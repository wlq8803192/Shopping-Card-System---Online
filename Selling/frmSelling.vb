Imports System.Runtime.InteropServices

'modify code 003:
'date;2013/8/15
'auther:Hyron zyx 
'remark:销售单无卡销售bug修正

'modify code 004:
'date:2013/8/22
'auther:Hyron bjy
'remark:卡成本设置明细到城市-卡类型-卡成本是否可选
'       打印小票增加卡成本合计

'modify code 005:
'date:2013/8/23
'auther:Hyron bjy
'remark:修改92/94卡小票打印显示
'       92卡---“以下列表是营销卡”改为“以下列表是购买福卡抵用券信息”
'       94卡---抬头处：将“家乐福市场活动卡购买凭证” 改为 “家乐福市场活动卡凭证”
'              在“行号 开始卡号 结束卡号” 上面加一行：“以下列表是购买商品抵用券信息”

'modify code 006:
'date;2013/8/28
'auther:Hyron bjy 
'remark:删除购物卡充值列表最后一行，付款金额不自动清零 bug修正

'modify code 007:
'date;2013/9/2
'auther:Hyron bjy 
'remark:输入86条码卡不验证合同最小面值 bug修正，94活动券不需验证

'modify code 008:
'date;2013/11/5
'auther:Hyron bjy 
'remark:新增[积分兑换]支付方式，用于一般销售单，不可开发票，不可混合支付
'更名历史： 中移T+1 -〉自动兑换补充值 -〉积分兑换

'modify code 011:
'date;2014/1/6
'auther:Hyron bjy 
'remark:礼品卡增加条码输入，自动显示面值，不可手填

'modify code 016:
'date;2014/3/25
'auther:Hyron bjy 
'remark:员工卡销售单新增银行卡支付方式，限登陆人员属于上海家乐福总部

'modify code 019:
'date;2014/4/21
'auther:Hyron bjy 
'remark:合同客户，付款抵扣BUG修正

'modify code 022:
'date;2014/5/15
'auther:Hyron bjy 
'remark:返点卡号段时，不判断卡面值不超1000元BUG修正

'modify code 038:
'date;2014/9/24
'auther:Hyron bjy 
'remark:返点比率0.0->0.00

'modify code 040:
'date;2014/11/5
'auther:Hyron bjy 
'remark:新增销售单类型---线下提卡销售单

'modify code 044:
'date;2015/1/9
'auther:Hyron bjy 
'remark: 增加线下提卡销售单支付方式--瑞泰

'modify code 046:
'date;2015/4/1
'auther:Hyron zyx 
'remark:新增销售单类型---实名制卡销售单

'modify code 047:
'date;2014/5/11
'auther:Hyron qm 
'remark:实名制卡特殊操作

'modify code 050:
'date;2015/10/26
'auther:Hyron qm 
'remark:增加实名制卡CardBin，实名制卡非实名制卡售卖分开，修改实名制卡特殊操作

'modify code 051:
'date;2016/01/08
'auther:BJY 
'remark:增加通卖卡65888

'modify code 052:
'date;2016/01/11
'auther:BJY 
'remark:修正付款抵扣合同抵扣金额不对的BUG

'modify code 054:
'date;2016/02/15
'auther:BJY 
'remark:增加65卡销售单，65/61使用新返点规则，去除051的一般销售单售卖65卡功能

'modify code 059:
'date;2016/06/24
'auther:BJY 
'remark:付款抵扣合同，如全额抵扣，允许保存销售单，且记录支付金额为0的支付方式

'modify code 060:
'date;2016/06/29
'auther:BJY 
'remark:打印凭证A4版最后一行显示不全问题修正，行数50行改为45行

'modify code 061:
'date;2016/06/29
'auther:BJY 
'remark:修正实名/非实名通卖销售单不显示转入转出账号问题

'modify code 062:
'date;2016/07/14
'auther:QP
'remark:修正打印发票按钮操作权限问题

'modify code 063:
'date;2016/07/18
'auther:QP
'remark:修正实名制卡解除绑定关系问题

'modify code 064:
'date;2016/07/18
'auther:QP
'remark:修正实名制卡和非实名制卡建单,输入客户时,取消勾选客户关联的合同的操作

'modify code 066:
'date;2016/10/26
'auther:QP
'remark:修正过期合同未拿返点,保存销售单时报错

'modify code 068:
'date;2016/11/15
'auther:QP
'remark:修正销售单61/65卡合同返点

'modify code 072:
'date;2017/05/10
'auther:Qipeng
'remark:增加电子卡团购功能

'modify code 075:
'date;2017/07/3
'auther:Qipeng
'remark:增加获取返点卡按钮，连接CUL实时接口获取返点的卡号

'modify code 085:
'date;2017/11/9
'auther:Qipeng
'remark:销售单的支付方式中添加“内购”方式,并隐掉支票和支票+保证金方式,转账修改为转账+支票方式

Public Class frmSelling
    <DllImport("user32.dll", CharSet:=CharSet.Auto, SetLastError:=False)> _
   Private Shared Function SendMessage(ByVal hWnd As IntPtr, ByVal Msg As Int16, ByVal wParam As Int16, ByVal lParam As Int16) As IntPtr
        '模拟单击日历控件下拉框
    End Function

    Private blSkipDeal As Boolean = True, sTimerType As String = "BrushCard", blBrushingEnd As Boolean = True, bClicks As Byte = 0, bHightLightTimes As Byte = 0, sCustomerPrompt As String = "", sErrorNormalInfo As String = "", sErrorRebateInfo As String = ""
    Private errorNormalCell As DataGridViewCell, errorRebateCell As DataGridViewCell, editingTextBox As TextBox
    Private blNormalCardFaceValueErrorWhenSwitchCustomer As Boolean = False, dmCardCost As Decimal = 0, dmMinFaceValue As Decimal = 0, dmMaxFaceValue As Decimal = 0, sCULCardBin As String = "", sGiftCardBin As String = "", sFreeCardBin As String = "", sPaperCardBin As String = ""
    Private blCanCreateCustomer As Boolean, blCanViewCustomer As Boolean, blCanViewCityRule As Boolean, blCanViewContract As Boolean
    Private sCityID As String = "", sCustomerName As String = "", dmNormalSalesAMT As Decimal = 0, dmPayableAMT As Decimal = 0, dmReceivedAMT As Decimal = 0, dmAvailableRebateAMT As Decimal = 0, dmRebateSalesAMT As Decimal = 0
    Private dmAvailableRebateRate As Decimal = 0, dmMaxNormalRebateRate As Decimal = 0, dmMaxNormalRebateAMT As Decimal = 0, blCalculateNormalRebateByRate As Boolean = True
    Private drCustomer As DataRow, dtNormalCard As DataTable, dtRebateCard As DataTable, dtPayment As DataTable, dtRowPayment As DataTable
    Private dtCardParameter As DataTable, dtDropdownCustomer As DataTable, dvCustomerBuyer As DataView, dtCardCost As DataTable, dtPaymentTerm As DataTable, dtSelectablePayment As DataTable
    Private sNewestCityRuleID As String = "", sCityRuleID As String = "", drNewestCityRule As DataRow, dtNewestRuleDetails As DataTable, drCityRule As DataRow, dtRuleDetails As DataTable
    Private sContractID As String = "", sBalanceContractID As String = "", sContractAppointedStoreID As String = "", sBalanceContractAppointedStoreID As String = "", blThisRebateAvailable As Boolean = False, drContract As DataRow, dtContractDetails As DataTable, drContractExtra As DataRow
    Private iFirstAvailableRowID As Int16 = -1, iSecondAvailableRowID As Int16 = -1
    Private dtActivation As DataTable, sActivationLoadedTime As String = ""
    Private blCheckTicketPrinter As Boolean = False, blIsMultiPaper As Boolean = False, iTicketPageNum As Int16 = 1, iTicketPageCount As Int16 = 1, sTicketPrintedTime As String, dtCardListInTicket As DataTable '用于打印小票
    Private dmTotalChargedAMT As Decimal = 0, dmTotalRebateAMT As Decimal = 0, dmTotalPaymentAMT As Decimal = 0, dmTotalPrintedInvoiceAMT As Decimal = 0, dtInvoiceItem As DataTable '用于打印发票

    Private blCanUse60Card As Boolean = False, blCanUse92Card As Boolean = False, blCanUse94Card As Boolean = False, blCanUsePaperCard As Boolean = False, dtPaperCardFaceValue As DataTable, dtInternalPayer As DataTable, drInternalPayer As DataRow

    Private drEmployee As DataRow = Nothing, sEmployeePrompt As String = "", sEmployeeID As String = "", sEmployeeNo As String = "", sOldEmployeePrompt As String = "", sOldEmployeeID As String = "", sOldEmployeeNo As String = ""

    Private drMember As DataRow = Nothing

    Private Declare Function LockWindowUpdate Lib "user32" (ByVal hwndLock As Long) As Long

    Public dtLastCheckingProblemCard As DataTable, dtAllCheckedCard As DataTable, sFirstCheckCardTime As String = "", blCanRecheckCard As Boolean, blNeedReloadCard As Boolean  '用于检查购物卡使用状态
    'modify code 040,046,054,072:start-------------------------------------------------------------------------
    Public bNewSalesBillType As Byte = 0 '0 - 一般销售单; 1 - 退货销售单; 2 - 活动卡销售单; 3 - 公关卡销售单; 4 - 员工销售单; 5 - 联名卡销售单; 6 - 线下提卡销售单; 7 - 实名制卡销售单; 8 - 通卖非实名卡销售单; 9 - 电子卡销售单
    'modify code 040,046,054,072:end-------------------------------------------------------------------------
    Public blIsChanged As Boolean = False, sSalesBillID As String = "-1", sCustomerID As String = "", blHaveThreeMedia As Boolean = True, blUsedOldCard As Boolean = False '使用旧卡时没有卡成本且不限制最小面值
    Public drSalesBill As DataRow, drImportedFile As DataRow, dtImportedDetails As DataTable, drInvoicePrintable As DataRow, dtInvoice As DataTable, dtInvoiceLayout As DataTable
    Public blInvoicePrinterMultiUser As Boolean = False, sInvoicePrinterDevice As String = "", sInvoiceCode As String = "", sInvoiceNo As String = "" '控制发票代码及号码的生成
    Public iDifferenceSeconds As Integer = 0 '数据库服务器与本机的时间差

    'modify code 004:start-------------------------------------------------------------------------
    '定义全局变量
    Private dtCardCostManage As DataTable
    Private dm84CardCost As Decimal = 0
    Private dm86CardCost As Decimal = 0
    Private dm92CardCost As Decimal = 0
    Private dm94CardCost As Decimal = 0
    Private dm60CardCost As Decimal = 0
    Private CARD_TYPE_84 As String = "84"
    Private CARD_TYPE_86 As String = "86"
    Private CARD_TYPE_92 As String = "92"
    Private CARD_TYPE_94 As String = "94"
    Private CARD_TYPE_60 As String = "60"

    Private bl84CanChanged As Boolean = False
    Private bl86CanChanged As Boolean = False
    Private bl92CanChanged As Boolean = False
    Private bl94CanChanged As Boolean = False
    Private bl60CanChanged As Boolean = False
    'modify code 004:end-------------------------------------------------------------------------

    'modify code 051:start-------------------------------------------------------------------------
    Private dm65CardCost As Decimal = 0
    Private CARD_TYPE_65 As String = "65"
    Private bl65CanChanged As Boolean = False
    Private blCanUse65Card As Boolean = False
    'modify code 051:end-------------------------------------------------------------------------

    'modify code 046:start-------------------------------------------------------------------------
    '实名制卡最大面值
    Private dmMaxSignCardFaceValue As Decimal = 5000
    Private dtHolderInfo As DataTable
    'modify code 046:end-------------------------------------------------------------------------

    'modify code 008,040,044:start-------------------------------------------------------------------------
    Public dtCityPaymentTerm As DataTable
    'modify code 008,040,044:end-------------------------------------------------------------------------

    'modify code 011:start-------------------------------------------------------------------------
    Private dtBarcodeFaceValue As DataTable
    'modify code 011:end-------------------------------------------------------------------------

    'modify code 016:start-------------------------------------------------------------------------
    Private dtBankCardStoreID As DataTable
    'modify code 016:end-------------------------------------------------------------------------

    'modify code 040:start-------------------------------------------------------------------------
    Public ecir As InternetWebService.ExtractingCodeInfoResponse = Nothing
    Private dtBillBuyChannel As DataTable = Nothing
    Private guIDClass As InternetWebService.GuIDClass = Nothing
    Private sCards As String = ""
    Public sIssuerId As String = ""
    'modify code 040:end-------------------------------------------------------------------------

    'modify code 044:start-------------------------------------------------------------------------
    Public cir As InternetRuiTaiWebService.CodeInfoResponse = Nothing
    Private guIDClass_Ruitai As InternetRuiTaiWebService.GuIDClass = Nothing
    Public strSelectedBuyChannel As String, strSerialNo As String
    'modify code 044:end-------------------------------------------------------------------------

    'modify code 047:start-------------------------------------------------------------------------
    Public isSignCard As Boolean = False
    Public signCardNo As String
    'modify code 047:end-------------------------------------------------------------------------
    'modify code 050:start-------------------------------------------------------------------------
    'Private dtSignCardRangeAll As DataTable
    Private dtSignCardRangeOld As New DataTable
    Private dtSignCardRangeNew As New DataTable
    Private sSignCardBin As String
    Private dmSignCardCost As Decimal = 0
    Private blSignCardCanChanged As Boolean = False
    Private sameFlag As Boolean = False
    'modify code 050:end-------------------------------------------------------------------------

    'modify code 054:start-------------------------------------------------------------------------
    Private sCityRule As String = "CityRule"
    Private sCityRuleDetails As String = "CityRuleDetails"
    'modify code 054:end-------------------------------------------------------------------------

    'modify code 060:start-------------------------------------------------------------------------
    Private iAdjust As Integer = -10
    Private iPrintRows As Integer = 45
    'modify code 060:end-------------------------------------------------------------------------

    'modify code 072:start-------------------------------------------------------------------------
    Public sOrderNo As String = ""
    'modify code 072:end-------------------------------------------------------------------------

    'modify code 075:start-------------------------------------------------------------------------
    Public dtRebateCardEx As DataTable
    'modify code 075:end-------------------------------------------------------------------------

    Private Sub frmSelling_Activated(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Activated
        If Me.dgvNormalCard.CurrentCell IsNot Nothing Then
            If Me.dgvNormalCard.Focused Then
                If Me.dgvNormalCard.CurrentCell.ReadOnly = False Then Me.dgvNormalCard.CurrentCell.Selected = True : Me.dgvNormalCard.BeginEdit(True)
            Else
                blSkipDeal = True
                Me.dgvNormalCard.CurrentCell.Selected = False
                Me.dgvNormalCard.CurrentRow.Selected = False
                blSkipDeal = False
                frmMain.statusText.Text = "就绪。"
            End If
        End If

        If Me.dgvRebateCard.CurrentCell IsNot Nothing Then
            blSkipDeal = True
            Me.dgvRebateCard.CurrentCell.Selected = False
            Me.dgvRebateCard.CurrentRow.Selected = False
            blSkipDeal = False
        End If

        If Me.dgvPayment.CurrentCell IsNot Nothing Then
            blSkipDeal = True
            Me.dgvPayment.CurrentCell.Selected = False
            Me.dgvPayment.CurrentRow.Selected = False
            blSkipDeal = False
        End If

        If drSalesBill("SalesBillState") = 9 AndAlso Me.flpLeftContainer.VerticalScroll.Visible = True Then
            Me.lblSalesBillRemarks.Select()
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
        End If

        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" Then
            Me.txbInputEmployeeNo.Focus()
            Me.txbInputEmployeeNo.Select()
            Me.txbInputEmployeeNo.SelectAll()
            frmMain.statusText.Text = IIf(sEmployeePrompt = "", "请输入员工编号。", sEmployeePrompt)
        End If
    End Sub

    Private Sub frmSelling_FormClosing(ByVal sender As Object, ByVal e As System.Windows.Forms.FormClosingEventArgs) Handles Me.FormClosing
        If blIsChanged Then
            Me.btnOK.Select()
            Dim bAnswer As Windows.Forms.DialogResult = MessageBox.Show("当前销售单还未保存。    " & Chr(13) & Chr(13) & "是否在关闭窗口前保存该销售单？    " & Chr(13) & Chr(13) & "   是    -   保存并退出" & Chr(13) & "   否    -   放弃并退出" & Chr(13) & "  取消   -   取消关闭", "请确认保存销售单：", MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question, MessageBoxDefaultButton.Button1)

            If bAnswer = Windows.Forms.DialogResult.Yes Then
                e.Cancel = Not Me.SaveChanges
            ElseIf bAnswer = Windows.Forms.DialogResult.Cancel Then
                e.Cancel = True
            End If
        ElseIf frmMain.statusText.Text.IndexOf("无法") = -1 Then
            frmMain.statusText.Text = "就绪。"
        End If
        dtSelectablePayment.Rows.Add(0, 1) '不加会出错
    End Sub

    Private Sub frmSelling_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        If frmMain.dtLoginStructure.Select("AreaType='S'").Length = 0 Then
            MessageBox.Show("没有门店，不能创建销售单！    " & Chr(13) & Chr(13) & "请找系统管理员建立门店。    ", "未发现门店！", MessageBoxButtons.OK)
            Me.Close() : Return
        End If

        blCanCreateCustomer = (frmMain.dtAllowedRight.Select("RightName='CustomerCreate'").Length > 0)
        blCanViewCustomer = (frmMain.dtAllowedRight.Select("RightName Like 'Customer%' And RightName<>'CustomerCreate'").Length > 0)
        'modify code 054,072:start-------------------------------------------------------------------------
        'blCanViewCityRule = (frmMain.dtAllowedRight.Select("RightName='CityConfigBrowse'").Length > 0)
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            blCanViewCityRule = (frmMain.dtAllowedRight.Select("RightName='CrossSellingCityConfigBrowse'").Length > 0)
            sCityRule = "CrossSellingCityRule"
            sCityRuleDetails = "CrossSellingCityRuleDetails"
        Else
            blCanViewCityRule = (frmMain.dtAllowedRight.Select("RightName='CityConfigBrowse'").Length > 0)
        End If
        'modify code 054,072:end-------------------------------------------------------------------------

        'blCanViewContract = (frmMain.dtAllowedRight.Select("RightName Like 'Contract%' And RightName<>'ContractCreate'").Length > 0)

        'modify code 068,072:start-------------------------------------------------------------------------
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            blCanViewContract = (frmMain.dtAllowedRight.Select("RightName Like 'CrossContract%' And RightName<>'CrossContractCreate'").Length > 0)
        Else
            blCanViewContract = (frmMain.dtAllowedRight.Select("RightName Like 'Contract%' And RightName<>'ContractCreate'").Length > 0)
        End If
        'modify code 068,072:end-------------------------------------------------------------------------

        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        dtNormalCard = New DataTable
        dtNormalCard.Columns.Add("RowID", System.Type.GetType("System.Int16"))
        'modify code 004:start-------------------------------------------------------------------------
        dtNormalCard.Columns.Add("FirstBuy", System.Type.GetType("System.String"))
        'modify code 004:end-------------------------------------------------------------------------
        dtNormalCard.Columns.Add("CardFeature", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("StartCardNo", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("EndCardNo", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("CardQTY", System.Type.GetType("System.Int32"))
        'modify code 011:start-------------------------------------------------------------------------
        dtNormalCard.Columns.Add("BarCode", System.Type.GetType("System.String"))
        'modify code 011:end-------------------------------------------------------------------------
        dtNormalCard.Columns.Add("FaceValue", System.Type.GetType("System.Decimal"))
        dtNormalCard.Columns.Add("ReducedCardPayment", System.Type.GetType("System.Decimal"))
        'modify code 004:start-------------------------------------------------------------------------
        'dtNormalCard.Columns.Add("CardCost", System.Type.GetType("System.Decimal"))
        dtNormalCard.Columns.Add("CardCost", System.Type.GetType("System.String"))
        'modify code 004:start-------------------------------------------------------------------------
        dtNormalCard.Columns.Add("CardPayment", System.Type.GetType("System.Decimal"))
        dtNormalCard.Columns.Add("ChargedAMT", System.Type.GetType("System.Decimal"))
        dtNormalCard.Columns.Add("PayableAMT", System.Type.GetType("System.Decimal"))
        dtNormalCard.Columns.Add("PaymentDescription", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("ActivationState", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("ActivatedQTY", System.Type.GetType("System.Int32"))
        dtNormalCard.Columns.Add("ActivatedAMT", System.Type.GetType("System.Decimal"))
        dtNormalCard.Columns.Add("StateReason", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("CostAMT", System.Type.GetType("System.Decimal"))
        'modify code 046:start-------------------------------------------------------------------------
        '一般销售单界面追加是否实名制列
        dtNormalCard.Columns.Add("HolderName", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("Gender", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("HolderIdNo", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("Mobile", System.Type.GetType("System.String"))
        dtNormalCard.Columns.Add("IsSignCard", System.Type.GetType("System.String"))
        'modify code 046:end-------------------------------------------------------------------------

        dtRebateCard = New DataTable
        dtRebateCard.Columns.Add("RowID", System.Type.GetType("System.Int16"))
        dtRebateCard.Columns.Add("CardFeature", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("StartCardNo", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("EndCardNo", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("CardQTY", System.Type.GetType("System.Int32"))
        dtRebateCard.Columns.Add("FaceValue", System.Type.GetType("System.Decimal"))
        dtRebateCard.Columns.Add("ChargedAMT", System.Type.GetType("System.Decimal"))
        dtRebateCard.Columns.Add("PayableAMT", System.Type.GetType("System.Decimal"))
        dtRebateCard.Columns.Add("ActivationState", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("ActivatedQTY", System.Type.GetType("System.Int32"))
        dtRebateCard.Columns.Add("ActivatedAMT", System.Type.GetType("System.Decimal"))
        dtRebateCard.Columns.Add("StateReason", System.Type.GetType("System.String"))
        'modify code 046:start-------------------------------------------------------------------------
        dtRebateCard.Columns.Add("IsSignCard", System.Type.GetType("System.String"))
        'modify code 046:end-------------------------------------------------------------------------
        'modify code 050:start-------------------------------------------------------------------------
        '实名制卡销售单界面返点表追加实名制信息列
        dtRebateCard.Columns.Add("HolderName", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("Gender", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("HolderIdNo", System.Type.GetType("System.String"))
        dtRebateCard.Columns.Add("Mobile", System.Type.GetType("System.String"))
        'modify code 050:end-------------------------------------------------------------------------

        dtSelectablePayment = New DataTable
        dtSelectablePayment.Columns.Add("Selected", System.Type.GetType("System.Boolean"))
        dtSelectablePayment.Columns.Add("RowID", System.Type.GetType("System.Int16"))
        dtSelectablePayment.Columns.Add("PaymentTerm", System.Type.GetType("System.String"))
        dtSelectablePayment.Columns.Add("AvailableAMT", System.Type.GetType("System.Decimal"))
        dtSelectablePayment.Columns.Add("DistributedAMT", System.Type.GetType("System.Decimal"))
        dtSelectablePayment.DefaultView.Sort = "RowID"

        Try
            If frmMain.dtAllowedRight.Select("RightName='SalesBillSalesmanAdjust'").Length > 0 AndAlso frmMain.dvBigFish Is Nothing Then
                Dim sCityID As String = ""
                If frmMain.sLoginAreaType = "S" Then
                    frmMain.dvMediumFish = DB.GetDataTable("Select AreaID,UserID As SalesmanID,UserCode,Isnull(UserChineseName,UserEnglishName) As SalesmanName From UserList Where AreaID=" & frmMain.sLoginAreaID & " And RoleID=19 And UserState=2").DefaultView
                Else
                    frmMain.dvMediumFish = DB.GetDataTable("Select U.AreaID,U.UserID As SalesmanID,U.UserCode,Isnull(U.UserChineseName,U.UserEnglishName) As SalesmanName From UserList AS U Join AreaScope(" & frmMain.sLoginUserID & ") As S On U.AreaID=S.AreaID Where U.RoleID=19 And U.UserState=2").DefaultView
                End If
                frmMain.dvMediumFish.Sort = "UserCode"
                If frmMain.sLoginAreaType = "S" Then
                    sCityID = frmMain.dtLoginStructure.Rows.Find(frmMain.sLoginAreaID)("ParentAreaID").ToString
                ElseIf frmMain.sLoginAreaType = "C" Then
                    sCityID = frmMain.sLoginAreaID
                End If
                If sCityID <> "" Then
                    frmMain.dvBigFish = DB.GetDataTable("Select AreaID,UserID As SalesmanID ,UserCode,Isnull(UserChineseName,UserEnglishName) As SalesmanName From UserList Where AreaID=" & sCityID & " And RoleID=10 And UserState=2").DefaultView
                Else
                    frmMain.dvBigFish = DB.GetDataTable("Select U.AreaID,U.UserID As SalesmanID,U.UserCode,Isnull(U.UserChineseName,U.UserEnglishName) As SalesmanName From UserList AS U Join AreaScope(" & frmMain.sLoginUserID & ") As S On U.AreaID=S.AreaID Where U.RoleID=10 And U.UserState=2").DefaultView
                End If
                frmMain.dvBigFish.Sort = "UserCode"
            End If

            If frmMain.sLoginAreaType = "S" Then
                sCityID = frmMain.dtLoginStructure.Rows.Find(frmMain.sLoginAreaID)("ParentAreaID").ToString
                dtCardParameter = DB.GetDataTable("Select * From CityCardParameter Where CityID=" & sCityID).Copy
            ElseIf frmMain.sLoginAreaType = "C" Then
                sCityID = frmMain.sLoginAreaID
                dtCardParameter = DB.GetDataTable("Select * From CityCardParameter Where CityID=" & sCityID).Copy
            Else
                dtCardParameter = DB.GetDataTable("Select P.* From CityCardParameter AS P Inner Join AreaScope(" & frmMain.sLoginUserID & ") AS S On P.CityID=S.AreaID").Copy
            End If

            'modify code 004:start-------------------------------------------------------------------------
            '获取卡成本设置
            SetCardCostByCityID(sCityID)
            'modify code 004:end-------------------------------------------------------------------------

            'modify code 008,040,044:start-------------------------------------------------------------------------
            '获取城市新增支付方式
            'GetPaymentTermByCityID(sCityID, "7,8")  '7 - 积分兑换，8 - 兑换码
            GetPaymentTermByCityID(sCityID)
            For iCount As Integer = 0 To dtCityPaymentTerm.Rows.Count - 1
                If dtCityPaymentTerm.Rows(iCount)("PaymentTerm") = 7 Then '积分兑换不允许修改名称
                    Continue For
                Else
                    If IsDBNull(dtCityPaymentTerm.Rows(iCount)("PaymentName")) Then
                        MessageBox.Show("设置支付方式名称不全,请联系系统管理员设置。    ", "未设置支付方式名称！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        frmMain.statusText.Text = "未设置支付方式名称，不能" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单！"
                        DB.Close() : Me.Close() : Return
                    End If
                End If
            Next
            'modify code 008,040,044:end-------------------------------------------------------------------------

            'modify code 011:start-------------------------------------------------------------------------
            '获取条码和面值的对应关系
            GetBarcodeFaceValue()
            'modify code 011:end-------------------------------------------------------------------------

            'modify code 016:start-------------------------------------------------------------------------
            '获取可以在员工销售单使用银行卡的区域集合
            GetBankCardAreaID()
            'modify code 016:end-------------------------------------------------------------------------

            'modify code 040,044:start------------------------------------------------------------------------
            '获取线下提卡销售单打印发票设置
            GetBillBuyChannelCityID(sCityID)
            'modify code 040,044:end------------------------------------------------------------------------

            If frmMain.dtAllowedRight.Select("RightName In ('SalesBillNormalCreate','SalesBillPRCreate','SalesBillMKCreate')").Length > 0 AndAlso dtCardParameter.Select("UsePaperCard=1").Length > 0 Then
                dtPaperCardFaceValue = DB.GetDataTable("Exec GetPaperCardFaceValue " & frmMain.sLoginUserID).Copy
                dtPaperCardFaceValue.PrimaryKey = New DataColumn() {dtPaperCardFaceValue.Columns("CardType")}
            End If

            dtInternalPayer = DB.GetDataTable("Select I.* From InternalPayerStore As I Inner Join AreaScope(" & frmMain.sLoginUserID & ") As S On I.StoreID = S.AreaID Order By S.SortCode")
            dtInternalPayer.PrimaryKey = New DataColumn() {dtInternalPayer.Columns("StoreID")}
            For Each sPayerName As String In dtInternalPayer.Rows(0)("PayerNames").ToString.Split("|")
                Me.cbbAvailablePayer.Items.Add(sPayerName)
            Next
            Me.cbbAvailablePayer.SelectedIndex = 0

            dtPayment = DB.GetDataTable("Exec GetSalesBillPayment " & sSalesBillID).Copy

            Dim dtSalesBill As DataTable = DB.GetDataTable("Exec SalesBillSingle " & sSalesBillID).Copy
            If sSalesBillID = "-1" Then
                If (bNewSalesBillType = 2 OrElse bNewSalesBillType = 3) AndAlso dtInternalPayer.Rows.Count = 0 Then
                    MessageBox.Show("当前门店未设置家乐福自购时的付款单位名称，不能建立" & IIf(bNewSalesBillType = 2, "活动", "公关") & "卡销售单！    " & Chr(13) & Chr(13) & "请通知系统管理员设置该门店自购时的付款单位名称。    ", "未设置家乐福自购时的付款单位名称！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "门店未设置家乐福自购时的付款单位名称，不能建立" & IIf(bNewSalesBillType = 2, "活动", "公关") & "卡销售单！"
                    DB.Close() : Me.Close() : Return
                Else
                    drInternalPayer = dtInternalPayer.Rows(0)
                End If
                drSalesBill = dtSalesBill.Rows.Add
                drSalesBill("SalesBillType") = bNewSalesBillType
                If frmMain.sLoginAreaType = "S" Then
                    drSalesBill("StoreID") = frmMain.sLoginAreaID
                    Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
                    drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
                    sCULCardBin = drStore("CULCardBin").ToString
                    sGiftCardBin = "60" & sCULCardBin.Substring(2)
                    sGiftCardBin = sGiftCardBin.Replace("|84", "|60")
                    sFreeCardBin = "92" & sCULCardBin.Substring(2)
                    sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
                    sPaperCardBin = "86" & sCULCardBin.Substring(2)
                    sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
                    sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
                    'modify code 050:start------------------------------------------------------------------------
                    sSignCardBin = frmMain.signCardBin & sCULCardBin.Substring(2)
                    sSignCardBin = sSignCardBin.Replace("|84", "|" & frmMain.signCardBin)
                    'modify code 050:end------------------------------------------------------------------------
                    If bNewSalesBillType = 2 Then
                        sCULCardBin = "94" & sCULCardBin.Substring(2)
                        sCULCardBin = sCULCardBin.Replace("|84", "|94")
                        sPaperCardBin = sCULCardBin
                    ElseIf bNewSalesBillType = 3 Then
                        sCULCardBin = "92" & sCULCardBin.Substring(2)
                        sCULCardBin = sCULCardBin.Replace("|84", "|92")
                        sPaperCardBin = sCULCardBin
                    End If
                End If

                Dim strBin As String
                strBin = Replace(sSignCardBin, "|", "','")
                dtSignCardRangeNew = DB.GetDataTable("Select * From SignCardListNew Where CardType = '实名制卡' and SUBSTRING(cardno,5,5) in ('" & strBin & "')").Copy
                strBin = Replace(sCULCardBin & "|" & sGiftCardBin, "|", "','")
                dtSignCardRangeOld = DB.GetDataTable("Select * From SignCardList Where CardType = '实名制卡' and SUBSTRING(cardno,5,5) in ('" & strBin & "')").Copy

                drSalesBill("CustomerType") = 0 '个人客户
                drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                If bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
                    drSalesBill("StoreID") = drInternalPayer("StoreID")
                    drSalesBill("CustomerName") = drInternalPayer("StoreName").ToString
                    drSalesBill("BuyerName") = IIf(bNewSalesBillType = 2, drInternalPayer("MKLinkman").ToString, drInternalPayer("PRLinkman").ToString)
                    drSalesBill("TelMP") = IIf(bNewSalesBillType = 2, drInternalPayer("MKTelMP").ToString, drInternalPayer("PRTelMP").ToString)
                    drSalesBill("BuyerCredentialsType") = IIf(bNewSalesBillType = 2, drInternalPayer("MKCredentialsType").ToString, drInternalPayer("PRCredentialsType").ToString)
                    If drSalesBill("BuyerCredentialsType").ToString = "" Then drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                    drSalesBill("BuyerCredentialsNo") = IIf(bNewSalesBillType = 2, drInternalPayer("MKCredentialsNo").ToString, drInternalPayer("PRCredentialsNo").ToString)
                    drSalesBill("CompanyCredentialsType") = "税务登记证"
                    drSalesBill("CompanyCredentialsNo") = drInternalPayer("ReceiverTaxNo").ToString
                    If drSalesBill("BuyerName").ToString <> "" Then Me.cbbBuyerName.Items.Add(drSalesBill("BuyerName").ToString)
                    If drSalesBill("TelMP").ToString <> "" Then Me.cbbTelMP.Items.Add(drSalesBill("TelMP").ToString)
                End If
                drSalesBill("CardQTY") = 0
                drSalesBill("NormalCardQTY") = 0
                drSalesBill("NormalSalesAMT") = 0
                drSalesBill("CardCost") = 0
                drSalesBill("RebateMode") = 0 '没有返点
                drSalesBill("RebateCardQTY") = 0
                drSalesBill("RebateSalesAMT") = 0
                drSalesBill("AddToContract") = 0
                drSalesBill("FirstAvailableRowID") = -1
                drSalesBill("SecondAvailableRowID") = -1
                If bNewSalesBillType = 1 Then drSalesBill("RefundDate") = Today()

                If bNewSalesBillType = 2 AndAlso drInternalPayer("LastPromotionTitle").ToString <> "" Then
                    Dim sPromotionPeriod As String = drInternalPayer("LastPromotionPeriod").ToString
                    If CDate(sPromotionPeriod.Substring(sPromotionPeriod.LastIndexOf("-") + 1).Trim) >= Today Then
                        drSalesBill("PromotionTitle") = drInternalPayer("LastPromotionTitle").ToString
                        drSalesBill("PromotionPeriod") = sPromotionPeriod
                    End If
                End If

                If sCustomerID = "" Then
                    drSalesBill("CustomerStoreID") = drSalesBill("StoreID")
                Else
                    'Dim dtCustomer As DataTable = DB.GetDataTable("Exec CustomerSingle " & sCustomerID).Copy

                    'modify code 068,072:start-------------------------------------------------------------------------
                    Dim dtCustomer As DataTable
                    If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                        dtCustomer = DB.GetDataTable("Exec CrossCustomerSingle " & sCustomerID).Copy
                    Else
                        dtCustomer = DB.GetDataTable("Exec CustomerSingle " & sCustomerID).Copy
                    End If
                    'modify code 068,072:end-------------------------------------------------------------------------

                    If dtCustomer.Rows.Count = 0 Then
                        MessageBox.Show("您选择的客户已经不存在（可能被删除或移位）！    ", "客户不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        If frmCustomerManagement.IsHandleCreated Then
                            Try
                                frmCustomerManagement.dvCustomer.Table.Rows.Find(sCustomerID).Delete()
                            Catch
                            End Try
                        End If
                        frmMain.statusText.Text = "客户不存在！"
                        dtNormalCard.Dispose() : dtNormalCard = Nothing
                        dtRebateCard.Dispose() : dtRebateCard = Nothing
                        dtPayment.Dispose() : dtPayment = Nothing
                        dtSalesBill.Dispose() : dtSalesBill = Nothing
                        dtCustomer.Dispose() : dtCustomer = Nothing
                        DB.Close() : Me.Close() : Return
                    Else
                        drCustomer = dtCustomer.Rows(0)
                        dtCustomer.Dispose() : dtCustomer = Nothing
                        If frmCustomerManagement.IsHandleCreated Then frmCustomerManagement.UpdateCustomer(drCustomer)
                        If drCustomer("Stopped") Then
                            MessageBox.Show("您选择的客户已被停止使用，再也不能向该客户售卡！    " & Chr(13) & Chr(13) & "停用客户： " & drCustomer("StoreCode").ToString & drCustomer("CustomerCode").ToString & " " & drCustomer("CustomerChineseName").ToString & Space(4) & IIf(drCustomer("StoppedReason").ToString = "", "", Chr(13) & "停用原因： " & drCustomer("StoppedReason").ToString & Space(4)), "客户已被停止使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            sCustomerID = "" : drCustomer = Nothing : drSalesBill = Nothing
                            frmMain.statusText.Text = "客户已被停止使用！"
                            dtNormalCard.Dispose() : dtNormalCard = Nothing
                            dtRebateCard.Dispose() : dtRebateCard = Nothing
                            dtPayment.Dispose() : dtPayment = Nothing
                            dtSalesBill.Dispose() : dtSalesBill = Nothing
                            DB.Close() : Me.Close() : Return
                        Else
                            dvCustomerBuyer = DB.GetDataTable("Exec GetCustomerBuyer " & sCustomerID & "," & drSalesBill("StoreID").ToString).DefaultView
                            Me.CombineCustomerBuyer()
                        End If
                    End If
                    If drSalesBill("StoreID").ToString = "" Then
                        drSalesBill("StoreID") = drCustomer("StoreID")
                        Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
                        drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
                        sCULCardBin = drStore("CULCardBin").ToString
                        sGiftCardBin = "60" & sCULCardBin.Substring(2)
                        sGiftCardBin = sGiftCardBin.Replace("|84", "|60")
                        sFreeCardBin = "92" & sCULCardBin.Substring(2)
                        sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
                        sPaperCardBin = "86" & sCULCardBin.Substring(2)
                        sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
                        sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
                        'modify code 050:start------------------------------------------------------------------------
                        sSignCardBin = frmMain.signCardBin & sCULCardBin.Substring(2)
                        sSignCardBin = sPaperCardBin.Replace("|84", "|" & frmMain.signCardBin)
                        'modify code 050:end------------------------------------------------------------------------
                        If bNewSalesBillType = 2 Then
                            sCULCardBin = "94" & sCULCardBin.Substring(2)
                            sCULCardBin = sCULCardBin.Replace("|84", "|94")
                            sPaperCardBin = sCULCardBin
                        ElseIf bNewSalesBillType = 3 Then
                            sCULCardBin = "92" & sCULCardBin.Substring(2)
                            sCULCardBin = sCULCardBin.Replace("|84", "|92")
                            sPaperCardBin = sCULCardBin
                        End If
                    End If
                    drSalesBill("CustomerType") = 1 '公司客户
                    drSalesBill("CustomerID") = sCustomerID
                    drSalesBill("CustomerName") = drCustomer("CustomerChineseName").ToString
                    drSalesBill("CustomerStoreID") = drCustomer("StoreID")
                    If dvCustomerBuyer.Count > 0 Then
                        drSalesBill("BuyerName") = dvCustomerBuyer(0)("BuyerName").ToString
                        drSalesBill("TelMP") = dvCustomerBuyer(0)("TelMP").ToString
                        If dvCustomerBuyer(0)("CredentialsType").ToString = "" Then
                            drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                        Else
                            drSalesBill("BuyerCredentialsType") = dvCustomerBuyer(0)("CredentialsType").ToString
                            drSalesBill("BuyerCredentialsNo") = dvCustomerBuyer(0)("CredentialsNo").ToString
                        End If
                        dvCustomerBuyer.RowFilter = ""
                        For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                            Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                        Next
                        dvCustomerBuyer.RowFilter = "BuyerName='" & dvCustomerBuyer(0)("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                        For Each drTelMP As DataRowView In dvCustomerBuyer
                            Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                        Next
                    End If
                    If drCustomer("AllowNoCredentials") Then
                        Me.cbbCompanyCredentialsType.Items.Insert(0, "（特准无需证件）")
                        drSalesBill("CompanyCredentialsType") = "（特准无需证件）"
                    ElseIf drCustomer("CompanyCredentialsType").ToString = "" Then
                        drSalesBill("CompanyCredentialsType") = Me.cbbCompanyCredentialsType.Items(0)
                    Else
                        drSalesBill("CompanyCredentialsType") = drCustomer("CompanyCredentialsType").ToString
                        drSalesBill("CompanyCredentialsNo") = drCustomer("CompanyCredentialsNo").ToString
                    End If

                    sContractID = drCustomer("ValidContractID").ToString
                    If sContractID <> "" Then
                        '下载合同参数
                        Try
                            'drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                            'dtContractDetails = DB.GetDataTable("Select * From ContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy

                            'modify code 068,072:start-------------------------------------------------------------------------
                            If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                                drContract = DB.GetDataTable("Exec GetCrossContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                                dtContractDetails = DB.GetDataTable("Select * From CrossContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy
                            Else
                                drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                                dtContractDetails = DB.GetDataTable("Select * From ContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy
                            End If
                            'modify code 068,072:end-------------------------------------------------------------------------

                        Catch
                            sCustomerID = "" : drCustomer = Nothing : drSalesBill = Nothing
                            frmMain.statusText.Text = "系统因在检索数据时出错而无法下载合同资料。请联系软件开发人员。"
                            dtNormalCard.Dispose() : dtNormalCard = Nothing
                            dtRebateCard.Dispose() : dtRebateCard = Nothing
                            dtPayment.Dispose() : dtPayment = Nothing
                            dtSalesBill.Dispose() : dtSalesBill = Nothing
                            DB.Close() : Me.Close() : Return
                        End Try
                        sContractAppointedStoreID = drContract("AppointedStoreID").ToString
                        drSalesBill("ContractID") = sContractID
                        drSalesBill("ContractCode") = drCustomer("ValidContractCode").ToString
                        drSalesBill("ContractMode") = drContract("PaymentMode").ToString & drContract("CalculationMode").ToString
                        Select Case drContract("CalculationDay")
                            Case 0
                                drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "0" '合同期满后兑现累计返点
                            Case 255
                                drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "2" '每次购买时兑现累计返点
                            Case Else
                                drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "1" '每月一次兑现累计返点
                        End Select
                    End If

                    sBalanceContractID = drCustomer("BalanceContractID").ToString
                    If sBalanceContractID <> "" Then
                        '存在到期合同返点结余
                        Try
                            'sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From ContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString

                            'modify code 068,072:start-------------------------------------------------------------------------
                            If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                                sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From CrossContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString
                            Else
                                sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From ContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString
                            End If
                            'modify code 068,072:end-------------------------------------------------------------------------

                        Catch
                            sCustomerID = "" : drCustomer = Nothing : drSalesBill = Nothing
                            frmMain.statusText.Text = "系统因在检索数据时出错而无法下载合同资料。请联系软件开发人员。"
                            dtNormalCard.Dispose() : dtNormalCard = Nothing
                            dtRebateCard.Dispose() : dtRebateCard = Nothing
                            dtPayment.Dispose() : dtPayment = Nothing
                            dtSalesBill.Dispose() : dtSalesBill = Nothing
                            DB.Close() : Me.Close() : Return
                        End Try
                        drSalesBill("BalanceContractID") = sBalanceContractID
                        drSalesBill("BalanceContractCode") = drCustomer("BalanceContractCode").ToString
                        drSalesBill("BalanceContractBalanceRebateAMT") = drCustomer("BalanceRebateAMT")
                    End If
                End If

                drSalesBill("PayableAMT") = 0
                drSalesBill("PrintedInvoiceAMT") = 0
                drSalesBill("ChargedAMT") = 0
                drSalesBill("ActivatedAMT") = 0
                drSalesBill("SalesBillState") = 0
                drSalesBill("ActivationCancelledAMT") = 0
                drSalesBill("TableType") = 0

                Try
                    sCityID = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
                    Dim drCity As DataRow = dtCardParameter.Select("CityID=" & sCityID)(0)
                    dmCardCost = CDec(drCity("CardCost")) : dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue")) : blCanUse60Card = drCity("Use60Card") : blCanUse92Card = drCity("Use92Card") : blCanUse94Card = drCity("Use94Card") : blCanUsePaperCard = drCity("UsePaperCard") : blHaveThreeMedia = drCity("ThreeMedia")
                    'modify code 051:start-------------------------------------------------------------------------
                    blCanUse65Card = drCity("Use65Card")
                    'modify code 051:end-------------------------------------------------------------------------
                Catch
                    dmCardCost = 0 : dmMinFaceValue = 1 : dmMaxFaceValue = 1000 : blCanUse60Card = False : blCanUse92Card = False : blCanUse94Card = False : blCanUsePaperCard = False : blHaveThreeMedia = True
                    'modify code 051:start-------------------------------------------------------------------------
                    blCanUse65Card = False
                    'modify code 051:end-------------------------------------------------------------------------
                End Try

                If blUsedOldCard OrElse (bNewSalesBillType > 0 AndAlso bNewSalesBillType < 4) Then dmCardCost = 0 : dmMinFaceValue = 0

                If bNewSalesBillType = 4 Then dmCardCost = 0 : dmMinFaceValue = 100 '如果是员工单，不收卡费，最低面值100元
                'modify code 004:start-------------------------------------------------------------------------
                'dtCardCost = New DataTable
                'dtCardCost.Columns.Add("CardCost", System.Type.GetType("System.Decimal"))
                'dtCardCost.Columns.Add("FormattedCardCost", System.Type.GetType("System.String"))
                'For iLevel As Integer = CInt(dmCardCost) To 0 Step -1
                '    dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
                'Next
                'dtCardCost.AcceptChanges()
                'modify code 004:end-------------------------------------------------------------------------

                'modify code 046:start-------------------------------------------------------------------------
                dtHolderInfo = DB.GetDataTable("SELECT * FROM HolderInfoList")
                'modify code 046:end-------------------------------------------------------------------------

                If bNewSalesBillType <> 1 AndAlso drSalesBill("StoreID").ToString <> "" Then
                    sCityID = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
                    'modify code 054:start-------------------------------------------------------------------------
                    'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where CityID=" & sCityID & " And RuleState=2")
                    Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sCityID & " And RuleState=2")
                    'modify code 054:end-------------------------------------------------------------------------
                    If dtCityRule.Rows.Count > 0 Then
                        drNewestCityRule = dtCityRule.Copy.Rows(0)
                        sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                        'modify code 054:start-------------------------------------------------------------------------
                        'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).Copy
                        dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).Copy
                        'modify code 054:end-------------------------------------------------------------------------
                        For Each drDetail As DataRow In dtNewestRuleDetails.Rows
                            drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                        Next
                        drSalesBill("CityRuleID") = sNewestCityRuleID
                    Else
                        sNewestCityRuleID = "-1"
                    End If
                    dtCityRule.Dispose() : dtCityRule = Nothing
                End If

                dtNormalCard.Rows.Add(1)
                dtRebateCard.Rows.Add(1)
                dtPayment.Rows.Add(1, 0)
                If bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
                    dtPayment.Rows(0)("PaymentTerm") = 2
                    dtPayment.Rows(0)("MediaNo") = Format(Today(), "yyyyMMdd")
                    dtPayment.Rows(0)("PayerName") = Me.cbbAvailablePayer.Text
                End If

                dtRowPayment = New DataTable
                dtRowPayment.Columns.Add("CardRowID", System.Type.GetType("System.Int16"))
                dtRowPayment.Columns.Add("PaymentRowID", System.Type.GetType("System.Int16"))
                dtRowPayment.Columns.Add("DistributedAMT", System.Type.GetType("System.Decimal"))
            ElseIf dtSalesBill.Rows.Count = 0 Then
                MessageBox.Show("您所要打开的销售单已经不存在（已被删除）！    ", "销售单不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                If frmSalesBillManagement.IsHandleCreated Then
                    Try
                        frmSalesBillManagement.dvSalesBill.Table.Rows.Find(sSalesBillID).Delete()
                    Catch
                    End Try
                End If
                frmMain.statusText.Text = "销售单不存在！"
                dtNormalCard.Dispose() : dtNormalCard = Nothing
                dtRebateCard.Dispose() : dtRebateCard = Nothing
                dtPayment.Dispose() : dtPayment = Nothing
                dtSalesBill.Dispose() : dtSalesBill = Nothing
                DB.Close() : Me.Close() : Return
            Else
                drSalesBill = dtSalesBill.Rows(0)

                'modify code 040,044:start-------------------------------------------------------------------------
                If drSalesBill("SalesBillType") = 6 Then
                    If strSelectedBuyChannel = "Cul" Then
                        GetInternetBillInfo()
                        If ecir Is Nothing Then
                            dtNormalCard.Dispose() : dtNormalCard = Nothing
                            dtRebateCard.Dispose() : dtRebateCard = Nothing
                            If dtPayment IsNot Nothing Then dtPayment.Dispose() : dtPayment = Nothing
                            DB.Close() : Me.Close()
                            frmMain.statusText.Text = "系统因在检索数据时出错而无法打开销售单。请联系软件开发人员。"
                            Return
                        End If
                    End If
                End If
                'modify code 040,044:start-------------------------------------------------------------------------

                If drSalesBill("SalesBillType") = 4 Then drEmployee = DB.GetDataTable("Select * From EmployeeSales Where SalesBillID=" & sSalesBillID).Rows(0)
                If drSalesBill("SalesBillType") = 5 Then drMember = DB.GetDataTable("Select * From MemberSales Where SalesBillID=" & sSalesBillID).Rows(0)

                sCustomerID = drSalesBill("CustomerID").ToString
                Select Case drSalesBill("RebateMode")
                    Case 1
                        sCityRuleID = drSalesBill("RebateRuleID").ToString
                    Case 2
                        sContractID = drSalesBill("RebateRuleID").ToString
                    Case 3
                        sBalanceContractID = drSalesBill("RebateRuleID").ToString
                End Select

                sCityID = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID"))("ParentAreaID").ToString
                Dim dvCardDetails As DataView = Nothing, drCard As DataRow = Nothing, sFeature As String
                Select Case drSalesBill("TableType")
                    Case 0
                        dvCardDetails = DB.GetDataTable("Select * From NewSalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                    Case 1
                        dvCardDetails = DB.GetDataTable("Select * From PendingSalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                    Case 2
                        dvCardDetails = DB.GetDataTable("Select * From SalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                    Case Else
                        dvCardDetails = DB.GetDataTable("Select * From CancelledSalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                End Select
                If drSalesBill("TableType") = 0 Then
                    dtRowPayment = DB.GetDataTable("Select CardRowID,PaymentRowID,DistributedAMT From NewSalesBillRowPayment Where SalesBillID=" & sSalesBillID).Copy
                Else
                    dtRowPayment = DB.GetDataTable("Select CardRowID,PaymentRowID,DistributedAMT From SalesBillRowPayment Where SalesBillID=" & sSalesBillID).Copy
                End If

                'modify code 004,011:start-------------------------------------------------------------------------
                Dim dtStatusDetail As DataTable
                dtStatusDetail = DB.GetDataTable("select RowID,SalesStatus,BarCode from SalesBillSalesStatusDetails where SalesBillID = " & sSalesBillID).Copy
                'modify code 004,011:end-------------------------------------------------------------------------

                'modify code 046:start-------------------------------------------------------------------------
                dtHolderInfo = DB.GetDataTable("SELECT * FROM HolderInfoList")

                Dim dtSalesBillExtendHis As DataTable
                Dim drSalesBillExtendHis As DataRow
                dtSalesBillExtendHis = DB.GetDataTable("SELECT * FROM SalesBillExtendHis WHERE SalesBillID ='" & sSalesBillID & "'")
                'modify code 046:end-------------------------------------------------------------------------

                dvCardDetails.Sort = "RowID"
                dvCardDetails.RowFilter = "RowType<2"
                For Each dr As DataRowView In dvCardDetails
                    drCard = dtNormalCard.Rows.Add
                    drCard("RowID") = dr("RowID")
                    'modify code 004,011:start-------------------------------------------------------------------------
                    If dtStatusDetail.Rows.Count = 0 Then
                        drCard("FirstBuy") = ""
                        drCard("BarCode") = ""
                    ElseIf dtStatusDetail.Select("RowID = " & dr("RowID")).Length = 0 Then
                        drCard("FirstBuy") = ""
                        drCard("BarCode") = ""
                    Else
                        Dim myDataRow As DataRow = dtStatusDetail.Select("RowID = " & dr("RowID")).GetValue(0)
                        drCard("FirstBuy") = myDataRow.Item("SalesStatus")
                        drCard("BarCode") = myDataRow.Item("BarCode")
                    End If
                    'modify code 004,011:end-------------------------------------------------------------------------
                    If dr("StartCardNo").ToString.IndexOf("9") = 0 Then
                        If dr("StartCardNo").ToString.IndexOf("94") = 0 Then
                            drCard("CardFeature") = "活动券"
                        Else
                            drCard("CardFeature") = "公关券"
                        End If
                    ElseIf dr("StartCardNo").ToString.IndexOf("86") = 0 Then
                        drCard("CardFeature") = "条码卡"
                    ElseIf dr("StartCardNo").ToString.IndexOf("8") = 0 Then
                        sFeature = dr("StartCardNo").ToString.Substring(5, 3)
                        If sFeature = "100" OrElse sFeature.IndexOf("8") = 0 Then
                            drCard("CardFeature") = "条码卡"
                        Else
                            drCard("CardFeature") = "充值券"
                        End If
                    Else
                        If dr("StartCardNo").ToString.IndexOf("233694") = 0 Then
                            drCard("CardFeature") = "活动卡"
                        ElseIf dr("StartCardNo").ToString.IndexOf("233692") = 0 Then
                            drCard("CardFeature") = IIf(drSalesBill("SalesBillType") = 1, "营销卡", "公关卡")
                        ElseIf dr("StartCardNo").ToString.IndexOf("233660") = 0 Then
                            drCard("CardFeature") = "礼品卡"
                        Else
                            drCard("CardFeature") = "磁条卡"
                        End If
                    End If
                    drCard("StartCardNo") = dr("StartCardNo").ToString.Trim
                    drCard("EndCardNo") = dr("EndCardNo").ToString.Trim
                    drCard("CardQTY") = dr("CardQTY")
                    drCard("FaceValue") = dr("FaceValue")
                    drCard("ReducedCardPayment") = dr("FaceValue") + dr("CardCost") - dr("CardPayment")
                    'modify code 004:start-------------------------------------------------------------------------
                    drCard("CardCost") = Format(dr("CardCost"), "#,0.00")
                    'modify code 004:end-------------------------------------------------------------------------
                    drCard("CardPayment") = dr("CardPayment")
                    drCard("ChargedAMT") = dr("FaceValue") * dr("CardQTY")
                    drCard("PayableAMT") = dr("PayableAMT")
                    'modify code 046:start-------------------------------------------------------------------------
                    If dtSalesBillExtendHis.Select("SalesBillDetailID ='" & dr("SalesBillDetailID").ToString & "'").Length > 0 Then
                        drSalesBillExtendHis = dtSalesBillExtendHis.Select("SalesBillDetailID ='" & dr("SalesBillDetailID").ToString & "'")(0)
                        If bNewSalesBillType = 7 Then
                            drCard("HolderIdNo") = drSalesBillExtendHis("HolderIdNo")
                            drCard("HolderName") = drSalesBillExtendHis("HolderName")
                            drCard("Gender") = drSalesBillExtendHis("Gender")
                            drCard("Mobile") = drSalesBillExtendHis("Mobile")
                        ElseIf bNewSalesBillType = 0 Then
                            drCard("IsSignCard") = drSalesBillExtendHis("IsSignCard")
                        End If
                    End If
                    'modify code 046:end-------------------------------------------------------------------------
                    If dtPayment.Rows.Count > 1 Then drCard("PaymentDescription") = Me.FormatPaymentDescription(drCard("RowID").ToString)
                    Select Case dr("ActivationState")
                        Case 0
                            drCard("ActivationState") = "等待激活"
                        Case 1
                            drCard("ActivationState") = "正在激活"
                        Case 2
                            drCard("ActivationState") = "激活失败"
                        Case 3
                            If dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "部分激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "部分激活"
                            End If
                        Case 4
                            If drCard("ChargedAMT") = dr("ActivationCancelledAMT") Then
                                drCard("ActivationState") = "全部激活（已被撤销）"
                            ElseIf dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "全部激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "全部激活"
                            End If
                        Case 9
                            drCard("ActivationState") = "等待取消"
                        Case Else
                            drCard("ActivationState") = "已被取消"
                    End Select
                    drCard("ActivatedQTY") = dr("ActivatedQTY")
                    drCard("ActivatedAMT") = dr("ActivatedAMT")
                    drCard("StateReason") = dr("StateReason")
                    drCard.EndEdit() : drCard.AcceptChanges()
                Next
                dtNormalCard.AcceptChanges()

                'modify code 004:start-------------------------------------------------------------------------
                'dtCardCost = New DataTable
                'dtCardCost.Columns.Add("CardCost", System.Type.GetType("System.Decimal"))
                'dtCardCost.Columns.Add("FormattedCardCost", System.Type.GetType("System.String"))
                'Dim dmMaxCost As Decimal = dvCardDetails.Table.Compute("Max(CardCost)", "")
                'For iLevel As Integer = CInt(dmMaxCost) To 0 Step -1
                '    dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
                'Next
                'dtCardCost.AcceptChanges()
                'modify code 004:end------------------------------------------------------------------------

                dvCardDetails.RowFilter = "RowType=2"
                For Each dr As DataRowView In dvCardDetails
                    drCard = dtRebateCard.Rows.Add
                    drCard("RowID") = dr("RowID")
                    If dr("StartCardNo").ToString.IndexOf("9") = 0 Then
                        drCard("CardFeature") = "营销券"
                    ElseIf dr("StartCardNo").ToString.IndexOf("86") = 0 Then
                        drCard("CardFeature") = "条码卡"
                    ElseIf dr("StartCardNo").ToString.IndexOf("8") = 0 Then
                        sFeature = dr("StartCardNo").ToString.Substring(5, 3)
                        If sFeature = "100" OrElse sFeature.IndexOf("8") = 0 Then
                            drCard("CardFeature") = "条码卡"
                        Else
                            drCard("CardFeature") = "充值券"
                        End If
                    Else
                        If dr("StartCardNo").ToString.IndexOf("233692") = 0 Then
                            drCard("CardFeature") = "营销卡"
                        ElseIf dr("StartCardNo").ToString.IndexOf("233660") = 0 Then
                            drCard("CardFeature") = "礼品卡"
                        Else
                            drCard("CardFeature") = "磁条卡"
                        End If
                    End If
                    drCard("StartCardNo") = dr("StartCardNo").ToString.Trim
                    drCard("EndCardNo") = dr("EndCardNo").ToString.Trim
                    drCard("CardQTY") = dr("CardQTY")
                    drCard("FaceValue") = dr("FaceValue")
                    drCard("ChargedAMT") = dr("FaceValue") * dr("CardQTY")
                    drCard("PayableAMT") = 0
                    'modify code 046,050:start-------------------------------------------------------------------------
                    If dtSalesBillExtendHis.Select("SalesBillDetailID ='" & dr("SalesBillDetailID").ToString & "'").Length > 0 Then
                        drSalesBillExtendHis = dtSalesBillExtendHis.Select("SalesBillDetailID ='" & dr("SalesBillDetailID").ToString & "'")(0)
                        '实名制卡销售单界面返点表追加实名制信息列
                        'drCard("IsSignCard") = drSalesBillExtendHis("IsSignCard")
                        If bNewSalesBillType = 7 Then
                            drCard("HolderIdNo") = drSalesBillExtendHis("HolderIdNo")
                            drCard("HolderName") = drSalesBillExtendHis("HolderName")
                            drCard("Gender") = drSalesBillExtendHis("Gender")
                            drCard("Mobile") = drSalesBillExtendHis("Mobile")
                        ElseIf bNewSalesBillType = 0 Then
                            drCard("IsSignCard") = drSalesBillExtendHis("IsSignCard")
                        End If
                    End If
                    'modify code 046,050:end-------------------------------------------------------------------------
                    Select Case dr("ActivationState")
                        Case 0
                            drCard("ActivationState") = "等待激活"
                        Case 1
                            drCard("ActivationState") = "正在激活"
                        Case 2
                            drCard("ActivationState") = "激活失败"
                        Case 3
                            If dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "部分激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "部分激活"
                            End If
                        Case 4
                            If drCard("ChargedAMT") = dr("ActivationCancelledAMT") Then
                                drCard("ActivationState") = "全部激活（已被撤销）"
                            ElseIf dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "全部激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "全部激活"
                            End If
                        Case 9
                            drCard("ActivationState") = "等待取消"
                        Case Else
                            drCard("ActivationState") = "已被取消"
                    End Select
                    drCard("ActivatedQTY") = dr("ActivatedQTY")
                    drCard("ActivatedAMT") = dr("ActivatedAMT")
                    drCard("StateReason") = dr("StateReason")
                    drCard.EndEdit() : drCard.AcceptChanges()
                Next
                dtRebateCard.AcceptChanges()

                dvCardDetails.Dispose() : dvCardDetails = Nothing
            End If
            dtSalesBill.Dispose() : dtSalesBill = Nothing

            dmTotalChargedAMT = drSalesBill("ChargedAMT")
            dmTotalRebateAMT = drSalesBill("RebateSalesAMT")
            'modify code 040,044:start-------------------------------------------------------------------------
            If sSalesBillID = "-1" AndAlso drSalesBill("SalesBillType") = 6 Then
                If strSelectedBuyChannel = "Cul" Then
                    dmTotalPaymentAMT = ecir.ExtractingCodeInfoData.BillPayTotalAmount + drSalesBill("CardCost")
                Else
                    dmTotalPaymentAMT = cir.CodeAmount / 100 + drSalesBill("CardCost")
                End If
            Else
                dmTotalPaymentAMT = drSalesBill("PayableAMT")
            End If
            'modify code 040,044:end-------------------------------------------------------------------------
            dmTotalPrintedInvoiceAMT = drSalesBill("PrintedInvoiceAMT")
        Catch
            dtNormalCard.Dispose() : dtNormalCard = Nothing
            dtRebateCard.Dispose() : dtRebateCard = Nothing
            If dtPayment IsNot Nothing Then dtPayment.Dispose() : dtPayment = Nothing
            DB.Close() : Me.Close()
            frmMain.statusText.Text = "系统因在检索数据时出错而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请联系软件开发人员。"
            Return
        End Try

        If drSalesBill("StoreID").ToString <> "" AndAlso frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 Then
            Try
                sCityID = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("ParentAreaID").ToString
                Dim dtInovicePrintable As DataTable = DB.GetDataTable("Select * From InvoicePrintable Where CityID=" & sCityID)
                If dtInovicePrintable.Rows.Count = 0 Then
                    drInvoicePrintable = dtInovicePrintable.Copy.Rows.Add()
                    drInvoicePrintable("CityID") = sCityID
                    drInvoicePrintable("CanPrintInvoice") = 1
                    drInvoicePrintable("CanPrintInNextMonth") = 1
                    drInvoicePrintable("MinInvoiceAMT") = 0
                    drInvoicePrintable("MaxInvoiceAMT") = 500000
                    drInvoicePrintable.AcceptChanges()
                Else
                    drInvoicePrintable = dtInovicePrintable.Copy.Rows(0)
                End If
                dtInovicePrintable.Dispose() : dtInovicePrintable = Nothing
            Catch
                sCustomerID = "" : drCustomer = Nothing : drSalesBill = Nothing
                frmMain.statusText.Text = "系统因在检索数据时出错而无法下载发票控制参数。请联系软件开发人员。"
                dtNormalCard.Dispose() : dtNormalCard = Nothing
                dtRebateCard.Dispose() : dtRebateCard = Nothing
                DB.Close() : Me.Close() : Return
            End Try
        End If

        DB.Close()

        dtPaymentTerm = New DataTable
        dtPaymentTerm.Columns.Add("PaymentTerm", System.Type.GetType("System.Byte"))
        dtPaymentTerm.Columns.Add("PaymentTermDescription", System.Type.GetType("System.String"))
        dtPaymentTerm.Rows.Add(0, "现金")
        'modify code 044:start-------------------------------------------------------------------------
        'modify code 040:start-------------------------------------------------------------------------
        'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
        '    'modify code 044:start-------------------------------------------------------------------------
        '    'dtPaymentTerm.Rows.Add(8, "兑换码")
        '    If strSelectedBuyChannel = "Cul" Then
        '        dtPaymentTerm.Rows.Add(8, dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString)
        '    Else
        '        dtPaymentTerm.Rows.Add(11, dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString)
        '    End If
        '    'modify code 044:end-------------------------------------------------------------------------
        'Else
        'modify code 044:end-------------------------------------------------------------------------
        'modify code 016:start-------------------------------------------------------------------------
        '员工单可以使用现金和银行卡，目前只有上海家乐福总部人员可见银行卡支付方式（可设置）
        If sSalesBillID = "-1" And bNewSalesBillType = 4 And dtBankCardStoreID.Rows.Count > 0 Then
            dtPaymentTerm.Rows.Add(1, "银行卡")
        End If
        'modify code 016:end-------------------------------------------------------------------------
        If sSalesBillID <> "-1" OrElse bNewSalesBillType <> 4 Then
            dtPaymentTerm.Rows.Add(1, "银行卡") '''''

            'modify code 085:start-------------------------------------------------------------------------
            dtPaymentTerm.Rows.Add(2, "转账")
            dtPaymentTerm.Rows.Add(3, "支票")
            dtPaymentTerm.Rows.Add(4, "支票＋保证金")
            'dtPaymentTerm.Rows.Add(2, "转账/支票")
            ''dtPaymentTerm.Rows.Add(3, "支票")
            'dtPaymentTerm.Rows.Add(4, "转账/支票＋保证金")
            'dtPaymentTerm.Rows.Add(13, dtCityPaymentTerm.Select("PaymentTerm=13")(0)("PaymentName").ToString)
            'modify code 085:end-------------------------------------------------------------------------

        End If
        If sSalesBillID <> "-1" Then
            dtPaymentTerm.Rows.Add(5, "转账_后付")
            dtPaymentTerm.Rows.Add(6, "支票_后付")
        End If
        'modify code 008:start-------------------------------------------------------------------------
        'If dtCityPaymentTerm.Rows.Count > 0 Then
        If dtCityPaymentTerm.Select("PaymentTerm=7").Length > 0 Then
            'modify code 046,054,072:start-------------------------------------------------------------------------
            '同一般销售单
            'If bNewSalesBillType = 0 Then
            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 Then
            If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                'modify code 046.054,072:end-------------------------------------------------------------------------
                dtPaymentTerm.Rows.Add(7, "积分兑换")
            End If
        End If
        'modify code 008:end-------------------------------------------------------------------------
        'modify code 044:start-------------------------------------------------------------------------
        'End If
        If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
            If sSalesBillID = -1 Then
                If strSelectedBuyChannel = "Cul" Then
                    dtPaymentTerm.Rows.Add(8, dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString)
                Else
                    dtPaymentTerm.Rows.Add(11, dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString)
                End If
            Else
                Dim dtPaymentResult As DataTable
                Dim strsql As String

                DB.Open()
                strsql = "select PaymentTerm from NewSalesBillPayment where RowID=1 and SalesBillID=" & sSalesBillID & _
                   "union select PaymentTerm from SalesBillPayment where RowID=1 and SalesBillID=" & sSalesBillID
                dtPaymentResult = DB.GetDataTable(strsql)

                If CInt(dtPaymentResult.Rows(0)("PaymentTerm").ToString) = 8 Then
                    dtPaymentTerm.Rows.Add(8, dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString)
                ElseIf CInt(dtPaymentResult.Rows(0)("PaymentTerm").ToString) = 11 Then
                    dtPaymentTerm.Rows.Add(11, dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString)
                End If
                DB.Dispose()
            End If
        End If
        'modify code 044:end-------------------------------------------------------------------------
        'modify code 040:end-------------------------------------------------------------------------
        dtPaymentTerm.AcceptChanges()

        If frmMain.dtAllowedRight.Select("RightName='SalesBillNormalCreate'").Length > 0 AndAlso frmMain.dvCardFaceValue Is Nothing AndAlso IO.File.Exists(Application.StartupPath & "\PredefineCardFaceValue\PredefineCardFaceValue.dat") Then
            Dim dtCardFaceValue As New DataTable
            With dtCardFaceValue.Columns
                .Add("RowID", System.Type.GetType("System.Int16"))
                .Add("StartCardNo", System.Type.GetType("System.String"))
                .Add("EndCardNo", System.Type.GetType("System.String"))
                .Add("CardQTY", System.Type.GetType("System.Int32"))
                .Add("FaceValue", System.Type.GetType("System.Decimal"))
            End With
            frmMain.dvCardFaceValue = New DataView(dtCardFaceValue.Copy)
            dtCardFaceValue.Dispose() : dtCardFaceValue = Nothing

            Dim myReader As FileIO.TextFieldParser = Nothing, currentRow As String(), newCardRow As DataRowView = Nothing
            Try
                myReader = New FileIO.TextFieldParser(Application.StartupPath & "\PredefineCardFaceValue\PredefineCardFaceValue.dat")
                myReader.TextFieldType = FileIO.FieldType.Delimited
                myReader.Delimiters = New String() {vbTab}
                While Not myReader.EndOfData
                    Try
                        currentRow = myReader.ReadFields()
                        newCardRow = frmMain.dvCardFaceValue.AddNew
                        If currentRow.Length = 5 AndAlso currentRow(1).ToString <> "" Then
                            For bColumn As Byte = 0 To 4
                                newCardRow(bColumn) = currentRow(bColumn)
                            Next
                        End If
                        newCardRow.EndEdit()
                    Catch
                        newCardRow.Row.RejectChanges()
                    End Try
                End While
            Finally
                If myReader IsNot Nothing Then
                    myReader.Close()
                    myReader.Dispose()
                    myReader = Nothing
                End If
            End Try
            frmMain.dvCardFaceValue.Table.Rows.Add(frmMain.dvCardFaceValue.Count + 1)
            frmMain.dvCardFaceValue.Table.AcceptChanges()
        End If

        Dim dvStore As DataView = frmMain.dtLoginStructure.Copy.DefaultView
        dvStore.RowFilter = "AreaType='S'"
        dvStore.Sort = "SortCode"
        dvStore = dvStore.ToTable(False, "AreaID", "AreaName").DefaultView
        With Me.cbbSelectStore
            .DataSource = dvStore
            .ValueMember = "AreaID"
            .DisplayMember = "AreaName"
            If dtInternalPayer.Rows.Count > 0 Then .SelectedValue = dtInternalPayer.Rows(0)("StoreID")
        End With

        With Me.dgvNormalCard
            .DataSource = dtNormalCard
            With .Columns(0)
                .HeaderText = "行号"
                .Width = 36
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .DefaultCellStyle.BackColor = SystemColors.Control
                .DefaultCellStyle.ForeColor = SystemColors.ControlText
                .DefaultCellStyle.SelectionBackColor = SystemColors.Control
                .DefaultCellStyle.SelectionForeColor = SystemColors.ControlText
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            'modify code 004:start-------------------------------------------------------------------------
            If sSalesBillID = -1 Then
                Dim newColumnFirstBuy As New DataGridViewComboBoxColumn
                With newColumnFirstBuy
                    .DataPropertyName = "FirstBuy"
                    '.DataSource = dtFirstBuy
                    .ValueMember = "FirstBuy"
                    .DisplayMember = "FirstBuy"
                    .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                    .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                End With
                .Columns.RemoveAt(1)
                .Columns.Insert(1, newColumnFirstBuy)
                With .Columns(1)
                    .HeaderText = "购卡/充值"
                    .Width = 90
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                End With
            Else
                With .Columns(1)
                    .HeaderText = "购卡/充值"
                    .Width = 90
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                    .ReadOnly = True
                End With
            End If
            'modify code 004:end-------------------------------------------------------------------------
            With .Columns(2)
                .HeaderText = "卡类型"
                .Width = 50
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(3)
                .HeaderText = "开始卡号"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(4)
                .HeaderText = "结束卡号"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(5)
                .HeaderText = "数量"
                .MinimumWidth = 50
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            'modify code 011:start-------------------------------------------------------------------------
            With .Columns(6)
                .HeaderText = "条码"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            'modify code 011:end-------------------------------------------------------------------------
            With .Columns(7)
                .HeaderText = "面值"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.True
            End With
            With .Columns(8)
                .HeaderText = "单张抵扣"
                .MinimumWidth = 60
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
                .Visible = False
            End With
            'modify code 004:start-------------------------------------------------------------------------
            If sSalesBillID = -1 Then
                Dim newColumn As New DataGridViewComboBoxColumn
                With newColumn
                    .DataPropertyName = "CardCost"
                    '.DataSource = dtCardCost
                    .ValueMember = "CardCost"
                    '.DisplayMember = "FormattedCardCost"
                    .DisplayMember = "CardCost"
                    .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                    .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                End With
                .Columns.RemoveAt(9)
                .Columns.Insert(9, newColumn)
                With .Columns(9)
                    .HeaderText = "卡费/张"
                    .Width = 80
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                End With
            Else
                With .Columns(9)
                    .HeaderText = "卡费/张"
                    .Width = 80
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                    .ReadOnly = True
                End With
            End If
            'modify code 004:start-------------------------------------------------------------------------
            With .Columns(10)
                .HeaderText = "单张应付"
                .MinimumWidth = 60
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
                .Visible = False
            End With
            With .Columns(11)
                .HeaderText = "充值总计"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(12)
                .HeaderText = "应付总计"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(13)
                .HeaderText = "付款分配"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(14)
                .HeaderText = "激活状态"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .MinimumWidth = 70
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(15)
                .HeaderText = "激活卡数"
                .MinimumWidth = 50
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(16)
                .HeaderText = "激活金额"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(17)
                .HeaderText = "状态说明"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            .Columns(18).Visible = False
            'modify code 046:start-------------------------------------------------------------------------
            '实名制追加新的列
            With .Columns(19)
                .HeaderText = "持卡人姓名"
                .Width = 80
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            If sSalesBillID = -1 Then
                Dim newColumn As New DataGridViewComboBoxColumn
                newColumn.Items.Add("男")
                newColumn.Items.Add("女")
                With newColumn
                    .DataPropertyName = "Gender"
                    .ValueMember = "Gender"
                    .DisplayMember = "Gender"
                    .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                    .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                End With
                .Columns.RemoveAt(20)
                .Columns.Insert(20, newColumn)
                With .Columns(20)
                    .HeaderText = "性别"
                    .Width = 50
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                End With
            Else
                With .Columns(20)
                    .HeaderText = "性别"
                    .Width = 50
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                    .ReadOnly = True
                End With
            End If
            With .Columns(21)
                .HeaderText = "持卡人身份证"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(22)
                .HeaderText = "持卡人手机"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(23)
                .HeaderText = "实名卡"
                .Width = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            'modify code 046:end-------------------------------------------------------------------------
        End With

        For bColumn As Byte = 0 To dtNormalCard.Columns.Count - 1
            Me.dgvNormalCard.Columns(bColumn).Name = dtNormalCard.Columns(bColumn).ColumnName
        Next
        'modify code 050:start-------------------------------------------------------------------------
        'modify code 046:start-------------------------------------------------------------------------
        '一般销售单及实名制卡销售单界面显示切换
        'If bNewSalesBillType = 0 Then
        '    Me.dgvNormalCard.Columns(19).Visible = False
        '    Me.dgvNormalCard.Columns(20).Visible = False
        '    Me.dgvNormalCard.Columns(21).Visible = False
        '    Me.dgvNormalCard.Columns(22).Visible = False
        '    Me.dgvNormalCard.Columns(23).Visible = True
        'ElseIf bNewSalesBillType = 7 Then
        '    Me.dgvNormalCard.Columns(19).Visible = True
        '    Me.dgvNormalCard.Columns(20).Visible = True
        '    Me.dgvNormalCard.Columns(21).Visible = True
        '    Me.dgvNormalCard.Columns(22).Visible = True
        '    Me.dgvNormalCard.Columns(23).Visible = False
        'Else
        '    Me.dgvNormalCard.Columns(19).Visible = False
        '    Me.dgvNormalCard.Columns(20).Visible = False
        '    Me.dgvNormalCard.Columns(21).Visible = False
        '    Me.dgvNormalCard.Columns(22).Visible = False
        '    Me.dgvNormalCard.Columns(23).Visible = False
        'End If
        Me.dgvNormalCard.Columns(23).Visible = False
        If bNewSalesBillType = 7 Then
            Me.dgvNormalCard.Columns(19).Visible = True
            Me.dgvNormalCard.Columns(20).Visible = True
            Me.dgvNormalCard.Columns(21).Visible = True
            Me.dgvNormalCard.Columns(22).Visible = True
        Else
            Me.dgvNormalCard.Columns(19).Visible = False
            Me.dgvNormalCard.Columns(20).Visible = False
            Me.dgvNormalCard.Columns(21).Visible = False
            Me.dgvNormalCard.Columns(22).Visible = False
        End If
        'modify code 046:end-------------------------------------------------------------------------
        'modify code 050:end-------------------------------------------------------------------------
        'modify code 004:start-------------------------------------------------------------------------

        If bNewSalesBillType = 9 Then
            dtCardCost = New DataTable
            dtCardCost.Columns.Add("CardCost", System.Type.GetType("System.Decimal"))
            dtCardCost.Columns.Add("FormattedCardCost", System.Type.GetType("System.String"))
        End If

        'Dim dmMaxCost As Decimal = dvCardDetails.Table.Compute("Max(CardCost)", "")
        'For iLevel As Integer = CInt(dmMaxCost) To 0 Step -1
        '    dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
        'Next
        'dtCardCost.AcceptChanges()
        'modify code 004:end------------------------------------------------------------------------

        With Me.dgvRebateCard
            .DataSource = dtRebateCard
            With .Columns(0)
                .HeaderText = "行号"
                .Width = 36
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .DefaultCellStyle.BackColor = SystemColors.Control
                .DefaultCellStyle.ForeColor = SystemColors.ControlText
                .DefaultCellStyle.SelectionBackColor = SystemColors.Control
                .DefaultCellStyle.SelectionForeColor = SystemColors.ControlText
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(1)
                .HeaderText = "卡类型"
                .Width = 50
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(2)
                .HeaderText = "开始卡号"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(3)
                .HeaderText = "结束卡号"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(4)
                .HeaderText = "数量"
                .MinimumWidth = 50
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(5)
                .HeaderText = "面值"
                .MinimumWidth = 50
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(6)
                .HeaderText = "充值总计"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(7)
                .HeaderText = "应付总计"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(8)
                .HeaderText = "激活状态"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .MinimumWidth = 70
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(9)
                .HeaderText = "激活卡数"
                .MinimumWidth = 50
                .FillWeight = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(10)
                .HeaderText = "激活金额"
                .MinimumWidth = 60
                .FillWeight = 100
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(11)
                .HeaderText = "状态说明"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            'modify code 046:start-------------------------------------------------------------------------
            With .Columns(12)
                .HeaderText = "实名卡"
                .Width = 50
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            'modify code 046:end-------------------------------------------------------------------------
            'modify code 050:start-------------------------------------------------------------------------
            '实名制卡销售单界面返点表追加实名制信息列
            With .Columns(13)
                .HeaderText = "持卡人姓名"
                .Width = 80
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            If sSalesBillID = -1 Then
                Dim newColumn As New DataGridViewComboBoxColumn
                newColumn.Items.Add("男")
                newColumn.Items.Add("女")
                With newColumn
                    .DataPropertyName = "Gender"
                    .ValueMember = "Gender"
                    .DisplayMember = "Gender"
                    .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                    .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                End With
                .Columns.RemoveAt(14)
                .Columns.Insert(14, newColumn)
                With .Columns(14)
                    .HeaderText = "性别"
                    .Width = 50
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                End With
            Else
                With .Columns(14)
                    .HeaderText = "性别"
                    .Width = 50
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                    .ReadOnly = True
                End With
            End If
            With .Columns(15)
                .HeaderText = "持卡人身份证"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(16)
                .HeaderText = "持卡人手机"
                .Width = 125
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            'modify code 050:end-------------------------------------------------------------------------
        End With
        For bColumn As Byte = 0 To dtRebateCard.Columns.Count - 1
            Me.dgvRebateCard.Columns(bColumn).Name = dtRebateCard.Columns(bColumn).ColumnName
        Next

        'modify code 050:start-------------------------------------------------------------------------
        Me.dgvRebateCard.Columns(12).Visible = False
        '实名制卡销售单界面返点表追加实名制信息列
        If bNewSalesBillType = 7 Then
            Me.dgvRebateCard.Columns(13).Visible = True
            Me.dgvRebateCard.Columns(14).Visible = True
            Me.dgvRebateCard.Columns(15).Visible = True
            Me.dgvRebateCard.Columns(16).Visible = True
        Else
            Me.dgvRebateCard.Columns(13).Visible = False
            Me.dgvRebateCard.Columns(14).Visible = False
            Me.dgvRebateCard.Columns(15).Visible = False
            Me.dgvRebateCard.Columns(16).Visible = False
        End If
        'modify code 050:end-------------------------------------------------------------------------

        With Me.dgvPayment
            .DataSource = dtPayment
            With .Columns(0)
                .HeaderText = "行号"
                .Width = 36
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .DefaultCellStyle.BackColor = SystemColors.Control
                .DefaultCellStyle.ForeColor = SystemColors.ControlText
                .DefaultCellStyle.SelectionBackColor = SystemColors.Control
                .DefaultCellStyle.SelectionForeColor = SystemColors.ControlText
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            Dim newColumn As New DataGridViewComboBoxColumn
            With newColumn
                .DataPropertyName = "PaymentTerm"
                .DataSource = dtPaymentTerm
                .ValueMember = "PaymentTerm"
                .DisplayMember = "PaymentTermDescription"
                .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
            End With
            .Columns.RemoveAt(1)
            .Columns.Insert(1, newColumn)
            With .Columns(1)
                .HeaderText = "付款方式"
                .Width = 81
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(2)
                .HeaderText = "付款金额"
                .MinimumWidth = 75
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            With .Columns(3)
                'modify code 008:start-------------------------------------------------------------------------
                '.HeaderText = "卡/账/支票号"
                .HeaderText = "卡/账/支票号/兑换号"
                'modify code 085:start-------------------------------------------------------------------------
                If Not dtPayment Is Nothing AndAlso dtPayment.Rows.Count > 0 Then
                    If dtPayment.Rows(0)("PaymentTerm").ToString = "13" Then
                        .HeaderText = "领卡用途"
                    End If
                End If
                'modify code 085:end-------------------------------------------------------------------------
                'modify code 008:end-------------------------------------------------------------------------
                .MinimumWidth = 75
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            CType(.Columns(3), DataGridViewTextBoxColumn).MaxInputLength = 50
            With .Columns(4)
                .HeaderText = "持卡人/付款单位"
                'modify code 085:start-------------------------------------------------------------------------
                If Not dtPayment Is Nothing AndAlso dtPayment.Rows.Count > 0 Then
                    If dtPayment.Rows(0)("PaymentTerm").ToString = "13" Then
                        .HeaderText = "领卡部门"
                    End If
                End If
                'modify code 085:end-------------------------------------------------------------------------
                .MinimumWidth = 75
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            CType(.Columns(4), DataGridViewTextBoxColumn).MaxInputLength = 100
            With .Columns(5)
                .HeaderText = "到账状态"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(6)
                .HeaderText = "确认者"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
            With .Columns(7)
                .HeaderText = "确认时间"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .DefaultCellStyle.Format = "yyyy\/MM\/dd HH:mm:ss"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
            End With
        End With
        For bColumn As Byte = 0 To dtPayment.Columns.Count - 1
            Me.dgvPayment.Columns(bColumn).Name = dtPayment.Columns(bColumn).ColumnName
        Next

        With Me.dgvSelectablePayment
            .DataSource = dtSelectablePayment
            Dim newCheckColumn As New DataGridViewCheckBoxColumn()
            newCheckColumn.DataPropertyName = "Selected"
            .Columns.RemoveAt(0)
            .Columns.Insert(0, newCheckColumn)
            With .Columns(0)
                .HeaderText = "选择"
                .Width = 36
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
                .Selected = False
            End With
            With .Columns(1)
                .HeaderText = "行号"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Width = 36
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
                .Selected = False
            End With
            With .Columns(2)
                .HeaderText = "付款方式"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
                .Selected = False
            End With
            With .Columns(3)
                .HeaderText = "可用金额"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                .Resizable = DataGridViewTriState.False
                .ReadOnly = True
                .Selected = False
            End With
            With .Columns(4)
                .HeaderText = "分配金额"
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .DefaultCellStyle.Format = "#,0.00"
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.ColumnHeader
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .Resizable = DataGridViewTriState.False
            End With
        End With
        For bColumn As Byte = 0 To dtSelectablePayment.Columns.Count - 1
            Me.dgvSelectablePayment.Columns(bColumn).Name = dtSelectablePayment.Columns(bColumn).ColumnName
        Next

        If sSalesBillID = "-1" Then
            Me.FillNewSalesBill()
        Else
            Me.FillSalesBill()
        End If

        'modify code 040,044:start-------------------------------------------------------------------------
        If drSalesBill("SalesBillType") = 6 And sSalesBillID = "-1" Then
            If strSelectedBuyChannel = "Cul" Then
                SetInternetBillInfo()
            Else
                SetInternetRuiTaiInfo()
            End If
            dtSelectablePayment.Rows.Add(0, Me.dgvPayment("RowID", 0).Value, Me.dgvPayment("PaymentTerm", 0).FormattedValue)
        End If
        'modify code 040,044:end-------------------------------------------------------------------------

        Try
            Me.splitRight.SplitterDistance = Me.Height - 219
        Catch
        End Try

        Me.ResetInterfaceLayout()

        Me.Activate()
        If sSalesBillID = "-1" AndAlso sBalanceContractID <> "" AndAlso (sBalanceContractAppointedStoreID = "" OrElse sBalanceContractAppointedStoreID = drSalesBill("StoreID").ToString) AndAlso _
        MessageBox.Show("发现当前客户存在已到期但仍有剩余返点等待结算的合同。    " & Chr(13) & Chr(13) & _
                        "是否现在就结算该合同的剩余返点？    " & Chr(13) & Chr(13) & _
                        "注意：结算到期合同的剩余返点时，不能售卖正常卡。    ", "是否结算到期合同的剩余返点？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.Yes Then
            Me.Activate()
            Me.chbBalanceContract.Checked = True
        ElseIf bNewSalesBillType = 5 Then
            Me.txbMemberName.Select()
            Me.txbMemberName.SelectAll()
        ElseIf bNewSalesBillType = 4 Then
            If Me.dgvRebateCard.CurrentCell IsNot Nothing Then Me.dgvRebateCard.CurrentCell.Selected = False
            If Me.dgvRebateCard.CurrentRow IsNot Nothing Then Me.dgvRebateCard.CurrentRow.Selected = False
            Me.txbInputEmployeeNo.Select()
            Me.txbInputEmployeeNo.SelectAll()
            frmMain.statusText.Text = "请输入员工编号。"
        ElseIf bNewSalesBillType = 2 Then
            Me.txbPromotionTitle.Select() : Me.txbPromotionTitle.SelectAll()
            'modify code 046,054,072:start-------------------------------------------------------------------------
            '同一般销售单
            'ElseIf bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
        ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'modify code 046,054,072:end-------------------------------------------------------------------------
            Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll()
        ElseIf Me.txbBuyerName.Visible = True Then
            Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
        Else
            Me.cbbBuyerName.Select() : Me.cbbBuyerName.SelectAll()
        End If

        'If drSalesBill("CustomerType") = 1 AndAlso sCustomerID = "" Then '北京使用
        '    Me.txbCustomerName.Select()
        '    sTimerType = "CreateNewSalesBill"
        '    Me.theTimer.Interval = 100
        '    Me.theTimer.Enabled = True
        'End If

        'modify code 047:start-------------------------------------------------------------------------
        If isSignCard Then
            Me.dgvNormalCard("StartCardNo", 0).Value = signCardNo
        End If
        'modify code 047:end-------------------------------------------------------------------------
    End Sub

    Private Sub frmSelling_Resize(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Resize
        If Not Me.Created Then Return
        Me.ResetInterfaceLayout()
        If Me.pnlAddjustSalesman.Visible = True Then
            Dim iHeight As Integer = Me.flpLeftContainer.Height - Me.grbSalesBillInfo.Height - Me.grbSalesBillInfo.Top - 6
            If iHeight < 28 Then iHeight = 28
            Me.pnlAddjustSalesman.Height = iHeight
            Me.ResetInterfaceLayout()
        End If

        If sSalesBillID <> "-1" OrElse Me.dgvNormalCard.CurrentCell Is Nothing OrElse Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "PaymentDescription" Then Return
        Me.pcbSelectablPayment.Visible = False
        Me.pnlSelectablePayment.Visible = False
        Me.pcbSelectablPayment.Image = My.Resources.PaymentDown
        If Me.dgvNormalCard.CurrentRow IsNot Nothing AndAlso Me.dgvNormalCard.CurrentRow.Displayed AndAlso Me.dgvNormalCard.Columns("PaymentDescription").Displayed Then
            Me.pcbSelectablPayment.Location = Me.GetRowPaymentPicLocation
            Me.pcbSelectablPayment.Visible = True
        End If
    End Sub

    Private Sub theTimer_Tick(ByVal sender As Object, ByVal e As System.EventArgs) Handles theTimer.Tick
        If sTimerType = "HightLightCardResultButton" Then
            Select Case bHightLightTimes
                Case 0, 2, 4, 6
                    Me.btnViewActivation.Text = ""
                Case 1, 3, 5, 7
                    Me.btnViewActivation.Text = "显示卡片检查结果(&R)"
                Case Else
                    Me.theTimer.Enabled = False
            End Select
            bHightLightTimes += 1
            Return
        End If

        Me.theTimer.Enabled = False
        Select Case sTimerType
            Case "CustomerError"
                Me.cbbCompanyCredentialsType.SelectionLength = 0
                If Me.splitLayout.ActiveControl IsNot Nothing AndAlso Me.splitLayout.ActiveControl.Name <> "cbbCustomerType" AndAlso Me.splitLayout.ActiveControl.Name <> "cbbSalesBillType" AndAlso Me.splitLayout.ActiveControl.Name <> "btnNewCustomer" Then
                    If Me.txbCustomerName.Visible = True Then
                        Me.txbCustomerName.Focus() : Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
                    Else
                        Me.cbbCustomerName.Cursor = Cursors.Arrow
                        Me.cbbCustomerName.Focus() : Me.cbbCustomerName.Select() : Me.cbbCustomerName.SelectAll() : Me.cbbCustomerName.DroppedDown = True
                    End If
                Else
                    frmMain.statusText.Text = "就绪。"
                End If
            Case "CompanyCredentialsNoError"
                Me.cbbCompanyCredentialsType.SelectionLength = 0 : Me.cbbBuyerName.SelectionLength = 0 : Me.cbbBuyerCredentialsType.SelectionLength = 0 : Me.cbbTelMP.SelectionLength = 0
                Me.txbCompanyCredentialsNo.Focus() : Me.txbCompanyCredentialsNo.Select() : Me.txbCompanyCredentialsNo.SelectAll()
                frmMain.statusText.Text = sCustomerPrompt
            Case "TelMPError"
                If Me.txbTelMP.Visible Then
                    Me.txbTelMP.Focus() : Me.txbTelMP.Select() : Me.txbTelMP.SelectAll()
                Else
                    Me.cbbTelMP.Cursor = Cursors.Arrow
                    Me.cbbTelMP.Focus() : Me.cbbTelMP.Select() : Me.cbbTelMP.SelectAll() : Me.cbbTelMP.DroppedDown = True
                End If
                frmMain.statusText.Text = sCustomerPrompt
            Case "BuyerCredentialsNoError"
                Me.cbbBuyerCredentialsType.SelectionLength = 0
                Me.txbBuyerCredentialsNo.Focus() : Me.txbBuyerCredentialsNo.Select() : Me.txbBuyerCredentialsNo.SelectAll()
                frmMain.statusText.Text = sCustomerPrompt
            Case "DoubleClick"
                bClicks = 0
            Case "CreateCustomer"
                Me.btnNewCustomer.PerformClick()
            Case "AfterCreatedCustomer"
                Me.cbbCompanyCredentialsType.Focus() : Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll()
                frmMain.statusText.Text = "创建客户成功。"
            Case "AfterSelectCustomer"
                If errorNormalCell IsNot Nothing Then
                    Me.dgvNormalCard.Select() : errorNormalCell.Selected = True
                ElseIf Me.dgvRebateCard.Visible AndAlso errorRebateCell IsNot Nothing Then
                    Me.dgvRebateCard.Select() : errorRebateCell.Selected = True
                ElseIf Me.txbCompanyCredentialsNo.Text = "" Then
                    Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll()
                ElseIf Me.txbBuyerName.Visible = True Then
                    Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
                Else
                    Me.cbbBuyerName.Select() : Me.cbbBuyerName.SelectAll()
                End If
            Case "BrushingCard"
                blBrushingEnd = True
            Case "SingleDistributedAMTError"
                Me.dgvSelectablePayment.Select()
                errorNormalCell.Selected = True
                Me.dgvSelectablePayment.BeginEdit(True)
                errorNormalCell = Nothing
            Case "DistributedAMTError"
                Me.dgvNormalCard("PayableAMT", errorNormalCell.RowIndex).Selected = True
                errorNormalCell.Selected = True
            Case "CreateNewSalesBill"
                sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
                frmMain.statusText.Text = sCustomerPrompt
            Case "EmployeeError"
                If sEmployeePrompt = "" Then
                    MessageBox.Show("您还未输入员工编号！请先输入员工编号。    ", "请输入员工编号。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sEmployeePrompt = "请输入员工编号。"
                End If
                Me.txbInputEmployeeNo.Focus()
                Me.txbInputEmployeeNo.Select()
                Me.txbInputEmployeeNo.SelectAll()
                frmMain.statusText.Text = sEmployeePrompt
        End Select
        sTimerType = ""
    End Sub

    Private Sub txbInputEmployeeNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbInputEmployeeNo.KeyDown
        If e.KeyCode = Keys.Enter AndAlso Me.btnEmployeeNo.Enabled Then Me.btnEmployeeNo.PerformClick() : e.SuppressKeyPress = True : Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If (e.KeyCode >= Keys.A AndAlso e.KeyCode <= Keys.Z) Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbInputEmployeeNo_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbInputEmployeeNo.Leave
        If Me.btnEmployeeNo.Enabled Then Me.btnEmployeeNo.PerformClick()
    End Sub

    Private Sub txbInputEmployeeNo_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txbInputEmployeeNo.TextChanged
        If blSkipDeal Then Return
        sEmployeeID = ""
        If Me.grbEmployeeInfo.Visible Then
            Me.grbEmployeeInfo.Visible = False
            Me.grbInputEmployeeTel.Visible = False
            Me.grbEmployeeQuota.Visible = False
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
            Me.grbPrintDiscount.Visible = False
            Me.ResetInterfaceLayout()
        End If

        sEmployeePrompt = "请输入员工编号。"
        Me.btnEmployeeNo.Enabled = (Me.txbInputEmployeeNo.Text.Trim <> "")
        frmMain.statusText.Text = sEmployeePrompt
    End Sub

    Private Sub btnEmployeeNo_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnEmployeeNo.Click
        sEmployeeNo = Me.txbInputEmployeeNo.Text.Trim

        If sEmployeeNo.Length < 10 Then
            MessageBox.Show("您输入的员工编号不足 10 位！    ", "员工编号不足 10位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sEmployeePrompt = "员工编号不足 10位！"
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select()
            Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False : Return
        End If

        If sEmployeeNo.Length = 10 Then
            Dim bCharLength As Byte = 5
            If Not IsNumeric(sEmployeeNo.Substring(5)) Then bCharLength = 6
            For bChar As Byte = 0 To bCharLength - 1
                If Asc(sEmployeeNo.Substring(bChar, 1)) < 65 OrElse Asc(sEmployeeNo.Substring(bChar, 1)) > 90 Then
                    sEmployeeNo = ""
                    Exit For
                End If
            Next
            If sEmployeeNo <> "" Then
                For bChar As Byte = bCharLength To 9
                    If Asc(sEmployeeNo.Substring(bChar, 1)) < 48 OrElse Asc(sEmployeeNo.Substring(bChar, 1)) > 57 Then
                        sEmployeeNo = ""
                        Exit For
                    End If
                Next
            End If
        Else
            sEmployeeNo = ""
        End If

        If sEmployeeNo = "" Then
            MessageBox.Show("员工编号格式错误！    " & Chr(13) & Chr(13) & "员工编号一般由5位字母和5位数字组成。    " & Chr(13) & Chr(13) & "请重新输入员工编号。    ", "员工编号格式错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sEmployeePrompt = "员工编号格式错误（一般由5位字母和5位数字组成）！"
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select()
            Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False : Return
        End If

        If sEmployeeNo = sOldEmployeeNo Then
            If drEmployee IsNot Nothing Then
                sEmployeeID = sOldEmployeeID
                Me.grbEmployeeInfo.Visible = True
                Me.grbInputEmployeeTel.Visible = (drEmployee("EmployeeState").ToString <> "离职" AndAlso drEmployee("CurrentMonth").ToString = drEmployee("QuotaMonth").ToString AndAlso drEmployee("PurchaseQuota") > drEmployee("UsedPurchaseQuota"))
                Me.grbEmployeeQuota.Visible = (drEmployee("EmployeeState").ToString <> "离职" AndAlso drEmployee("CurrentMonth").ToString = drEmployee("QuotaMonth").ToString)
            End If
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
            Me.ResetInterfaceLayout()
            frmMain.statusText.Text = sOldEmployeePrompt
            Me.btnEmployeeNo.Enabled = False : Return
        End If

        Me.Cursor = Cursors.WaitCursor
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法下载员工资料。请检查数据库连接。"
            Me.Cursor = Cursors.Default : Return
        End If

        Dim dtEmployee As DataTable = DB.GetDataTable("Exec GetEmployeeInfo " & frmMain.sLoginUserID & ",'" & sEmployeeNo & "'")
        DB.Close()
        If dtEmployee Is Nothing Then
            frmMain.statusText.Text = "系统因在检索数据时出错而无法检索员工。请联系软件开发人员。"
            Me.Cursor = Cursors.Default : Return
        End If

        sOldEmployeeNo = sEmployeeNo
        drEmployee = dtEmployee.Copy.Rows(0)
        dtEmployee.Dispose() : dtEmployee = Nothing

        If drEmployee("Result").ToString <> "OK" Then
            Select Case drEmployee("Result").ToString
                Case "NotFound"
                    MessageBox.Show("未发现此编号的员工！     ", "员工编号不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sEmployeePrompt = "员工编号不存在！"
                Case "MissingArea"
                    MessageBox.Show("此员工信息不齐全！无法确定员工购买资格！    " & Chr(13) & Chr(13) & "备注：员工信息来自家乐福薪资系统（Payroll System）。    ", "员工Payroll信息不完全！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sEmployeePrompt = "员工Payroll信息不完全！"
                Case "OverCity"
                    MessageBox.Show("此员工不属于本市员工，不接受该员工的购买！    ", "员工不能跨市购卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sEmployeePrompt = "员工不能跨市购卡！"
                Case "OverStore"
                    MessageBox.Show("此员工不属于本店员工，不接受该员工的购买！    ", "员工不能跨店购卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sEmployeePrompt = "员工不能跨店购卡！"
            End Select
            drEmployee = Nothing
            sOldEmployeePrompt = sEmployeePrompt
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select() : Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False
            Me.Cursor = Cursors.Default : Return
        End If

        Me.grbEmployeeInfo.Visible = True
        Me.grbEmployeeInfo.Text = "请核对员工信息："
        Me.txbEmployeeName.Text = drEmployee("EmployeeName").ToString
        Me.txbEmployeeIDType.Text = drEmployee("IDType").ToString
        Me.lblEmployeeIDNo.Text = "证件号码（" & drEmployee("IDNo").ToString.Length.ToString & " 位）："
        Me.txbEmployeeIDNo.Text = drEmployee("IDNo").ToString
        Me.txbOfficeName.Text = drEmployee("OfficeName").ToString
        Me.txbLevelName.Text = drEmployee("LevelName").ToString
        Me.txbEmployeeState.Text = drEmployee("EmployeeState").ToString

        If drEmployee("EmployeeState").ToString = "离职" Then
            Me.grbEmployeeInfo.Text = "员工信息："
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
            Me.ResetInterfaceLayout()
            MessageBox.Show("此员工已离职，不能再享受购卡优惠政策！    ", "离职员工不再享受购卡优惠！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sEmployeePrompt = "离职员工不再享受购卡优惠！"
            sOldEmployeePrompt = sEmployeePrompt
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select() : Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False
            Me.Cursor = Cursors.Default : Return
        End If

        If drEmployee("QuotaMonth").ToString = "" Then
            Me.grbEmployeeInfo.Text = "员工信息："
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
            Me.ResetInterfaceLayout()
            MessageBox.Show("新进员工需要等到下个月1号起才能享受购卡优惠政策！    ", "新进员工暂不能享受购卡优惠政策！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sEmployeePrompt = "新进员工暂不能享受购卡优惠政策！"
            sOldEmployeePrompt = sEmployeePrompt
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select() : Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False
            Me.Cursor = Cursors.Default : Return
        End If

        If drEmployee("CurrentMonth").ToString <> drEmployee("QuotaMonth").ToString Then
            Me.grbEmployeeInfo.Text = "员工信息："
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
            Me.ResetInterfaceLayout()
            If drEmployee("EmployeeState").ToString = "转移" Then
                MessageBox.Show("此员工已转移（调离本" & IIf(drEmployee("StoreID").ToString = "", "市", "店") & "！不可再在本" & IIf(drEmployee("StoreID").ToString = "", "市", "店") & "购卡。    ", "该员工已转移！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                sEmployeePrompt = "此员工已转移（调离本" & IIf(drEmployee("StoreID").ToString = "", "市", "店") & "！"
            Else
                MessageBox.Show("系统还未设置本月员工的购买额度！请联系系统管理员。    ", "系统还未设置本月员工的购买额度！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                sEmployeePrompt = "系统还未设置本月员工的购买额度！"
            End If
            sOldEmployeePrompt = sEmployeePrompt
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select() : Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False
            Me.Cursor = Cursors.Default : Return
        End If

        Me.grbEmployeeQuota.Visible = True
        Me.txbPurchaseQuota.Text = Format(drEmployee("PurchaseQuota"), "#,0.00")
        'modify code 038:start-------------------------------------------------------------------------
        'Me.txbRateQuota.Text = Format(drEmployee("RateQuota") * 100, "#,0.0")
        Me.txbRateQuota.Text = Format(drEmployee("RateQuota") * 100, "#,0.00")
        'modify code 038:end-------------------------------------------------------------------------
        Me.txbRebateQuota.Text = Format(drEmployee("PurchaseQuota") * drEmployee("RateQuota"), "#,0.00")
        Me.txbUsedPurchaseQuota.Text = Format(drEmployee("UsedPurchaseQuota"), "#,0.00")
        Me.txbUsedRebateQuota.Text = Format(drEmployee("UsedPurchaseQuota") * drEmployee("RateQuota"), "#,0.00")

        If drEmployee("UsedPurchaseQuota") >= drEmployee("PurchaseQuota") Then
            Me.grbEmployeeInfo.Text = "员工信息："
            Me.tlpAvailableQuota.Visible = False
            Me.tlpDistributedQuota.Visible = False
            Me.tlpBalanceQuota.Visible = False
            Me.flpEmployeeQuota.AutoSize = False
            Me.flpEmployeeQuota.AutoSize = True
            Me.grbEmployeeQuota.Height = Me.flpEmployeeQuota.Height + 25
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
            Me.ResetInterfaceLayout()
            MessageBox.Show("此员工本月的优惠购买额度已用完！    " & Chr(13) & Chr(13) & "所以，该员工在本月内不再享受购卡优惠。    ", "此员工本月的优惠购买额度已用完！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sEmployeePrompt = "此员工本月的优惠购买额度已用完！"
            sOldEmployeePrompt = sEmployeePrompt
            frmMain.statusText.Text = sEmployeePrompt
            Me.txbInputEmployeeNo.Select() : Me.txbInputEmployeeNo.SelectAll()
            Me.btnEmployeeNo.Enabled = False
            Me.Cursor = Cursors.Default : Return
        End If

        Me.grbPrintDiscount.Visible = True

        If frmMain.sLoginAreaType <> "S" Then
            Dim blChangedStore As Boolean = False
            If drEmployee("PurchaseStoreID").ToString <> "-1" Then
                If drSalesBill("StoreID").ToString <> drEmployee("PurchaseStoreID").ToString Then
                    drSalesBill("StoreID") = drEmployee("PurchaseStoreID")
                    drSalesBill("CustomerStoreID") = drSalesBill("StoreID")
                    blChangedStore = True
                End If
            Else
                With frmSelectStore
                    .sCityID = drEmployee("PurchaseCityID").ToString
                    .ShowDialog()
                    drSalesBill("StoreID") = .cbbStore.SelectedValue
                    drSalesBill("CustomerStoreID") = drSalesBill("StoreID")
                    .Dispose()
                End With
                blChangedStore = True
            End If

            If blChangedStore Then Me.SelectStore(False)
        End If

        drSalesBill("BuyerName") = drEmployee("EmployeeName").ToString
        For Each drPayment As DataRow In dtPayment.Select("PaymentTerm=1")
            drPayment("PayerName") = drSalesBill("BuyerName").ToString
        Next
        Me.grbInputEmployeeTel.Visible = True
        blSkipDeal = True
        Me.cbbInputEmployeeTel.Items.Clear()
        If drEmployee("TelMP").ToString = "" Then
            drSalesBill("TelMP") = DBNull.Value
            Me.txbInputEmployeeTel.Visible = True
            Me.cbbInputEmployeeTel.Visible = False
            Me.txbInputEmployeeTel.Text = ""
        Else
            drSalesBill("TelMP") = drEmployee("TelMP").ToString
            Me.cbbInputEmployeeTel.Visible = True
            Me.txbInputEmployeeTel.Visible = False
            Me.cbbInputEmployeeTel.Items.Add(drEmployee("TelMP").ToString)
            Me.cbbInputEmployeeTel.SelectedIndex = 0
        End If
        blSkipDeal = False

        Me.tlpAvailableQuota.Visible = True
        Me.txbMaxAvailablePurchaseQuota.Text = Format(drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota"), "#,0.00")
        Me.txbMaxAvailableRebateQuota.Text = Format((drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota")) * drEmployee("RateQuota"), "#,0.00")
        Me.UpdateEmployeePurchaseInfo()

        sEmployeeID = drEmployee("EmployeeID").ToString
        sOldEmployeeID = sEmployeeID
        sEmployeePrompt = "就绪。"

        Me.btnEmployeeNo.Enabled = False
        Me.txbEmployeeIDNo.Select() : Me.txbEmployeeIDNo.SelectAll()
        frmMain.statusText.Text = sEmployeePrompt
        Me.Cursor = Cursors.Default
    End Sub

    Private Sub txbInputEmployeeTel_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbInputEmployeeTel.DoubleClick
        Me.txbInputEmployeeTel.SelectAll()
    End Sub

    Private Sub txbInputEmployeeTel_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbInputEmployeeTel.KeyDown, cbbInputEmployeeTel.KeyDown
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True : e.SuppressKeyPress = True : Return
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If (e.Shift AndAlso (e.KeyCode = Keys.D9 OrElse e.KeyCode = Keys.D0)) OrElse e.KeyCode = Keys.OemMinus OrElse e.KeyCode = Keys.Subtract OrElse e.KeyCode = Keys.Space Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbInputEmployeeTel_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbInputEmployeeTel.Leave
        If Me.txbInputEmployeeTel.Text <> Me.txbInputEmployeeTel.Text.Trim Then Me.txbInputEmployeeTel.Text = Me.txbInputEmployeeTel.Text.Trim
    End Sub

    Private Sub txbInputEmployeeTel_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbInputEmployeeTel.TextChanged
        If Me.txbInputEmployeeTel.ReadOnly Then Return
        If drSalesBill("TelMP").ToString <> Me.txbInputEmployeeTel.Text.Trim Then
            drSalesBill("TelMP") = Me.txbInputEmployeeTel.Text.Trim
        End If
    End Sub

    Private Sub cbbInputEmployeeTel_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbInputEmployeeTel.Leave
        If Me.cbbInputEmployeeTel.Text <> Me.cbbInputEmployeeTel.Text.Trim Then Me.cbbInputEmployeeTel.Text = Me.cbbInputEmployeeTel.Text.Trim : Me.txbInputEmployeeTel.Text = Me.cbbInputEmployeeTel.Text
    End Sub

    Private Sub cbbInputEmployeeTel_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbInputEmployeeTel.TextChanged
        If drSalesBill("TelMP").ToString <> Me.cbbInputEmployeeTel.Text.Trim Then
            drSalesBill("TelMP") = Me.cbbInputEmployeeTel.Text.Trim
        End If
    End Sub

    Private Sub cbbInputEmployeeTel_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles cbbInputEmployeeTel.MouseClick
        If Me.cbbInputEmployeeTel.Focused AndAlso e.Button = Windows.Forms.MouseButtons.Left Then
            bClicks += 1
            sTimerType = "DoubleClick"
            Me.theTimer.Interval = 500
            Me.theTimer.Enabled = True
            If bClicks = 2 Then
                Me.cbbInputEmployeeTel.SelectionStart = 0
                Me.cbbInputEmployeeTel.SelectionLength = Me.cbbCustomerName.Text.Length
                bClicks = 0
            End If
        Else
            Me.cbbInputEmployeeTel.SelectionLength = 0
        End If
    End Sub


    Private Sub txbPromotionTitle_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbPromotionTitle.DoubleClick
        Me.txbPromotionTitle.SelectAll()
    End Sub

    Private Sub txbPromotionTitle_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbPromotionTitle.KeyDown
        If Me.txbPromotionTitle.ReadOnly Then Return

        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    Private Sub txbPromotionTitle_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbPromotionTitle.Leave
        If Me.txbPromotionTitle.ReadOnly Then Return
        If Me.txbPromotionTitle.Text <> Me.txbPromotionTitle.Text.Trim Then Me.txbPromotionTitle.Text = Me.txbPromotionTitle.Text.Trim
        If drSalesBill("PromotionTitle").ToString <> Me.txbPromotionTitle.Text Then
            If Me.txbPromotionTitle.Text = "" Then
                Me.txbPromotionTitle.Text = drSalesBill("PromotionTitle").ToString
            Else
                drSalesBill("PromotionTitle") = Me.txbPromotionTitle.Text
            End If
        End If
    End Sub

    Private Sub pnlPromotionStartDate_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles pnlPromotionStartDate.MouseClick
        Me.dtpPromotionStartDate.Select()
        SendMessage(Me.dtpPromotionStartDate.Handle, 260, 40, 0) '下拉日历
    End Sub

    Private Sub dtpPromotionStartDate_CloseUp(ByVal sender As Object, ByVal e As System.EventArgs) Handles dtpPromotionStartDate.CloseUp
        If Me.pnlPromotionStartDate.Visible Then
            Me.dtpPromotionEndDate.Value = Me.dtpPromotionStartDate.Value
            Me.pnlPromotionStartDate.Visible = False
            Me.pnlPromotionEndDate.Visible = False
            drSalesBill("PromotionPeriod") = Format(Me.dtpPromotionStartDate.Value, "yyyy\/MM\/dd") & " - " & Format(Me.dtpPromotionEndDate.Value, "yyyy\/MM\/dd")
        End If
    End Sub

    Private Sub dtpPromotionStartDate_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles dtpPromotionStartDate.Validated
        If Me.dtpPromotionStartDate.Value > Me.dtpPromotionEndDate.Value Then
            Dim dtStart As Date = Me.dtpPromotionStartDate.Value
            Me.dtpPromotionStartDate.Value = Me.dtpPromotionEndDate.Value
            Me.dtpPromotionEndDate.Value = dtStart
        End If
        drSalesBill("PromotionPeriod") = Format(Me.dtpPromotionStartDate.Value, "yyyy\/MM\/dd") & " - " & Format(Me.dtpPromotionEndDate.Value, "yyyy\/MM\/dd")
    End Sub

    Private Sub pnlPromotionDate_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles pnlPromotionEndDate.MouseClick
        Me.dtpPromotionEndDate.Select()
        SendMessage(Me.dtpPromotionEndDate.Handle, 260, 40, 0) '下拉日历
    End Sub

    Private Sub dtpPromotionEndDate_CloseUp(ByVal sender As Object, ByVal e As System.EventArgs) Handles dtpPromotionEndDate.CloseUp
        If Me.pnlPromotionEndDate.Visible Then
            Me.dtpPromotionStartDate.Value = Me.dtpPromotionEndDate.Value
            Me.pnlPromotionStartDate.Visible = False
            Me.pnlPromotionEndDate.Visible = False
            drSalesBill("PromotionPeriod") = Format(Me.dtpPromotionStartDate.Value, "yyyy\/MM\/dd") & " - " & Format(Me.dtpPromotionEndDate.Value, "yyyy\/MM\/dd")
        End If
    End Sub

    Private Sub dtpPromotionEndDate_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles dtpPromotionEndDate.Validated
        If Me.dtpPromotionStartDate.Value > Me.dtpPromotionEndDate.Value Then
            Dim dtStart As Date = Me.dtpPromotionStartDate.Value
            Me.dtpPromotionStartDate.Value = Me.dtpPromotionEndDate.Value
            Me.dtpPromotionEndDate.Value = dtStart
        End If
        drSalesBill("PromotionPeriod") = Format(Me.dtpPromotionStartDate.Value, "yyyy\/MM\/dd") & " - " & Format(Me.dtpPromotionEndDate.Value, "yyyy\/MM\/dd")
    End Sub

    Private Sub cbbSelectStore_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cbbSelectStore.SelectedIndexChanged
        If blSkipDeal Then Return
        blSkipDeal = True
        Dim sNewStoreID As String = Me.cbbSelectStore.SelectedValue.ToString, sOldPromotionTitle As String = drInternalPayer("LastPromotionTitle").ToString
        If sNewStoreID <> drSalesBill("StoreID").ToString Then
            drInternalPayer = dtInternalPayer.Rows.Find(sNewStoreID)
            If drInternalPayer Is Nothing Then
                MessageBox.Show("当前门店未设置家乐福自购时的付款单位名称，不能建立" & IIf(bNewSalesBillType = 2, "活动", "公关") & "卡销售单！    " & Chr(13) & Chr(13) & "请通知系统管理员设置该门店自购时的付款单位名称。    " & Chr(13) & Chr(13) & "系统即将恢复回原来的门店。    ", "未设置家乐福自购时的付款单位名称！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.cbbSelectStore.SelectedValue = drSalesBill("StoreID").ToString
                drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
            Else
                drSalesBill("StoreID") = sNewStoreID
                drSalesBill("CustomerStoreID") = sNewStoreID
                drSalesBill("CustomerName") = drInternalPayer("StoreName").ToString
                drSalesBill("BuyerName") = IIf(bNewSalesBillType = 2, drInternalPayer("MKLinkman").ToString, drInternalPayer("PRLinkman").ToString)
                drSalesBill("TelMP") = IIf(bNewSalesBillType = 2, drInternalPayer("MKTelMP").ToString, drInternalPayer("PRTelMP").ToString)
                drSalesBill("BuyerCredentialsType") = IIf(bNewSalesBillType = 2, drInternalPayer("MKCredentialsType").ToString, drInternalPayer("PRCredentialsType").ToString)
                drSalesBill("BuyerCredentialsNo") = IIf(bNewSalesBillType = 2, drInternalPayer("MKCredentialsNo").ToString, drInternalPayer("PRCredentialsNo").ToString)
                drSalesBill("CompanyCredentialsType") = "税务登记证"
                drSalesBill("CompanyCredentialsNo") = drInternalPayer("ReceiverTaxNo").ToString
                Me.cbbBuyerName.Items.Clear()
                If drSalesBill("BuyerName").ToString <> "" Then Me.cbbBuyerName.Items.Add(drSalesBill("BuyerName").ToString)
                Me.cbbTelMP.Items.Clear()
                If drSalesBill("TelMP").ToString <> "" Then Me.cbbTelMP.Items.Add(drSalesBill("TelMP").ToString)

                If bNewSalesBillType = 2 AndAlso drSalesBill("PromotionTitle").ToString = sOldPromotionTitle Then
                    Dim sPromotionPeriod As String = drInternalPayer("LastPromotionPeriod").ToString
                    If sPromotionPeriod <> "" AndAlso CDate(sPromotionPeriod.Substring(sPromotionPeriod.LastIndexOf("-") + 1).Trim) >= Today Then
                        drSalesBill("PromotionTitle") = drInternalPayer("LastPromotionTitle").ToString
                        drSalesBill("PromotionPeriod") = sPromotionPeriod
                    Else
                        drSalesBill("PromotionTitle") = DBNull.Value
                        drSalesBill("PromotionPeriod") = DBNull.Value
                    End If
                End If
                With Me.cbbAvailablePayer
                    .Items.Clear()
                    For Each sPayerName As String In drInternalPayer("PayerNames").ToString.Split("|")
                        .Items.Add(sPayerName)
                    Next
                    .SelectedIndex = 0
                End With

                dtNormalCard.Rows.Clear()
                dtNormalCard.Rows.Add(1)
                dmNormalSalesAMT = 0 : dmPayableAMT = 0
                dtPayment.Rows(0)("PaymentAMT") = DBNull.Value
                dtPayment.Rows(0)("PayerName") = Me.cbbAvailablePayer.Text

                Me.txbCustomerName.Text = drSalesBill("CustomerName").ToString
                Me.txbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
                Me.txbCompanyCredentialsNo.Text = drSalesBill("CompanyCredentialsNo").ToString
                Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
                If Me.cbbBuyerName.Items.Count > 0 Then
                    Me.txbBuyerName.Visible = False
                    Me.cbbBuyerName.Visible = True
                    Me.cbbBuyerName.Text = drSalesBill("BuyerName").ToString
                Else
                    Me.txbBuyerName.Visible = True
                    Me.cbbBuyerName.Visible = False
                End If
                Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                If Me.cbbTelMP.Items.Count > 0 Then
                    Me.txbTelMP.Visible = False
                    Me.cbbTelMP.Visible = True
                    Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
                Else
                    Me.txbTelMP.Visible = True
                    Me.cbbTelMP.Visible = False
                End If

                If bNewSalesBillType = 2 Then
                    Me.txbPromotionTitle.Text = drSalesBill("PromotionTitle").ToString
                    If drSalesBill("PromotionPeriod").ToString = "" Then
                        Me.pnlPromotionStartDate.Visible = True
                        Me.pnlPromotionEndDate.Visible = True
                    Else
                        Dim sPromotionPeriod As String = drSalesBill("PromotionPeriod").ToString
                        Me.dtpPromotionStartDate.Value = CDate(sPromotionPeriod.Substring(0, 10))
                        Me.pnlPromotionStartDate.Visible = False
                        Me.dtpPromotionEndDate.Value = CDate(sPromotionPeriod.Substring(sPromotionPeriod.LastIndexOf("-") + 1).Trim)
                        Me.pnlPromotionEndDate.Visible = False
                    End If
                End If

                Me.NormalCardSummary()
            End If
        End If
        blSkipDeal = False
    End Sub

    Private Sub grbCustomer_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles grbCustomer.Leave
        frmMain.statusText.Text = "就绪。"
    End Sub

    Private Sub cbbCustomerType_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cbbCustomerType.SelectedIndexChanged
        If blSkipDeal OrElse Me.cbbCustomerType.SelectedIndex = drSalesBill("CustomerType") Then Return

        drSalesBill("CardQTY") = 0
        drSalesBill("RebateCardQTY") = 0
        drSalesBill("RebateRate") = DBNull.Value
        drSalesBill("RebateSalesAMT") = 0
        drSalesBill("RebateMode") = 0
        drSalesBill("RebateRuleID") = DBNull.Value
        drSalesBill("RebateState") = DBNull.Value
        drSalesBill("ContractID") = DBNull.Value
        drSalesBill("ContractCode") = DBNull.Value
        drSalesBill("ContractMode") = DBNull.Value
        drSalesBill("BalanceContractID") = DBNull.Value
        drSalesBill("BalanceContractCode") = DBNull.Value
        drSalesBill("BalanceContractBalanceRebateAMT") = 0
        drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
        drSalesBill("AddToContract") = 0

        sContractID = "" : sBalanceContractID = ""
        For Each drCard As DataRow In dtNormalCard.Rows
            If drCard("FaceValue").ToString <> "" Then
                drCard("ReducedCardPayment") = 0
                drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost")
                If drCard("CardQTY").ToString <> "" Then drCard("PayableAMT") = drCard("CardQTY") * drCard("CardPayment")
            End If
        Next
        Me.pnlDeductionAMT.Visible = False
        Me.dgvNormalCard.Columns("ReducedCardPayment").Visible = False
        Me.dgvNormalCard.Columns("CardPayment").Visible = False

        Try
            Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
            dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue"))
        Catch
            dmMinFaceValue = 1 : dmMaxFaceValue = 1000
        End Try
        If blUsedOldCard Then dmMinFaceValue = 0

        Me.pnlBalanceContractPayment.Visible = False
        Me.pnlNormalPayment.Visible = True

        drSalesBill("CustomerType") = Me.cbbCustomerType.SelectedIndex
        If Me.cbbCustomerType.SelectedIndex = 0 Then
            drSalesBill("CustomerID") = DBNull.Value
            drSalesBill("CustomerName") = ""
            drSalesBill("CustomerStoreID") = drSalesBill("StoreID")

            drSalesBill("BuyerName") = DBNull.Value
            drSalesBill("TelMP") = DBNull.Value
            drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
            drSalesBill("BuyerCredentialsNo") = DBNull.Value

            sCustomerID = "" : dmRebateSalesAMT = 0
            Me.pnlCompanyCustomer.Visible = False
            Me.pnlCustomerButtons.Visible = False
            Me.flpCustomer.AutoSize = False
            Me.flpCustomer.AutoSize = True
            Me.grbCustomer.Height = Me.flpCustomer.Height + 25

            Me.grbBuyerInfo.Text = "请完善购买人信息："
            Me.txbBuyerName.Visible = True
            Me.cbbBuyerName.Visible = False
            Me.txbTelMP.Visible = True
            Me.cbbTelMP.Visible = False
            blSkipDeal = True
            Me.cbbBuyerName.Items.Clear()
            Me.txbBuyerName.Text = ""
            Me.cbbTelMP.Items.Clear()
            Me.txbTelMP.Text = ""
            Me.cbbBuyerCredentialsType.SelectedIndex = 0
            Me.txbBuyerCredentialsType.Text = Me.cbbBuyerCredentialsType.Text
            Me.txbBuyerCredentialsNo.Text = ""
            blSkipDeal = False

            Me.grbBalanceContract.Visible = False
            Me.grbContract.Visible = False
            If Me.splitList.Panel2Collapsed = False AndAlso Me.chbNormalRebate.Checked = False Then Me.splitList.Panel2Collapsed = True
            If dmNormalSalesAMT > 0 Then
                Me.grbNormalRebate.Visible = True
                Me.chbNormalRebate.Enabled = True
                If Me.chbNormalRebate.Checked Then Me.InitNormalRebateInfo()
            Else
                blSkipDeal = True : Me.chbNormalRebate.Checked = False : blSkipDeal = False
                Me.grbNormalRebate.Visible = False
            End If

            If dmNormalSalesAMT = 0 OrElse Me.chbNormalRebate.Checked = False Then
                blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                Me.NormalCardSummary()
            End If

            If errorNormalCell IsNot Nothing Then
                Me.dgvNormalCard.Select() : errorNormalCell.Selected = True
            ElseIf Me.chbNormalRebate.Checked AndAlso errorRebateCell IsNot Nothing Then
                Me.dgvRebateCard.Select() : errorRebateCell.Selected = True
            Else
                Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
            End If
        Else
            If drCustomer IsNot Nothing Then
                sCustomerID = drCustomer("CustomerID").ToString
                drSalesBill("CustomerID") = sCustomerID
                drSalesBill("CustomerName") = drCustomer("CustomerChineseName").ToString
                drSalesBill("CustomerStoreID") = drCustomer("StoreID")
            Else
                sCustomerID = ""
                drSalesBill("CustomerID") = DBNull.Value
                drSalesBill("CustomerName") = ""
            End If
            Me.pnlCompanyCustomer.Visible = True
            Me.pnlCustomerButtons.Visible = True
            Me.flpCustomer.AutoSize = False
            Me.flpCustomer.AutoSize = True
            Me.grbCustomer.Height = Me.flpCustomer.Height + 25

            Me.grbBuyerInfo.Text = "请完善代购人信息："
            blSkipDeal = True
            Me.cbbBuyerName.Items.Clear()
            Me.cbbTelMP.Items.Clear()
            If drCustomer IsNot Nothing AndAlso dvCustomerBuyer.Count > 0 Then
                drSalesBill("BuyerName") = dvCustomerBuyer(0)("BuyerName").ToString
                drSalesBill("TelMP") = dvCustomerBuyer(0)("TelMP").ToString
                If dvCustomerBuyer(0)("CredentialsType").ToString = "" Then
                    drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                Else
                    drSalesBill("BuyerCredentialsType") = dvCustomerBuyer(0)("CredentialsType").ToString
                    drSalesBill("BuyerCredentialsNo") = dvCustomerBuyer(0)("CredentialsNo").ToString
                End If

                dvCustomerBuyer.RowFilter = ""
                For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                    Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                Next
                Me.cbbBuyerName.Text = drSalesBill("BuyerName").ToString
                Me.cbbBuyerName.Visible = True
                Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
                Me.txbBuyerName.Visible = False

                dvCustomerBuyer.RowFilter = "BuyerName='" & dvCustomerBuyer(0)("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                For Each drTelMP As DataRowView In dvCustomerBuyer
                    Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                Next
                Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                If Me.cbbTelMP.Items.Count = 0 Then
                    Me.cbbTelMP.Visible = False
                    Me.txbTelMP.Visible = True
                Else
                    Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
                    Me.cbbTelMP.Visible = True
                    Me.txbTelMP.Visible = False
                End If
            Else
                drSalesBill("BuyerName") = DBNull.Value
                drSalesBill("TelMP") = DBNull.Value
                drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                drSalesBill("BuyerCredentialsNo") = DBNull.Value

                Me.txbBuyerName.Text = ""
                Me.txbTelMP.Text = ""
                Me.txbBuyerName.Visible = True
                Me.cbbBuyerName.Visible = False
                Me.txbTelMP.Visible = True
                Me.cbbTelMP.Visible = False
            End If
            Me.cbbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
            Me.txbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
            Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
            blSkipDeal = False

            If drCustomer IsNot Nothing Then
                sContractID = drCustomer("ValidContractID").ToString
                If sContractID <> "" Then
                    drSalesBill("ContractID") = sContractID
                    drSalesBill("ContractCode") = drCustomer("ValidContractCode").ToString
                    drSalesBill("ContractMode") = drContract("PaymentMode").ToString & drContract("CalculationMode").ToString
                    Select Case drContract("CalculationDay")
                        Case 0
                            drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "0" '合同期满后兑现累计返点
                        Case 255
                            drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "2" '每次购买时兑现累计返点
                        Case Else
                            drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "1" '每月一次兑现累计返点
                    End Select
                    Me.grbContract.Visible = True
                    If Me.chbContract.Checked Then
                        Me.grbNormalRebate.Visible = False
                        Me.InitContractInfo()
                    End If
                End If
                sBalanceContractID = drCustomer("BalanceContractID").ToString
                If sBalanceContractID <> "" Then
                    drSalesBill("BalanceContractID") = sBalanceContractID
                    drSalesBill("BalanceContractCode") = drCustomer("BalanceContractCode").ToString
                    drSalesBill("BalanceContractBalanceRebateAMT") = drCustomer("BalanceRebateAMT")
                    Me.grbBalanceContract.Visible = True
                    If Me.chbBalanceContract.Checked Then
                        Me.grbContract.Visible = False
                        Me.grbNormalRebate.Visible = False
                        Me.pnlNormalPayment.Visible = False
                        Me.pnlBalanceContractPayment.Visible = True
                        Me.pnlNormalPayment.Visible = False
                        Me.btnOK.Text = "销售单确认(&O)"
                        dmNormalSalesAMT = 0 : dmPayableAMT = 0
                        Me.InitBalanceContractInfo()
                    End If
                End If
            End If

            If Me.grbNormalRebate.Visible Then
                If Me.chbNormalRebate.Checked Then
                    Me.InitNormalRebateInfo()
                Else
                    blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                    Me.NormalCardSummary()
                End If
            End If

            If sCustomerID <> "" AndAlso errorNormalCell IsNot Nothing Then
                Me.dgvNormalCard.Select() : errorNormalCell.Selected = True
            ElseIf sCustomerID <> "" AndAlso Me.dgvRebateCard.Visible AndAlso errorRebateCell IsNot Nothing Then
                Me.dgvRebateCard.Select() : errorRebateCell.Selected = True
            ElseIf Me.cbbCustomerName.Visible Then
                Me.cbbCustomerName.Select()
            Else
                Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
            End If
        End If

        For Each drPayment As DataRow In dtPayment.Select("PaymentTerm=1")
            drPayment("PayerName") = drSalesBill("BuyerName").ToString
        Next

        If Me.splitList.Panel2Collapsed Then
            Me.grbPrintDiscount.Visible = False
        ElseIf blCanUse92Card Then
            Me.grbPrintDiscount.Visible = True
        Else
            Me.chbPrintDiscount.Checked = False
            Me.grbPrintDiscount.Visible = False
        End If
        Me.ResetInterfaceLayout()

        If sCustomerID <> "" OrElse sCustomerName = "" Then
            sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
        Else
            sCustomerPrompt = "找不到该客户，请先创建该客户或输入其他的公司名称。"
        End If
        If Me.cbbCustomerType.SelectedIndex = 0 Then
            frmMain.statusText.Text = "就绪。"
        Else
            frmMain.statusText.Text = sCustomerPrompt
        End If
    End Sub

    Private Sub txbCustomerName_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbCustomerName.DoubleClick
        Me.txbCustomerName.SelectAll()
    End Sub

    Private Sub txbCustomerName_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbCustomerName.Enter, cbbCustomerName.Enter
        If Me.txbCustomerName.Visible = True AndAlso Me.txbCustomerName.ReadOnly Then Return

        sCustomerName = CType(sender, Control).Text
        frmMain.statusText.Text = sCustomerPrompt
    End Sub

    Private Sub txbCustomerName_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbCustomerName.KeyDown, cbbCustomerName.KeyDown
        If Me.txbCustomerName.Visible = True AndAlso Me.txbCustomerName.ReadOnly Then Return
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If e.KeyCode = Keys.Enter Then Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll() : e.SuppressKeyPress = True
    End Sub

    Private Sub txbCustomerName_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbCustomerName.TextChanged, cbbCustomerName.TextChanged
        If blSkipDeal OrElse Me.txbCustomerName.Visible = True AndAlso Me.txbCustomerName.ReadOnly Then Return
        Me.btnViewCustomer.Enabled = False
    End Sub

    Private Sub txbCustomerName_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbCustomerName.Validating, cbbCustomerName.Validating
        If (Me.txbCustomerName.Visible = True AndAlso Me.txbCustomerName.ReadOnly) OrElse drSalesBill("CustomerType") = 0 Then Return

        Dim controlCustomerName As Control = CType(sender, Control)
        If controlCustomerName.Name.IndexOf("cbb") > -1 AndAlso Me.cbbCustomerName.SelectedValue IsNot Nothing AndAlso sCustomerID = Me.cbbCustomerName.SelectedValue.ToString Then Return

        If controlCustomerName.Text <> controlCustomerName.Text.Trim Then controlCustomerName.Text = controlCustomerName.Text.Trim

        If controlCustomerName.Text = "" Then
            If sCustomerName = "" Then
                sCustomerPrompt = "您还未确定公司名称！请先输入公司名称。"
                frmMain.statusText.Text = sCustomerPrompt
                sTimerType = "CustomerError"
                Me.theTimer.Interval = 50
                Me.theTimer.Enabled = True
            Else
                controlCustomerName.Text = sCustomerName
                If sCustomerID = "" Then
                    frmMain.statusText.Text = sCustomerPrompt
                    Me.Activate() : Me.Cursor = Cursors.Default
                    sTimerType = "CustomerError"
                    Me.theTimer.Interval = 50
                    Me.theTimer.Enabled = True
                End If
            End If
        ElseIf sCustomerName <> controlCustomerName.Text Then
            Me.btnViewCustomer.Enabled = False
            Me.Cursor = Cursors.WaitCursor
            frmMain.statusText.Text = "正从数据库中检索客户……"
            frmMain.statusMain.Refresh()
            Dim DB As New DataBase
            DB.Open()

            If DB.IsConnected Then
                If dtDropdownCustomer IsNot Nothing Then dtDropdownCustomer.Dispose() : dtDropdownCustomer = Nothing
                dtDropdownCustomer = DB.GetDataTable("Exec GetMatchedCustomerWhenSellCard " & frmMain.sLoginUserID & ",'" & controlCustomerName.Text.Replace("'", "''") & "'")
                DB.Close()

                If dtDropdownCustomer Is Nothing Then
                    If controlCustomerName.Name.IndexOf("cbb") > -1 Then
                        Me.cbbCustomerName.Visible = False
                        Me.txbCustomerName.Visible = True
                        Me.txbCustomerName.Text = Me.cbbCustomerName.Text
                    End If
                    sCustomerID = "" : drCustomer = Nothing
                    sCustomerPrompt = "系统因在检索数据时出错而无法检索客户。请联系软件开发人员。"
                    frmMain.statusText.Text = sCustomerPrompt
                    Me.Activate() : Me.Cursor = Cursors.Default
                    sTimerType = "CustomerError"
                    Me.theTimer.Interval = 50
                    Me.theTimer.Enabled = True
                Else
                    Select Case dtDropdownCustomer.Rows.Count
                        Case 0
                            If controlCustomerName.Name.IndexOf("cbb") > -1 Then
                                Me.cbbCustomerName.Visible = False
                                Me.txbCustomerName.Visible = True
                                Me.txbCustomerName.Text = Me.cbbCustomerName.Text
                            End If
                            sCustomerID = "" : drCustomer = Nothing
                            If frmMain.dtAllowedRight.Select("RightName='CustomerCreate'").Length > 0 AndAlso ((Me.splitLayout.ActiveControl IsNot Nothing AndAlso Me.splitLayout.ActiveControl.Name = "btnNewCustomer") OrElse MessageBox.Show("找不到该客户，是否现在创建该客户？    ", "是否创建客户？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.Yes) Then
                                sTimerType = "CreateCustomer"
                                Me.theTimer.Interval = 50
                                Me.theTimer.Enabled = True
                            Else
                                sCustomerPrompt = "找不到该客户，请先创建该客户或输入其他的公司名称。"
                                frmMain.statusText.Text = sCustomerPrompt
                                Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
                                sTimerType = "CustomerError"
                                Me.theTimer.Interval = 50
                                Me.theTimer.Enabled = True
                            End If
                        Case 1
                            If controlCustomerName.Name.IndexOf("cbb") > -1 Then
                                Me.cbbCustomerName.Visible = False
                                Me.txbCustomerName.Visible = True
                                Me.txbCustomerName.Text = Me.cbbCustomerName.Text
                                controlCustomerName = Me.txbCustomerName
                            End If

                            Me.SelectCompanyCustomer(controlCustomerName, dtDropdownCustomer.Rows(0)("CustomerID").ToString)

                            sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
                            frmMain.statusText.Text = "就绪。"
                        Case Else
                            sCustomerName = controlCustomerName.Text
                            If controlCustomerName.Name.IndexOf("txb") > -1 Then Me.cbbCustomerName.Text = Me.txbCustomerName.Text : Me.cbbCustomerName.Visible = True : Me.txbCustomerName.Visible = False
                            Dim sMaxLengthName As String = "", iMaxLength As Int16 = 0, iLength As Int16 = 0, g As Graphics, iDropDownWidth As Int16
                            For Each dr As DataRow In dtDropdownCustomer.Rows
                                iLength = System.Text.Encoding.Default.GetByteCount(dr("CustomerName").ToString)
                                If iMaxLength < iLength Then sMaxLengthName = dr("CustomerName").ToString
                            Next
                            g = Me.cbbCustomerName.CreateGraphics()
                            iDropDownWidth = g.MeasureString(sMaxLengthName, Me.cbbCustomerName.Font).Width - 4
                            g.Dispose() : g = Nothing
                            If Me.cbbCustomerName.DropDownHeight < Me.cbbCustomerName.ItemHeight * Me.cbbCustomerName.Items.Count Then iDropDownWidth += 18
                            If iDropDownWidth < Me.cbbCustomerName.Width Then iDropDownWidth = Me.cbbCustomerName.Width
                            blSkipDeal = True
                            With Me.cbbCustomerName
                                .DataSource = dtDropdownCustomer
                                .ValueMember = "CustomerID"
                                .DisplayMember = "CustomerName"
                                .DropDownWidth = iDropDownWidth
                            End With
                            Me.cbbCustomerName.Text = sCustomerName
                            blSkipDeal = False
                            sCustomerID = "" : drCustomer = Nothing
                            sCustomerPrompt = "存在多个相似客户。请选择其中一个。"
                            frmMain.statusText.Text = sCustomerPrompt
                            sTimerType = "CustomerError"
                            Me.theTimer.Interval = 50
                            Me.theTimer.Enabled = True
                    End Select
                End If
            Else
                sCustomerID = "" : drCustomer = Nothing
                sCustomerPrompt = "系统因连接不到数据库而无法检索客户。请检查数据库连接。"
                frmMain.statusText.Text = sCustomerPrompt
                sTimerType = "CustomerError"
                Me.theTimer.Interval = 50
                Me.theTimer.Enabled = True
            End If
            Me.Activate() : Me.Cursor = Cursors.Default
        ElseIf sCustomerID = "" Then
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CustomerError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub cbbCustomerName_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbCustomerName.Leave, txbCustomerName.Leave
        frmMain.statusText.Text = "就绪。"
    End Sub

    Private Sub cbbCustomerName_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles cbbCustomerName.MouseClick
        If Me.cbbCustomerName.Focused AndAlso e.Button = Windows.Forms.MouseButtons.Left Then
            bClicks += 1
            sTimerType = "DoubleClick"
            Me.theTimer.Interval = 500
            Me.theTimer.Enabled = True
            If bClicks = 2 Then
                Me.cbbCustomerName.SelectionStart = 0
                Me.cbbCustomerName.SelectionLength = Me.cbbCustomerName.Text.Length
                bClicks = 0
            End If
        Else
            Me.cbbCustomerName.SelectionLength = 0
        End If
    End Sub

    Private Sub cbbCustomerName_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbCustomerName.SelectedIndexChanged
        If blSkipDeal OrElse Me.cbbCustomerName.SelectedValue Is Nothing Then Return
        If sCustomerID = Me.cbbCustomerName.SelectedValue.ToString Then Return
        sCustomerName = Me.cbbCustomerName.Text
        Me.txbCustomerName.Text = Me.cbbCustomerName.Text

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在下载客户资料……"
        frmMain.statusMain.Refresh()

        Me.SelectCompanyCustomer(Me.cbbCustomerName, Me.cbbCustomerName.SelectedValue.ToString)

        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub cbbCompanyCredentialsType_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbCompanyCredentialsType.Enter
        If Me.txbCustomerName.ReadOnly = False AndAlso Me.txbCustomerName.Visible = True AndAlso sCustomerID = "" Then
            Me.txbCustomerName.Select()
            frmMain.statusText.Text = sCustomerPrompt
        ElseIf Me.cbbCustomerName.Visible = True AndAlso sCustomerID = "" Then
            Me.cbbCustomerName.Select()
            frmMain.statusText.Text = sCustomerPrompt
        Else
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub cbbCompanyCredentialsType_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles cbbCompanyCredentialsType.KeyDown
        If e.KeyCode = Keys.Enter Then
            Me.txbCompanyCredentialsNo.Select() : Me.txbCompanyCredentialsNo.SelectAll()
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    Private Sub cbbCompanyCredentialsType_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbCompanyCredentialsType.Leave
        If Me.cbbCompanyCredentialsType.Text <> Me.cbbCompanyCredentialsType.Text.Trim Then
            blSkipDeal = True
            Me.cbbCompanyCredentialsType.Text = Me.cbbCompanyCredentialsType.Text.Trim
            Me.txbCompanyCredentialsType.Text = Me.cbbCompanyCredentialsType.Text
            blSkipDeal = False
        End If
        If Me.cbbCompanyCredentialsType.Text = "（特准无需证件）" AndAlso Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = -1 Then Me.cbbCompanyCredentialsType.Text = "" '不允许手工输入
        If Me.cbbCompanyCredentialsType.Text = "（特准无需证件）" AndAlso Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = 0 Then Me.cbbCompanyCredentialsType.SelectedIndex = 0
    End Sub

    Private Sub cbbCompanyCredentialsType_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles cbbCompanyCredentialsType.MouseClick
        If sCustomerID = "" OrElse Me.cbbCompanyCredentialsType.Focused = False Then
            Me.cbbCompanyCredentialsType.SelectionLength = 0
        ElseIf e.Button = Windows.Forms.MouseButtons.Left Then
            bClicks += 1
            sTimerType = "DoubleClick"
            Me.theTimer.Interval = 500
            Me.theTimer.Enabled = True
            If bClicks = 2 Then
                Me.cbbCompanyCredentialsType.SelectionStart = 0
                Me.cbbCompanyCredentialsType.SelectionLength = Me.cbbCompanyCredentialsType.Text.Length
                bClicks = 0
            End If
        End If
    End Sub

    Private Sub cbbCompanyCredentialsType_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbCompanyCredentialsType.TextChanged, cbbCompanyCredentialsType.SelectedIndexChanged
        If blSkipDeal OrElse drSalesBill("CompanyCredentialsType").ToString = Me.cbbCompanyCredentialsType.Text.Trim Then Return
        Me.txbCompanyCredentialsType.Text = Me.cbbCompanyCredentialsType.Text.Trim
        drSalesBill("CompanyCredentialsType") = Me.txbCompanyCredentialsType.Text
        If Me.cbbCompanyCredentialsType.SelectedIndex = 0 AndAlso Me.cbbCompanyCredentialsType.Text = "（特准无需证件）" Then
            drSalesBill("CompanyCredentialsNo") = DBNull.Value
            Me.txbCompanyCredentialsNo.Text = ""
            Me.txbCompanyCredentialsNo.ReadOnly = True
            Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
            Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
        Else
            If Me.txbCompanyCredentialsType.Text = drCustomer("CompanyCredentialsType").ToString Then
                drSalesBill("CompanyCredentialsNo") = drCustomer("CompanyCredentialsNo").ToString
            Else
                drSalesBill("CompanyCredentialsNo") = DBNull.Value
            End If
            Me.txbCompanyCredentialsNo.ReadOnly = False
            Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
            Me.txbCompanyCredentialsNo.Text = drSalesBill("CompanyCredentialsNo").ToString
            If Me.cbbCompanyCredentialsType.SelectedIndex <> -1 Then Me.txbCompanyCredentialsNo.Select() : Me.txbCompanyCredentialsNo.SelectAll()
        End If
    End Sub

    Private Sub txbCompanyCredentialsNo_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbCompanyCredentialsNo.DoubleClick
        Me.txbCompanyCredentialsNo.SelectAll()
    End Sub

    Private Sub txbCompanyCredentialsNo_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbCompanyCredentialsNo.Enter
        If Me.txbCompanyCredentialsNo.ReadOnly Then Return
        If Me.cbbCompanyCredentialsType.Text = "" Then
            Me.cbbCompanyCredentialsType.Select()
            frmMain.statusText.Text = "请先选择或输入公司证件类型。"
        Else
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub txbCompanyCredentialsNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbCompanyCredentialsNo.KeyDown
        If Me.txbCompanyCredentialsNo.ReadOnly Then Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then
            If Me.cbbBuyerName.Visible Then
                Me.cbbBuyerName.Select() : Me.cbbBuyerName.SelectAll()
            Else
                Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
            End If
            e.SuppressKeyPress = True : Return
        End If
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If (e.KeyCode >= Keys.A AndAlso e.KeyCode <= Keys.Z) Then Return
        If (e.Shift AndAlso (e.KeyCode = Keys.D9 OrElse e.KeyCode = Keys.D0)) OrElse e.KeyCode = Keys.OemMinus OrElse e.KeyCode = Keys.Subtract OrElse e.KeyCode = Keys.Space Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbCompanyCredentialsNo_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbCompanyCredentialsNo.Validating
        If Me.txbCompanyCredentialsNo.ReadOnly OrElse drSalesBill("CompanyCredentialsNo").ToString = Me.txbCompanyCredentialsNo.Text.Trim Then Return
        If Me.txbCompanyCredentialsNo.Text <> Me.txbCompanyCredentialsNo.Text.Trim Then Me.txbCompanyCredentialsNo.Text = Me.txbCompanyCredentialsNo.Text.Trim
        If Me.txbCompanyCredentialsNo.Text <> "" AndAlso Me.txbCompanyCredentialsNo.Text.Length < 4 Then
            drSalesBill("CompanyCredentialsNo") = DBNull.Value
            If sCustomerPrompt <> "公司证件号码位数不应低于 4 位！请重新输入公司证件号码。" Then MessageBox.Show("公司证件号码位数不应低于 4 位！    " & Chr(13) & Chr(13) & "请重新输入公司证件号码。    ", "公司证件号码位数不应低于 4 位！！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sCustomerPrompt = "公司证件号码位数不应低于 4 位！请重新输入公司证件号码。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CompanyCredentialsNoError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        Else
            drSalesBill("CompanyCredentialsNo") = Me.txbCompanyCredentialsNo.Text
            sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub btnNewCustomer_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnNewCustomer.Click
        If frmMain.dtAllowedRight.Select("RightName='CustomerCreate'").Length = 0 Then
            MessageBox.Show("对不起，您无权限创建新客户。    " & Chr(13) & _
                            "Sorry, you have no right to create new Customer.    ", "无权限创建客户 No right to create Customer!", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Me.btnNewCustomer.Enabled = False : Return
        End If

        If frmCustomer.IsHandleCreated Then Return '避免重复打开
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开客户窗口……"
        frmMain.statusMain.Refresh()

        If sCustomerID = "" Then
            If Me.txbCustomerName.Visible Then
                frmCustomer.sCustomerNameFromOthers = Me.txbCustomerName.Text.Trim
            Else
                frmCustomer.sCustomerNameFromOthers = Me.cbbCustomerName.Text.Trim
            End If
        End If
        If frmCustomer.sCustomerNameFromOthers = "" Then frmCustomer.sCustomerNameFromOthers = " "

        frmCustomer.ShowDialog()
        If frmCustomer.sCustomerID = "-1" Then
            If sCustomerName = "" Then
                sCustomerPrompt = "您还未确定公司名称！请先输入公司名称。"
                frmMain.statusText.Text = sCustomerPrompt
            ElseIf sCustomerID = "" Then
                sCustomerPrompt = "找不到该客户，请先创建该客户或" & IIf(Me.txbCustomerName.Visible = True, "输入", "选择") & "其他的公司名称。"
                frmMain.statusText.Text = sCustomerPrompt
            End If
            If Me.txbCustomerName.Visible = True Then
                Me.txbCustomerName.Focus() : Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
            Else
                Me.cbbCustomerName.Focus() : Me.cbbCustomerName.Select() : Me.cbbCustomerName.SelectAll()
            End If
        Else
            drCustomer = frmCustomer.drCustomer.Table.Copy.Rows(0)
            If dvCustomerBuyer Is Nothing Then
                Dim dtCustomerBuyer As New DataTable
                With dtCustomerBuyer.Columns
                    .Add("BuyerName", System.Type.GetType("System.String"))
                    .Add("TelMP", System.Type.GetType("System.String"))
                    .Add("CredentialsType", System.Type.GetType("System.String"))
                    .Add("CredentialsNo", System.Type.GetType("System.String"))
                    .Add("SortID", System.Type.GetType("System.Int32"))
                End With
                dvCustomerBuyer = New DataView(dtCustomerBuyer.Copy)
                dtCustomerBuyer.Dispose() : dtCustomerBuyer = Nothing
            Else
                dvCustomerBuyer.Table.Rows.Clear()
                dvCustomerBuyer.Table.AcceptChanges()
            End If

            If frmMain.sLoginAreaType <> "S" Then
                drSalesBill("StoreID") = drCustomer("StoreID").ToString
                Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
                drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
                Dim sNewCULCardBin As String = drStore("CULCardBin").ToString
                If sNewCULCardBin <> sCULCardBin Then
                    blSkipDeal = True

                    blNormalCardFaceValueErrorWhenSwitchCustomer = False
                    errorNormalCell = Nothing : sErrorNormalInfo = ""
                    errorRebateCell = Nothing : sErrorRebateInfo = ""

                    If dtRebateCard.Rows.Count > 0 Then
                        dtRebateCard.Rows.Clear()
                        dtRebateCard.Rows.Add(1)
                        Me.RebateCardSummary()
                    End If
                    If dtNormalCard.Rows.Count > 0 Then
                        dtNormalCard.Rows.Clear()
                        dtNormalCard.Rows.Add(1)
                        Me.NormalCardSummary()
                    End If
                    blSkipDeal = False

                    sCULCardBin = sNewCULCardBin
                    sFreeCardBin = "92" & sCULCardBin.Substring(2)
                    sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
                    sPaperCardBin = "86" & sCULCardBin.Substring(2)
                    sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
                    sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
                End If
            End If

            sCustomerID = drCustomer("CustomerID").ToString
            sCustomerName = drCustomer("CustomerChineseName").ToString
            drSalesBill("CustomerID") = sCustomerID
            drSalesBill("CustomerName") = sCustomerName
            drSalesBill("CustomerStoreID") = drCustomer("StoreID")
            Me.CombineCustomerBuyer()
            If dvCustomerBuyer.Count > 0 Then
                drSalesBill("BuyerName") = dvCustomerBuyer(0)("BuyerName").ToString
                drSalesBill("TelMP") = dvCustomerBuyer(0)("TelMP").ToString
                drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                drSalesBill("BuyerCredentialsNo") = DBNull.Value
                dvCustomerBuyer.RowFilter = ""
                For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                    Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                Next
                dvCustomerBuyer.RowFilter = "BuyerName='" & dvCustomerBuyer(0)("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                For Each drTelMP As DataRowView In dvCustomerBuyer
                    Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                Next
            End If
            If drCustomer("AllowNoCredentials") Then
                If Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = -1 Then Me.cbbCompanyCredentialsType.Items.Insert(0, "（特准无需证件）")
                drSalesBill("CompanyCredentialsType") = "（特准无需证件）"
                drSalesBill("CompanyCredentialsNo") = DBNull.Value
            Else
                If Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = 0 Then Me.cbbCompanyCredentialsType.Items.RemoveAt(0)
                If drCustomer("CompanyCredentialsType").ToString = "" Then
                    drSalesBill("CompanyCredentialsType") = Me.cbbCompanyCredentialsType.Items(0)
                    drSalesBill("CompanyCredentialsNo") = DBNull.Value
                Else
                    drSalesBill("CompanyCredentialsType") = drCustomer("CompanyCredentialsType").ToString
                    drSalesBill("CompanyCredentialsNo") = drCustomer("CompanyCredentialsNo").ToString
                End If
            End If

            Me.cbbCustomerName.Visible = False
            Me.txbCustomerName.Text = sCustomerName
            Me.txbCustomerName.Visible = True

            blSkipDeal = True
            Me.cbbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
            Me.txbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
            Me.txbCompanyCredentialsNo.Text = drSalesBill("CompanyCredentialsNo").ToString
            If drSalesBill("CompanyCredentialsType").ToString = "（特准无需证件）" Then
                Me.txbCompanyCredentialsNo.ReadOnly = True
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
            Else
                Me.txbCompanyCredentialsNo.ReadOnly = False
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
            End If

            Me.cbbBuyerName.Items.Clear()
            Me.cbbTelMP.Items.Clear()
            If dvCustomerBuyer.Count > 0 Then
                dvCustomerBuyer.RowFilter = ""
                For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                    Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                Next
                Me.cbbBuyerName.Text = drSalesBill("BuyerName").ToString
                Me.cbbBuyerName.Visible = True
                Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
                Me.txbBuyerName.Visible = False

                dvCustomerBuyer.RowFilter = "BuyerName='" & dvCustomerBuyer(0)("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                For Each drTelMP As DataRowView In dvCustomerBuyer
                    Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                Next
                Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                If Me.cbbTelMP.Items.Count = 0 Then
                    Me.cbbTelMP.Visible = False
                    Me.txbTelMP.Visible = True
                Else
                    Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
                    Me.cbbTelMP.Visible = True
                    Me.txbTelMP.Visible = False
                End If
            Else
                Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
                Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                Me.txbBuyerName.Visible = True
                Me.cbbBuyerName.Visible = False
                Me.txbTelMP.Visible = True
                Me.cbbTelMP.Visible = False
            End If
            Me.cbbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
            Me.txbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
            Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
            blSkipDeal = False

            Me.btnViewCustomer.Enabled = blCanViewCustomer

            If dmNormalSalesAMT > 0 Then
                Me.grbContract.Visible = False
                Me.grbNormalRebate.Visible = True
                If Me.chbNormalRebate.Checked Then Me.InitNormalRebateInfo()
            End If
            If dmNormalSalesAMT = 0 OrElse Me.chbNormalRebate.Checked = False Then
                blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                Me.NormalCardSummary()
            End If

            Me.pnlBalanceContractPayment.Visible = False
            Me.pnlNormalPayment.Visible = True

            For Each drPayment As DataRow In dtPayment.Select("PaymentTerm=1")
                drPayment("PayerName") = drSalesBill("BuyerName").ToString
            Next

            sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
            sTimerType = "AfterCreatedCustomer"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If

        frmCustomer.Dispose()
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub btnViewCustomer_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnViewCustomer.Click
        If frmMain.dtAllowedRight.Select("RightName Like 'Customer%' And RightName<>'CustomerCreate'").Length = 0 Then
            MessageBox.Show("对不起！您没有浏览客户的权限。    ", "您无权浏览客户！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnViewCustomer.Enabled = False
        ElseIf frmMain.sLoginAreaType = "S" AndAlso drSalesBill("StoreID").ToString <> drSalesBill("CustomerStoreID").ToString Then
            MessageBox.Show("对不起！您不能查看其它门店的客户资料（虽然允许售卡给该客户）。    ", "没法查看其它门店客户资料！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnViewCustomer.Enabled = False
        End If
        If Me.btnViewCustomer.Enabled = False Then
            If Me.txbCustomerName.Visible Then
                Me.txbCustomerName.Select()
                Me.txbCustomerName.SelectAll()
            Else
                Me.cbbCustomerName.Select()
                Me.cbbCustomerName.SelectAll()
            End If
            Return
        End If

        Me.Cursor = Cursors.WaitCursor
        If drCustomer IsNot Nothing Then
            frmMain.statusText.Text = "正在打开客户""" & drCustomer("StoreCode").ToString & drCustomer("CustomerCode").ToString & " " & drCustomer("CustomerChineseName").ToString & """……"
        Else
            frmMain.statusText.Text = "正在打开客户""" & Me.txbCustomerName.Text & """……"
        End If
        frmMain.statusMain.Refresh()

        If drCustomer IsNot Nothing Then frmCustomer.drCustomer = drCustomer.Table.Copy.Rows(0)
        frmCustomer.blFromSalesBill = True
        frmCustomer.sCustomerID = sCustomerID
        frmCustomer.ShowDialog()
        If sSalesBillID = "-1" AndAlso frmCustomer.sCustomerID = "" Then
            frmCustomer.Dispose()
            Me.btnViewCustomer.Enabled = False
            sCustomerID = "" : drCustomer = Nothing
            sCustomerPrompt = "您选择的客户已经不存在（可能被删除或移位），请先创建该客户或输入其他的公司名称。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CustomerError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
            Me.Activate() : Me.Cursor = Cursors.Default
            Return
        End If

        If Not frmCustomer.blAlreadyChanged OrElse sSalesBillID <> "-1" Then
            frmCustomer.Dispose()
            If Me.txbCustomerName.Visible = True Then
                Me.txbCustomerName.Focus() : Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
            Else
                Me.cbbCustomerName.Focus() : Me.cbbCustomerName.Select() : Me.cbbCustomerName.SelectAll()
            End If
            Me.Activate() : Me.Cursor = Cursors.Default
            Return
        End If
        drCustomer = frmCustomer.drCustomer.Table.Copy.Rows(0)
        frmCustomer.Dispose()

        blSkipDeal = True
        sCustomerName = drCustomer("CustomerChineseName").ToString & IIf(drCustomer("Stopped"), " （已停止使用）", "")
        If dtDropdownCustomer IsNot Nothing AndAlso dtDropdownCustomer.Select("CustomerID=" & sCustomerID).Length > 0 Then
            dtDropdownCustomer.Select("CustomerID=" & sCustomerID)(0)("CustomerName") = sCustomerName
            dtDropdownCustomer.AcceptChanges()
        End If
        Me.txbCustomerName.Text = sCustomerName
        If drCustomer("Stopped") Then
            MessageBox.Show("您选择的客户已被停止使用，再也不能向该客户售卡！    " & Chr(13) & Chr(13) & "停用客户： " & drCustomer("StoreCode").ToString & drCustomer("CustomerCode").ToString & " " & drCustomer("CustomerChineseName").ToString & Space(4) & IIf(drCustomer("StoppedReason").ToString = "", "", Chr(13) & "停用原因： " & drCustomer("StoppedReason").ToString & Space(4)), "客户已被停止使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            If frmCustomerManagement.IsHandleCreated Then
                Try
                    Dim customer As DataRow = frmCustomerManagement.dvCustomer.Table.Rows.Find(sCustomerID)
                    customer("StateDescription") = "停止使用 Blocked" : customer("Stopped") = 1
                    customer.AcceptChanges() : customer = Nothing
                Catch
                End Try
            End If
            sCustomerID = "" : drCustomer = Nothing
            sCustomerPrompt = "您选择的客户已被停止使用，请选择其他客户。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CustomerError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        Else
            If frmMain.sLoginAreaType <> "S" Then
                drSalesBill("StoreID") = drCustomer("StoreID").ToString
                Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
                drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
                Dim sNewCULCardBin As String = drStore("CULCardBin").ToString
                If sNewCULCardBin <> sCULCardBin Then
                    blNormalCardFaceValueErrorWhenSwitchCustomer = False
                    errorNormalCell = Nothing : sErrorNormalInfo = ""
                    errorRebateCell = Nothing : sErrorRebateInfo = ""
                    If dtRebateCard.Rows.Count > 0 Then
                        dtRebateCard.Rows.Clear()
                        dtRebateCard.Rows.Add(1)
                        Me.RebateCardSummary()
                    End If
                    If dtNormalCard.Rows.Count > 0 Then
                        dtNormalCard.Rows.Clear()
                        dtNormalCard.Rows.Add(1)
                        Me.NormalCardSummary()
                    End If

                    sCULCardBin = sNewCULCardBin
                    sFreeCardBin = "92" & sCULCardBin.Substring(2)
                    sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
                    sPaperCardBin = "86" & sCULCardBin.Substring(2)
                    sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
                    sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
                End If
            End If

            drSalesBill("CustomerName") = sCustomerName
            drSalesBill("CustomerStoreID") = drCustomer("StoreID")

            Me.CombineCustomerBuyer()
            Me.cbbBuyerName.Items.Clear()
            Me.cbbTelMP.Items.Clear()
            If dvCustomerBuyer.Count > 0 Then
                dvCustomerBuyer.RowFilter = ""
                For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                    Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                Next
                Me.cbbBuyerName.Visible = True
                Me.txbBuyerName.Visible = False

                If drSalesBill("BuyerName").ToString = "" Then drSalesBill("BuyerName") = dvCustomerBuyer(0)("BuyerName").ToString
                Me.cbbBuyerName.Text = drSalesBill("BuyerName").ToString
                Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString

                dvCustomerBuyer.RowFilter = "BuyerName='" & drSalesBill("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                For Each drTelMP As DataRowView In dvCustomerBuyer
                    Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                Next
                If Me.cbbTelMP.Items.Count = 0 Then
                    Me.cbbTelMP.Visible = False
                    Me.txbTelMP.Visible = True
                Else
                    Me.cbbTelMP.Visible = True
                    Me.txbTelMP.Visible = False
                    If drSalesBill("TelMP").ToString = "" Then drSalesBill("TelMP") = Me.cbbTelMP.Items(0)
                    Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
                    Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                End If
            Else
                Me.txbBuyerName.Visible = True
                Me.cbbBuyerName.Visible = False
                Me.txbTelMP.Visible = True
                Me.cbbTelMP.Visible = False
            End If

            Me.btnViewCustomer.Enabled = blCanViewCustomer

            If Me.txbCompanyCredentialsNo.Text = "" Then
                Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll()
            ElseIf Me.txbBuyerName.Visible = True Then
                Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
            Else
                Me.cbbBuyerName.Select() : Me.cbbBuyerName.SelectAll()
            End If

            For Each drPayment As DataRow In dtPayment.Select("PaymentTerm=1")
                drPayment("PayerName") = drSalesBill("BuyerName").ToString
            Next

            frmMain.statusText.Text = "就绪。"
        End If

        Me.Activate() : Me.Cursor = Cursors.Default
        blSkipDeal = False
    End Sub

    Private Sub cbbAvailablePayer_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cbbAvailablePayer.SelectedIndexChanged
        If blSkipDeal Then Return
        Me.dgvPayment("PayerName", 0).Value = Me.cbbAvailablePayer.Text
    End Sub

    Private Sub grbBuyerInfo_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles grbBuyerInfo.Leave
        frmMain.statusText.Text = "就绪。"
    End Sub

    Private Sub txbBuyerName_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbBuyerName.DoubleClick
        Me.txbBuyerName.SelectAll()
    End Sub

    Private Sub txbBuyerName_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbBuyerName.Enter, cbbBuyerName.Enter
        If sSalesBillID = "-1" AndAlso frmMain.statusText.Text <> "请先输入客户姓名。" Then
            frmMain.statusText.Text = "快捷键提示：按<F1>可插入/删除""先生""；按<F2>可插入/删除""女士""。"
        End If
    End Sub

    Private Sub txbBuyerName_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbBuyerName.KeyDown, cbbBuyerName.KeyDown
        If Me.txbBuyerName.Visible = True AndAlso Me.txbBuyerName.ReadOnly Then Return
        If e.KeyCode = Keys.Enter Then
            If Me.txbTelMP.Visible Then
                Me.txbTelMP.Select() : Me.txbTelMP.SelectAll()
            Else
                Me.cbbTelMP.Select() : Me.cbbTelMP.SelectionStart = 0 : Me.cbbTelMP.SelectionLength = Me.cbbTelMP.Text.Length
            End If
            e.SuppressKeyPress = True : Return
        End If

        If e.KeyCode = Keys.F1 Then
            If Me.txbBuyerName.Visible Then
                If Me.txbBuyerName.Text.IndexOf("先生") = -1 Then
                    Me.txbBuyerName.Text = Me.txbBuyerName.Text.Trim & "先生"
                Else
                    Me.txbBuyerName.Text = Me.txbBuyerName.Text.Trim.Replace("先生", "")
                End If
                Me.txbBuyerName.SelectionLength = 0 : Me.txbBuyerName.SelectionStart = Me.txbBuyerName.Text.Length
            Else
                If Me.cbbBuyerName.Text.IndexOf("先生") = -1 Then
                    Me.cbbBuyerName.Text = Me.cbbBuyerName.Text.Trim & "先生"
                Else
                    Me.cbbBuyerName.Text = Me.cbbBuyerName.Text.Trim.Replace("先生", "")
                End If
                Me.cbbBuyerName.SelectionLength = 0 : Me.cbbBuyerName.SelectionStart = Me.cbbBuyerName.Text.Length
            End If
            e.SuppressKeyPress = True : Return
        End If

        If e.KeyCode = Keys.F2 Then
            If Me.txbBuyerName.Visible Then
                If Me.txbBuyerName.Text.IndexOf("女士") = -1 Then
                    Me.txbBuyerName.Text = Me.txbBuyerName.Text.Trim & "女士"
                Else
                    Me.txbBuyerName.Text = Me.txbBuyerName.Text.Trim.Replace("女士", "")
                End If
                Me.txbBuyerName.SelectionLength = 0 : Me.txbBuyerName.SelectionStart = Me.txbBuyerName.Text.Length
            Else
                If Me.cbbBuyerName.Text.IndexOf("女士") = -1 Then
                    Me.cbbBuyerName.Text = Me.cbbBuyerName.Text.Trim & "女士"
                Else
                    Me.cbbBuyerName.Text = Me.cbbBuyerName.Text.Trim.Replace("女士", "")
                End If
                Me.cbbBuyerName.SelectionLength = 0 : Me.cbbBuyerName.SelectionStart = Me.cbbBuyerName.Text.Length
            End If
            e.SuppressKeyPress = True : Return
        End If

        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    Private Sub txbBuyerName_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbBuyerName.Leave
        If Me.txbBuyerName.ReadOnly Then Return
        If Me.txbBuyerName.Text <> Me.txbBuyerName.Text.Trim Then Me.txbBuyerName.Text = Me.txbBuyerName.Text.Trim
    End Sub

    Private Sub txbBuyerName_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbBuyerName.TextChanged
        If blSkipDeal OrElse Me.txbBuyerName.ReadOnly Then Return
        If drSalesBill("BuyerName").ToString <> Me.txbBuyerName.Text.Trim Then
            blSkipDeal = True
            drSalesBill("BuyerName") = Me.txbBuyerName.Text.Trim
            If Me.txbBuyerName.Text = "" Then
                drSalesBill("TelMP") = DBNull.Value
                drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                drSalesBill("BuyerCredentialsNo") = DBNull.Value
                Me.txbTelMP.Text = ""
                Me.cbbBuyerCredentialsType.Text = Me.cbbBuyerCredentialsType.Items(0)
                Me.txbBuyerCredentialsNo.Text = ""
            End If
            blSkipDeal = False

            For Each drPayment As DataRow In dtPayment.Select("PaymentTerm=1")
                drPayment("PayerName") = drSalesBill("BuyerName").ToString
            Next
        End If
    End Sub

    Private Sub cbbBuyerName_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbBuyerName.Leave
        If Me.cbbBuyerName.Text <> Me.cbbBuyerName.Text.Trim Then Me.cbbBuyerName.Text = Me.cbbBuyerName.Text.Trim : Me.txbBuyerName.Text = Me.cbbBuyerName.Text
    End Sub

    Private Sub cbbBuyerName_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles cbbBuyerName.MouseClick
        If Me.cbbBuyerName.Focused AndAlso e.Button = Windows.Forms.MouseButtons.Left Then
            bClicks += 1
            sTimerType = "DoubleClick"
            Me.theTimer.Interval = 500
            Me.theTimer.Enabled = True
            If bClicks = 2 Then
                Me.cbbBuyerName.SelectionStart = 0
                Me.cbbBuyerName.SelectionLength = Me.cbbCustomerName.Text.Length
                bClicks = 0
            End If
        Else
            Me.cbbBuyerName.SelectionLength = 0
        End If
    End Sub

    Private Sub cbbBuyerName_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbBuyerName.TextChanged, cbbBuyerName.SelectedIndexChanged
        If blSkipDeal Then Return

        If drSalesBill("BuyerName").ToString <> Me.cbbBuyerName.Text.Trim Then
            blSkipDeal = True
            drSalesBill("BuyerName") = Me.cbbBuyerName.Text.Trim
            Me.txbBuyerName.Text = Me.cbbBuyerName.Text.Trim
            'modify code 046,054,072:start-------------------------------------------------------------------------
            '同一般销售单
            'If bNewSalesBillType = 0 Then
            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 Then
            If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                'modify code 046,054,072:end-------------------------------------------------------------------------
                If Me.cbbBuyerName.SelectedIndex = -1 OrElse Me.cbbBuyerName.Text.Trim = "" Then
                    dvCustomerBuyer.RowFilter = "1=2"
                Else
                    dvCustomerBuyer.RowFilter = "BuyerName='" & drSalesBill("BuyerName").ToString.Replace("'", "''") & "'"
                End If
                If dvCustomerBuyer.Count = 0 Then
                    If (Me.cbbTelMP.Visible = True AndAlso Me.cbbTelMP.SelectedIndex <> -1) OrElse Me.cbbBuyerName.Text = "" Then
                        drSalesBill("TelMP") = DBNull.Value
                        drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                        drSalesBill("BuyerCredentialsNo") = DBNull.Value
                    End If
                    Me.txbTelMP.Visible = True
                    Me.cbbTelMP.Visible = False
                Else
                    Me.cbbTelMP.Items.Clear()
                    For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "TelMP").Rows
                        If drBuyer("TelMP").ToString <> "" Then Me.cbbTelMP.Items.Add(drBuyer("TelMP").ToString)
                    Next
                    If Me.cbbTelMP.Items.Count = 0 Then
                        drSalesBill("TelMP") = ""
                        Me.txbTelMP.Visible = True
                        Me.cbbTelMP.Visible = False
                    Else
                        drSalesBill("TelMP") = Me.cbbTelMP.Items(0)
                        Me.txbTelMP.Visible = False
                        Me.cbbTelMP.Visible = True
                    End If
                    If dvCustomerBuyer(0)("CredentialsType").ToString = "" Then
                        drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                    Else
                        drSalesBill("BuyerCredentialsType") = dvCustomerBuyer(0)("CredentialsType").ToString
                    End If
                    drSalesBill("BuyerCredentialsNo") = dvCustomerBuyer(0)("CredentialsNo").ToString
                End If
            ElseIf bNewSalesBillType = 2 Then
                Me.cbbTelMP.Items.Clear()
                If drSalesBill("TelMP").ToString = "" Then
                    Me.txbTelMP.Visible = True
                    Me.cbbTelMP.Visible = False
                Else
                    Me.cbbTelMP.Items.Add(drSalesBill("TelMP").ToString)
                    Me.cbbTelMP.Visible = True
                    Me.txbTelMP.Visible = False
                End If
                drSalesBill("TelMP") = drInternalPayer("MKTelMP").ToString
                drSalesBill("BuyerCredentialsType") = drInternalPayer("MKCredentialsType").ToString
                If drSalesBill("BuyerCredentialsType").ToString = "" Then drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                drSalesBill("BuyerCredentialsNo") = drInternalPayer("MKCredentialsNo").ToString
            Else
                Me.cbbTelMP.Items.Clear()
                If drSalesBill("TelMP").ToString = "" Then
                    Me.txbTelMP.Visible = True
                    Me.cbbTelMP.Visible = False
                Else
                    Me.cbbTelMP.Items.Add(drSalesBill("TelMP").ToString)
                    Me.cbbTelMP.Visible = True
                    Me.txbTelMP.Visible = False
                End If
                drSalesBill("TelMP") = drInternalPayer("PRTelMP").ToString
                drSalesBill("BuyerCredentialsType") = drInternalPayer("PRCredentialsType").ToString
                If drSalesBill("BuyerCredentialsType").ToString = "" Then drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                drSalesBill("BuyerCredentialsNo") = drInternalPayer("PRCredentialsNo").ToString
            End If
            Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
            Me.txbTelMP.Text = Me.cbbTelMP.Text
            Me.cbbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
            Me.txbBuyerCredentialsType.Text = Me.cbbBuyerCredentialsType.Text
            Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
            blSkipDeal = False

            For Each drPayment As DataRow In dtPayment.Select("PaymentTerm=1")
                drPayment("PayerName") = drSalesBill("BuyerName").ToString
            Next
        End If
    End Sub

    Private Sub txbTelMP_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbTelMP.DoubleClick
        Me.txbTelMP.SelectAll()
    End Sub

    Private Sub txbTelMP_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbTelMP.Enter, cbbTelMP.Enter
        If Me.txbBuyerName.ReadOnly = False AndAlso Me.txbBuyerName.Visible = True AndAlso Me.txbBuyerName.Text = "" Then
            Me.txbBuyerName.Select()
            frmMain.statusText.Text = "请先输入客户姓名。"
        ElseIf Me.cbbBuyerName.Visible = True AndAlso Me.cbbBuyerName.Text = "" Then
            Me.txbBuyerName.Select()
            frmMain.statusText.Text = "请先输入客户姓名。"
        Else
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub txbTelMP_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbTelMP.KeyDown, cbbTelMP.KeyDown
        If Me.txbTelMP.Visible = True AndAlso Me.txbTelMP.ReadOnly Then Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then
            If Me.cbbBuyerCredentialsType.Visible Then
                Me.cbbBuyerCredentialsType.Select() : Me.cbbBuyerCredentialsType.SelectAll()
            Else
                Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True
            End If
            e.SuppressKeyPress = True : Return
        End If
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If (e.Shift AndAlso (e.KeyCode = Keys.D9 OrElse e.KeyCode = Keys.D0)) OrElse e.KeyCode = Keys.OemMinus OrElse e.KeyCode = Keys.Subtract OrElse e.KeyCode = Keys.Space Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbTelMP_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbTelMP.Leave
        If Me.txbTelMP.ReadOnly Then Return
        If Me.txbTelMP.Text <> Me.txbTelMP.Text.Trim Then Me.txbTelMP.Text = Me.txbTelMP.Text.Trim
    End Sub

    Private Sub cbbTelMP_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbTelMP.Leave
        If Me.cbbTelMP.Text <> Me.cbbTelMP.Text.Trim Then Me.cbbTelMP.Text = Me.cbbTelMP.Text.Trim : Me.txbTelMP.Text = Me.cbbTelMP.Text
    End Sub

    Private Sub cbbTelMP_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles cbbTelMP.MouseClick
        If Me.cbbTelMP.Focused AndAlso e.Button = Windows.Forms.MouseButtons.Left Then
            bClicks += 1
            sTimerType = "DoubleClick"
            Me.theTimer.Interval = 500
            Me.theTimer.Enabled = True
            If bClicks = 2 Then
                Me.cbbTelMP.SelectionStart = 0
                Me.cbbTelMP.SelectionLength = Me.cbbTelMP.Text.Length
                bClicks = 0
            End If
        Else
            Me.cbbTelMP.SelectionLength = 0
        End If
    End Sub

    Private Sub cbbTelMP_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles cbbTelMP.Validating, txbTelMP.Validating
        If Me.txbTelMP.Visible AndAlso Me.txbTelMP.ReadOnly Then Return
        If Me.txbTelMP.Visible AndAlso drSalesBill("TelMP").ToString = Me.txbTelMP.Text.Trim Then Return
        If Me.cbbTelMP.Visible AndAlso drSalesBill("TelMP").ToString = Me.cbbTelMP.Text.Trim Then Return
        'modify code 046,054,072:start-------------------------------------------------------------------------
        '同一般销售单
        'Dim sTelMP As String = CType(sender, Control).Text.Trim, sName As String = IIf(bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
        'Dim sTelMP As String = CType(sender, Control).Text.Trim, sName As String = IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
        Dim sTelMP As String = CType(sender, Control).Text.Trim, sName As String = IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
        'modify code 046,054,072:end-------------------------------------------------------------------------
        If sTelMP <> "" AndAlso sTelMP.Length < 7 Then
            drSalesBill("TelMP") = DBNull.Value
            If sCustomerPrompt.IndexOf("联系电话") = -1 Then MessageBox.Show(sName & "联系电话位数不应低于 7 位！    " & Chr(13) & Chr(13) & "请重新输入" & sName & "联系电话。    ", sName & "联系电话位数不应低于 7 位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            sCustomerPrompt = sName & "联系电话位数不应低于 7 位！请重新输入" & sName & "联系电话。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "TelMPError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        Else
            drSalesBill("TelMP") = sTelMP
            Me.txbTelMP.Text = sTelMP
            sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub cbbBuyerCredentialsType_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbBuyerCredentialsType.Enter
        If Me.txbBuyerName.ReadOnly = False AndAlso Me.txbBuyerName.Visible = True AndAlso Me.txbBuyerName.Text = "" Then
            Me.txbBuyerName.Select()
            frmMain.statusText.Text = "请先输入客户姓名。"
        ElseIf Me.cbbBuyerName.Visible = True AndAlso Me.cbbBuyerName.Text = "" Then
            Me.txbBuyerName.Select()
            frmMain.statusText.Text = "请先输入客户姓名。"
        Else
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub cbbBuyerCredentialsType_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles cbbBuyerCredentialsType.KeyDown
        If e.KeyCode = Keys.Enter Then
            Me.txbBuyerCredentialsNo.Select() : Me.txbBuyerCredentialsNo.SelectAll()
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    Private Sub cbbBuyerCredentialsType_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbBuyerCredentialsType.Leave
        If Me.cbbBuyerCredentialsType.Text <> Me.cbbBuyerCredentialsType.Text.Trim Then
            blSkipDeal = True
            Me.cbbBuyerCredentialsType.Text = Me.cbbBuyerCredentialsType.Text.Trim
            Me.txbBuyerCredentialsType.Text = Me.cbbBuyerCredentialsType.Text
            blSkipDeal = False
        End If
    End Sub

    Private Sub cbbBuyerCredentialsType_MouseClick(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles cbbBuyerCredentialsType.MouseClick
        If drSalesBill("BuyerName").ToString = "" OrElse Me.cbbBuyerCredentialsType.Focused = False Then
            Me.cbbBuyerCredentialsType.SelectionLength = 0
        ElseIf e.Button = Windows.Forms.MouseButtons.Left Then
            bClicks += 1
            sTimerType = "DoubleClick"
            Me.theTimer.Interval = 500
            Me.theTimer.Enabled = True
            If bClicks = 2 Then
                Me.cbbBuyerCredentialsType.SelectionStart = 0
                Me.cbbBuyerCredentialsType.SelectionLength = Me.cbbBuyerCredentialsType.Text.Length
                bClicks = 0
            End If
        End If
    End Sub

    Private Sub cbbBuyerCredentialsType_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbbBuyerCredentialsType.TextChanged, cbbBuyerCredentialsType.SelectedIndexChanged
        If blSkipDeal OrElse drSalesBill("BuyerCredentialsType").ToString = Me.cbbBuyerCredentialsType.Text.Trim Then Return
        Me.txbBuyerCredentialsType.Text = Me.cbbBuyerCredentialsType.Text.Trim
        drSalesBill("BuyerCredentialsType") = Me.txbBuyerCredentialsType.Text
        Select Case bNewSalesBillType
            Case 0
                If drSalesBill("CustomerType") = 0 Then
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                Else
                    dvCustomerBuyer.RowFilter = "BuyerName='" & drSalesBill("BuyerName").ToString.Replace("'", "''") & "'"
                    If dvCustomerBuyer.Count = 0 OrElse Me.cbbBuyerCredentialsType.Text <> dvCustomerBuyer(0)("CredentialsType").ToString Then
                        drSalesBill("BuyerCredentialsNo") = DBNull.Value
                    Else
                        drSalesBill("BuyerCredentialsNo") = dvCustomerBuyer(0)("CredentialsNo").ToString
                    End If
                End If
            Case 2
                If drSalesBill("BuyerName").ToString <> drInternalPayer("MKLinkman").ToString OrElse Me.cbbBuyerCredentialsType.Text <> drInternalPayer("MKbBuyerCredentialsType").ToString Then
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                Else
                    drSalesBill("BuyerCredentialsNo") = drInternalPayer("MKCredentialsNo").ToString
                End If
            Case Else
                If drSalesBill("BuyerName").ToString <> drInternalPayer("PRLinkman").ToString OrElse Me.cbbBuyerCredentialsType.Text <> drInternalPayer("PRbBuyerCredentialsType").ToString Then
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                Else
                    drSalesBill("BuyerCredentialsNo") = drInternalPayer("PRCredentialsNo").ToString
                End If
        End Select
        Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
    End Sub

    Private Sub txbBuyerCredentialsNo_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbBuyerCredentialsNo.DoubleClick
        Me.txbBuyerCredentialsNo.SelectAll()
    End Sub

    Private Sub txbBuyerCredentialsNo_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbBuyerCredentialsNo.Enter
        If Me.txbBuyerCredentialsNo.ReadOnly Then Return
        If Me.txbBuyerName.ReadOnly = False AndAlso Me.txbBuyerName.Visible = True AndAlso Me.txbBuyerName.Text = "" Then
            Me.txbBuyerName.Select()
            frmMain.statusText.Text = "请先输入客户姓名。"
        ElseIf Me.cbbBuyerName.Visible = True AndAlso Me.cbbBuyerName.Text = "" Then
            Me.txbBuyerName.Select()
            frmMain.statusText.Text = "请先输入客户姓名。"
        ElseIf Me.cbbBuyerCredentialsType.Text = "" Then
            Me.cbbBuyerCredentialsType.Select()
            'modify code 046,054,072:start-------------------------------------------------------------------------
            '同一般销售单
            'frmMain.statusText.Text = "请先选择或输入" & IIf(bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人") & "证件类型。"
            'frmMain.statusText.Text = "请先选择或输入" & IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人") & "证件类型。"
            frmMain.statusText.Text = "请先选择或输入" & IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人") & "证件类型。"
            'modify code 046,054,072:end-------------------------------------------------------------------------
        Else
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub txbBuyerCredentialsNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbBuyerCredentialsNo.KeyDown
        If Me.txbBuyerCredentialsNo.ReadOnly Then Return
        If e.Control AndAlso e.KeyCode = Keys.V Then My.Computer.Clipboard.Clear() : e.SuppressKeyPress = True : Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True : e.SuppressKeyPress = True : Return
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If e.KeyCode = Keys.Multiply OrElse (e.Shift AndAlso e.KeyCode = Keys.D8) Then e.SuppressKeyPress = True : Return '不允许输入“*”号

        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) OrElse _
           (e.KeyCode >= Keys.A AndAlso e.KeyCode <= Keys.Z) OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back OrElse _
           (e.Shift AndAlso (e.KeyCode = Keys.D9 OrElse e.KeyCode = Keys.D0)) OrElse e.KeyCode = Keys.OemMinus OrElse e.KeyCode = Keys.Subtract OrElse e.KeyCode = Keys.Space Then

            If Me.txbBuyerCredentialsNo.Text.IndexOf("*") > -1 Then Me.txbBuyerCredentialsNo.Text = ""
            Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbBuyerCredentialsNo_MouseDown(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles txbBuyerCredentialsNo.MouseDown
        If Me.txbBuyerCredentialsNo.ReadOnly = False AndAlso e.Button = Windows.Forms.MouseButtons.Right Then My.Computer.Clipboard.Clear()
    End Sub

    Private Sub txbBuyerCredentialsNo_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbBuyerCredentialsNo.Validating
        If Me.txbBuyerCredentialsNo.ReadOnly OrElse Me.txbBuyerCredentialsNo.Text.Trim.IndexOf("*") > -1 Then Return
        If Me.txbBuyerCredentialsNo.Text <> Me.txbBuyerCredentialsNo.Text.Trim Then Me.txbBuyerCredentialsNo.Text = Me.txbBuyerCredentialsNo.Text.Trim
        'modify code 046,054,072:start-------------------------------------------------------------------------
        '同一般销售单
        'Dim sBuyerCredentialsNo As String = Me.txbBuyerCredentialsNo.Text, sName As String = IIf(bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
        'Dim sBuyerCredentialsNo As String = Me.txbBuyerCredentialsNo.Text, sName As String = IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
        Dim sBuyerCredentialsNo As String = Me.txbBuyerCredentialsNo.Text, sName As String = IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
        'modify code 046,054,072:end-------------------------------------------------------------------------
        If sBuyerCredentialsNo <> "" Then
            If Me.cbbBuyerCredentialsType.SelectedIndex = 0 Then '身份证号
                If sBuyerCredentialsNo.Length <> 18 Then
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                    If sCustomerPrompt.IndexOf("身份证号码位数") = -1 Then MessageBox.Show(sName & "身份证号码位数应该是 18 位（二代身份证）！    " & Chr(13) & Chr(13) & "请重新输入" & sName & "身份证号码。    ", sName & "身份证号码错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sCustomerPrompt = sName & "身份证号码位数应该是 18 位（二代身份证）！请重新输入" & sName & "身份证号码。"
                    frmMain.statusText.Text = sCustomerPrompt
                    sTimerType = "BuyerCredentialsNoError"
                    Me.theTimer.Interval = 50
                    Me.theTimer.Enabled = True
                    Return
                ElseIf (Not IsNumeric(sBuyerCredentialsNo.Substring(0, 17))) OrElse (Not IsDate(sBuyerCredentialsNo.Substring(6, 8).Insert(4, "/").Insert(7, "/"))) OrElse sBuyerCredentialsNo <> CustomerIDNo.GetFullIDNo(sBuyerCredentialsNo.Substring(0, 17)) Then
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                    If sCustomerPrompt.IndexOf("身份证号码无效") = -1 Then MessageBox.Show(sName & "身份证号码无效！    " & Chr(13) & Chr(13) & "请重新输入" & sName & "身份证号码。    ", sName & "身份证号码无效！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sCustomerPrompt = sName & "身份证号码无效！请重新输入" & sName & "身份证号码。"
                    frmMain.statusText.Text = sCustomerPrompt
                    sTimerType = "BuyerCredentialsNoError"
                    Me.theTimer.Interval = 50
                    Me.theTimer.Enabled = True
                    Return
                End If
            ElseIf sBuyerCredentialsNo.Length < 4 Then
                drSalesBill("BuyerCredentialsNo") = DBNull.Value
                If sCustomerPrompt.IndexOf("人证件号码位数") = -1 Then MessageBox.Show(sName & "证件号码位数不应低于 4 位！    " & Chr(13) & Chr(13) & "请重新输入" & sName & "证件号码。    ", sName & "证件号码位数位数不应低于 4 位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                sCustomerPrompt = sName & "证件号码位数不应低于 4 位！请重新输入" & sName & "证件号码。"
                frmMain.statusText.Text = sCustomerPrompt
                sTimerType = "BuyerCredentialsNoError"
                Me.theTimer.Interval = 50
                Me.theTimer.Enabled = True
                Return
            End If
        End If
        drSalesBill("BuyerCredentialsNo") = sBuyerCredentialsNo
        Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
        If sCustomerPrompt.IndexOf("联系电话") = -1 Then sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
        frmMain.statusText.Text = "就绪。"
    End Sub

    Private Sub txbMemberName_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberName.DoubleClick
        Me.txbMemberName.SelectAll()
    End Sub

    Private Sub txbMemberName_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbMemberName.KeyDown
        If Me.txbMemberName.ReadOnly Then Return
        If e.KeyCode = Keys.Enter Then
            Me.txbMemberIDNo.Select() : Me.txbMemberIDNo.SelectAll()
            e.SuppressKeyPress = True : Return
        End If

        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    Private Sub txbMemberName_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberName.Leave
        If Me.txbMemberName.ReadOnly Then Return
        If Me.txbMemberName.Text <> Me.txbMemberName.Text.Trim Then Me.txbMemberName.Text = Me.txbMemberName.Text.Trim
    End Sub

    Private Sub txbMemberName_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberName.TextChanged
        If Me.txbMemberName.ReadOnly OrElse drSalesBill("BuyerName").ToString = Me.txbMemberName.Text.Trim Then Return
        drSalesBill("BuyerName") = Me.txbMemberName.Text.Trim
    End Sub

    Private Sub txbMemberIDNo_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberIDNo.DoubleClick
        Me.txbMemberIDNo.SelectAll()
    End Sub

    Private Sub txbMemberIDNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbMemberIDNo.KeyDown
        If Me.txbMemberIDNo.ReadOnly Then Return
        If e.Control AndAlso e.KeyCode = Keys.V Then My.Computer.Clipboard.Clear() : e.SuppressKeyPress = True : Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True : e.SuppressKeyPress = True : Return
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If e.KeyCode = Keys.Multiply OrElse (e.Shift AndAlso e.KeyCode = Keys.D8) Then e.SuppressKeyPress = True : Return '不允许输入“*”号

        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) OrElse e.KeyCode = Keys.X OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then
            If Me.txbMemberIDNo.Text.IndexOf("*") > -1 Then Me.txbMemberIDNo.Text = ""
            Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbMemberIDNo_MouseDown(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles txbMemberIDNo.MouseDown
        If Me.txbMemberIDNo.ReadOnly = False AndAlso e.Button = Windows.Forms.MouseButtons.Right Then My.Computer.Clipboard.Clear()
    End Sub

    Private Sub txbMemberIDNo_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbMemberIDNo.Validating
        If Me.txbMemberIDNo.ReadOnly OrElse Me.txbMemberIDNo.Text.Trim.IndexOf("*") > -1 Then Return
        If Me.txbMemberIDNo.Text <> Me.txbMemberIDNo.Text.Trim Then Me.txbMemberIDNo.Text = Me.txbMemberIDNo.Text.Trim
        Dim sMemberIDNo As String = Me.txbMemberIDNo.Text
        If sMemberIDNo = "" Then Return
        If sMemberIDNo.Length <> 18 Then
            MessageBox.Show("会员身份证号码位数应该是 18 位（二代身份证）！    " & Chr(13) & Chr(13) & "请重新输入会员身份证号码。    ", "会员身份证号码错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "会员身份证号码位数应该是 18 位（二代身份证）！请重新输入会员身份证号码。"
            e.Cancel = True
            Return
        ElseIf (Not IsNumeric(sMemberIDNo.Substring(0, 17))) OrElse (Not IsDate(sMemberIDNo.Substring(6, 8).Insert(4, "/").Insert(7, "/"))) OrElse sMemberIDNo <> CustomerIDNo.GetFullIDNo(sMemberIDNo.Substring(0, 17)) Then
            MessageBox.Show("会员身份证号码无效！    " & Chr(13) & Chr(13) & "请重新输入会员身份证号码。    ", "会员身份证号码无效！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "会员身份证号码无效！请重新输入会员身份证号码。"
            e.Cancel = True
            Return
        End If

        drSalesBill("BuyerCredentialsNo") = sMemberIDNo
        Me.txbMemberIDNo.Text = Me.MaskBuyerCredentialsNo()

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在检索会员信息……"
        frmMain.statusMain.Refresh()

        Dim DB As New DataBase()
        DB.Open()
        If DB.IsConnected Then
            Try
                drMember = DB.GetDataTable("Select Top (1) * From MemberSales Where MemberIDNo='" & sMemberIDNo & "' Order By SalesBillID DESC").Rows(0)
                drSalesBill("BuyerName") = drMember("MemberName").ToString
                Me.txbMemberName.Text = drMember("MemberName").ToString
                drSalesBill("TelMP") = drMember("MemberTel").ToString
                Me.txbMemberTel.Text = drMember("MemberTel").ToString
                Me.txbMemberAddress.Text = drMember("MemberAddress").ToString
                Me.txbNewMemberCardNo.Text = drMember("NewMemberCardNo").ToString
            Catch
            End Try
        End If
        DB.Close()

        Me.Cursor = Cursors.Default
        frmMain.statusText.Text = "就绪。"
    End Sub

    Private Sub txbMemberTel_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberTel.DoubleClick
        Me.txbMemberTel.SelectAll()
    End Sub

    Private Sub txbMemberTel_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbMemberTel.KeyDown, cbbTelMP.KeyDown
        If Me.txbMemberTel.ReadOnly Then Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then
            Me.txbMemberAddress.Select() : Me.txbMemberAddress.SelectAll()
            e.SuppressKeyPress = True : Return
        End If
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If (e.Shift AndAlso (e.KeyCode = Keys.D9 OrElse e.KeyCode = Keys.D0)) OrElse e.KeyCode = Keys.OemMinus OrElse e.KeyCode = Keys.Subtract OrElse e.KeyCode = Keys.Space Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbMemberTel_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberTel.Leave
        If Me.txbMemberTel.ReadOnly Then Return
        If Me.txbMemberTel.Text <> Me.txbMemberTel.Text.Trim Then Me.txbMemberTel.Text = Me.txbMemberTel.Text.Trim
    End Sub

    Private Sub txbMemberTel_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbMemberTel.Validating
        If Me.txbMemberTel.ReadOnly OrElse drSalesBill("TelMP").ToString = Me.txbMemberTel.Text.Trim Then Return
        Dim sTelMP As String = Me.txbMemberTel.Text.Trim
        CType(sender, Control).Text = sTelMP
        If sTelMP <> "" AndAlso sTelMP.Length < 7 Then
            MessageBox.Show("会员联系电话位数不应低于 7 位！    " & Chr(13) & Chr(13) & "请重新输入会员联系电话。    ", "会员联系电话位数不应低于 7 位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "会员联系电话位数不应低于 7 位！请重新输入会员联系电话。"
            e.Cancel = True
        Else
            drSalesBill("TelMP") = sTelMP
            frmMain.statusText.Text = "就绪。"
        End If
    End Sub

    Private Sub txbMemberAddress_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberAddress.DoubleClick
        Me.txbMemberAddress.SelectAll()
    End Sub

    Private Sub txbMemberAddress_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbMemberAddress.KeyDown
        If txbMemberAddress.ReadOnly Then Return
        If e.KeyCode = Keys.Enter Then
            Me.txbNewMemberCardNo.Select() : Me.txbNewMemberCardNo.SelectAll()
            e.SuppressKeyPress = True : Return
        End If
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    Private Sub txbMemberAddress_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbMemberAddress.Leave
        If Me.txbMemberAddress.ReadOnly Then Return
        Me.txbMemberAddress.Text = Me.txbMemberAddress.Text.Trim
    End Sub

    Private Sub txbNewMemberCardNo_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbNewMemberCardNo.DoubleClick
        Me.txbNewMemberCardNo.SelectAll()
    End Sub

    Private Sub txbNewMemberCardNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbNewMemberCardNo.KeyDown
        If Me.txbNewMemberCardNo.ReadOnly Then Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then
            Me.txbOldMemberCardNo.Select() : Me.txbOldMemberCardNo.SelectAll()
            e.SuppressKeyPress = True : Return
        End If
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbNewMemberCardNo_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbNewMemberCardNo.Validating
        If Me.txbNewMemberCardNo.ReadOnly Then Return
        Dim sNewNo As String = Me.txbNewMemberCardNo.Text.Trim
        Me.txbNewMemberCardNo.Text = sNewNo
        If sNewNo = "" Then Return
        If Not IsNumeric(sNewNo) Then
            MessageBox.Show("新积分卡号必须由数字组成！请重新输入新积分卡号。    ", "新积分卡号必须由数字组成！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "新积分卡号必须由数字组成！请重新输入新积分卡号。"
            e.Cancel = True
        ElseIf sNewNo.Length <> "20" Then
            MessageBox.Show("新积分卡号位数应该是 20 位！请重新输入新积分卡号。    ", "新积分卡号错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "新积分卡号位数应该是 20 位！请重新输入新积分卡号。 "
            e.Cancel = True
        ElseIf sNewNo.Substring(16, 4) <> "9912" Then
            MessageBox.Show("新积分卡号最后 4 位应该是""9912""（有效期）！请重新输入新积分卡号。    ", "新积分卡号错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "新积分卡号最后 4 位应该是""9912""（有效期）！请重新输入新积分卡号。 "
            e.Cancel = True
        ElseIf sNewNo.Substring(0, 16) <> MemberCardNo.GetFullCardNo(sNewNo.Substring(0, 15)) Then
            MessageBox.Show("新积分卡号无效！    " & Chr(13) & Chr(13) & "请重新输入新积分卡号。    ", "新积分卡号无效！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "新积分卡号无效！请重新输入新积分卡号。"
            e.Cancel = True
        End If
    End Sub

    Private Sub txbOldMemberCardNo_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbOldMemberCardNo.DoubleClick
        Me.txbOldMemberCardNo.SelectAll()
    End Sub

    Private Sub txbOldMemberCardNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbOldMemberCardNo.KeyDown
        If Me.txbOldMemberCardNo.ReadOnly Then Return
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Delete OrElse e.KeyCode = Keys.Back Then Return
        If e.Shift AndAlso e.KeyCode <> Keys.D0 AndAlso e.KeyCode <> Keys.D9 Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then
            Me.txbOldMemberCardNo.Select() : Me.txbOldMemberCardNo.SelectAll()
            e.SuppressKeyPress = True : Return
        End If
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbOldMemberCardNo_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbOldMemberCardNo.Validating
        If Me.txbOldMemberCardNo.ReadOnly Then Return
        Dim sOldNo As String = Me.txbOldMemberCardNo.Text.Trim
        Me.txbOldMemberCardNo.Text = sOldNo
        If sOldNo = "" Then Return
        If Not IsNumeric(sOldNo) Then
            MessageBox.Show("旧积分卡号必须由数字组成！请重新输入旧积分卡号。    ", "旧积分卡号必须由数字组成！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "旧积分卡号必须由数字组成！请重新输入旧积分卡号。"
            e.Cancel = True
        ElseIf sOldNo.Length <> "20" Then
            MessageBox.Show("旧积分卡号位数应该是 20 位！请重新输入旧积分卡号。    ", "旧积分卡号错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "旧积分卡号位数应该是 20 位！请重新输入旧积分卡号。 "
            e.Cancel = True
        ElseIf sOldNo.Substring(16, 4) <> "9912" Then
            MessageBox.Show("旧积分卡号最后 4 位应该是""9912""（有效期）！请重新输入旧积分卡号。    ", "旧积分卡号错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "旧积分卡号最后 4 位应该是""9912""（有效期）！请重新输入旧积分卡号。 "
            e.Cancel = True
        ElseIf sOldNo.Substring(0, 16) <> MemberCardNo.GetFullCardNo(sOldNo.Substring(0, 15)) Then
            MessageBox.Show("旧积分卡号无效！    " & Chr(13) & Chr(13) & "请重新输入旧积分卡号。    ", "旧积分卡号无效！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "旧积分卡号无效！请重新输入旧积分卡号。"
            e.Cancel = True
        End If
    End Sub

    Private Sub chbBalanceContract_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chbBalanceContract.CheckedChanged
        If blSkipDeal Then Return

        Try
            Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
            dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue"))
        Catch
            dmMinFaceValue = 1 : dmMaxFaceValue = 1000
        End Try
        If blUsedOldCard Then dmMinFaceValue = 0

        If Me.chbBalanceContract.Checked = False Then
            Me.splitList.Panel1Collapsed = False
            Me.flpBalanceContract.Visible = False
            Me.grbBalanceContract.Height = 108

            Dim blHadInitted As Boolean = False
            If sContractID <> "" Then
                Me.grbContract.Visible = True
                If Me.chbContract.Checked Then Me.InitContractInfo() : blHadInitted = True
            End If

            If Not blHadInitted Then
                dmRebateSalesAMT = 0
                drSalesBill("CardQTY") = 0
                drSalesBill("RebateMode") = 0
                drSalesBill("RebateRuleID") = DBNull.Value
                drSalesBill("RebateRate") = DBNull.Value
                drSalesBill("RebateCardQTY") = 0
                drSalesBill("RebateSalesAMT") = 0
                drSalesBill("RebateState") = DBNull.Value
                Me.splitList.Panel2Collapsed = True
                blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                Me.NormalCardSummary()
                Me.ResetInterfaceLayout()
            End If

            Me.pnlBalanceContractPayment.Visible = False
            Me.pnlNormalPayment.Visible = True

            blSkipDeal = True
            If Me.dgvRebateCard.CurrentCell IsNot Nothing Then Me.dgvRebateCard.CurrentCell.Selected = False
            If Me.dgvRebateCard.CurrentRow IsNot Nothing Then Me.dgvRebateCard.CurrentRow.Selected = False

            If Me.dgvPayment.CurrentCell IsNot Nothing Then Me.dgvPayment.CurrentCell.Selected = False
            If Me.dgvPayment.CurrentRow IsNot Nothing Then Me.dgvPayment.CurrentRow.Selected = False
            blSkipDeal = False

            Me.dgvNormalCard.Select()
            Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True
        Else
            Me.grbContract.Visible = False
            Me.grbNormalRebate.Visible = False
            Me.splitList.Panel1Collapsed = True
            Me.splitList.Panel2Collapsed = False
            Me.pnlBalanceContractPayment.Visible = True
            Me.pnlNormalPayment.Visible = False
            Me.btnOK.Text = "销售单确认(&O)"

            Me.InitBalanceContractInfo()
            Me.dgvRebateCard.Select()
            Me.dgvRebateCard.Rows(Me.dgvRebateCard.RowCount - 1).Selected = False
            Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.RowCount - 1).Selected = True
        End If

        If Me.splitList.Panel2Collapsed Then
            Me.grbPrintDiscount.Visible = False
        ElseIf blCanUse92Card Then
            Me.grbPrintDiscount.Visible = True
        Else
            Me.chbPrintDiscount.Checked = False
            Me.grbPrintDiscount.Visible = False
        End If
        Me.ResetInterfaceLayout()

        If (Me.splitList.Panel1Collapsed AndAlso dtNormalCard.Rows(0)("StartCardNo").ToString <> "") OrElse (Me.splitList.Panel2Collapsed AndAlso dtRebateCard.Rows(0)("StartCardNo").ToString <> "") Then
            blCanRecheckCard = True
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                frmCheckCardResult.btnRecheck.Visible = True
            End If
        End If
    End Sub

    Private Sub lblBalanceContract_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblBalanceContract.Click
        If sSalesBillID = "-1" Then
            If Me.chbBalanceContract.Enabled Then
                Me.chbBalanceContract.Select()
                Me.chbBalanceContract.Checked = Not Me.chbBalanceContract.Checked
            Else
                MessageBox.Show("对不起，该合同不允许在本店使用！    " & Chr(13) & Chr(13) & "（该合同只允许在特定的门店中使用。）    ", "该合同不允许在本店使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            End If
        End If
    End Sub

    Private Sub btnViewBalanceContract_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnViewBalanceContract.Click
        If frmMain.dtAllowedRight.Select("RightName Like 'Customer%' And RightName<>'CustomerCreate'").Length = 0 Then
            MessageBox.Show("对不起！因为您没有浏览客户的权限，所以也不能浏览该客户的合同。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Me.btnViewContract.Enabled = False
            Return
        End If

        If frmMain.sLoginAreaType = "S" AndAlso drSalesBill("StoreID").ToString <> drSalesBill("CustomerStoreID").ToString Then
            MessageBox.Show("对不起！因为您不能查看其它门店的客户资料，所以也不能浏览该客户的合同。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnViewContract.Enabled = False
            Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
        End If

        'If frmMain.dtAllowedRight.Select("RightName Like 'Contract%' And RightName<>'ContractCreate'").Length = 0 Then
        '    MessageBox.Show("对不起！您没有浏览合同的权限。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
        '    Me.btnViewContract.Enabled = False
        '    Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
        'End If

        'modify code 068,072:start-------------------------------------------------------------------------
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            If frmMain.dtAllowedRight.Select("RightName Like 'CrossContract%' And RightName<>'CrossContractCreate'").Length = 0 Then
                MessageBox.Show("对不起！您没有浏览合同的权限。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnViewContract.Enabled = False
                Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
            End If
        Else
            If frmMain.dtAllowedRight.Select("RightName Like 'Contract%' And RightName<>'ContractCreate'").Length = 0 Then
                MessageBox.Show("对不起！您没有浏览合同的权限。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnViewContract.Enabled = False
                Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
            End If
        End If
        'modify code 068,072:end-------------------------------------------------------------------------

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开合同""" & Me.txbBalanceContractCode.Text & " " & Me.txbCustomerName.Text & """……"
        frmMain.statusMain.Refresh()

        'frmContract.sContractID = sBalanceContractID
        'If dtContractDetails IsNot Nothing Then frmContract.dtContractDetails = dtContractDetails.Copy
        'frmContract.ShowDialog()
        'frmContract.Dispose()

        'modify code 068,072:start-------------------------------------------------------------------------
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            frmCrossContract.sContractID = sBalanceContractID
            If dtContractDetails IsNot Nothing Then frmCrossContract.dtContractDetails = dtContractDetails.Copy
            frmCrossContract.ShowDialog()
            frmCrossContract.Dispose()
        Else
            frmContract.sContractID = sBalanceContractID
            If dtContractDetails IsNot Nothing Then frmContract.dtContractDetails = dtContractDetails.Copy
            frmContract.ShowDialog()
            frmContract.Dispose()
        End If
        'modify code 068,072:end-------------------------------------------------------------------------

        Me.Activate() : Me.Cursor = Cursors.Default
        Me.txbBalanceContractCode.Select() : Me.txbBalanceContractCode.SelectAll()
    End Sub

    Private Sub chbContract_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chbContract.CheckedChanged
        If blSkipDeal Then Return

        Try
            Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
            dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue"))
        Catch
            dmMinFaceValue = 1 : dmMaxFaceValue = 1000
        End Try
        If blUsedOldCard Then dmMinFaceValue = 0

        If Me.chbContract.Checked = False Then
            Me.flpContract.Visible = False
            Me.grbContract.Height = 81
            Me.pnlDeductionAMT.Visible = False

            Dim blHadInitted As Boolean = False
            If dmNormalSalesAMT > 0 Then
                Me.grbNormalRebate.Visible = True
                If Me.chbNormalRebate.Checked Then Me.InitNormalRebateInfo() : blHadInitted = True
            End If

            If Not blHadInitted Then
                dmRebateSalesAMT = 0
                drSalesBill("CardQTY") = drSalesBill("NormalCardQTY")
                drSalesBill("RebateMode") = 0
                drSalesBill("RebateRuleID") = DBNull.Value
                drSalesBill("RebateRate") = DBNull.Value
                drSalesBill("RebateCardQTY") = 0
                drSalesBill("RebateSalesAMT") = 0
                drSalesBill("RebateState") = DBNull.Value
                Me.splitList.Panel2Collapsed = True
                blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                Me.NormalCardSummary()
                Me.ResetInterfaceLayout()
            End If

            Me.dgvNormalCard.Select()
            Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True
            Me.dgvNormalCard.BeginEdit(True)
        Else
            Me.grbNormalRebate.Visible = False
            Me.flpContract.Visible = True
            Me.InitContractInfo()
            Me.dgvRebateCard.Select()
            Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.RowCount - 1).Selected = True
            Me.dgvRebateCard.BeginEdit(True)
        End If

        If Me.splitList.Panel2Collapsed Then
            Me.grbPrintDiscount.Visible = False
        ElseIf blCanUse92Card Then
            Me.grbPrintDiscount.Visible = True
        Else
            Me.chbPrintDiscount.Checked = False
            Me.grbPrintDiscount.Visible = False
        End If
        Me.ResetInterfaceLayout()

        If Me.splitList.Panel2Collapsed AndAlso dtRebateCard.Rows(0)("StartCardNo").ToString <> "" Then
            blCanRecheckCard = True
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                frmCheckCardResult.btnRecheck.Visible = True
            End If
        End If

        'modify code 075:start-------------------------------------------------------------------------
        If bNewSalesBillType = 9 Then
            If Me.chbContract.Checked = False Then
                Me.btnCheckCUL.Enabled = False
            Else
                Me.btnCheckCUL.Enabled = True
            End If
        End If
        'modify code 075:end-------------------------------------------------------------------------
    End Sub

    'modify code 075:start-------------------------------------------------------------------------
    Private Sub btnCheckCUL_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCheckCUL.Click
        frmSetOrderNow.ShowDialog()
        frmSetOrderNow.Dispose()
    End Sub
    'modify code 075:end-------------------------------------------------------------------------

    Private Sub lblContract_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblContract.Click
        If sSalesBillID = "-1" Then
            If Me.chbContract.Enabled Then
                Me.chbContract.Select()
                Me.chbContract.Checked = Not Me.chbContract.Checked
            Else
                MessageBox.Show("对不起，该合同不允许在本店使用！    " & Chr(13) & Chr(13) & "（该合同只允许在特定的门店中使用。）    ", "该合同不允许在本店使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            End If
        End If
    End Sub

    Private Sub btnViewContract_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnViewContract.Click
        If frmMain.dtAllowedRight.Select("RightName Like 'Customer%' And RightName<>'CustomerCreate'").Length = 0 Then
            MessageBox.Show("对不起！因为您没有浏览客户的权限，所以也不能浏览该客户的合同。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Me.btnViewContract.Enabled = False
            Return
        End If

        If frmMain.sLoginAreaType = "S" AndAlso drSalesBill("StoreID").ToString <> drSalesBill("CustomerStoreID").ToString Then
            MessageBox.Show("对不起！因为您不能查看其它门店的客户资料，所以也不能浏览该客户的合同。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnViewContract.Enabled = False
            Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
        End If

        'If frmMain.dtAllowedRight.Select("RightName Like 'Contract%' And RightName<>'ContractCreate'").Length = 0 Then
        '    MessageBox.Show("对不起！您没有浏览合同的权限。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
        '    Me.btnViewContract.Enabled = False
        '    Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
        'End If

        'modify code 068,072:start-------------------------------------------------------------------------
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            If frmMain.dtAllowedRight.Select("RightName Like 'CrossContract%' And RightName<>'CrossContractCreate'").Length = 0 Then
                MessageBox.Show("对不起！您没有浏览合同的权限。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnViewContract.Enabled = False
                Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
            End If
        Else
            If frmMain.dtAllowedRight.Select("RightName Like 'Contract%' And RightName<>'ContractCreate'").Length = 0 Then
                MessageBox.Show("对不起！您没有浏览合同的权限。    ", "您无权浏览合同！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnViewContract.Enabled = False
                Me.txbContractCode.Select() : Me.txbContractCode.SelectAll() : Return
            End If
        End If
        'modify code 068,072:end-------------------------------------------------------------------------

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开合同""" & Me.txbContractCode.Text & " " & Me.txbCustomerName.Text & """……"
        frmMain.statusMain.Refresh()

        'frmContract.sContractID = sContractID
        'If dtContractDetails IsNot Nothing Then frmContract.dtContractDetails = dtContractDetails.Copy
        'frmContract.iFirstAvailableRowID = iFirstAvailableRowID
        'frmContract.iSecondAvailableRowID = iSecondAvailableRowID
        'frmContract.ShowDialog()
        'frmContract.Dispose()

        'modify code 068,072:start-------------------------------------------------------------------------
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            frmCrossContract.sContractID = sContractID
            If dtContractDetails IsNot Nothing Then frmCrossContract.dtContractDetails = dtContractDetails.Copy
            frmCrossContract.iFirstAvailableRowID = iFirstAvailableRowID
            frmCrossContract.iSecondAvailableRowID = iSecondAvailableRowID
            frmCrossContract.ShowDialog()
            frmCrossContract.Dispose()
        Else
            frmContract.sContractID = sContractID
            If dtContractDetails IsNot Nothing Then frmContract.dtContractDetails = dtContractDetails.Copy
            frmContract.iFirstAvailableRowID = iFirstAvailableRowID
            frmContract.iSecondAvailableRowID = iSecondAvailableRowID
            frmContract.ShowDialog()
            frmContract.Dispose()
        End If
        'modify code 068,072:end-------------------------------------------------------------------------

        Me.Activate() : Me.Cursor = Cursors.Default
        Me.txbContractCode.Select() : Me.txbContractCode.SelectAll()
    End Sub

    Private Sub chbNormalRebate_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chbNormalRebate.CheckedChanged
        If blSkipDeal Then Return

        Try
            Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
            dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue"))
        Catch
            dmMinFaceValue = 1 : dmMaxFaceValue = 1000
        End Try
        If blUsedOldCard Then dmMinFaceValue = 0

        If Me.chbNormalRebate.Checked = False Then
            drSalesBill("CardQTY") = drSalesBill("NormalCardQTY")
            drSalesBill("RebateMode") = 0
            drSalesBill("RebateRuleID") = DBNull.Value
            drSalesBill("RebateRate") = DBNull.Value
            drSalesBill("RebateCardQTY") = 0
            drSalesBill("RebateSalesAMT") = 0
            drSalesBill("RebateState") = DBNull.Value
            drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
            dmAvailableRebateAMT = 0 : dmAvailableRebateRate = 0 : dmRebateSalesAMT = 0

            Me.flpNormalRebate.Visible = False
            Me.grbNormalRebate.Height = 52
            Me.splitList.Panel2Collapsed = True
            blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
            Me.NormalCardSummary()

            Me.dgvNormalCard.Select()
            Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True
        Else
            If drSalesBill("StoreID").ToString = "" Then Me.SelectStore()
            Dim sNewCityID As String = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
            If sNewCityID <> sCityID OrElse sNewestCityRuleID = "" Then Me.GetNewestCityRule(sNewCityID)
            If sNewestCityRuleID = "" Then
                blSkipDeal = True
                Me.chbNormalRebate.Checked = False : Me.btnViewCityRule.Enabled = False
                blSkipDeal = False
                Return
            ElseIf sNewestCityRuleID = "-1" Then
                MessageBox.Show("未发现当前门店所在城市的返点规则！    " & Chr(13) & Chr(13) & "必须存在城市返点规则（且通过审核），才能给予客户返点。    " & Chr(13) & Chr(13) & "请先找相关主管建立并审核城市返点规则。    ", "不能给予客户返点！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                blSkipDeal = True
                Me.chbNormalRebate.Checked = False
                Me.chbNormalRebate.Enabled = False
                Me.btnViewCityRule.Enabled = False
                blSkipDeal = False
                frmMain.statusText.Text = "未发现当前门店所在城市的返点规则！"
                Return
            End If

            Me.flpNormalRebate.Visible = True
            Me.splitList.Panel2Collapsed = False
            blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
            Me.InitNormalRebateInfo()

            If dmAvailableRebateAMT = 0 OrElse dmAvailableRebateAMT <= dmRebateSalesAMT Then
                Me.txbNormalRebateRate.Focus() : Me.txbNormalRebateRate.Select() : Me.txbNormalRebateRate.SelectAll()
            Else
                Me.dgvRebateCard.Focus() : Me.dgvRebateCard.Select() : Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.RowCount - 1).Selected = True : Me.dgvRebateCard.BeginEdit(True)
            End If
            blSkipDeal = True : Me.dgvRebateCard.CurrentRow.Selected = False : blSkipDeal = False
        End If

        If Me.splitList.Panel2Collapsed Then
            Me.grbPrintDiscount.Visible = False
        ElseIf blCanUse92Card Then
            Me.grbPrintDiscount.Visible = True
        Else
            Me.chbPrintDiscount.Checked = False
            Me.grbPrintDiscount.Visible = False
        End If
        Me.ResetInterfaceLayout()
        If Me.flpLeftContainer.VerticalScroll.Visible = True Then
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
        End If

        If Me.splitList.Panel2Collapsed AndAlso dtRebateCard.Rows.Count > 0 AndAlso dtRebateCard.Rows(0)("StartCardNo").ToString <> "" Then
            blCanRecheckCard = True
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                frmCheckCardResult.btnRecheck.Visible = True
            End If
        End If
    End Sub

    Private Sub lblNormalRebate_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblNormalRebate.Click
        If Me.chbNormalRebate.Enabled Then
            Me.chbNormalRebate.Select()
            If sTimerType <> "CustomerError" Then Me.chbNormalRebate.Checked = Not Me.chbNormalRebate.Checked
        End If
    End Sub

    Private Sub btnViewCityRule_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnViewCityRule.Click
        If sSalesBillID = "-1" Then
            If drSalesBill("StoreID").ToString = "" Then Me.SelectStore()
            Dim sNewCityID As String = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
            If sNewCityID <> sCityID OrElse sNewestCityRuleID = "" Then Me.GetNewestCityRule(sNewCityID)
            If sNewestCityRuleID = "" Then
                blSkipDeal = True
                Me.chbNormalRebate.Checked = False : Me.btnViewCityRule.Enabled = False
                blSkipDeal = False
                Return
            ElseIf sNewestCityRuleID = "-1" Then
                MessageBox.Show("未发现当前门店所在城市的返点规则！    " & Chr(13) & Chr(13) & "必须存在城市返点规则（且通过审核），才能给予客户返点。    " & Chr(13) & Chr(13) & "请先找相关主管建立并审核城市返点规则。    ", "不能给予客户返点！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                blSkipDeal = True
                Me.chbNormalRebate.Checked = False
                Me.chbNormalRebate.Enabled = False
                Me.btnViewCityRule.Enabled = False
                blSkipDeal = False
                frmMain.statusText.Text = "未发现当前门店所在城市的返点规则！"
                Return
            Else
                drCityRule = drNewestCityRule.Table.Copy.Rows(0)
                dtRuleDetails = dtNewestRuleDetails.Copy
            End If
        ElseIf drCityRule Is Nothing Then
            Me.GetCityRule()
            If drCityRule Is Nothing Then Return
        End If

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开城市返点规则……"
        frmMain.statusMain.Refresh()

        With frmViewCityRebateRule
            .iAvailableRowID = iFirstAvailableRowID
            .lblCityFullName.Text = drCityRule("CityFullName").ToString

            With .dgvValidated
                .DataSource = dtRuleDetails
                .Columns(0).Visible = False
                .Columns(1).Visible = False
                .Columns(2).Visible = False
                With .Columns(3)
                    .HeaderText = "No."
                    .Width = 40
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .Resizable = DataGridViewTriState.False
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .DefaultCellStyle.ForeColor = SystemColors.ControlText
                    .DefaultCellStyle.BackColor = SystemColors.Control
                    .DefaultCellStyle.SelectionForeColor = SystemColors.ControlText
                    .DefaultCellStyle.SelectionBackColor = SystemColors.Control
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                End With
                With .Columns(4)
                    .HeaderText = "最小金额＞" & Chr(13) & "Minimal AMT"
                    .Width = 85
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .Resizable = DataGridViewTriState.False
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                    .DefaultCellStyle.Format = "#,0.00"
                End With
                With .Columns(5)
                    .HeaderText = "最大金额≤" & Chr(13) & "Maximum AMT"
                    .Width = 85
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .Resizable = DataGridViewTriState.False
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                    .DefaultCellStyle.Format = "#,0.00"
                End With
                With .Columns(6)
                    .HeaderText = "最大返点" & Chr(13) & "Max Disc %"
                    .Width = 75
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .Resizable = DataGridViewTriState.False
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    'modify code 038:start-------------------------------------------------------------------------
                    '.DefaultCellStyle.Format = "#,0.0"
                    .DefaultCellStyle.Format = "#,0.00"
                    'modify code 038:end-------------------------------------------------------------------------
                End With
                .Columns(7).Visible = False
                With .Columns(8)
                    .HeaderText = "审核者（超过最大返点时）" & Chr(13) & "Who Validate if over Maximum Rate"
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                    .Resizable = DataGridViewTriState.False
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                End With
            End With
            .lblModifier1.Text = drCityRule("Modifier").ToString
            .lblModifiedTime1.Text = Format(drCityRule("ModifiedTime"), "yyyy\/MM\/dd HH:mm:ss")
            .lblAuditor1.Text = drCityRule("Auditor").ToString
            .lblValidatedTime1.Text = Format(drCityRule("ValidatedTime"), "yyyy\/MM\/dd HH:mm:ss")

            .ShowDialog()
            .Dispose()
        End With
        If Me.chbNormalRebate.Enabled Then
            If Me.chbNormalRebate.Checked Then
                Me.txbNormalRebateRate.Select() : Me.txbNormalRebateRate.SelectAll()
            Else
                Me.chbNormalRebate.Select()
            End If
        Else
            Me.lblNormalRebate.Select()
        End If
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub txbNormalRebateRate_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbNormalRebateRate.DoubleClick
        Me.txbNormalRebateRate.SelectAll()
    End Sub

    Private Sub txbNormalRebateRate_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbNormalRebateRate.KeyDown
        If Me.txbNormalRebateRate.ReadOnly Then Return

        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then Me.txbNormalRebateAMT.Select() : Me.txbNormalRebateAMT.SelectAll() : e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If e.KeyCode = Keys.OemPeriod OrElse e.KeyCode = Keys.Decimal Then
            If Me.txbNormalRebateRate.SelectedText.IndexOf(".") > -1 OrElse Me.txbNormalRebateRate.Text.IndexOf(".") = -1 Then Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbNormalRebateRate_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbNormalRebateRate.Validating
        If Me.txbNormalRebateRate.ReadOnly Then Return
        If Me.txbNormalRebateRate.Text <> Me.txbNormalRebateRate.Text.Trim Then Me.txbNormalRebateRate.Text = Me.txbNormalRebateRate.Text.Trim
        'modify code 038:start-------------------------------------------------------------------------
        'If Not IsNumeric(Me.txbNormalRebateRate.Text) Then Me.txbNormalRebateRate.Text = "0.0"
        'Me.txbNormalRebateRate.Text = Format(CDec(Me.txbNormalRebateRate.Text), "#,0.0")
        If Not IsNumeric(Me.txbNormalRebateRate.Text) Then Me.txbNormalRebateRate.Text = "0.00"
        Me.txbNormalRebateRate.Text = Format(CDec(Me.txbNormalRebateRate.Text), "#,0.00")
        'modify code 038:end-------------------------------------------------------------------------
        If dmAvailableRebateRate = CDec(Me.txbNormalRebateRate.Text) / 100 Then Return
        dmAvailableRebateRate = CDec(Me.txbNormalRebateRate.Text) / 100
        blCalculateNormalRebateByRate = True

        If dmAvailableRebateRate > 1 Then
            MessageBox.Show("系统规定：返点比率不能超过 20 %！请重新输入返点比率。    ", "返点比率超过 20 %！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            e.Cancel = True
            Return
        End If

        dmAvailableRebateAMT = dmNormalSalesAMT * dmAvailableRebateRate
        Me.txbNormalRebateAMT.Text = Format(dmAvailableRebateAMT, "#,0.00")
        Me.UpdateNormalRebateInfo()
    End Sub

    Private Sub txbNormalRebateAMT_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbNormalRebateAMT.DoubleClick
        Me.txbNormalRebateAMT.SelectAll()
    End Sub

    Private Sub txbNormalRebateAMT_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbNormalRebateAMT.Enter
        If Me.txbNormalRebateAMT.ReadOnly = False Then
            Me.txbNormalRebateAMT.Text = Me.txbNormalRebateAMT.Text.Replace(",", "")
        End If
    End Sub

    Private Sub txbNormalRebateAMT_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbNormalRebateAMT.KeyDown
        If Me.txbNormalRebateAMT.ReadOnly Then Return

        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.Enter Then
            If Not IsNumeric(Me.txbNormalRebateAMT.Text) OrElse CDec(Me.txbNormalRebateAMT.Text) = 0 Then
                Me.txbNormalRebateRate.Select() : Me.txbNormalRebateRate.SelectAll()
            Else
                Me.dgvRebateCard.Select() : Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.RowCount - 1).Selected = True
            End If
            e.SuppressKeyPress = True : Return
        End If
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If e.KeyCode = Keys.OemPeriod OrElse e.KeyCode = Keys.Decimal Then
            If Me.txbNormalRebateAMT.SelectedText.IndexOf(".") > -1 OrElse Me.txbNormalRebateAMT.Text.IndexOf(".") = -1 Then Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbNormalRebateAMT_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txbNormalRebateAMT.Validating
        If Me.txbNormalRebateAMT.ReadOnly Then Return
        If Me.txbNormalRebateAMT.Text <> Me.txbNormalRebateAMT.Text.Trim Then Me.txbNormalRebateAMT.Text = Me.txbNormalRebateAMT.Text.Trim
        If Not IsNumeric(Me.txbNormalRebateAMT.Text) Then Me.txbNormalRebateAMT.Text = "0.00"
        Me.txbNormalRebateAMT.Text = Format(CDec(Me.txbNormalRebateAMT.Text), "#,0.00")
        If dmAvailableRebateAMT = CDec(Me.txbNormalRebateAMT.Text) Then Return
        dmAvailableRebateAMT = CDec(Me.txbNormalRebateAMT.Text)
        blCalculateNormalRebateByRate = False

        If dmAvailableRebateAMT = 0 Then
            dmAvailableRebateRate = 0
        ElseIf dmNormalSalesAMT = 0 Then
            dmAvailableRebateRate = 1
        Else
            'modify code 038:start-------------------------------------------------------------------------
            'dmAvailableRebateRate = Int((dmAvailableRebateAMT / dmNormalSalesAMT) * 1000 + 0.5) / 1000
            dmAvailableRebateRate = Int((dmAvailableRebateAMT / dmNormalSalesAMT) * 10000 + 0.5) / 10000
            'modify code 038:end-------------------------------------------------------------------------
        End If
        If dmAvailableRebateRate > 1 Then
            MessageBox.Show("系统规定：返点比率不能超过 20 %！请重新输入返点比率。    ", "返点比率超过 20 %！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            e.Cancel = True
            Return
        End If

        'modify code 038:start-------------------------------------------------------------------------
        'Me.txbNormalRebateRate.Text = Format(dmAvailableRebateRate * 100, "#,0.0")
        Me.txbNormalRebateRate.Text = Format(dmAvailableRebateRate * 100, "#,0.00")
        'modify code 038:end-------------------------------------------------------------------------
        Me.UpdateNormalRebateInfo()
    End Sub

    Private Sub btnModifyNormalRebate_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnModifyNormalRebate.Click
        If frmMain.dtAllowedRight.Select("RightName='SalesBillRebateModify'").Length = 0 Then
            MessageBox.Show("对不起！您没有修改销售单一般返点的权限。    ", "您无权修改销售单一般返点！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.txbNormalRebateRate.Select() : Me.txbNormalRebateRate.SelectAll()
            Me.pnlModifyNormalRebate.Visible = False
            Me.flpNormalRebate.AutoSize = False
            Me.flpNormalRebate.AutoSize = True
            Me.grbNormalRebate.Height = Me.flpNormalRebate.Height + 55
            Me.ResetInterfaceLayout()
            Return
        End If

        If drCityRule Is Nothing Then
            Me.GetCityRule()
            If drCityRule Is Nothing Then Return
            Try
                Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
                dmMaxFaceValue = CDec(drCity("MaxFaceValue")) : blCanUse60Card = drCity("Use60Card") : blCanUse92Card = drCity("Use92Card") : blCanUse94Card = drCity("Use94Card") : blCanUsePaperCard = drCity("UsePaperCard")
                'modify code 051:start-------------------------------------------------------------------------
                blCanUse65Card = drCity("Use65Card")
                'modify code 051:end-------------------------------------------------------------------------
            Catch
                dmMaxFaceValue = 1000 : blCanUse60Card = False : blCanUse92Card = False : blCanUse94Card = False : blCanUsePaperCard = False
                'modify code 051:start-------------------------------------------------------------------------
                blCanUse65Card = False
                'modify code 051:end-------------------------------------------------------------------------
            End Try
        End If

        Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
        sCULCardBin = drStore("CULCardBin").ToString
        sGiftCardBin = "60" & sCULCardBin.Substring(2)
        sGiftCardBin = sGiftCardBin.Replace("|84", "|60")
        sFreeCardBin = "92" & sCULCardBin.Substring(2)
        sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
        sPaperCardBin = "86" & sCULCardBin.Substring(2)
        sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
        sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段

        Dim drRule As DataRow = Nothing
        For Each drRule In dtRuleDetails.Rows
            If drRule("EndSalesAMT").ToString <> "" AndAlso dmNormalSalesAMT > drRule("StartSalesAMT") AndAlso dmNormalSalesAMT <= drRule("EndSalesAMT") Then
                Exit For
            End If
        Next

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开销售单城市返点修改窗口……"
        frmMain.statusMain.Refresh()

        If dtActivation Is Nothing Then
            Dim DB As New DataBase()
            DB.Open()
            If DB.IsConnected Then
                Try
                    dtActivation = DB.GetDataTable("Exec GetSalesBillCardActivation " & sSalesBillID).Copy
                    If drSalesBill("SalesBillState") > 0 AndAlso drSalesBill("SalesBillState") < 4 Then
                        sActivationLoadedTime = Format(Now(), "yyyy\/MM\/dd HH:mm:ss")
                    End If
                    DB.Close()
                Catch
                    DB.Close()
                    frmMain.statusText.Text = "系统因在检索数据时出错而无法无法修改该销售单的城市返点。请联系软件开发人员。"
                    Me.Activate() : Me.Cursor = Cursors.Default : Return
                End Try
            Else
                frmMain.statusText.Text = "系统因连接不到数据库而无法修改该销售单的城市返点。请检查数据库连接。"
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If
        End If

        With frmModifyNormalRebate
            Dim dvTemp As DataView = dtActivation.Copy.DefaultView
            dvTemp.RowFilter = "(RowType Like '正常卡%') And ((CULActivatedTime Is Null) Or (CardNo Like '8%'))"
            .dtOriginalNormal = dvTemp.ToTable(False, "CardNo", "FaceValue", "RowID")
            .dtOriginalNormal.PrimaryKey = New DataColumn() {.dtOriginalNormal.Columns("CardNo")}
            .dtOriginalNormal.AcceptChanges()
            dvTemp.RowFilter = "RowType='返点卡'"
            .dtOriginalRebate = dvTemp.ToTable(False, "CardNo", "FaceValue", "RowID")
            .dtOriginalRebate.PrimaryKey = New DataColumn() {.dtOriginalRebate.Columns("CardNo")}
            .dtOriginalRebate.AcceptChanges()
            dvTemp.Dispose() : dvTemp = Nothing

            .sCULCardBin = sCULCardBin
            .sGiftCardBin = sGiftCardBin
            .sFreeCardBin = sFreeCardBin
            .sPaperCardBin = sPaperCardBin
            'modify code 050:start-------------------------------------------------------------------------
            .sSignCardBin = sSignCardBin
            'modify code 050:end-------------------------------------------------------------------------

            .dtPaperCardFaceValue = dtPaperCardFaceValue
            .blCanUse60Card = blCanUse60Card
            .blCanUse92Card = blCanUse92Card
            .blCanUse94Card = blCanUse94Card
            .blCanUsePaperCard = blCanUsePaperCard
            'modify code 051:start-------------------------------------------------------------------------
            .blCanUse65Card = blCanUse65Card
            'modify code 051:end-------------------------------------------------------------------------

            .drRule = drRule
            'modify code 050:start-------------------------------------------------------------------------
            '.dtRebateCard = dtRebateCard.DefaultView.ToTable(False, "RowID", "CardFeature", "StartCardNo", "EndCardNo", "CardQTY", "FaceValue", "ChargedAMT")
            .dtRebateCard = dtRebateCard.DefaultView.ToTable(False, "RowID", "CardFeature", "StartCardNo", "EndCardNo", "CardQTY", "FaceValue", "ChargedAMT", "HolderName", "Gender", "HolderIdNo", "Mobile")
            'modify code 050:end-------------------------------------------------------------------------
            .dtRebateCard.AcceptChanges()
            .dmMaxFaceValue = dmMaxFaceValue
            .txbNormalSalesAMT.Text = Format(dmNormalSalesAMT, "#,0.00")
            'modify code 038:start-------------------------------------------------------------------------
            '.txbMaxNormalRebateRate.Text = Format(drRule("MaxRebateRate"), "#,0.0")
            .txbMaxNormalRebateRate.Text = Format(drRule("MaxRebateRate"), "#,0.00")
            'modify code 038:end-------------------------------------------------------------------------
            .txbMaxNormalRebateAMT.Text = Format(dmNormalSalesAMT * drRule("MaxRebateRate") / 100, "#,0.00")

            'modify code 038:start-------------------------------------------------------------------------
            '.txbNormalRebateRate.Text = Format(drSalesBill("RebateRate") * 100, "#,0.0")
            .txbNormalRebateRate.Text = Format(drSalesBill("RebateRate") * 100, "#,0.00")
            'modify code 038:end-------------------------------------------------------------------------
            .txbNormalRebateAMT.Text = Format(drSalesBill("RebateSalesAMT"), "#,0.00")
            .lblNormalRebateState.Text = "没有通过审核！"
            .lblNormalRebateRemarks.Text = drSalesBill("NormalRebateRemarks").ToString
            .theTip.SetToolTip(.lblNormalRebateState, "审核： " & drSalesBill("NormalRebateAuditorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("NormalRebateValidatedTime"), "yyyy\/MM\/dd HH:mm"))
            .txbDistributionNormalRebateAMT.Text = .txbNormalRebateAMT.Text

            .grbPrintDiscount.Visible = blCanUse92Card
            .chbPrintDiscount.Checked = IIf(drSalesBill("InvoicePrintDiscount").ToString.ToLower = "false", False, True)

            If .ShowDialog() = Windows.Forms.DialogResult.OK Then
                Call LockWindowUpdate(Me.dgvRebateCard.Handle)

                dtRebateCard.Rows.Clear()
                If drSalesBill("RebateSalesAMT") = 0 Then
                    Me.lblRebateCardSummary.Text = ""
                    Me.splitList.Panel2Collapsed = True
                    Me.grbPrintDiscount.Visible = False
                Else
                    Me.lblRebateCardSummary.Text = .lblRebateCardSummary.Text.Replace("）", "  应付：0.00 元）")
                    Dim drRebate As DataRow
                    'modify code 046:start-------------------------------------------------------------------------
                    Dim DB As New DataBase()
                    DB.Open()

                    For Each dr As DataRow In .dtRebateCard.Select("CardQTY>0", "RowID")
                        drRebate = dtRebateCard.Rows.Add()
                        For bColumn As Byte = 0 To 6
                            drRebate(bColumn) = dr(bColumn)
                        Next
                        drRebate("PayableAMT") = 0
                        drRebate("ActivationState") = "等待激活"

                        If DB.IsConnected Then
                            'If dtSignCardRangeAll.Select("CardNo>='" & dr(2).ToString & "' and CardNo<='" & dr(3).ToString & "'").Length = CInt(dr(4).ToString) Then
                            'if sSignCardBin.IndexOf(dr(2).Substring(4, 5)) = -1 then
                            If DB.GetDataTable("select * from SignCardListNew where CardNo>='" & dr(2) & "' and CardNo<='" & dr(3) & "' and CardType = '实名制卡'").Rows.Count = dr(4) Then
                                drRebate("IsSignCard") = "是"
                            Else
                                drRebate("IsSignCard") = "否"
                            End If
                        End If
                        'modify code 046:end-------------------------------------------------------------------------
                    Next
                End If
                dtRebateCard.AcceptChanges()
                Me.ResetInterfaceLayout()
                Call LockWindowUpdate(0)
            End If
            .Dispose()

            If .dgvRebateCard.CurrentRow IsNot Nothing Then
                blSkipDeal = True
                .dgvRebateCard.CurrentCell.Selected = False
                .dgvRebateCard.CurrentRow.Selected = False
                blSkipDeal = False
            End If
        End With

        drRule = Nothing
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub chbPrintDiscount_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chbPrintDiscount.CheckedChanged
        If blSkipDeal OrElse sSalesBillID <> "-1" OrElse Me.grbPrintDiscount.Visible = False Then Return
        drSalesBill("InvoicePrintDiscount") = IIf(Me.chbPrintDiscount.Checked, 1, 0)
        Me.dgvRebateCard.Select()
        If Me.chbPrintDiscount.Checked Then
            If errorRebateCell IsNot Nothing Then
                Me.dgvRebateCard("RowID", errorRebateCell.RowIndex).Selected = True
                Me.menuDeleteRebateCard.PerformClick()
            End If
        Else
            For iRow As Int16 = Me.dgvRebateCard.RowCount - 1 To 0 Step -1
                If Me.dgvRebateCard("CardFeature", iRow).Value.ToString <> "" AndAlso Me.dgvRebateCard("CardFeature", iRow).Value.ToString <> "营销卡" AndAlso Me.dgvRebateCard("CardFeature", iRow).Value.ToString <> "营销券" Then
                    Me.dgvRebateCard("RowID", iRow).Selected = True
                    Me.menuDeleteRebateCard.PerformClick()
                End If
            Next
        End If
        Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.RowCount - 1).Selected = True
    End Sub

    Private Sub lblPrintDiscount_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lblPrintDiscount.Click
        If Me.chbPrintDiscount.Enabled Then
            Me.chbPrintDiscount.Select()
            If sTimerType <> "CustomerError" Then Me.chbPrintDiscount.Checked = Not Me.chbPrintDiscount.Checked
        End If
    End Sub

    Private Sub btnAddjustSalesman_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAddjustSalesman.Click
        Dim sStoreID As String = drSalesBill("StoreID").ToString, sCityID As String = frmMain.dtLoginStructure.Rows.Find(sStoreID)("ParentAreaID").ToString
        If frmMain.dvBigFish Is Nothing Then

        End If
        frmMain.dvMediumFish.RowFilter = "AreaID=" & sStoreID
        frmMain.dvBigFish.RowFilter = "AreaID=" & sCityID

        frmAdjustSalesman.currentSalesBill = drSalesBill
        If frmAdjustSalesman.ShowDialog() = Windows.Forms.DialogResult.OK Then
            Me.pnlAddjustSalesman.Visible = (frmMain.sLoginRoleID <> "14")
            Me.ResetInterfaceLayout()
            If Me.flpLeftContainer.VerticalScroll.Visible = True Then
                Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
                Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            End If
            If frmSalesBillManagement.IsHandleCreated AndAlso frmSalesBillManagement.dvSalesBill.Table.Rows.Find(sSalesBillID) IsNot Nothing Then
                Dim currentSalesBill As DataRow = frmSalesBillManagement.dvSalesBill.Table.Rows.Find(sSalesBillID)
                currentSalesBill("SalesmanID") = drSalesBill("SalesmanID")
                currentSalesBill("SalesmanName") = drSalesBill("SalesmanName").ToString
                currentSalesBill("SalesmanChanged") = 1
                currentSalesBill.AcceptChanges()
                If frmSalesBillManagement.dgvList.CurrentRow IsNot Nothing AndAlso frmSalesBillManagement.dgvList("SalesBillID", frmSalesBillManagement.dgvList.CurrentRow.Index).Value.ToString = drSalesBill("SalesBillID").ToString Then frmSalesBillManagement.btnAdjustSalesman.Enabled = False
            End If
        End If
        frmAdjustSalesman.Dispose()
    End Sub

    Private Sub lblSourceFile_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lblSourceFile.Click
        If Me.lblSourceFile.Text.IndexOf("\") = -1 Then Return

        Dim sFileName As String = Me.lblSourceFile.Text
        If Not IO.File.Exists(sFileName) Then
            MessageBox.Show("源文件已被移除，无法打开！    ", "源文件已被移除！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            With Me.lblSourceFile
                .Text = sFileName.Substring(sFileName.LastIndexOf("\") + 1)
                .Font = New Font(.Font, FontStyle.Regular)
                .ForeColor = SystemColors.ControlText
                .Cursor = Cursors.Default
            End With
            Return
        End If

        Dim excelAPP As Object = Nothing
        Try
            excelAPP = GetObject(, "Excel.Application")
        Catch
        End Try

        If excelAPP Is Nothing Then
            Try
                excelAPP = CreateObject("Excel.Application")
                excelAPP.Visible = False
            Catch ex As Exception
                If excelAPP Is Nothing Then
                    MessageBox.Show("您的电脑还未安装 Microsoft Excel。因此，您无法使用该功能。    ", "请先安装 Microsoft Excel 应用程序。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Else
                    MessageBox.Show("您电脑上的 Microsoft Excel 不能正常使用。因此，您无法使用该功能。    ", "请检查 Microsoft Excel 应用程序或重启电脑。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    excelAPP = Nothing
                End If
                Return
            End Try
        End If

        Try
            excelAPP.Windows(sFileName.Substring(sFileName.LastIndexOf("\") + 1)).Activate()
            excelAPP.Visible = False : excelAPP.Visible = True
        Catch
            Try
                excelAPP.DisplayAlerts = False
                excelAPP.Workbooks.Open(sFileName)
                excelAPP.Visible = False : excelAPP.Visible = True
                excelAPP.DisplayAlerts = True
            Catch ex As Exception
                excelAPP.Quit()
                MessageBox.Show("打开源文件时发生错误！具体的错误信息如下：    " & Chr(13) & Chr(13) & ex.Message & Space(4) & Chr(13) & Chr(13) & "请检查错误原因，然后重试。如仍有问题，请联系软件开发人员。    ", "打开源文件时发生错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            End Try
        Finally
            excelAPP = Nothing
        End Try
    End Sub

    Private Sub lblViewImportedResult_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lblViewImportedResult.Click
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开导入结果……"
        frmMain.statusMain.Refresh()

        If drImportedFile Is Nothing Then
            Dim DB As New DataBase
            DB.Open()
            If DB.IsConnected Then
                Try
                    drImportedFile = DB.GetDataTable("Select * From ImportedFileList Where SalesBillID=" & sSalesBillID).Rows(0)
                    'modify code 046:start-------------------------------------------------------------------------
                    'dtImportedDetails = DB.GetDataTable("Select * From ImportedFileDetails Where SalesBillID=" & sSalesBillID)
                    dtImportedDetails = DB.GetDataTable("Select SalesBillID,RowID,ErrorColumn,CityName,CardNo,FaceValue,SalesDate,Remarks,CardCost,HolderName,Gender,HolderIdNo,Mobile,ImportedState,StateReason From ImportedFileDetails Where SalesBillID=" & sSalesBillID)
                    'modify code 046:end-------------------------------------------------------------------------
                Catch
                    drImportedFile = Nothing
                    frmMain.statusText.Text = "打开导入结果时出现数据库内部错误！"
                End Try
            Else
                frmMain.statusText.Text = "系统因连接不到数据库而无法打开导入结果。请检查数据库连接。"
            End If
            DB.Close()
        End If

        Me.Activate() : Me.Cursor = Cursors.Default
        If drImportedFile Is Nothing Then Return
        frmMain.statusText.Text = "就绪。"

        With frmImportedFileResult
            'modify code 046:start-------------------------------------------------------------------------
            If bNewSalesBillType = 7 Then
                .isSign = True
            End If
            'modify code 046:end-------------------------------------------------------------------------
            .drImportedFile = drImportedFile
            .dtImportedDetails = dtImportedDetails.Copy
            .ShowDialog()
            .Dispose()
        End With
    End Sub

    Private Sub dgvNormalCard_CellClick(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvNormalCard.CellClick
        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" AndAlso Me.btnEmployeeNo.Text <> "" Then
            sTimerType = "EmployeeError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub dgvNormalCard_CellEndEdit(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvNormalCard.CellEndEdit
        If blSkipDeal Then Return
        blSkipDeal = True : Me.dgvNormalCard.CurrentCell.Selected = False : blSkipDeal = False
    End Sub

    Private Sub dgvNormalCard_CellEnter(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvNormalCard.CellEnter
        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" AndAlso Me.btnEmployeeNo.Text <> "" Then
            sTimerType = "EmployeeError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub dgvNormalCard_CellFormatting(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellFormattingEventArgs) Handles dgvNormalCard.CellFormatting
        '列可见
        If e.ColumnIndex > 0 AndAlso Me.dgvNormalCard.Columns(e.ColumnIndex).Visible = True Then
            'If Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "CardFeature" AndAlso Me.dgvNormalCard("CardFeature", e.RowIndex).Value.ToString <> "磁条卡" Then
            '    e.CellStyle.ForeColor = Color.Orange
            '    e.CellStyle.Font = New Font(e.CellStyle.Font, FontStyle.Bold)
            'End If
            '新建销售单
            If sSalesBillID = "-1" Then
                '设置列格式
                If Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "FaceValue" AndAlso Me.dgvNormalCard("FaceValue", e.RowIndex).ReadOnly Then
                    e.CellStyle.BackColor = Color.WhiteSmoke
                ElseIf Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "CardCost" AndAlso Me.dgvNormalCard("CardCost", e.RowIndex).ReadOnly Then
                    e.CellStyle.BackColor = Color.WhiteSmoke
                ElseIf (Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "StartCardNo" OrElse Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "EndCardNo") AndAlso Me.dgvNormalCard("ActivationState", e.RowIndex).Value.ToString = "N" Then
                    e.CellStyle.ForeColor = Color.Red
                    e.CellStyle.SelectionForeColor = Color.Red
                    If Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "EndCardNo" Then e.CellStyle.BackColor = Color.WhiteSmoke
                    Return
                ElseIf Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "PaymentDescription" Then
                    If Me.dgvNormalCard(e.ColumnIndex, e.RowIndex).Value.ToString.IndexOf("请分配付款金额") > -1 Then
                        e.CellStyle.ForeColor = Color.Green
                        e.CellStyle.BackColor = Color.PeachPuff
                        If Me.dgvNormalCard.CurrentCell IsNot Nothing AndAlso e.ColumnIndex = Me.dgvNormalCard.CurrentCell.ColumnIndex Then
                            e.CellStyle.SelectionForeColor = Color.Blue
                            e.CellStyle.SelectionBackColor = Color.PeachPuff
                        Else
                            e.CellStyle.SelectionForeColor = Color.YellowGreen
                        End If
                    ElseIf errorNormalCell IsNot Nothing AndAlso e.ColumnIndex = errorNormalCell.ColumnIndex AndAlso e.RowIndex = errorNormalCell.RowIndex Then
                        e.CellStyle.ForeColor = Color.Red
                        e.CellStyle.SelectionForeColor = Color.Red
                        e.CellStyle.BackColor = Color.PeachPuff
                        If Me.dgvNormalCard.CurrentCell IsNot Nothing AndAlso e.ColumnIndex = Me.dgvNormalCard.CurrentCell.ColumnIndex Then e.CellStyle.SelectionBackColor = Color.PeachPuff
                    ElseIf sSalesBillID = "-1" AndAlso Me.dgvNormalCard.CurrentCell IsNot Nothing AndAlso e.ColumnIndex = Me.dgvNormalCard.CurrentCell.ColumnIndex Then
                        e.CellStyle.ForeColor = SystemColors.ControlText
                        e.CellStyle.BackColor = Color.PeachPuff
                        e.CellStyle.SelectionForeColor = SystemColors.ControlText
                        e.CellStyle.SelectionBackColor = Color.PeachPuff
                    Else
                        e.CellStyle.ForeColor = SystemColors.ControlText
                        e.CellStyle.BackColor = Color.PeachPuff
                    End If
                    Return
                End If
            End If

            If Me.dgvNormalCard.CurrentRow IsNot Nothing AndAlso Me.dgvNormalCard.CurrentRow.Selected = True AndAlso e.RowIndex = Me.dgvNormalCard.CurrentRow.Index Then
                If errorNormalCell IsNot Nothing AndAlso e.ColumnIndex = errorNormalCell.ColumnIndex AndAlso e.RowIndex = errorNormalCell.RowIndex Then
                    e.CellStyle.SelectionForeColor = Color.Red
                Else
                    e.CellStyle.SelectionForeColor = SystemColors.HighlightText
                End If
                e.CellStyle.SelectionBackColor = SystemColors.Highlight
            ElseIf Me.dgvNormalCard.ReadOnly Then
                e.CellStyle.BackColor = SystemColors.Control
                If Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "ActivationState" Then
                    If Me.dgvNormalCard("ActivationState", e.RowIndex).Value.ToString = "等待激活" Then
                        e.CellStyle.ForeColor = Color.Green
                        e.CellStyle.SelectionForeColor = Color.LightGreen
                    ElseIf Me.dgvNormalCard("ActivationState", e.RowIndex).Value.ToString = "正在激活" Then
                        e.CellStyle.ForeColor = Color.SteelBlue
                        e.CellStyle.SelectionForeColor = Color.LightBlue
                    ElseIf Me.dgvNormalCard("ActivationState", e.RowIndex).Value.ToString = "部分激活" Then
                        e.CellStyle.ForeColor = Color.Chocolate
                        e.CellStyle.SelectionForeColor = Color.PeachPuff
                    ElseIf e.Value.ToString = "激活失败" OrElse e.Value.ToString = "等待取消" OrElse e.Value.ToString = "已被取消" Then
                        e.CellStyle.ForeColor = Color.Red
                        e.CellStyle.SelectionForeColor = Color.Red
                    ElseIf e.Value.ToString.IndexOf("（") > 0 Then
                        e.CellStyle.ForeColor = Color.Maroon
                        e.CellStyle.SelectionForeColor = Color.Maroon
                    End If
                ElseIf Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "StateReason" Then
                    e.CellStyle.ForeColor = Color.Red
                    e.CellStyle.SelectionForeColor = Color.Red
                End If
            Else
                If Me.dgvNormalCard.Columns(e.ColumnIndex).ReadOnly Then
                    e.CellStyle.BackColor = Color.WhiteSmoke
                ElseIf Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "FaceValue" AndAlso e.Value.ToString <> "" AndAlso e.Value = 0 Then
                    e.CellStyle.ForeColor = Color.Red
                Else
                    If errorNormalCell IsNot Nothing AndAlso e.ColumnIndex = errorNormalCell.ColumnIndex AndAlso e.RowIndex = errorNormalCell.RowIndex Then e.CellStyle.ForeColor = Color.Red
                    'modify code 046:start-------------------------------------------------------------------------
                    'If blNormalCardFaceValueErrorWhenSwitchCustomer AndAlso Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "FaceValue" AndAlso e.Value.ToString <> "" AndAlso (e.Value < dmMinFaceValue OrElse e.Value > dmMaxFaceValue) Then e.CellStyle.ForeColor = Color.Red
                    Dim maxFaceValue As Decimal = dmMaxFaceValue
                    If bNewSalesBillType = 7 Then
                        maxFaceValue = dmMaxSignCardFaceValue
                    End If
                    If blNormalCardFaceValueErrorWhenSwitchCustomer AndAlso Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "FaceValue" AndAlso e.Value.ToString <> "" AndAlso (e.Value < dmMinFaceValue OrElse e.Value > maxFaceValue) Then e.CellStyle.ForeColor = Color.Red
                    'modify code 046:end-------------------------------------------------------------------------
                End If
            End If
        End If
    End Sub

    Private Sub dgvNormalCard_CellLeave(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvNormalCard.CellLeave
        If editingTextBox IsNot Nothing AndAlso e.ColumnIndex > 0 Then
            Select Case Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name
                Case "CardQTY"
                    If editingTextBox.Text <> "" AndAlso editingTextBox.Parent IsNot Nothing AndAlso editingTextBox.Parent.Parent.Name = "dgvNormalCard" Then editingTextBox.Text = Format(CDec(editingTextBox.Text), "#,0")
                Case "FaceValue"
                    If editingTextBox.Text <> "" AndAlso editingTextBox.Parent IsNot Nothing AndAlso editingTextBox.Parent.Parent.Name = "dgvNormalCard" Then editingTextBox.Text = Format(CDec(editingTextBox.Text), "#,0.00")
            End Select
            editingTextBox = Nothing
        End If
    End Sub

    Private Sub dgvNormalCard_CellMouseUp(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellMouseEventArgs) Handles dgvNormalCard.CellMouseUp
        If Me.dgvNormalCard.ReadOnly Then Return
        'modify code 004:start-------------------------------------------------------------------------
        'If e.RowIndex = -1 Then
        '    If dmCardCost > 0 AndAlso Me.dgvNormalCard.Columns(e.ColumnIndex).Name = "CardCost" AndAlso dtNormalCard.Select("Isnull(CardFeature,'磁条卡') In ('磁条卡','礼品卡')").Length > 2 Then
        '        Dim theLocation As Point = Me.dgvNormalCard.GetColumnDisplayRectangle(e.ColumnIndex, False).Location
        '        Me.cmenuCardCost.Show(Me.dgvNormalCard.PointToScreen(New Point(theLocation.X, theLocation.Y + Me.dgvNormalCard.ColumnHeadersHeight)))
        '        theLocation = Nothing
        '    End If
        '    Return
        'End If
        'modify code 004:end-------------------------------------------------------------------------

        If e.Button = Windows.Forms.MouseButtons.Right AndAlso e.ColumnIndex = 0 AndAlso drImportedFile Is Nothing AndAlso Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString <> "" Then
            blSkipDeal = True
            Me.dgvNormalCard("ChargedAMT", e.RowIndex).Selected = True
            Me.dgvNormalCard.CurrentRow.Selected = True
            blSkipDeal = False
            Me.cmenuDeleteNormalCard.Show(Control.MousePosition)
        End If
    End Sub

    Private Sub dgvNormalCard_CellValueChanged(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvNormalCard.CellValueChanged
        If blSkipDeal Then Return
        blSkipDeal = True
        Dim sValue As String = Me.dgvNormalCard(e.ColumnIndex, e.RowIndex).Value.ToString, sFeature As String = Me.dgvNormalCard("CardFeature", e.RowIndex).Value.ToString, sNewFeature As String = "充值券", blIsPaperCard As Boolean = False
        If bNewSalesBillType = 2 Then
            If blCanUsePaperCard Then
                If sFeature = "活动券" Then
                    blIsPaperCard = True
                ElseIf sFeature = "" Then
                    sFeature = "活动卡"
                End If
            ElseIf sFeature = "" Then
                sFeature = "活动卡"
            End If
        ElseIf bNewSalesBillType = 3 Then
            If blCanUsePaperCard Then
                If sFeature = "公关券" Then
                    blIsPaperCard = True
                ElseIf sFeature = "" Then
                    sFeature = "公关卡"
                End If
            ElseIf sFeature = "" Then
                sFeature = "公关卡"
            End If
            'modify code 050:start-------------------------------------------------------------------------
        ElseIf bNewSalesBillType = 7 Then
            sFeature = "实名制卡"
            'modify code 050:end-------------------------------------------------------------------------
        ElseIf blCanUsePaperCard Then
            If sFeature = "条码卡" OrElse sFeature = "充值券" OrElse sFeature = "营销券" OrElse sFeature = "公关券" OrElse sFeature = "活动券" Then
                blIsPaperCard = True
            ElseIf sFeature = "" Then
                sFeature = "磁条卡"
            End If
        ElseIf sFeature = "" Then
            sFeature = "磁条卡"
        End If

        Call LockWindowUpdate(Me.dgvNormalCard.Handle)

        errorNormalCell = Nothing : sErrorNormalInfo = ""
        Select Case Me.dgvNormalCard.Columns(e.ColumnIndex).Name
            'modify code 004:start-------------------------------------------------------------------------
            Case "FirstBuy"
                'modify code 011:start-------------------------------------------------------------------------

                'modify code 019:start-------------------------------------------------------------------------
                If IsDBNull(Me.dgvNormalCard("FirstBuy", e.RowIndex).Value) Then Exit Select
                'modify code 019:end-------------------------------------------------------------------------

                If Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString = "购卡" Then
                    Me.dgvNormalCard("BarCode", e.RowIndex).ReadOnly = False
                    Me.dgvNormalCard("FaceValue", e.RowIndex).Value = DBNull.Value
                    Me.dgvNormalCard("ChargedAMT", e.RowIndex).Value = DBNull.Value
                    Me.dgvNormalCard("FaceValue", e.RowIndex).ReadOnly = True
                Else
                    Me.dgvNormalCard("BarCode", e.RowIndex).Value = DBNull.Value
                    Me.dgvNormalCard("BarCode", e.RowIndex).ReadOnly = True
                    Me.dgvNormalCard("FaceValue", e.RowIndex).Value = DBNull.Value
                    Me.dgvNormalCard("ChargedAMT", e.RowIndex).Value = DBNull.Value
                    Me.dgvNormalCard("FaceValue", e.RowIndex).ReadOnly = False
                End If
                'modify code 011:end-------------------------------------------------------------------------
                Me.dgvNormalCard("CardCost", e.RowIndex).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString, e.RowIndex)

                If bNewSalesBillType = 1 Then
                    Me.dgvNormalCard("CardPayment", e.RowIndex).Value = 0
                Else
                    Me.dgvNormalCard("CardPayment", e.RowIndex).Value = Me.dgvNormalCard("FaceValue", e.RowIndex).Value + Me.dgvNormalCard("CardCost", e.RowIndex).Value
                End If
                Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = Me.dgvNormalCard("CardPayment", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                Me.dgvNormalCard("CostAMT", e.RowIndex).Value = Me.dgvNormalCard("CardCost", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value

                If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then
                    For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", e.RowIndex).Value.ToString)
                        drRowPayment.Delete() : drRowPayment.AcceptChanges()
                    Next
                    Me.dgvNormalCard("PaymentDescription", e.RowIndex).Value = "请分配付款金额……"
                    If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = Me.dgvNormalCard.Columns("CardCost").Index AndAlso errorNormalCell.RowIndex = e.RowIndex Then
                        errorNormalCell = Nothing : sErrorNormalInfo = ""
                    End If
                End If
                Me.NormalCardSummary()
                'modify code 004:end-------------------------------------------------------------------------
            Case "StartCardNo"
                Me.dgvNormalCard("ActivationState", e.RowIndex).Value = DBNull.Value '清除检查是否已存在卡时可能设置的值
                If drSalesBill("StoreID").ToString = "" Then Me.SelectStore()
                sNewFeature = Me.SetInputtingCardFeature(sValue)

                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    If Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString = "" Then
                        Me.dgvNormalCard.EndEdit() : Me.dgvNormalCard("StartCardNo", e.RowIndex).Value = DBNull.Value : Me.dgvNormalCard.Refresh()
                        blSkipDeal = False : Call LockWindowUpdate(0) : Return
                    Else
                        Me.dgvNormalCard.EndEdit()
                        Me.dgvNormalCard("StartCardNo", e.RowIndex).Value = Me.dgvNormalCard("EndCardNo", e.RowIndex).Value
                        sValue = Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString
                    End If
                ElseIf sNewFeature = "" Then
                    If Me.IsValidCard(sValue) Then
                        sErrorNormalInfo = "卡类型未开通"
                        MessageBox.Show("卡类型未开通！    " & Chr(13) & Chr(13) & "请通知总部开通此卡类型。    ", "卡类型未开通！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Else
                        sErrorNormalInfo = "不可识别的卡类型"
                        MessageBox.Show("不可识别的卡类型！    " & Chr(13) & Chr(13) & "请检查卡号！    ", "不可识别的卡类型！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf bNewSalesBillType = 2 AndAlso sNewFeature <> "活动卡" AndAlso sNewFeature <> "活动券" Then
                    sErrorNormalInfo = "不是活动卡" & IIf(blCanUsePaperCard, "或活动券", "")
                    MessageBox.Show("活动卡销售单只能接受活动卡" & IIf(blCanUsePaperCard, "或活动券", "") & "！    " & Chr(13) & Chr(13) & "当前卡" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "请输入活动卡卡号" & IIf(blCanUsePaperCard, "或活动券券号", "") & "。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 3 AndAlso sNewFeature <> "公关卡" AndAlso sNewFeature <> "公关券" Then
                    sErrorNormalInfo = "不是公关卡" & IIf(blCanUsePaperCard, "或公关券", "")
                    MessageBox.Show("公关卡销售单只能接受公关卡" & IIf(blCanUsePaperCard, "或公关券", "") & "！    " & Chr(13) & Chr(13) & "当前卡" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "请输入公关卡卡号" & IIf(blCanUsePaperCard, "或公关券券号", "") & "。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 5 AndAlso sNewFeature <> "磁条卡" Then
                    sErrorNormalInfo = "不是磁条卡"
                    MessageBox.Show("联名卡销售单只能接受磁条卡！    " & Chr(13) & Chr(13) & "当前卡不是磁条卡！    " & Chr(13) & Chr(13) & "请输入磁条卡卡号。    ", "不是磁条卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 1 AndAlso blIsPaperCard Then
                    sErrorNormalInfo = sNewFeature & "不能用于退货销售单"
                    MessageBox.Show(sNewFeature & "是定额卡，不能用于退货销售单！    " & Chr(13) & Chr(13) & "退货时只能接受磁条卡（非定额卡），请输入磁条卡卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso sNewFeature <> "实名制卡" Then
                    sErrorNormalInfo = "不是实名制卡"
                    MessageBox.Show("实名制卡销售单只能接受实名制卡！    " & Chr(13) & Chr(13) & "当前卡不是实名制卡！    " & Chr(13) & Chr(13) & "请输入实名制卡卡号。    ", "不是实名制卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                    'modify code 054:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 8 AndAlso sValue.IndexOf("233665") <> 0 Then
                    sErrorNormalInfo = "不是通卖非实名卡"
                    MessageBox.Show("通卖非实名卡销售单只能接受通卖非实名卡！    " & Chr(13) & Chr(13) & "当前卡不是通卖非实名卡！    " & Chr(13) & Chr(13) & "请输入通卖非实名卡卡号。    ", "不是通卖非实名卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 0 AndAlso sValue.IndexOf("233665") = 0 Then
                    sErrorNormalInfo = "通卖非实名卡不能出现在一般销售单中"
                    MessageBox.Show("一般销售单中不能售卖通卖非实名卡！    " & Chr(13) & Chr(13) & "请输入磁条卡" & IIf(blCanUsePaperCard, "或条码卡", "") & "的卡号。    ", "通卖非实名卡不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 054:end-------------------------------------------------------------------------
                    'modify code 046,054:start-------------------------------------------------------------------------
                    '同一般销售单
                    'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 4) AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                    'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 4) AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                    'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 4) AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 4 OrElse bNewSalesBillType = 8) AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                    'modify code 046,054:end-------------------------------------------------------------------------
                    sErrorNormalInfo = sNewFeature & "只能当作返点卡使用，不能当作正常卡使用"
                    MessageBox.Show(sNewFeature & "不能出现在正常卡充值列表中！    " & Chr(13) & Chr(13) & sErrorNormalInfo & "。    " & Chr(13) & Chr(13) & "请输入除营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "之外的卡" & IIf(blCanUsePaperCard, "（券）", "") & "号。    ", sNewFeature & "不能当作正常卡使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 0 AndAlso sNewFeature <> "磁条卡" AndAlso sNewFeature <> "礼品卡" AndAlso sNewFeature <> "充值券" AndAlso sNewFeature <> "条码卡" Then
                    sErrorNormalInfo = sNewFeature & "不能出现在一般销售单中"
                    MessageBox.Show(sNewFeature & "不能出现在一般销售单中！    " & Chr(13) & Chr(13) & "请输入磁条卡" & IIf(blCanUsePaperCard, "或条码卡", "") & "的卡号。    ", sNewFeature & "不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051,054:start-------------------------------------------------------------------------
                    'ElseIf sFeature = "磁条卡" AndAlso sNewFeature = sFeature AndAlso Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso sValue.Substring(0, 5) <> Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 5) Then
                    '    sErrorNormalInfo = "84和65卡不能同时出现在同一行中"
                    '    MessageBox.Show("84和65卡不能同时出现在同一行中！    " & Chr(13) & Chr(13) & "请输入正确的磁条卡的卡号。    ", "84和65卡不能同时出现在同一行中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051,054:end-------------------------------------------------------------------------
                ElseIf sNewFeature <> sFeature Then
                    sErrorNormalInfo = sNewFeature & "不能出现在" & sFeature & "行中"
                    MessageBox.Show("当前行已被确定为" & sFeature & "行，不能容纳" & sNewFeature & "！    " & Chr(13) & Chr(13) & "请另起一行或删除该" & sFeature & "行再输入" & sNewFeature & "号。    ", sNewFeature & "不能出现在" & sFeature & "行中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf blIsPaperCard Then
                    If sValue.Length < 17 Then
                        sErrorNormalInfo = sNewFeature & "号位数不足 17 位"
                        MessageBox.Show(sNewFeature & "号错误：位数不足 17 位！    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf sPaperCardBin.IndexOf(sValue.Substring(0, 5)) = -1 Then
                        sErrorNormalInfo = sNewFeature & "的银商JV编号不符"
                        MessageBox.Show(sNewFeature & "号错误：银商JV编号不符！    " & Chr(13) & Chr(13) & sNewFeature & "号的前 5 位即为银商JV编号。    " & Chr(13) & Chr(13) & "系统设置的该店的银商JV编号是： " & sPaperCardBin & Space(4) & Chr(13) & "您输入的" & sNewFeature & "的银商JV编号是： " & sValue.Substring(0, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "银商JV编号不符！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso sValue.Substring(0, 8) <> Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 8) Then
                        sErrorNormalInfo = sNewFeature & "的开始" & sNewFeature.Substring(2, 1) & "号与结束" & sNewFeature.Substring(2, 1) & "号的券类型不一致"
                        MessageBox.Show("同一行" & sNewFeature & "的开始" & sNewFeature.Substring(2, 1) & "号与结束" & sNewFeature.Substring(2, 1) & "号的券类型必须一致！    " & Chr(13) & Chr(13) & "（" & sNewFeature & "号的前 8 位即为券类型。）    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "券类型不一致！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvNormalCard("FaceValue", e.RowIndex).Value.ToString = "" AndAlso dtPaperCardFaceValue.Rows.Find(sValue.Substring(0, 8)) Is Nothing Then
                        sErrorNormalInfo = "券类型不存在"
                        MessageBox.Show("当前" & sNewFeature & "的券类型""" & sValue.Substring(0, 8) & """不存在！    " & Chr(13) & Chr(13) & "（" & sNewFeature & "号的前 8 位即为券类型。）    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "券类型不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso Math.Abs(CLng(Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString) - CLng(sValue)) + 1 > 100000 Then
                        sErrorNormalInfo = "该行" & sNewFeature & "数量超过 100,000 张"
                        MessageBox.Show("每行的" & sNewFeature & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf sValue.Length < 19 Then
                    sErrorNormalInfo = "卡号位数不足 19 位"
                    'modify code 051:start-------------------------------------------------------------------------
                    'MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                    'modify code 040,044,050:start-------------------------------------------------------------------------
                ElseIf dtSignCardRangeOld.Select("CardNo='" & sValue & "'").Length = 1 Then
                    sErrorNormalInfo = "旧实名制卡无法继续使用，请更换新实名制卡"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号或更换新实名制卡。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 7 AndAlso sSignCardBin.IndexOf(sValue.Substring(4, 5)) = -1 Then
                    sErrorNormalInfo = "实名制卡银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 6 AndAlso strSelectedBuyChannel = "Cul" _
                    AndAlso ((sNewFeature = "磁条卡" AndAlso sCULCardBin.IndexOf(sValue.Substring(4, 5)) = -1) _
                             OrElse (sNewFeature = "礼品卡" AndAlso sGiftCardBin.IndexOf(sValue.Substring(4, 5)) = -1)) Then
                    sErrorNormalInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "线下提卡为" & IIf(sCULCardBin = "", "礼品卡", "实体卡") & "    " & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 040,044:end-------------------------------------------------------------------------
                ElseIf (sNewFeature = "磁条卡" AndAlso sCULCardBin.IndexOf(sValue.Substring(4, 5)) = -1) OrElse (sNewFeature = "礼品卡" AndAlso sGiftCardBin.IndexOf(sValue.Substring(4, 5)) = -1) Then
                    'modify code 051:start-------------------------------------------------------------------------
                    'sErrorNormalInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码不符"
                    'MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, sGiftCardBin) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorNormalInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, sGiftCardBin) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                ElseIf sValue <> ShoppingCardNo.GetFullCardNo(sValue.Substring(0, 18)) Then
                    sErrorNormalInfo = "卡号校验码错误"
                    'modify code 051:start-------------------------------------------------------------------------
                    'MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                ElseIf Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso Math.Abs(CLng(Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) - CLng(sValue.Substring(0, 18))) + 1 > 100000 Then
                    'modify code 051:start-------------------------------------------------------------------------
                    'sErrorNormalInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    'MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorNormalInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso _
                    dtSignCardRangeNew.Select("CardNo >='" & sValue & "' and CardNo <='" & Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString & "'").Length > 0 AndAlso _
                    dtSignCardRangeNew.Select("CardNo >='" & sValue & "' and CardNo <='" & Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString & "'").Length <> CLng(sValue.Substring(0, 18)) - CLng(Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + 1 Then
                    sErrorNormalInfo = "新卡售卖和旧卡充值请分行操作"
                    MessageBox.Show("新卡售卖和旧卡充值请分行操作！    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                End If

                If sErrorNormalInfo = "" Then
                    Dim blGotoEndCardColumn As Boolean = False
                    If blIsPaperCard Then
                        If Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString = "" Then
                            Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = sValue
                            blGotoEndCardColumn = True
                        End If
                        If Me.dgvNormalCard("FaceValue", e.RowIndex).Value.ToString = "" Then
                            Me.dgvNormalCard("FaceValue", e.RowIndex).Value = dtPaperCardFaceValue.Rows.Find(sValue.Substring(0, 8))("FaceValue")
                            'modify code 007,046,054,072:start-------------------------------------------------------------------------
                            '同一般销售单
                            'If bNewSalesBillType = 0 Then
                            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 Then
                            If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                                blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                            End If
                            'modify code 007,046,054,072:end-------------------------------------------------------------------------
                            'modify code 004:start-------------------------------------------------------------------------
                            '输入开始卡号时,默认[购卡]，需要每行分别设置，不能设置数据源
                            'modify code 050:start-------------------------------------------------------------------------
                            If bNewSalesBillType <> 7 Then
                                Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, e.RowIndex)
                            End If
                            'modify code 050:end-------------------------------------------------------------------------
                            'Me.dgvNormalCard("CardCost", e.RowIndex).Value = 0
                            Me.dgvNormalCard("CardCost", e.RowIndex).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString, e.RowIndex)
                            'modify code 004:end-------------------------------------------------------------------------
                        End If

                        Me.ConfigNormalPaperCardRow()
                        If drSalesBill("RebateCardQTY") > 0 AndAlso Me.CheckPaperCardExisting(False, Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString) Then
                            Call LockWindowUpdate(0)
                            errorNormalCell = Me.dgvNormalCard("StartCardNo", e.RowIndex)
                            sErrorNormalInfo = "同一张" & sNewFeature & "不能同时既是正常卡又是返点卡"
                            MessageBox.Show(sNewFeature & "是定额卡，只能被激活一次，所以不能既当作正常卡使用又当作返点卡使用！    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "同一张" & sNewFeature & "不能同时既是正常卡又是返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            frmMain.statusText.Text = "开始" & sNewFeature.Substring(2, 1) & "号错误（" & sErrorNormalInfo & "）！请重新输入开始" & sNewFeature.Substring(2, 1) & "号。"
                            Me.dgvNormalCard.Select() : Me.dgvNormalCard("EndCardNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                        ElseIf blGotoEndCardColumn Then
                            Me.dgvNormalCard("EndCardNo", Me.dgvNormalCard.CurrentRow.Index).Selected = True
                        End If
                    Else
                        If Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString = "" OrElse blUsedOldCard Then
                            Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = sValue
                            blGotoEndCardColumn = True
                        End If
                        If bNewSalesBillType <> 1 AndAlso Me.dgvNormalCard("FaceValue", e.RowIndex).Value.ToString = "" AndAlso frmMain.dvCardFaceValue IsNot Nothing Then
                            frmMain.dvCardFaceValue.RowFilter = "'" & sValue & "'>=StartCardNo And '" & sValue & "'<=EndCardNo"
                            If frmMain.dvCardFaceValue.Count = 1 Then Me.dgvNormalCard("FaceValue", e.RowIndex).Value = frmMain.dvCardFaceValue(0)("FaceValue")
                        End If
                        If Me.dgvNormalCard("FaceValue", e.RowIndex).Value.ToString = "" AndAlso dtNormalCard.Select("'" & sValue & "'>=StartCardNo And '" & sValue & "'<=EndCardNo").Length > 0 Then
                            Try
                                Me.dgvNormalCard("FaceValue", e.RowIndex).Value = dtNormalCard.Select("'" & sValue & "'>=StartCardNo And '" & sValue & "'<=EndCardNo")(0)("FaceValue")
                            Catch
                            End Try
                        End If
                        'modify code 004:start-------------------------------------------------------------------------
                        '输入开始卡号时,默认[购卡]，需要每行分别设置，不能设置数据源
                        'modify code 050:start-------------------------------------------------------------------------
                        If bNewSalesBillType <> 7 Then
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, e.RowIndex)
                        End If
                        'modify code 050:end-------------------------------------------------------------------------
                        '设置卡成本,需要每行分别设置卡成本下拉框，不能给列设置数据源
                        If Me.dgvNormalCard("CardCost", e.RowIndex).Value.ToString = "" Then
                            'Dim dmCost As Decimal = dtCardCost.Rows(0)("CardCost")
                            'If dmCost > 0 Then
                            '    For iRow As Integer = e.RowIndex - 1 To 0 Step -1
                            '        If "|磁条卡|礼品卡|".IndexOf("|" & Me.dgvNormalCard("CardFeature", iRow).Value.ToString & "|") > -1 Then
                            '            dmCost = Me.dgvNormalCard("CardCost", iRow).Value
                            '            Exit For
                            '        End If
                            '    Next
                            'End If
                            'Me.dgvNormalCard("CardCost", e.RowIndex).Value = dmCost
                            Me.dgvNormalCard("CardCost", e.RowIndex).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString, e.RowIndex)
                        End If
                        'modify code 004:end-------------------------------------------------------------------------

                        Me.ConfigNormalCardRow()
                        If blGotoEndCardColumn Then
                            'modify code 046,054,072:start-------------------------------------------------------------------------
                            '同一般销售单
                            'If bNewSalesBillType = 0 AndAlso blUsedOldCard Then
                            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso blUsedOldCard Then
                            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso blUsedOldCard Then
                                'modify code 046,054,072:end-------------------------------------------------------------------------
                                Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Selected = True
                            Else
                                Me.dgvNormalCard("EndCardNo", Me.dgvNormalCard.CurrentRow.Index).Selected = True
                            End If
                        End If
                    End If
                    'modify code 050:start-------------------------------------------------------------------------
                    If bNewSalesBillType = 7 Then
                        If dtSignCardRangeNew.Select("CardNo ='" & sValue & "'").Length = 1 Then
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy("", e.RowIndex, "充值")
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("CardCost", e.RowIndex).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString, e.RowIndex)
                            Me.dgvNormalCard("CardCost", e.RowIndex).ReadOnly = True

                            Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value = ""
                            Me.dgvNormalCard("HolderName", e.RowIndex).Value = ""
                            Me.dgvNormalCard("Mobile", e.RowIndex).Value = ""
                            Me.dgvNormalCard("Gender", e.RowIndex).Value = ""

                            Me.dgvNormalCard("HolderIdNo", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("HolderName", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("Mobile", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("Gender", e.RowIndex).ReadOnly = True
                        Else
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy("", e.RowIndex, "购卡")
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("CardCost", e.RowIndex).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString, e.RowIndex)
                            Me.dgvNormalCard("CardCost", e.RowIndex).ReadOnly = False

                            Me.dgvNormalCard("HolderIdNo", e.RowIndex).ReadOnly = False
                            Me.dgvNormalCard("HolderName", e.RowIndex).ReadOnly = False
                            Me.dgvNormalCard("Mobile", e.RowIndex).ReadOnly = False
                            Me.dgvNormalCard("Gender", e.RowIndex).ReadOnly = False
                        End If
                    End If
                    'modify code 050:end-------------------------------------------------------------------------
                Else
                    errorNormalCell = Me.dgvNormalCard("StartCardNo", e.RowIndex)
                    If sNewFeature = "" Then sNewFeature = "磁条卡"
                    If sNewFeature = "实名制卡" Then
                        frmMain.statusText.Text = "开始卡号错误（" & sErrorNormalInfo & "）！请重新输入开始卡号。"
                    Else
                        frmMain.statusText.Text = "开始" & sNewFeature.Substring(2, 1) & "号错误（" & sErrorNormalInfo & "）！请重新输入开始" & sNewFeature.Substring(2, 1) & "号。"
                    End If
					Me.dgvNormalCard.Select() : Me.dgvNormalCard("EndCardNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                End If
            Case "EndCardNo"
                sNewFeature = Me.SetInputtingCardFeature(sValue)

                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    If Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString <> "" Then
                        Me.dgvNormalCard.EndEdit()
                        Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = Me.dgvNormalCard("StartCardNo", e.RowIndex).Value
                        sValue = Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString
                    Else
                        Me.dgvNormalCard.EndEdit() : Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = DBNull.Value
                        blSkipDeal = False : Call LockWindowUpdate(0) : Return
                    End If
                ElseIf sNewFeature = "" Then
                    If Me.IsValidCard(sValue) Then
                        sErrorNormalInfo = "卡类型未开通"
                        MessageBox.Show("卡类型未开通！    " & Chr(13) & Chr(13) & "请通知总部开通此卡类型。    ", "卡类型未开通！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Else
                        sErrorNormalInfo = "不可识别的卡类型"
                        MessageBox.Show("不可识别的卡类型！    " & Chr(13) & Chr(13) & "请检查卡号！    ", "不可识别的卡类型！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf bNewSalesBillType = 2 AndAlso sNewFeature <> "活动卡" AndAlso sNewFeature <> "活动券" Then
                    sErrorNormalInfo = "不是活动卡" & IIf(blCanUsePaperCard, "或活动券", "")
                    MessageBox.Show("活动卡销售单只能接受活动卡" & IIf(blCanUsePaperCard, "或活动券", "") & "！    " & Chr(13) & Chr(13) & "当前卡" & sErrorNormalInfo & "！请输入该类型的卡号" & IIf(blCanUsePaperCard, "或券号", "") & "。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 3 AndAlso sNewFeature <> "公关卡" AndAlso sNewFeature <> "公关券" Then
                    sErrorNormalInfo = "不是公关卡" & IIf(blCanUsePaperCard, "或公关券", "")
                    MessageBox.Show("公关卡销售单只能接受公关卡" & IIf(blCanUsePaperCard, "或公关券", "") & "！    " & Chr(13) & Chr(13) & "当前卡" & sErrorNormalInfo & "！请输入该类型的卡号" & IIf(blCanUsePaperCard, "或券号", "") & "。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 5 AndAlso sNewFeature <> "磁条卡" Then
                    sErrorNormalInfo = "不是磁条卡"
                    MessageBox.Show("联名卡销售单只能接受磁条卡！    " & Chr(13) & Chr(13) & "当前卡不是磁条卡！    " & Chr(13) & Chr(13) & "请输入磁条卡卡号。    ", "不是磁条卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso sNewFeature <> "实名制卡" Then
                    sErrorNormalInfo = "不是实名制卡"
                    MessageBox.Show("实名制卡销售单只能接受实名制卡！    " & Chr(13) & Chr(13) & "当前卡不是实名制卡！    " & Chr(13) & Chr(13) & "请输入实名制卡卡号。    ", "不是实名制卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                    'modify code 054:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 8 AndAlso sValue.IndexOf("233665") <> 0 Then
                    sErrorNormalInfo = "不是通卖非实名卡"
                    MessageBox.Show("通卖非实名卡销售单只能接受通卖非实名卡！    " & Chr(13) & Chr(13) & "当前卡不是通卖非实名卡！    " & Chr(13) & Chr(13) & "请输入通卖非实名卡卡号。    ", "不是通卖非实名卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 0 AndAlso sValue.IndexOf("233665") = 0 Then
                    sErrorNormalInfo = "通卖非实名卡不能出现在一般销售单中"
                    MessageBox.Show("一般销售单中不能售卖通卖非实名卡！    " & Chr(13) & Chr(13) & "请输入磁条卡" & IIf(blCanUsePaperCard, "或条码卡", "") & "的卡号。    ", "通卖非实名卡不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 054:end-------------------------------------------------------------------------
                    'modify code 046,054:start-------------------------------------------------------------------------
                    '同一般销售单
                    'ElseIf bNewSalesBillType = 0 AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                    'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso (sNewFeature = "营销卡" OrElse sNewFeature = "营销券") Then
                    'modify code 046,054:end-------------------------------------------------------------------------
                    sErrorNormalInfo = sNewFeature & "只能当作返点卡使用，不能当作正常卡使用"
                    MessageBox.Show(sNewFeature & "不能出现在正常卡充值列表中！    " & Chr(13) & Chr(13) & sErrorNormalInfo & "    " & Chr(13) & Chr(13) & "请输入除营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "之外的卡" & IIf(blCanUsePaperCard, "（券）", "") & "号。    ", sNewFeature & "不能当作正常卡使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 0 AndAlso sNewFeature <> "磁条卡" AndAlso sNewFeature <> "礼品卡" AndAlso sNewFeature <> "充值券" AndAlso sNewFeature <> "条码卡" Then
                    sErrorNormalInfo = sNewFeature & "不能出现在一般销售单中"
                    MessageBox.Show(sNewFeature & "不能出现在一般销售单中！    " & Chr(13) & Chr(13) & "请输入磁条卡" & IIf(blCanUsePaperCard, "或条码卡", "") & "的卡号。    ", sNewFeature & "不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf dtSignCardRangeOld.Select("CardNo='" & sValue & "'").Length = 1 Then
                    sErrorNormalInfo = "旧实名制卡无法继续使用，请更换新实名制卡"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号或更换新实名制卡。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 7 AndAlso sSignCardBin.IndexOf(sValue.Substring(4, 5)) = -1 Then
                    sErrorNormalInfo = "实名制卡银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                    'modify code 051,054:start-------------------------------------------------------------------------
                    'ElseIf sFeature = "磁条卡" AndAlso sNewFeature = sFeature AndAlso sValue.Substring(0, 5) <> Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 5) Then
                    '    sErrorNormalInfo = "84和65卡不能同时出现在同一行中"
                    '    MessageBox.Show("84和65卡不能同时出现在同一行中！    " & Chr(13) & Chr(13) & "请输入正确的磁条卡的卡号。    ", "84和65卡不能同时出现在同一行中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051,054:end-------------------------------------------------------------------------
                ElseIf sNewFeature <> sFeature Then
                    sErrorNormalInfo = sNewFeature & "不能出现在" & sFeature & "行中"
                    MessageBox.Show("当前行已被确定为" & sFeature & "行，不能容纳" & sNewFeature & "！    " & Chr(13) & Chr(13) & "请另起一行或删除该" & sFeature & "行再输入" & sNewFeature & "号。    ", sNewFeature & "不能出现在" & sFeature & "行中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf blIsPaperCard Then
                    If sValue.Length < 17 Then
                        sErrorNormalInfo = sNewFeature & "号位数不足 17 位"
                        MessageBox.Show(sNewFeature & "号错误：位数不足 17 位！    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf sPaperCardBin.IndexOf(sValue.Substring(0, 5)) = -1 Then
                        sErrorNormalInfo = sNewFeature & "的银商JV编号不符"
                        MessageBox.Show(sNewFeature & "号错误：银商JV编号不符！    " & Chr(13) & Chr(13) & sNewFeature & "号的前 5 位即为银商JV编号。    " & Chr(13) & Chr(13) & "系统设置的该店的银商JV编号是： " & sPaperCardBin & Space(4) & Chr(13) & "您输入的" & sNewFeature & "的银商JV编号是： " & sValue.Substring(0, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "银商JV编号不符！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf sValue.Substring(0, 8) <> Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 8) Then
                        sErrorNormalInfo = sNewFeature & "的结束" & sNewFeature.Substring(2, 1) & "号与开始" & sNewFeature.Substring(2, 1) & "号的券类型不一致"
                        MessageBox.Show("同一行" & sNewFeature & "的结束" & sNewFeature.Substring(2, 1) & "号与开始" & sNewFeature.Substring(2, 1) & "号的券类型必须一致！    " & Chr(13) & Chr(13) & "（" & sNewFeature & "号的前 8 位即为券类型。）    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "券类型不一致！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Math.Abs(CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString) - CLng(sValue)) + 1 > 100000 Then
                        sErrorNormalInfo = "该行" & sNewFeature & "数量超过 100,000 张"
                        MessageBox.Show("每行的" & sNewFeature & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf sValue.Length < 19 Then
                    sErrorNormalInfo = "卡号位数不足 19 位"
                    'modify code 051:start-------------------------------------------------------------------------
                    'MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf (sNewFeature = "磁条卡" AndAlso sCULCardBin.IndexOf(sValue.Substring(4, 5)) = -1) OrElse (sNewFeature = "礼品卡" AndAlso sGiftCardBin.IndexOf(sValue.Substring(4, 5)) = -1) Then
                    'sErrorNormalInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码不符"
                    'MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, sGiftCardBin) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorNormalInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorNormalInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, sGiftCardBin) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf sValue <> ShoppingCardNo.GetFullCardNo(sValue.Substring(0, 18)) Then
                    sErrorNormalInfo = "卡号校验码错误"
                    'MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf Math.Abs(CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) - CLng(sValue.Substring(0, 18))) + 1 > 100000 Then
                    'sErrorNormalInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    'MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorNormalInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso _
                    dtSignCardRangeNew.Select("CardNo <='" & sValue & "' and CardNo >='" & Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString & "'").Length > 0 AndAlso _
                    dtSignCardRangeNew.Select("CardNo <='" & sValue & "' and CardNo >='" & Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString & "'").Length <> CLng(sValue.Substring(0, 18)) - CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + 1 Then
                    sErrorNormalInfo = "新卡售卖和旧卡充值请分行操作"
                    MessageBox.Show("新卡售卖和旧卡充值请分行操作！    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                End If

                If sErrorNormalInfo = "" Then
                    If blIsPaperCard Then
                        Me.ConfigNormalPaperCardRow()
                        If drSalesBill("RebateCardQTY") > 0 AndAlso Me.CheckPaperCardExisting(False, Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString) Then
                            Call LockWindowUpdate(0)
                            errorNormalCell = Me.dgvNormalCard("EndCardNo", e.RowIndex)
                            sErrorNormalInfo = "同一张" & sNewFeature & "不能同时既是正常卡又是返点卡"
                            MessageBox.Show(sNewFeature & "是定额卡，只能被激活一次，所以不能既当作正常卡使用又当作返点卡使用！    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "同一张" & sNewFeature & "不能同时既是正常卡又是返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            frmMain.statusText.Text = "结束" & sNewFeature.Substring(2, 1) & "号错误（" & sErrorNormalInfo & "）！请重新输入结束" & sNewFeature.Substring(2, 1) & "号。"
                            Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                        End If
                    Else
                        Me.ConfigNormalCardRow()
                    End If

                    'modify code 050:start-------------------------------------------------------------------------
                    If bNewSalesBillType = 7 Then
                        If dtSignCardRangeNew.Select("CardNo ='" & Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString & "'").Length = 1 Then
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy("", e.RowIndex, "充值")
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("CardCost", e.RowIndex).ReadOnly = True

                            Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value = ""
                            Me.dgvNormalCard("HolderName", e.RowIndex).Value = ""
                            Me.dgvNormalCard("Mobile", e.RowIndex).Value = ""
                            Me.dgvNormalCard("Gender", e.RowIndex).Value = ""

                            Me.dgvNormalCard("HolderIdNo", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("HolderName", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("Mobile", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("Gender", e.RowIndex).ReadOnly = True
                        Else
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy("", e.RowIndex, "购卡")
                            Me.dgvNormalCard("FirstBuy", e.RowIndex).ReadOnly = True
                            Me.dgvNormalCard("CardCost", e.RowIndex).ReadOnly = False

                            Me.dgvNormalCard("HolderIdNo", e.RowIndex).ReadOnly = False
                            Me.dgvNormalCard("HolderName", e.RowIndex).ReadOnly = False
                            Me.dgvNormalCard("Mobile", e.RowIndex).ReadOnly = False
                            Me.dgvNormalCard("Gender", e.RowIndex).ReadOnly = False
                        End If
                    End If
                    'modify code 050:end-------------------------------------------------------------------------
                Else
                    errorNormalCell = Me.dgvNormalCard("EndCardNo", e.RowIndex)
                    If sNewFeature = "" Then sNewFeature = "磁条卡"
                    frmMain.statusText.Text = "结束" & sNewFeature.Substring(2, 1) & "号错误（" & sErrorNormalInfo & "）！请重新输入结束" & sNewFeature.Substring(2, 1) & "号。"
                    Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                End If
            Case "CardQTY"
                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    Me.dgvNormalCard.EndEdit()
                    If blIsPaperCard Then
                        Me.dgvNormalCard("CardQTY", e.RowIndex).Value = CLng(Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString) - CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString) + 1
                    Else
                        Me.dgvNormalCard("CardQTY", e.RowIndex).Value = CLng(Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) - CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + 1
                    End If
                ElseIf CLng(sValue) > 100000 Then
                    'modify code 051:start-------------------------------------------------------------------------
                    'sErrorNormalInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量超过 100,000 张"
                    'MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量不能超过 100,000 张！" & Space(4) & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'frmMain.statusText.Text = "每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量不能超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量。"
                    sErrorNormalInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量超过 100,000 张"
                    MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量不能超过 100,000 张！" & Space(4) & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量不能超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量。"
                    'modify code 051:end-------------------------------------------------------------------------
                    errorNormalCell = Me.dgvNormalCard("CardQTY", e.RowIndex)
                    Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                ElseIf CInt(sValue) < 2 Then
                    blSkipDeal = False
                    Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = Me.dgvNormalCard("StartCardNo", e.RowIndex).Value
                    Me.dgvNormalCard("CardQTY", e.RowIndex).Value = 1
                Else
                    blSkipDeal = False
                    If blIsPaperCard Then
                        Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = (CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString) + CInt(sValue) - 1).ToString
                    Else
                        Me.dgvNormalCard("EndCardNo", e.RowIndex).Value = ShoppingCardNo.GetFullCardNo((CLng(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + CInt(sValue) - 1).ToString)
                    End If
                End If
                'modify code 011:start-------------------------------------------------------------------------
            Case "BarCode"
                '条码13位
                Me.dgvNormalCard("FaceValue", e.RowIndex).Value = DBNull.Value

                Me.dgvNormalCard("ChargedAMT", e.RowIndex).Value = DBNull.Value
                Me.dgvNormalCard("ReducedCardPayment", e.RowIndex).Value = DBNull.Value
                Me.dgvNormalCard("CardPayment", e.RowIndex).Value = DBNull.Value
                Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = DBNull.Value
                Me.dgvNormalCard("CostAMT", e.RowIndex).Value = DBNull.Value
                Me.dgvNormalCard("PaymentDescription", e.RowIndex).Value = DBNull.Value
                For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", e.RowIndex).Value.ToString)
                    drRowPayment.Delete() : drRowPayment.AcceptChanges()
                Next

                If Me.dgvNormalCard("Barcode", e.RowIndex).Value.ToString.Length = 13 Then
                    For Each drBarcodeFaceValue As DataRow In dtBarcodeFaceValue.Select("Barcode = '" & Me.dgvNormalCard("BarCode", e.RowIndex).Value.ToString & "'")
                        Me.dgvNormalCard("FaceValue", e.RowIndex).Value = drBarcodeFaceValue("FaceValue")

                        Me.dgvNormalCard("ChargedAMT", e.RowIndex).Value = Me.dgvNormalCard("FaceValue", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                        Me.dgvNormalCard("ReducedCardPayment", e.RowIndex).Value = 0

                        If bNewSalesBillType = 1 Then
                            Me.dgvNormalCard("CardPayment", e.RowIndex).Value = 0
                            Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = 0
                            Me.dgvNormalCard("CostAMT", e.RowIndex).Value = 0
                        Else
                            Me.dgvNormalCard("CardPayment", e.RowIndex).Value = Me.dgvNormalCard("FaceValue", e.RowIndex).Value + Me.dgvNormalCard("CardCost", e.RowIndex).Value
                            Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = Me.dgvNormalCard("CardPayment", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                            Me.dgvNormalCard("CostAMT", e.RowIndex).Value = Me.dgvNormalCard("CardCost", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                        End If
                        If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then
                            For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", e.RowIndex).Value.ToString)
                                drRowPayment.Delete() : drRowPayment.AcceptChanges()
                            Next
                            Me.dgvNormalCard("PaymentDescription", e.RowIndex).Value = "请分配付款金额……"
                            If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = e.ColumnIndex AndAlso errorNormalCell.RowIndex = e.RowIndex Then
                                errorNormalCell = Nothing : sErrorNormalInfo = ""
                            End If
                        End If
                    Next
                End If

                Me.NormalCardSummary()

                If Me.dgvNormalCard("FaceValue", e.RowIndex).Value.ToString = "" Then
                    MessageBox.Show("提示：" & Chr(13) & Chr(13) & "条码输入不正确，请重新输入。", "条码输入不正确！", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                End If

                'modify code 011:end-------------------------------------------------------------------------
            Case "FaceValue"
                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    If frmMain.dvCardFaceValue IsNot Nothing Then
                        sValue = Me.dgvNormalCard("EndCardNo", e.RowIndex).Value.ToString
                        frmMain.dvCardFaceValue.RowFilter = "'" & sValue & "'>=StartCardNo And '" & sValue & "'<=EndCardNo"
                        If frmMain.dvCardFaceValue.Count = 1 Then sValue = Format(frmMain.dvCardFaceValue(0)("FaceValue"), "0.00") Else sValue = ""
                    Else
                        sValue = ""
                    End If
                    Me.dgvNormalCard.EndEdit()
                    If sValue = "" Then
                        Me.dgvNormalCard("FaceValue", e.RowIndex).Value = DBNull.Value
                    Else
                        Me.dgvNormalCard("FaceValue", e.RowIndex).Value = CDec(sValue)
                    End If
                End If

                'modify code 046:start-------------------------------------------------------------------------
                'modify code 050:start-------------------------------------------------------------------------
                Dim maxFaceValue As Decimal = dmMaxFaceValue
                If bNewSalesBillType = 7 Then
                    maxFaceValue = dmMaxSignCardFaceValue
                End If
                'modify code 050:end-------------------------------------------------------------------------
                If sValue = "" Then

                ElseIf CDec(sValue) < 100 AndAlso CDec(sValue) >= dmMinFaceValue AndAlso bNewSalesBillType <> 1 Then
                    MessageBox.Show("提示：" & Chr(13) & Chr(13) & "如果是新卡，请确保面值介于 100 元 与 " & Format(maxFaceValue, "#,0.00").Replace(".00", "") & " 元之间！    ", "新卡时面值不能低于 100 元！", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                    Me.dgvNormalCard.Select()
                    Me.dgvNormalCard.BeginEdit(True)
                ElseIf dmMinFaceValue + maxFaceValue > 0 AndAlso (CDec(sValue) < dmMinFaceValue OrElse CDec(sValue) > maxFaceValue) Then
                    sErrorNormalInfo = "卡片面值应该介于 " & Format(dmMinFaceValue, "#,0.00").Replace(".00", "") & " 元 与 " & Format(maxFaceValue, "#,0.00").Replace(".00", "") & " 元之间"
                ElseIf CDec(sValue) = 0 Then
                    sErrorNormalInfo = "卡片面值不能为零"
                End If
                'modify code 046:end-------------------------------------------------------------------------

                If sErrorNormalInfo = "" Then
                    If sValue = "" Then
                        Me.dgvNormalCard("ChargedAMT", e.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("ReducedCardPayment", e.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("CardPayment", e.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("CostAMT", e.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("PaymentDescription", e.RowIndex).Value = DBNull.Value
                        For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", e.RowIndex).Value.ToString)
                            drRowPayment.Delete() : drRowPayment.AcceptChanges()
                        Next
                    Else
                        Me.dgvNormalCard("ChargedAMT", e.RowIndex).Value = Me.dgvNormalCard("FaceValue", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                        Me.dgvNormalCard("ReducedCardPayment", e.RowIndex).Value = 0
                        If bNewSalesBillType = 1 Then
                            Me.dgvNormalCard("CardPayment", e.RowIndex).Value = 0
                            Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = 0
                            Me.dgvNormalCard("CostAMT", e.RowIndex).Value = 0
                        Else
                            Me.dgvNormalCard("CardPayment", e.RowIndex).Value = Me.dgvNormalCard("FaceValue", e.RowIndex).Value + Me.dgvNormalCard("CardCost", e.RowIndex).Value
                            Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = Me.dgvNormalCard("CardPayment", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                            Me.dgvNormalCard("CostAMT", e.RowIndex).Value = Me.dgvNormalCard("CardCost", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                        End If
                        If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then
                            For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", e.RowIndex).Value.ToString)
                                drRowPayment.Delete() : drRowPayment.AcceptChanges()
                            Next
                            Me.dgvNormalCard("PaymentDescription", e.RowIndex).Value = "请分配付款金额……"
                            If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = e.ColumnIndex AndAlso errorNormalCell.RowIndex = e.RowIndex Then
                                errorNormalCell = Nothing : sErrorNormalInfo = ""
                            End If
                        End If
                        'modify code 050:start-------------------------------------------------------------------------
                        If isSignCard Then
                            If dtSignCardRangeNew.Select("CardNo ='" & Me.dgvNormalCard("StartCardNo", e.RowIndex).Value & "'").Length = 1 Then
                                Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = SetFirstBuy("", e.RowIndex, "充值")
                                Me.dgvNormalCard("FirstBuy", e.RowIndex).ReadOnly = True
                                Me.dgvNormalCard("CardCost", e.RowIndex).ReadOnly = True

                                Me.dgvNormalCard("CardCost", e.RowIndex).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvNormalCard("FirstBuy", e.RowIndex).Value.ToString, e.RowIndex)
                                Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value = ""
                                Me.dgvNormalCard("HolderName", e.RowIndex).Value = ""
                                Me.dgvNormalCard("Mobile", e.RowIndex).Value = ""
                                Me.dgvNormalCard("Gender", e.RowIndex).Value = ""

                                Me.dgvNormalCard("HolderIdNo", e.RowIndex).ReadOnly = True
                                Me.dgvNormalCard("HolderName", e.RowIndex).ReadOnly = True
                                Me.dgvNormalCard("Mobile", e.RowIndex).ReadOnly = True
                                Me.dgvNormalCard("Gender", e.RowIndex).ReadOnly = True
                            End If
                        End If
                        'modify code 050:end-------------------------------------------------------------------------
                    End If

                    Me.NormalCardSummary()
                    If Me.dgvNormalCard("FaceValue", e.RowIndex).Equals(errorNormalCell) Then
                        'modify code 050:start-------------------------------------------------------------------------
                        'MessageBox.Show("国家政策规定， 卡片的最大面值不能超过 1,000 元。    " & Chr(13) & Chr(13) & sErrorNormalInfo.Replace("不能", "已经") & "！" & Space(4) & Chr(13) & Chr(13) & "请重新设置卡片面值。    ", "卡片面值超出许可范围！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        MessageBox.Show("根据国家政策规定， 卡片面值超出许可范围。    " & Chr(13) & Chr(13) & sErrorNormalInfo.Replace("不能", "已经") & "！" & Space(4) & Chr(13) & Chr(13) & "请重新设置卡片面值。    ", "卡片面值超出许可范围！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        'modify code 050:end-------------------------------------------------------------------------
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新设置卡片面值。"
                    Else
                        blCanRecheckCard = True
                        If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                            frmCheckCardResult.btnRecheck.Visible = True
                        End If
                    End If
                Else
                    errorNormalCell = Me.dgvNormalCard("FaceValue", e.RowIndex)
                    If sErrorNormalInfo.IndexOf("介于") > -1 Then
                        MessageBox.Show(sErrorNormalInfo & "！" & Space(4) & Chr(13) & Chr(13) & "请重新设置卡片面值。    ", "卡片面值超出许可范围！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                    frmMain.statusText.Text = "卡片面值超出许可范围（" & sErrorNormalInfo & "）！请重新设置卡片面值。"
                    Me.dgvNormalCard.Select() : Me.dgvNormalCard("EndCardNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                End If
            Case "CardCost"
                If bNewSalesBillType = 1 Then
                    Me.dgvNormalCard("CardPayment", e.RowIndex).Value = 0
                Else
                    Me.dgvNormalCard("CardPayment", e.RowIndex).Value = Me.dgvNormalCard("FaceValue", e.RowIndex).Value + Me.dgvNormalCard("CardCost", e.RowIndex).Value
                End If
                Me.dgvNormalCard("PayableAMT", e.RowIndex).Value = Me.dgvNormalCard("CardPayment", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                Me.dgvNormalCard("CostAMT", e.RowIndex).Value = Me.dgvNormalCard("CardCost", e.RowIndex).Value * Me.dgvNormalCard("CardQTY", e.RowIndex).Value
                If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then
                    For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", e.RowIndex).Value.ToString)
                        drRowPayment.Delete() : drRowPayment.AcceptChanges()
                    Next
                    Me.dgvNormalCard("PaymentDescription", e.RowIndex).Value = "请分配付款金额……"
                    If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = e.ColumnIndex AndAlso errorNormalCell.RowIndex = e.RowIndex Then
                        errorNormalCell = Nothing : sErrorNormalInfo = ""
                    End If
                End If
                Me.NormalCardSummary()
                'modify code 046,050:start-------------------------------------------------------------------------
                '实名制追加check
            Case "HolderName"
                If bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = "购卡" Then
                    If sValue = "" Then
                        errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                        frmMain.statusText.Text = "实名卡销售必须输入持卡人姓名。"
                        MessageBox.Show("实名卡销售必须输入持卡人姓名。    ", "持卡人姓名为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If

                    If sErrorNormalInfo = "" AndAlso Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString <> "" Then
                        '与界面个人信息对比
                        For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                            If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                ElseIf dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                ElseIf dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderName

                        For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                            If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                ElseIf dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                ElseIf dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderName

                        '与已存个人信息对比
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                            If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                sErrorNormalInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                            ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                sErrorNormalInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                            ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                sErrorNormalInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                            End If
                        End If
                    End If

ErrorFlagHolderName:
                    If sErrorNormalInfo = "" Then
                        Me.ConfigNormalCardRow()
                    Else
                        Me.dgvNormalCard.Select() : Me.dgvNormalCard("HolderName", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                    End If
                End If
            Case "Gender"
                If bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = "购卡" Then
                    If sValue = "" Then
                        errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                        frmMain.statusText.Text = "实名卡销售必须输入持卡人性别。"
                        MessageBox.Show("实名卡销售必须输入持卡人性别。    ", "持卡人性别为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If

                    If sErrorNormalInfo = "" AndAlso Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString <> "" Then
                        '与界面个人信息对比
                        For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                            If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                ElseIf dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                ElseIf dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagGender

                        For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                            If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                ElseIf dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                ElseIf dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagGender

                        '与已存个人信息对比
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                            If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                sErrorNormalInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                            ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                sErrorNormalInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                            ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                sErrorNormalInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                            End If
                        End If
                    End If

ErrorFlagGender:
                    If sErrorNormalInfo = "" Then
                        Me.ConfigNormalCardRow()
                    Else
                        Me.dgvNormalCard.Select() : Me.dgvNormalCard("Gender", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                    End If
                End If
            Case "HolderIdNo"
                If bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = "购卡" Then
                    If sValue = "" Then
                        errorNormalCell = Me.dgvNormalCard("HolderIdNo", e.RowIndex)
                        sErrorNormalInfo = "实名卡销售必须输入持卡人身份证号。"
                        MessageBox.Show("实名卡销售必须输入持卡人身份证号。    ", "持卡人身份证号为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf CheckCredentialsNo(sValue) = False Then
                        errorNormalCell = Me.dgvNormalCard("HolderIdNo", e.RowIndex)
                        sErrorNormalInfo = "输入的持卡人身份证号不正确。"
                        MessageBox.Show("输入的持卡人身份证号不正确。    ", "持卡人身份证号不正确！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If

                    If sErrorNormalInfo = "" AndAlso Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString <> "" Then
                        '与界面个人信息对比
                        For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                            If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderIdNo

                        For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                            If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderIdNo

                        '与已存个人信息对比
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                            If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                sErrorNormalInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                            End If
                        End If
                    End If

                    If sErrorNormalInfo = "" AndAlso Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString <> "" Then
                        '与界面个人信息对比
                        For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                            If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderIdNo

                        For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                            If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderIdNo

                        '与已存个人信息对比
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                            If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                sErrorNormalInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                            End If
                        End If
                    End If

                    If sErrorNormalInfo = "" AndAlso Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString <> "" Then
                        '与界面个人信息对比
                        For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                            If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderIdNo

                        For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                            If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagHolderIdNo

                        '与已存个人信息对比
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                            If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                sErrorNormalInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                            End If
                        End If
                    End If

ErrorFlagHolderIdNo:
                    If sErrorNormalInfo = "" Then
                        Me.ConfigNormalCardRow()
                    Else
                        Me.dgvNormalCard.Select() : Me.dgvNormalCard("HolderIdNo", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                    End If
                End If
            Case "Mobile"
                If bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", e.RowIndex).Value = "购卡" Then
                    If sValue = "" Then
                        errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                        sErrorNormalInfo = "实名卡销售必须输入持卡人手机号"
                        MessageBox.Show("实名卡销售必须输入持卡人手机号。    ", "持卡人手机号为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Not IsNumeric(sValue.Trim()) OrElse sValue.Trim().Length <> 11 Then
                        errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                        sErrorNormalInfo = "输入的持卡人手机号格式不正确"
                        MessageBox.Show("输入的持卡人手机号格式不正确。    ", "持卡人手机号格式不正确！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If

                    If sErrorNormalInfo = "" AndAlso Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString <> "" Then
                        '与界面个人信息对比
                        For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                            If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                ElseIf dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                ElseIf dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagMobile

                        For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                            If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                            AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                                If dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人手机不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                    Exit For
                                ElseIf dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人姓名不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                    Exit For
                                ElseIf dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                    errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                    sErrorNormalInfo = "持同一证件号的持卡人性别不一致。"
                                    frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                    Exit For
                                End If
                            End If
                        Next i
                        If sErrorNormalInfo <> "" Then GoTo ErrorFlagMobile

                        '与已存个人信息对比
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                            If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvNormalCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Mobile", e.RowIndex)
                                sErrorNormalInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                            ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvNormalCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("HolderName", e.RowIndex)
                                sErrorNormalInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                            ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvNormalCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                                errorNormalCell = Me.dgvNormalCard("Gender", e.RowIndex)
                                sErrorNormalInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                                frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                            End If
                        End If
                    End If

ErrorFlagMobile:
                    If sErrorNormalInfo = "" Then
                        Me.ConfigNormalCardRow()
                    Else
                        Me.dgvNormalCard.Select() : Me.dgvNormalCard("Mobile", e.RowIndex).Selected = True : errorNormalCell.Selected = True
                    End If
                End If
                'modify code 046,050:end-------------------------------------------------------------------------
        End Select
        blSkipDeal = False

        For Each Column As DataGridViewColumn In Me.dgvNormalCard.Columns
            If Column.Visible = True Then
                If Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill Then
                    Column.MinimumWidth = 2
                    Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                    Column.MinimumWidth = Column.Width
                    Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                ElseIf Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells AndAlso Column.Name <> "PaymentDescription" Then
                    Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                End If
            End If
        Next

        Call LockWindowUpdate(0)
    End Sub

    Private Sub dgvNormalCard_DataError(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewDataErrorEventArgs) Handles dgvNormalCard.DataError
        e.Cancel = True
    End Sub

    Private Sub dgvNormalCard_EditingControlShowing(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewEditingControlShowingEventArgs) Handles dgvNormalCard.EditingControlShowing
        If Me.dgvNormalCard.CurrentRow.Selected Then
            blSkipDeal = True : Me.dgvNormalCard.CurrentRow.Selected = False : blSkipDeal = False
        End If
        'modify code 046:start-------------------------------------------------------------------------
        '追加性别列
        'modify code 004:start-------------------------------------------------------------------------
        'If Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "CardCost" Then
        If Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "CardCost" _
            And Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "FirstBuy" _
            And Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "Gender" Then
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 046:end-------------------------------------------------------------------------
            editingTextBox = CType(e.Control, TextBox)
            RemoveHandler editingTextBox.KeyDown, AddressOf CardNo_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf CardQTY_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf MediaNo_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf PayerName_KeyDown
            'modify code 011:start-------------------------------------------------------------------------
            RemoveHandler editingTextBox.KeyDown, AddressOf Barcode_KeyDown
            'modify code 011:end-------------------------------------------------------------------------
            RemoveHandler editingTextBox.TextChanged, AddressOf editingTextBox_TextChanged
            RemoveHandler editingTextBox.TextChanged, AddressOf Money_TextChanged
            editingTextBox.ImeMode = Windows.Forms.ImeMode.Disable
            Select Case Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name
                Case "StartCardNo", "EndCardNo"
                    If "|条码卡|充值券|公关券|活动券|".IndexOf("|" & Me.dgvNormalCard("CardFeature", Me.dgvNormalCard.CurrentCell.RowIndex).Value.ToString & "|") > -1 Then
                        editingTextBox.MaxLength = 17
                    Else
                        editingTextBox.MaxLength = 19
                    End If
                    AddHandler editingTextBox.KeyDown, AddressOf CardNo_KeyDown
                Case "CardQTY"
                    editingTextBox.MaxLength = 6
                    editingTextBox.Text = editingTextBox.Text.Replace(",", "")
                    AddHandler editingTextBox.KeyDown, AddressOf CardQTY_KeyDown
                    'modify code 011:start-------------------------------------------------------------------------
                Case "BarCode"
                    editingTextBox.MaxLength = 13
                    AddHandler editingTextBox.KeyDown, AddressOf Barcode_KeyDown
                    'modify code 011:end-------------------------------------------------------------------------
                    'modify code 046:start-------------------------------------------------------------------------
                    '实名制追加输入格式
                Case "HolderName"
                    editingTextBox.MaxLength = 6
                    editingTextBox.ImeMode = Windows.Forms.ImeMode.On
                Case "HolderIdNo"
                    editingTextBox.MaxLength = 18
                Case "Mobile"
                    editingTextBox.MaxLength = 11
                    'modify code 046:end-------------------------------------------------------------------------
                Case Else
                    editingTextBox.MaxLength = 12
                    editingTextBox.Text = editingTextBox.Text.Replace(",", "")
                    AddHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
            End Select
            AddHandler editingTextBox.TextChanged, AddressOf editingTextBox_TextChanged
        End If
    End Sub

    Private Sub dgvNormalCard_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles dgvNormalCard.KeyDown
        If e.KeyCode = Keys.Delete AndAlso Me.dgvNormalCard.ReadOnly = False AndAlso drImportedFile Is Nothing AndAlso Me.dgvNormalCard.CurrentRow.Selected = True Then
            Me.menuDeleteNormalCard.PerformClick()
            e.SuppressKeyPress = True
        End If
    End Sub

    Private Sub dgvNormalCard_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvNormalCard.Leave
        If Me.dgvSelectablePayment.Visible Then Return
        'Dim clickedControl As Control = Me.pnlSelectablePayment.GetChildAtPoint(Me.pnlSelectablePayment.PointToClient(Control.MousePosition))
        'If clickedControl IsNot Nothing AndAlso clickedControl.Name = "dgvSelectablePayment" Then Return

        frmMain.statusText.Text = "就绪。"
        blSkipDeal = True
        If Me.dgvNormalCard.CurrentCell IsNot Nothing Then Me.dgvNormalCard.CurrentCell.Selected = False
        If Me.dgvNormalCard.CurrentRow IsNot Nothing Then Me.dgvNormalCard.CurrentRow.Selected = False
        blSkipDeal = False
        Me.pcbSelectablPayment.Visible = False
    End Sub

    Private Sub dgvNormalCard_Scroll(ByVal sender As Object, ByVal e As System.Windows.Forms.ScrollEventArgs) Handles dgvNormalCard.Scroll
        If blSkipDeal Then Return
        If sSalesBillID <> "-1" OrElse Me.dgvNormalCard.CurrentCell Is Nothing OrElse Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "PaymentDescription" Then Return
        Me.pcbSelectablPayment.Visible = False
        Me.pnlSelectablePayment.Visible = False
        Me.pcbSelectablPayment.Image = My.Resources.PaymentDown
        If Me.dgvNormalCard.CurrentRow IsNot Nothing AndAlso Me.dgvNormalCard.CurrentRow.Displayed AndAlso Me.dgvNormalCard.Columns("PaymentDescription").Displayed Then
            Me.pcbSelectablPayment.Location = Me.GetRowPaymentPicLocation
            Me.pcbSelectablPayment.Visible = True
        End If
    End Sub

    Private Sub dgvNormalCard_SelectionChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvNormalCard.SelectionChanged
        If blSkipDeal OrElse Me.dgvNormalCard.CurrentCell Is Nothing Then Return
        If sSalesBillID = "-1" AndAlso Me.dgvNormalCard.Columns("PaymentDescription").Visible = True AndAlso Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "PaymentDescription" Then Me.pcbSelectablPayment.Visible = False
        blSkipDeal = True
        frmMain.statusText.Text = "就绪。"
        If Me.dgvNormalCard.ReadOnly Then
            Me.dgvNormalCard.CurrentRow.Selected = True
        ElseIf Me.dgvNormalCard.CurrentCell.ColumnIndex = 0 Then
            Me.dgvNormalCard("ChargedAMT", Me.dgvNormalCard.CurrentRow.Index).Selected = True
            Me.dgvNormalCard.CurrentRow.Selected = True
            If Me.dgvNormalCard.ReadOnly = False AndAlso drImportedFile Is Nothing AndAlso Me.dgvNormalCard("CardQTY", Me.dgvNormalCard.CurrentRow.Index).Value.ToString <> "" Then frmMain.statusText.Text = "提示：按<Delete>键可删除该行。"
        ElseIf errorNormalCell IsNot Nothing Then
            If errorNormalCell IsNot Me.dgvNormalCard.CurrentCell Then
                Dim sFeature As String = Me.dgvNormalCard("CardFeature", errorNormalCell.RowIndex).Value.ToString
                If sFeature = "" Then sFeature = "购物卡"
                Select Case Me.dgvNormalCard.Columns(errorNormalCell.ColumnIndex).Name
                    Case "StartCardNo"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = "开始" & sFeature.Substring(2, 1) & "号错误（" & sErrorNormalInfo & "）！请重新输入开始" & sFeature.Substring(2, 1) & "号。"
                    Case "EndCardNo"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = "结束" & sFeature.Substring(2, 1) & "号错误（" & sErrorNormalInfo & "）！请重新输入结束" & sFeature.Substring(2, 1) & "号。"
                    Case "CardQTY"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        'modify code 051:start-------------------------------------------------------------------------
                        'frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量。"
                        frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量。"
                        'modify code 051:end-------------------------------------------------------------------------
                    Case "FaceValue"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新设置卡片面值。"
                        'modify code 046:start-------------------------------------------------------------------------
                        '选中出错的单元格
                    Case "HolderName"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新输入持卡人姓名。"
                    Case "Gender"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新输入持卡人性别。"
                    Case "HolderIdNo"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新输入持卡人身份证号。"
                    Case "Mobile"
                        errorNormalCell.Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新输入持卡人手机号。"
                        'modify code 046:end-------------------------------------------------------------------------
                    Case Else
                        errorNormalCell.Selected = True
                        Me.pcbSelectablPayment.Location = Me.GetRowPaymentPicLocation()
                        Me.pcbSelectablPayment.Visible = True
                        Me.ShowRowPaymentGrid()
                        frmMain.statusText.Text = sErrorNormalInfo & "！请重新分配付款金额。"
                End Select
            ElseIf Me.dgvNormalCard.Columns(errorNormalCell.ColumnIndex).Name = "PaymentDescription" Then
                errorNormalCell.Selected = True
                Me.pcbSelectablPayment.Location = Me.GetRowPaymentPicLocation()
                Me.pcbSelectablPayment.Visible = True
                Me.ShowRowPaymentGrid()
            End If
        Else
            Dim sFeature As String
            For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
                'modify code 050:start-------------------------------------------------------------------------
                '控制卡面值不能为空（包括 选择同行[面值]及之后的单元格 / 选择最后一行以外的他行的任意单元格 时）
                'If drNormal.Cells("FaceValue").Value.ToString = "" AndAlso ((drNormal.Index = Me.dgvNormalCard.CurrentRow.Index AndAlso Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name = "CardCost") OrElse (drNormal.Index <> Me.dgvNormalCard.CurrentRow.Index AndAlso drNormal.Index <> Me.dgvNormalCard.RowCount - 1)) Then
                If drNormal.Cells("FaceValue").Value.ToString = "" AndAlso ((drNormal.Index = Me.dgvNormalCard.CurrentRow.Index AndAlso Me.dgvNormalCard.CurrentCell.ColumnIndex >= Me.dgvNormalCard.Columns("FaceValue").Index) OrElse (drNormal.Index <> Me.dgvNormalCard.CurrentRow.Index AndAlso drNormal.Index <> Me.dgvNormalCard.RowCount - 1)) Then
                    'modify code 050:end-------------------------------------------------------------------------
                    If Me.dgvNormalCard("StartCardNo", drNormal.Index).Value.ToString = "" Then
                        Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入开始卡号。"
                    ElseIf Me.dgvNormalCard("EndCardNo", drNormal.Index).Value.ToString = "" Then
                        Me.dgvNormalCard("EndCardNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入结束卡号。"
                        'modify code 011:start-------------------------------------------------------------------------
                    ElseIf Me.dgvNormalCard("StartCardNo", drNormal.Index).Value.ToString.Substring(0, 6) = "233660" AndAlso Me.dgvNormalCard("FirstBuy", drNormal.Index).Value.ToString = "购卡" Then
                        Me.dgvNormalCard("BarCode", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入条码。"
                        'modify code 011:end-------------------------------------------------------------------------
                        'modify code 046,050:start-------------------------------------------------------------------------
                        'ElseIf bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", drNormal.Index).Value.ToString = "购卡" Then
                        '    'modify code 050:end-------------------------------------------------------------------------
                        '    '实名制输入check
                        '    If Me.dgvNormalCard("HolderName", drNormal.Index).Value.ToString = "" Then
                        '        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                        '        frmMain.statusText.Text = "请先输入持卡人姓名。"
                        '    ElseIf Me.dgvNormalCard("Gender", drNormal.Index).Value.ToString = "" Then
                        '        Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                        '        frmMain.statusText.Text = "请先输入持卡人性别。"
                        '    ElseIf Me.dgvNormalCard("HolderIdNo", drNormal.Index).Value.ToString = "" Then
                        '        Me.dgvNormalCard("HolderIdNo", drNormal.Index).Selected = True
                        '        frmMain.statusText.Text = "请先输入持卡人身份证号。"
                        '    ElseIf Me.dgvNormalCard("Mobile", drNormal.Index).Value.ToString = "" Then
                        '        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                        '        frmMain.statusText.Text = "请先输入持卡人手机号。"
                        '    Else
                        '        Me.dgvNormalCard("FaceValue", drNormal.Index).Selected = True
                        '        Me.dgvNormalCard.BeginEdit(True)
                        '        sFeature = Me.dgvNormalCard("CardFeature", drNormal.Index).Value.ToString
                        '        If sFeature = "" Then sFeature = "购物卡"
                        '        'modify code 051:start-------------------------------------------------------------------------
                        '        'frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "的面值未设置！请先设置该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "的面值。"
                        '        frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "的面值未设置！请先设置该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "的面值。"
                        '        'modify code 051:end-------------------------------------------------------------------------
                        '    End If
                        'modify code 046:end-------------------------------------------------------------------------
                    Else
                        Me.dgvNormalCard("FaceValue", drNormal.Index).Selected = True
                        Me.dgvNormalCard.BeginEdit(True)
                        sFeature = Me.dgvNormalCard("CardFeature", drNormal.Index).Value.ToString
                        If sFeature = "" Then sFeature = "购物卡"
                        'modify code 051:start-------------------------------------------------------------------------
                        'frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "的面值未设置！请先设置该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "的面值。"
                        frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "的面值未设置！请先设置该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "的面值。"
                        'modify code 051:end-------------------------------------------------------------------------
                    End If
                    blSkipDeal = False : Exit Sub
                    'modify code 046,050:start-------------------------------------------------------------------------
                    '实名制输入check（仅check实名制卡销售单中，售卡卡行换行时）
                    'ElseIf bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", drNormal.Index).Value.ToString = "购卡" Then
                ElseIf bNewSalesBillType = 7 AndAlso Me.dgvNormalCard("FirstBuy", drNormal.Index).Value.ToString = "购卡" _
                AndAlso drNormal.Index <> Me.dgvNormalCard.CurrentRow.Index Then
                    'modify code 050:end-------------------------------------------------------------------------
                    If drNormal.Cells("HolderName").Value.ToString = "" Then
                        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人姓名。"
                        blSkipDeal = False : Exit Sub
                    ElseIf drNormal.Cells("Gender").Value.ToString = "" Then
                        Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人性别。"
                        blSkipDeal = False : Exit Sub
                    ElseIf drNormal.Cells("HolderIdNo").Value.ToString = "" Then
                        Me.dgvNormalCard("HolderIdNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人身份证号。"
                        blSkipDeal = False : Exit Sub
                    ElseIf drNormal.Cells("Mobile").Value.ToString = "" Then
                        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人手机号。"
                        blSkipDeal = False : Exit Sub
                        '实名制输入同卡同人check（仅check实名制销售单中，实名制售卡卡行，已输入完整个人信息后，换行时）
                    ElseIf Me.dgvNormalCard("HolderIdNo", drNormal.Index).Value.ToString <> "" Then
                        If dtRebateCard.Select("StartCardNo = '" & Me.dgvNormalCard("StartCardNo", drNormal.Index).Value.ToString & "'").Length <> _
                        dtRebateCard.Select("StartCardNo = '" & Me.dgvNormalCard("StartCardNo", drNormal.Index).Value.ToString & "' AND HolderIdNo ='" & Me.dgvNormalCard("HolderIdNo", drNormal.Index).Value.ToString & "'").Length Then
                            Me.dgvNormalCard("HolderIdNo", drNormal.Index).Selected = True
                            frmMain.statusText.Text = "同一张实名制卡只能绑定一个人。"
                            blSkipDeal = False : Exit Sub
                        End If
                    End If

                    '个人信息检查
                    'If drNormal.Cells("HolderIdNo").Value.ToString <> "" AndAlso dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length = 1 Then
                    '    If drNormal.Cells("HolderName").Value.ToString <> "" AndAlso dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drNormal.Cells("HolderName").Value.ToString & "'").Length = 0 Then
                    '        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                    '        frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                    '        blSkipDeal = False : Exit Sub
                    '    End If

                    '    If drNormal.Cells("Gender").Value.ToString <> "" AndAlso dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drNormal.Cells("Gender").Value.ToString & "'").Length = 0 Then
                    '        Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                    '        frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                    '        blSkipDeal = False : Exit Sub
                    '    End If

                    '    If drNormal.Cells("Mobile").Value.ToString <> "" AndAlso dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drNormal.Cells("Mobile").Value.ToString & "'").Length = 0 Then
                    '        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                    '        frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                    '        blSkipDeal = False : Exit Sub
                    '    End If
                    'End If

                    ''If drNormal.Cells("HolderIdNo").Value.ToString <> "" AndAlso dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length = 0 Then
                    ''    If drNormal.Cells("HolderName").Value.ToString <> "" AndAlso dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drNormal.Cells("HolderName").Value.ToString & "'").Length <> dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length Then
                    ''        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                    ''        frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                    ''        blSkipDeal = False : Exit Sub
                    ''        Exit Sub
                    ''    End If

                    ''    If drNormal.Cells("Gender").Value.ToString <> "" AndAlso dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drNormal.Cells("Gender").Value.ToString & "'").Length <> dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length Then
                    ''        Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                    ''        frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                    ''        blSkipDeal = False : Exit Sub
                    ''        Exit Sub
                    ''    End If

                    ''    If drNormal.Cells("Mobile").Value.ToString <> "" AndAlso dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drNormal.Cells("Mobile").Value.ToString & "'").Length <> dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length Then
                    ''        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                    ''        frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                    ''        blSkipDeal = False : Exit Sub
                    ''        Exit Sub
                    ''    End If
                    ''End If
                    'modify code 046:end-------------------------------------------------------------------------
                End If
            Next

            If Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.CurrentRow.Index).Value.ToString = "" Then
                If Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "StartCardNo" Then
                    Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.CurrentRow.Index).Selected = True
                    frmMain.statusText.Text = "请先输入开始卡号。"
                End If
            ElseIf Me.dgvNormalCard("EndCardNo", Me.dgvNormalCard.CurrentRow.Index).Value.ToString = "" Then
                If Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name <> "EndCardNo" Then
                    Me.dgvNormalCard("EndCardNo", Me.dgvNormalCard.CurrentRow.Index).Selected = True
                    frmMain.statusText.Text = "请先输入结束卡号。"
                End If
            ElseIf Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name = "PaymentDescription" AndAlso Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentCell.RowIndex).Value.ToString <> "" Then
                If sSalesBillID = "-1" Then
                    Me.pcbSelectablPayment.Location = Me.GetRowPaymentPicLocation()
                    Me.pcbSelectablPayment.Visible = True
                    If Me.pnlSelectablePayment.Visible = False AndAlso (Me.dgvNormalCard("PaymentDescription", Me.dgvNormalCard.CurrentRow.Index).Value.ToString.IndexOf("请分配付款金额") > -1 OrElse Me.dgvNormalCard.CurrentCell.Equals(errorNormalCell)) Then
                        Me.ShowRowPaymentGrid()
                    End If
                Else
                    Me.dgvNormalCard.CurrentRow.Selected = True
                End If
            ElseIf Me.dgvNormalCard.CurrentCell.ReadOnly = True Then
                Me.dgvNormalCard("ChargedAMT", Me.dgvNormalCard.CurrentRow.Index).Selected = True
                Me.dgvNormalCard.CurrentRow.Selected = True
                If Me.dgvNormalCard.ReadOnly = False AndAlso drImportedFile Is Nothing Then frmMain.statusText.Text = "提示：按<Delete>键可删除该行。"
            ElseIf Me.dgvNormalCard.CurrentCell.ReadOnly = False Then
                'modify code 004:start-------------------------------------------------------------------------
                'If Me.dgvNormalCard.Columns(Me.dgvNormalCard.CurrentCell.ColumnIndex).Name = "CardCost" AndAlso dmCardCost > 0 AndAlso dtNormalCard.Select("Isnull(CardFeature,'磁条卡') In ('磁条卡','礼品卡')").Length > 2 Then
                '    frmMain.statusText.Text = "提示：点击""卡成本""列标题，可以为购物卡列表中的所有行指定相同的卡成本。"
                'End If
                'modify code 004:end-------------------------------------------------------------------------
                Me.dgvNormalCard.BeginEdit(True)
            End If
        End If
        blSkipDeal = False
    End Sub

    Private Sub pcbSelectablePayment_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles pcbSelectablPayment.Click
        If Me.pnlSelectablePayment.Visible = False Then
            Me.ShowRowPaymentGrid()
        Else
            Me.pcbSelectablPayment.Image = My.Resources.PaymentDown
            Me.pnlSelectablePayment.Visible = False
        End If
    End Sub

    Private Sub dgvSelectablePayment_CellContentClick(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvSelectablePayment.CellContentClick
        If Me.dgvSelectablePayment.Columns(e.ColumnIndex).Name <> "Selected" OrElse Me.dgvSelectablePayment("AvailableAMT", e.RowIndex).Value = 0 Then Return
        Dim dmAvailable As Decimal = Me.dgvSelectablePayment("AvailableAMT", e.RowIndex).Value, dmBalanceAMT As Decimal = Me.dgvNormalCard("PayableAMT", Me.dgvNormalCard.CurrentCell.RowIndex).Value
        Try
            dmBalanceAMT = dmBalanceAMT - dtSelectablePayment.Compute("Sum(DistributedAMT)", "")
        Catch
        End Try
        Dim drPayment As DataRow = dtSelectablePayment.Select("RowID=" & Me.dgvSelectablePayment("RowID", e.RowIndex).Value.ToString)(0), sCardRowID As String = Me.dgvNormalCard("RowID", Me.dgvNormalCard.CurrentCell.RowIndex).Value.ToString, sPaymentRowID As String = Me.dgvSelectablePayment("RowID", e.RowIndex).Value.ToString
        If dmBalanceAMT = 0 AndAlso Not drPayment("Selected") Then Return
        blSkipDeal = True
        If drPayment("Selected") Then
            Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).ReadOnly = True
            dtRowPayment.Select("CardRowID=" & sCardRowID & " And PaymentRowID=" & sPaymentRowID)(0).Delete()
            drPayment("Selected") = 0
            drPayment("DistributedAMT") = 0
            Me.dgvSelectablePayment.Refresh()
        Else
            Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).ReadOnly = False
            Dim newRowPayment As DataRow = dtRowPayment.Rows.Add()
            newRowPayment("CardRowID") = sCardRowID
            newRowPayment("PaymentRowID") = sPaymentRowID
            newRowPayment("DistributedAMT") = IIf(dmBalanceAMT < dmAvailable, dmBalanceAMT, dmAvailable)
            newRowPayment.EndEdit()
            drPayment("Selected") = 1
            drPayment("DistributedAMT") = newRowPayment("DistributedAMT")
        End If
        dtRowPayment.AcceptChanges() : dtSelectablePayment.AcceptChanges()
        Me.dgvNormalCard("PaymentDescription", Me.dgvNormalCard.CurrentCell.RowIndex).Value = Me.FormatPaymentDescription(sCardRowID)
        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
        Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
        Me.dgvNormalCard.FirstDisplayedScrollingColumnIndex = Me.dgvNormalCard.Columns("PaymentDescription").Index
        Try
            If Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).ReadOnly = False Then
                Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).Selected = True
                Me.dgvSelectablePayment.BeginEdit(True)
            End If
        Catch
        End Try
        blSkipDeal = False
    End Sub

    Private Sub dgvSelectablePayment_CellFormatting(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellFormattingEventArgs) Handles dgvSelectablePayment.CellFormatting
        If Me.dgvSelectablePayment.Columns(e.ColumnIndex).Name = "DistributedAMT" Then
            If Me.dgvSelectablePayment("Selected", e.RowIndex).Value Then
                Me.dgvSelectablePayment(e.ColumnIndex, e.RowIndex).ReadOnly = False
                e.CellStyle.BackColor = SystemColors.Window
            Else
                Me.dgvSelectablePayment(e.ColumnIndex, e.RowIndex).ReadOnly = True
                e.CellStyle.BackColor = Color.PeachPuff
            End If
        End If
    End Sub

    Private Sub dgvSelectablePayment_CellLeave(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvSelectablePayment.CellLeave
        If editingTextBox IsNot Nothing Then
            If editingTextBox.Text <> "" AndAlso editingTextBox.Parent IsNot Nothing AndAlso editingTextBox.Parent.Parent.Name = "dgvSelectablePayment" Then editingTextBox.Text = Format(CDec(editingTextBox.Text), "#,0.00")
            editingTextBox = Nothing
        End If
    End Sub

    Private Sub dgvSelectablePayment_CellValueChanged(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvSelectablePayment.CellValueChanged
        If blSkipDeal OrElse Me.dgvSelectablePayment.Columns(e.ColumnIndex).Name <> "DistributedAMT" Then Return
        blSkipDeal = True
        Dim sValue As String = Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).Value.ToString, dmDistributedAMT As Decimal = 0, dmAvailable As Decimal = Me.dgvSelectablePayment("AvailableAMT", e.RowIndex).Value, dmBalanceAMT As Decimal = Me.dgvNormalCard("PayableAMT", Me.dgvNormalCard.CurrentCell.RowIndex).Value
        If Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).Value.ToString <> "" AndAlso IsNumeric(Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).Value.ToString) Then dmDistributedAMT = Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).Value
        Try
            dmBalanceAMT = dmBalanceAMT - dtSelectablePayment.Compute("Sum(DistributedAMT)", "RowID<>" & Me.dgvSelectablePayment("RowID", e.RowIndex).Value.ToString)
        Catch
        End Try
        If dmDistributedAMT > dmAvailable Then dmDistributedAMT = dmAvailable
        If dmDistributedAMT > dmBalanceAMT Then dmDistributedAMT = dmBalanceAMT
        Me.dgvSelectablePayment.EndEdit()
        Dim drPayment As DataRow = dtSelectablePayment.Select("RowID=" & Me.dgvSelectablePayment("RowID", e.RowIndex).Value.ToString)(0), sCardRowID As String = Me.dgvNormalCard("RowID", Me.dgvNormalCard.CurrentCell.RowIndex).Value.ToString, sPaymentRowID As String = Me.dgvSelectablePayment("RowID", e.RowIndex).Value.ToString
        If dmDistributedAMT = 0 Then
            dtRowPayment.Select("CardRowID=" & sCardRowID & " And PaymentRowID=" & sPaymentRowID)(0).Delete()
            drPayment("Selected") = 0
            drPayment("DistributedAMT") = 0
            Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).ReadOnly = True
        Else
            drPayment("DistributedAMT") = dmDistributedAMT
            dtRowPayment.Select("CardRowID=" & sCardRowID & " And PaymentRowID=" & sPaymentRowID)(0)("DistributedAMT") = dmDistributedAMT
        End If
        dtRowPayment.AcceptChanges() : dtSelectablePayment.AcceptChanges()
        Me.dgvNormalCard("PaymentDescription", Me.dgvNormalCard.CurrentCell.RowIndex).Value = Me.FormatPaymentDescription(sCardRowID)
        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
        Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
        Me.dgvNormalCard.FirstDisplayedScrollingColumnIndex = Me.dgvNormalCard.Columns("PaymentDescription").Index
        If Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).ReadOnly = False AndAlso sValue.Replace(",", "") <> Me.dgvSelectablePayment("DistributedAMT", e.RowIndex).Value.ToString.Replace(",", "") Then
            errorNormalCell = Me.dgvSelectablePayment("DistributedAMT", e.RowIndex)
            sTimerType = "SingleDistributedAMTError"
            Me.theTimer.Interval = 100
            Me.theTimer.Enabled = True
        End If
        blSkipDeal = False
    End Sub

    Private Sub dgvSelectablePayment_DataError(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewDataErrorEventArgs) Handles dgvSelectablePayment.DataError
        e.Cancel = True
    End Sub

    Private Sub dgvSelectablePayment_EditingControlShowing(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewEditingControlShowingEventArgs) Handles dgvSelectablePayment.EditingControlShowing
        editingTextBox = CType(e.Control, TextBox)
        editingTextBox.ImeMode = Windows.Forms.ImeMode.Disable
        editingTextBox.MaxLength = Format(Me.dgvSelectablePayment("AvailableAMT", Me.dgvSelectablePayment.CurrentCell.RowIndex).Value, "0.00").Length
        editingTextBox.Text = editingTextBox.Text.Replace(",", "")
        RemoveHandler editingTextBox.KeyDown, AddressOf CardNo_KeyDown
        RemoveHandler editingTextBox.KeyDown, AddressOf CardQTY_KeyDown
        RemoveHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
        RemoveHandler editingTextBox.KeyDown, AddressOf MediaNo_KeyDown
        RemoveHandler editingTextBox.KeyDown, AddressOf PayerName_KeyDown
        RemoveHandler editingTextBox.TextChanged, AddressOf editingTextBox_TextChanged
        RemoveHandler editingTextBox.TextChanged, AddressOf Money_TextChanged
        AddHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
    End Sub

    Private Sub dgvSelectablePayment_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvSelectablePayment.Leave
        Me.pcbSelectablPayment.Image = My.Resources.PaymentDown
        Me.pcbSelectablPayment.Visible = False
        Me.pnlSelectablePayment.Visible = False
    End Sub

    Private Sub pnlSelectablePayment_VisibleChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles pnlSelectablePayment.VisibleChanged
        If blSkipDeal Then Return
        If pnlSelectablePayment.Visible = False Then
            Me.dgvSelectablePayment.EndEdit()
            Dim dmDistributedAMT As Decimal = 0, dmRowPayableAMT As Decimal = Me.dgvNormalCard("PayableAMT", Me.dgvNormalCard.CurrentCell.RowIndex).Value
            Try
                dmDistributedAMT = dtRowPayment.Compute("Sum(DistributedAMT)", "CardRowID=" & Me.dgvNormalCard("RowID", Me.dgvNormalCard.CurrentCell.RowIndex).Value.ToString)
            Catch
            End Try
            If dmDistributedAMT = 0 OrElse dmDistributedAMT = dmRowPayableAMT Then
                If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = Me.dgvNormalCard.CurrentCell.ColumnIndex AndAlso errorNormalCell.RowIndex = Me.dgvNormalCard.CurrentCell.RowIndex Then
                    errorNormalCell = Nothing : sErrorNormalInfo = ""
                End If
            Else
                Dim blReShow As Boolean = (errorNormalCell Is Nothing), thePoint As New Point(MousePosition.X, MousePosition.Y)
                If blReShow Then
                    MessageBox.Show("分配的付款金额不足！请重新分配。    ", "分配的付款金额不足！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                End If
                errorNormalCell = Me.dgvNormalCard.CurrentCell
                sErrorNormalInfo = "已分配的付款金额不足"
                Me.dgvNormalCard.Refresh()
                If blReShow Then
                    Dim clickedControl As Control = Me.dgvNormalCard.Parent.GetChildAtPoint(Me.dgvNormalCard.Parent.PointToClient(thePoint))
                    If clickedControl Is Nothing OrElse clickedControl.Name <> "dgvNormalCard" Then Return
                    sTimerType = "DistributedAMTError"
                    Me.theTimer.Interval = 100
                    Me.theTimer.Enabled = True
                End If
            End If
        End If
    End Sub

    'modify code 004:start-------------------------------------------------------------------------
    'Private Sub cmenuCardCost_ItemClicked(ByVal sender As Object, ByVal e As System.Windows.Forms.ToolStripItemClickedEventArgs) Handles cmenuCardCost.ItemClicked
    '    Dim sCardCost As String = e.ClickedItem.Text
    '    sCardCost = sCardCost.Substring(sCardCost.IndexOf(" ") + 1)
    '    sCardCost = sCardCost.Substring(0, sCardCost.IndexOf(" "))
    '    blSkipDeal = True
    '    For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
    '        If drNormal.Cells("StartCardNo").Value.ToString.IndexOf("2") = 0 Then
    '            drNormal.Cells("CardCost").Value = CDec(sCardCost)
    '            If drNormal.Cells("FaceValue").Value.ToString <> "" Then
    '                drNormal.Cells("CardPayment").Value = drNormal.Cells("FaceValue").Value + CDec(sCardCost)
    '                drNormal.Cells("PayableAMT").Value = drNormal.Cells("CardPayment").Value * drNormal.Cells("CardQTY").Value
    '                drNormal.Cells("CostAMT").Value = CDec(sCardCost) * drNormal.Cells("CardQTY").Value
    '            End If
    '        End If
    '    Next
    '    blSkipDeal = False
    '    Me.NormalCardSummary()
    '    Me.dgvNormalCard.Select()
    '    Me.dgvNormalCard("CardCost", 1).Selected = True
    '    Me.dgvNormalCard("CardCost", 0).Selected = True
    'End Sub

    'Private Sub cmenuCardCost_Opening(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles cmenuCardCost.Opening
    '    Me.cmenuCardCost.Items.Clear()
    '    Dim dmEachCost As Decimal = Me.dgvNormalCard("CardCost", 0).Value
    '    If dtNormalCard.Select("CardCost=" & dmEachCost.ToString).Length <> dtNormalCard.Rows.Count - 1 Then dmEachCost = -1

    '    For iLevel As Int16 = CInt(dmCardCost) To 0 Step -1
    '        Me.cmenuCardCost.Items.Add("相同卡成本 " & Format(iLevel, "#,0.00") & " 元")
    '        CType(Me.cmenuCardCost.Items(Me.cmenuCardCost.Items.Count - 1), ToolStripMenuItem).CheckOnClick = True
    '        If iLevel = dmEachCost Then CType(Me.cmenuCardCost.Items(Me.cmenuCardCost.Items.Count - 1), ToolStripMenuItem).Checked = True
    '    Next
    'End Sub
    'modify code 004:end-------------------------------------------------------------------------

    Private Sub menuDeleteNormalCard_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles menuDeleteNormalCard.Click
        Dim blDeleted As Boolean = False
        blSkipDeal = True
        Dim iCurrentRow As Integer = Me.dgvNormalCard.CurrentRow.Index, sRowID As String = Me.dgvNormalCard("RowID", iCurrentRow).Value.ToString, drNormal As DataRow = dtNormalCard.Select("RowID=" & sRowID)(0)
        If errorNormalCell IsNot Nothing AndAlso errorNormalCell.RowIndex = iCurrentRow Then errorNormalCell = Nothing
        If iCurrentRow = Me.dgvNormalCard.RowCount - 1 Then
            If drNormal("StartCardNo").ToString <> "" Then
                drNormal.Delete()
                drNormal = dtNormalCard.Rows.Add(iCurrentRow + 1)
                blDeleted = True
            End If
        Else
            drNormal.Delete()
            For Each drNormal In dtNormalCard.Select("RowID>" & (iCurrentRow + 1))
                drNormal("RowID") = drNormal("RowID") - 1
            Next
            blDeleted = True
        End If
        If blDeleted Then
            For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & sRowID)
                drRowPayment.Delete() : drRowPayment.AcceptChanges()
            Next
            Me.NormalCardSummary()
            If Me.splitList.Panel2Collapsed = False Then Me.ResetCardListLayout()

            blCanRecheckCard = True
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                frmCheckCardResult.btnRecheck.Visible = True
            End If
        End If
        If iCurrentRow > Me.dgvNormalCard.RowCount - 1 Then iCurrentRow = Me.dgvNormalCard.RowCount - 1
        If Me.dgvNormalCard("StartCardNo", iCurrentRow).Value.ToString = "" Then
            Me.dgvNormalCard("StartCardNo", iCurrentRow).Selected = True
            Me.dgvNormalCard.BeginEdit(True)
            frmMain.statusText.Text = "就绪。"
        Else
            Me.dgvNormalCard("ChargedAMT", iCurrentRow).Selected = True : Me.dgvNormalCard.CurrentRow.Selected = True
        End If
        Me.dgvNormalCard.Columns("CardFeature").Visible = (dtNormalCard.Select("Isnull(CardFeature, '磁条卡')<>'磁条卡'").Length > 0)
        'modify code 004:start-------------------------------------------------------------------------
        'If dmCardCost > 0 AndAlso dtNormalCard.Select("Isnull(CardFeature,'磁条卡') In ('磁条卡','礼品卡')").Length > 2 Then
        '    Me.dgvNormalCard.Columns("CardCost").ToolTipText = "点击该标题可为各行指定相同的卡成本"
        'Else
        '    Me.dgvNormalCard.Columns("CardCost").ToolTipText = ""
        'End If
        'modify code 004:end-------------------------------------------------------------------------
        blSkipDeal = False
    End Sub

    Private Sub dgvRebateCard_CellClick(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvRebateCard.CellClick
        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" AndAlso Me.btnEmployeeNo.Text <> "" Then
            sTimerType = "EmployeeError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub dgvRebateCard_CellEndEdit(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvRebateCard.CellEndEdit
        If blSkipDeal Then Return
        blSkipDeal = True : Me.dgvRebateCard.CurrentCell.Selected = False : blSkipDeal = False
    End Sub

    Private Sub dgvRebateCard_CellEnter(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvRebateCard.CellEnter
        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" AndAlso Me.btnEmployeeNo.Text <> "" Then
            sTimerType = "EmployeeError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub dgvRebateCard_CellFormatting(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellFormattingEventArgs) Handles dgvRebateCard.CellFormatting
        If e.ColumnIndex > 0 AndAlso Me.dgvRebateCard.Columns(e.ColumnIndex).Visible = True Then
            'If Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "CardFeature" AndAlso Me.dgvRebateCard("CardFeature", e.RowIndex).Value.ToString <> "磁条卡" Then
            '    e.CellStyle.ForeColor = Color.Orange
            '    e.CellStyle.Font = New Font(e.CellStyle.Font, FontStyle.Bold)
            'End If

            If sSalesBillID = "-1" Then
                If Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "FaceValue" AndAlso Me.dgvRebateCard("FaceValue", e.RowIndex).ReadOnly Then
                    e.CellStyle.BackColor = Color.WhiteSmoke
                ElseIf (Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "StartCardNo" OrElse Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "EndCardNo") AndAlso Me.dgvRebateCard("ActivationState", e.RowIndex).Value.ToString = "N" Then
                    e.CellStyle.ForeColor = Color.Red
                    e.CellStyle.SelectionForeColor = Color.Red
                    If Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "EndCardNo" Then e.CellStyle.BackColor = Color.WhiteSmoke
                    Return
                End If
            End If

            If Me.dgvRebateCard.CurrentRow IsNot Nothing AndAlso Me.dgvRebateCard.CurrentRow.Selected = True AndAlso e.RowIndex = Me.dgvRebateCard.CurrentRow.Index Then
                If errorRebateCell IsNot Nothing AndAlso e.ColumnIndex = errorRebateCell.ColumnIndex AndAlso e.RowIndex = errorRebateCell.RowIndex Then
                    e.CellStyle.SelectionForeColor = Color.Red
                Else
                    e.CellStyle.SelectionForeColor = SystemColors.HighlightText
                End If
                e.CellStyle.SelectionBackColor = SystemColors.Highlight
            ElseIf Me.dgvRebateCard.ReadOnly Then
                e.CellStyle.BackColor = SystemColors.Control
                If Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "ActivationState" Then
                    If Me.dgvRebateCard("ActivationState", e.RowIndex).Value.ToString = "等待激活" Then
                        e.CellStyle.ForeColor = Color.Green
                        e.CellStyle.SelectionForeColor = Color.LightGreen
                    ElseIf Me.dgvRebateCard("ActivationState", e.RowIndex).Value.ToString = "正在激活" Then
                        e.CellStyle.ForeColor = Color.SteelBlue
                    ElseIf Me.dgvRebateCard("ActivationState", e.RowIndex).Value.ToString = "部分激活" Then
                        e.CellStyle.ForeColor = Color.Chocolate
                        e.CellStyle.SelectionForeColor = Color.PeachPuff
                        e.CellStyle.SelectionForeColor = Color.LightBlue
                    ElseIf e.Value.ToString = "激活失败" OrElse e.Value.ToString = "等待取消" OrElse e.Value.ToString = "已被取消" Then
                        e.CellStyle.ForeColor = Color.Red
                        e.CellStyle.SelectionForeColor = Color.Red
                    ElseIf e.Value.ToString.IndexOf("（") > 0 Then
                        e.CellStyle.ForeColor = Color.Maroon
                        e.CellStyle.SelectionForeColor = Color.Maroon
                    End If
                ElseIf Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "StateReason" Then
                    e.CellStyle.ForeColor = Color.Red
                    e.CellStyle.SelectionForeColor = Color.Red
                End If
            ElseIf Me.dgvRebateCard.Columns(e.ColumnIndex).ReadOnly Then
                e.CellStyle.BackColor = Color.WhiteSmoke
            ElseIf Me.dgvRebateCard.Columns(e.ColumnIndex).Name = "FaceValue" AndAlso e.Value.ToString <> "" AndAlso e.Value = 0 Then
                e.CellStyle.ForeColor = Color.Red
            ElseIf errorRebateCell IsNot Nothing AndAlso e.ColumnIndex = errorRebateCell.ColumnIndex AndAlso e.RowIndex = errorRebateCell.RowIndex Then
                e.CellStyle.ForeColor = Color.Red
            End If
        End If
    End Sub

    Private Sub dgvRebateCard_CellLeave(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvRebateCard.CellLeave
        If editingTextBox IsNot Nothing AndAlso e.ColumnIndex > 0 Then
            Select Case Me.dgvRebateCard.Columns(Me.dgvRebateCard.CurrentCell.ColumnIndex).Name
                Case "CardQTY"
                    If editingTextBox.Text <> "" AndAlso editingTextBox.Parent IsNot Nothing AndAlso editingTextBox.Parent.Parent.Name = "dgvRebateCard" Then editingTextBox.Text = Format(CDec(editingTextBox.Text), "#,0")
                Case "FaceValue"
                    If editingTextBox.Text <> "" AndAlso editingTextBox.Parent IsNot Nothing AndAlso editingTextBox.Parent.Parent.Name = "dgvRebateCard" Then editingTextBox.Text = Format(CDec(editingTextBox.Text), "#,0.00")
            End Select
            editingTextBox = Nothing
        End If
    End Sub

    Private Sub dgvRebateCard_CellMouseUp(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellMouseEventArgs) Handles dgvRebateCard.CellMouseUp
        If e.Button = Windows.Forms.MouseButtons.Right AndAlso e.ColumnIndex = 0 AndAlso Me.dgvRebateCard.ReadOnly = False AndAlso Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString <> "" Then
            blSkipDeal = True
            Me.dgvRebateCard("ChargedAMT", e.RowIndex).Selected = True
            Me.dgvRebateCard.CurrentRow.Selected = True
            blSkipDeal = False
            Me.cmenuDeleteRebateCard.Show(Control.MousePosition)
        End If
    End Sub

    Private Sub dgvRebateCard_CellValueChanged(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvRebateCard.CellValueChanged
        If blSkipDeal Then Return
        blSkipDeal = True
        Dim sValue As String = Me.dgvRebateCard(e.ColumnIndex, e.RowIndex).Value.ToString, sFeature As String = Me.dgvRebateCard("CardFeature", e.RowIndex).Value.ToString, sNewFeature As String = "充值券", blIsPaperCard As Boolean = False
        If blCanUsePaperCard Then
            If sFeature = "条码卡" OrElse sFeature = "充值券" OrElse sFeature = "营销券" OrElse sFeature = "活动券" Then
                blIsPaperCard = True
            ElseIf sFeature = "" Then
                'modify code 050:start-------------------------------------------------------------------------
                'sFeature = "磁条卡"
                If sValue.IndexOf("2336" & frmMain.signCardBin) = 0 Then
                    sFeature = "实名制卡"
                Else
                    sFeature = "磁条卡"
                End If
                'modify code 050:end-------------------------------------------------------------------------
            End If
        ElseIf sFeature = "" Then
            'modify code 050:start-------------------------------------------------------------------------
            'sFeature = "磁条卡"
            If sValue.IndexOf("2336" & frmMain.signCardBin) = 0 Then
                sFeature = "实名制卡"
            Else
                sFeature = "磁条卡"
            End If
            'modify code 050:end-------------------------------------------------------------------------
        End If

        Call LockWindowUpdate(Me.dgvRebateCard.Handle)

        errorRebateCell = Nothing : sErrorRebateInfo = ""
        Select Case Me.dgvRebateCard.Columns(e.ColumnIndex).Name
            Case "StartCardNo"
                Me.dgvRebateCard("ActivationState", e.RowIndex).Value = DBNull.Value '清除检查是否已存在卡时可能设置的值
                If drSalesBill("StoreID").ToString = "" Then Me.SelectStore()
                sNewFeature = Me.SetInputtingCardFeature(sValue, True)

                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    If Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString = "" Then
                        Me.dgvRebateCard.EndEdit() : Me.dgvRebateCard("StartCardNo", e.RowIndex).Value = DBNull.Value
                        blSkipDeal = False : Call LockWindowUpdate(0) : Return
                    Else
                        Me.dgvRebateCard.EndEdit()
                        Me.dgvRebateCard("StartCardNo", e.RowIndex).Value = Me.dgvRebateCard("EndCardNo", e.RowIndex).Value
                        sValue = Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString
                    End If
                ElseIf sNewFeature = "" Then
                    If Me.IsValidCard(sValue) Then
                        sErrorRebateInfo = "卡类型未开通"
                        MessageBox.Show("卡类型未开通！    " & Chr(13) & Chr(13) & "请通知总部开通此卡类型。    ", "卡类型未开通！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Else
                        sErrorRebateInfo = "不可识别的卡类型"
                        MessageBox.Show("不可识别的卡类型！    " & Chr(13) & Chr(13) & "请检查卡号！    ", "不可识别的卡类型！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf sNewFeature = "活动卡" OrElse sNewFeature = "活动券" Then
                    sErrorRebateInfo = sNewFeature & "不能出现在一般销售单中"
                    MessageBox.Show(sNewFeature & "不能出现在一般销售单中！    " & Chr(13) & Chr(13) & "请输入除活动卡" & IIf(blCanUsePaperCard, "（券）", "") & "之外的卡" & IIf(blCanUsePaperCard, "（券）", "") & "号。    ", sNewFeature & "不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso sNewFeature <> "实名制卡" AndAlso sNewFeature <> "营销卡" AndAlso sNewFeature <> "营销券" Then
                    sErrorRebateInfo = "此卡不能出现在实名制卡销售单中"
                    MessageBox.Show("此卡不能出现在实名制卡销售单中！    " & Chr(13) & Chr(13) & "请输入实名制卡/营销卡/营销券。    ", sNewFeature & "不能出现在实名制卡销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                    'modify code 054:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 8 AndAlso sValue.IndexOf("233665") <> 0 AndAlso sNewFeature <> "营销卡" AndAlso sNewFeature <> "营销券" Then
                    sErrorRebateInfo = "此卡不能出现在通卖非实名卡销售单中"
                    MessageBox.Show("此卡不能出现在通卖非实名卡销售单中！    " & Chr(13) & Chr(13) & "请输入通卖非实名卡/营销卡/营销券。    ", sNewFeature & "不能出现在通卖非实名卡销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 0 AndAlso sValue.IndexOf("233665") = 0 Then
                    sErrorRebateInfo = "通卖非实名卡不能出现在一般销售单中"
                    MessageBox.Show("一般销售单中不能售卖通卖非实名卡！    " & Chr(13) & Chr(13) & "请输入磁条卡" & IIf(blCanUsePaperCard, "或条码卡", "") & "的卡号。    ", "通卖非实名卡不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 054:end-------------------------------------------------------------------------
                ElseIf bNewSalesBillType <> 9 AndAlso sNewFeature <> sFeature Then
                    sErrorRebateInfo = sNewFeature & "不能出现在" & sFeature & "行中"
                    MessageBox.Show("该行已被确定为" & sFeature & "行，不能容纳" & sNewFeature & "！    " & Chr(13) & Chr(13) & "请另起一行或删除该" & sFeature & "行再输入" & sNewFeature & "号。    ", sNewFeature & "不能出现在" & sFeature & "行中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType <> 9 AndAlso blCanUse92Card AndAlso Me.chbPrintDiscount.Checked = False AndAlso sNewFeature <> "营销卡" AndAlso sNewFeature <> "营销券" Then
                    sErrorRebateInfo = "该卡不是营销卡" & IIf(blCanUsePaperCard, "或营销券", "")
                    MessageBox.Show("您已选择不在发票上打印折扣信息，所以只能用营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "作为返点卡。但当前卡不是营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "！    " & Chr(13) & Chr(13) & "如果想使用除营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "之外的其它卡作为返点卡，请先勾选左边面版的""在发票上打印折扣信息""选项。    ", "不是营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "不能当作返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf blIsPaperCard Then
                    If sValue.Length < 17 Then
                        sErrorRebateInfo = sNewFeature & "号位数不足 17 位"
                        MessageBox.Show(sNewFeature & "号错误：位数不足 17 位！    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf (sNewFeature <> "营销券" AndAlso sPaperCardBin.IndexOf(sValue.Substring(0, 5)) = -1) OrElse (sNewFeature = "营销券" AndAlso sFreeCardBin.IndexOf(sValue.Substring(0, 5)) = -1) Then
                        sErrorRebateInfo = sFeature & "的银商JV编号不符"
                        MessageBox.Show(sNewFeature & "号错误：银商JV编号不符！    " & Chr(13) & Chr(13) & sNewFeature & "号的前 5 位即为银商JV编号。    " & Chr(13) & Chr(13) & "系统设置的该店的银商JV编号是： " & IIf(sNewFeature = "营销券", sFreeCardBin, sPaperCardBin) & Space(4) & Chr(13) & "您输入的" & sNewFeature & "的银商JV编号是： " & sValue.Substring(0, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "银商JV编号不符！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso sValue.Substring(0, 8) <> Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 8) Then
                        sErrorRebateInfo = sFeature & "的开始" & sFeature.Substring(2, 1) & "号与结束" & sFeature.Substring(2, 1) & "号的券类型不一致"
                        MessageBox.Show("同一行" & sNewFeature & "的开始" & sNewFeature.Substring(2, 1) & "号与结束" & sNewFeature.Substring(2, 1) & "号的券类型必须一致！    " & Chr(13) & Chr(13) & "（" & sNewFeature & "号的前 8 位即为券类型。）    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "券类型不一致！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvRebateCard("FaceValue", e.RowIndex).Value.ToString = "" AndAlso dtPaperCardFaceValue.Rows.Find(sValue.Substring(0, 8)) Is Nothing Then
                        sErrorRebateInfo = "券类型不存在"
                        MessageBox.Show("当前" & sNewFeature & "的券类型""" & sValue.Substring(0, 8) & """不存在！    " & Chr(13) & Chr(13) & "（" & sNewFeature & "号的前 8 位即为券类型。）    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "券类型不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso Math.Abs(CLng(Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString) - CLng(sValue)) + 1 > 100000 Then
                        sErrorRebateInfo = "该行" & sFeature & "数量超过 100,000 张"
                        MessageBox.Show("每行的" & sNewFeature & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                    'modify code 051:start-------------------------------------------------------------------------
                ElseIf sValue.Length < 19 Then
                    sErrorRebateInfo = "卡号位数不足 19 位"
                    'MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 9 Then
                    If sValue.Length = 19 AndAlso sValue.Substring(4, 5) <> "65999" AndAlso sValue.Substring(4, 2) <> "92" Then
                        sErrorRebateInfo = "卡号错误"
                        MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：银商Bin码不符！    " & Chr(13) & Chr(13) & "（返点卡银商Bin码不符。）    " & Chr(13) & Chr(13) & "  请重新输入卡号。    ", "卡号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf sValue <> ShoppingCardNo.GetFullCardNo(sValue.Substring(0, 18)) Then
                        sErrorRebateInfo = "卡号校验码错误"
                        MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf (sNewFeature = "磁条卡" AndAlso sCULCardBin.IndexOf(sValue.Substring(4, 5)) = -1) OrElse (sNewFeature = "礼品卡" AndAlso sGiftCardBin.IndexOf(sValue.Substring(4, 5)) = -1) OrElse (sNewFeature = "营销卡" AndAlso sFreeCardBin.IndexOf(sValue.Substring(4, 5)) = -1) Then
                    'sErrorRebateInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码不符"
                    'MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, IIf(sNewFeature = "礼品卡", sGiftCardBin, sFreeCardBin)) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorRebateInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, IIf(sNewFeature = "礼品卡", sGiftCardBin, sFreeCardBin)) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf sValue <> ShoppingCardNo.GetFullCardNo(sValue.Substring(0, 18)) Then
                    sErrorRebateInfo = "卡号校验码错误"
                    'MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso Math.Abs(CLng(Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) - CLng(sValue.Substring(0, 18))) + 1 > 100000 Then
                    'sErrorRebateInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    'MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorRebateInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso _
                    dtSignCardRangeNew.Select("CardNo >='" & sValue & "' and CardNo <='" & Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString & "'").Length > 0 AndAlso _
                    dtSignCardRangeNew.Select("CardNo >='" & sValue & "' and CardNo <='" & Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString & "'").Length <> CLng(sValue.Substring(0, 18)) - CLng(Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + 1 Then
                    sErrorRebateInfo = "新卡售卖和旧卡充值请分行操作"
                    MessageBox.Show("新卡售卖和旧卡充值请分行操作！    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                End If

                'modify code 050:start-------------------------------------------------------------------------
                '实名卡check
                If sErrorRebateInfo = "" Then
                    If dtSignCardRangeOld.Select("CardNo='" & sValue & "' and CardType='实名制卡'").Length = 1 Then
                        sErrorRebateInfo = "旧版实名制卡无法继续使用"
                        MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号或更换新实名制卡。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Else
                        If bNewSalesBillType = 7 Then
                            'If sCULCardBin.IndexOf(sValue.Substring(4, 5)) > 0 OrElse sFreeCardBin.IndexOf(sValue.Substring(4, 5)) > 0 Then
                            '    Me.dgvRebateCard("IsSignCard", e.RowIndex).Value = "否"
                            'ElseIf dtSignCardRangeNew.Select("CardNo='" & sValue & "' and CardType='实名制卡'").Length = 1 Then
                            '    Me.dgvRebateCard("IsSignCard", e.RowIndex).Value = "是"
                            If sValue.IndexOf("233661") = 0 Then
                                Me.dgvRebateCard("IsSignCard", e.RowIndex).Value = "是"
                            ElseIf sFreeCardBin.IndexOf(sValue.Substring(4, 5)) >= 0 Then
                                Me.dgvRebateCard("IsSignCard", e.RowIndex).Value = "否"
                            Else
                                'sErrorRebateInfo = "实名制卡销售单只能使用实名制卡，84卡，92卡作为返点卡"
                                sErrorRebateInfo = "实名制卡销售单只能使用实名制卡，92卡作为返点卡"
                                MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            End If
                        Else
                            'If dtSignCardRangeNew.Select("CardNo='" & sValue & "' and CardType='实名制卡'").Length = 1 Then
                            If sValue.IndexOf("233661") = 0 Then
                                sErrorRebateInfo = "非实名制卡销售单不能使用实名制卡作为返点卡"
                                MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            End If
                        End If
                    End If

                End If
                'modify code 050:end-------------------------------------------------------------------------

                If sErrorRebateInfo = "" Then
                    Dim blGotoEndCardColumn As Boolean = False
                    If blIsPaperCard Then
                        If Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString = "" Then
                            Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = sValue
                            blGotoEndCardColumn = True
                        End If
                        If Me.dgvRebateCard("FaceValue", e.RowIndex).Value.ToString = "" Then
                            Me.dgvRebateCard("FaceValue", e.RowIndex).Value = dtPaperCardFaceValue.Rows.Find(sValue.Substring(0, 8))("FaceValue")
                        End If

                        Me.ConfigRebatePaperCardRow()
                        If drSalesBill("NormalCardQTY") > 0 AndAlso Me.CheckPaperCardExisting(True, Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString) Then
                            Call LockWindowUpdate(0)
                            errorRebateCell = Me.dgvRebateCard("StartCardNo", e.RowIndex)
                            sErrorRebateInfo = "同一张" & sFeature & "不能同时既是正常卡又是返点卡"
                            MessageBox.Show(sFeature & "是定额卡，只能被激活一次，所以不能既当作正常卡使用又当作返点卡使用！    " & Chr(13) & Chr(13) & "请重新输入" & sFeature & "号。    ", "同一张" & sFeature & "不能同时既是正常卡又是返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            frmMain.statusText.Text = "开始" & sFeature.Substring(2, 1) & "号错误（" & sErrorRebateInfo & "）！请重新输入开始" & sFeature.Substring(2, 1) & "号。"
                            Me.dgvRebateCard.Select() : Me.dgvRebateCard("EndCardNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                        ElseIf blGotoEndCardColumn Then
                            Me.dgvRebateCard("EndCardNo", Me.dgvRebateCard.CurrentRow.Index).Selected = True
                        End If
                    Else
                        If Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString = "" OrElse blUsedOldCard Then
                            Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = sValue
                            blGotoEndCardColumn = True
                        End If

                        If Me.dgvRebateCard("FaceValue", e.RowIndex).Value.ToString = "" AndAlso dtRebateCard.Select("'" & sValue & "'>=StartCardNo And '" & sValue & "'<=EndCardNo").Length > 0 Then
                            Me.dgvRebateCard("FaceValue", e.RowIndex).Value = dtRebateCard.Select("'" & sValue & "'>=StartCardNo And '" & sValue & "'<=EndCardNo")(0)("FaceValue")
                        End If

                        Me.ConfigRebateCardRow()
                        If blGotoEndCardColumn Then
                            'modify code 046,054,072:start-------------------------------------------------------------------------
                            '同一般销售单
                            'If bNewSalesBillType = 0 AndAlso blUsedOldCard Then
                            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso blUsedOldCard Then
                            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso blUsedOldCard Then
                                'modify code 046,054,072:end-------------------------------------------------------------------------
                                Me.dgvRebateCard("FaceValue", Me.dgvRebateCard.CurrentRow.Index).Selected = True
                            Else
                                Me.dgvRebateCard("EndCardNo", Me.dgvRebateCard.CurrentRow.Index).Selected = True
                            End If
                        End If
                    End If
                    'modify code 050:start-------------------------------------------------------------------------
                    If bNewSalesBillType = 7 Then
                        If sValue.IndexOf("233661") = -1 Then
                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value = ""
                            Me.dgvRebateCard("HolderName", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Mobile", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Gender", e.RowIndex).Value = ""

                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("HolderName", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Mobile", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Gender", e.RowIndex).ReadOnly = True
                        ElseIf dtSignCardRangeNew.Select("CardNo ='" & sValue & "'").Length = 1 Then
                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value = ""
                            Me.dgvRebateCard("HolderName", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Mobile", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Gender", e.RowIndex).Value = ""

                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("HolderName", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Mobile", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Gender", e.RowIndex).ReadOnly = True
                        Else
                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).ReadOnly = False
                            Me.dgvRebateCard("HolderName", e.RowIndex).ReadOnly = False
                            Me.dgvRebateCard("Mobile", e.RowIndex).ReadOnly = False
                            Me.dgvRebateCard("Gender", e.RowIndex).ReadOnly = False
                        End If
                    End If
                    'modify code 050:end-------------------------------------------------------------------------
                Else
                    errorRebateCell = Me.dgvRebateCard("StartCardNo", e.RowIndex)
                    If sNewFeature = "" Then sNewFeature = "磁条卡"
                    frmMain.statusText.Text = "开始" & sFeature.Substring(2, 1) & "号错误（" & sErrorRebateInfo & "）！请重新输入开始" & sFeature.Substring(2, 1) & "号。"
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("EndCardNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
            Case "EndCardNo"
                sNewFeature = Me.SetInputtingCardFeature(sValue, True)

                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    If Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString <> "" Then
                        Me.dgvRebateCard.EndEdit()
                        Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = Me.dgvRebateCard("StartCardNo", e.RowIndex).Value
                        sValue = Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString
                    Else
                        Me.dgvRebateCard.EndEdit() : Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = DBNull.Value
                        blSkipDeal = False : Call LockWindowUpdate(0) : Return
                    End If
                ElseIf sNewFeature = "" Then
                    If Me.IsValidCard(sValue) Then
                        sErrorRebateInfo = "卡类型未开通"
                        MessageBox.Show("卡类型未开通！    " & Chr(13) & Chr(13) & "请通知总部开通此卡类型。    ", "卡类型未开通！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Else
                        sErrorRebateInfo = "不可识别的卡类型"
                        MessageBox.Show("不可识别的卡类型！    " & Chr(13) & Chr(13) & "请检查卡号！    ", "不可识别的卡类型！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf sNewFeature = "活动卡" OrElse sNewFeature = "活动券" Then
                    sErrorRebateInfo = sNewFeature & "不能出现在一般销售单中"
                    MessageBox.Show(sNewFeature & "不能出现在一般销售单中！    " & Chr(13) & Chr(13) & "请输入除活动卡" & IIf(blCanUsePaperCard, "（券）", "") & "之外的卡" & IIf(blCanUsePaperCard, "（券）", "") & "号。    ", sNewFeature & "不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso sNewFeature <> "实名制卡" AndAlso sNewFeature <> "营销卡" AndAlso sNewFeature <> "营销券" Then
                    sErrorRebateInfo = "此卡不能出现在实名制卡销售单中"
                    MessageBox.Show("此卡不能出现在实名制卡销售单中！    " & Chr(13) & Chr(13) & "请输入实名制卡/营销卡/营销券。    ", sNewFeature & "不能出现在实名制卡销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                    'modify code 054:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 8 AndAlso sValue.IndexOf("233665") <> 0 AndAlso sNewFeature <> "营销卡" AndAlso sNewFeature <> "营销券" Then
                    sErrorRebateInfo = "此卡不能出现在通卖非实名卡销售单中"
                    MessageBox.Show("此卡不能出现在通卖非实名卡销售单中！    " & Chr(13) & Chr(13) & "请输入通卖非实名卡/营销卡/营销券。    ", sNewFeature & "不能出现在通卖非实名卡销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 0 AndAlso sValue.IndexOf("233665") = 0 Then
                    sErrorRebateInfo = "通卖非实名卡不能出现在一般销售单中"
                    MessageBox.Show("一般销售单中不能售卖通卖非实名卡！    " & Chr(13) & Chr(13) & "请输入磁条卡" & IIf(blCanUsePaperCard, "或条码卡", "") & "的卡号。    ", "通卖非实名卡不能出现在一般销售单中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 054:end-------------------------------------------------------------------------
                ElseIf bNewSalesBillType <> 9 AndAlso blCanUse92Card AndAlso Me.chbPrintDiscount.Checked = False AndAlso sNewFeature <> "营销卡" AndAlso sNewFeature <> "营销券" Then
                    sErrorRebateInfo = "该卡不是营销卡" & IIf(blCanUsePaperCard, "或营销券", "")
                    MessageBox.Show("您已选择不在发票上打印折扣信息，所以只能用营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "作为返点卡。但当前卡不是营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "！    " & Chr(13) & Chr(13) & "如果想使用除营销卡之外的其它卡作为返点卡" & IIf(blCanUsePaperCard, "（券）", "") & "，请先勾选左边面版的""在发票上打印折扣信息""选项。    ", "不是营销卡" & IIf(blCanUsePaperCard, "（券）", "") & "不能当作返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType <> 9 AndAlso sNewFeature <> sFeature Then
                    sErrorRebateInfo = sNewFeature & "不能出现在" & sFeature & "行中"
                    MessageBox.Show("该行已被确定为" & sFeature & "行，不能容纳" & sNewFeature & "！    " & Chr(13) & Chr(13) & "请另起一行或删除该" & sFeature & "行再输入" & sNewFeature & "号。    ", sNewFeature & "不能出现在" & sFeature & "行中！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf blIsPaperCard Then
                    If sValue.Length < 17 Then
                        sErrorRebateInfo = sNewFeature & "号位数不足 17 位"
                        MessageBox.Show(sNewFeature & "号错误：位数不足 17 位！    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf (sNewFeature <> "营销券" AndAlso sPaperCardBin.IndexOf(sValue.Substring(0, 5)) = -1) OrElse (sNewFeature = "营销券" AndAlso sFreeCardBin.IndexOf(sValue.Substring(0, 5)) = -1) Then
                        sErrorRebateInfo = sFeature & "的银商JV编号不符"
                        MessageBox.Show(sNewFeature & "号错误：银商JV编号不符！    " & Chr(13) & Chr(13) & sNewFeature & "号的前 5 位即为银商JV编号。    " & Chr(13) & Chr(13) & "系统设置的该店的银商JV编号是： " & IIf(sNewFeature = "营销券", sFreeCardBin, sPaperCardBin) & Space(4) & Chr(13) & "您输入的" & sNewFeature & "的银商JV编号是： " & sValue.Substring(0, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "银商JV编号不符！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString <> "" AndAlso sValue.Substring(0, 8) <> Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 8) Then
                        sErrorRebateInfo = sFeature & "的结束" & sFeature.Substring(2, 1) & "号与开始" & sFeature.Substring(2, 1) & "号的券类型不一致"
                        MessageBox.Show("同一行" & sNewFeature & "的结束" & sNewFeature.Substring(2, 1) & "号与开始" & sNewFeature.Substring(2, 1) & "号的券类型必须一致！    " & Chr(13) & Chr(13) & "（" & sNewFeature & "号的前 8 位即为券类型。）    " & Chr(13) & Chr(13) & "请重新输入" & sNewFeature & "号。    ", "券类型不一致！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf Math.Abs(CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString) - CLng(sValue)) + 1 > 100000 Then
                        sErrorRebateInfo = "该行" & sFeature & "数量超过 100,000 张"
                        MessageBox.Show("每行的" & sNewFeature & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                    'modify code 051:start-------------------------------------------------------------------------
                ElseIf sValue.Length < 19 Then
                    sErrorRebateInfo = "卡号位数不足 19 位"
                    'MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show(IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：位数不足 19 位！" & Space(4) & Chr(13) & Chr(13) & "请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf bNewSalesBillType = 9 Then
                    If sValue.Length = 19 AndAlso sValue.Substring(4, 5) <> "65999" AndAlso sValue.Substring(4, 2) <> "92" Then
                        sErrorRebateInfo = "卡号错误"
                        MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：银商Bin码不符！    " & Chr(13) & Chr(13) & "（返点卡银商Bin码不符。）    " & Chr(13) & Chr(13) & "  请重新输入卡号。    ", "卡号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    ElseIf sValue <> ShoppingCardNo.GetFullCardNo(sValue.Substring(0, 18)) Then
                        sErrorRebateInfo = "卡号校验码错误"
                        MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                ElseIf (sNewFeature = "磁条卡" AndAlso sCULCardBin.IndexOf(sValue.Substring(4, 5)) = -1) OrElse (sNewFeature = "礼品卡" AndAlso sGiftCardBin.IndexOf(sValue.Substring(4, 5)) = -1) OrElse (sNewFeature = "营销卡" AndAlso sFreeCardBin.IndexOf(sValue.Substring(4, 5)) = -1) Then
                    'sErrorRebateInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码不符"
                    'MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, IIf(sNewFeature = "礼品卡", sGiftCardBin, sFreeCardBin)) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorRebateInfo = IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码不符"
                    MessageBox.Show("卡号错误：" & sErrorRebateInfo & "！    " & Chr(13) & Chr(13) & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "银商Bin码即卡的第二段号码（第 5 至 9 位）。    " & Chr(13) & Chr(13) & "系统设置的该店的银商Bin码是： " & IIf(sNewFeature = "磁条卡", sCULCardBin, IIf(sNewFeature = "礼品卡", sGiftCardBin, sFreeCardBin)) & Space(4) & Chr(13) & "您输入的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "的银商Bin码是： " & sValue.Substring(4, 5) & Space(4) & Chr(13) & Chr(13) & "请重新输入卡号。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf sValue <> ShoppingCardNo.GetFullCardNo(sValue.Substring(0, 18)) Then
                    sErrorRebateInfo = "卡号校验码错误"
                    'MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show("  " & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "号错误：卡号校验码错误！    " & Chr(13) & Chr(13) & "（卡号的最后一位数字即为校验码。）    " & Chr(13) & Chr(13) & "  请重新输入" & sNewFeature.Substring(2, 1) & "号。    ", sNewFeature.Substring(2, 1) & "号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf Math.Abs(CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) - CLng(sValue.Substring(0, 18))) + 1 > 100000 Then
                    'sErrorRebateInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    'MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sErrorRebateInfo = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量超过 100,000 张"
                    MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sNewFeature, "购物卡") & "数量不能超过 100,000 张！    " & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 051:end-------------------------------------------------------------------------
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso _
                    dtSignCardRangeNew.Select("CardNo <='" & sValue & "' and CardNo >='" & Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString & "'").Length > 0 AndAlso _
                    dtSignCardRangeNew.Select("CardNo <='" & sValue & "' and CardNo >='" & Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString & "'").Length <> CLng(sValue.Substring(0, 18)) - CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + 1 Then
                    sErrorRebateInfo = "新卡售卖和旧卡充值请分行操作"
                    MessageBox.Show("新卡售卖和旧卡充值请分行操作！    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'modify code 050:end-------------------------------------------------------------------------
                End If

                If sErrorRebateInfo = "" Then
                    If blIsPaperCard Then
                        Me.ConfigRebatePaperCardRow()
                        If drSalesBill("NormalCardQTY") > 0 AndAlso Me.CheckPaperCardExisting(True, Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString, Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString) Then
                            Call LockWindowUpdate(0)
                            errorRebateCell = Me.dgvRebateCard("EndCardNo", e.RowIndex)
                            sErrorRebateInfo = "同一张" & sFeature & "不能同时既是正常卡又是返点卡"
                            MessageBox.Show(sFeature & "是定额卡，只能被激活一次，所以不能既当作正常卡使用又当作返点卡使用！    " & Chr(13) & Chr(13) & "请重新输入" & sFeature & "号。    ", "同一张" & sFeature & "卡不能同时既是正常卡又是返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            frmMain.statusText.Text = "结束" & sFeature.Substring(2, 1) & "号错误（" & sErrorRebateInfo & "）！请重新输入结束" & sFeature.Substring(2, 1) & "号。"
                            Me.dgvRebateCard.Select() : Me.dgvRebateCard("StartCardNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                        End If
                    Else
                        Me.ConfigRebateCardRow()
                    End If
                    'modify code 050:start-------------------------------------------------------------------------
                    If bNewSalesBillType = 7 Then
                        If sValue.IndexOf("233661") = -1 Then
                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value = ""
                            Me.dgvRebateCard("HolderName", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Mobile", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Gender", e.RowIndex).Value = ""

                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("HolderName", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Mobile", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Gender", e.RowIndex).ReadOnly = True
                        ElseIf dtSignCardRangeNew.Select("CardNo ='" & sValue & "'").Length = 1 Then
                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value = ""
                            Me.dgvRebateCard("HolderName", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Mobile", e.RowIndex).Value = ""
                            Me.dgvRebateCard("Gender", e.RowIndex).Value = ""

                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("HolderName", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Mobile", e.RowIndex).ReadOnly = True
                            Me.dgvRebateCard("Gender", e.RowIndex).ReadOnly = True
                        Else
                            Me.dgvRebateCard("HolderIdNo", e.RowIndex).ReadOnly = False
                            Me.dgvRebateCard("HolderName", e.RowIndex).ReadOnly = False
                            Me.dgvRebateCard("Mobile", e.RowIndex).ReadOnly = False
                            Me.dgvRebateCard("Gender", e.RowIndex).ReadOnly = False
                        End If
                    End If
                    'modify code 050:end-------------------------------------------------------------------------
                Else
                    errorRebateCell = Me.dgvRebateCard("EndCardNo", e.RowIndex)
                    If sNewFeature = "" Then sNewFeature = "磁条卡"
                    frmMain.statusText.Text = "结束" & sFeature.Substring(2, 1) & "号错误（" & sErrorRebateInfo & "）！请重新输入结束" & sFeature.Substring(2, 1) & "号。"
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("StartCardNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
            Case "CardQTY"
                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    Me.dgvRebateCard.EndEdit()
                    If blIsPaperCard Then
                        Me.dgvRebateCard("CardQTY", e.RowIndex).Value = CLng(Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString) - CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString) + 1
                    Else
                        Me.dgvRebateCard("CardQTY", e.RowIndex).Value = CLng(Me.dgvRebateCard("EndCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) - CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + 1
                    End If
                ElseIf CLng(sValue) > 100000 Then
                    'modify code 051:start-------------------------------------------------------------------------
                    'sErrorRebateInfo = "该行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量超过 100,000 张"
                    'MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量不能超过 100,000 张！" & Space(4) & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    'frmMain.statusText.Text = "每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量不能超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量。"
                    sErrorRebateInfo = "该行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量超过 100,000 张"
                    MessageBox.Show("每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量不能超过 100,000 张！" & Space(4) & Chr(13) & Chr(13) & "请分成多行输入。    ", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "每行的" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量不能超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量。"
                    'modify code 051:end-------------------------------------------------------------------------
                    errorRebateCell = Me.dgvRebateCard("CardQTY", e.RowIndex)
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("StartCardNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                ElseIf CInt(sValue) < 2 Then
                    blSkipDeal = False
                    Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = Me.dgvRebateCard("StartCardNo", e.RowIndex).Value
                    Me.dgvRebateCard("CardQTY", e.RowIndex).Value = 1
                Else
                    blSkipDeal = False
                    If blIsPaperCard Then
                        Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = (CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString) + CInt(sValue) - 1).ToString
                    Else
                        Me.dgvRebateCard("EndCardNo", e.RowIndex).Value = ShoppingCardNo.GetFullCardNo((CLng(Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString.Substring(0, 18)) + CInt(sValue) - 1).ToString)
                    End If
                End If
            Case "FaceValue"
                If sValue = "" OrElse Not IsNumeric(sValue) Then
                    sValue = ""
                    Me.dgvRebateCard.EndEdit()
                    Me.dgvRebateCard("FaceValue", e.RowIndex).Value = DBNull.Value
                End If

                If sValue = "" Then
                ElseIf CDec(sValue) = 0 Then
                    sErrorRebateInfo = "卡片面值不能为零"
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf CDec(sValue) > 1000 Then
                    Dim sCardNo As String
                    sCardNo = Me.dgvRebateCard("StartCardNo", e.RowIndex).Value.ToString
                    If sSignCardBin.IndexOf(sCardNo.Substring(4, 5)) > 0 Then
                        '实名制行
                        If CDec(sValue) > dmMaxSignCardFaceValue Then
                            sErrorRebateInfo = "实名制卡片面值不能超过 5,000 元"
                        End If
                    Else
                        '非实名制行
                        sErrorRebateInfo = "卡片面值不能超过 1,000 元"
                    End If

                    'modify code 050:end-------------------------------------------------------------------------
                End If

                If sErrorRebateInfo = "" Then
                    If sValue = "" Then
                        Me.dgvRebateCard("ChargedAMT", e.RowIndex).Value = DBNull.Value
                        Me.dgvRebateCard("PayableAMT", e.RowIndex).Value = DBNull.Value
                    Else
                        Me.dgvRebateCard("ChargedAMT", e.RowIndex).Value = Me.dgvRebateCard("FaceValue", e.RowIndex).Value * Me.dgvRebateCard("CardQTY", e.RowIndex).Value
                        Me.dgvRebateCard("PayableAMT", e.RowIndex).Value = 0
                    End If
                    Me.RebateCardSummary()
                    If Me.dgvRebateCard("FaceValue", e.RowIndex).Equals(errorRebateCell) Then
                        'modify code 046:start-------------------------------------------------------------------------
                        'MessageBox.Show("国家政策规定， 卡片的最大面值不能超过 1,000 元。    " & Chr(13) & Chr(13) & sErrorRebateInfo.Replace("不能", "已经") & "！" & Space(4) & Chr(13) & Chr(13) & "请重新设置卡片面值。    ", "卡片面值超出许可范围！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        MessageBox.Show("根据国家政策规定， 卡片面值超出许可范围。    " & Chr(13) & Chr(13) & sErrorRebateInfo.Replace("不能", "已经") & "！" & Space(4) & Chr(13) & Chr(13) & "请重新设置卡片面值。    ", "卡片面值超出许可范围！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        'modify code 046:end-------------------------------------------------------------------------
                        frmMain.statusText.Text = sErrorRebateInfo & "！请重新设置卡片面值。"
                    Else
                        blCanRecheckCard = True
                        If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                            frmCheckCardResult.btnRecheck.Visible = True
                        End If
                    End If
                Else
                    errorRebateCell = Me.dgvRebateCard("FaceValue", e.RowIndex)
                    If sErrorRebateInfo.IndexOf("超过") > -1 Then
                        MessageBox.Show(sErrorRebateInfo & "！" & Space(4) & Chr(13) & Chr(13) & "请重新设置卡片面值。    ", "卡片面值超出许可范围！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    End If
                    frmMain.statusText.Text = sErrorRebateInfo & "！请重新设置卡片面值。"
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("EndCardNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
                'modify code 050:start-------------------------------------------------------------------------
                '实名制追加check
            Case "HolderName"
                If sValue = "" Then
                    errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                    sErrorRebateInfo = "实名卡销售必须输入持卡人姓名。"
                    MessageBox.Show("实名卡销售必须输入持卡人姓名。    ", "持卡人姓名为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                End If

                If sErrorRebateInfo = "" AndAlso Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString <> "" Then
                    '与界面个人信息对比
                    For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                        If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            ElseIf dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            ElseIf dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderName

                    For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                        If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            ElseIf dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            ElseIf dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderName

                    '与已存个人信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                            sErrorRebateInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                        ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                            sErrorRebateInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                        ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                            sErrorRebateInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                        End If
                    End If
                End If

ErrorFlagHolderName:
                If sErrorRebateInfo = "" Then
                    Me.ConfigRebateCardRow()
                Else
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("HolderName", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
            Case "Gender"
                If sValue = "" Then
                    errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                    sErrorRebateInfo = "实名卡销售必须输入持卡人性别。"
                    MessageBox.Show("实名卡销售必须输入持卡人性别。    ", "持卡人性别为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                End If

                If sErrorRebateInfo = "" AndAlso Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString <> "" Then
                    '与界面个人信息对比
                    For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                        If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            ElseIf dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            ElseIf dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagGender

                    For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                        If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            ElseIf dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            ElseIf dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagGender

                    '与已存个人信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                            sErrorRebateInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                        ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                            sErrorRebateInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                        ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                            sErrorRebateInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                        End If
                    End If
                End If

ErrorFlagGender:
                If sErrorRebateInfo = "" Then
                    Me.ConfigRebateCardRow()
                Else
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("Gender", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
            Case "HolderIdNo"
                If sValue = "" Then
                    errorRebateCell = Me.dgvRebateCard("HolderIdNo", e.RowIndex)
                    sErrorRebateInfo = "实名卡销售必须输入持卡人身份证号。"
                    MessageBox.Show("实名卡销售必须输入持卡人身份证号。    ", "持卡人身份证号为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf CheckCredentialsNo(sValue) = False Then
                    errorRebateCell = Me.dgvRebateCard("HolderIdNo", e.RowIndex)
                    sErrorRebateInfo = "输入的持卡人身份证号不正确。"
                    MessageBox.Show("输入的持卡人身份证号不正确。    ", "持卡人身份证号不正确！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                End If

                If sErrorRebateInfo = "" AndAlso Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString <> "" Then
                    '与界面个人信息对比
                    For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                        If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderIdNo

                    For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                        If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderIdNo

                    '与已存个人信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                            sErrorRebateInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                        End If
                    End If
                End If

                If sErrorRebateInfo = "" AndAlso Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString <> "" Then
                    '与界面个人信息对比
                    For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                        If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderIdNo

                    For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                        If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderIdNo

                    '与已存个人信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                            sErrorRebateInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                        End If
                    End If
                End If

                If sErrorRebateInfo = "" AndAlso Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString <> "" Then
                    '与界面个人信息对比
                    For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                        If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderIdNo

                    For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                        If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagHolderIdNo

                    '与已存个人信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                            sErrorRebateInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                        End If
                    End If
                End If

ErrorFlagHolderIdNo:
                If sErrorRebateInfo = "" Then
                    Me.ConfigRebateCardRow()
                Else
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("HolderIdNo", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
            Case "Mobile"
                If sValue = "" Then
                    errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                    sErrorRebateInfo = "实名卡销售必须输入持卡人手机号。"
                    MessageBox.Show("实名卡销售必须输入持卡人手机号。    ", "持卡人手机号为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                ElseIf Not IsNumeric(sValue.Trim()) OrElse sValue.Trim().Length <> 11 Then
                    errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                    sErrorRebateInfo = "输入的持卡人手机号格式不正确。"
                    MessageBox.Show("输入的持卡人手机号格式不正确。    ", "持卡人手机号格式不正确！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                End If

                If sErrorRebateInfo = "" AndAlso Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString <> "" Then
                    '与界面个人信息对比
                    For i As Integer = 0 To dtNormalCard.Rows.Count - 1
                        If dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtNormalCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtNormalCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            ElseIf dtNormalCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            ElseIf dtNormalCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagMobile

                    For i As Integer = 0 To dtRebateCard.Rows.Count - 1
                        If dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim <> "" _
                        AndAlso dtRebateCard.Rows(i).Item("HolderIdNo").ToString.Trim = Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString.Trim Then
                            If dtRebateCard.Rows(i).Item("Mobile").ToString.Trim <> Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致。"
                                Exit For
                            ElseIf dtRebateCard.Rows(i).Item("HolderName").ToString.Trim <> Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致。"
                                Exit For
                            ElseIf dtRebateCard.Rows(i).Item("Gender").ToString.Trim <> Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString.Trim Then
                                errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致。"
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致。"
                                Exit For
                            End If
                        End If
                    Next i
                    If sErrorRebateInfo <> "" Then GoTo ErrorFlagMobile

                    '与已存个人信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Mobile = '" & Me.dgvRebateCard("Mobile", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Mobile", e.RowIndex)
                            sErrorRebateInfo = "持卡人手机与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致。"
                        ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND HolderName = '" & Me.dgvRebateCard("HolderName", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("HolderName", e.RowIndex)
                            sErrorRebateInfo = "持卡人姓名与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致。"
                        ElseIf dtHolderInfo.Select("HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", e.RowIndex).Value.ToString & "' AND Gender = '" & Me.dgvRebateCard("Gender", e.RowIndex).Value.ToString & "'").Length = 0 Then
                            errorRebateCell = Me.dgvRebateCard("Gender", e.RowIndex)
                            sErrorRebateInfo = "持卡人性别与数据库中保存的个人信息不一致。"
                            frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致。"
                        End If
                    End If
                End If

ErrorFlagMobile:
                If sErrorRebateInfo = "" Then
                    Me.ConfigRebateCardRow()
                Else
                    Me.dgvRebateCard.Select() : Me.dgvRebateCard("Mobile", e.RowIndex).Selected = True : errorRebateCell.Selected = True
                End If
                'modify code 050:end-------------------------------------------------------------------------
        End Select
        blSkipDeal = False
        For Each Column As DataGridViewColumn In Me.dgvRebateCard.Columns
            If Column.Visible = True AndAlso Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill Then
                Column.MinimumWidth = 2
                Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                Column.MinimumWidth = Column.Width
                Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
            End If
        Next
        Call LockWindowUpdate(0)
    End Sub

    Private Sub dgvRebateCard_DataError(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewDataErrorEventArgs) Handles dgvRebateCard.DataError
        e.Cancel = True
    End Sub

    Private Sub dgvRebateCard_EditingControlShowing(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewEditingControlShowingEventArgs) Handles dgvRebateCard.EditingControlShowing
        If Me.dgvRebateCard.CurrentRow.Selected Then
            blSkipDeal = True : Me.dgvRebateCard.CurrentRow.Selected = False : blSkipDeal = False
        End If

        'modify code 050:start-------------------------------------------------------------------------
        '追加性别列
        If Me.dgvRebateCard.Columns(Me.dgvRebateCard.CurrentCell.ColumnIndex).Name <> "Gender" Then
            'modify code 050:end-------------------------------------------------------------------------
            editingTextBox = CType(e.Control, TextBox)
            RemoveHandler editingTextBox.KeyDown, AddressOf CardNo_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf CardQTY_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf MediaNo_KeyDown
            RemoveHandler editingTextBox.KeyDown, AddressOf PayerName_KeyDown
            RemoveHandler editingTextBox.TextChanged, AddressOf editingTextBox_TextChanged
            RemoveHandler editingTextBox.TextChanged, AddressOf Money_TextChanged
            editingTextBox.ImeMode = Windows.Forms.ImeMode.Disable
            Select Case Me.dgvRebateCard.Columns(Me.dgvRebateCard.CurrentCell.ColumnIndex).Name
                Case "StartCardNo", "EndCardNo"
                    If "|条码卡|充值券|营销券|".IndexOf("|" & Me.dgvRebateCard("CardFeature", Me.dgvRebateCard.CurrentCell.RowIndex).Value.ToString & "|") > -1 Then
                        editingTextBox.MaxLength = 17
                    Else
                        editingTextBox.MaxLength = 19
                    End If
                    AddHandler editingTextBox.KeyDown, AddressOf CardNo_KeyDown
                Case "CardQTY"
                    editingTextBox.MaxLength = 6
                    editingTextBox.Text = editingTextBox.Text.Replace(",", "")
                    AddHandler editingTextBox.KeyDown, AddressOf CardQTY_KeyDown
                    'modify code 050:start-------------------------------------------------------------------------
                    '实名制追加输入格式
                Case "HolderName"
                    editingTextBox.MaxLength = 6
                    editingTextBox.ImeMode = Windows.Forms.ImeMode.On
                Case "HolderIdNo"
                    editingTextBox.MaxLength = 18
                Case "Mobile"
                    editingTextBox.MaxLength = 11
                    'modify code 050:end-------------------------------------------------------------------------
                Case Else
                    editingTextBox.MaxLength = 12
                    editingTextBox.Text = editingTextBox.Text.Replace(",", "")
                    AddHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
            End Select
            AddHandler editingTextBox.TextChanged, AddressOf editingTextBox_TextChanged
        End If

    End Sub

    Private Sub dgvRebateCard_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles dgvRebateCard.KeyDown
        If e.KeyCode = Keys.Delete AndAlso Me.dgvRebateCard.ReadOnly = False AndAlso Me.dgvRebateCard.CurrentRow.Selected = True Then
            Me.menuDeleteRebateCard.PerformClick()
            e.SuppressKeyPress = True
        End If
    End Sub

    Private Sub dgvRebateCard_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvRebateCard.Leave
        frmMain.statusText.Text = "就绪。"
        blSkipDeal = True
        If Me.dgvRebateCard.CurrentCell IsNot Nothing Then Me.dgvRebateCard.CurrentCell.Selected = False
        If Me.dgvRebateCard.CurrentRow IsNot Nothing Then Me.dgvRebateCard.CurrentRow.Selected = False
        blSkipDeal = False
    End Sub

    Private Sub dgvRebateCard_SelectionChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvRebateCard.SelectionChanged
        If blSkipDeal OrElse Me.dgvRebateCard.CurrentCell Is Nothing Then Return
        blSkipDeal = True
        frmMain.statusText.Text = "就绪。"
        If Me.dgvRebateCard.ReadOnly Then
            Me.dgvRebateCard.CurrentRow.Selected = True
        ElseIf Me.dgvRebateCard.CurrentCell.ColumnIndex = 0 Then
            Me.dgvRebateCard("ChargedAMT", Me.dgvRebateCard.CurrentRow.Index).Selected = True
            Me.dgvRebateCard.CurrentRow.Selected = True
            If Me.dgvRebateCard.ReadOnly = False AndAlso Me.dgvRebateCard("CardQTY", Me.dgvRebateCard.CurrentRow.Index).Value.ToString <> "" Then frmMain.statusText.Text = "提示：按<Delete>键可删除该行。"
        ElseIf errorRebateCell IsNot Nothing Then
            If errorRebateCell IsNot Me.dgvRebateCard.CurrentCell Then
                Dim sFeature As String = Me.dgvRebateCard("CardFeature", errorRebateCell.RowIndex).Value.ToString
                If sFeature = "" Then sFeature = "购物卡"
                Select Case Me.dgvRebateCard.Columns(errorRebateCell.ColumnIndex).Name
                    Case "StartCardNo"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = "开始" & sFeature.Substring(2, 1) & "号错误（" & sErrorRebateInfo & "）！请重新输入开始" & sFeature.Substring(2, 1) & "号。"
                    Case "EndCardNo"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = "结束" & sFeature.Substring(2, 1) & "号错误（" & sErrorRebateInfo & "）！请重新输入结束" & sFeature.Substring(2, 1) & "号。"
                    Case "CardQTY"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        'modify code 051:start-------------------------------------------------------------------------
                        'frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, sFeature, "购物卡") & "数量。"
                        frmMain.statusText.Text = "该行" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量超过 100,000 张！请重新输入" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, sFeature, "购物卡") & "数量。"
                        'modify code 051:end-------------------------------------------------------------------------
                        'modify code 050:start-------------------------------------------------------------------------
                        '选中出错的单元格
                    Case "HolderName"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorRebateInfo & "！请重新输入持卡人姓名。"
                    Case "Gender"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorRebateInfo & "！请重新输入持卡人性别。"
                    Case "HolderIdNo"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorRebateInfo & "！请重新输入持卡人身份证号。"
                    Case "Mobile"
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorRebateInfo & "！请重新输入持卡人手机号。"
                        'modify code 050:end-------------------------------------------------------------------------
                    Case Else
                        errorRebateCell.Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = sErrorRebateInfo & "！请重新设置卡片面值。"
                End Select
            End If
        Else
            For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
                'modify code 046,050:start-------------------------------------------------------------------------
                Dim sFaceValue As String = drRebate.Cells("FaceValue").Value.ToString
                If sFaceValue <> "" Then
                    Dim sCardNo As String = ""
                    sCardNo = drRebate.Cells("StartCardNo").Value.ToString
                    If drRebate.Cells("IsSignCard").Value.ToString = "是" Then
                        '实名制行
                        If CDec(sFaceValue) > dmMaxSignCardFaceValue Then
                            Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
                            frmMain.statusText.Text = "实名制卡片面值不能超过 5,000 元。"
                            blSkipDeal = False : Exit Sub
                        End If
                    Else
                        '非实名制行
                        If CDec(sFaceValue) > 1000 Then
                            Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
                            frmMain.statusText.Text = "卡片面值不能超过 1,000 元"
                            blSkipDeal = False : Exit Sub
                        End If
                    End If
                End If
                'modify code 046,050:end-------------------------------------------------------------------------
                'modify code 050:start-------------------------------------------------------------------------
                '控制面值不为空
                'If drRebate.Index <> Me.dgvRebateCard.RowCount - 1 AndAlso drRebate.Index <> Me.dgvRebateCard.CurrentRow.Index AndAlso drRebate.Cells("FaceValue").Value.ToString = "" Then
                If ((drRebate.Index <> Me.dgvRebateCard.RowCount - 1 AndAlso drRebate.Index <> Me.dgvRebateCard.CurrentRow.Index) OrElse _
                    (drRebate.Index = Me.dgvRebateCard.CurrentRow.Index AndAlso Me.dgvRebateCard.CurrentCell.ColumnIndex >= Me.dgvRebateCard.Columns("FaceValue").Index)) _
                AndAlso drRebate.Cells("FaceValue").Value.ToString = "" Then
                    If Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString = "" Then
                        Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = "请先输入开始卡号。"
                        blSkipDeal = False : Exit Sub
                    ElseIf Me.dgvRebateCard("EndCardNo", drRebate.Index).Value.ToString = "" Then
                        Me.dgvRebateCard("EndCardNo", drRebate.Index).Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = "请先输入结束卡号。"
                        blSkipDeal = False : Exit Sub
                    Else
                        'modify code 046,050:end-------------------------------------------------------------------------
                        Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
                        Me.dgvRebateCard.BeginEdit(True)
                        frmMain.statusText.Text = "该行返点卡的面值未设置！请先设置该行返点卡的面值。"
                        blSkipDeal = False : Exit Sub
                    End If
                    'modify code 050:start-------------------------------------------------------------------------
                    '实名制输入完整性check（仅check实名制销售单中，实名制售卡卡行换行时）
                ElseIf bNewSalesBillType = 7 AndAlso Me.dgvRebateCard("HolderName", drRebate.Index).ReadOnly = False _
                AndAlso Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString <> "" _
                AndAlso Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString.IndexOf("2336" & frmMain.signCardBin) = 0 _
                AndAlso drRebate.Index <> Me.dgvRebateCard.CurrentRow.Index Then
                    If Me.dgvRebateCard("HolderName", drRebate.Index).Value.ToString = "" Then
                        Me.dgvRebateCard("HolderName", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人姓名。"
                        blSkipDeal = False : Exit Sub
                    ElseIf Me.dgvRebateCard("Gender", drRebate.Index).Value.ToString = "" Then
                        Me.dgvRebateCard("Gender", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人性别。"
                        blSkipDeal = False : Exit Sub
                    ElseIf Me.dgvRebateCard("HolderIdNo", drRebate.Index).Value.ToString = "" Then
                        Me.dgvRebateCard("HolderIdNo", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人身份证号。"
                        blSkipDeal = False : Exit Sub
                    ElseIf Me.dgvRebateCard("Mobile", drRebate.Index).Value.ToString = "" Then
                        Me.dgvRebateCard("Mobile", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "请先输入持卡人手机号。"
                        blSkipDeal = False : Exit Sub
                        '实名制输入同卡同人check（仅check实名制销售单中，实名制售卡卡行，已输入完整个人信息后，换行时）
                    ElseIf Me.dgvRebateCard("HolderIdNo", drRebate.Index).Value.ToString <> "" Then
                        If dtNormalCard.Select("StartCardNo = '" & Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString & "'").Length <> _
                        dtNormalCard.Select("StartCardNo = '" & Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString & "' AND HolderIdNo ='" & Me.dgvRebateCard("HolderIdNo", drRebate.Index).Value.ToString & "'").Length Then
                            Me.dgvRebateCard("HolderIdNo", drRebate.Index).Selected = True
                            frmMain.statusText.Text = "同一张实名制卡只能绑定一个人。"
                            blSkipDeal = False : Exit Sub
                        End If
                    End If
                End If
                'modify code 050:end-------------------------------------------------------------------------
            Next

            If Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.CurrentRow.Index).Value.ToString = "" Then
                If Me.dgvRebateCard.Columns(Me.dgvRebateCard.CurrentCell.ColumnIndex).Name <> "StartCardNo" Then
                    Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.CurrentRow.Index).Selected = True
                    frmMain.statusText.Text = "请先输入开始卡号。"
                End If
            ElseIf Me.dgvRebateCard("EndCardNo", Me.dgvRebateCard.CurrentRow.Index).Value.ToString = "" Then
                If Me.dgvRebateCard.Columns(Me.dgvRebateCard.CurrentCell.ColumnIndex).Name <> "EndCardNo" Then
                    Me.dgvRebateCard("EndCardNo", Me.dgvRebateCard.CurrentRow.Index).Selected = True
                    frmMain.statusText.Text = "请先输入结束卡号。"
                End If
            ElseIf Me.dgvRebateCard.CurrentCell.ReadOnly = True Then
                Me.dgvRebateCard("ChargedAMT", Me.dgvRebateCard.CurrentRow.Index).Selected = True
                Me.dgvRebateCard.CurrentRow.Selected = True
                If Me.dgvRebateCard.ReadOnly = False Then frmMain.statusText.Text = "提示：按<Delete>键可删除该行。"
            ElseIf Me.dgvRebateCard.CurrentCell.ReadOnly = False Then
                Me.dgvRebateCard.BeginEdit(True)
            End If
        End If
        blSkipDeal = False
    End Sub

    Private Sub dgvRebateCard_VisibleChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvRebateCard.VisibleChanged
        If blSkipDeal Then Return

        'modify code 046,054,072:start-------------------------------------------------------------------------
        '同一般销售单
        'If sSalesBillID = "-1" AndAlso bNewSalesBillType = 0 Then
        'If sSalesBillID = "-1" AndAlso (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) Then
        If sSalesBillID = "-1" AndAlso (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) Then
            'modify code 046,054,072:end-------------------------------------------------------------------------
            If blCanUse92Card AndAlso Me.dgvRebateCard.Visible = True Then
                Me.grbPrintDiscount.Visible = True
            Else
                Me.chbPrintDiscount.Checked = False
                Me.grbPrintDiscount.Visible = False
            End If
            Me.ResetInterfaceLayout()
        End If
    End Sub

    Private Sub menuDeleteRebateCard_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles menuDeleteRebateCard.Click
        Dim blDeleted As Boolean = False
        blSkipDeal = True
        Dim iCurrentRow As Integer = Me.dgvRebateCard.CurrentRow.Index, drRebate As DataRow = dtRebateCard.Select("RowID=" & Me.dgvRebateCard("RowID", iCurrentRow).Value.ToString)(0)
        If errorRebateCell IsNot Nothing AndAlso errorRebateCell.RowIndex = iCurrentRow Then errorRebateCell = Nothing
        If iCurrentRow = Me.dgvRebateCard.RowCount - 1 Then
            If drRebate("StartCardNo").ToString <> "" Then
                drRebate.Delete()
                drRebate = dtRebateCard.Rows.Add(iCurrentRow + 1)
            End If
            blDeleted = True
        Else
            drRebate.Delete()
            For Each drRebate In dtRebateCard.Select("RowID>" & (iCurrentRow + 1))
                drRebate("RowID") = drRebate("RowID") - 1
            Next
            blDeleted = True
        End If
        If blDeleted Then
            Me.RebateCardSummary()
            Me.ResetCardListLayout()

            blCanRecheckCard = True
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then
                frmCheckCardResult.btnRecheck.Visible = True
            End If
        End If
        If iCurrentRow > Me.dgvRebateCard.RowCount - 1 Then iCurrentRow = Me.dgvRebateCard.RowCount - 1
        If Me.dgvRebateCard("StartCardNo", iCurrentRow).Value.ToString = "" Then
            Me.dgvRebateCard("StartCardNo", iCurrentRow).Selected = True
            Me.dgvRebateCard.BeginEdit(True)
            frmMain.statusText.Text = "就绪。"
        Else
            Me.dgvRebateCard("ChargedAMT", iCurrentRow).Selected = True : Me.dgvRebateCard.CurrentRow.Selected = True
        End If
        Me.dgvRebateCard.Columns("CardFeature").Visible = (dtRebateCard.Select("Isnull(CardFeature,'磁条卡')<>'磁条卡'").Length > 0)
        blSkipDeal = False
    End Sub

    Private Sub dgvPayment_CellClick(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvPayment.CellClick
        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" AndAlso Me.btnEmployeeNo.Text <> "" Then
            sTimerType = "EmployeeError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub dgvPayment_CellEndEdit(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvPayment.CellEndEdit
        blSkipDeal = True : Me.dgvPayment.CurrentCell.Selected = False : blSkipDeal = False
    End Sub

    Private Sub dgvPayment_CellEnter(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvPayment.CellEnter
        If sSalesBillID = "-1" AndAlso bNewSalesBillType = 4 AndAlso sEmployeeID = "" AndAlso Me.btnEmployeeNo.Text <> "" Then
            sTimerType = "EmployeeError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        End If
    End Sub

    Private Sub dgvPayment_CellFormatting(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellFormattingEventArgs) Handles dgvPayment.CellFormatting
        Try
            If e.ColumnIndex > 0 Then
                If Me.dgvPayment.ReadOnly OrElse Me.dgvPayment.Rows(e.RowIndex).ReadOnly Then
                    e.CellStyle.BackColor = SystemColors.Control
                ElseIf Me.dgvPayment("ValidationState", e.RowIndex).Value.ToString = "已确认到账" Then
                    Me.dgvPayment.Rows(e.RowIndex).ReadOnly = True
                    e.CellStyle.BackColor = SystemColors.Control
                ElseIf Me.dgvPayment("ValidationState", e.RowIndex).Value.ToString = "还未确认到账！" Then
                    e.CellStyle.ForeColor = Color.Red
                    e.CellStyle.SelectionForeColor = Color.Red
                ElseIf Me.dgvPayment.Columns(e.ColumnIndex).ReadOnly Then
                    e.CellStyle.BackColor = Color.WhiteSmoke
                    'modify code 008:start-------------------------------------------------------------------------
                ElseIf Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 7 AndAlso Me.dgvPayment.Columns(e.ColumnIndex).Name = "PayerName" Then
                    Me.dgvPayment(e.ColumnIndex, e.RowIndex).ReadOnly = False
                    'e.CellStyle.BackColor = Color.WhiteSmoke
                    'modify code 008:end-------------------------------------------------------------------------
                ElseIf Me.dgvPayment.Columns(e.ColumnIndex).Name = "MediaNo" OrElse Me.dgvPayment.Columns(e.ColumnIndex).Name = "PayerName" Then
                    If Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 0 Then
                        Me.dgvPayment(e.ColumnIndex, e.RowIndex).ReadOnly = True
                        e.CellStyle.BackColor = Color.WhiteSmoke
                    Else
                        Me.dgvPayment(e.ColumnIndex, e.RowIndex).ReadOnly = False
                        e.CellStyle.BackColor = SystemColors.Window
                    End If
                End If
            End If
        Catch
        End Try
    End Sub

    Private Sub dgvPayment_CellLeave(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvPayment.CellLeave
        If editingTextBox IsNot Nothing AndAlso editingTextBox.Text <> "" AndAlso editingTextBox.Parent IsNot Nothing AndAlso editingTextBox.Parent.Parent.Name = "dgvPayment" Then
            If Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name = "PaymentAMT" Then
                editingTextBox.Text = Format(CDec(editingTextBox.Text), "#,0.00")
            Else
                editingTextBox.Text = editingTextBox.Text.Trim
            End If
            editingTextBox = Nothing
        End If
    End Sub

    Private Sub dgvPayment_CellMouseDown(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellMouseEventArgs) Handles dgvPayment.CellMouseDown
        If Me.dgvPayment.ReadOnly = False AndAlso e.Button = Windows.Forms.MouseButtons.Right AndAlso Me.dgvPayment.Columns(e.ColumnIndex).Name = "MediaNo" AndAlso Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 1 Then
            My.Computer.Clipboard.Clear()
        End If
    End Sub

    Private Sub dgvPayment_CellMouseUp(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellMouseEventArgs) Handles dgvPayment.CellMouseUp
        'modify code 044:start-------------------------------------------------------------------------
        If e.Button = Windows.Forms.MouseButtons.Right AndAlso e.ColumnIndex = 0 AndAlso (drSalesBill("SalesbillType") = 0 OrElse drSalesBill("SalesbillType") = 6) AndAlso dtPayment.Select("RowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString)(0).RowState = DataRowState.Added AndAlso Me.dgvPayment("PaymentAMT", e.RowIndex).Value.ToString <> "" Then
            'If e.Button = Windows.Forms.MouseButtons.Right AndAlso e.ColumnIndex = 0 AndAlso drSalesBill("SalesbillType") = 0 AndAlso dtPayment.Select("RowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString)(0).RowState = DataRowState.Added AndAlso Me.dgvPayment("PaymentAMT", e.RowIndex).Value.ToString <> "" Then
            'modify code 044:end-------------------------------------------------------------------------
            Me.dgvPayment("RowID", e.RowIndex).Selected = True
            blSkipDeal = True
            Me.dgvPayment.EndEdit()
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditProgrammatically
            Me.dgvPayment("PaymentAMT", e.RowIndex).Selected = True
            Me.dgvPayment.CurrentRow.Selected = True
            blSkipDeal = False
            Me.cmenuDeletePayment.Show(Control.MousePosition)
        End If
    End Sub

    Private Sub dgvPayment_CellValidating(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellValidatingEventArgs) Handles dgvPayment.CellValidating
        If Me.dgvPayment.EditingControl Is Nothing Then Return

        'modify code 085:start-------------------------------------------------------------------------
        'If Me.dgvPayment.EditingControl.Text <> "转账/支票" OrElse Me.dgvPayment.EditingControl.Text <> "转账/支票＋保证金" Then
        '    Me.dgvPayment("PayerName", e.RowIndex).ReadOnly = False
        'End If
        'modify code 085:end-------------------------------------------------------------------------

        'modify code 008:start-------------------------------------------------------------------------
        'If Me.dgvPayment.Columns(e.ColumnIndex).Name = "PaymentTerm" AndAlso drSalesBill("RebateMode") = 2 AndAlso Me.dgvPayment.EditingControl.Text <> "转账" AndAlso Me.dgvPayment.EditingControl.Text <> "支票" Then

        'modify code 085:start-------------------------------------------------------------------------
        If Me.dgvPayment.Columns(e.ColumnIndex).Name = "PaymentTerm" AndAlso drSalesBill("RebateMode") = 2 AndAlso Me.dgvPayment.EditingControl.Text <> "转账" AndAlso Me.dgvPayment.EditingControl.Text <> "支票" AndAlso Me.dgvPayment.EditingControl.Text <> "积分兑换" Then
            'If Me.dgvPayment.Columns(e.ColumnIndex).Name = "PaymentTerm" AndAlso drSalesBill("RebateMode") = 2 AndAlso Me.dgvPayment.EditingControl.Text <> "转账/支票" AndAlso Me.dgvPayment.EditingControl.Text <> "转账/支票＋保证金" Then
            'modify code 085:end-------------------------------------------------------------------------

            If Me.dgvPayment.EditingControl.Text = "现金" OrElse Me.dgvPayment.EditingControl.Text = "银行卡" Then
                Dim dmTotalCardCost As Decimal = 0, dmCash As Decimal = 0
                Try
                    dmTotalCardCost = drSalesBill("CardCost")
                    dmCash = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm<2")
                Catch
                End Try
                If dmTotalCardCost = 0 Then
                    'MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票/积分兑换""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
                    e.Cancel = True
                ElseIf dmTotalCardCost < dmCash Then
                    'MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "（现金或银行卡只可用来支付卡成本。）    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "（现金或银行卡只可用来支付卡成本。）    " & Chr(13) & Chr(13) & "请选择""转账/支票/积分兑换""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
                    e.Cancel = True
                End If
            Else
                'MessageBox.Show("对不起，合同客户不允许使用除""转账/支票""之外的支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用非""转账/支票""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                MessageBox.Show("对不起，合同客户不允许使用除""转账/支票/积分兑换""之外的支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票/积分兑换""支付方式。    ", "合同客户不允许使用非""转账/支票/积分兑换""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
                e.Cancel = True
            End If
            'modify code 008:end-------------------------------------------------------------------------
        ElseIf Me.dgvPayment.Columns(e.ColumnIndex).Name = "MediaNo" AndAlso Me.dgvPayment.EditingControl.Text.Trim <> "" AndAlso Me.dgvPayment.EditingControl.Text.Trim.IndexOf("*") = -1 AndAlso Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 1 Then
            Dim sMediaNo As String = Me.dgvPayment.EditingControl.Text.Trim
            If Not IsNumeric(sMediaNo) Then
                MessageBox.Show("银行卡卡号必须由数字组成！请重新输入银行卡卡号。    ", "银行卡卡号必须由数字组成！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
                e.Cancel = True
            ElseIf sMediaNo.Length < 10 Then
                MessageBox.Show("银行卡卡号位数不应低于 10 位！请重新输入银行卡卡号。    ", "银行卡卡号位数不应低于 10 位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
                e.Cancel = True
            ElseIf sMediaNo <> BankCardNo.GetFullCardNo(sMediaNo.Substring(0, sMediaNo.Length - 1)) AndAlso MessageBox.Show("这可能是一张无效的银行卡！    " & Chr(13) & Chr(13) & "您是否确认该卡的卡号正确无误？    ", "该银行卡卡号可能无效！", MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) = Windows.Forms.DialogResult.No Then
                Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
                e.Cancel = True
            End If
            'modify code 008:start-------------------------------------------------------------------------
            'ElseIf Me.dgvPayment.Columns(e.ColumnIndex).Name = "MediaNo" AndAlso Me.dgvPayment.EditingControl.Text.Trim <> "" AndAlso Me.dgvPayment.EditingControl.Text.Trim.IndexOf("*") = -1 AndAlso Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 7 Then
            '    If Not IsNumeric(Me.dgvPayment.EditingControl.Text.Trim) Then
            '        MessageBox.Show("顾客手机号/兑换号为数字！请重新输入。    ", "顾客手机号/兑换号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            '        Me.dgvPayment(e.ColumnIndex, e.RowIndex).Selected = True
            '        e.Cancel = True
            '    End If
            'modify code 008:end-------------------------------------------------------------------------
        End If
    End Sub

    Private Sub dgvPayment_CellValueChanged(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvPayment.CellValueChanged
        If blSkipDeal Then Return
        blSkipDeal = True
        frmMain.statusText.Text = "就绪。"
        Select Case Me.dgvPayment.Columns(e.ColumnIndex).Name
            Case "PaymentTerm"

                'modify code 085:start-------------------------------------------------------------------------
                'If Me.dgvPayment.CurrentCell.Value = 13 Then
                '    Dim dtPaySource As New DataTable
                '    Dim newColumn As New DataGridViewComboBoxColumn
                '    dtPaySource.Columns.Add("MediaNo", System.Type.GetType("System.String"))
                '    dtPaySource.Rows.Add("PR")
                '    dtPaySource.Rows.Add("Promotion")
                '    dtPaySource.Rows.Add("Welfare")
                '    dtPaySource.Rows.Add("Union")
                '    dtPaySource.Rows.Add("Others")

                '    With Me.dgvPayment
                '        With newColumn
                '            .DataPropertyName = "MediaNo"
                '            .DataSource = dtPaySource
                '            .ValueMember = "MediaNo"
                '            .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                '            .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                '        End With
                '        .Columns.RemoveAt(3)
                '        .Columns.Insert(3, newColumn)
                '        With .Columns(3)
                '            .Name = "MediaNo"
                '            .HeaderText = "领卡用途"
                '            .MinimumWidth = 75
                '            .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                '            .SortMode = DataGridViewColumnSortMode.NotSortable
                '            .Resizable = DataGridViewTriState.False
                '            .ReadOnly = False
                '        End With
                '        With .Columns(4)
                '            .Name = "PayerName"
                '            .HeaderText = "领卡部门"
                '            .MinimumWidth = 75
                '            .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                '            .SortMode = DataGridViewColumnSortMode.NotSortable
                '            .Resizable = DataGridViewTriState.False
                '            .ReadOnly = False
                '        End With
                '    End With
                'Else
                '    With Me.dgvPayment
                '        Dim newColumn As New DataGridViewTextBoxColumn
                '        .Columns.RemoveAt(3)
                '        .Columns.Insert(3, newColumn)
                '        With .Columns(3)
                '            .Name = "MediaNo"
                '            .HeaderText = "卡/账/支票号/兑换号"
                '            .MinimumWidth = 75
                '            .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                '            .SortMode = DataGridViewColumnSortMode.NotSortable
                '            .Resizable = DataGridViewTriState.False
                '        End With
                '        With .Columns(4)
                '            .Name = "PayerName"
                '            .HeaderText = "持卡人/付款单位"
                '            .MinimumWidth = 75
                '            .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                '            .SortMode = DataGridViewColumnSortMode.NotSortable
                '            .Resizable = DataGridViewTriState.False
                '        End With
                '    End With
                'End If
                'modify code 085:end-------------------------------------------------------------------------

                'modify code 044:start-------------------------------------------------------------------------
                'TODO
                '[已支付金额]为不可选择的支付方式
                If Me.dgvPayment.CurrentCell.Value = 8 OrElse Me.dgvPayment.CurrentCell.Value = 11 Then
                    MessageBox.Show("[已支付金额]为不可选择的支付方式！请重新选择。", "支付方式选择错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "支付方式选择错误！"
                    Me.dgvPayment.CurrentCell.Value = 0
                    Me.dgvPayment.CurrentCell.Selected = True
                End If
                'modify code 044:end-------------------------------------------------------------------------
                'modify code 008:start-------------------------------------------------------------------------
                If Me.dgvPayment.CurrentCell.Value = 7 AndAlso Me.dgvPayment.RowCount > 1 Then
                    MessageBox.Show("积分兑换支付方式不能与其他支付方式混合使用！请重新选择。", "支付方式选择错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "支付方式选择错误！"
                    Me.dgvPayment.CurrentCell.Value = 0
                    Me.dgvPayment.CurrentCell.Selected = True
                End If
                'modify code 008:end-------------------------------------------------------------------------
                If Me.dgvPayment.CurrentCell.Value = 0 Then '现金
                    Me.dgvPayment("MediaNo", e.RowIndex).Value = DBNull.Value : Me.dgvPayment("MediaNo", e.RowIndex).ReadOnly = True
                    Me.dgvPayment("PayerName", e.RowIndex).Value = DBNull.Value : Me.dgvPayment("PayerName", e.RowIndex).ReadOnly = True
                    'modify code 008:start-------------------------------------------------------------------------
                ElseIf Me.dgvPayment.CurrentCell.Value = 7 Then
                    Me.dgvPayment("MediaNo", e.RowIndex).Value = ""
                    Me.dgvPayment("MediaNo", e.RowIndex).ReadOnly = False
                    'Me.dgvPayment("PayerName", e.RowIndex).Value = "中移电子商务有限公司"
                    Me.dgvPayment("PayerName", e.RowIndex).Value = ""
                    'Me.dgvPayment("PayerName", e.RowIndex).ReadOnly = True
                    Me.dgvPayment("PayerName", e.RowIndex).ReadOnly = False
                    'modify code 008:end-------------------------------------------------------------------------
                Else

                    'modify code 085:start-------------------------------------------------------------------------
                    'If e.RowIndex < 1 Then Return
                    'modify code 085:end-------------------------------------------------------------------------

                    Me.dgvPayment("MediaNo", e.RowIndex).ReadOnly = False
                    Me.dgvPayment("PayerName", e.RowIndex).ReadOnly = False
                    If Me.dgvPayment.CurrentCell.Value = 1 AndAlso drSalesBill("BuyerName").ToString <> "" Then Me.dgvPayment("PayerName", e.RowIndex).Value = drSalesBill("BuyerName").ToString
                    If drSalesBill("CustomerType") = 1 AndAlso Me.dgvPayment.CurrentCell.Value > 1 Then Me.dgvPayment("PayerName", e.RowIndex).Value = Me.txbCustomerName.Text
                    If Me.dgvPayment("MediaNo", e.RowIndex).Value.ToString <> "" AndAlso (Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 3 OrElse Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 4 OrElse Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 6) Then '支票
                        Dim blMediaNoRepeated As Boolean = False
                        For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                            If drPayment.Index <> e.RowIndex AndAlso Me.dgvPayment("PaymentTerm", e.RowIndex).Value.ToString = drPayment.Cells("PaymentTerm").Value.ToString AndAlso Me.dgvPayment("MediaNo", e.RowIndex).Value.ToString = drPayment.Cells("MediaNo").Value.ToString Then blMediaNoRepeated = True : Exit For
                        Next
                        If blMediaNoRepeated Then
                            Me.dgvPayment("MediaNo", e.RowIndex).Value = ""
                            Me.dgvPayment("MediaNo", e.RowIndex).Selected = True
                        End If
                    End If
                End If
                Me.dgvPayment.Refresh()
                If Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentCell.RowIndex).Value.ToString <> "" AndAlso Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentCell.RowIndex).Value.ToString > 0 Then
                    dtSelectablePayment.Select("RowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString)(0)("PaymentTerm") = Me.dgvPayment("PaymentTerm", e.RowIndex).FormattedValue.ToString
                    If dtSelectablePayment.Rows.Count > 1 Then
                        Dim drNormalCard As DataRow
                        For Each drRowPayment As DataRow In dtRowPayment.Select("PaymentRowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString, "CardRowID")
                            drNormalCard = dtNormalCard.Select("RowID=" & drRowPayment("CardRowID").ToString)(0)
                            drNormalCard("PaymentDescription") = Me.FormatPaymentDescription(drNormalCard("RowID").ToString)
                        Next
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                        Me.dgvNormalCard.Refresh()
                    End If
                End If

                'modify code 008:start-------------------------------------------------------------------------
                Me.PaymentSummary()
                'modify code 008:end-------------------------------------------------------------------------

            Case "PaymentAMT"
                If Me.dgvPayment("PaymentAMT", e.RowIndex).Value.ToString <> "" AndAlso (Not IsNumeric(Me.dgvPayment("PaymentAMT", e.RowIndex).Value.ToString) OrElse Me.dgvPayment("PaymentAMT", e.RowIndex).Value < 0) Then Me.dgvPayment("PaymentAMT", e.RowIndex).Value = DBNull.Value
                If Me.dgvPayment("PaymentAMT", e.RowIndex).Value.ToString = "" OrElse Me.dgvPayment("PaymentAMT", e.RowIndex).Value = 0 Then
                    Dim drPayment As DataRow = Nothing, drNormalCard As DataRow = Nothing
                    Try
                        drPayment = dtSelectablePayment.Select("RowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString)(0)
                        drPayment.Delete() : drPayment.AcceptChanges()
                        For Each drRowPayment As DataRow In dtRowPayment.Select("PaymentRowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString)
                            drNormalCard = dtNormalCard.Select("RowID=" & drRowPayment("CardRowID").ToString)(0)
                            drNormalCard("PaymentDescription") = "请分配付款金额……"
                            If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = e.ColumnIndex AndAlso errorNormalCell.RowIndex = e.RowIndex Then
                                errorNormalCell = Nothing : sErrorNormalInfo = ""
                            End If
                            drRowPayment.Delete() : drRowPayment.AcceptChanges()
                        Next
                    Catch
                    End Try

                    For Each dr As DataGridViewRow In Me.dgvPayment.Rows
                        If dr.Index <> e.RowIndex AndAlso (dr.Cells("PaymentAMT").Value.ToString = "" OrElse dr.Cells("PaymentAMT").Value = 0) Then
                            dr.Cells("PaymentAMT").Selected = True
                            Me.menuDeletePayment.PerformClick()
                        End If
                    Next

                    If dtSelectablePayment.Rows.Count < 2 Then
                        For Each drNormalCard In dtNormalCard.Rows
                            drNormalCard("PaymentDescription") = DBNull.Value
                        Next
                        Me.dgvNormalCard.Columns("PaymentDescription").Visible = False
                        dtRowPayment.Rows.Clear() : dtRowPayment.AcceptChanges()
                    Else
                        Me.dgvNormalCard.Columns("PaymentDescription").Visible = True
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    End If
                Else
                    If dtSelectablePayment.Select("RowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString).Length = 0 Then
                        dtSelectablePayment.Rows.Add(0, Me.dgvPayment("RowID", e.RowIndex).Value, Me.dgvPayment("PaymentTerm", e.RowIndex).FormattedValue)
                    End If
                    Dim drNormalCard As DataRow = Nothing
                    For Each drRowPayment As DataRow In dtRowPayment.Select("PaymentRowID=" & Me.dgvPayment("RowID", e.RowIndex).Value.ToString)
                        drNormalCard = dtNormalCard.Select("RowID=" & drRowPayment("CardRowID").ToString)(0)
                        drNormalCard("PaymentDescription") = "请分配付款金额……"
                        If errorNormalCell IsNot Nothing AndAlso errorNormalCell.ColumnIndex = e.ColumnIndex AndAlso errorNormalCell.RowIndex = e.RowIndex Then
                            errorNormalCell = Nothing : sErrorNormalInfo = ""
                        End If
                        drRowPayment.Delete() : drRowPayment.AcceptChanges()
                    Next
                    If dtSelectablePayment.Rows.Count > 1 Then
                        For Each drNormalCard In dtNormalCard.Select("Isnull(StartCardNo,'')<>'' And Isnull(PaymentDescription,'')=''")
                            drNormalCard("PaymentDescription") = "请分配付款金额……"
                        Next
                        Me.dgvNormalCard.Columns("PaymentDescription").Visible = True
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                        frmMain.statusText.Text = "注意：付款单中存在多行付款，请对购物卡列表中的每一行进行付款分配。"
                    End If
                End If
                dtSelectablePayment.AcceptChanges()

                Me.PaymentSummary()
                Try
                    'modify code 008:start-------------------------------------------------------------------------
                    'If Me.dgvPayment("PaymentTerm", e.RowIndex).Value > 0 Then
                    If Me.dgvPayment("PaymentTerm", e.RowIndex).Value > 0 And Me.dgvPayment("PaymentTerm", e.RowIndex).Value <> 7 Then
                        'modify code 008:end-------------------------------------------------------------------------
                        If Me.dgvPayment("MediaNo", e.RowIndex).Value.ToString = "" Then
                            Me.dgvPayment("MediaNo", e.RowIndex).Selected = True
                        ElseIf Me.dgvPayment("PayerName", e.RowIndex).Value.ToString = "" Then
                            Me.dgvPayment("PayerName", e.RowIndex).Selected = True
                        End If
                    Else
                        Dim blSelected As Boolean = False
                        For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                            If drPayment.Cells("PaymentAMT").Value.ToString = "" OrElse drPayment.Cells("PaymentAMT").Value = 0 Then
                                drPayment.Cells("PaymentAMT").Selected = True
                                blSelected = True
                                Exit For
                            End If
                        Next
                        If Not blSelected Then
                            If e.RowIndex = Me.dgvPayment.RowCount - 1 Then
                                Me.dgvPayment("PaymentAMT", e.RowIndex).Selected = True
                            Else
                                Me.dgvPayment("PaymentAMT", e.RowIndex + 1).Selected = True
                            End If
                        End If
                    End If
                Catch
                Finally
                    If Me.dgvPayment.CurrentRow IsNot Nothing Then Me.dgvPayment.CurrentRow.Selected = False
                End Try
            Case "MediaNo"

                'modify code 085:start-------------------------------------------------------------------------
                'If e.RowIndex < 1 Then Return
                'modify code 085:end-------------------------------------------------------------------------

                If Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 3 OrElse Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 4 OrElse Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 6 Then '支票
                    Dim sValue As String = Me.dgvPayment.CurrentCell.Value.ToString, blMediaNoRepeated As Boolean = False
                    If sValue <> "" Then
                        For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                            If drPayment.Index <> e.RowIndex AndAlso Me.dgvPayment("PaymentTerm", e.RowIndex).Value.ToString = drPayment.Cells("PaymentTerm").Value.ToString AndAlso sValue = drPayment.Cells("MediaNo").Value.ToString Then blMediaNoRepeated = True : Exit For
                        Next
                        If blMediaNoRepeated Then
                            MessageBox.Show("此支票号已存在！    " & Chr(13) & Chr(13) & "请重新输入支票号。    ", "支票号重复！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            frmMain.statusText.Text = "支票号重复！请重新输入。"
                            Me.dgvPayment.CurrentCell.Value = ""
                            Me.dgvPayment.CurrentCell.Selected = True
                        End If
                    End If
                ElseIf Me.dgvPayment("PaymentTerm", e.RowIndex).Value = 1 AndAlso Me.dgvPayment.CurrentCell.Value.ToString <> "" AndAlso Me.dgvPayment.CurrentCell.Value.ToString.IndexOf("*") = -1 Then
                    Dim sValue As String = Me.dgvPayment.CurrentCell.Value.ToString
                    Try
                        sValue = StrConv(sValue, VbStrConv.Narrow)
                    Catch
                    End Try
                    sValue = sValue.Substring(0, 6) & StrDup(sValue.Length - 10, "*") & sValue.Substring(sValue.Length - 4, 4)
                    Me.dgvPayment.CurrentCell.Value = sValue
                End If
        End Select
        blSkipDeal = False
    End Sub

    Private Sub dgvPayment_EditingControlShowing(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewEditingControlShowingEventArgs) Handles dgvPayment.EditingControlShowing
        If Me.dgvPayment.CurrentRow.Selected Then
            blSkipDeal = True : Me.dgvPayment.CurrentRow.Selected = False : blSkipDeal = False
        End If
        If Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name <> "PaymentTerm" Then
            Try
                editingTextBox = CType(e.Control, TextBox)
                RemoveHandler editingTextBox.KeyDown, AddressOf CardNo_KeyDown
                RemoveHandler editingTextBox.KeyDown, AddressOf CardQTY_KeyDown
                RemoveHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
                RemoveHandler editingTextBox.KeyDown, AddressOf MediaNo_KeyDown
                RemoveHandler editingTextBox.KeyDown, AddressOf PayerName_KeyDown
                RemoveHandler editingTextBox.TextChanged, AddressOf editingTextBox_TextChanged
                RemoveHandler editingTextBox.TextChanged, AddressOf Money_TextChanged
                If Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name = "PaymentAMT" Then
                    editingTextBox.ImeMode = Windows.Forms.ImeMode.Disable
                    editingTextBox.Text = editingTextBox.Text.Replace(",", "")
                    AddHandler editingTextBox.KeyDown, AddressOf Money_KeyDown
                    AddHandler editingTextBox.TextChanged, AddressOf Money_TextChanged
                ElseIf Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name = "MediaNo" Then
                    editingTextBox.ImeMode = Windows.Forms.ImeMode.Disable
                    AddHandler editingTextBox.KeyDown, AddressOf MediaNo_KeyDown
                ElseIf Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name = "PayerName" Then
                    editingTextBox.ImeMode = Windows.Forms.ImeMode.NoControl
                    AddHandler editingTextBox.KeyDown, AddressOf PayerName_KeyDown
                End If
            Catch
            End Try
        End If
    End Sub

    Private Sub dgvPayment_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles dgvPayment.KeyDown
        If e.KeyCode = Keys.Delete AndAlso Me.dgvPayment.CurrentRow.Selected = True AndAlso drSalesBill("SalesBillType") = 0 AndAlso dtPayment.Select("RowID=" & Me.dgvPayment("RowID", Me.dgvPayment.CurrentRow.Index).Value.ToString)(0).RowState = DataRowState.Added AndAlso Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Value.ToString <> "" Then
            Me.menuDeletePayment.PerformClick()
            e.SuppressKeyPress = True
        End If
    End Sub

    Private Sub dgvPayment_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvPayment.Leave
        Dim clickedControl As Control = Me.tlpPayment.GetChildAtPoint(Me.tlpPayment.PointToClient(Control.MousePosition))
        If clickedControl IsNot Nothing AndAlso clickedControl.Name = "btnModifyPaymentInfo" Then Return

        frmMain.statusText.Text = "就绪。"
        blSkipDeal = True
        If Me.dgvPayment.CurrentCell IsNot Nothing Then Me.dgvPayment.CurrentCell.Selected = False
        If Me.dgvPayment.CurrentRow IsNot Nothing Then Me.dgvPayment.CurrentRow.Selected = False
        Me.btnModifyPaymentInfo.Visible = False
        blSkipDeal = False
    End Sub

    Private Sub dgvPayment_SelectionChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles dgvPayment.SelectionChanged
        If blSkipDeal OrElse Me.dgvPayment.CurrentCell Is Nothing Then Return
        blSkipDeal = True
        If frmMain.statusText.Text.IndexOf("注意") = -1 Then frmMain.statusText.Text = "就绪。"

        'modify code 044:start-------------------------------------------------------------------------
        'TODO
        '线下支付行不可编辑
        If Me.dgvPayment.CurrentRow.Cells(1).Value = 11 OrElse Me.dgvPayment.CurrentRow.Cells(1).Value = 8 Then
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditProgrammatically
            Me.dgvPayment("PayerName", Me.dgvPayment.CurrentRow.Index).Selected = True
            Me.dgvPayment.CurrentRow.Selected = True
            blSkipDeal = False
            Return
        End If
        'modify code 044:end-------------------------------------------------------------------------

        If Me.dgvPayment.ReadOnly OrElse bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
            Me.dgvPayment.CurrentRow.Selected = True
            Me.btnModifyPaymentInfo.Visible = (Me.dgvPayment.Focused AndAlso drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("SalesBillState") < 9 AndAlso Me.dgvPayment("ValidationState", Me.dgvPayment.CurrentRow.Index).Value.ToString <> "已确认到账")
        ElseIf Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name = "RowID" Then
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditProgrammatically
            Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Selected = True
            Me.dgvPayment.CurrentRow.Selected = True
            If dtPayment.Select("RowID=" & Me.dgvPayment("RowID", Me.dgvPayment.CurrentRow.Index).Value.ToString)(0).RowState = DataRowState.Added AndAlso Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Value.ToString <> "" Then frmMain.statusText.Text = "提示：按<Delete>键可删除该行。"
            'modify code 008:start-------------------------------------------------------------------------
            'ElseIf dtPayment.Select("RowID<>" & (Me.dgvPayment.CurrentRow.Index + 1).ToString & " And PaymentTerm>0 And Isnull(PaymentAMT,0)>0 And (Isnull(MediaNo,'')='' Or Isnull(PayerName,'')='')").Length > 0 Then
        ElseIf dtPayment.Select("RowID<>" & (Me.dgvPayment.CurrentRow.Index + 1).ToString & " And PaymentTerm>0 and PaymentTerm<>7 And Isnull(PaymentAMT,0)>0 And (Isnull(MediaNo,'')='' Or Isnull(PayerName,'')='')").Length > 0 Then
            'modify code 008:end-------------------------------------------------------------------------
            For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                If drPayment.Cells("PaymentTerm").Value > 0 AndAlso (drPayment.Cells("MediaNo").Value.ToString = "" OrElse drPayment.Cells("PayerName").Value.ToString = "") Then
                    Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                    If drPayment.Cells("MediaNo").Value.ToString = "" Then
                        drPayment.Cells("MediaNo").Selected = True
                        Select Case drPayment.Cells("PaymentTerm").Value
                            Case 1 '银行卡
                                frmMain.statusText.Text = "当付款方式是""银行卡""时，银行卡卡号不能为空！请输入银行卡卡号。"
                            Case 2, 5 '转账
                                frmMain.statusText.Text = "当付款方式是""转账""时，转账账号不能为空！请输入转账账号。"
                            Case Else '支票
                                frmMain.statusText.Text = "当付款方式是""支票""时，支票号不能为空！请输入支票号。"
                        End Select
                    Else
                        drPayment.Cells("PayerName").Selected = True
                        Select Case drPayment.Cells("PaymentTerm").Value
                            Case 1 '银行卡
                                frmMain.statusText.Text = "当付款方式是""银行卡""时，持卡人姓名不能为空！请输入持卡人姓名。"
                            Case 2, 5 '转账
                                frmMain.statusText.Text = "当付款方式是""转账""时，付款单位不能为空！请输入付款单位。"
                            Case Else '支票
                                frmMain.statusText.Text = "当付款方式是""支票""时，付款单位不能为空！请输入付款单位。"
                        End Select
                    End If
                    Exit For
                End If
            Next
        ElseIf Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name <> "PaymentTerm" AndAlso Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Value.ToString = "" Then
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
            If Me.dgvPayment.Columns(Me.dgvPayment.CurrentCell.ColumnIndex).Name <> "PaymentAMT" Then
                Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Selected = True
                frmMain.statusText.Text = "请先输入付款金额。"
            End If
        ElseIf Me.dgvPayment.CurrentCell.ReadOnly = True Then
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditProgrammatically
            Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Selected = True
            Me.dgvPayment.CurrentRow.Selected = True
            If dtPayment.Select("RowID=" & Me.dgvPayment("RowID", Me.dgvPayment.CurrentRow.Index).Value.ToString)(0).RowState = DataRowState.Added AndAlso Me.dgvPayment("PaymentAMT", Me.dgvPayment.CurrentRow.Index).Value.ToString <> "" Then frmMain.statusText.Text = "提示：按<Delete>键可删除该行。"
        Else
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
            Me.dgvPayment.BeginEdit(True)
        End If
        blSkipDeal = False
    End Sub

    Private Sub menuDeletePayment_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles menuDeletePayment.Click
        blSkipDeal = True
        Dim iCurrentRow As Integer = Me.dgvPayment.CurrentRow.Index, drPayment As DataRow = dtPayment.Select("RowID=" & Me.dgvPayment("RowID", iCurrentRow).Value.ToString)(0)

        'modify code 006:start-------------------------------------------------------------------------
        If iCurrentRow = 0 And drPayment("PaymentAMT") = 0 Then
            Exit Sub
        End If
        'modify code 006:end-------------------------------------------------------------------------

        For Each drRowPayment As DataRow In dtRowPayment.Select("PaymentRowID=" & (iCurrentRow + 1).ToString)
            drRowPayment.Delete() : drRowPayment.AcceptChanges()
        Next
        If dtSelectablePayment.Select("RowID=" & (iCurrentRow + 1).ToString).Length > 0 Then dtSelectablePayment.Select("RowID=" & (iCurrentRow + 1).ToString)(0).Delete()
        drPayment.Delete()

        If iCurrentRow < Me.dgvPayment.RowCount Then
            Dim drSelectablePayment As DataRow
            For Each drPayment In dtPayment.Select("RowID>" & (iCurrentRow + 1))
                If drPayment("PaymentAMT").ToString <> "" AndAlso drPayment("PaymentAMT") > 0 Then
                    drSelectablePayment = dtSelectablePayment.Select("RowID=" & drPayment("RowID").ToString)(0)
                    drSelectablePayment("RowID") = drPayment("RowID") - 1
                    For Each drRowPayment As DataRow In dtRowPayment.Select("PaymentRowID=" & drPayment("RowID").ToString)
                        drRowPayment("PaymentRowID") = drPayment("RowID") - 1
                    Next
                End If
                drPayment("RowID") = drPayment("RowID") - 1
            Next
        End If

        dtSelectablePayment.AcceptChanges() : dtRowPayment.AcceptChanges()

        If dtSelectablePayment.Rows.Count < 2 Then
            For Each drNormalCard As DataRow In dtNormalCard.Rows
                drNormalCard("PaymentDescription") = DBNull.Value
            Next
            Me.dgvNormalCard.Columns("PaymentDescription").Visible = False
            dtRowPayment.Rows.Clear() : dtRowPayment.AcceptChanges()
        Else
            For Each drNormalCard As DataRow In dtNormalCard.Rows
                If drNormalCard("StartCardNo").ToString <> "" Then
                    drNormalCard("PaymentDescription") = Me.FormatPaymentDescription(drNormalCard("RowID").ToString)
                    If drNormalCard("PaymentDescription") = "请分配付款金额……" Then
                        If errorNormalCell IsNot Nothing AndAlso Me.dgvNormalCard.Columns(errorNormalCell.ColumnIndex).Name = "PaymentDescription" AndAlso errorNormalCell.RowIndex = drNormalCard("RowID") + 1 Then
                            errorNormalCell = Nothing : sErrorNormalInfo = ""
                        End If
                    End If
                End If
            Next
            Me.dgvNormalCard.Columns("PaymentDescription").Visible = True
            Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
            Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
            Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
        End If

        If dtPayment.Compute("Sum(PaymentAMT)", "").ToString = "" Then dmReceivedAMT = 0 Else dmReceivedAMT = dtPayment.Compute("Sum(PaymentAMT)", "")
        drSalesBill("ReceivedAMT") = dmReceivedAMT
        Me.PaymentSummary()

        If iCurrentRow > Me.dgvPayment.RowCount - 1 Then iCurrentRow = Me.dgvPayment.RowCount - 1
        If Me.dgvPayment("PaymentAMT", iCurrentRow).Value.ToString = "" OrElse Me.dgvPayment("PaymentAMT", iCurrentRow).Value = 0 Then
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
            Me.dgvPayment("PaymentAMT", iCurrentRow).Selected = True
            Me.dgvPayment.BeginEdit(True)
            frmMain.statusText.Text = "就绪。"
        Else
            Me.dgvPayment.EditMode = DataGridViewEditMode.EditProgrammatically
            Me.dgvPayment("PaymentAMT", iCurrentRow).Selected = True
            Me.dgvPayment.CurrentRow.Selected = True
        End If
        blSkipDeal = False
    End Sub

    Private Sub btnModifyPaymentInfo_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnModifyPaymentInfo.Click
        If frmMain.dtAllowedRight.Select("RightName='SalesBillPaymentModify'").Length = 0 Then
            MessageBox.Show("对不起！您没有修改付款信息的权限。    ", "您无权修改付款信息！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnModifyPaymentInfo.Enabled = False
            Return
        End If

        Dim drPayment As DataRow = dtPayment.Select("RowID=" & Me.dgvPayment("RowID", Me.dgvPayment.CurrentRow.Index).Value.ToString)(0), sPaymentTermName As String = Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentRow.Index).FormattedValue.ToString
        With frmModifyPaymentInfo
            .dmPayableAMT = dmPayableAMT
            With .cbbPaymentTerm
                With .Items
                    If Me.dgvPayment("ValidationState", Me.dgvPayment.CurrentRow.Index).Value.ToString = "保证金已确认" Then
                        .Add("支票＋保证金")
                        frmModifyPaymentInfo.txbPaymentTerm.Visible = True
                        frmModifyPaymentInfo.cbbPaymentTerm.Visible = False
                    ElseIf sPaymentTermName.IndexOf("_后付") > -1 Then
                        .Add("转账_后付")
                        .Add("支票_后付")
                    Else
                        If drSalesBill("RebateMode") <> 2 OrElse drSalesBill("CardCost") <> 0 Then
                            .Add("现金")
                            .Add("银行卡")
                        End If
                        .Add("转账")
                        .Add("支票")
                        .Add("支票＋保证金")
                        'modify code 008,040:start-------------------------------------------------------------------------
                        'If dtCityPaymentTerm.Rows.Count > 0 Then
                        If dtCityPaymentTerm.Select("PaymentTerm=7").Length > 0 Then
                            'modify code 046,054,072:start-------------------------------------------------------------------------
                            '同一般销售单
                            'If bNewSalesBillType = 0 And Me.dgvPayment.RowCount <= 1 Then
                            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) And Me.dgvPayment.RowCount <= 1 Then
                            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) And Me.dgvPayment.RowCount <= 1 Then
                                'modify code 046,054,072:end-------------------------------------------------------------------------
                                .Add("积分兑换")
                            End If
                        End If
                        'modify code 008,040:end-------------------------------------------------------------------------
                    End If
                End With
                .Text = sPaymentTermName
            End With
            .txbPaymentTerm.Text = sPaymentTermName
            .txbPaymentAMT.Text = Format(drPayment("PaymentAMT"), "#,0.00")
            .txbMediaNo.Text = drPayment("MediaNo").ToString
            .txbPayerName.Text = drPayment("PayerName").ToString
            If .ShowDialog = Windows.Forms.DialogResult.OK Then
                Select Case .cbbPaymentTerm.Text
                    Case "现金"
                        drPayment("PaymentTerm") = 0
                        drPayment("MediaNo") = DBNull.Value
                        drPayment("PayerName") = DBNull.Value
                        drPayment("ValidationState") = "现金已收"
                        'modify code 008:start-------------------------------------------------------------------------
                    Case "积分兑换"
                        drPayment("PaymentTerm") = 7
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = "积分兑换已收"
                        'modify code 008:end-------------------------------------------------------------------------
                    Case "银行卡"
                        drPayment("PaymentTerm") = 1
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = "已刷卡"
                    Case "转账"
                        drPayment("PaymentTerm") = 2
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = "转账已登记"
                    Case "支票"
                        drPayment("PaymentTerm") = 3
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = "支票已收"
                    Case "支票＋保证金"
                        drPayment("PaymentTerm") = 4
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = IIf(Me.dgvPayment("ValidationState", Me.dgvPayment.CurrentRow.Index).Value.ToString = "保证金已确认", "保证金已确认", "支票、现金已收")
                    Case "转账_后付"
                        drPayment("PaymentTerm") = 5
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = IIf(Me.dgvPayment("ValidationState", Me.dgvPayment.CurrentRow.Index).Value.ToString = "还未确认到账！", "还未确认到账！", "转账已登记")
                    Case Else
                        drPayment("PaymentTerm") = 6
                        drPayment("MediaNo") = .txbMediaNo.Text.Trim
                        drPayment("PayerName") = .txbPayerName.Text.Trim
                        drPayment("ValidationState") = IIf(Me.dgvPayment("ValidationState", Me.dgvPayment.CurrentRow.Index).Value.ToString = "还未确认到账！", "还未确认到账！", "支票已收")
                End Select
                If drPayment("PaymentTerm", DataRowVersion.Original) <> drPayment("PaymentTerm") AndAlso dtPayment.Rows.Count > 1 Then
                    Dim drNormalCard As DataRow
                    For Each drRowPayment As DataRow In dtRowPayment.Select("PaymentRowID=" & drPayment("RowID").ToString, "CardRowID")
                        drNormalCard = dtNormalCard.Select("RowID=" & drRowPayment("CardRowID").ToString)(0)
                        drNormalCard("PaymentDescription") = Me.FormatPaymentDescription(drNormalCard("RowID").ToString)
                        drNormalCard.AcceptChanges()
                    Next
                    Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                    Me.dgvNormalCard.Columns("PaymentDescription").Width += 0
                    Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    Me.dgvNormalCard.Refresh()
                End If
            End If
            .Dispose()
        End With

        drPayment.AcceptChanges()
        drPayment = Nothing
        'modify code 008:start-------------------------------------------------------------------------
        If dtPayment.Rows(0)("PaymentTerm") = 7 Then
            Me.btnPrintInvoice.Enabled = False
        Else
            Me.btnPrintInvoice.Enabled = True
        End If
        'modify code 008:end-------------------------------------------------------------------------
        Me.dgvPayment.Select()
    End Sub

    Private Sub dtpRefundDate_ValueChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles dtpRefundDate.ValueChanged
        If blSkipDeal OrElse Not Me.dtpRefundDate.Visible Then Return
        Me.txbRefundDate.Text = Format(Me.dtpRefundDate.Value, "yyyy\/MM\/dd")
        drSalesBill("RefundDate") = CDate(Format(Me.dtpRefundDate.Value, "yyyy\/MM\/dd"))
    End Sub

    Private Sub txbRefundNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txbRefundNo.KeyDown
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub txbRefundNo_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txbRefundNo.Leave
        If Me.txbRefundNo.ReadOnly Then Return
        If Me.txbRefundNo.Text <> Me.txbRefundNo.Text.Trim Then Me.txbRefundNo.Text = Me.txbRefundNo.Text.Trim
        If drSalesBill("RefundNo").ToString <> Me.txbRefundNo.Text Then drSalesBill("RefundNo") = Me.txbRefundNo.Text
    End Sub

    Private Sub btnOK_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnOK.Click

        If sSalesBillID = "-1" Then '保存新建的销售单
            Me.SaveChanges()
            Return
        End If

        '取消销售单
        If Me.btnOK.Text.IndexOf("申请取消") > -1 Then
            If frmMain.dtAllowedRight.Select("RightName='SalesBillCancel'").Length = 0 Then
                MessageBox.Show("对不起！您没有申请取消销售单的权限。    ", "您无权申请取消销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnOK.Enabled = False
                Return
            End If

            If drSalesBill("ActivationCancelledAMT").ToString <> drSalesBill("ChargedAMT").ToString AndAlso drSalesBill("SalesBillState") > 0 Then
                MessageBox.Show("仅当销售单处于""等待激活""或""已被撤销激活""状态时，才可以被申请取消！    " & Chr(13) & Chr(13) & "目前销售单不处于""等待激活""或""已被撤销激活""状态，所以不再可以取消。    ", "销售单不能被取消！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnOK.Enabled = False
                Return
            End If

            If frmMain.sLoginAreaType <> "H" AndAlso dtPayment.Select("PaymentTerm>1 And ValidationState='已确认到账'").Length > 0 Then
                MessageBox.Show("总部金融服务部最新规定：    " & Chr(13) & Chr(13) & "当付款方式中的转账或支票已被城市JV确认到账后，销售单不再可以被取消！    " & Chr(13) & Chr(13) & "请联系总部金融服务部。    ", "销售单不能被取消！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnOK.Enabled = False
                Return
            End If

            'If frmCancelSalesBill.ShowDialog() = Windows.Forms.DialogResult.OK AndAlso dtActivation IsNot Nothing Then
            '    dtActivation.Dispose() : dtActivation = Nothing : sActivationLoadedTime = ""
            'End If

            ''modify code 046:start-------------------------------------------------------------------------
            'updateSignCardType("非实名制卡", "申请取消")
            ''modify code 046:end-------------------------------------------------------------------------

            ''modify code 063:start-------------------------------------------------------------------------
            If frmCancelSalesBill.ShowDialog() = Windows.Forms.DialogResult.OK Then
                updateSignCardType("非实名制卡", "申请取消")

                If dtActivation IsNot Nothing Then
                    dtActivation.Dispose() : dtActivation = Nothing : sActivationLoadedTime = ""
                End If
            End If
            ''modify code 063:end-------------------------------------------------------------------------

            frmCancelSalesBill.Dispose()
        ElseIf Me.btnOK.Text.IndexOf("撤销取消") > -1 Then
            If drSalesBill("CancellerID").ToString <> frmMain.sLoginUserID Then
                MessageBox.Show("对不起！非取消销售单申请者本人无权撤销由他人提交的取消销售单申请。    ", "您无权撤销取消销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnOK.Enabled = False
                Return
            End If

            Me.Cursor = Cursors.WaitCursor
            frmMain.statusText.Text = "正在撤销取消销售单……"
            frmMain.statusMain.Refresh()

            Dim DB As New DataBase()
            DB.Open()
            If Not DB.IsConnected Then
                frmMain.statusText.Text = "系统因连接不到数据库而无法撤销取消销售单。请检查数据库连接。"
                Me.Cursor = Cursors.Default : Return
            End If

            Dim dtResult As DataTable = DB.GetDataTable("Exec SalesBillRemoveCancellation " & sSalesBillID & "," & IIf(drSalesBill("ActivationCancelledAMT").ToString = drSalesBill("ChargedAMT").ToString, 1, 0).ToString & ",'" & frmMain.sLoginUserRealName.Replace("'", "''") & "'," & frmMain.sSSID)
            DB.Close()
            If dtResult Is Nothing Then
                frmMain.statusText.Text = "撤销取消销售单失败！"
            ElseIf dtResult.Rows(0)("Result").ToString = "Error" Then
                MessageBox.Show("撤销取消销售单时出现错误！下面是数据库的内部错误提示：    " & Chr(13) & Chr(13) & dtResult.Rows(0)("ErrorInfo").ToString & Space(4) & Chr(13) & Chr(13) & "请放弃保存，在关闭窗口后重试。如果仍有问题，请联系软件开发人员。    ", "保存销售单失败！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                frmMain.statusText.Text = "撤销取消销售单失败！"
            ElseIf dtResult.Rows(0)("Result").ToString = "SalesBillDeleted" Then
                MessageBox.Show("销售单取消申请已被确认，不可撤销！    ", "销售单取消申请已被确认！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.ResetInterfaceWhenSalesBillDeleted(dtResult.Rows(0))
                frmMain.statusText.Text = "销售单取消申请已被确认！"
            Else
                If drSalesBill("ActivationCancelledAMT").ToString <> drSalesBill("ChargedAMT").ToString Then
                    drSalesBill("SalesBillState") = 0
                Else
                    drSalesBill("SalesBillState") = 4
                End If
                drSalesBill.AcceptChanges()
                For Each drNormalCard As DataRow In dtNormalCard.Rows
                    drNormalCard("ActivationState") = "等待激活"
                    drNormalCard("StateReason") = DBNull.Value
                    drNormalCard.AcceptChanges()
                Next
                For Each drRebateCard As DataRow In dtRebateCard.Rows
                    drRebateCard("ActivationState") = "等待激活"
                    drRebateCard("StateReason") = DBNull.Value
                    drRebateCard.AcceptChanges()
                Next
                If dtActivation IsNot Nothing Then dtActivation.Dispose() : dtActivation = Nothing : sActivationLoadedTime = ""
                Me.FillSalesBill()
                If frmSalesBillManagement.IsHandleCreated Then
                    Try
                        Dim currentSalesBill As DataRow = frmSalesBillManagement.dvSalesBill.Table.Rows.Find(drSalesBill("SalesBillID").ToString)
                        If drSalesBill("ActivationCancelledAMT").ToString = drSalesBill("ChargedAMT").ToString Then
                            currentSalesBill("SalesBillState") = "已撤销激活"
                        Else
                            currentSalesBill("SalesBillState") = "等待激活"
                        End If
                        currentSalesBill.AcceptChanges()
                        currentSalesBill = Nothing
                        If frmSalesBillManagement.dgvList.CurrentRow IsNot Nothing Then
                            frmSalesBillManagement.dgvList.CurrentRow.Selected = False
                            frmSalesBillManagement.dgvList.CurrentRow.Selected = True
                        Else
                            frmSalesBillManagement.btnOpen.Enabled = False
                        End If
                    Catch
                    End Try
                End If
                frmMain.statusText.Text = "撤销取消销售单成功。"
                'modify code 046:start-------------------------------------------------------------------------
                updateSignCardType("实名制卡", "撤销取消")
                'modify code 046:end-------------------------------------------------------------------------
            End If
            Me.Cursor = Cursors.Default
        Else
            If frmMain.dtAllowedRight.Select("RightName='SalesBillDelete'").Length = 0 Then
                MessageBox.Show("对不起！您没有确认取消销售单的权限。    ", "您无权确认取消销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.btnOK.Enabled = False
                Return
            End If

            With frmConfirmCancelSalesBill
                .drSalesBill = drSalesBill
                .ShowDialog()
                .Dispose()
            End With
        End If
    End Sub

    Private Sub btnPrintTicket_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnPrintTicket.Click
        If Me.btnPrintTicket.Text.IndexOf("重") = -1 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillTicketPrint'").Length = 0 Then
            MessageBox.Show("对不起！您没有打印销售小票的权限。    ", "您无权打印销售小票！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnPrintTicket.Enabled = False
            Return
        End If

        If Me.btnPrintTicket.Text.IndexOf("重") > -1 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillTicketReprint'").Length = 0 Then
            MessageBox.Show("对不起！您没有重打印销售小票的权限。    ", "您无权重打印销售小票！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnPrintTicket.Enabled = False
            Return
        End If

        If My.Settings.TicketPrinter = "" Then
            frmConfigTicket.Text = "未指定小票打印机，请先指定打印机："
            Me.btnConfigTicket.PerformClick()
            If My.Settings.TicketPrinter = "" Then Return
        End If

        Dim sTask As String = IIf(Me.btnPrintTicket.Text.IndexOf("重") = -1, "", "重") & "打印小票"
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在" & sTask & "……"
        frmMain.statusMain.Refresh()

        Dim DB As New DataBase()
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & sTask & "。请检查数据库连接。"
            Me.Activate() : Me.Cursor = Cursors.Default : Return
        End If

        Dim dtResult As DataTable = DB.GetDataTable("Exec PrintTicket " & sSalesBillID & "," & IIf(drSalesBill("TicketPrintedTimes") = 0, "1", "0") & ",'" & frmMain.sLoginUserRealName.Replace("'", "''") & "'," & frmMain.sSSID)
        If dtResult Is Nothing Then
            frmMain.statusText.Text = sTask & "失败！"
            DB.Close()
            Me.Activate() : Me.Cursor = Cursors.Default : Return
        ElseIf dtResult.Rows(0)("Result").ToString <> "OK" Then
            Select Case dtResult.Rows(0)("Result").ToString
                Case "SalesBillDeleted"
                    MessageBox.Show("当前销售单已被取消！不能" & sTask & "。    ", "不能" & sTask & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.ResetInterfaceWhenSalesBillDeleted(dtResult.Rows(0))
                    frmMain.statusText.Text = "当前销售单已被取消！"
                Case "SalesBillCanceled"
                    MessageBox.Show("当前销售单已被申请取消！不能" & sTask & "。    ", "不能" & sTask & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.ResetInterfaceWhenSalesBillCancelled(dtResult.Rows(0))
                    frmMain.statusText.Text = "当前销售单已被申请取消！"
                Case Else
                    MessageBox.Show(sTask & "时出现错误！下面是数据库的内部错误提示：    " & Chr(13) & Chr(13) & dtResult.Rows(0)("ErrorInfo").ToString & Space(4) & Chr(13) & Chr(13) & "请放弃" & sTask & "，在关闭窗口后重试。如果仍有问题，请联系软件开发人员。    ", sTask & "失败！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = sTask & "失败！"
            End Select

            dtResult.Dispose() : dtResult = Nothing : DB.Close()
            Me.Activate() : Me.Cursor = Cursors.Default : Return
        End If

        sTicketPrintedTime = Format(dtResult.Rows(0)("PrintedTime"), "yyyy\/MM\/dd HH:mm")
        dtResult.Dispose() : dtResult = Nothing

        'modify code 005:start-------------------------------------------------------------------------
        'dtCardListInTicket = dtNormalCard.DefaultView.ToTable(False, "RowID", "StartCardNo", "EndCardNo", "CardQTY", "FaceValue", "ChargedAMT", "PayableAMT")
        dtCardListInTicket = dtNormalCard.DefaultView.ToTable(False, "RowID", "StartCardNo", "EndCardNo", "CardQTY", "FaceValue", "CardCost", "ChargedAMT", "PayableAMT")
        If dtRebateCard.Rows.Count > 0 Then
            'dtCardListInTicket.Rows.Add(DBNull.Value, "以下列表是营销卡" & IIf(drSalesBill("RebateState").ToString = "0" OrElse drSalesBill("RebateState").ToString = "1", "（需审核）：", "："))
            dtCardListInTicket.Rows.Add(DBNull.Value, " ")
            dtCardListInTicket.Rows.Add(DBNull.Value, " ")
            dtCardListInTicket.Rows.Add(DBNull.Value, "以下列表是购买福卡抵用券信息" & IIf(drSalesBill("RebateState").ToString = "0" OrElse drSalesBill("RebateState").ToString = "1", "（需审核）：", "："))
            'dtCardListInTicket.Merge(dtRebateCard.DefaultView.ToTable(False, "RowID", "StartCardNo", "EndCardNo", "CardQTY", "FaceValue", "ChargedAMT", "PayableAMT"))
            For iRow As Integer = 0 To Me.dtRebateCard.Rows.Count - 1
                dtCardListInTicket.Rows.Add(Me.dtRebateCard.Rows(iRow).Item("RowID").ToString, Me.dtRebateCard.Rows(iRow).Item("StartCardNo").ToString, _
                                            Me.dtRebateCard.Rows(iRow).Item("EndCardNo").ToString, Me.dtRebateCard.Rows(iRow).Item("CardQTY").ToString, _
                                            Me.dtRebateCard.Rows(iRow).Item("FaceValue").ToString, Format(0, "#,0.00"), Me.dtRebateCard.Rows(iRow).Item("ChargedAMT").ToString, _
                                            Me.dtRebateCard.Rows(iRow).Item("PayableAMT").ToString)
            Next
            dtCardListInTicket.AcceptChanges()
            'modify code 005:end-------------------------------------------------------------------------
        End If

        If Not blCheckTicketPrinter Then
            Dim sPrinterName As String = "", sDriverName As String = ""
            Try
                Dim WMI As New System.Management.ManagementObjectSearcher("SELECT * FROM Win32_Printer"), WMER As System.Management.PropertyDataCollection.PropertyDataEnumerator
                For Each WMIOBJ As System.Management.ManagementObject In WMI.Get
                    WMER = WMIOBJ.Properties.GetEnumerator : sPrinterName = "" : sDriverName = ""
                    While WMER.MoveNext
                        With WMER.Current
                            If .Name.ToLower = "name" Then sPrinterName = .Value.ToString
                            If .Name.ToLower = "drivername" Then sDriverName = .Value.ToString
                            If sPrinterName <> "" AndAlso sDriverName <> "" Then Exit While
                        End With
                    End While
                    If sPrinterName = My.Settings.TicketPrinter Then Exit For
                Next
                WMI = Nothing
            Catch
                If My.Settings.TicketPrinter.ToLower.IndexOf("epson") > -1 Then sDriverName = "EPSON LQ-735K ESC/P2" Else sDriverName = ""
            End Try

            If sDriverName.ToLower.IndexOf("epson ") = 0 Then blIsMultiPaper = True Else blIsMultiPaper = False
            blCheckTicketPrinter = True
        End If

        If blIsMultiPaper Then
            iTicketPageCount = Math.Truncate((dtCardListInTicket.Rows.Count + 7 - 1) / 20) + 1 '需要打印的行数 + 页尾可容纳行数
        Else
            'modify code 060:start-------------------------------------------------------------------------
            'iTicketPageCount = Math.Truncate((dtCardListInTicket.Rows.Count + 7 - 1) / 45) + 1 '需要打印的行数 + 页尾可容纳行数
            iTicketPageCount = Math.Truncate((dtCardListInTicket.Rows.Count + 7 - 1) / iPrintRows) + 1 '需要打印的行数 + 页尾可容纳行数
            'modify code 060:end-------------------------------------------------------------------------
        End If

        Try
            Dim Ticket As New System.Drawing.Printing.PrintDocument, PrintStandard As New System.Drawing.Printing.StandardPrintController()
            Ticket.PrintController = PrintStandard '不出现打印窗口
            Ticket.DocumentName = "Ticket_" & Me.lblSalesBillCode.Text.Replace(" ", "") & "-" & (drSalesBill("TicketPrintedTimes") + 1).ToString
            iTicketPageNum = 1
            Ticket.PrinterSettings.PrinterName = My.Settings.TicketPrinter
            'modify code 059:start-------------------------------------------------------------------------
            'If blIsMultiPaper Then
            '    AddHandler Ticket.PrintPage, AddressOf Ticket_PrintPage_MultiPaper
            'Else
            '    AddHandler Ticket.PrintPage, AddressOf Ticket_PrintPage_A4
            '    Ticket.PrinterSettings.Copies = 2
            'End If
            If (Not drContract Is Nothing AndAlso drContract("PaymentMode") = 1) OrElse (Not IsDBNull(drSalesBill("ContractMode")) AndAlso drSalesBill("ContractMode").ToString.Substring(0, 1) <> "0") Then '付款抵扣单独打印函数，需要考虑金额为0的情况
                If blIsMultiPaper Then
                    AddHandler Ticket.PrintPage, AddressOf Ticket_PrintPage_MultiPaper_Zero
                Else
                    AddHandler Ticket.PrintPage, AddressOf Ticket_PrintPage_A4_Zero
                    Ticket.PrinterSettings.Copies = 2
                End If
            Else
                If blIsMultiPaper Then
                    AddHandler Ticket.PrintPage, AddressOf Ticket_PrintPage_MultiPaper
                Else
                    AddHandler Ticket.PrintPage, AddressOf Ticket_PrintPage_A4
                    Ticket.PrinterSettings.Copies = 2
                End If
            End If
            'modify code 059:end-------------------------------------------------------------------------

            Ticket.Print()
            Ticket.Dispose()

            drSalesBill("TicketPrintedTimes") += 1
            drSalesBill.AcceptChanges()
            Me.btnPrintTicket.Text = "重打印小票(&T)"
            Me.btnPrintTicket.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillTicketReprint'").Length > 0 AndAlso drSalesBill("TicketPrintedTimes") < 3)

            If drInvoicePrintable("CanPrintInvoice") Then
                If dmTotalPaymentAMT = 0 Then
                    Me.btnPrintInvoice.Text = "打印发票(&I)"
                    Me.btnPrintInvoice.Enabled = False
                ElseIf dmTotalPrintedInvoiceAMT = 0 Then
                    Me.btnPrintInvoice.Text = "打印发票(&I)"
                    Me.btnPrintInvoice.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length > 0)
                ElseIf dmTotalPaymentAMT = dmTotalPrintedInvoiceAMT Then
                    Me.btnPrintInvoice.Text = "查看发票(&I)"
                    Me.btnPrintInvoice.Enabled = True
                Else
                    If frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length > 0 Then
                        Me.btnPrintInvoice.Text = "打印发票(&I)"
                    Else
                        Me.btnPrintInvoice.Text = "查看发票(&I)"
                    End If
                    Me.btnPrintInvoice.Enabled = True
                End If
            Else
                Me.btnPrintInvoice.Text = "打印发票(&I)"
                Me.btnPrintInvoice.Enabled = False
            End If
            'modify code 008:start-------------------------------------------------------------------------
            If dtPayment.Rows.Count > 0 Then
                If dtPayment.Rows(0)("PaymentTerm") = 7 Then
                    Me.btnPrintInvoice.Enabled = False
                End If
            End If
            'modify code 008:end-------------------------------------------------------------------------
            'modify code 040,044:start-------------------------------------------------------------------------
            If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                If strSelectedBuyChannel = "Cul" Then
                    If dtBillBuyChannel Is Nothing OrElse dtBillBuyChannel.Select("BillBuyChannel = '" & ecir.ExtractingCodeInfoData.BillBuyChannel & "'").Length = 0 _
                        OrElse dtBillBuyChannel.Select("BillBuyChannel = '" & ecir.ExtractingCodeInfoData.BillBuyChannel & "' and CanPrintInvoice = 1 ").Length = 0 Then
                        Me.btnPrintInvoice.Enabled = False
                    End If
                Else
                    If dtBillBuyChannel Is Nothing OrElse dtBillBuyChannel.Select("BillBuyChannel = 'RUITAI'").Length = 0 _
                        OrElse dtBillBuyChannel.Select("BillBuyChannel = 'RUITAI' and CanPrintInvoice = 1 ").Length = 0 Then
                        Me.btnPrintInvoice.Enabled = False
                    End If
                End If
            End If
            'modify code 040,044:end-------------------------------------------------------------------------
            frmMain.statusText.Text = "就绪。"
        Catch ex As Exception
            If drSalesBill("TicketPrintedTimes") = 0 Then
                Try
                    DB.ModifyTable("Update PendingSalesBillExtra Set TicketPrintedTimes = 0 Where SalesBillID=" & sSalesBillID)
                Catch
                End Try
            End If
            MessageBox.Show(sTask & "时发生如下错误：    " & Chr(13) & Chr(13) & ex.Message & "    ", sTask & "出错！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = sTask & "出错！"
        End Try

        dtCardListInTicket.Dispose() : dtCardListInTicket = Nothing : DB.Close()
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub btnConfigTicket_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnConfigTicket.Click
        If frmMain.dtAllowedRight.Select("RightName Like 'SalesBillTicket%'").Length = 0 Then
            MessageBox.Show("因为您没有打印销售小票的权限，所以您不必要设置小票打印机。    ", "您无须设置小票打印机！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnConfigTicket.Enabled = False
            Return
        End If

        If Printing.PrinterSettings.InstalledPrinters.Count = 0 Then
            MessageBox.Show("您的电脑未发现打印机！请先安装打印机。    ", "未发现打印机！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "未发现打印机！"
            Return
        End If

        With frmConfigTicket
            For Each sPrinter As String In Printing.PrinterSettings.InstalledPrinters
                .cbbPrinter.Items.Add(sPrinter)
            Next
            If My.Settings.TicketPrinter <> "" AndAlso .cbbPrinter.Items.IndexOf(My.Settings.TicketPrinter) > -1 Then
                .cbbPrinter.SelectedIndex = .cbbPrinter.Items.IndexOf(My.Settings.TicketPrinter)
                If .Text.IndexOf("不再可用") > -1 Then
                    .cbbPrinter.Items(.cbbPrinter.Items.IndexOf(My.Settings.TicketPrinter)) = My.Settings.TicketPrinter & "（不可用）"
                End If
            Else
                Dim printDoc As New Printing.PrintDocument
                .cbbPrinter.SelectedIndex = .cbbPrinter.Items.IndexOf(printDoc.PrinterSettings.PrinterName)
                printDoc.Dispose() : printDoc = Nothing
            End If

            If .ShowDialog = Windows.Forms.DialogResult.OK Then
                My.Settings.TicketPrinter = .cbbPrinter.Text
                My.Settings.Save()
                blCheckTicketPrinter = False
            End If

            .Dispose()
        End With
    End Sub

    Private Sub btnPrintApplicationForm_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnPrintApplicationForm.Click
        If My.Settings.ApplicationFormPrinter = "" Then
            frmConfigTicket.Text = "未指定折扣申请单打印机，请先指定打印机："
            Me.btnConfigApplicationForm.PerformClick()
            If My.Settings.ApplicationFormPrinter = "" Then Return
        End If

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打印折扣申请单……"
        frmMain.statusMain.Refresh()

        Dim DB As New DataBase()
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法打印折扣申请单。请检查数据库连接。"
            Me.Activate() : Me.Cursor = Cursors.Default : Return
        End If

        If drSalesBill("RebateMode") = 3 AndAlso (drContractExtra Is Nothing OrElse drContractExtra("ContractID").ToString <> sBalanceContractID) Then '
            Try
                'drContractExtra = DB.GetDataTable("Select ContractID, HistorySalesAMT,HistoryRebateAMT,HistoryPaidRebateAMT From ContractExtra Where ContractID=" & sBalanceContractID).Rows(0)

                'modify code 068,072:start-------------------------------------------------------------------------
                If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                    drContractExtra = DB.GetDataTable("Select ContractID, HistorySalesAMT,HistoryRebateAMT,HistoryPaidRebateAMT From CrossContractExtra Where ContractID=" & sBalanceContractID).Rows(0)
                Else
                    drContractExtra = DB.GetDataTable("Select ContractID, HistorySalesAMT,HistoryRebateAMT,HistoryPaidRebateAMT From ContractExtra Where ContractID=" & sBalanceContractID).Rows(0)
                End If
                'modify code 068,072:end-------------------------------------------------------------------------

            Catch
                frmMain.statusText.Text = "系统因检索不到合同而无法打印折扣申请单！"
                DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default : Return
            End Try
        End If

        Try
            Dim ApplicationForm As New System.Drawing.Printing.PrintDocument, PrintStandard As New System.Drawing.Printing.StandardPrintController()
            ApplicationForm.PrintController = PrintStandard '不出现打印窗口
            ApplicationForm.DocumentName = "Application_" & Me.lblSalesBillCode.Text.Replace(" ", "")
            ApplicationForm.PrinterSettings.PrinterName = My.Settings.ApplicationFormPrinter
            AddHandler ApplicationForm.PrintPage, AddressOf ApplicationForm_PrintPage

            ApplicationForm.Print()
            ApplicationForm.Dispose()

            Try
                DB.ModifyTable("Exec OperationLogInsert " & frmMain.sSSID & ",'Print Discount Application Form','SalesBill'," & sSalesBillID)
            Catch
            End Try
            frmMain.statusText.Text = "就绪。"
        Catch ex As Exception
            MessageBox.Show("打印折扣申请单时发生如下错误：    " & Chr(13) & Chr(13) & ex.Message & "    ", "打印折扣申请单出错！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "打印折扣申请单出错！"
        End Try

        DB.Close()
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub btnConfigApplicationForm_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnConfigApplicationForm.Click
        If Printing.PrinterSettings.InstalledPrinters.Count = 0 Then
            MessageBox.Show("您的电脑未发现打印机！请先安装打印机。    ", "未发现打印机！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "未发现打印机！"
            Return
        End If

        With frmConfigTicket
            .Text = "请选择用于打印折扣申请单的打印机："
            For Each sPrinter As String In Printing.PrinterSettings.InstalledPrinters
                .cbbPrinter.Items.Add(sPrinter)
            Next
            If My.Settings.ApplicationFormPrinter <> "" AndAlso .cbbPrinter.Items.IndexOf(My.Settings.ApplicationFormPrinter) > -1 Then
                .cbbPrinter.SelectedIndex = .cbbPrinter.Items.IndexOf(My.Settings.ApplicationFormPrinter)
                If .Text.IndexOf("不再可用") > -1 Then
                    .cbbPrinter.Items(.cbbPrinter.Items.IndexOf(My.Settings.ApplicationFormPrinter)) = My.Settings.ApplicationFormPrinter & "（不可用）"
                End If
            Else
                Dim printDoc As New Printing.PrintDocument
                .cbbPrinter.SelectedIndex = .cbbPrinter.Items.IndexOf(printDoc.PrinterSettings.PrinterName)
                printDoc.Dispose() : printDoc = Nothing
            End If

            If .ShowDialog = Windows.Forms.DialogResult.OK Then
                My.Settings.ApplicationFormPrinter = .cbbPrinter.Text
                My.Settings.Save()
            End If

            .Dispose()
        End With
    End Sub

    Private Sub btnPrintInvoice_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnPrintInvoice.Click
        If Me.btnPrintInvoice.Text.IndexOf("打印") = 0 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length = 0 Then
            MessageBox.Show("对不起！您没有打印销售发票的权限。    ", "您无权打印销售发票！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnPrintInvoice.Enabled = False
            Return
        End If

        Dim sTask As String = IIf(Me.btnPrintInvoice.Text.IndexOf("打印") = 0, "打印", "查看")
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开发票" & sTask & "窗口……"
        frmMain.statusMain.Refresh()

        If dtInvoice Is Nothing Then
            Dim DB As New DataBase
            DB.Open()
            If Not DB.IsConnected Then
                frmMain.statusText.Text = "系统因连接不到数据库而无法打开发票" & sTask & "窗口。请检查数据库连接。"
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If

            dtInvoice = DB.GetDataTable("Exec GetSalesBillInvoice @SalesBillID=" & sSalesBillID)
            If dtInvoice Is Nothing Then
                frmMain.statusText.Text = "打开发票" & sTask & "窗口失败！"
                DB.Close()
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If
            dtInvoice.DefaultView.Sort = "RowID"

            Try
                iDifferenceSeconds = DateDiff(DateInterval.Second, DB.GetDataTable("Select GetDate()").Rows(0)(0), Now())
            Catch
                iDifferenceSeconds = 0
            End Try

            If frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint' Or RightName='SalesBillInvoiceReprint'").Length > 0 Then
                '加入drinvoictprintable
                frmMain.statusText.Text = "正在获取发票打印参数……"
                If dtInvoiceLayout Is Nothing Then
                    dtInvoiceLayout = DB.GetDataTable("Select * From InvoiceLayout Where StoreID=" & drSalesBill("StoreID").ToString)
                    If dtInvoiceLayout Is Nothing Then
                        frmMain.statusText.Text = "获取发票打印参数失败！"
                        DB.Close()
                        Me.Activate() : Me.Cursor = Cursors.Default : Return
                    End If
                End If

                If sContractID <> "" AndAlso drContract Is Nothing Then
                    Try
                        'drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)

                        'modify code 068,072:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                            drContract = DB.GetDataTable("Exec GetCrossContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                        Else
                            drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                        End If
                        'modify code 068,072:end-------------------------------------------------------------------------

                    Catch
                        frmMain.statusText.Text = "获取发票打印参数失败！"
                        DB.Close()
                        Me.Activate() : Me.Cursor = Cursors.Default : Return
                    End Try
                End If

                If (drContract Is Nothing OrElse drContract("InvoiceItem").ToString = "") AndAlso (dtInvoiceItem Is Nothing OrElse dtInvoice.Rows.Count = 0 OrElse dtInvoiceItem.Rows(0)("CityID").ToString <> sCityID) Then
                    dtInvoiceItem = DB.GetDataTable("Select C.CityID,C.ItemID,I.Content From InvoiceCityItem As C Join InvoiceItemList As I On C.ItemID=I.ItemID Where C.CityID=" & sCityID)
                    If dtInvoiceItem Is Nothing Then
                        frmMain.statusText.Text = "获取发票打印参数失败！"
                        DB.Close()
                        Me.Activate() : Me.Cursor = Cursors.Default : Return
                    ElseIf dtInvoiceItem.Rows.Count = 0 Then
                        MessageBox.Show("所在城市还未指定可用的发票品项，所以不能打印发票！    " & Chr(13) & Chr(13) & "请找总部为该城市指定可用的发票品项。    ", "没有发票品项，不能打印发票！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        frmMain.statusText.Text = "没有发票品项，不能打印发票！"
                        DB.Close()
                        Me.Activate() : Me.Cursor = Cursors.Default : Return
                    End If
                End If

                Try
                    Dim drInvoiceCodeNo As DataRow = DB.GetDataTable("Select LastInvoiceCode,LastInvoiceNo From InvoiceCodeNo Where StoreID=" & drSalesBill("StoreID").ToString & " And PrinterDevice='" & sInvoicePrinterDevice.Replace("'", "''") & "'").Rows(0)
                    sInvoiceCode = drInvoiceCodeNo("LastInvoiceCode").ToString
                    sInvoiceNo = (CLng(drInvoiceCodeNo("LastInvoiceNo").ToString) + 1).ToString
                    If sInvoiceNo.Length < drInvoiceCodeNo("LastInvoiceNo").ToString.Length Then sInvoiceNo = StrDup(drInvoiceCodeNo("LastInvoiceNo").ToString.Length - sInvoiceNo.Length, "0") & sInvoiceNo
                Catch
                    sInvoiceCode = "" : sInvoiceNo = ""
                End Try
                DB.Close()

                If My.Settings.InvoicePrinter = "" AndAlso (dtInvoiceLayout.Rows.Count = 0 OrElse dtInvoiceLayout.Rows(0)("StoreID").ToString <> drSalesBill("StoreID").ToString OrElse Not dtInvoiceLayout.Rows(0)("IsLocked")) Then
                    frmConfigInvoice.Text = "未设置发票版面和打印机，请先设置发票版面和打印机："
                    Me.btnConfigInvoice.PerformClick()
                    If My.Settings.InvoicePrinter = "" Then Me.Activate() : Me.Cursor = Cursors.Default : Return
                ElseIf My.Settings.InvoicePrinter = "" Then
                    frmConfigInvoice.Text = "未指定发票打印机，请先指定打印机："
                    Me.btnConfigInvoice.PerformClick()
                    If My.Settings.InvoicePrinter = "" Then Me.Activate() : Me.Cursor = Cursors.Default : Return
                ElseIf dtInvoiceLayout Is Nothing OrElse dtInvoiceLayout.Rows.Count = 0 OrElse dtInvoiceLayout.Rows(0)("StoreID").ToString <> drSalesBill("StoreID").ToString Then
                    frmConfigInvoice.Text = "未设置发票版面，请先设置发票版面："
                    Me.btnConfigInvoice.PerformClick()
                    If dtInvoiceLayout.Rows.Count = 0 OrElse dtInvoiceLayout.Rows(0)("StoreID").ToString <> drSalesBill("StoreID").ToString Then Me.Activate() : Me.Cursor = Cursors.Default : Return
                ElseIf sInvoicePrinterDevice = "" Then
                    Dim WMI As New System.Management.ManagementObjectSearcher("SELECT * FROM Win32_Printer"), WMER As System.Management.PropertyDataCollection.PropertyDataEnumerator, ipAddress As Net.IPAddress = Nothing
                    Dim sPrinterName As String = "", sPortName As String = "", sSystemName As String = ""
                    Try
                        For Each WMIOBJ As System.Management.ManagementObject In WMI.Get
                            WMER = WMIOBJ.Properties.GetEnumerator : sPrinterName = "" : sPortName = "" : sSystemName = ""
                            While WMER.MoveNext
                                With WMER.Current
                                    If .Name.ToLower = "name" Then sPrinterName = .Value.ToString
                                    If .Name.ToLower = "portname" Then sPortName = .Value.ToString
                                    If .Name.ToLower = "systemname" Then sSystemName = .Value.ToString
                                    If sPrinterName <> "" AndAlso sPortName <> "" AndAlso sSystemName <> "" Then Exit While
                                End With
                            End While
                            If sPrinterName = My.Settings.InvoicePrinter Then Exit For
                        Next
                        WMI = Nothing
                        If sPortName.ToUpper.IndexOf("IP_") = 0 Then
                            sInvoicePrinterDevice = sPortName
                        ElseIf Net.IPAddress.TryParse(sPortName, ipAddress) Then
                            sInvoicePrinterDevice = "IP_" & sPortName 'Win7环境下的网络打印机本地化为以IP地址为名称的端口名
                        ElseIf My.Settings.InvoicePrinter.IndexOf("\\") = 0 Then
                            sInvoicePrinterDevice = My.Settings.InvoicePrinter
                        Else '将本地打印机表达成网络打印机的形式
                            sInvoicePrinterDevice = "\\" & sSystemName & "\" & My.Settings.InvoicePrinter
                        End If
                    Catch
                        frmConfigInvoice.Text = "原来的发票打印机不再可用，请重新指定打印机："
                        Me.btnConfigInvoice.PerformClick()
                        If My.Settings.InvoicePrinter = "" Then Me.Activate() : Me.Cursor = Cursors.Default : Return
                    End Try
                End If
            End If
        End If

        frmMain.statusText.Text = "就绪。"
        If drInternalPayer Is Nothing Then drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
        With frmPrintInvoice
            .Text = sTask & "发票："
            .dmTotalChargedAMT = dmTotalChargedAMT
            .dmTotalRebateAMT = dmTotalRebateAMT
            .txbTotalPaymentAMT.Text = Format(dmTotalPaymentAMT, "#,0.00")
            .txbTotalPrintedInvoiceAMT.Text = Format(dmTotalPrintedInvoiceAMT, "#,0.00")
            .sCarrefourName = drInternalPayer("PayeeName").ToString
            .sReceiverTaxNo = drInternalPayer("ReceiverTaxNo").ToString
            If sTask = "查看" Then
                .grbAvailableInvoiceAMT.Text = "发票金额汇总："
                .lblAvailableInvoiceAMT.Text = "未打印发票金额："
            End If
            .txbAvailableInvoiceAMT.Text = Format(dmTotalPaymentAMT - dmTotalPrintedInvoiceAMT, "#,0.00")
            If frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint' Or RightName='SalesBillInvoiceReprint'").Length > 0 Then
                If drSalesBill("SalesBillType") = 4 Then
                    .txbInvoiceTitle.Text = drSalesBill("BuyerName").ToString & " （员工购卡福利）"
                ElseIf drSalesBill("SalesBillType") > 1 Then
                    .txbInvoiceTitle.Text = drSalesBill("CustomerName").ToString
                ElseIf drSalesBill("CustomerType") = 0 Then
                    'If drSalesBill("BuyerName").ToString = "" Then
                    .txbInvoiceTitle.Text = "（个人）"
                    'Else
                    '.txbInvoiceTitle.Text = drSalesBill("BuyerName").ToString & " （个人）"
                    'End If
                ElseIf sContractID = "" Then
                    .txbInvoiceTitle.Text = drSalesBill("CustomerName").ToString
                Else
                    .txbInvoiceTitle.Text = drContract("InvoiceTitle").ToString
                    .blIsDeduction = (drContract("PaymentMode") = 1)
                End If

                If drContract Is Nothing OrElse drContract("InvoiceItem").ToString = "" Then
                    .dtInvoiceItem = dtInvoiceItem.DefaultView.ToTable(False, "ItemID", "Content")
                Else
                    .dtInvoiceItem = New DataTable
                    .dtInvoiceItem.Columns.Add("ItemID", System.Type.GetType("System.Int16"))
                    .dtInvoiceItem.Columns.Add("Content", System.Type.GetType("System.String"))
                    Dim saInvoiceItems() As String = drContract("InvoiceItem").ToString.Split("、")
                    For iItem As Int16 = 0 To saInvoiceItems.Length - 1
                        .dtInvoiceItem.Rows.Add(iItem, saInvoiceItems(iItem))
                    Next
                End If
                .dtInvoiceItem.AcceptChanges()
                .txbInvoiceCode.Text = sInvoiceCode
                .txbInvoiceNo.Text = sInvoiceNo
            End If
            .ShowDialog()
            If sTask = "打印" AndAlso drSalesBill("SalesBillState") < 9 Then
                dmTotalPaymentAMT = CDec(.txbTotalPaymentAMT.Text)
                dmTotalPrintedInvoiceAMT = CDec(.txbTotalPrintedInvoiceAMT.Text)
                If dmTotalPaymentAMT = 0 Then
                    Me.btnPrintInvoice.Text = "打印发票(&I)"
                    Me.btnPrintInvoice.Enabled = False
                ElseIf dmTotalPrintedInvoiceAMT = 0 Then
                    Me.btnPrintInvoice.Text = "打印发票(&I)"
                    Me.btnPrintInvoice.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length > 0) '当前用户是有权限打印发票的用户
                ElseIf dmTotalPaymentAMT = dmTotalPrintedInvoiceAMT Then
                    Me.btnPrintInvoice.Text = "查看发票(&I)"
                    Me.btnPrintInvoice.Enabled = True
                Else
                    If frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length > 0 Then
                        Me.btnPrintInvoice.Text = "打印发票(&I)"
                    Else
                        Me.btnPrintInvoice.Text = "查看发票(&I)"
                    End If
                    Me.btnPrintInvoice.Enabled = True
                End If
            End If
            .Dispose()
        End With
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub btnConfigInvoice_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnConfigInvoice.Click
        If frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length = 0 Then
            MessageBox.Show("因为您没有打印销售发票的权限，所以您不必要设置发票版面和打印机。    ", "您无须设置发票版面和打印机！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnConfigInvoice.Enabled = False
            Return
        End If

        If Printing.PrinterSettings.InstalledPrinters.Count = 0 Then
            MessageBox.Show("您的电脑未发现打印机！请先安装打印机。    ", "未发现打印机！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            frmMain.statusText.Text = "未发现打印机！"
            Return
        End If

        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开发票设置窗口……"
        frmMain.statusMain.Refresh()

        If dtInvoiceLayout Is Nothing OrElse dtInvoiceLayout.Rows.Count = 0 OrElse dtInvoiceLayout.Rows(0)("StoreID").ToString <> drSalesBill("StoreID").ToString Then
            Dim DB As New DataBase
            DB.Open()
            If Not DB.IsConnected Then
                frmMain.statusText.Text = "系统因连接不到数据库而无法打开发票设置窗口。请检查数据库连接。"
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If
            dtInvoiceLayout = DB.GetDataTable("Select * From InvoiceLayout Where StoreID=" & drSalesBill("StoreID").ToString)
            If dtInvoiceLayout Is Nothing Then
                frmMain.statusText.Text = "打开发票设置窗口失败！"
                DB.Close()
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If

            If dtInvoiceLayout.Rows.Count = 0 Then '从同一个城市的其他店复制发票版面
                Try
                    Dim dtStore As DataTable = DB.GetDataTable("Select Distinct I.StoreID,I.IsLocked From InvoiceLayout As I Join AreaList As A On I.StoreID=A.AreaID Where A.ParentAreaID=" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID"))("ParentAreaID").ToString)
                    If dtStore.Rows.Count > 0 Then
                        If dtStore.Select("IsLocked=1").Length > 0 Then
                            dtInvoiceLayout = DB.GetDataTable("Select * From InvoiceLayout Where StoreID=" & dtStore.Select("IsLocked=1")(0)("StoreID").ToString)
                        Else
                            dtInvoiceLayout = DB.GetDataTable("Select * From InvoiceLayout Where StoreID=" & dtStore.Rows(0)("StoreID").ToString)
                        End If
                        For Each drItem As DataRow In dtInvoiceLayout.Rows
                            drItem("StoreID") = drSalesBill("StoreID")
                            drItem("IsLocked") = 0
                        Next
                    End If
                    dtStore.Dispose() : dtStore = Nothing
                Catch
                    dtInvoiceLayout = Nothing
                    frmMain.statusText.Text = "打开发票设置窗口失败！"
                    DB.Close()
                    Me.Activate() : Me.Cursor = Cursors.Default : Return
                End Try
            End If

            DB.Close()
            dtInvoiceLayout.DefaultView.Sort = "ItemID"
        End If

        If dtInvoiceLayout.Rows.Count = 0 Then
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 1, "发票抬头", 10, 10, 30, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 2, "发票品项", 10, 40, 45, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 3, "计量数量", 10, 105, 45, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 4, "计量单价", 10, 120, 45, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 5, "发票金额", 10, 140, 45, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 6, "大写总额", 10, 25, 80, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 7, "付款方式", 10, 125, 90, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 8, "经手人", 10, 145, 90, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 9, "开票日期", 10, 135, 15, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 10, "家乐福小票号（含标题）", 10, 110, 10, 1)
            dtInvoiceLayout.Rows.Add(drSalesBill("StoreID"), 0, 11, "购买统计信息（含标题）", 10, 5, 95, 1)
        End If

        If drInternalPayer Is Nothing Then
            If drSalesBill("StoreID").ToString = "" Then
                drInternalPayer = dtInternalPayer.Rows(0)
            Else
                drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
            End If
        End If
        frmMain.statusText.Text = "就绪。"
        With frmConfigInvoice
            .sCarrefourName = drInternalPayer("PayeeName").ToString
            .sReceiverTaxNo = drInternalPayer("ReceiverTaxNo").ToString
            If .ShowDialog() = Windows.Forms.DialogResult.Cancel Then dtInvoiceLayout.RejectChanges()
            .Dispose()
        End With
        frmMain.statusText.Text = "就绪。"
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub btnViewActivation_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnViewActivation.Click
        If Me.btnViewActivation.Text = "" OrElse Me.btnViewActivation.Text.IndexOf("显示") > -1 Then
            With frmCheckCardResult
                .blCanUse60Card = blCanUse60Card
                .blCanUse92Card = blCanUse92Card
                .blCanUse94Card = blCanUse94Card
                .blCanUsePaperCard = blCanUsePaperCard
                'modify code 051:start-------------------------------------------------------------------------
                .blCanUse65Card = blCanUse65Card
                'modify code 051:end-------------------------------------------------------------------------
                .Text = "上次购物卡可用状态检查结果"
                .Show()
            End With
            Me.btnViewActivation.Text = "隐藏卡片检查结果(&R)"
        ElseIf Me.btnViewActivation.Text.IndexOf("隐藏") > -1 Then
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible Then frmCheckCardResult.Close()
            If dtLastCheckingProblemCard.Rows.Count > 0 AndAlso dtLastCheckingProblemCard.Select("UsageState='可以售卖'").Length = 0 Then
                Me.btnViewActivation.Text = "显示卡片检查结果(&R)"
                If bHightLightTimes = 0 Then
                    sTimerType = "HightLightCardResultButton"
                    Me.theTimer.Interval = 500
                    Me.theTimer.Enabled = True
                End If
            Else
                dtLastCheckingProblemCard.Rows.Clear()
                Me.btnViewActivation.Text = "激活明细(&A)"
                Me.btnViewActivation.Enabled = False
            End If
        Else
            If dtActivation IsNot Nothing AndAlso sActivationLoadedTime <> "" AndAlso DateDiff(DateInterval.Minute, CDate(sActivationLoadedTime), Now()) > 5 Then
                dtActivation.Dispose() : dtActivation = Nothing : sActivationLoadedTime = ""
            End If

            Me.Cursor = Cursors.WaitCursor
            If dtActivation Is Nothing Then
                frmMain.statusText.Text = "正在下载购物卡激活明细……"
                frmMain.statusMain.Refresh()
                Dim DB As New DataBase
                DB.Open()
                If Not DB.IsConnected Then
                    frmMain.statusText.Text = "系统因连接不到数据库而无法下载购物卡激活明细。请检查数据库连接。"
                    Me.Activate() : Me.Cursor = Cursors.Default : Return
                End If

                Try
                    dtActivation = DB.GetDataTable("Exec GetSalesBillCardActivation " & sSalesBillID).Copy
                    If drSalesBill("SalesBillState") > 0 AndAlso drSalesBill("SalesBillState") < 4 Then
                        sActivationLoadedTime = Format(Now(), "yyyy\/MM\/dd HH:mm:ss")
                    End If
                    DB.Close()
                Catch
                    DB.Close()
                    frmMain.statusText.Text = "系统因在检索数据时出错而无法下载购物卡激活明细。请联系软件开发人员。"
                    Me.Activate() : Me.Cursor = Cursors.Default : Return
                End Try
            End If

            If dtActivation.Rows.Count < drSalesBill("NormalCardQTY") + drSalesBill("RebateCardQTY") Then
                Dim newCard As DataRow, sStartCardNo As String, iCardQTY As Integer, sCardNo As String
                For Each drNormal As DataRow In dtNormalCard.Rows
                    sStartCardNo = drNormal("StartCardNo").ToString : iCardQTY = drNormal("CardQTY") - 1
                    If sStartCardNo.IndexOf("2") = 0 Then sStartCardNo = sStartCardNo.Substring(0, 18)
                    For iCard As Integer = 0 To iCardQTY
                        If sStartCardNo.IndexOf("2") = 0 Then
                            sCardNo = ShoppingCardNo.GetFullCardNo((CLng(sStartCardNo) + iCard).ToString)
                        Else
                            sCardNo = (CLng(sStartCardNo) + iCard).ToString
                        End If
                        If dtActivation.Select("RowType<>'返点卡' And CardNo='" & sCardNo & "'").Length = 0 Then
                            newCard = dtActivation.Rows.Add()
                            Select Case drSalesBill("SalesBillType")
                                Case 0, 4, 5
                                    If sCardNo.IndexOf("8") = 0 Then
                                        If sCardNo.IndexOf("86") = 0 OrElse sCardNo.Substring(5, 1) = "8" OrElse sCardNo.Substring(5, 3) = "100" Then
                                            newCard("RowType") = "正常卡（条码卡）"
                                        Else
                                            newCard("RowType") = "正常卡（充值券）"
                                        End If
                                    Else
                                        newCard("RowType") = IIf(sCardNo.IndexOf("23366") = 0, "正常卡（礼品卡）", "正常卡")
                                    End If
                                Case 1
                                    If sCardNo.IndexOf("233694") = 0 Then
                                        newCard("RowType") = "活动卡退卡"
                                    ElseIf sCardNo.IndexOf("233692") = 0 Then
                                        newCard("RowType") = "营销卡退卡"
                                    ElseIf sCardNo.IndexOf("233660") = 0 Then
                                        newCard("RowType") = "礼品卡退卡"
                                    Else
                                        newCard("RowType") = "退货卡"
                                    End If
                                Case 2
                                    newCard("RowType") = IIf(sStartCardNo.IndexOf("2") = 0, "活动卡", "活动券")
                                Case Else
                                    newCard("RowType") = IIf(sStartCardNo.IndexOf("2") = 0, "公关卡", "公关券")
                            End Select
                            newCard("RowID") = drNormal("RowID")
                            newCard("CardNo") = sCardNo
                            newCard("FaceValue") = drNormal("FaceValue")
                            Select Case drSalesBill("SalesBillState")
                                Case 99
                                    newCard("ActivationState") = "已被取消"
                                    newCard("StateReason") = drSalesBill("StateReason").ToString
                                Case 9
                                    newCard("ActivationState") = "等待取消"
                                    newCard("StateReason") = drSalesBill("StateReason").ToString
                                Case Else
                                    newCard("ActivationState") = "等待激活"
                            End Select
                            newCard("Reactivate") = 0
                            newCard.AcceptChanges()
                        End If
                    Next
                Next

                For Each drRebate As DataRow In dtRebateCard.Rows
                    sStartCardNo = drRebate("StartCardNo").ToString : iCardQTY = drRebate("CardQTY") - 1
                    If sStartCardNo.IndexOf("2") = 0 Then sStartCardNo = sStartCardNo.Substring(0, 18)
                    For iCard As Integer = 0 To iCardQTY
                        If sStartCardNo.IndexOf("2") = 0 Then
                            sCardNo = ShoppingCardNo.GetFullCardNo((CLng(sStartCardNo) + iCard).ToString)
                        Else
                            sCardNo = (CLng(sStartCardNo) + iCard).ToString
                        End If
                        If dtActivation.Select("RowType='返点卡' And CardNo='" & sCardNo & "'").Length = 0 Then
                            newCard = dtActivation.Rows.Add()
                            If sCardNo.IndexOf("9") = 0 Then
                                newCard("RowType") = "营销券"
                            ElseIf sCardNo.IndexOf("8") = 0 Then
                                If sCardNo.IndexOf("86") = 0 OrElse sCardNo.Substring(5, 3) = "100" OrElse sCardNo.Substring(5, 1) = "8" Then
                                    newCard("RowType") = "返点卡（条码卡）"
                                Else
                                    newCard("RowType") = "返点卡（充值券）"
                                End If
                            ElseIf sCardNo.IndexOf("233692") = 0 Then
                                newCard("RowType") = "营销卡"
                            ElseIf sCardNo.IndexOf("233660") = 0 Then
                                newCard("RowType") = "返点卡（礼品卡）"
                            Else
                                newCard("RowType") = "返点卡"
                            End If
                            newCard("RowID") = drRebate("RowID")
                            newCard("CardNo") = sCardNo
                            newCard("FaceValue") = drRebate("FaceValue")
                            Select Case drSalesBill("SalesBillState")
                                Case 99
                                    newCard("ActivationState") = "已被取消"
                                    newCard("StateReason") = drSalesBill("StateReason").ToString
                                Case 9
                                    newCard("ActivationState") = "等待取消"
                                    newCard("StateReason") = drSalesBill("StateReason").ToString
                                Case Else
                                    newCard("ActivationState") = "等待激活"
                            End Select
                            newCard("Reactivate") = 0
                            newCard.AcceptChanges()
                        End If
                    Next
                Next
            End If

            With frmActivationDetails
                .dvCard = dtActivation.Copy.DefaultView
                .ShowDialog()
                .dvCard.RowFilter = ""
                dtActivation = .dvCard.Table.Copy
                .dvCard.Dispose()
                .dvCard = Nothing
                .Dispose()
            End With

            Me.Activate() : Me.Cursor = Cursors.Default
        End If
    End Sub

    Private Sub btnNewSalesBill_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnNewSalesBill.Click
        If bNewSalesBillType <> 1 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillNormalCreate'").Length = 0 Then
            MessageBox.Show("对不起！您没有创建一般销售单的权限。    ", "您无权创建一般销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.btnNewSalesBill.Enabled = False
            Return
        End If

        If blIsChanged Then
            Dim bAnswer As DialogResult = MessageBox.Show("是否在新建销售单之前，先保存当前销售单？    ", "当前销售单未保存！", MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question)
            If bAnswer = Windows.Forms.DialogResult.Cancel OrElse (bAnswer = Windows.Forms.DialogResult.Yes AndAlso Not Me.SaveChanges()) Then Return
        End If

        sCustomerID = ""
        blUsedOldCard = (bNewSalesBillType = 1)
        'modify code 050:start-------------------------------------------------------------------------
        If bNewSalesBillType = 7 Then
            Me.cbbSalesBillType.Items(0) = "实名制卡销售单"
        End If
        'modify code 050:end-------------------------------------------------------------------------
        'modify code 054:start-------------------------------------------------------------------------
        If bNewSalesBillType = 8 Then
            Me.cbbSalesBillType.Items(0) = "通卖非实名卡销售单"
        End If
        'modify code 050:end-------------------------------------------------------------------------
        Me.ReCreateSalesBill()
    End Sub

    Private Sub FillNewSalesBill()
        blSkipDeal = True

        Me.grbSalesBillType.Text = "请选择销售单类型："
        Me.txbSalesBillType.Visible = False
        Me.cbbSalesBillType.Visible = True
        Me.cbbSalesBillType.SelectedIndex = 0

        If bNewSalesBillType = 4 Then '员工销售单
            Me.flpEmployee.Visible = True
            Me.grbInputEmployeeNo.Visible = True
            Me.txbInputEmployeeNo.Text = ""
            Me.pnlEmployeeNo.Visible = False
            Me.pnlEmployeeTel.Visible = False
            Me.grbEmployeeInfo.Text = "请核对员工信息："
            Me.grbEmployeeInfo.Height = Me.flpEmployeeInfo.Height + 26
            Me.grbEmployeeInfo.Visible = False
            Me.txbInputEmployeeTel.Text = ""
            Me.cbbInputEmployeeTel.Items.Clear()
            Me.grbInputEmployeeTel.Visible = False
            Me.grbEmployeeQuota.Visible = False
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
        Else
            Me.flpEmployee.Visible = False
        End If

        If bNewSalesBillType = 2 Then '活动卡销售单
            Me.grbPromotionInfo.Visible = True
            Me.grbPromotionInfo.Text = "请输入活动摘要："
            Me.txbPromotionTitle.ReadOnly = False
            Me.txbPromotionTitle.BackColor = SystemColors.Window
            Me.txbPromotionTitle.Text = drSalesBill("PromotionTitle").ToString
            Me.pnlPromotionPeriod.Visible = True
            If drSalesBill("PromotionPeriod").ToString = "" Then
                Me.pnlPromotionStartDate.Visible = True
                Me.pnlPromotionEndDate.Visible = True
            Else
                Dim sPromotionPeriod As String = drSalesBill("PromotionPeriod").ToString
                Me.dtpPromotionStartDate.Value = CDate(sPromotionPeriod.Substring(0, 10))
                Me.pnlPromotionStartDate.Visible = False
                Me.dtpPromotionEndDate.Value = CDate(sPromotionPeriod.Substring(sPromotionPeriod.LastIndexOf("-") + 1).Trim)
                Me.pnlPromotionEndDate.Visible = False
            End If
            Me.dtpPromotionStartDate.MinDate = DateAdd(DateInterval.Month, -6, Today())
            Me.dtpPromotionStartDate.MaxDate = DateAdd(DateInterval.Month, 6, Today())
            Me.dtpPromotionEndDate.MinDate = DateAdd(DateInterval.Month, -6, Today())
            Me.dtpPromotionEndDate.MaxDate = DateAdd(DateInterval.Month, 6, Today())
            Me.pnlPromotionPeriodReadOnly.Visible = False
        Else
            Me.grbPromotionInfo.Visible = False
        End If

        If bNewSalesBillType = 1 OrElse bNewSalesBillType = 4 OrElse bNewSalesBillType = 5 Then '退货销售单/员工销售单/联名卡销售单
            Me.grbCustomer.Visible = False
        Else
            Me.grbCustomer.Visible = True
            If bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
                Me.grbCustomer.Text = "家乐福自购客户信息："
            Else
                Me.grbCustomer.Text = "请选择客户："
            End If
            If (bNewSalesBillType = 2 OrElse bNewSalesBillType = 3) AndAlso dtInternalPayer.Rows.Count > 1 Then
                Me.pnlSelectStore.Visible = True
            Else
                Me.pnlSelectStore.Visible = False
            End If
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'If bNewSalesBillType = 0 Then
            '同一般销售单
            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 Then '一般销售单或线下提卡销售单
            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 Then '一般销售单或线下提卡销售单
            If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                'modify code 040,046,054,072:end-------------------------------------------------------------------------
                Me.pnlCustomerType.Visible = True
                Me.cbbCustomerType.Visible = True
                Me.cbbCustomerType.SelectedIndex = drSalesBill("CustomerType")
            Else
                Me.cbbCustomerType.SelectedIndex = 0
                Me.pnlCustomerType.Visible = False
            End If
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'If bNewSalesBillType = 0 Then '一般销售单
            '同一般销售单
            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 Then '一般销售单或线下提卡销售单
            'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 Then '一般销售单或线下提卡销售单
            If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                'modify code 040,046,054,072:end-------------------------------------------------------------------------
                Me.pnlCompanyCustomer.Visible = (drSalesBill("CustomerType") = 1)
                Me.lblCustomerName.Text = "请输入公司名称："
                Me.txbCustomerName.Visible = True
                Me.txbCustomerName.ReadOnly = False
                Me.txbCustomerName.BackColor = SystemColors.Window
                Me.cbbCustomerName.Visible = False
                Me.cbbCompanyCredentialsType.Visible = True
                Me.txbCompanyCredentialsType.Visible = False
                If drSalesBill("CompanyCredentialsType").ToString = "（特准无需证件）" Then
                    Me.txbCompanyCredentialsNo.ReadOnly = True
                    Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                    Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
                Else
                    Me.txbCompanyCredentialsNo.ReadOnly = False
                    Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                End If
                Me.btnNewCustomer.Visible = True
                Me.btnNewCustomer.Enabled = blCanCreateCustomer
                Me.btnViewCustomer.Enabled = blCanViewCustomer
                Me.pnlCustomerButtons.Visible = Me.pnlCompanyCustomer.Visible
            Else '活动卡销售单或公关卡销售单
                Me.pnlCompanyCustomer.Visible = True
                Me.lblCustomerName.Text = "家乐福自购客户名称："
                Me.txbCustomerName.Visible = True
                Me.txbCustomerName.ReadOnly = True
                Me.txbCustomerName.BackColor = SystemColors.Window
                Me.txbCustomerName.BackColor = SystemColors.Control
                Me.cbbCustomerName.Visible = False
                Me.cbbCompanyCredentialsType.Visible = False
                Me.txbCompanyCredentialsType.Visible = True
                Me.txbCompanyCredentialsNo.ReadOnly = True
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
                Me.pnlCustomerButtons.Visible = False
            End If
            Me.txbCustomerName.Text = drSalesBill("CustomerName").ToString
            Me.cbbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
            Me.txbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
            Me.txbCompanyCredentialsNo.Text = drSalesBill("CompanyCredentialsNo").ToString
            Me.flpCustomer.AutoSize = False
            Me.flpCustomer.AutoSize = True
            Me.grbCustomer.Height = Me.flpCustomer.Height + 25
        End If

        Me.grbAvailablePayer.Visible = ((bNewSalesBillType = 2 OrElse bNewSalesBillType = 3) AndAlso Me.cbbAvailablePayer.Items.Count > 1)

        If bNewSalesBillType = 4 OrElse bNewSalesBillType = 5 Then '员工销售单/联名卡销售单
            grbBuyerInfo.Visible = False
        Else
            grbBuyerInfo.Visible = True
            Me.theTip.SetToolTip(Me.cbbBuyerName, "快捷键提示：按<F1>可插入/删除""先生""；按<F2>可插入/删除""女士""。")
            Me.theTip.SetToolTip(Me.txbBuyerName, "快捷键提示：按<F1>可插入/删除""先生""；按<F2>可插入/删除""女士""。")
            Me.txbBuyerName.ReadOnly = False
            Me.txbBuyerName.BackColor = SystemColors.Window
            Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
            Me.txbTelMP.ReadOnly = False
            Me.txbTelMP.BackColor = SystemColors.Window
            Me.txbTelMP.Text = drSalesBill("TelMP").ToString
            If Me.cbbBuyerName.Items.Count > 0 Then
                Me.txbBuyerName.Visible = False
                Me.cbbBuyerName.Visible = True
                Me.cbbBuyerName.Text = drSalesBill("BuyerName").ToString
            Else
                Me.txbBuyerName.Visible = True
                Me.cbbBuyerName.Visible = False
            End If
            If Me.cbbTelMP.Items.Count > 0 Then
                Me.txbTelMP.Visible = False
                Me.cbbTelMP.Visible = True
                Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
            Else
                Me.txbTelMP.Visible = True
                Me.cbbTelMP.Visible = False
            End If
            If bNewSalesBillType = 1 Then '退货销售单
                Me.grbBuyerInfo.Text = "请输入退货客户："
                Me.pnlBuyerCredentials.Visible = False
                Me.grbBuyerInfo.Height = 80
            Else
                'modify code 040,046,054,072:start-------------------------------------------------------------------------
                'If bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0 Then
                '同一般销售单
                'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 0 Then '一般销售单或线下提卡销售单，且是个人客户
                'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0 Then '一般销售单或线下提卡销售单，且是个人客户
                If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0 Then
                    'modify code 040,046,054,072:end-------------------------------------------------------------------------
                    Me.grbBuyerInfo.Text = "请完善购买人信息："
                Else
                    Me.grbBuyerInfo.Text = "请完善代购人信息："
                End If
                Me.pnlBuyerCredentials.Visible = True
                Me.cbbBuyerCredentialsType.Visible = True
                Me.txbBuyerCredentialsType.Visible = False
                Me.txbBuyerCredentialsNo.ReadOnly = False
                Me.txbBuyerCredentialsNo.BackColor = SystemColors.Window
                Me.cbbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
                Me.txbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
                Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
                Me.grbBuyerInfo.Height = 134
            End If
        End If

        If bNewSalesBillType = 5 Then '联名卡销售单
            Me.grbMemberInfo.Visible = True
            Me.grbMemberInfo.Text = "请完善会员信息："
            Me.txbMemberName.ReadOnly = False
            Me.txbMemberName.BackColor = SystemColors.Window
            Me.txbMemberName.Text = ""
            Me.txbMemberIDNo.ReadOnly = False
            Me.txbMemberIDNo.BackColor = SystemColors.Window
            Me.txbMemberIDNo.Text = ""
            Me.txbMemberTel.ReadOnly = False
            Me.txbMemberTel.BackColor = SystemColors.Window
            Me.txbMemberTel.Text = ""
            Me.txbMemberAddress.ReadOnly = False
            Me.txbMemberAddress.BackColor = SystemColors.Window
            Me.txbMemberAddress.Text = ""
            Me.txbNewMemberCardNo.ReadOnly = False
            Me.txbNewMemberCardNo.BackColor = SystemColors.Window
            Me.txbNewMemberCardNo.Text = ""
            Me.txbOldMemberCardNo.ReadOnly = False
            Me.txbOldMemberCardNo.BackColor = SystemColors.Window
            Me.txbOldMemberCardNo.Text = ""
        Else
            Me.grbMemberInfo.Visible = False
        End If

        Me.grbBalanceContract.Text = "是否结算上期合同剩余返点？"
        Me.chbBalanceContract.Checked = False
        Me.chbBalanceContract.Enabled = True
        If sBalanceContractID = "" Then
            Me.txbBalanceContractCode.Text = ""
            Me.txbBalanceContractBalanceRebateAMT.Text = "0.00"
        Else '存在到期合同返点结余
            Me.txbBalanceContractCode.Text = drSalesBill("BalanceContractCode").ToString
            Me.txbBalanceContractBalanceRebateAMT.Text = Format(drSalesBill("BalanceContractBalanceRebateAMT"), "#,0.00")
            If sBalanceContractAppointedStoreID <> "" AndAlso sBalanceContractAppointedStoreID <> drSalesBill("StoreID").ToString Then Me.chbBalanceContract.Enabled = False
        End If
        Me.btnViewBalanceContract.Enabled = blCanViewContract
        Me.txbPreviousDistribution.Text = "0.00"
        Me.txbPreviousDistribution.ForeColor = SystemColors.ControlText
        Me.txbPreviousDistribution.BackColor = SystemColors.Control
        Me.txbPreviousDistribution.Font = New Font(Me.txbPreviousDistribution.Font, FontStyle.Regular)
        Me.txbPreviousBalance.Text = "0.00"
        Me.flpBalanceContract.Visible = False
        Me.grbBalanceContract.Height = 108
        Me.grbBalanceContract.Visible = (sBalanceContractID <> "")

        Me.grbContract.Text = "是否使用当前合同？"
        Me.chbContract.Checked = True
        Me.chbContract.Enabled = True
        If sContractID = "" Then
            Me.grbContract.Visible = False
            Me.splitList.Panel2Collapsed = True
        Else
            Me.txbContractCode.Text = drSalesBill("ContractCode").ToString
            Me.grbContract.Visible = True
            If sContractAppointedStoreID <> "" AndAlso sContractAppointedStoreID <> drSalesBill("StoreID").ToString Then
                Me.chbContract.Checked = False
                Me.chbContract.Enabled = False
                Me.flpContract.Visible = False
                Me.grbContract.Height = 81
                Me.splitList.Panel2Collapsed = True
            Else
                Me.InitContractInfo()
            End If
        End If

        Me.grbNormalRebate.Text = "是否给予城市返点？"
        Me.chbNormalRebate.Checked = False
        Me.chbNormalRebate.Enabled = True
        Me.btnViewCityRule.Enabled = blCanViewCityRule
        Me.pnlMaxNormalRebateCalculation.Visible = True
        'modify code 038:start-------------------------------------------------------------------------
        'Me.txbMaxNormalRebateRate.Text = "0.0"
        Me.txbMaxNormalRebateRate.Text = "0.00"
        Me.txbMaxNormalRebateAMT.Text = "0.00"
        'Me.txbNormalRebateRate.Text = "0.0"
        Me.txbNormalRebateRate.Text = "0.00"
        'modify code 038:end-------------------------------------------------------------------------
        Me.txbNormalRebateRate.ReadOnly = False
        Me.txbNormalRebateRate.ForeColor = SystemColors.ControlText
        Me.txbNormalRebateRate.BackColor = SystemColors.Window
        Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Regular)
        Me.txbNormalRebateAMT.Text = "0.00"
        Me.txbNormalRebateAMT.ReadOnly = False
        Me.txbNormalRebateAMT.ForeColor = SystemColors.ControlText
        Me.txbNormalRebateAMT.BackColor = SystemColors.Window
        Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Regular)
        Me.theTip.SetToolTip(Me.lblNormalRebateState, "")
        Me.pnlNormalRebateState.Visible = False
        Me.pnlNormalRebateRemarks.Visible = False
        Me.pnlDistributionNormalRebateAMT.Visible = True
        Me.txbDistributionNormalRebateAMT.Text = "0.00"
        Me.theTip.SetToolTip(Me.txbDistributionNormalRebateAMT, "")
        Me.pnlBalanceNormalRebateAMT.Visible = False
        Me.txbBalanceNormalRebateAMT.Text = "0.00"
        Me.btnModifyNormalRebate.Text = "修改返点"
        Me.btnModifyNormalRebate.Enabled = True
        Me.pnlModifyNormalRebate.Visible = False
        Me.flpNormalRebate.Visible = False
        Me.grbNormalRebate.Height = 52
        Me.grbNormalRebate.Visible = False

        Me.chbPrintDiscount.Checked = False
        Me.chbPrintDiscount.Enabled = True
        If bNewSalesBillType = 4 Then
            Me.chbPrintDiscount.Checked = True
            Me.chbPrintDiscount.Enabled = False
            Me.grbPrintDiscount.Visible = False
            '同一般销售单
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'ElseIf bNewSalesBillType = 0 AndAlso Me.dgvRebateCard.Visible = True AndAlso blCanUse92Card Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso Me.dgvRebateCard.Visible = True AndAlso blCanUse92Card Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso Me.dgvRebateCard.Visible = True AndAlso blCanUse92Card Then
        ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso Me.dgvRebateCard.Visible = True AndAlso blCanUse92Card Then
            'modify code 040,046,054,072:end-------------------------------------------------------------------------
            Me.grbPrintDiscount.Visible = True
        Else
            Me.grbPrintDiscount.Visible = False
        End If

        Me.pnlActivationSummary.Visible = False
        Me.pnlCardCost.Visible = False
        Me.grbSalesBillSummary.Height = Me.flpSalesBillSummary.Height + 28
        Me.theTip.SetToolTip(Me.lblSalesBillState, "")
        Me.grbSalesBillSummary.Visible = False
        Me.grbSalesBillInfo.Visible = False

        Me.pnlAddjustSalesman.Visible = False

        Me.splitList.Panel1Collapsed = False
        Select Case drSalesBill("SalesBillType")
            'modify code 040,044:start-------------------------------------------------------------------------
            Case 6
                If strSelectedBuyChannel = "Cul" Then
                    Me.lblNormalListTitle.Text = "购物卡充值列表：（卡类型：" & IIf(Me.ecir.ExtractingCodeInfoData.BillType = "ENTITY", "实体卡", "礼品卡") & " 卡面值：" & Me.ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.CardPrice & "元 卡数量：" & Me.ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.ProductNum & "张）"
                Else
                    Me.lblNormalListTitle.Text = "购物卡充值列表："
                End If
                'modify code 040,044:end-------------------------------------------------------------------------
            Case 0, 4, 5
                Me.lblNormalListTitle.Text = "购物卡充值列表："
            Case 1
                Me.lblNormalListTitle.Text = "退货卡充值列表："
            Case 2
                Me.lblNormalListTitle.Text = "活动卡充值列表："
                'modify code 046:start-------------------------------------------------------------------------
            Case 7
                Me.lblNormalListTitle.Text = "实名制卡充值列表："
                'modify code 046:end-------------------------------------------------------------------------
                'modify code 054:start-------------------------------------------------------------------------
            Case 8
                Me.lblNormalListTitle.Text = "通卖非实名卡充值列表："
                'modify code 054:end-------------------------------------------------------------------------
            Case 9
                Me.lblNormalListTitle.Text = "电子卡充值列表："
            Case Else
                Me.lblNormalListTitle.Text = "公关卡充值列表："
        End Select
        Me.pnlImportedFile.Visible = False
        With Me.dgvNormalCard
            .ReadOnly = False
            .Columns("RowID").ReadOnly = True
            .Columns("CardFeature").ReadOnly = True
            .Columns("CardFeature").Visible = False
            .Columns("StartCardNo").ReadOnly = False
            .Columns("EndCardNo").ReadOnly = False
            .Columns("CardQTY").ReadOnly = False
            .Columns("FaceValue").ReadOnly = False
            .Columns("ReducedCardPayment").Visible = False
            .Columns("ReducedCardPayment").ReadOnly = True
            'modify code 004:start-------------------------------------------------------------------------
            '.Columns("CardCost").Visible = (dmCardCost > 0)
            .Columns("CardCost").Visible = True
            'modify code 004:end-------------------------------------------------------------------------
            .Columns("CardPayment").ReadOnly = True
            .Columns("CardPayment").Visible = False
            .Columns("PaymentDescription").ReadOnly = True
            .Columns("PaymentDescription").Visible = False
            .Columns("ChargedAMT").ReadOnly = True
            .Columns("PayableAMT").ReadOnly = True
            With .Columns("ActivationState")
                .ReadOnly = True
                .Visible = False
            End With
            With .Columns("ActivatedQTY")
                .ReadOnly = True
                .Visible = False
            End With
            With .Columns("ActivatedAMT")
                .ReadOnly = True
                .Visible = False
            End With
            With .Columns("StateReason")
                .ReadOnly = True
                .Visible = False
            End With
            If .CurrentCell IsNot Nothing Then .CurrentCell.Selected = False
            If .CurrentRow IsNot Nothing Then .CurrentRow.Selected = False
        End With

        Try
            With Me.dgvRebateCard
                .ReadOnly = False
                .Columns("RowID").ReadOnly = True
                .Columns("CardFeature").ReadOnly = True
                .Columns("CardFeature").Visible = False
                .Columns("StartCardNo").ReadOnly = False
                .Columns("EndCardNo").ReadOnly = False
                .Columns("CardQTY").ReadOnly = False
                .Columns("ChargedAMT").ReadOnly = True
                .Columns("PayableAMT").ReadOnly = True
                With .Columns("ActivationState")
                    .ReadOnly = True
                    .Visible = False
                End With
                With .Columns("ActivatedQTY")
                    .ReadOnly = True
                    .Visible = False
                End With
                With .Columns("ActivatedAMT")
                    .ReadOnly = True
                    .Visible = False
                End With
                With .Columns("StateReason")
                    .ReadOnly = True
                    .Visible = False
                End With
                If .CurrentCell IsNot Nothing Then .CurrentCell.Selected = False
                If .CurrentRow IsNot Nothing Then .CurrentRow.Selected = False
            End With
        Catch
        End Try

        Me.lblDeductionAMT.Text = "0.00 元"
        Me.pnlDeductionAMT.Visible = False

        If bNewSalesBillType = 1 Then
            Me.pnlNormalPayment.Visible = False
            Me.pnlBalanceContractPayment.Visible = False
            Me.pnlReturnPayment.Visible = True
            Me.lblRefundTitle.Text = "但需要输入如下来自退货中心的退货信息："
            Me.dtpRefundDate.Visible = True
            Me.dtpRefundDate.Value = Today()
            Me.dtpRefundDate.MinDate = DateAdd(DateInterval.Month, -1, Today())
            Me.dtpRefundDate.MaxDate = Today()
            Me.txbRefundDate.Visible = False
            Me.txbRefundDate.Text = Format(Me.dtpRefundDate.Value, "yyyy\/MM\/dd")
            Me.txbRefundNo.Text = ""
            Me.txbRefundNo.ReadOnly = False
            Me.txbRefundNo.BackColor = SystemColors.Window
        Else
            Me.pnlNormalPayment.Visible = True
            Me.pnlBalanceContractPayment.Visible = False
            Me.pnlReturnPayment.Visible = False
            With Me.dgvPayment
                .Visible = True
                'modify code 050:start-------------------------------------------------------------------------
                .ReadOnly = False
                'modify code 050:end-------------------------------------------------------------------------
                'modify code 044:start-------------------------------------------------------------------------
                'modify code 040:start-------------------------------------------------------------------------
                'If bNewSalesBillType = 6 Then
                '    .ReadOnly = True
                'Else
                '    .ReadOnly = False
                'End If
                'modify code 040:end-------------------------------------------------------------------------
                'modify code 044:end-------------------------------------------------------------------------
                .Columns("RowID").ReadOnly = True
                .Columns("PaymentTerm").ReadOnly = (bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 OrElse bNewSalesBillType = 6)
                .Columns("PaymentAMT").ReadOnly = (bNewSalesBillType = 2 OrElse bNewSalesBillType = 3)
                .Columns("MediaNo").ReadOnly = True
                .Columns("PayerName").ReadOnly = True
                With .Columns("ValidationState")
                    .ReadOnly = True
                    .Visible = False
                End With
                With .Columns("AuditorName")
                    .ReadOnly = True
                    .Visible = False
                End With
                With .Columns("ValidatedTime")
                    .ReadOnly = True
                    .Visible = False
                End With
                If .CurrentCell IsNot Nothing Then .CurrentCell.Selected = False
                If .CurrentRow IsNot Nothing Then .CurrentRow.Selected = False
            End With
            Me.btnModifyPaymentInfo.Visible = False
        End If

        Me.NormalCardSummary()

        'modify code 040:start-------------------------------------------------------------------------
        'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
        '    Me.lblTotalPayAmtTitle.Visible = True
        '    Me.lblTotalPayAmt.Visible = True
        '    Me.lblTotalPayAmtUnit.Visible = True
        'Else
        '    Me.lblTotalPayAmtTitle.Visible = False
        '    Me.lblTotalPayAmt.Visible = False
        '    Me.lblTotalPayAmtUnit.Visible = False
        'End If
        'modify code 040:end-------------------------------------------------------------------------

        Me.btnOK.Text = IIf(bNewSalesBillType = 1, "退货确认(&O)", "付款确认(&O)")
        Me.btnOK.Enabled = False
        Me.btnPrintTicket.Text = "打印小票(&T)"
        Me.btnPrintTicket.Enabled = False
        Me.btnConfigTicket.Enabled = (frmMain.dtAllowedRight.Select("RightName Like 'SalesBillTicket%'").Length > 0)
        Me.btnPrintApplicationForm.Enabled = False
        Me.btnConfigApplicationForm.Enabled = True
        Me.btnPrintInvoice.Text = " 打印发票(&I)"
        Me.btnPrintInvoice.Enabled = False
        Me.btnConfigInvoice.Enabled = (bNewSalesBillType <> 1 AndAlso frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 AndAlso (drInvoicePrintable Is Nothing OrElse drInvoicePrintable("CanPrintInvoice")))
        Me.btnViewActivation.Enabled = False
        Me.btnNewSalesBill.Enabled = False

        Me.Text = "创建销售单"

        sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"
        blSkipDeal = False

        If bNewSalesBillType = 5 Then
            Me.txbMemberName.Select()
            Me.txbMemberName.SelectAll()
        ElseIf bNewSalesBillType = 4 Then
            If Me.dgvRebateCard.CurrentCell IsNot Nothing Then Me.dgvRebateCard.CurrentCell.Selected = False
            If Me.dgvRebateCard.CurrentRow IsNot Nothing Then Me.dgvRebateCard.CurrentRow.Selected = False
            Me.txbInputEmployeeNo.Select()
            Me.txbInputEmployeeNo.SelectAll()
            frmMain.statusText.Text = "请输入员工编号。"
        ElseIf bNewSalesBillType = 2 Then
            Me.txbPromotionTitle.Select() : Me.txbPromotionTitle.SelectAll()
            '同一般销售单
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'ElseIf bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
        ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'modify code 040,046,054,072:end-------------------------------------------------------------------------
            Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll()
        ElseIf Me.txbBuyerName.Visible = True Then
            Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
        Else
            Me.cbbBuyerName.Select() : Me.cbbBuyerName.SelectAll()
        End If
        Me.ResetInterfaceLayout()

        'If bNewSalesBillType <> 1 AndAlso frmMain.sLoginAreaType = "S" AndAlso frmMain.dtLoginStructure.Rows.Find(frmMain.sLoginAreaID)("ParentAreaID").ToString = "20" Then '北京用户
        '    Me.cbbCustomerType.SelectedIndex = 1
        'End If
    End Sub

    Public Sub ReCreateSalesBill()
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在初始化新销售单……"
        frmMain.statusMain.Refresh()
        Me.btnEmployeeNo.Text = "确定"
        Me.txbCustomerName.Text = ""

        'modify code 046,050:start-------------------------------------------------------------------------
        Me.dgvNormalCard.Columns(23).Visible = False
        If bNewSalesBillType = 7 Then
            Me.dgvNormalCard.Columns(19).Visible = True
            Me.dgvNormalCard.Columns(20).Visible = True
            Me.dgvNormalCard.Columns(21).Visible = True
            Me.dgvNormalCard.Columns(22).Visible = True
        Else
            Me.dgvNormalCard.Columns(19).Visible = False
            Me.dgvNormalCard.Columns(20).Visible = False
            Me.dgvNormalCard.Columns(21).Visible = False
            Me.dgvNormalCard.Columns(22).Visible = False
        End If
        'modify code 046,050:end-------------------------------------------------------------------------
        'modify code 050:start-------------------------------------------------------------------------
        Me.dgvRebateCard.Columns(12).Visible = False
        '实名制卡销售单界面返点表追加实名制信息列
        If bNewSalesBillType = 7 Then
            Me.dgvRebateCard.Columns(13).Visible = True
            Me.dgvRebateCard.Columns(14).Visible = True
            Me.dgvRebateCard.Columns(15).Visible = True
            Me.dgvRebateCard.Columns(16).Visible = True
        Else
            Me.dgvRebateCard.Columns(13).Visible = False
            Me.dgvRebateCard.Columns(14).Visible = False
            Me.dgvRebateCard.Columns(15).Visible = False
            Me.dgvRebateCard.Columns(16).Visible = False
        End If
        'modify code 050:end-------------------------------------------------------------------------

        If drInternalPayer Is Nothing Then
            If (bNewSalesBillType = 2 OrElse bNewSalesBillType = 3) AndAlso dtInternalPayer.Rows.Count = 0 Then
                MessageBox.Show("当前门店未设置家乐福自购时的付款单位名称，不能建立" & IIf(bNewSalesBillType = 2, "活动", "公关") & "卡销售单！    " & Chr(13) & Chr(13) & "请通知系统管理员设置该门店自购时的付款单位名称。    ", "未设置家乐福自购时的付款单位名称！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                frmMain.statusText.Text = "门店未设置家乐福自购时的付款单位名称，不能建立" & IIf(bNewSalesBillType = 2, "活动", "公关") & "卡销售单！"
            Else
                drInternalPayer = dtInternalPayer.Rows(0)
            End If
        End If

        If bNewSalesBillType <> 1 AndAlso frmMain.sLoginAreaType = "S" AndAlso sNewestCityRuleID = "" Then
            Dim DB As New DataBase
            DB.Open()
            If Not DB.IsConnected Then
                frmMain.statusText.Text = "系统因连接不到数据库而无法创建销售单。请检查数据库连接。"
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If

            Try
                sCityID = frmMain.dtLoginStructure.Select("AreaID=" & frmMain.sLoginAreaID)(0)("ParentAreaID").ToString
                'modify code 054:start-------------------------------------------------------------------------
                'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where CityID=" & sCityID & " And RuleState=2")
                Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sCityID & " And RuleState=2")
                'modify code 054:end-------------------------------------------------------------------------
                If dtCityRule.Rows.Count > 0 Then
                    drNewestCityRule = dtCityRule.Copy.Rows(0)
                    sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                    'modify code 054:start-------------------------------------------------------------------------
                    'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).Copy
                    dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).Copy
                    'modify code 054:end-------------------------------------------------------------------------
                    For Each drDetail As DataRow In dtNewestRuleDetails.Rows
                        drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                    Next
                Else
                    sNewestCityRuleID = "-1"
                End If
                dtCityRule.Dispose() : dtCityRule = Nothing
            Catch
                frmMain.statusText.Text = "系统因在检索数据时出错而无法创建销售单。请联系软件开发人员。"
                DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default : Return
            End Try

            DB.Close()
        End If

        If sCustomerID = "" Then
            sCustomerName = "" : drCustomer = Nothing : sContractID = "" : sBalanceContractID = "" : sContractAppointedStoreID = "" : sBalanceContractAppointedStoreID = "" : drContract = Nothing
            If dtContractDetails IsNot Nothing Then dtContractDetails.Dispose() : dtContractDetails = Nothing
            If dvCustomerBuyer IsNot Nothing Then dvCustomerBuyer.Dispose() : dvCustomerBuyer = Nothing
        Else
            Dim DB As New DataBase
            DB.Open()
            If Not DB.IsConnected Then
                frmMain.statusText.Text = "系统因连接不到数据库而无法创建销售单。请检查数据库连接。"
                Me.Activate() : Me.Cursor = Cursors.Default : Return
            End If

            Try
                'Dim dtCustomer As DataTable = DB.GetDataTable("Exec CustomerSingle " & sCustomerID).Copy

                'modify code 068,072:start-------------------------------------------------------------------------
                Dim dtCustomer As DataTable
                If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                    dtCustomer = DB.GetDataTable("Exec CrossCustomerSingle " & sCustomerID).Copy
                Else
                    dtCustomer = DB.GetDataTable("Exec CustomerSingle " & sCustomerID).Copy
                End If
                'modify code 068,072:end-------------------------------------------------------------------------

                If dtCustomer.Rows.Count = 0 Then
                    MessageBox.Show("您选择的客户已经不存在（可能被删除或移位）！    ", "客户不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    If frmCustomerManagement.IsHandleCreated Then
                        Try
                            frmCustomerManagement.dvCustomer.Table.Rows.Find(sCustomerID).Delete()
                        Catch
                        End Try
                    End If
                    frmMain.statusText.Text = "客户不存在！"
                    DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default : Return
                Else
                    drCustomer = dtCustomer.Rows(0)
                    dtCustomer.Dispose() : dtCustomer = Nothing
                    If drCustomer("Stopped") Then
                        MessageBox.Show("您选择的客户已被停止使用，再也不能向该客户售卡！    " & Chr(13) & Chr(13) & "停用客户： " & drCustomer("StoreCode").ToString & drCustomer("CustomerCode").ToString & " " & drCustomer("CustomerChineseName").ToString & Space(4) & IIf(drCustomer("StoppedReason").ToString = "", "", Chr(13) & "停用原因： " & drCustomer("StoppedReason").ToString & Space(4)), "客户已被停止使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        If frmCustomerManagement.IsHandleCreated Then
                            Try
                                Dim customer As DataRow = frmCustomerManagement.dvCustomer.Table.Rows.Find(sCustomerID)
                                customer("StateDescription") = "停止使用 Blocked" : customer("Stopped") = 1
                                customer.AcceptChanges() : customer = Nothing
                            Catch
                            End Try
                        End If
                        frmMain.statusText.Text = "客户已被停止使用！"
                        DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default : Return
                    Else
                        dvCustomerBuyer = DB.GetDataTable("Exec GetCustomerBuyer " & sCustomerID & "," & drSalesBill("StoreID").ToString).DefaultView
                        Me.CombineCustomerBuyer()
                    End If
                End If

                sContractID = drCustomer("ValidContractID").ToString : sContractAppointedStoreID = ""
                If sContractID = "" Then
                    If drContract IsNot Nothing Then
                        drContract = Nothing : dtContractDetails.Dispose() : dtContractDetails = Nothing
                    End If
                Else
                    '下载合同参数
                    Try
                        'drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                        'dtContractDetails = DB.GetDataTable("Select * From ContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy

                        'modify code 068,072:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                            drContract = DB.GetDataTable("Exec GetCrossContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                            dtContractDetails = DB.GetDataTable("Select * From CrossContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy
                        Else
                            drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                            dtContractDetails = DB.GetDataTable("Select * From ContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy
                        End If
                        'modify code 068,072:end-------------------------------------------------------------------------

                    Catch
                        sCustomerID = ""
                        sCustomerPrompt = "系统因在检索数据时出错而无法下载合同资料。请联系软件开发人员。"
                        frmMain.statusText.Text = sCustomerPrompt
                        sTimerType = "CustomerError"
                        Me.theTimer.Interval = 50
                        Me.theTimer.Enabled = True
                    End Try
                    sContractAppointedStoreID = drContract("AppointedStoreID").ToString
                End If

                sBalanceContractID = drCustomer("BalanceContractID").ToString : sBalanceContractAppointedStoreID = ""
                If sBalanceContractID <> "" Then
                    Try
                        'sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From ContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString

                        'modify code 068,072:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                            sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From CrossContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString
                        Else
                            sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From ContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString
                        End If
                        'modify code 068,072:end-------------------------------------------------------------------------

                    Catch
                        sCustomerID = ""
                        sCustomerPrompt = "系统因在检索数据时出错而无法下载合同资料。请联系软件开发人员。"
                        frmMain.statusText.Text = sCustomerPrompt
                        sTimerType = "CustomerError"
                        Me.theTimer.Interval = 50
                        Me.theTimer.Enabled = True
                    End Try
                End If

                sNewestCityRuleID = ""
                If sCityID = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString AndAlso drNewestCityRule IsNot Nothing Then
                    sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                Else
                    sCityID = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
                    'modify code 054:start-------------------------------------------------------------------------
                    'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where CityID=" & sCityID & " And RuleState=2")
                    Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sCityID & " And RuleState=2")
                    'modify code 054:end-------------------------------------------------------------------------
                    If dtCityRule.Rows.Count = 0 Then
                        drNewestCityRule = Nothing
                        If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                        sNewestCityRuleID = "-1"
                    Else
                        drNewestCityRule = dtCityRule.Copy.Rows(0)
                        sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                        'modify code 054:start-------------------------------------------------------------------------
                        'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).Copy
                        dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).Copy
                        'modify code 054:end-------------------------------------------------------------------------
                        For Each drDetail As DataRow In dtNewestRuleDetails.Rows
                            drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                        Next
                    End If
                    dtCityRule.Dispose() : dtCityRule = Nothing

                    If frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 Then
                        Dim dtInovicePrintable As DataTable = DB.GetDataTable("Select * From InvoicePrintable Where CityID=" & sCityID)
                        If dtInovicePrintable.Rows.Count = 0 Then
                            drInvoicePrintable = dtInovicePrintable.Copy.Rows.Add()
                            drInvoicePrintable("CityID") = sCityID
                            drInvoicePrintable("CanPrintInvoice") = 1
                            drInvoicePrintable("CanPrintInNextMonth") = 1
                            drInvoicePrintable("MinInvoiceAMT") = 0
                            drInvoicePrintable("MaxInvoiceAMT") = 500000
                            drInvoicePrintable.AcceptChanges()
                        Else
                            drInvoicePrintable = dtInovicePrintable.Copy.Rows(0)
                        End If
                        dtInovicePrintable.Dispose() : dtInovicePrintable = Nothing
                    End If
                End If

                DB.Close()
            Catch
                frmMain.statusText.Text = "系统因在检索数据时出错而无法创建销售单。请联系软件开发人员。"
                DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default : Return
            End Try
        End If

        Me.btnViewActivation.Text = "激活明细(&A)" : Me.btnViewActivation.Enabled = False
        If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then frmCheckCardResult.Close()
        If dtLastCheckingProblemCard IsNot Nothing AndAlso dtLastCheckingProblemCard.Rows.Count > 0 Then dtLastCheckingProblemCard.Rows.Clear() : dtLastCheckingProblemCard.AcceptChanges()
        If dtAllCheckedCard IsNot Nothing AndAlso dtAllCheckedCard.Rows.Count > 0 Then dtAllCheckedCard.Rows.Clear() : dtAllCheckedCard.AcceptChanges()
        sFirstCheckCardTime = "" : blCanRecheckCard = False : blNeedReloadCard = False : bHightLightTimes = 0

        errorNormalCell = Nothing : sErrorNormalInfo = "" : errorRebateCell = Nothing : sErrorRebateInfo = ""
        Me.cbbBuyerName.Items.Clear() : Me.cbbTelMP.Items.Clear()

        sSalesBillID = "-1"
        drSalesBill = drSalesBill.Table.Rows.Add
        drSalesBill("SalesBillType") = bNewSalesBillType
        drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
        If bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
            drSalesBill("StoreID") = drInternalPayer("StoreID")
            drSalesBill("CustomerName") = drInternalPayer("StoreName").ToString
            drSalesBill("BuyerName") = IIf(bNewSalesBillType = 2, drInternalPayer("MKLinkman").ToString, drInternalPayer("PRLinkman").ToString)
            drSalesBill("TelMP") = IIf(bNewSalesBillType = 2, drInternalPayer("MKTelMP").ToString, drInternalPayer("PRTelMP").ToString)
            drSalesBill("BuyerCredentialsType") = IIf(bNewSalesBillType = 2, drInternalPayer("MKCredentialsType").ToString, drInternalPayer("PRCredentialsType").ToString)
            If drSalesBill("BuyerCredentialsType").ToString = "" Then drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
            drSalesBill("BuyerCredentialsNo") = IIf(bNewSalesBillType = 2, drInternalPayer("MKCredentialsNo").ToString, drInternalPayer("PRCredentialsNo").ToString)
            drSalesBill("CompanyCredentialsType") = "税务登记证"
            drSalesBill("CompanyCredentialsNo") = drInternalPayer("ReceiverTaxNo").ToString
            If drSalesBill("BuyerName").ToString <> "" Then Me.cbbBuyerName.Items.Add(drSalesBill("BuyerName").ToString)
            If drSalesBill("TelMP").ToString <> "" Then Me.cbbTelMP.Items.Add(drSalesBill("TelMP").ToString)
        ElseIf bNewSalesBillType = 4 Then
            sEmployeePrompt = "请输入员工编号。" : sEmployeeID = "" : sEmployeeNo = "" : sOldEmployeeID = "" : sOldEmployeeNo = "" : drEmployee = Nothing
        ElseIf bNewSalesBillType = 5 Then
            drMember = Nothing
        End If
        drSalesBill("CardQTY") = 0
        drSalesBill("NormalCardQTY") = 0
        drSalesBill("NormalSalesAMT") = 0
        drSalesBill("CardCost") = 0
        drSalesBill("RebateMode") = 0 '没有返点
        drSalesBill("RebateCardQTY") = 0
        drSalesBill("RebateSalesAMT") = 0
        'modify code 040,046,054,072:start-------------------------------------------------------------------------
        'If bNewSalesBillType = 0 AndAlso sNewestCityRuleID <> "-1" AndAlso sNewestCityRuleID <> "" Then drSalesBill("CityRuleID") = sNewestCityRuleID
        'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso sNewestCityRuleID <> "-1" AndAlso sNewestCityRuleID <> "" Then drSalesBill("CityRuleID") = sNewestCityRuleID
        'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso sNewestCityRuleID <> "-1" AndAlso sNewestCityRuleID <> "" Then drSalesBill("CityRuleID") = sNewestCityRuleID
        If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso sNewestCityRuleID <> "-1" AndAlso sNewestCityRuleID <> "" Then drSalesBill("CityRuleID") = sNewestCityRuleID
        'modify code 040,046,054,072:end-------------------------------------------------------------------------
        drSalesBill("AddToContract") = 0
        drSalesBill("FirstAvailableRowID") = -1
        drSalesBill("SecondAvailableRowID") = -1
        drSalesBill("PayableAMT") = 0
        drSalesBill("PrintedInvoiceAMT") = 0
        drSalesBill("ChargedAMT") = 0
        drSalesBill("ActivatedAMT") = 0
        drSalesBill("SalesBillState") = 0
        drSalesBill("ActivationCancelledAMT") = 0
        drSalesBill("TableType") = 0
        If bNewSalesBillType = 1 Then drSalesBill("RefundDate") = Today()

        If frmMain.sLoginAreaType = "S" Then
            drSalesBill("StoreID") = frmMain.sLoginAreaID
            Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
            drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
            sCULCardBin = drStore("CULCardBin").ToString
            sGiftCardBin = "60" & sCULCardBin.Substring(2)
            sGiftCardBin = sGiftCardBin.Replace("|84", "|60")
            sFreeCardBin = "92" & sCULCardBin.Substring(2)
            sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
            sPaperCardBin = "86" & sCULCardBin.Substring(2)
            sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
            sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
            If bNewSalesBillType = 2 Then
                sCULCardBin = "94" & sCULCardBin.Substring(2)
                sCULCardBin = sCULCardBin.Replace("|84", "|94")
                sPaperCardBin = sCULCardBin
            ElseIf bNewSalesBillType = 3 Then
                sCULCardBin = "92" & sCULCardBin.Substring(2)
                sCULCardBin = sCULCardBin.Replace("|84", "|92")
                sPaperCardBin = sCULCardBin
            End If
        End If

        Dim DB1 As New DataBase
        Dim strBin As String

        'modify code 050:start-------------------------------------------------------------------------
        sSignCardBin = frmMain.signCardBin & sCULCardBin.Substring(2)
        sSignCardBin = sSignCardBin.Replace("|84", "|" & frmMain.signCardBin)
        strBin = Replace(sSignCardBin, "|", "','")
        DB1.Open()
        dtSignCardRangeNew = DB1.GetDataTable("Select * From SignCardListNew Where CardType = '实名制卡' and SUBSTRING(cardno,5,5) in ('" & strBin & "')").Copy
        strBin = Replace(sCULCardBin & "|" & sGiftCardBin, "|", "','")
        dtSignCardRangeOld = DB1.GetDataTable("Select * From SignCardList Where CardType = '实名制卡' and SUBSTRING(cardno,5,5) in ('" & strBin & "')").Copy
        DB1.Close()
        DB1.Dispose()
        'modify code 050:end-------------------------------------------------------------------------

        blSkipDeal = True
        Call LockWindowUpdate(Me.Handle)

        If sCustomerID = "" Then
            drSalesBill("CustomerStoreID") = drSalesBill("StoreID")
            drSalesBill("CustomerType") = 0 '个人客户

            If bNewSalesBillType = 2 AndAlso drInternalPayer("LastPromotionPeriod").ToString <> "" Then
                Dim sPromotionPeriod As String = drInternalPayer("LastPromotionPeriod").ToString
                If CDate(sPromotionPeriod.Substring(sPromotionPeriod.LastIndexOf("-") + 1).Trim) >= Today Then
                    drSalesBill("PromotionTitle") = drInternalPayer("LastPromotionTitle").ToString
                    drSalesBill("PromotionPeriod") = sPromotionPeriod
                End If
            End If
        Else
            If drSalesBill("StoreID").ToString = "" Then
                drSalesBill("StoreID") = drCustomer("StoreID")
                Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
                drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
                sCULCardBin = drStore("CULCardBin").ToString
                sGiftCardBin = "60" & sCULCardBin.Substring(2)
                sGiftCardBin = sGiftCardBin.Replace("|84", "|60")
                sFreeCardBin = "92" & sCULCardBin.Substring(2)
                sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
                sPaperCardBin = "86" & sCULCardBin.Substring(2)
                sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
                sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
                If bNewSalesBillType = 2 Then
                    sCULCardBin = "94" & sCULCardBin.Substring(2)
                    sCULCardBin = sCULCardBin.Replace("|84", "|94")
                    sPaperCardBin = sCULCardBin
                ElseIf bNewSalesBillType = 3 Then
                    sCULCardBin = "92" & sCULCardBin.Substring(2)
                    sCULCardBin = sCULCardBin.Replace("|84", "|92")
                    sPaperCardBin = sCULCardBin
                End If
            End If
            drSalesBill("CustomerType") = 1 '公司客户
            drSalesBill("CustomerID") = sCustomerID
            drSalesBill("CustomerName") = drCustomer("CustomerChineseName").ToString
            drSalesBill("CustomerStoreID") = drCustomer("StoreID")
            Me.cbbBuyerName.Items.Clear()
            Me.cbbTelMP.Items.Clear()
            If dvCustomerBuyer.Count > 0 Then
                drSalesBill("BuyerName") = dvCustomerBuyer(0)("BuyerName").ToString
                drSalesBill("TelMP") = dvCustomerBuyer(0)("TelMP").ToString
                If dvCustomerBuyer(0)("CredentialsType").ToString = "" Then
                    drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                Else
                    drSalesBill("BuyerCredentialsType") = dvCustomerBuyer(0)("CredentialsType").ToString
                    drSalesBill("BuyerCredentialsNo") = dvCustomerBuyer(0)("CredentialsNo").ToString
                End If
                dvCustomerBuyer.RowFilter = ""
                For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                    Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                Next
                dvCustomerBuyer.RowFilter = "BuyerName='" & dvCustomerBuyer(0)("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                For Each drTelMP As DataRowView In dvCustomerBuyer
                    Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                Next
            End If
            If drCustomer("AllowNoCredentials") Then
                If Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = -1 Then Me.cbbCompanyCredentialsType.Items.Insert(0, "（特准无需证件）")
                drSalesBill("CompanyCredentialsType") = "（特准无需证件）"
            Else
                If Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = 0 Then Me.cbbCompanyCredentialsType.Items.RemoveAt(0)
                If drCustomer("CompanyCredentialsType").ToString = "" Then
                    drSalesBill("CompanyCredentialsType") = Me.cbbCompanyCredentialsType.Items(0)
                Else
                    drSalesBill("CompanyCredentialsType") = drCustomer("CompanyCredentialsType").ToString
                    drSalesBill("CompanyCredentialsNo") = drCustomer("CompanyCredentialsNo").ToString
                End If
            End If

            If sContractID <> "" Then
                drSalesBill("ContractID") = sContractID
                drSalesBill("ContractCode") = drCustomer("ValidContractCode").ToString
                drSalesBill("ContractMode") = drContract("PaymentMode").ToString & drContract("CalculationMode").ToString
                Select Case drContract("CalculationDay")
                    Case 0
                        drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "0" '合同期满后兑现累计返点
                    Case 255
                        drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "2" '每次购买时兑现累计返点
                    Case Else
                        drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "1" '每月一次兑现累计返点
                End Select
            End If
            If sBalanceContractID <> "" Then
                drSalesBill("BalanceContractID") = sBalanceContractID
                drSalesBill("BalanceContractCode") = drCustomer("BalanceContractCode").ToString
                drSalesBill("BalanceContractBalanceRebateAMT") = drCustomer("BalanceRebateAMT")
            End If
        End If

        Try
            Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
            dmCardCost = CDec(drCity("CardCost")) : dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue")) : blCanUse60Card = drCity("Use60Card") : blCanUse92Card = drCity("Use92Card") : blCanUse94Card = drCity("Use94Card") : blCanUsePaperCard = drCity("UsePaperCard") : blHaveThreeMedia = drCity("ThreeMedia")
            'modify code 051:start-------------------------------------------------------------------------
            blCanUse65Card = drCity("Use65Card")
            'modify code 051:end-------------------------------------------------------------------------
        Catch
            dmCardCost = 0 : dmMinFaceValue = 1 : dmMaxFaceValue = 1000 : blCanUse60Card = False : blCanUse92Card = False : blCanUse94Card = False : blCanUsePaperCard = False : blHaveThreeMedia = True
            'modify code 051:start-------------------------------------------------------------------------
            blCanUse65Card = False
            'modify code 051:end-------------------------------------------------------------------------
        End Try

        If blUsedOldCard OrElse (bNewSalesBillType > 0 AndAlso bNewSalesBillType < 4) Then dmCardCost = 0 : dmMinFaceValue = 0
        If bNewSalesBillType = 4 Then dmCardCost = 0 : dmMinFaceValue = 100 '如果是员工单，不收卡费，最低面值100元
        'modify code 004:start-------------------------------------------------------------------------
        'dtCardCost.Rows.Clear()
        'For iLevel As Integer = CInt(dmCardCost) To 0 Step -1
        '    dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
        'Next
        'dtCardCost.AcceptChanges()
        'modify code 004:end-------------------------------------------------------------------------

        dtNormalCard.Rows.Clear() : dtNormalCard.AcceptChanges() : dtNormalCard.Rows.Add(1)
        'modify code 004:start-------------------------------------------------------------------------
        If sSalesBillID = -1 Then
            Dim newColumnFirstBuy As New DataGridViewComboBoxColumn
            With newColumnFirstBuy
                .DataPropertyName = "FirstBuy"
                '.DataSource = dtFirstBuy
                .ValueMember = "FirstBuy"
                .DisplayMember = "FirstBuy"
                .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
            End With
            Me.dgvNormalCard.Columns.RemoveAt(1)
            Me.dgvNormalCard.Columns.Insert(1, newColumnFirstBuy)
            With Me.dgvNormalCard.Columns(1)
                .HeaderText = "购卡/充值"
                .Width = 90
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            Me.dgvNormalCard.Columns(1).Name = dtNormalCard.Columns(1).ColumnName

            Dim newColumn As New DataGridViewComboBoxColumn
            With newColumn
                .DataPropertyName = "CardCost"
                '.DataSource = dtCardCost
                .ValueMember = "CardCost"
                '.DisplayMember = "FormattedCardCost"
                .DisplayMember = "CardCost"
                .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
            End With
            Me.dgvNormalCard.Columns.RemoveAt(9)
            Me.dgvNormalCard.Columns.Insert(9, newColumn)
            With Me.dgvNormalCard.Columns(9)
                .HeaderText = "卡费/张"
                .Width = 80
                .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                .SortMode = DataGridViewColumnSortMode.NotSortable
                .Resizable = DataGridViewTriState.False
            End With
            Me.dgvNormalCard.Columns(9).Name = dtNormalCard.Columns(9).ColumnName

            'modify code 063:start-------------------------------------------------------------------------
            If bNewSalesBillType = 7 Then
                Dim newColumnGender As New DataGridViewComboBoxColumn
                newColumnGender.Items.Add("男")
                newColumnGender.Items.Add("女")
                With newColumnGender
                    .DataPropertyName = "Gender"
                    .ValueMember = "Gender"
                    .DisplayMember = "Gender"
                    .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                    .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                End With

                Me.dgvNormalCard.Columns.RemoveAt(20)
                Me.dgvNormalCard.Columns.Insert(20, newColumnGender)
                With Me.dgvNormalCard.Columns(20)
                    .HeaderText = "性别"
                    .Width = 50
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                End With
                Me.dgvNormalCard.Columns(20).Name = dtNormalCard.Columns(20).ColumnName
            End If
            'modify code 063:end-------------------------------------------------------------------------
        End If
        'modify code 004:end-------------------------------------------------------------------------
        dtRebateCard.Rows.Clear() : dtRebateCard.AcceptChanges() : dtRebateCard.Rows.Add(1)
        If bNewSalesBillType = 4 Then
            'modify code 016:start-------------------------------------------------------------------------
            '员工单可以使用现金和银行卡，目前只有上海家乐福总部人员可见银行卡支付方式（可设置）
            If dtBankCardStoreID.Rows.Count > 0 Then
                For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>1")
                    drPaymentTerm.Delete()
                Next
            Else
                For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>0")
                    drPaymentTerm.Delete()
                Next
            End If
            'modify code 016:end-------------------------------------------------------------------------
        Else
            'modify code 008:start-------------------------------------------------------------------------
            'For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>4")
            For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>4 and PaymentTerm<>7")
                'modify code 008:start-------------------------------------------------------------------------
                drPaymentTerm.Delete()
            Next
        End If
        dtPaymentTerm.AcceptChanges()
        dtPayment.Rows.Clear() : dtPayment.AcceptChanges() : dtPayment.Rows.Add(1, 0)
        If bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
            dtPayment.Rows(0)("PaymentTerm") = 2
            dtPayment.Rows(0)("MediaNo") = Format(Today(), "yyyyMMdd")
            dtPayment.Rows(0)("PayerName") = Me.cbbAvailablePayer.Text
        End If
        dtRowPayment.Rows.Clear() : dtRowPayment.AcceptChanges()
        dtSelectablePayment.Rows.Clear() : dtSelectablePayment.AcceptChanges()
        If dtInvoice IsNot Nothing Then dtInvoice.Rows.Clear() : dtInvoice.AcceptChanges()
        If dtActivation IsNot Nothing Then dtActivation.Dispose() : dtActivation = Nothing : sActivationLoadedTime = ""

        dmNormalSalesAMT = 0 : dmPayableAMT = 0 : dmReceivedAMT = 0 : dmAvailableRebateAMT = 0 : dmAvailableRebateRate = 0 : dmRebateSalesAMT = 0 : dmTotalChargedAMT = 0 : dmTotalRebateAMT = 0 : dmTotalPaymentAMT = 0 : dmTotalPrintedInvoiceAMT = 0
        dmMaxNormalRebateRate = 0 : dmMaxNormalRebateAMT = 0 : blCalculateNormalRebateByRate = True
        iFirstAvailableRowID = -1 : iSecondAvailableRowID = -1
        blUsedOldCard = False ' 当按主菜单“特殊操作”的子菜单“从文件中充值”或“购物卡再充值”时，blUsedOldCard = True
        blIsChanged = False
        drImportedFile = Nothing
        If dtImportedDetails IsNot Nothing Then dtImportedDetails.Dispose() : dtImportedDetails = Nothing
        Me.FillNewSalesBill()

        blSkipDeal = False
        Call LockWindowUpdate(0)

        If sBalanceContractID <> "" AndAlso (sBalanceContractAppointedStoreID = "" OrElse sBalanceContractAppointedStoreID = drSalesBill("StoreID").ToString) AndAlso _
        MessageBox.Show("发现当前客户存在已到期但仍有剩余返点等待结算的合同。    " & Chr(13) & Chr(13) & _
                       "是否现在就结算该合同的剩余返点？    " & Chr(13) & Chr(13) & _
                       "注意：结算到期合同的剩余返点时，不能售卖正常卡。    ", "是否结算到期合同的剩余返点？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.Yes Then
            Me.chbBalanceContract.Checked = True
        ElseIf bNewSalesBillType = 5 Then
            Me.txbMemberName.Select()
            Me.txbMemberName.SelectAll()
        ElseIf bNewSalesBillType = 4 Then
            If Me.dgvRebateCard.CurrentCell IsNot Nothing Then Me.dgvRebateCard.CurrentCell.Selected = False
            If Me.dgvRebateCard.CurrentRow IsNot Nothing Then Me.dgvRebateCard.CurrentRow.Selected = False
            Me.txbInputEmployeeNo.Select()
            Me.txbInputEmployeeNo.SelectAll()
            frmMain.statusText.Text = "请输入员工编号。"
        ElseIf bNewSalesBillType = 2 Then
            Me.txbPromotionTitle.Select() : Me.txbPromotionTitle.SelectAll()
            '同一般销售单
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'ElseIf bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
        ElseIf (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 1 AndAlso Me.txbCompanyCredentialsNo.Text = "" Then
            'modify code 040,046,054,072:end-------------------------------------------------------------------------
            Me.cbbCompanyCredentialsType.Select() : Me.cbbCompanyCredentialsType.SelectAll()
        ElseIf Me.txbBuyerName.Visible = True Then
            Me.txbBuyerName.Select() : Me.txbBuyerName.SelectAll()
        Else
            Me.cbbBuyerName.Select() : Me.cbbBuyerName.SelectAll()
        End If

        frmMain.statusText.Text = "就绪。"
        Me.Activate() : Me.Cursor = Cursors.Default

        'If drSalesBill("CustomerType") = 1 AndAlso sCustomerID = "" Then '北京使用
        '    Me.txbCustomerName.Select()
        '    sTimerType = "CreateNewSalesBill"
        '    Me.theTimer.Interval = 100
        '    Me.theTimer.Enabled = True
        'End If
    End Sub

    Public Sub UpdateInterFaceWhenImportFile()
        drSalesBill("ImportedFromFile") = drImportedFile("SourceFile").ToString.Substring(drImportedFile("SourceFile").ToString.LastIndexOf("\") + 1)

        Me.cbbSalesBillType.Visible = False
        Me.txbSalesBillType.Visible = True
        Me.cbbCustomerType.Visible = False
        Me.txbCustomerName.ReadOnly = True
        Me.txbCustomerName.BackColor = SystemColors.Window
        Me.txbCustomerName.BackColor = SystemColors.Control
        Me.btnNewCustomer.Visible = False

        Me.pnlImportedFile.Visible = True
        With Me.lblSourceFile
            .Text = drImportedFile("SourceFile")
            .Font = New Font(.Font, FontStyle.Underline)
            .ForeColor = Color.Blue
            .Cursor = Cursors.Hand
        End With
        Me.theTip.SetToolTip(Me.lblSourceFile, "单击此链接可以在Microsoft Excel中打开该文件。")

        blSkipDeal = True
        dtNormalCard.Rows.Clear()
        Dim drNormal As DataRow, iRowID As Int16 = 1
        For Each drCard As DataRow In dtImportedDetails.Select("ImportedState='已导入'")
            drNormal = dtNormalCard.Rows.Add
            drNormal("RowID") = iRowID
            drNormal("StartCardNo") = drCard("CardNo").ToString
            drNormal("EndCardNo") = drCard("CardNo").ToString

            'modify code 004:start-------------------------------------------------------------------------
            Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = SetFirstBuy(Me.dgvNormalCard("StartCardNo", iRowID - 1).Value.ToString, iRowID - 1)
            'modify code 046:start-------------------------------------------------------------------------
            'Me.dgvNormalCard("CardCost", iRowID - 1).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", iRowID - 1).Value.ToString, Me.dgvNormalCard("FirstBuy", iRowID - 1).Value.ToString, iRowID - 1)
            'If Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = "购卡" Then Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = "充值"
            'modify code 046:end-------------------------------------------------------------------------
            If Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = "" Then Me.dgvNormalCard("CardCost", iRowID - 1).Value = Format(0, "#,0.00")
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 050:start-------------------------------------------------------------------------
            'modify code 046:start-------------------------------------------------------------------------
            Me.cbbCustomerType.Visible = True
            Me.btnNewCustomer.Visible = True
            Me.txbCustomerName.ReadOnly = False
            Me.txbCustomerName.BackColor = SystemColors.Window

            If bNewSalesBillType = 7 Then
                If dtSignCardRangeNew.Select("CardNo ='" & drCard("CardNo").ToString & "'").Length = 1 Then
                    Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = SetFirstBuy("", iRowID - 1, "充值")
                    Me.dgvNormalCard("CardCost", iRowID - 1).Value = Format(0, "#,0.00")

                    Me.dgvNormalCard("HolderName", iRowID - 1).Value = ""
                    Me.dgvNormalCard("Gender", iRowID - 1).Value = ""
                    Me.dgvNormalCard("HolderIdNo", iRowID - 1).Value = ""
                    Me.dgvNormalCard("Mobile", iRowID - 1).Value = ""
                Else
                    Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = SetFirstBuy("", iRowID - 1, "购卡")
                    Me.dgvNormalCard("CardCost", iRowID - 1).Value = Format(CDec(drCard("CardCost").ToString), "#,0.00")

                    Me.dgvNormalCard("HolderName", iRowID - 1).Value = drCard("HolderName").ToString
                    Me.dgvNormalCard("Gender", iRowID - 1).Value = drCard("Gender").ToString
                    Me.dgvNormalCard("HolderIdNo", iRowID - 1).Value = drCard("HolderIdNo").ToString
                    Me.dgvNormalCard("Mobile", iRowID - 1).Value = drCard("Mobile").ToString
                End If
            End If
            'modify code 046:end-------------------------------------------------------------------------
            'modify code 050:end-------------------------------------------------------------------------

            drNormal("CardQTY") = 1
            drNormal("FaceValue") = CDec(drCard("FaceValue").ToString)
            drNormal("ReducedCardPayment") = 0
            'modify code 046:start-------------------------------------------------------------------------
            'modify code 004:start-------------------------------------------------------------------------
            'drNormal("CardCost") = 0
            'drNormal("CardCost") = Format(0, "#,0.00")
            'modify code 050:start-------------------------------------------------------------------------
            If bNewSalesBillType <> 7 Then
                '    drNormal("CardCost") = CDec(drCard("CardCost").ToString)
                'Else
                drNormal("CardCost") = Format(0, "#,0.00")
            Else
                If Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = "充值" Then
                    drNormal("CardCost") = Format(0, "#,0.00")
                Else
                    drNormal("CardCost") = CDec(drCard("CardCost").ToString)
                End If
            End If
            'modify code 050:end-------------------------------------------------------------------------
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 046:end-------------------------------------------------------------------------
            drNormal("CardPayment") = CDec(drCard("FaceValue").ToString)
            drNormal("ChargedAMT") = CDec(drCard("FaceValue").ToString)
            drNormal("PayableAMT") = CDec(drCard("FaceValue").ToString)
            drNormal("CostAMT") = 0
            'modify code 050:start-------------------------------------------------------------------------
            'modify code 046:start-------------------------------------------------------------------------
            If bNewSalesBillType = 7 Then
                'drNormal("CostAMT") = CDec(drCard("CardCost").ToString)
                drNormal("CostAMT") = CDec(Me.dgvNormalCard("CardCost", iRowID - 1).Value)
                drNormal("PayableAMT") = CDec(drCard("FaceValue").ToString) + drNormal("CostAMT")
            End If
            'modify code 046:end-------------------------------------------------------------------------
            'modify code 050:end-------------------------------------------------------------------------
            iRowID += 1
        Next
        blSkipDeal = False

        With Me.dgvNormalCard
            .Columns("StartCardNo").ReadOnly = True
            .Columns("EndCardNo").ReadOnly = True
            .Columns("CardQTY").ReadOnly = True
            .Columns("FaceValue").ReadOnly = True
            'modify code 004:start-------------------------------------------------------------------------
            '.Columns("CardCost").Visible = False
            .Columns("FirstBuy").ReadOnly = True
            .Columns("CardCost").ReadOnly = True
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 011:start-------------------------------------------------------------------------
            .Columns("BarCode").ReadOnly = True
            'modify code 011:end-------------------------------------------------------------------------
            'modify code 046:start-------------------------------------------------------------------------
            If bNewSalesBillType = 7 Then
                .Columns("HolderName").ReadOnly = True
                .Columns("Gender").ReadOnly = True
                .Columns("HolderIdNo").ReadOnly = True
                .Columns("Mobile").ReadOnly = True
                .Columns("CardCost").Visible = True
            Else
                .Columns("CardCost").Visible = False
            End If
            'modify code 046:end-------------------------------------------------------------------------
        End With

        'modify code 004:start-------------------------------------------------------------------------
        'For i As Integer = 0 To Me.dgvNormalCard.RowCount - 1
        '    Me.dgvNormalCard("FirstBuy", i).Value = SetFirstBuy(Me.dgvNormalCard("StartCardNo", i).Value.ToString, i)
        '    Me.dgvNormalCard("CardCost", i).Value = SetCardCost(Me.dgvNormalCard("StartCardNo", i).Value.ToString, Me.dgvNormalCard("FirstBuy", i).Value.ToString, i)
        '    If Me.dgvNormalCard("FirstBuy", i).Value = "购卡" Then Me.dgvNormalCard("FirstBuy", i).Value = "充值"
        '    If Me.dgvNormalCard("FirstBuy", i).Value = "" Then Me.dgvNormalCard("CardCost", i).Value = Format(0, "#,0.00")
        'Next
        'Me.dgvNormalCard.Columns("FirstBuy").ReadOnly = True
        'Me.dgvNormalCard.Columns("CardCost").ReadOnly = True
        'modify code 004:end-------------------------------------------------------------------------

        Me.NormalCardSummary()

        Me.btnNewSalesBill.Enabled = True
    End Sub

    'modify code 072:end-------------------------------------------------------------------------
    Public Sub UpdateInterFaceWhenElectronic()
        drSalesBill("ImportedFromFile") = ""
        Me.cbbSalesBillType.Visible = False
        Me.txbSalesBillType.Visible = True
        Me.cbbCustomerType.Visible = False
        Me.txbCustomerName.ReadOnly = True
        Me.btnNewCustomer.Visible = False

        blSkipDeal = True
        dtNormalCard.Rows.Clear()
        Dim drNormal As DataRow, iRowID As Int16 = 1
        For Each drCard As DataRow In dtImportedDetails.Select("ImportedState='已导入'")
            drNormal = dtNormalCard.Rows.Add
            drNormal("RowID") = iRowID
            drNormal("StartCardNo") = drCard("StartCardNo").ToString
            drNormal("EndCardNo") = drCard("EndCardNo").ToString

            Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = SetFirstBuy(Me.dgvNormalCard("StartCardNo", iRowID - 1).Value.ToString, iRowID - 1)
            If Me.dgvNormalCard("FirstBuy", iRowID - 1).Value = "" Then Me.dgvNormalCard("CardCost", iRowID - 1).Value = Format(0, "#,0.00")
            Me.cbbCustomerType.Visible = True
            Me.btnNewCustomer.Visible = True
            Me.txbCustomerName.ReadOnly = False
            Me.txbCustomerName.BackColor = SystemColors.Window

            drNormal("CardQTY") = drCard("CardQTY").ToString
            drNormal("FaceValue") = CDec(drCard("FaceValue").ToString)
            drNormal("ReducedCardPayment") = 0
            drNormal("CardCost") = Format(0, "#,0.00")
            drNormal("CardPayment") = CDec(drCard("FaceValue").ToString) * CDec(drCard("CardQTY").ToString)
            drNormal("ChargedAMT") = CDec(drCard("FaceValue").ToString) * CDec(drCard("CardQTY").ToString)
            drNormal("PayableAMT") = CDec(drCard("FaceValue").ToString) * CDec(drCard("CardQTY").ToString)
            drNormal("CostAMT") = 0

            iRowID += 1
        Next
        drNormal = dtNormalCard.Rows.Add
        drNormal("RowID") = iRowID
        blSkipDeal = False

        With Me.dgvNormalCard
            .Columns("StartCardNo").ReadOnly = True
            .Columns("EndCardNo").ReadOnly = True
            .Columns("CardQTY").ReadOnly = True
            .Columns("FaceValue").ReadOnly = True
            .Columns("FirstBuy").ReadOnly = True
            .Columns("CardCost").ReadOnly = True
            .Columns("BarCode").ReadOnly = True
            .Columns("CardCost").Visible = False
        End With

        Me.NormalCardSummary()
        Me.btnNewSalesBill.Enabled = True
    End Sub
    'modify code 072:end-------------------------------------------------------------------------

    Private Sub FillSalesBill()
        Me.grbSalesBillType.Text = "销售单类型："
        Me.txbSalesBillType.Visible = True
        Select Case drSalesBill("SalesBillType")
            Case 0
                Me.txbSalesBillType.Text = "一般销售单"
            Case 1
                Me.txbSalesBillType.Text = "退货销售单"
            Case 2
                Me.txbSalesBillType.Text = "活动卡销售单"
            Case 3
                Me.txbSalesBillType.Text = "公关卡销售单"
            Case 4
                Me.txbSalesBillType.Text = "员工销售单"
                'modify code 040:start-------------------------------------------------------------------------
            Case 6
                Me.txbSalesBillType.Text = "线下提卡销售单"
                'modify code 040:end-------------------------------------------------------------------------
                'modify code 046:start-------------------------------------------------------------------------
            Case 7
                Me.txbSalesBillType.Text = "实名制卡销售单"
                'modify code 046:end-------------------------------------------------------------------------
                'modify code 054:start-------------------------------------------------------------------------
            Case 8
                Me.txbSalesBillType.Text = "通卖非实名卡销售单"
                'modify code 054:end-------------------------------------------------------------------------
                'modify code 072:start-------------------------------------------------------------------------
            Case 9
                Me.txbSalesBillType.Text = "电子卡销售单"
                'modify code 072:end-------------------------------------------------------------------------
            Case Else
                Me.txbSalesBillType.Text = "联名卡销售单"
        End Select
        Me.cbbSalesBillType.Visible = False

        If drSalesBill("SalesBillType") = 4 Then
            Me.flpEmployee.Visible = True
            Me.grbInputEmployeeNo.Visible = False
            Me.grbEmployeeInfo.Visible = True
            Me.grbEmployeeInfo.Text = "员工信息："
            Me.pnlEmployeeNo.Visible = True
            Me.txbEmployeeNo.Text = drEmployee("EmployeeNo").ToString
            Me.txbEmployeeName.Text = drEmployee("EmployeeName").ToString
            Me.txbEmployeeIDType.Text = drEmployee("IDType").ToString
            Me.lblEmployeeIDNo.Text = "证件号码（" & drEmployee("IDNo").ToString.Length.ToString & " 位）："
            Me.txbEmployeeIDNo.Text = drEmployee("IDNo").ToString
            Me.txbOfficeName.Text = drEmployee("OfficeName").ToString
            Me.txbLevelName.Text = drEmployee("LevelName").ToString
            Me.txbEmployeeState.Text = drEmployee("EmployeeState").ToString
            Me.pnlEmployeeTel.Visible = True
            Me.txbEmployeeTel.Text = drEmployee("TelMP").ToString
            Me.flpEmployeeInfo.AutoSize = False
            Me.flpEmployeeInfo.AutoSize = True
            Me.grbEmployeeInfo.Height = Me.flpEmployeeInfo.Height + 26
            Me.grbInputEmployeeTel.Visible = False

            Me.grbEmployeeQuota.Visible = True
            Me.txbPurchaseQuota.Text = Format(drEmployee("PurchaseQuota"), "#,0.00")
            'modify code 038:start-------------------------------------------------------------------------
            'Me.txbRateQuota.Text = Format(drEmployee("RateQuota") * 100, "#,0.0")
            Me.txbRateQuota.Text = Format(drEmployee("RateQuota") * 100, "#,0.00")
            'modify code 038:end-------------------------------------------------------------------------
            Me.txbRebateQuota.Text = Format(drEmployee("PurchaseQuota") * drEmployee("RateQuota"), "#,0.00")
            Me.txbUsedPurchaseQuota.Text = Format(drEmployee("UsedPurchaseQuota"), "#,0.00")
            Me.txbUsedRebateQuota.Text = Format(drEmployee("UsedPurchaseQuota") * drEmployee("RateQuota"), "#,0.00")
            Me.tlpAvailableQuota.Visible = False
            Me.tlpDistributedQuota.Visible = True
            Me.txbDistributedPurchaseQuota.BackColor = SystemColors.Control
            Me.txbDistributedPurchaseQuota.ForeColor = SystemColors.ControlText
            Me.txbDistributedPurchaseQuota.Font = New Font(Me.txbDistributedPurchaseQuota.Font, FontStyle.Regular)
            Me.theTip.SetToolTip(Me.txbDistributedPurchaseQuota, "")
            Me.txbDistributedPurchaseQuota.Text = Format(drSalesBill("NormalSalesAMT"), "#,0.00")
            Me.txbDistributedRebateQuota.BackColor = SystemColors.Control
            Me.txbDistributedRebateQuota.ForeColor = SystemColors.ControlText
            Me.txbDistributedRebateQuota.Font = New Font(Me.txbDistributedRebateQuota.Font, FontStyle.Regular)
            Me.theTip.SetToolTip(Me.txbDistributedRebateQuota, "")
            Me.txbDistributedRebateQuota.Text = Format(drSalesBill("RebateSalesAMT"), "#,0.00")
            Me.pnlDistributedBalanceRebateQuota.Visible = False
            If drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") - drSalesBill("NormalSalesAMT") > 0 Then
                Me.tlpBalanceQuota.Visible = True
                Me.pnlBalancePurchaseQuota.Visible = True
                Me.txbBalancePurchaseQuota.Text = Format(drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") - drSalesBill("NormalSalesAMT"), "#,0.00")
                Me.pnlBalanceRebateQuota.Visible = True
                Me.txbBalanceRebateQuota.Text = Format((drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") - drSalesBill("NormalSalesAMT")) * drEmployee("RateQuota"), "#,0.00")
            Else
                Me.tlpBalanceQuota.Visible = False
            End If
            Me.flpEmployeeQuota.AutoSize = False
            Me.flpEmployeeQuota.AutoSize = True
            Me.grbEmployeeQuota.Height = Me.flpEmployeeQuota.Height + 25
            Me.flpEmployee.AutoSize = False
            Me.flpEmployee.AutoSize = True
        Else
            Me.flpEmployee.Visible = False
        End If

        If drSalesBill("SalesBillType") = 2 Then
            Me.grbPromotionInfo.Text = "活动摘要："
            Me.txbPromotionTitle.ReadOnly = True
            Me.txbPromotionTitle.BackColor = SystemColors.Window
            Me.txbPromotionTitle.BackColor = SystemColors.Control
            Me.txbPromotionTitle.Text = drSalesBill("PromotionTitle").ToString
            Me.pnlPromotionPeriod.Visible = False
            Me.pnlPromotionPeriodReadOnly.Visible = True
            Me.txbPromotionStartDate.Text = drSalesBill("PromotionPeriod").ToString.Substring(0, 10)
            Me.txbPromotionEndDate.Text = drSalesBill("PromotionPeriod").ToString.Substring(13)
        Else
            Me.grbPromotionInfo.Visible = False
        End If

        'modify code 040:start-------------------------------------------------------------------------
        'If (drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("CustomerType") = 0) OrElse drSalesBill("SalesBillType") = 1 OrElse drSalesBill("SalesBillType") = 4 OrElse drSalesBill("SalesBillType") = 5 Then '个人客户的一般销售单、退货销售单、员工卡销售单、联名卡销售单
        If ((drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6) AndAlso drSalesBill("CustomerType") = 0) OrElse drSalesBill("SalesBillType") = 1 OrElse drSalesBill("SalesBillType") = 4 OrElse drSalesBill("SalesBillType") = 5 Then '个人客户的一般销售单或线下提卡销售单、退货销售单、员工卡销售单、联名卡销售单
            'modify code 040:end-------------------------------------------------------------------------
            Me.grbCustomer.Visible = False
        Else
            Me.grbCustomer.Visible = True
            Me.grbCustomer.Text = "公司信息："
            Me.pnlSelectStore.Visible = False
            Me.pnlCustomerType.Visible = False
            Me.pnlCompanyCustomer.Visible = True
            'modify code 040:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 Then
            If drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6 Then
                'modify code 040:end-------------------------------------------------------------------------
                Me.lblCustomerName.Text = "公司名称："
            Else
                Me.lblCustomerName.Text = "家乐福自购客户名称："
            End If
            Me.txbCustomerName.Visible = True
            Me.txbCustomerName.ReadOnly = True
            Me.txbCustomerName.BackColor = SystemColors.Window
            Me.txbCustomerName.BackColor = SystemColors.Control
            Me.txbCustomerName.Text = drSalesBill("CustomerName").ToString
            Me.cbbCustomerName.Visible = False
            Me.cbbCompanyCredentialsType.Visible = False
            Me.txbCompanyCredentialsType.Visible = True
            Me.txbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
            Me.txbCompanyCredentialsNo.ReadOnly = True
            Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
            Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
            Me.txbCompanyCredentialsNo.Text = drSalesBill("CompanyCredentialsNo").ToString
            'modify code 040:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 Then
            If drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6 Then
                'modify code 040:end-------------------------------------------------------------------------
                Me.pnlCustomerButtons.Visible = True
                Me.btnNewCustomer.Visible = False
                Me.btnViewCustomer.Visible = True
                Me.btnViewCustomer.Enabled = blCanViewCustomer
            Else
                Me.pnlCustomerButtons.Visible = False
            End If
            Me.flpCustomer.AutoSize = False
            Me.flpCustomer.AutoSize = True
            Me.grbCustomer.Height = Me.flpCustomer.Height + 25
        End If

        Me.grbAvailablePayer.Visible = False

        If drSalesBill("SalesBillType") = 4 OrElse drSalesBill("SalesBillType") = 5 Then '员工销售单、联名卡销售单
            grbBuyerInfo.Visible = False
        Else
            grbBuyerInfo.Visible = True
            Me.theTip.SetToolTip(Me.cbbBuyerName, "")
            Me.theTip.SetToolTip(Me.txbBuyerName, "")
            Me.txbBuyerName.Visible = True
            Me.txbBuyerName.ReadOnly = True
            Me.txbBuyerName.BackColor = SystemColors.Window
            Me.txbBuyerName.BackColor = SystemColors.Control
            Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
            Me.cbbBuyerName.Visible = False
            Me.txbTelMP.Visible = True
            Me.txbTelMP.ReadOnly = True
            Me.txbTelMP.BackColor = SystemColors.Window
            Me.txbTelMP.BackColor = SystemColors.Control
            Me.txbTelMP.Text = drSalesBill("TelMP").ToString
            Me.cbbTelMP.Visible = False
            If drSalesBill("SalesBillType") = 1 Then '退货销售单
                Me.grbBuyerInfo.Text = "退货客户信息："
                Me.pnlBuyerCredentials.Visible = False
                Me.grbBuyerInfo.Height = 80
            Else
                'modify code 040:start-------------------------------------------------------------------------
                'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("CustomerType") = 0 Then
                If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6) AndAlso drSalesBill("CustomerType") = 0 Then
                    'modify code 040:end-------------------------------------------------------------------------
                    Me.grbBuyerInfo.Text = "购买人信息："
                Else
                    Me.grbBuyerInfo.Text = "代购人信息："
                End If
                Me.pnlBuyerCredentials.Visible = True
                Me.txbBuyerCredentialsType.Visible = True
                Me.txbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
                Me.cbbBuyerCredentialsType.Visible = False
                Me.txbBuyerCredentialsNo.ReadOnly = True
                Me.txbBuyerCredentialsNo.BackColor = SystemColors.Window
                Me.txbBuyerCredentialsNo.BackColor = SystemColors.Control
                Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
                Me.grbBuyerInfo.Height = 134
            End If
        End If

        If drSalesBill("SalesBillType") = 5 Then '联名卡销售单
            Me.grbMemberInfo.Visible = False
            Me.grbMemberInfo.Visible = True
            Me.grbMemberInfo.Text = "会员信息："
            Me.txbMemberName.ReadOnly = True
            Me.txbMemberName.BackColor = SystemColors.Window
            Me.txbMemberName.BackColor = SystemColors.Control
            Me.txbMemberName.Text = drMember("MemberName").ToString
            Me.txbMemberIDNo.ReadOnly = True
            Me.txbMemberIDNo.BackColor = SystemColors.Window
            Me.txbMemberIDNo.BackColor = SystemColors.Control
            Me.txbMemberIDNo.Text = Me.MaskBuyerCredentialsNo()
            Me.txbMemberTel.ReadOnly = True
            Me.txbMemberTel.BackColor = SystemColors.Window
            Me.txbMemberTel.BackColor = SystemColors.Control
            Me.txbMemberTel.Text = drMember("MemberTel").ToString
            Me.txbMemberAddress.ReadOnly = True
            Me.txbMemberAddress.BackColor = SystemColors.Window
            Me.txbMemberAddress.BackColor = SystemColors.Control
            Me.txbMemberAddress.Text = drMember("MemberAddress").ToString
            Me.txbNewMemberCardNo.ReadOnly = True
            Me.txbNewMemberCardNo.BackColor = SystemColors.Window
            Me.txbNewMemberCardNo.BackColor = SystemColors.Control
            Me.txbNewMemberCardNo.Text = drMember("NewMemberCardNo").ToString
            Me.txbOldMemberCardNo.ReadOnly = True
            Me.txbOldMemberCardNo.BackColor = SystemColors.Window
            Me.txbOldMemberCardNo.BackColor = SystemColors.Control
            Me.txbOldMemberCardNo.Text = drMember("OldMemberCardNo").ToString
        Else
            Me.grbMemberInfo.Visible = False
        End If

        Select Case drSalesBill("RebateMode")
            Case 0, 4
                Me.grbBalanceContract.Visible = False
                Me.grbContract.Visible = False
                Me.grbNormalRebate.Visible = False
            Case 1
                Me.grbBalanceContract.Visible = False
                Me.grbContract.Visible = False
                Me.grbNormalRebate.Visible = True

                Me.grbNormalRebate.Text = "城市返点："
                Me.chbNormalRebate.Checked = True
                Me.chbNormalRebate.Enabled = False
                Me.btnViewCityRule.Enabled = blCanViewCityRule
                Me.flpNormalRebate.Visible = True
                Me.pnlMaxNormalRebateCalculation.Visible = False
                'modify code 038:start-------------------------------------------------------------------------
                'Me.txbNormalRebateRate.Text = Format(drSalesBill("RebateRate") * 100, "#,0.0")
                Me.txbNormalRebateRate.Text = Format(drSalesBill("RebateRate") * 100, "#,0.00")
                'modify code 038:end-------------------------------------------------------------------------
                Me.txbNormalRebateRate.ReadOnly = True
                Me.txbNormalRebateRate.BackColor = SystemColors.Window
                Me.txbNormalRebateRate.BackColor = SystemColors.Control
                Me.txbNormalRebateAMT.Text = Format(drSalesBill("RebateSalesAMT"), "#,0.00")
                Me.txbNormalRebateAMT.ReadOnly = True
                Me.txbNormalRebateAMT.BackColor = SystemColors.Window
                Me.txbNormalRebateAMT.BackColor = SystemColors.Control
                Me.pnlNormalRebateState.Visible = True
                Me.theTip.SetToolTip(Me.lblNormalRebateState, "")
                Me.pnlModifyNormalRebate.Visible = False
                Select Case drSalesBill("RebateState")
                    Case 0
                        Me.txbNormalRebateRate.ForeColor = Color.Orange
                        Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Bold)
                        Me.txbNormalRebateAMT.ForeColor = Color.Orange
                        Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Bold)
                        Me.lblNormalRebateState.Text = "需审核（超出标准范围）"
                    Case 1
                        Me.txbNormalRebateRate.ForeColor = Color.Red
                        Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Bold)
                        Me.txbNormalRebateAMT.ForeColor = Color.Red
                        Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Bold)
                        Me.lblNormalRebateState.Text = "没有通过审核！"
                        Me.theTip.SetToolTip(Me.lblNormalRebateState, "审核： " & drSalesBill("NormalRebateAuditorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("NormalRebateValidatedTime"), "yyyy\/MM\/dd HH:mm"))
                        Me.btnModifyNormalRebate.Enabled = True
                        If frmMain.dtAllowedRight.Select("RightName='SalesBillRebateModify'").Length > 0 Then
                            Me.pnlModifyNormalRebate.Visible = True
                        Else
                            Me.pnlModifyNormalRebate.Visible = False
                        End If
                    Case 2
                        Me.txbNormalRebateRate.ForeColor = SystemColors.ControlText
                        Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Regular)
                        Me.txbNormalRebateAMT.ForeColor = SystemColors.ControlText
                        Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Regular)
                        Me.lblNormalRebateState.Text = "有效（在标准范围内）"
                    Case Else
                        Me.txbNormalRebateRate.ForeColor = Color.Green
                        Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Bold)
                        Me.txbNormalRebateAMT.ForeColor = Color.Green
                        Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Bold)
                        Me.lblNormalRebateState.Text = "已通过审核。"
                        Me.theTip.SetToolTip(Me.lblNormalRebateState, "审核： " & drSalesBill("NormalRebateAuditorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("NormalRebateValidatedTime"), "yyyy\/MM\/dd HH:mm"))
                End Select
                Me.lblNormalRebateRemarks.Text = drSalesBill("NormalRebateRemarks").ToString
                Me.pnlNormalRebateRemarks.Visible = (Me.lblNormalRebateRemarks.Text <> "")
                Me.pnlDistributionNormalRebateAMT.Visible = False
                Me.pnlBalanceNormalRebateAMT.Visible = False

                Me.flpNormalRebate.AutoSize = False
                Me.flpNormalRebate.AutoSize = True
                Me.grbNormalRebate.Height = Me.flpNormalRebate.Height + 55
            Case 2
                Me.grbBalanceContract.Visible = False
                Me.grbNormalRebate.Visible = False
                Me.grbContract.Visible = True

                Me.grbContract.Text = "合同返点："
                Me.chbContract.Checked = True
                Me.chbContract.Enabled = False
                Me.txbContractCode.Text = drSalesBill("ContractCode").ToString
                Me.btnViewContract.Enabled = blCanViewContract
                Me.txbThisSalesAMT.Text = Format(drSalesBill("ContractRebateThisSalesAMT"), "#,0.00")
                'modify code 038:start-------------------------------------------------------------------------
                'Me.txbThisRebateRate.Text = Format(drSalesBill("ContractRebateThisRebateRate") * 100, "#,0.0")
                Me.txbThisRebateRate.Text = Format(drSalesBill("ContractRebateThisRebateRate") * 100, "#,0.00")
                'modify code 038:end-------------------------------------------------------------------------
                Me.txbThisRebateAMT.Text = Format(drSalesBill("ContractRebateThisRebateAMT"), "#,0.00")
                If drSalesBill("ContractRebateThisRebateRemarks").ToString = "" Then
                    Me.pnlThisPurchaseRemarks.Visible = False
                    Me.pnlThisPurchaseRebate.Height = 119 - Me.pnlThisPurchaseRemarks.Height
                Else
                    Me.lblThisPurchaseRemarks.Text = drSalesBill("ContractRebateThisRebateRemarks").ToString
                    Me.pnlThisPurchaseRemarks.Visible = True
                    Me.pnlThisPurchaseRebate.Height = 119
                End If

                Me.txbHistorySalesAMT.Text = Format(drSalesBill("ContractRebateHistorySalesAMT"), "#,0.00")
                'modify code 038:start-------------------------------------------------------------------------
                'Me.txbHistoryRebateRate.Text = Format(drSalesBill("ContractRebateHistoryRebateRate") * 100, "#,0.0")
                Me.txbHistoryRebateRate.Text = Format(drSalesBill("ContractRebateHistoryRebateRate") * 100, "#,0.00")
                'modify code 038:end-------------------------------------------------------------------------
                Me.txbHistoryRebateAMT.Text = Format(drSalesBill("ContractRebateHistoryRebateAMT"), "#,0.00")
                Me.txbHistoryPaidRebateAMT.Text = Format(drSalesBill("ContractRebateHistoryPaidRebateAMT"), "#,0.00")
                If drSalesBill("ContractRebateHistoryRebateRemarks").ToString = "" Then
                    Me.pnlHistoryPurchaseRemarks.Visible = False
                    Me.pnlHistoryPurchaseRebate.Height = 146 - Me.pnlHistoryPurchaseRemarks.Height
                Else
                    Me.lblHistoryPurchaseRemarks.Text = drSalesBill("ContractRebateHistoryRebateRemarks").ToString
                    Me.pnlHistoryPurchaseRemarks.Visible = True
                    Me.pnlHistoryPurchaseRebate.Height = 146
                End If

                Me.txbAvailableRebateSalesAMT.Text = Format(drSalesBill("ContractRebateAvailableRebateAMT"), "#,0.00")
                Me.pnlRebatSalesAMT.Visible = True : Me.txbRebateSalesAMT.Text = Format(drSalesBill("RebateSalesAMT"), "#,0.00")

                If drSalesBill("ContractMode").ToString.Substring(0, 1) = "0" Then '赠送返点
                    Me.lblThisPurchaseRebate.Text = "本次购买返点计算："
                    Me.lblThisSalesAMT.Text = "购买： " : Me.theTip.SetToolTip(Me.lblThisSalesAMT, "本次购买金额")
                    Me.lblThisRebateRate.Text = "比率："
                    If drSalesBill("ContractMode").ToString.Substring(2) = "2" Then '每次购买
                        If drSalesBill("ContractMode").ToString.Substring(1, 1) = "0" Then '按总金额计算
                            Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次购买与历史购买之和达到的最终返点比率")
                        Else '分段计算
                            Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次购买与历史购买之和达到的最大返点比率")
                        End If
                    Else '合同期满或每月一次
                        Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次购买达到的最终返点比率")
                    End If
                    Me.lblThisRebateAMT.Text = "金额： " : Me.theTip.SetToolTip(Me.lblThisRebateAMT, "本次购买产生的返点金额")

                    Me.lblHistoryPurchaseRebate.Text = "历史购买返点计算："
                    Me.lblHistorySalesAMT.Text = "购买： " : Me.theTip.SetToolTip(Me.lblHistorySalesAMT, drSalesBill("ContractRebateHistorySalesAMTTip").ToString)
                    Me.lblHistoryRebateRate.Text = "比率： " : Me.theTip.SetToolTip(Me.lblHistoryRebateRate, IIf(drSalesBill("ContractMode").ToString.Substring(0, 1) = "0", "历史购买达到的最终返点比率", "历史购买达到的最大返点比率"))
                    Me.lblHistoryRebateAMT.Text = "金额： " : Me.theTip.SetToolTip(Me.lblHistoryRebateAMT, "历史购买产生的返点金额")
                    Me.lblHistoryPaidRebateAMT.Text = "已兑： " : Me.theTip.SetToolTip(Me.lblHistoryPaidRebateAMT, "历史已经兑现的返点金额总计")

                    Me.lblAvailableRebateAMT.Text = "本次最大可兑返点金额："
                    Me.lblRebateSalesAMT.Text = "本次已分配返点金额："
                    Me.lblBalanceRebateAMT.Text = "剩余返点金额："
                    If drSalesBill("RebateSalesAMT") < drSalesBill("ContractRebateAvailableRebateAMT") Then
                        Me.pnlBalanceRebateAMT.Visible = True
                        Me.txbBalanceRebateAMT.Text = Format(drSalesBill("ContractRebateAvailableRebateAMT") - drSalesBill("RebateSalesAMT"), "#,0.00")
                        Me.theTip.SetToolTip(Me.txbBalanceRebateAMT, "已分配的返点金额未达到本次最大可兑返点金额： " & Format(drSalesBill("ContractRebateAvailableRebateAMT"), "#,0.00").Replace(".00", "") & " 元。")
                    Else
                        Me.pnlBalanceRebateAMT.Visible = False
                    End If
                Else '付款抵扣
                    Me.lblThisPurchaseRebate.Text = "本次充值抵扣计算："
                    Me.lblThisSalesAMT.Text = "充值： " : Me.theTip.SetToolTip(Me.lblThisSalesAMT, "本次充值金额")
                    Me.lblThisRebateRate.Text = "比率： "
                    If drSalesBill("ContractMode").ToString.Substring(1, 1) = "0" Then '按总金额计算
                        Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次充值与历史充值之和达到的最终抵扣比率")
                    Else '分段计算
                        Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次充值与历史充值之和达到的最大抵扣比率")
                    End If
                    Me.lblThisRebateAMT.Text = "金额： " : Me.theTip.SetToolTip(Me.lblThisRebateAMT, "本次充值产生的抵扣金额")

                    Me.lblHistoryPurchaseRebate.Text = "历史充值抵扣计算："
                    Me.lblHistorySalesAMT.Text = "充值： " : Me.theTip.SetToolTip(Me.lblHistorySalesAMT, drSalesBill("ContractRebateHistorySalesAMTTip").ToString)
                    Me.lblHistoryRebateRate.Text = "比率： " : Me.theTip.SetToolTip(Me.lblHistoryRebateRate, IIf(drSalesBill("ContractMode").ToString.Substring(0, 1) = "0", "历史充值达到的最终抵扣比率", "历史充值达到的最大抵扣比率"))
                    Me.lblHistoryRebateAMT.Text = "金额： " : Me.theTip.SetToolTip(Me.lblHistoryRebateAMT, "历史充值产生的抵扣金额")
                    Me.lblHistoryPaidRebateAMT.Text = "已抵： " : Me.theTip.SetToolTip(Me.lblHistoryPaidRebateAMT, "历史已经抵扣的付款金额总计")

                    Me.lblAvailableRebateAMT.Text = "本次可抵扣付款金额："
                    Me.lblRebateSalesAMT.Text = "本次已抵扣付款金额："
                    Me.lblBalanceRebateAMT.Text = "未抵扣付款金额："
                    If drSalesBill("ContractRebateAvailableRebateAMT") > drSalesBill("RebateSalesAMT") Then
                        Me.pnlBalanceRebateAMT.Visible = True : Me.txbBalanceRebateAMT.Text = Format(drSalesBill("ContractRebateAvailableRebateAMT") - drSalesBill("RebateSalesAMT"), "#,0.00")
                    Else
                        Me.pnlBalanceRebateAMT.Visible = False
                    End If
                End If

                Me.flpContract.AutoSize = False
                Me.flpContract.AutoSize = True
                Me.grbContract.Height = Me.flpContract.Height + 83
            Case Else
                Me.grbContract.Visible = False
                Me.grbNormalRebate.Visible = False
                Me.grbBalanceContract.Visible = True

                Me.grbBalanceContract.Text = "上期合同剩余返点："
                Me.chbBalanceContract.Checked = True
                Me.chbBalanceContract.Enabled = False
                Me.txbBalanceContractCode.Text = drSalesBill("BalanceContractCode").ToString
                Me.txbBalanceContractBalanceRebateAMT.Text = Format(drSalesBill("BalanceContractBalanceRebateAMT"), "#,0.00")
                Me.flpBalanceContract.Visible = True
                Me.pnlPreviousDistribution.Visible = True
                Me.txbPreviousDistribution.Text = Format(drSalesBill("RebateSalesAMT"), "#,0.00")
                If drSalesBill("BalanceContractBalanceRebateAMT") > drSalesBill("RebateSalesAMT") Then
                    Me.pnlPreviousBalance.Visible = True : Me.txbPreviousBalance.Text = Format(drSalesBill("BalanceContractBalanceRebateAMT") - drSalesBill("RebateSalesAMT"), "#,0.00")
                Else
                    Me.pnlPreviousBalance.Visible = False
                End If

                Me.flpBalanceContract.AutoSize = False
                Me.flpBalanceContract.AutoSize = True
                Me.grbBalanceContract.Height = Me.flpBalanceContract.Height + 110
        End Select

        Me.chbPrintDiscount.Enabled = False
        If drSalesBill("InvoicePrintDiscount").ToString = "" OrElse drSalesBill("RebateSalesAMT").ToString = "" OrElse drSalesBill("RebateSalesAMT") = 0 OrElse (drSalesBill("ContractMode").ToString <> "" AndAlso drSalesBill("ContractMode").ToString.Substring(0, 1) = "1") Then '发票未打印过折扣信息或抵扣方式的合同返点
            Me.grbPrintDiscount.Visible = False
        Else
            Me.grbPrintDiscount.Visible = True
            Me.chbPrintDiscount.Checked = drSalesBill("InvoicePrintDiscount")
        End If

        Me.grbSalesBillSummary.Visible = True
        Me.txbCardQTY.Text = Format(drSalesBill("CardQTY"), "#,0")
        Me.txbChargedAMT.Text = Format(drSalesBill("ChargedAMT"), "#,0.00")
        If drSalesBill("ActivatedAMT") = 0 OrElse drSalesBill("ActivatedAMT") = drSalesBill("ChargedAMT") Then
            Me.pnlActivationSummary.Visible = False
        Else
            Me.pnlActivationSummary.Visible = True
            Me.txbActiveAMT.Text = Format(drSalesBill("ActivatedAMT"), "#,0.00")
            Me.txbInactiveAMT.Text = Format(drSalesBill("ChargedAMT") - drSalesBill("ActivatedAMT"), "#,0.00")
        End If
        Me.txbPaymentAMT.Text = Format(drSalesBill("PayableAMT"), "#,0.00")
        If drSalesBill("CardCost") > 0 Then
            Me.pnlCardCost.Visible = True
            Me.txbCardCost.Text = Format(drSalesBill("CardCost"), "#,0.00")
        Else
            Me.pnlCardCost.Visible = False
        End If
        Me.grbSalesBillSummary.Height = Me.flpSalesBillSummary.Height + 28

        Me.grbSalesBillInfo.Visible = True
        Me.lblSalesBillCode.Text = drSalesBill("StoreCode").ToString & " " & drSalesBill("SalesBillCode").ToString.Insert(6, " ")
        Me.lblCreatedTime.Text = Format(drSalesBill("CreatedTime"), "yyyy\/MM\/dd HH:mm:ss")
        Me.lblCreatorName.Text = drSalesBill("CreatorName").ToString
        Me.lblSalesBillState.Font = New Font(Me.lblSalesBillState.Font, FontStyle.Regular)
        Me.lblSalesBillState.ForeColor = SystemColors.ControlText
        Me.lblSalesBillRemarks.Text = "" : Me.theTip.SetToolTip(Me.lblSalesBillState, "")

        Select Case drSalesBill("SalesBillState")
            Case 0
                Me.lblSalesBillState.ForeColor = Color.Green
                Me.lblSalesBillState.Text = IIf(drSalesBill("PayableAMT") > 0, "已付款，", "") & "等待激活"
            Case 1
                Me.lblSalesBillState.ForeColor = Color.SteelBlue
                Me.lblSalesBillState.Text = "已提交到CUL，正在激活"
                Me.lblSalesBillRemarks.Text = "提交： " & drSalesBill("ActivatorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("ActivatedTime"), "yy\/MM\/dd HH:mm")
            Case 2
                Me.lblSalesBillState.ForeColor = Color.Red
                Me.lblSalesBillState.Text = "激活失败！"
                Me.lblSalesBillRemarks.Text = "提交： " & drSalesBill("ActivatorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("ActivatedTime"), "yy\/MM\/dd HH:mm")
                If drSalesBill("StateReason").ToString <> "" Then Me.theTip.SetToolTip(Me.lblSalesBillState, "失败原因： " & drSalesBill("StateReason").ToString)
            Case 3
                Me.lblSalesBillState.ForeColor = Color.Chocolate
                Me.lblSalesBillState.Text = "部分激活"
                Me.lblSalesBillRemarks.Text = "提交： " & drSalesBill("ActivatorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("ActivatedTime"), "yy\/MM\/dd HH:mm")
                If drSalesBill("StateReason").ToString <> "" Then Me.theTip.SetToolTip(Me.lblSalesBillState, "部分失败原因： " & drSalesBill("StateReason").ToString)
            Case 4
                If drSalesBill("ActivationCancelledAMT") = drSalesBill("ChargedAMT") Then
                    Me.lblSalesBillState.ForeColor = Color.Red
                    Me.lblSalesBillState.Text = "此单已被撤销激活！"
                Else
                    Me.lblSalesBillState.Text = "全部激活"
                    Me.lblSalesBillRemarks.Text = "提交： " & drSalesBill("ActivatorName").ToString & Chr(13) & "时间： " & Format(drSalesBill("ActivatedTime"), "yy\/MM\/dd HH:mm")
                End If
            Case 9
                Me.lblSalesBillState.Font = New Font(Me.lblSalesBillState.Font, FontStyle.Bold)
                Me.lblSalesBillState.ForeColor = Color.Red
                Me.lblSalesBillState.Text = "等待确认取消"
                If drSalesBill("StateReason").ToString <> "" Then Me.theTip.SetToolTip(Me.lblSalesBillState, "申请取消原因： " & drSalesBill("StateReason").ToString)
                Me.lblSalesBillRemarks.Text = "申请： " & drSalesBill("CancellerName").ToString & Chr(13) & "时间： " & Format(drSalesBill("CancelledTime"), "yy\/MM\/dd HH:mm")
            Case Else
                Me.lblSalesBillState.Font = New Font(Me.lblSalesBillState.Font, FontStyle.Bold)
                Me.lblSalesBillState.ForeColor = Color.Red
                Me.lblSalesBillState.Text = "此销售单已被取消！"
                If drSalesBill("StateReason").ToString <> "" Then Me.theTip.SetToolTip(Me.lblSalesBillState, "取消原因： " & drSalesBill("StateReason").ToString)
                Me.lblSalesBillRemarks.Text = "取消： " & drSalesBill("CancellerName").ToString & Chr(13) & "时间： " & Format(drSalesBill("CancelledTime"), "yy\/MM\/dd HH:mm")
        End Select
        If Me.lblSalesBillRemarks.Text = "" Then
            Me.pnlSalesBillStateDescription.Visible = False
            Me.grbSalesBillInfo.Height = 125
        Else
            Me.pnlSalesBillStateDescription.Visible = True
            Me.grbSalesBillInfo.Height = 157
        End If

        'modify code 040:start-------------------------------------------------------------------------
        'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillSalesmanAdjust'").Length > 0 AndAlso drSalesBill("SalesBillState") < 9 AndAlso drSalesBill("ActivationCancelledAMT") < drSalesBill("ChargedAMT") AndAlso (frmMain.sLoginRoleID <> "14" OrElse Not drSalesBill("SalesmanChanged")) Then
        If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6) AndAlso drSalesBill("PayableAMT") > 0 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillSalesmanAdjust'").Length > 0 AndAlso drSalesBill("SalesBillState") < 9 AndAlso drSalesBill("ActivationCancelledAMT") < drSalesBill("ChargedAMT") AndAlso (frmMain.sLoginRoleID <> "14" OrElse Not drSalesBill("SalesmanChanged")) Then
            'modify code 040:end-------------------------------------------------------------------------
            Me.pnlAddjustSalesman.Visible = True
        End If

        Select Case drSalesBill("SalesBillType")
            'modify code 040:start-------------------------------------------------------------------------
            'Case 0, 4
            Case 0, 4, 6
                'modify code 040:end-------------------------------------------------------------------------
                Me.lblNormalListTitle.Text = "购物卡充值列表："
            Case 1
                Me.lblNormalListTitle.Text = "退货卡充值列表："
            Case 2
                Me.lblNormalListTitle.Text = "活动卡充值列表："
                'modify code 046:start-------------------------------------------------------------------------
            Case 7
                Me.lblNormalListTitle.Text = "实名制卡充值列表："
                'modify code 046:end-------------------------------------------------------------------------
                'modify code 054:start-------------------------------------------------------------------------
            Case 8
                Me.lblNormalListTitle.Text = "通卖非实名卡充值列表："
                'modify code 054:end-------------------------------------------------------------------------
            Case 9
                Me.lblNormalListTitle.Text = "电子卡充值列表："
            Case Else
                Me.lblNormalListTitle.Text = "公关卡充值列表："
        End Select

        If dtNormalCard.Rows.Count = 0 Then
            Me.splitList.Panel1Collapsed = True
            dmNormalSalesAMT = 0
        Else
            Me.splitList.Panel1Collapsed = False
            If drSalesBill("ImportedFromFile").ToString = "" Then
                Me.pnlImportedFile.Visible = False
            Else
                With Me.lblSourceFile
                    .Text = drSalesBill("ImportedFromFile").ToString
                    .Font = New Font(.Font, FontStyle.Regular)
                    .ForeColor = SystemColors.ControlText
                    .Cursor = Cursors.Default
                End With
                Me.theTip.SetToolTip(Me.lblSourceFile, "")
                Me.pnlImportedFile.Visible = True
            End If

            If drSalesBill("SalesBillType") = 9 Then
                Me.pnlImportedFile.Visible = False
            End If

            With Me.dgvNormalCard
                .Columns("CardFeature").Visible = (dtNormalCard.Select("Isnull(CardFeature,'磁条卡')<>'磁条卡'").Length > 0)
                .Columns("CardCost").ToolTipText = ""
                'modify code 004:start-------------------------------------------------------------------------
                '.Columns("CardCost").Visible = (drSalesBill("CardCost") > 0)
                .Columns("CardCost").Visible = True
                'modify code 004:end-------------------------------------------------------------------------
                .Columns("ReducedCardPayment").Visible = False
                .Columns("CardPayment").Visible = False
                .Columns("PaymentDescription").Visible = (dtNormalCard.Select("Isnull(PaymentDescription,'')<>''").Length > 0)
                .Columns("ActivationState").Visible = True
                If dtNormalCard.Select("ActivatedAMT<>0 And ChargedAMT<>ActivatedAMT").Length = 0 Then
                    .Columns("ActivatedQTY").Visible = False
                    .Columns("ActivatedAMT").Visible = False
                Else
                    .Columns("ActivatedQTY").Visible = True
                    .Columns("ActivatedAMT").Visible = True
                End If
                .Columns("StateReason").Visible = (dtNormalCard.Select("Isnull(StateReason,'')<>''").Length <> 0)
                .ReadOnly = True

                If .CurrentCell IsNot Nothing Then .CurrentCell.Selected = False
                If .CurrentRow IsNot Nothing Then .CurrentRow.Selected = False
            End With
            For Each Column As DataGridViewColumn In Me.dgvNormalCard.Columns
                If Column.Visible = True Then
                    If Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill Then
                        Column.MinimumWidth = 2
                        Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        Column.MinimumWidth = Column.Width
                        Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                    ElseIf Column.Name = "PaymentDescription" Then
                        Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        Column.Width += 0
                        Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    ElseIf Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells Then
                        Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                        Column.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                    End If
                End If
            Next
            If drSalesBill("RebateMode").ToString = "2" AndAlso drSalesBill("ContractMode").ToString <> "" AndAlso drSalesBill("ContractMode").ToString.Substring(0, 1) = "1" Then
                Me.pnlDeductionAMT.Visible = True
                Me.lblDeductionAMT.Text = Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元"
            Else
                Me.pnlDeductionAMT.Visible = False
                Me.lblDeductionAMT.Text = "0.00 元"
            End If
            Me.NormalCardSummary()
        End If

        If dtRebateCard.Rows.Count = 0 Then
            Me.splitList.Panel2Collapsed = True
        Else
            Me.splitList.Panel2Collapsed = False
            With Me.dgvRebateCard
                .Columns("CardFeature").Visible = (dtRebateCard.Select("Isnull(CardFeature,'磁条卡')<>'磁条卡'").Length > 0)
                .Columns("ActivationState").Visible = True
                If dtRebateCard.Select("ActivatedAMT<>0 And ChargedAMT<>ActivatedAMT").Length = 0 Then
                    .Columns("ActivatedQTY").Visible = False
                    .Columns("ActivatedAMT").Visible = False
                Else
                    .Columns("ActivatedQTY").Visible = True
                    .Columns("ActivatedAMT").Visible = True
                End If
                .Columns("StateReason").Visible = (dtRebateCard.Select("Isnull(StateReason,'')<>''").Length <> 0)
                .ReadOnly = True

                If .CurrentCell IsNot Nothing Then .CurrentCell.Selected = False
                If .CurrentRow IsNot Nothing Then .CurrentRow.Selected = False
            End With
            Me.RebateCardSummary()
        End If

        If drSalesBill("SalesBillType") = 1 Then
            Me.pnlNormalPayment.Visible = False
            Me.pnlBalanceContractPayment.Visible = False
            Me.pnlReturnPayment.Visible = True
            Me.lblRefundTitle.Text = "下面是来自退货中心的退货信息："
            Me.dtpRefundDate.Visible = False
            Me.txbRefundDate.Visible = True
            If drSalesBill("RefundDate").ToString = "" Then
                Me.txbRefundDate.Text = ""
            Else
                Me.txbRefundDate.Text = Format(drSalesBill("RefundDate"), "yyyy\/MM\/dd")
            End If
            Me.txbRefundNo.Text = drSalesBill("RefundNo").ToString
            Me.txbRefundNo.ReadOnly = True
            Me.txbRefundNo.BackColor = SystemColors.Window
            Me.txbRefundNo.BackColor = SystemColors.Control
        Else
            Me.pnlReturnPayment.Visible = False
            If drSalesBill("RebateMode") = 3 Then
                Me.pnlNormalPayment.Visible = False
                Me.pnlBalanceContractPayment.Visible = True
            Else
                Me.pnlBalanceContractPayment.Visible = False
                Me.pnlNormalPayment.Visible = True
                With Me.dgvPayment
                    .Visible = True
                    .Columns("ValidationState").Visible = True
                    .ReadOnly = True

                    If dtPayment.Select("ValidationState Like '%已确认%'").Length > 0 Then
                        .Columns("AuditorName").Visible = True
                        .Columns("ValidatedTime").Visible = True
                    Else
                        .Columns("AuditorName").Visible = False
                        .Columns("ValidatedTime").Visible = False
                    End If

                    If .CurrentCell IsNot Nothing Then .CurrentCell.Selected = False
                    If .CurrentRow IsNot Nothing Then .CurrentRow.Selected = False
                End With
                If frmMain.dtAllowedRight.Select("RightName='SalesBillPaymentModify'").Length = 0 Then Me.btnModifyPaymentInfo.Enabled = False
                Me.btnModifyPaymentInfo.Visible = False
                Me.PaymentSummary()
            End If
        End If

        Try
            iFirstAvailableRowID = drSalesBill("FirstAvailableRowID") : iSecondAvailableRowID = drSalesBill("SecondAvailableRowID")
        Catch
            iFirstAvailableRowID = -1 : iSecondAvailableRowID = -1
        End Try

        'modify code 040:start-------------------------------------------------------------------------
        'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
        '    Me.lblTotalPayAmtTitle.Visible = True
        '    Me.lblTotalPayAmt.Visible = True
        '    Me.lblTotalPayAmtUnit.Visible = True
        'Else
        '    Me.lblTotalPayAmtTitle.Visible = False
        '    Me.lblTotalPayAmt.Visible = False
        '    Me.lblTotalPayAmtUnit.Visible = False
        'End If
        'modify code 040:end-------------------------------------------------------------------------

        If drSalesBill("SalesBillState") = 99 Then
            Me.btnOK.Text = "确认取消(&O)"
            Me.btnOK.Enabled = False
        ElseIf drSalesBill("SalesBillState") = 9 Then
            If frmMain.dtAllowedRight.Select("RightName='SalesBillCancel'").Length > 0 Then
                Me.btnOK.Text = "撤销取消(&O)"
                Me.btnOK.Enabled = True
            Else
                Me.btnOK.Text = "确认取消(&O)"
                Me.btnOK.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillDelete'").Length > 0)
            End If
        Else
            Me.btnOK.Text = "申请取消(&O)"
            'modify code 040:start-------------------------------------------------------------------------
            'Me.btnOK.Enabled = ((drSalesBill("SalesBillState") = 0 OrElse drSalesBill("ActivationCancelledAMT") = drSalesBill("ChargedAMT")) AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillCancel'").Length > 0)
            Me.btnOK.Enabled = ((drSalesBill("SalesBillState") = 0 OrElse drSalesBill("ActivationCancelledAMT") = drSalesBill("ChargedAMT")) AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillCancel'").Length > 0 AndAlso drSalesBill("SalesBillType") <> 6)
            'modify code 040:end-------------------------------------------------------------------------
        End If

        If drSalesBill("TicketPrintedTimes") = 0 Then
            Me.btnPrintTicket.Text = "打印小票(&T)"
            Me.btnPrintTicket.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillTicketPrint'").Length > 0 AndAlso DateDiff(DateInterval.Day, CDate(drSalesBill("CreatedTime")).Date, Today()) = 0)
        Else
            Me.btnPrintTicket.Text = "重打印小票(&T)"
            Me.btnPrintTicket.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillTicketReprint'").Length > 0 AndAlso drSalesBill("TicketPrintedTimes") < 3 AndAlso DateDiff(DateInterval.Day, CDate(drSalesBill("CreatedTime")).Date, Today()) = 0)
        End If
        Me.btnConfigTicket.Enabled = (frmMain.dtAllowedRight.Select("RightName Like 'SalesBillTicket%'").Length > 0)
        Me.btnPrintApplicationForm.Enabled = False : Me.btnConfigApplicationForm.Enabled = False
        If "|9|12|14|20|".IndexOf("|" & frmMain.sLoginRoleID & "|") > -1 OrElse (frmMain.dtAllowedRight.Select("RightName='SalesBillNormalCreate'").Length > 0) Then '城市经理、门店主管、售卡员或其他可以建一般销售单的人可以打印折扣申请单
            If drSalesBill("RebateSalesAMT") > 0 Then
                If dtRebateCard.Rows.Count > 0 AndAlso dtRebateCard.Select("ActivationState='等待激活'").Length = dtRebateCard.Rows.Count Then '全部返点卡未激活时
                    Me.btnPrintApplicationForm.Enabled = True
                ElseIf dtRebateCard.Rows.Count = 0 AndAlso dtNormalCard.Select("ActivationState='等待激活'").Length = dtNormalCard.Rows.Count Then '抵扣方式且全部正常卡未激活时
                    Me.btnPrintApplicationForm.Enabled = True
                End If
            End If
            Me.btnConfigApplicationForm.Enabled = True
        End If
        If dmTotalPaymentAMT = 0 Then
            Me.btnPrintInvoice.Text = "打印发票(&I)"
            Me.btnPrintInvoice.Enabled = False
        ElseIf dmTotalPrintedInvoiceAMT = 0 Then
            Me.btnPrintInvoice.Text = "打印发票(&I)"
            Me.btnPrintInvoice.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length > 0 AndAlso drSalesBill("TicketPrintedTimes") > 0 AndAlso (drInvoicePrintable Is Nothing OrElse drInvoicePrintable("CanPrintInvoice")))
        ElseIf dmTotalPaymentAMT = dmTotalPrintedInvoiceAMT Then
            Me.btnPrintInvoice.Text = "查看发票(&I)"
            Me.btnPrintInvoice.Enabled = True
        Else
            If frmMain.dtAllowedRight.Select("RightName='SalesBillInvoicePrint'").Length > 0 AndAlso (drInvoicePrintable Is Nothing OrElse drInvoicePrintable("CanPrintInvoice")) Then
                Me.btnPrintInvoice.Text = "打印发票(&I)"
            Else
                Me.btnPrintInvoice.Text = "查看发票(&I)"
            End If
            Me.btnPrintInvoice.Enabled = True
        End If
        'modify code 008:start-------------------------------------------------------------------------
        If dtPayment.Rows.Count > 0 Then
            If dtPayment.Rows(0)("PaymentTerm") = 7 Then
                Me.btnPrintInvoice.Enabled = False
            End If
        End If
        'modify code 008:end-------------------------------------------------------------------------
        'modify code 040,044:start-------------------------------------------------------------------------
        If drSalesBill("SalesBillType") = 6 Then
            If strSelectedBuyChannel = "Cul" Then
                If dtBillBuyChannel Is Nothing OrElse dtBillBuyChannel.Select("BillBuyChannel = '" & ecir.ExtractingCodeInfoData.BillBuyChannel & "'").Length = 0 _
                    OrElse dtBillBuyChannel.Select("BillBuyChannel = '" & ecir.ExtractingCodeInfoData.BillBuyChannel & "' and CanPrintInvoice = 1 ").Length = 0 Then
                    Me.btnPrintInvoice.Enabled = False
                End If
            ElseIf strSelectedBuyChannel = "RuiTai" Then
                If dtBillBuyChannel Is Nothing OrElse dtBillBuyChannel.Select("BillBuyChannel = 'RUITAI'").Length = 0 _
                    OrElse dtBillBuyChannel.Select("BillBuyChannel = 'RUITAI' and CanPrintInvoice = 1 ").Length = 0 Then
                    Me.btnPrintInvoice.Enabled = False
                End If
            Else
                'modify code 062:start-------------------------------------------------------------------------
                Dim DB As New DataBase()
                DB.Open()
                If Not DB.IsConnected Then
                    frmMain.statusText.Text = "系统因连接不到数据库而无法打开客户窗口。请检查数据库连接。"
                    Me.Close() : Return
                End If

                Dim dtInternetSales As DataTable
                dtInternetSales = DB.GetDataTable("select BILLBUYCHANNEL from InternetSales where SalesBillID = '" & sSalesBillID & "'")
                If dtInternetSales.Rows.Count > 0 Then
                    If dtBillBuyChannel.Select("BillBuyChannel = '" & dtInternetSales.Rows(0)(0).ToString() & "' and CanPrintInvoice = 1 ").Length = 0 Then
                        Me.btnPrintInvoice.Enabled = False
                    End If
                Else
                    If DB.GetDataTable("select * from InternetSales_RuiTai where SalesBillID = '" & sSalesBillID & "'").Rows.Count > 0 _
                        OrElse dtBillBuyChannel.Select("BillBuyChannel = 'RUITAI' and CanPrintInvoice = 1 ").Length = 0 Then
                        Me.btnPrintInvoice.Enabled = False
                    End If
                End If
                DB.Close()
                'modify code 062:end-------------------------------------------------------------------------
            End If
        End If
        'modify code 040,044:end-------------------------------------------------------------------------
        Me.btnConfigInvoice.Enabled = (drSalesBill("SalesBillType") <> 1 AndAlso frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 AndAlso (drInvoicePrintable Is Nothing OrElse drInvoicePrintable("CanPrintInvoice")))
        Me.btnViewActivation.Enabled = True

        If drSalesBill("SalesBillState") >= 9 Then '申请取消或已取消
            Me.btnPrintTicket.Enabled = False
            Me.btnPrintInvoice.Enabled = False
        End If

        If bNewSalesBillType = 1 Then
            Me.btnNewSalesBill.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillReturnedCreate'").Length > 0)
        Else
            Me.btnNewSalesBill.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillNormalCreate'").Length > 0)
        End If

        Me.Text = "查看销售单"
        Me.ResetInterfaceLayout()
    End Sub

    Private Function MaskBuyerCredentialsNo() As String
        Dim sMaskedNo As String = drSalesBill("BuyerCredentialsNo").ToString
        Select Case sMaskedNo.Length
            Case Is >= 18
                sMaskedNo = sMaskedNo.Substring(0, 6) & StrDup(sMaskedNo.Length - 10, "*") & sMaskedNo.Substring(sMaskedNo.Length - 4, 4)
            Case Is >= 12
                sMaskedNo = sMaskedNo.Substring(0, 4) & StrDup(sMaskedNo.Length - 8, "*") & sMaskedNo.Substring(sMaskedNo.Length - 4, 4)
            Case Is >= 8
                sMaskedNo = sMaskedNo.Substring(0, 2) & StrDup(sMaskedNo.Length - 4, "*") & sMaskedNo.Substring(sMaskedNo.Length - 2, 2)
        End Select
        Return sMaskedNo
    End Function

    Private Function MaskTelMP(ByVal sMaskedTelMP As String) As String
        If sMaskedTelMP = "" Then Return ""
        If IsNumeric(sMaskedTelMP) Then
            Select Case sMaskedTelMP.Length
                Case Is <= 4
                Case 5
                    sMaskedTelMP = sMaskedTelMP.Substring(0, 2) & "*" & sMaskedTelMP.Substring(3)
                Case 6
                    sMaskedTelMP = sMaskedTelMP.Substring(0, 2) & StrDup(2, "*") & sMaskedTelMP.Substring(4)
                Case 7
                    sMaskedTelMP = sMaskedTelMP.Substring(0, 2) & StrDup(3, "*") & sMaskedTelMP.Substring(5)
                Case Else
                    Dim iLeftLength As Int16 = Int(sMaskedTelMP.Length / 2) - 2
                    sMaskedTelMP = sMaskedTelMP.Substring(0, iLeftLength) & StrDup(4, "*") & sMaskedTelMP.Substring(4 + iLeftLength)
            End Select
        Else
            Dim sLeft As String = "", sMid As String = "", sRight As String = "", iPosition As Int16 = -1, iLeftLength = 0, iLength As Int16 = sMaskedTelMP.Length - 1
            For iIndex As Int16 = 0 To iLength
                If IsNumeric(sMaskedTelMP.Substring(iIndex, 1)) Then
                    Exit For
                Else
                    iPosition = iIndex
                    sLeft = sLeft & sMaskedTelMP.Substring(iIndex, 1)
                End If
            Next
            For iIndex As Int16 = iPosition + 1 To iLength
                If IsNumeric(sMaskedTelMP.Substring(iIndex, 1)) Then
                    iPosition = iIndex
                    iLeftLength += 1
                    sLeft = sLeft & sMaskedTelMP.Substring(iIndex, 1)
                Else
                    Exit For
                End If
            Next
            For iIndex As Int16 = iPosition + 1 To iLength
                If IsNumeric(sMaskedTelMP.Substring(iIndex, 1)) Then
                    Exit For
                Else
                    iPosition = iIndex
                    sLeft = sLeft & sMaskedTelMP.Substring(iIndex, 1)
                End If
            Next
            For iIndex As Int16 = iPosition + 1 To iLength
                If IsNumeric(sMaskedTelMP.Substring(iIndex, 1)) Then
                    iPosition = iIndex
                    sMid = sMid & sMaskedTelMP.Substring(iIndex, 1)
                Else
                    Exit For
                End If
            Next
            If iPosition < iLength Then sRight = sMaskedTelMP.Substring(iPosition + 1)
            If sRight = "" AndAlso iLeftLength > sMid.Length Then
                sLeft = "" : sMid = "" : iPosition = -1
                For iIndex As Int16 = 0 To iLength
                    If IsNumeric(sMaskedTelMP.Substring(iIndex, 1)) Then
                        Exit For
                    Else
                        iPosition = iIndex
                        sLeft = sLeft & sMaskedTelMP.Substring(iIndex, 1)
                    End If
                Next
                For iIndex As Int16 = iPosition + 1 To iLength
                    If IsNumeric(sMaskedTelMP.Substring(iIndex, 1)) Then
                        iPosition = iIndex
                        sMid = sMid & sMaskedTelMP.Substring(iIndex, 1)
                    Else
                        Exit For
                    End If
                Next
                sRight = sMaskedTelMP.Substring(iPosition + 1)
            End If

            Select Case sMid.Length
                Case Is <= 4
                    sMid = StrDup(sMid.Length, "*")
                Case 5
                    sMid = sMid.Substring(0, 2) & "*" & sMid.Substring(3)
                Case 6
                    sMid = sMid.Substring(0, 2) & StrDup(2, "*") & sMid.Substring(4)
                Case 7
                    sMid = sMid.Substring(0, 2) & StrDup(3, "*") & sMid.Substring(5)
                Case Else
                    iLeftLength = Int(sMid.Length / 2) - 2
                    sMid = sMid.Substring(0, iLeftLength) & StrDup(4, "*") & sMid.Substring(4 + iLeftLength)
            End Select
            sMaskedTelMP = sLeft & sMid & sRight
        End If

        Return sMaskedTelMP
    End Function

    Public Sub LoadSalesBill()
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在打开销售单……"
        frmMain.statusMain.Refresh()

        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法打开销售单。请检查数据库连接。"
            Me.Activate() : Me.Cursor = Cursors.Default : Return
        End If

        Try
            Dim dtSalesBill As DataTable = DB.GetDataTable("Exec SalesBillSingle " & sSalesBillID).Copy
            If dtSalesBill.Rows.Count = 0 Then
                MessageBox.Show("您所要打开的销售单已经不存在（已被删除）！    ", "销售单不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                If frmSalesBillManagement.IsHandleCreated Then
                    Try
                        frmSalesBillManagement.dvSalesBill.Table.Rows.Find(sSalesBillID).Delete()
                    Catch
                    End Try
                End If
                frmMain.statusText.Text = "销售单不存在！"
                DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default : Return
            Else
                drSalesBill = dtSalesBill.Copy.Rows(0)
                If drSalesBill("SalesBillType") = 4 Then drEmployee = DB.GetDataTable("Select * From EmployeeSales Where SalesBillID=" & sSalesBillID).Rows(0)
                If drSalesBill("SalesBillType") = 5 Then drMember = DB.GetDataTable("Select * From MemberSales Where SalesBillID=" & sSalesBillID).Rows(0)

                sCustomerID = drSalesBill("CustomerID").ToString
                sCityRuleID = "" : sContractID = "" : sBalanceContractID = ""
                Select Case drSalesBill("RebateMode")
                    Case 1
                        sCityRuleID = drSalesBill("RebateRuleID").ToString
                    Case 2
                        sContractID = drSalesBill("RebateRuleID").ToString
                    Case 3
                        sBalanceContractID = drSalesBill("RebateRuleID").ToString
                End Select

                Dim dvCardDetails As DataView = Nothing, drCard As DataRow = Nothing
                Select Case drSalesBill("TableType")
                    Case 0
                        dvCardDetails = DB.GetDataTable("Select * From NewSalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                    Case 1
                        dvCardDetails = DB.GetDataTable("Select * From PendingSalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                    Case 2
                        dvCardDetails = DB.GetDataTable("Select * From SalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                    Case Else
                        dvCardDetails = DB.GetDataTable("Select * From CancelledSalesBillDetails Where SalesBillID=" & sSalesBillID).DefaultView
                End Select

                'modify code 040,044:start-------------------------------------------------------------------------
                'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then '线下提卡销售单只有固定的支付方式
                '    'dtPaymentTerm.Rows.Add(8, "兑换码")
                '    If strSelectedBuyChannel = "Cul" Then
                '        dtPaymentTerm.Rows.Add(8, dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString)
                '    Else
                '        dtPaymentTerm.Rows.Add(11, dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString)
                '    End If
                'Else
                If dtPaymentTerm.Select("PaymentTerm>0").Length = 0 Then 'dtPaymentTerm.Select("PaymentTerm>1")
                    dtPaymentTerm.Rows.Add(1, "银行卡") ''''''''''''''''
                    dtPaymentTerm.Rows.Add(2, "转账")
                    dtPaymentTerm.Rows.Add(3, "支票")
                    dtPaymentTerm.Rows.Add(4, "支票＋保证金")
                End If
                If dtPaymentTerm.Select("PaymentTerm>4").Length = 0 Then
                    dtPaymentTerm.Rows.Add(5, "转账_后付")
                    dtPaymentTerm.Rows.Add(6, "支票_后付")
                    dtPaymentTerm.AcceptChanges()
                End If
                If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then '线下提卡销售单只有固定的支付方式
                    If strSelectedBuyChannel = "Cul" Then
                        dtPaymentTerm.Rows.Add(8, dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString)
                    Else
                        dtPaymentTerm.Rows.Add(11, dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString)
                    End If
                End If
                'End If
                'modify code 040,044:end-------------------------------------------------------------------------

                dtPayment.Rows.Clear()
                dtPayment.Merge(DB.GetDataTable("Exec GetSalesBillPayment " & sSalesBillID).DefaultView.Table)
                dtPayment.AcceptChanges()
                If drSalesBill("TableType") = 0 Then
                    dtRowPayment = DB.GetDataTable("Select CardRowID,PaymentRowID,DistributedAMT From NewSalesBillRowPayment Where SalesBillID=" & sSalesBillID).Copy
                Else
                    dtRowPayment = DB.GetDataTable("Select CardRowID,PaymentRowID,DistributedAMT From SalesBillRowPayment Where SalesBillID=" & sSalesBillID).Copy
                End If

                If sCityID <> frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID"))("ParentAreaID").ToString Then
                    sCityID = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID"))("ParentAreaID").ToString
                    If frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 Then
                        Dim dtInovicePrintable As DataTable = DB.GetDataTable("Select * From InvoicePrintable Where CityID=" & sCityID)
                        If dtInovicePrintable.Rows.Count = 0 Then
                            drInvoicePrintable = dtInovicePrintable.Copy.Rows.Add()
                            drInvoicePrintable("CityID") = sCityID
                            drInvoicePrintable("CanPrintInvoice") = 1
                            drInvoicePrintable("CanPrintInNextMonth") = 1
                            drInvoicePrintable("MinInvoiceAMT") = 0
                            drInvoicePrintable("MaxInvoiceAMT") = 500000
                            drInvoicePrintable.AcceptChanges()
                        Else
                            drInvoicePrintable = dtInovicePrintable.Copy.Rows(0)
                        End If
                        dtInovicePrintable.Dispose() : dtInovicePrintable = Nothing
                    End If
                End If

                'modify code 046:start-------------------------------------------------------------------------
                dtHolderInfo = DB.GetDataTable("SELECT * FROM HolderInfoList")

                Dim dtSalesBillExtendHis As DataTable
                Dim drSalesBillExtendHis As DataRow
                dtSalesBillExtendHis = DB.GetDataTable("SELECT * FROM SalesBillExtendHis WHERE SalesBillID ='" & sSalesBillID & "'")
                'modify code 046:end-------------------------------------------------------------------------

                DB.Close()

                blSkipDeal = True
                Dim sFeature As String
                Call LockWindowUpdate(Me.Handle)
                dtNormalCard.Rows.Clear()
                dvCardDetails.Sort = "RowID"
                dvCardDetails.RowFilter = "RowType<2"
                For Each dr As DataRowView In dvCardDetails
                    drCard = dtNormalCard.Rows.Add
                    drCard("RowID") = dr("RowID")
                    If dr("StartCardNo").ToString.IndexOf("9") = 0 Then
                        If dr("StartCardNo").ToString.IndexOf("94") = 0 Then
                            drCard("CardFeature") = "活动券"
                        Else
                            drCard("CardFeature") = "公关券"
                        End If
                    ElseIf dr("StartCardNo").ToString.IndexOf("86") = 0 Then
                        drCard("CardFeature") = "条码卡"
                    ElseIf dr("StartCardNo").ToString.IndexOf("8") = 0 Then
                        sFeature = dr("StartCardNo").ToString.Substring(5, 3)
                        If sFeature = "100" OrElse sFeature.IndexOf("8") = 0 Then
                            drCard("CardFeature") = "条码卡"
                        Else
                            drCard("CardFeature") = "充值券"
                        End If
                    Else
                        If dr("StartCardNo").ToString.IndexOf("233694") = 0 Then
                            drCard("CardFeature") = "活动卡"
                        ElseIf dr("StartCardNo").ToString.IndexOf("233692") = 0 Then
                            drCard("CardFeature") = IIf(drSalesBill("SalesBillType") = 1, "营销卡", "公关卡")
                        ElseIf dr("StartCardNo").ToString.IndexOf("233660") = 0 Then
                            drCard("CardFeature") = "礼品卡"
                        Else
                            drCard("CardFeature") = "磁条卡"
                        End If
                    End If

                    'modify code 046:start-------------------------------------------------------------------------
                    If dtSalesBillExtendHis.Select("SalesBillDetailID ='" & dr("SalesBillDetailID").ToString & "'").Length > 0 Then
                        drSalesBillExtendHis = dtSalesBillExtendHis.Select("SalesBillDetailID ='" & dr("SalesBillDetailID").ToString & "'")(0)
                        If bNewSalesBillType = 7 Then
                            drCard("HolderIdNo") = drSalesBillExtendHis("HolderIdNo")
                            drCard("HolderName") = drSalesBillExtendHis("HolderName")
                            drCard("Gender") = drSalesBillExtendHis("Gender")
                            drCard("Mobile") = drSalesBillExtendHis("Mobile")
                        ElseIf bNewSalesBillType = 0 Then
                            drCard("IsSignCard") = drSalesBillExtendHis("IsSignCard")
                        End If
                    End If
                    'modify code 046:end-------------------------------------------------------------------------

                    drCard("StartCardNo") = dr("StartCardNo")
                    drCard("EndCardNo") = dr("EndCardNo")
                    drCard("CardQTY") = dr("CardQTY")
                    drCard("FaceValue") = dr("FaceValue")
                    drCard("ReducedCardPayment") = dr("FaceValue") + dr("CardCost") - dr("CardPayment")
                    drCard("CardCost") = dr("CardCost")
                    drCard("CardPayment") = dr("CardPayment")
                    drCard("ChargedAMT") = dr("FaceValue") * dr("CardQTY")
                    drCard("PayableAMT") = dr("PayableAMT")
                    If dtPayment.Rows.Count > 1 Then drCard("PaymentDescription") = Me.FormatPaymentDescription(drCard("RowID").ToString)
                    Select Case dr("ActivationState")
                        Case 0
                            drCard("ActivationState") = "等待激活"
                        Case 1
                            drCard("ActivationState") = "正在激活"
                        Case 2
                            drCard("ActivationState") = "激活失败"
                        Case 3
                            If dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "部分激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "部分激活"
                            End If
                        Case 4
                            If drCard("ChargedAMT") = dr("ActivationCancelledAMT") Then
                                drCard("ActivationState") = "全部激活（已被撤销）"
                            ElseIf dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "全部激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "全部激活"
                            End If
                        Case 9
                            drCard("ActivationState") = "等待取消"
                        Case Else
                            drCard("ActivationState") = "已被取消"
                    End Select
                    drCard("ActivatedQTY") = dr("ActivatedQTY")
                    drCard("ActivatedAMT") = dr("ActivatedAMT")
                    drCard("StateReason") = dr("StateReason")
                Next
                dtNormalCard.AcceptChanges()

                'modify code 004:start-------------------------------------------------------------------------
                'dtCardCost.Rows.Clear()
                'Dim dmMaxCost As Decimal = dvCardDetails.Table.Compute("Max(CardCost)", "")
                'For iLevel As Integer = CInt(dmMaxCost) To 0 Step -1
                '    dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
                'Next
                'dtCardCost.AcceptChanges()
                'modify code 004:start-------------------------------------------------------------------------

                dtRebateCard.Rows.Clear()
                dvCardDetails.RowFilter = "RowType=2"
                For Each dr As DataRowView In dvCardDetails
                    drCard = dtRebateCard.Rows.Add
                    drCard("RowID") = dr("RowID")
                    If dr("StartCardNo").ToString.IndexOf("9") = 0 Then
                        drCard("CardFeature") = "营销券"
                    ElseIf dr("StartCardNo").ToString.IndexOf("86") = 0 Then
                        drCard("CardFeature") = "条码卡"
                    ElseIf dr("StartCardNo").ToString.IndexOf("8") = 0 Then
                        sFeature = dr("StartCardNo").ToString.Substring(5, 3)
                        If sFeature = "100" OrElse sFeature.IndexOf("8") = 0 Then
                            drCard("CardFeature") = "条码卡"
                        Else
                            drCard("CardFeature") = "充值券"
                        End If
                    Else
                        If dr("StartCardNo").ToString.IndexOf("233692") = 0 Then
                            drCard("CardFeature") = "营销卡"
                        ElseIf dr("StartCardNo").ToString.IndexOf("233660") = 0 Then
                            drCard("CardFeature") = "礼品卡"
                        Else
                            drCard("CardFeature") = "磁条卡"
                        End If
                    End If
                    drCard("StartCardNo") = dr("StartCardNo")
                    drCard("EndCardNo") = dr("EndCardNo")
                    drCard("CardQTY") = dr("CardQTY")
                    drCard("FaceValue") = dr("FaceValue")
                    drCard("ChargedAMT") = dr("FaceValue") * dr("CardQTY")
                    drCard("PayableAMT") = 0
                    Select Case dr("ActivationState")
                        Case 0
                            drCard("ActivationState") = "等待激活"
                        Case 1
                            drCard("ActivationState") = "正在激活"
                        Case 2
                            drCard("ActivationState") = "激活失败"
                        Case 3
                            If dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "部分激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "部分激活"
                            End If
                        Case 4
                            If drCard("ChargedAMT") = dr("ActivationCancelledAMT") Then
                                drCard("ActivationState") = "全部激活（已被撤销）"
                            ElseIf dr("ActivationCancelledAMT") > 0 Then
                                drCard("ActivationState") = "全部激活（部分撤销）"
                            Else
                                drCard("ActivationState") = "全部激活"
                            End If
                        Case 9
                            drCard("ActivationState") = "等待取消"
                        Case Else
                            drCard("ActivationState") = "已被取消"
                    End Select
                    drCard("ActivatedQTY") = dr("ActivatedQTY")
                    drCard("ActivatedAMT") = dr("ActivatedAMT")
                    drCard("StateReason") = dr("StateReason")
                Next
                dtRebateCard.AcceptChanges()

                dvCardDetails.Dispose() : dvCardDetails = Nothing
            End If
            dtSalesBill.Dispose() : dtSalesBill = Nothing

            dmTotalChargedAMT = drSalesBill("ChargedAMT")
            dmTotalRebateAMT = drSalesBill("RebateSalesAMT")
            'modify code 040,044:start-------------------------------------------------------------------------
            If bNewSalesBillType = 6 Then
                If strSelectedBuyChannel = "Cul" Then
                    dmTotalPaymentAMT = ecir.ExtractingCodeInfoData.BillPayTotalAmount
                Else
                    dmTotalPaymentAMT = cir.CodeAmount / 100
                End If
            Else
                dmTotalPaymentAMT = drSalesBill("PayableAMT")
            End If
            'modify code 040,044:end-------------------------------------------------------------------------
            dmTotalPrintedInvoiceAMT = drSalesBill("PrintedInvoiceAMT")

            errorNormalCell = Nothing : sErrorNormalInfo = "" : errorRebateCell = Nothing : sErrorRebateInfo = ""
            If dtDropdownCustomer IsNot Nothing Then dtDropdownCustomer.Dispose() : dtDropdownCustomer = Nothing
            drCityRule = Nothing
            If dtRuleDetails IsNot Nothing Then dtRuleDetails.Dispose() : dtRuleDetails = Nothing
            drContract = Nothing
            If dtContractDetails IsNot Nothing Then dtContractDetails.Dispose() : dtContractDetails = Nothing
            If dtInvoice IsNot Nothing Then dtInvoice.Dispose() : dtInvoice = Nothing
            If dtActivation IsNot Nothing Then dtActivation.Dispose() : dtActivation = Nothing : sActivationLoadedTime = ""

            drImportedFile = Nothing
            If dtImportedDetails IsNot Nothing Then dtImportedDetails.Dispose() : dtImportedDetails = Nothing

            blIsChanged = False
            Me.FillSalesBill()

            blSkipDeal = False
            frmMain.statusText.Text = "就绪。"
            If drSalesBill("SalesBillState") <> 9 Then Me.grbSalesBillType.Focus() : Me.grbSalesBillType.Select()
        Catch
            frmMain.statusText.Text = "系统因在检索数据时出错而无法打开销售单。请联系软件开发人员。"
            DB.Close()
        End Try

        Call LockWindowUpdate(0)
        Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub ResetCardListLayout()
        Dim iMaxRows As Int16 = Int(((Me.splitList.Height - 4 - IIf(ToolStripManager.VisualStylesEnabled, 0, 4)) / 2 - 15) / 24) - 1 '平均一边最大可容纳行数
        Dim iNormalRows As Int16 = dtNormalCard.Rows.Count
        Dim iRebateRows As Int16 = dtRebateCard.Rows.Count
        If iRebateRows < 3 AndAlso sSalesBillID = "-1" Then iRebateRows = 3
        Dim iAvailableRows As Int16
        If iRebateRows <= iMaxRows Then
            iAvailableRows = iRebateRows
        Else
            iAvailableRows = iMaxRows
            Do While iNormalRows <= iMaxRows - 1 AndAlso iAvailableRows < iRebateRows
                iAvailableRows += 1
                iMaxRows -= 1
            Loop
        End If
        Try
            Me.splitList.SplitterDistance = Me.splitList.Height - 4 - IIf(ToolStripManager.VisualStylesEnabled, 0, 2) - 15 - IIf(Me.dgvRebateCard.Width < Me.dgvRebateCard.Columns.GetColumnsWidth(DataGridViewElementStates.Visible), 17, 0) - (iAvailableRows + 1) * 24
        Catch
        End Try
    End Sub

    Private Sub ResetInterfaceLayout()
        Try
            Me.splitLayout.SplitterDistance = IIf(Me.flpLeftContainer.VerticalScroll.Visible, 264, 239)
        Catch
        End Try
        Try
            Me.splitRight.SplitterDistance = Me.Height - 219
        Catch
        End Try
        If Not Me.splitList.Panel1Collapsed AndAlso Not Me.splitList.Panel2Collapsed Then Me.ResetCardListLayout()

        If drSalesBill("SalesBillState") = 9 AndAlso Me.flpLeftContainer.VerticalScroll.Visible = True Then
            Me.lblSalesBillRemarks.Focus() : Me.lblThisPurchaseRemarks.Select()
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
        End If

        If Me.pnlAddjustSalesman.Visible = True Then
            Dim iHeight As Integer = Me.flpLeftContainer.Height - Me.grbSalesBillInfo.Height - Me.grbSalesBillInfo.Top - 6
            If iHeight < 28 Then iHeight = 28
            Me.pnlAddjustSalesman.Height = iHeight
        End If

        Me.dgvPayment.Height = IIf(ToolStripManager.VisualStylesEnabled, 96, 98)
    End Sub

    Private Sub SelectStore(Optional ByVal blShowDialog As Boolean = True)
        If blShowDialog Then
            frmSelectStore.ShowDialog()
            drSalesBill("StoreID") = frmSelectStore.cbbStore.SelectedValue
            drSalesBill("CustomerStoreID") = drSalesBill("StoreID")
            frmSelectStore.Dispose()
        End If

        Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
        drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
        sCULCardBin = drStore("CULCardBin").ToString
        sGiftCardBin = "60" & sCULCardBin.Substring(2)
        sGiftCardBin = sGiftCardBin.Replace("|84", "|60")
        sFreeCardBin = "92" & sCULCardBin.Substring(2)
        sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
        sPaperCardBin = "86" & sCULCardBin.Substring(2)
        sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
        sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
        If bNewSalesBillType = 2 Then
            sCULCardBin = "94" & sCULCardBin.Substring(2)
            sCULCardBin = sCULCardBin.Replace("|84", "|94")
            sPaperCardBin = sCULCardBin
        ElseIf bNewSalesBillType = 3 Then
            sCULCardBin = "92" & sCULCardBin.Substring(2)
            sCULCardBin = sCULCardBin.Replace("|84", "|92")
            sPaperCardBin = sCULCardBin
        End If

        If bNewSalesBillType <> 1 AndAlso sCityID <> frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString Then
            Me.chbNormalRebate.Enabled = True : Me.btnViewCityRule.Enabled = blCanViewCityRule
            sCityID = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
            sNewestCityRuleID = "" : drSalesBill("CityRuleID") = DBNull.Value
            Dim DB As New DataBase
            DB.Open()
            If DB.IsConnected Then
                Try
                    'modify code 054:start-------------------------------------------------------------------------
                    'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where CityID=" & sCityID & " And RuleState=2")
                    Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sCityID & " And RuleState=2")
                    'modify code 054:end-------------------------------------------------------------------------
                    If dtCityRule.Rows.Count = 0 Then
                        drNewestCityRule = Nothing
                        If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                        frmMain.statusText.Text = "未发现当前门店所在城市的返点规则！"
                        sNewestCityRuleID = "-1"
                    Else
                        drNewestCityRule = dtCityRule.Copy.Rows(0)
                        sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                        'modify code 054:start-------------------------------------------------------------------------
                        'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).Copy
                        dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).Copy
                        'modify code 054:end-------------------------------------------------------------------------
                        For Each drDetail As DataRow In dtNewestRuleDetails.Rows
                            drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                        Next
                        drSalesBill("CityRuleID") = sNewestCityRuleID
                    End If
                    dtCityRule.Dispose() : dtCityRule = Nothing
                Catch
                    drNewestCityRule = Nothing
                    If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                    frmMain.statusText.Text = "系统因在检索数据时出错而无法检索门店所在城市的返点规则。请联系软件开发人员。"
                End Try

                If frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 Then
                    Try
                        Dim dtInovicePrintable As DataTable = DB.GetDataTable("Select * From InvoicePrintable Where CityID=" & sCityID)
                        If dtInovicePrintable.Rows.Count = 0 Then
                            drInvoicePrintable = dtInovicePrintable.Copy.Rows.Add()
                            drInvoicePrintable("CityID") = sCityID
                            drInvoicePrintable("CanPrintInvoice") = 1
                            drInvoicePrintable("CanPrintInNextMonth") = 1
                            drInvoicePrintable("MinInvoiceAMT") = 0
                            drInvoicePrintable("MaxInvoiceAMT") = 500000
                            drInvoicePrintable.AcceptChanges()
                        Else
                            drInvoicePrintable = dtInovicePrintable.Copy.Rows(0)
                        End If
                        dtInovicePrintable.Dispose() : dtInovicePrintable = Nothing
                    Catch
                        drInvoicePrintable = Nothing
                        frmMain.statusText.Text = "系统因在检索数据时出错而无法检索发票控制参数。请联系软件开发人员。"
                    End Try

                    Me.btnConfigInvoice.Enabled = (bNewSalesBillType <> 1 AndAlso frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 AndAlso (drInvoicePrintable Is Nothing OrElse drInvoicePrintable("CanPrintInvoice")))
                End If
            End If
            DB.Close()

            Dim dmOldCardCost As Decimal = dmCardCost, blOldSkipDeal As Boolean = blSkipDeal
            Try
                Dim drCity As DataRow = dtCardParameter.Select("CityID=" & sCityID)(0)
                dmCardCost = CDec(drCity("MinFaceValue")) : dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue")) : blCanUse60Card = drCity("Use60Card") : blCanUse92Card = drCity("Use92Card") : blCanUse94Card = drCity("Use94Card") : blCanUsePaperCard = drCity("UsePaperCard") : blHaveThreeMedia = drCity("ThreeMedia")
                'modify code 051:start-------------------------------------------------------------------------
                blCanUse65Card = drCity("Use65Card")
                'modify code 051:end-------------------------------------------------------------------------
            Catch
                dmCardCost = 0 : dmMinFaceValue = 1 : dmMaxFaceValue = 1000 : blCanUse60Card = False : blCanUse92Card = False : blCanUse94Card = False : blCanUsePaperCard = False : blHaveThreeMedia = True
                'modify code 051:start-------------------------------------------------------------------------
                blCanUse65Card = False
                'modify code 051:end-------------------------------------------------------------------------
            End Try

            If blUsedOldCard OrElse (bNewSalesBillType > 0 AndAlso bNewSalesBillType < 4) Then dmCardCost = 0 : dmMinFaceValue = 0
            If bNewSalesBillType = 4 Then dmCardCost = 0 : dmMinFaceValue = 100 '如果是员工单，不收卡费，最低面值100元
            If dmCardCost <> dmOldCardCost Then
                blSkipDeal = True
                For Each drCard As DataRow In dtNormalCard.Rows
                    drCard("CardCost") = DBNull.Value
                Next
                dtCardCost.Rows.Clear()
                For iLevel As Integer = CInt(dmCardCost) To 0 Step -1
                    dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
                Next
                dtCardCost.AcceptChanges()
                For Each drCard As DataRow In dtNormalCard.Rows
                    If drCard("StartCardNo").ToString <> "" Then
                        drCard("CardCost") = IIf(drSalesBill("SalesBillType") = 0, 0, dmCardCost)
                        If drCard("FaceValue").ToString <> "" Then
                            drCard("CardPayment") = IIf(drSalesBill("SalesBillType") = 0, 0, drCard("FaceValue") + drCard("CardCost"))
                            If drCard("CardQTY").ToString <> "" Then drCard("PayableAMT") = drCard("CardQTY") * drCard("CardPayment")
                        End If
                    End If
                Next
                blSkipDeal = blOldSkipDeal
            End If

            If Me.splitList.Panel2Collapsed Then
                Me.grbPrintDiscount.Visible = False
            ElseIf blCanUse92Card Then
                Me.grbPrintDiscount.Visible = True
            Else
                Me.chbPrintDiscount.Checked = False
                Me.grbPrintDiscount.Visible = False
            End If
        End If
    End Sub

    Private Sub SelectCompanyCustomer(ByVal controlCustomerName As Control, ByVal sSelectedCustomerID As String)
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            sCustomerID = ""
            sCustomerPrompt = "系统因连接不到数据库而无法下载客户资料。请检查数据库连接。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CustomerError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
            Return
        End If

        'Dim dtCustomer As DataTable = DB.GetDataTable("Exec CustomerSingle " & sSelectedCustomerID)

        'modify code 068,072:start-------------------------------------------------------------------------
        Dim dtCustomer As DataTable
        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
            dtCustomer = DB.GetDataTable("Exec CrossCustomerSingle " & sSelectedCustomerID)
        Else
            dtCustomer = DB.GetDataTable("Exec CustomerSingle " & sSelectedCustomerID)
        End If
        'modify code 068,072:end-------------------------------------------------------------------------

        If dtCustomer Is Nothing Then
            sCustomerID = ""
            sCustomerPrompt = "系统因在检索数据时出错而无法检索客户。请联系软件开发人员。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CustomerError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        ElseIf dtCustomer.Rows.Count = 0 Then
            MessageBox.Show("您选择的客户已经不存在（可能被删除或移位）！    ", "客户不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            If frmCustomerManagement.IsHandleCreated Then
                Try
                    frmCustomerManagement.dvCustomer.Table.Rows.Find(sCustomerID).Delete()
                Catch
                End Try
            End If
            sCustomerID = "" : drCustomer = Nothing
            dtCustomer.Dispose() : dtCustomer = Nothing
            sCustomerPrompt = "您选择的客户已经不存在（可能被删除或移位），请先创建该客户或输入其他的公司名称。"
            frmMain.statusText.Text = sCustomerPrompt
            sTimerType = "CustomerError"
            Me.theTimer.Interval = 50
            Me.theTimer.Enabled = True
        Else
            drCustomer = dtCustomer.Copy.Rows(0)
            sCustomerID = drCustomer("CustomerID").ToString
            dtCustomer.Dispose() : dtCustomer = Nothing
            If frmCustomerManagement.IsHandleCreated Then frmCustomerManagement.UpdateCustomer(drCustomer)
            sCustomerName = IIf(drCustomer("CustomerChineseName").ToString = "", drCustomer("CustomerEnglishName").ToString, drCustomer("CustomerChineseName").ToString)
            If controlCustomerName.Text <> sCustomerName Then controlCustomerName.Text = sCustomerName
            Me.txbCustomerName.Text = sCustomerName

            If drCustomer("Stopped") Then
                MessageBox.Show("您选择的客户已被停止使用，再也不能向该客户售卡！    " & Chr(13) & Chr(13) & "停用客户： " & drCustomer("StoreCode").ToString & drCustomer("CustomerCode").ToString & " " & controlCustomerName.Text & Space(4) & IIf(drCustomer("StoppedReason").ToString = "", "", Chr(13) & "停用原因： " & drCustomer("StoppedReason").ToString & Space(4)), "客户已被停止使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                sCustomerID = "" : drCustomer = Nothing
                If sCustomerName.IndexOf(" （停止使用）") = -1 Then
                    controlCustomerName.Text = sCustomerName & " （停止使用）"
                    Me.txbCustomerName.Text = sCustomerName
                End If
                sCustomerPrompt = "您选择的客户已被停止使用，请输入其他的公司名称。"
                frmMain.statusText.Text = sCustomerPrompt
                sTimerType = "CustomerError"
                Me.theTimer.Interval = 50
                Me.theTimer.Enabled = True
            Else
                dvCustomerBuyer = DB.GetDataTable("Exec GetCustomerBuyer " & sCustomerID & "," & drSalesBill("StoreID").ToString).DefaultView
                If frmMain.sLoginAreaType = "S" AndAlso drCustomer("StoreID").ToString <> frmMain.sLoginAreaID Then '如果是门店用户且客户所在门店不是当前门店时，屏蔽联系人及电话
                    drCustomer("Linkman1") = DBNull.Value : drCustomer("Tel1") = DBNull.Value : drCustomer("MP1") = DBNull.Value
                    drCustomer("Linkman2") = DBNull.Value : drCustomer("Tel2") = DBNull.Value : drCustomer("MP2") = DBNull.Value
                End If
                Me.CombineCustomerBuyer()

                sCustomerPrompt = "提示：您可以输入客户编号、客户名称中的部分文字或客户名称拼音码来确定客户。"

                If dvCustomerBuyer.Count > 0 Then
                    drSalesBill("BuyerName") = dvCustomerBuyer(0)("BuyerName").ToString
                    drSalesBill("TelMP") = dvCustomerBuyer(0)("TelMP").ToString
                    If dvCustomerBuyer(0)("CredentialsType").ToString = "" Then
                        drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                        drSalesBill("BuyerCredentialsNo") = DBNull.Value
                    Else
                        drSalesBill("BuyerCredentialsType") = dvCustomerBuyer(0)("CredentialsType").ToString
                        drSalesBill("BuyerCredentialsNo") = dvCustomerBuyer(0)("CredentialsNo").ToString
                    End If
                Else
                    drSalesBill("BuyerName") = DBNull.Value
                    drSalesBill("TelMP") = DBNull.Value
                    drSalesBill("BuyerCredentialsType") = Me.cbbBuyerCredentialsType.Items(0)
                    drSalesBill("BuyerCredentialsNo") = DBNull.Value
                End If

                If drCustomer("AllowNoCredentials") Then
                    If Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = -1 Then Me.cbbCompanyCredentialsType.Items.Insert(0, "（特准无需证件）")
                    drSalesBill("CompanyCredentialsType") = "（特准无需证件）"
                    drSalesBill("CompanyCredentialsNo") = DBNull.Value
                Else
                    If Me.cbbCompanyCredentialsType.Items.IndexOf("（特准无需证件）") = 0 Then Me.cbbCompanyCredentialsType.Items.RemoveAt(0)
                    If drCustomer("CompanyCredentialsType").ToString = "" Then
                        drSalesBill("CompanyCredentialsType") = Me.cbbCompanyCredentialsType.Items(0)
                        drSalesBill("CompanyCredentialsNo") = DBNull.Value
                    Else
                        drSalesBill("CompanyCredentialsType") = drCustomer("CompanyCredentialsType").ToString
                        drSalesBill("CompanyCredentialsNo") = drCustomer("CompanyCredentialsNo").ToString
                    End If
                End If

                sContractID = drCustomer("ValidContractID").ToString : sContractAppointedStoreID = ""
                If sContractID = "" Then
                    drSalesBill("ContractID") = DBNull.Value
                    drSalesBill("ContractCode") = DBNull.Value
                    drSalesBill("ContractMode") = DBNull.Value
                Else
                    '下载合同参数
                    Try
                        'drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                        'dtContractDetails = DB.GetDataTable("Select * From ContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy

                        'modify code 068,072:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                            drContract = DB.GetDataTable("Exec GetCrossContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                            dtContractDetails = DB.GetDataTable("Select * From CrossContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy
                        Else
                            drContract = DB.GetDataTable("Exec GetContractWhenSellCard " & sContractID & "," & sCustomerID).Rows(0)
                            dtContractDetails = DB.GetDataTable("Select * From ContractDetails Where ContractID=" & sContractID & " Order By LevelID").Copy
                        End If
                        'modify code 068,072:end-------------------------------------------------------------------------

                    Catch
                        sCustomerID = ""
                        sCustomerPrompt = "系统因在检索数据时出错而无法下载合同资料。请联系软件开发人员。"
                        frmMain.statusText.Text = sCustomerPrompt
                        sTimerType = "CustomerError"
                        Me.theTimer.Interval = 50
                        Me.theTimer.Enabled = True
                        Return
                    End Try
                    sContractAppointedStoreID = drContract("AppointedStoreID").ToString
                    drSalesBill("ContractID") = sContractID
                    drSalesBill("ContractCode") = drCustomer("ValidContractCode").ToString
                    drSalesBill("ContractMode") = drContract("PaymentMode").ToString & drContract("CalculationMode").ToString
                    Select Case drContract("CalculationDay")
                        Case 0
                            drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "0" '合同期满后兑现累计返点
                        Case 255
                            drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "2" '每次购买时兑现累计返点
                        Case Else
                            drSalesBill("ContractMode") = drSalesBill("ContractMode").ToString & "1" '每月一次兑现累计返点
                    End Select
                End If

                sBalanceContractID = drCustomer("BalanceContractID").ToString : sBalanceContractAppointedStoreID = ""
                If sBalanceContractID = "" Then
                    drSalesBill("BalanceContractID") = DBNull.Value
                    drSalesBill("BalanceContractCode") = DBNull.Value
                    drSalesBill("BalanceContractBalanceRebateAMT") = 0
                Else
                    '存在到期合同返点结余
                    Try
                        'sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From ContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString

                        'modify code 068,072:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                            sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From CrossContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString
                        Else
                            sBalanceContractAppointedStoreID = DB.GetDataTable("Select AppointedStoreID From ContractList Where ContractID=" & sBalanceContractID).Rows(0)(0).ToString
                        End If
                        'modify code 068,072:end-------------------------------------------------------------------------

                    Catch
                        sCustomerID = ""
                        sCustomerPrompt = "系统因在检索数据时出错而无法下载合同资料。请联系软件开发人员。"
                        frmMain.statusText.Text = sCustomerPrompt
                        sTimerType = "CustomerError"
                        Me.theTimer.Interval = 50
                        Me.theTimer.Enabled = True
                        Return
                    End Try
                    drSalesBill("BalanceContractID") = sBalanceContractID
                    drSalesBill("BalanceContractCode") = drCustomer("BalanceContractCode").ToString
                    drSalesBill("BalanceContractBalanceRebateAMT") = drCustomer("BalanceRebateAMT")
                End If

                If frmMain.sLoginAreaType <> "S" Then drSalesBill("StoreID") = drCustomer("StoreID")

                Try
                    Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
                    dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue"))
                Catch
                    dmMinFaceValue = 1 : dmMaxFaceValue = 1000
                End Try

                If sCityID <> frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString Then
                    Me.chbNormalRebate.Enabled = True : Me.btnViewCityRule.Enabled = blCanViewCityRule
                    sCityID = frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString
                    sNewestCityRuleID = "" : drSalesBill("CityRuleID") = DBNull.Value
                    Try
                        'modify code 054:start-------------------------------------------------------------------------
                        'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where CityID=" & sCityID & " And RuleState=2")
                        Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sCityID & " And RuleState=2")
                        'modify code 054:end-------------------------------------------------------------------------
                        If dtCityRule.Rows.Count = 0 Then
                            drNewestCityRule = Nothing
                            If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                            frmMain.statusText.Text = "未发现当前门店所在城市的返点规则！"
                            sNewestCityRuleID = "-1"
                        Else
                            drNewestCityRule = dtCityRule.Copy.Rows(0)
                            sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                            'modify code 054:start-------------------------------------------------------------------------
                            'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).Copy
                            dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).Copy
                            'modify code 054:end-------------------------------------------------------------------------
                            For Each drDetail As DataRow In dtNewestRuleDetails.Rows
                                drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                            Next
                            drSalesBill("CityRuleID") = sNewestCityRuleID
                        End If
                        dtCityRule.Dispose() : dtCityRule = Nothing
                    Catch
                        drNewestCityRule = Nothing
                        If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                        frmMain.statusText.Text = "系统因在检索数据时出错而无法检索门店所在城市的返点规则。请联系软件开发人员。"
                    End Try

                    If frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 Then
                        Try
                            Dim dtInovicePrintable As DataTable = DB.GetDataTable("Select * From InvoicePrintable Where CityID=" & sCityID)
                            If dtInovicePrintable.Rows.Count = 0 Then
                                drInvoicePrintable = dtInovicePrintable.Copy.Rows.Add()
                                drInvoicePrintable("CityID") = sCityID
                                drInvoicePrintable("CanPrintInvoice") = 1
                                drInvoicePrintable("CanPrintInNextMonth") = 1
                                drInvoicePrintable("MinInvoiceAMT") = 0
                                drInvoicePrintable("MaxInvoiceAMT") = 500000
                                drInvoicePrintable.AcceptChanges()
                            Else
                                drInvoicePrintable = dtInovicePrintable.Copy.Rows(0)
                            End If
                            dtInovicePrintable.Dispose() : dtInovicePrintable = Nothing
                        Catch
                            drInvoicePrintable = Nothing
                            frmMain.statusText.Text = "系统因在检索数据时出错而无法检索发票控制参数。请联系软件开发人员。"
                        End Try
                        Me.btnConfigInvoice.Enabled = (bNewSalesBillType <> 1 AndAlso frmMain.dtAllowedRight.Select("RightName Like 'SalesBillInvoice%'").Length > 0 AndAlso (drInvoicePrintable Is Nothing OrElse drInvoicePrintable("CanPrintInvoice")))
                    End If

                    Dim dmOldCardCost As Decimal = dmCardCost
                    Try
                        Dim drCity As DataRow = dtCardParameter.Select("CityID=" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("ParentAreaID").ToString)(0)
                        dmCardCost = CDec(drCity("CardCost")) : dmMinFaceValue = CDec(drCity("MinFaceValue")) : dmMaxFaceValue = CDec(drCity("MaxFaceValue")) : blCanUse60Card = drCity("Use60Card") : blCanUse92Card = drCity("Use92Card") : blCanUse94Card = drCity("Use94Card") : blCanUsePaperCard = drCity("UsePaperCard") : blHaveThreeMedia = drCity("ThreeMedia")
                        'modify code 051:start-------------------------------------------------------------------------
                        blCanUse65Card = drCity("Use65Card")
                        'modify code 051:end-------------------------------------------------------------------------
                    Catch
                        dmCardCost = 0 : dmMinFaceValue = 1 : dmMaxFaceValue = 1000 : blCanUse60Card = False : blCanUse92Card = False : blCanUse94Card = False : blCanUsePaperCard = False : blHaveThreeMedia = True
                        'modify code 051:start-------------------------------------------------------------------------
                        blCanUse65Card = False
                        'modify code 051:end-------------------------------------------------------------------------
                    End Try

                    If blUsedOldCard Then dmCardCost = 0 : dmMinFaceValue = 0
                    If bNewSalesBillType = 4 Then dmCardCost = 0 : dmMinFaceValue = 100 '如果是员工单，不收卡费，最低面值100元
                    If dmCardCost <> dmOldCardCost Then
                        blSkipDeal = True
                        For Each drCard As DataRow In dtNormalCard.Rows
                            drCard("CardCost") = DBNull.Value
                        Next
                        dtCardCost.Rows.Clear()
                        For iLevel As Integer = CInt(dmCardCost) To 0 Step -1
                            dtCardCost.Rows.Add(iLevel, Format(iLevel, "#,0.00"))
                        Next
                        dtCardCost.AcceptChanges()
                        For Each drCard As DataRow In dtNormalCard.Rows
                            If drCard("StartCardNo").ToString <> "" Then
                                drCard("CardCost") = dmCardCost
                                If drCard("FaceValue").ToString <> "" Then
                                    drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost")
                                    If drCard("CardQTY").ToString <> "" Then drCard("PayableAMT") = drCard("CardQTY") * drCard("CardPayment")
                                End If
                            End If
                        Next
                        blSkipDeal = False
                    End If

                    If Me.splitList.Panel2Collapsed Then
                        Me.grbPrintDiscount.Visible = False
                    ElseIf blCanUse92Card Then
                        Me.grbPrintDiscount.Visible = True
                    Else
                        Me.chbPrintDiscount.Checked = False
                        Me.grbPrintDiscount.Visible = False
                    End If
                End If

                DB.Close()

                drSalesBill("CardQTY") = drSalesBill("NormalCardQTY")
                drSalesBill("RebateCardQTY") = 0
                drSalesBill("RebateRate") = DBNull.Value
                drSalesBill("RebateSalesAMT") = 0
                drSalesBill("RebateMode") = 0
                drSalesBill("RebateRuleID") = DBNull.Value
                drSalesBill("RebateState") = DBNull.Value
                drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
                drSalesBill("AddToContract") = 0

                sCustomerID = drCustomer("CustomerID").ToString
                drSalesBill("CustomerID") = sCustomerID
                drSalesBill("CustomerName") = sCustomerName
                drSalesBill("CustomerStoreID") = drCustomer("StoreID")

                For Each drCard As DataRow In dtNormalCard.Rows
                    If drCard("FaceValue").ToString <> "" Then
                        drCard("ReducedCardPayment") = 0
                        drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost")
                        If drCard("CardQTY").ToString <> "" Then drCard("PayableAMT") = drCard("CardQTY") * drCard("CardPayment")
                    End If
                Next
                Me.pnlDeductionAMT.Visible = False
                Me.dgvNormalCard.Columns("ReducedCardPayment").Visible = False
                Me.dgvNormalCard.Columns("CardPayment").Visible = False

                If frmMain.sLoginAreaType <> "S" Then
                    drSalesBill("StoreID") = drCustomer("StoreID")
                    Dim drStore As DataRow = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)
                    drSalesBill("StoreCode") = drStore("AreaCode").ToString.Substring(1)
                    Dim sNewCULCardBin As String = drStore("CULCardBin").ToString
                    If sNewCULCardBin <> sCULCardBin Then
                        blSkipDeal = True
                        blNormalCardFaceValueErrorWhenSwitchCustomer = False
                        errorNormalCell = Nothing : sErrorNormalInfo = ""
                        errorRebateCell = Nothing : sErrorRebateInfo = ""

                        If bNewSalesBillType <> "9" Then
                            If dtRebateCard.Rows.Count > 0 Then
                                dtRebateCard.Rows.Clear()
                                dtRebateCard.Rows.Add(1)
                                Me.RebateCardSummary()
                            End If
                            If dtNormalCard.Rows.Count > 0 Then
                                dtNormalCard.Rows.Clear()
                                dtNormalCard.Rows.Add(1)
                                Me.NormalCardSummary()
                            End If
                        End If

                        blSkipDeal = False

                        sCULCardBin = sNewCULCardBin
                        sFreeCardBin = "92" & sCULCardBin.Substring(2)
                        sFreeCardBin = sFreeCardBin.Replace("|84", "|92")
                        sPaperCardBin = "86" & sCULCardBin.Substring(2)
                        sPaperCardBin = sPaperCardBin.Replace("|84", "|86")
                        sPaperCardBin = sCULCardBin & "|" & sPaperCardBin '条码卡同时存在84及86号码段
                    End If
                End If

                Me.txbCustomerName.Text = drSalesBill("CustomerName").ToString
                blSkipDeal = True
                Me.cbbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
                Me.txbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
                Me.txbCompanyCredentialsNo.Text = drSalesBill("CompanyCredentialsNo").ToString
                If drSalesBill("CompanyCredentialsType").ToString = "（特准无需证件）" Then
                    Me.txbCompanyCredentialsNo.ReadOnly = True
                    Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                    Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
                Else
                    Me.txbCompanyCredentialsNo.ReadOnly = False
                    Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                End If

                Me.cbbBuyerName.Items.Clear()
                Me.cbbTelMP.Items.Clear()
                If dvCustomerBuyer.Count > 0 Then
                    dvCustomerBuyer.RowFilter = ""
                    For Each drBuyer As DataRow In dvCustomerBuyer.ToTable(True, "BuyerName").Rows
                        Me.cbbBuyerName.Items.Add(drBuyer("BuyerName").ToString)
                    Next
                    Me.cbbBuyerName.Text = drSalesBill("BuyerName").ToString
                    Me.cbbBuyerName.Visible = True
                    Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
                    Me.txbBuyerName.Visible = False

                    dvCustomerBuyer.RowFilter = "BuyerName='" & dvCustomerBuyer(0)("BuyerName").ToString.Replace("'", "''") & "' And Isnull(TelMP,'')<>''"
                    For Each drTelMP As DataRowView In dvCustomerBuyer
                        Me.cbbTelMP.Items.Add(drTelMP("TelMP").ToString)
                    Next
                    Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                    If Me.cbbTelMP.Items.Count = 0 Then
                        Me.cbbTelMP.Visible = False
                        Me.txbTelMP.Visible = True
                    Else
                        Me.cbbTelMP.Text = drSalesBill("TelMP").ToString
                        Me.cbbTelMP.Visible = True
                        Me.txbTelMP.Visible = False
                    End If
                Else
                    Me.txbBuyerName.Text = drSalesBill("BuyerName").ToString
                    Me.txbTelMP.Text = drSalesBill("TelMP").ToString
                    Me.txbBuyerName.Visible = True
                    Me.cbbBuyerName.Visible = False
                    Me.txbTelMP.Visible = True
                    Me.cbbTelMP.Visible = False
                End If
                Me.cbbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
                Me.txbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
                Me.txbBuyerCredentialsNo.Text = Me.MaskBuyerCredentialsNo()
                blSkipDeal = False

                Me.btnViewCustomer.Enabled = blCanViewCustomer

                blSkipDeal = True : Me.chbBalanceContract.Checked = False : blSkipDeal = False
                If sBalanceContractID = "" Then
                    Me.grbBalanceContract.Visible = False
                Else
                    Me.grbBalanceContract.Visible = True
                    Me.txbBalanceContractCode.Text = drCustomer("BalanceContractCode").ToString
                    Me.txbBalanceContractBalanceRebateAMT.Text = Format(drCustomer("BalanceRebateAMT"), "#,0.00")
                    Me.flpBalanceContract.Visible = False
                    Me.grbBalanceContract.Height = 108
                    If sBalanceContractAppointedStoreID <> "" AndAlso sBalanceContractAppointedStoreID <> drSalesBill("StoreID").ToString Then
                        Me.chbBalanceContract.Enabled = False
                    Else
                        Me.chbBalanceContract.Enabled = True
                    End If
                End If

                If sContractID = "" Then
                    Me.grbContract.Visible = False
                    If dmNormalSalesAMT > 0 Then
                        Me.grbNormalRebate.Visible = True
                        Me.chbNormalRebate.Enabled = True
                        If Me.chbNormalRebate.Checked Then Me.InitNormalRebateInfo()
                    End If
                    If dmNormalSalesAMT = 0 OrElse Me.chbNormalRebate.Checked = False Then
                        blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
                        Me.NormalCardSummary()
                    End If
                Else
                    Me.grbNormalRebate.Visible = False
                    Me.grbContract.Visible = True
                    Me.txbContractCode.Text = drSalesBill("ContractCode").ToString
                    If sContractAppointedStoreID <> "" AndAlso sContractAppointedStoreID <> drSalesBill("StoreID").ToString Then
                        Me.chbContract.Enabled = False
                        Me.chbContract.Checked = False
                        Me.flpContract.Visible = False
                        Me.grbContract.Height = 81
                        Me.splitList.Panel2Collapsed = True
                    Else
                        Me.chbContract.Enabled = True
                        'modify code 075:start-------------------------------------------------------------------------
                        Me.btnCheckCUL.Enabled = True
                        'modify code 075:end-------------------------------------------------------------------------
                        blSkipDeal = True : Me.chbContract.Checked = True : blSkipDeal = False
                        Me.flpContract.Visible = True
                        If Me.splitList.Panel2Collapsed Then
                            Me.splitList.Panel2Collapsed = False
                            Me.ResetCardListLayout()
                        End If
                        Me.InitContractInfo()
                    End If
                    blSkipDeal = True : Me.dgvRebateCard.CurrentRow.Selected = False : blSkipDeal = False
                End If

                'modify code 008,040,044,085:start-------------------------------------------------------------------------
                'For Each drPayment As DataRow In dtPayment.Select("PaymentTerm>0")
                For Each drPayment As DataRow In dtPayment.Select("PaymentTerm>0 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11")
                    'For Each drPayment As DataRow In dtPayment.Select("PaymentTerm>0 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11 and PaymentTerm<>13")
                    'modify code 008,040,044,085:end-------------------------------------------------------------------------
                    If drPayment("PaymentTerm") = 1 Then '银行卡 
                        If drSalesBill("BuyerName").ToString <> "" Then drPayment("PayerName") = drSalesBill("BuyerName").ToString
                    Else '转账/支票
                        drPayment("PayerName") = drSalesBill("CustomerName").ToString
                    End If
                Next

                If sBalanceContractID = "" AndAlso sContractID = "" AndAlso Me.chbNormalRebate.Checked = False AndAlso dtRebateCard.Rows(0)("StartCardNo").ToString = "" Then
                    Me.splitList.Panel2Collapsed = True
                    Me.grbPrintDiscount.Visible = False
                End If

                Me.ResetInterfaceLayout()

                If Me.flpLeftContainer.VerticalScroll.Visible = True Then
                    Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
                    Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
                End If

                frmMain.statusText.Text = "就绪。"

                'modify code 068:start-------------------------------------------------------------------------

                If sBalanceContractID <> "" AndAlso (sBalanceContractAppointedStoreID = "" OrElse sBalanceContractAppointedStoreID = drSalesBill("StoreID").ToString) AndAlso _
                MessageBox.Show("发现当前客户存在已到期但仍有剩余返点等待结算的合同。    " & Chr(13) & Chr(13) & _
                       "是否现在就结算该合同的剩余返点？    " & Chr(13) & Chr(13) & _
                       "注意：结算到期合同的剩余返点时，不能售卖正常卡。    ", "是否结算到期合同的剩余返点？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.Yes Then
                    Me.chbBalanceContract.Checked = True
                End If

                'modify code 064:start-------------------------------------------------------------------------
                'If bNewSalesBillType <> 7 AndAlso bNewSalesBillType <> 8 Then
                '    If sBalanceContractID <> "" AndAlso (sBalanceContractAppointedStoreID = "" OrElse sBalanceContractAppointedStoreID = drSalesBill("StoreID").ToString) AndAlso _
                '    MessageBox.Show("发现当前客户存在已到期但仍有剩余返点等待结算的合同。    " & Chr(13) & Chr(13) & _
                '       "是否现在就结算该合同的剩余返点？    " & Chr(13) & Chr(13) & _
                '       "注意：结算到期合同的剩余返点时，不能售卖正常卡。    ", "是否结算到期合同的剩余返点？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.Yes Then
                '        Me.chbBalanceContract.Checked = True
                '    End If
                'End If
                'modify code 064:start-------------------------------------------------------------------------

                'modify code 068:end-------------------------------------------------------------------------

                sTimerType = "AfterSelectCustomer"
                Me.theTimer.Interval = 50
                Me.theTimer.Enabled = True
            End If
        End If

        'modify code 064,068:start-------------------------------------------------------------------------
        'If bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 Then
        '    Me.grbContract.Enabled = False
        '    Me.grbContract.Visible = False
        '    Me.grbBalanceContract.Enabled = False
        '    Me.grbBalanceContract.Visible = False
        '    Me.chbContract.Checked = False
        '    Me.chbBalanceContract.Checked = False
        'End If
        'modify code 064,068:end-------------------------------------------------------------------------

    End Sub

    Private Sub CombineCustomerBuyer()
        dvCustomerBuyer.Table.RejectChanges()

        dvCustomerBuyer.RowFilter = ""
        dvCustomerBuyer.Sort = "SortID DESC"
        Dim iSortID As Integer = -1, sBuyerCredentialsType As String, sBuyerCredentialsNo As String
        If dvCustomerBuyer.Count > 0 Then iSortID = dvCustomerBuyer(0)("SortID")
        If drCustomer("Linkman2").ToString <> "" Then
            dvCustomerBuyer.RowFilter = "BuyerName='" & drCustomer("Linkman2").ToString.Replace("'", "''") & "'"
            If dvCustomerBuyer.Count = 0 Then
                If drCustomer("Tel2").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman2").ToString, drCustomer("Tel2").ToString, DBNull.Value, DBNull.Value, iSortID)
                End If
                If drCustomer("MP2").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman2").ToString, drCustomer("MP2").ToString, DBNull.Value, DBNull.Value, iSortID)
                End If
            Else
                sBuyerCredentialsType = dvCustomerBuyer(0)("CredentialsType").ToString
                sBuyerCredentialsNo = dvCustomerBuyer(0)("CredentialsNo").ToString
                If drCustomer("Tel2").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.RowFilter = "BuyerName='" & drCustomer("Linkman2").ToString.Replace("'", "''") & "' And TelMP='" & drCustomer("Tel2").ToString.Replace("'", "''") & "'"
                    If dvCustomerBuyer.Count = 0 Then
                        dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman2").ToString, drCustomer("Tel2").ToString, sBuyerCredentialsType, sBuyerCredentialsNo, iSortID)
                    Else
                        dvCustomerBuyer(0)("SortID") = iSortID
                    End If
                End If
                If drCustomer("MP2").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.RowFilter = "BuyerName='" & drCustomer("Linkman2").ToString.Replace("'", "''") & "' And TelMP='" & drCustomer("MP2").ToString.Replace("'", "''") & "'"
                    If dvCustomerBuyer.Count = 0 Then
                        dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman2").ToString, drCustomer("MP2").ToString, sBuyerCredentialsType, sBuyerCredentialsNo, iSortID)
                    Else
                        dvCustomerBuyer(0)("SortID") = iSortID
                    End If
                End If
            End If
        End If
        If drCustomer("Linkman1").ToString <> "" Then
            dvCustomerBuyer.RowFilter = "BuyerName='" & drCustomer("Linkman1").ToString.Replace("'", "''") & "'"
            If dvCustomerBuyer.Count = 0 Then
                If drCustomer("Tel1").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman1").ToString, drCustomer("Tel1").ToString, DBNull.Value, DBNull.Value, iSortID)
                End If
                If drCustomer("MP1").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman1").ToString, drCustomer("MP1").ToString, DBNull.Value, DBNull.Value, iSortID)
                End If
            Else
                sBuyerCredentialsType = dvCustomerBuyer(0)("CredentialsType").ToString
                sBuyerCredentialsNo = dvCustomerBuyer(0)("CredentialsNo").ToString
                If drCustomer("Tel1").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.RowFilter = "BuyerName='" & drCustomer("Linkman1").ToString.Replace("'", "''") & "' And TelMP='" & drCustomer("Tel1").ToString.Replace("'", "''") & "'"
                    If dvCustomerBuyer.Count = 0 Then
                        dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman1").ToString, drCustomer("Tel1").ToString, sBuyerCredentialsType, sBuyerCredentialsNo, iSortID)
                    Else
                        dvCustomerBuyer(0)("SortID") = iSortID
                    End If
                End If
                If drCustomer("MP1").ToString <> "" Then
                    iSortID += 1
                    dvCustomerBuyer.RowFilter = "BuyerName='" & drCustomer("Linkman1").ToString.Replace("'", "''") & "' And TelMP='" & drCustomer("MP1").ToString.Replace("'", "''") & "'"
                    If dvCustomerBuyer.Count = 0 Then
                        dvCustomerBuyer.Table.Rows.Add(drCustomer("Linkman1").ToString, drCustomer("MP1").ToString, sBuyerCredentialsType, sBuyerCredentialsNo, iSortID)
                    Else
                        dvCustomerBuyer(0)("SortID") = iSortID
                    End If
                End If
            End If
        End If
        dvCustomerBuyer.RowFilter = ""
    End Sub

    Private Sub NormalCardSummary()
        If sSalesBillID = "-1" Then
            Dim blOldSkipDeal As Boolean = blSkipDeal
            If blNormalCardFaceValueErrorWhenSwitchCustomer Then
                Me.lblNormalCardSummary.Text = "" : Me.lblRebateCardSummary.Text = ""
                blSkipDeal = True
                If errorNormalCell IsNot Nothing Then
                    If Me.dgvNormalCard.Columns(errorNormalCell.ColumnIndex).Name = "FaceValue" Then
                        errorNormalCell = Nothing
                    Else
                        Me.dgvNormalCard("ReducedCardPayment", errorNormalCell.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("CardPayment", errorNormalCell.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("ChargedAMT", errorNormalCell.RowIndex).Value = DBNull.Value
                        Me.dgvNormalCard("PayableAMT", errorNormalCell.RowIndex).Value = DBNull.Value
                    End If
                End If

                blNormalCardFaceValueErrorWhenSwitchCustomer = False
                If (dmMinFaceValue > 0 OrElse dmMaxFaceValue > 0) Then
                    For Each cardRow As DataGridViewRow In Me.dgvNormalCard.Rows
                        If cardRow.Cells("FaceValue").Value.ToString <> "" Then
                            'modify code 046:start-------------------------------------------------------------------------
                            Dim maxFaceValue As Decimal = dmMaxFaceValue
                            If bNewSalesBillType = 7 Then
                                maxFaceValue = dmMaxSignCardFaceValue
                            End If

                            If (cardRow.Cells("FaceValue").Value < dmMinFaceValue OrElse cardRow.Cells("FaceValue").Value > maxFaceValue) Then
                                'modify code 046:end-------------------------------------------------------------------------
                                blNormalCardFaceValueErrorWhenSwitchCustomer = True
                                If errorNormalCell Is Nothing Then
                                    errorNormalCell = cardRow.Cells("FaceValue")
                                    sErrorNormalInfo = "卡片面值应该介于 " & Format(dmMinFaceValue, "#,0.00").Replace(".00", "") & " 元 与 " & Format(dmMaxFaceValue, "#,0.00").Replace(".00", "") & " 元之间"
                                End If
                                cardRow.Cells("ReducedCardPayment").Value = DBNull.Value
                                cardRow.Cells("CardPayment").Value = DBNull.Value
                                cardRow.Cells("ChargedAMT").Value = DBNull.Value
                                cardRow.Cells("PayableAMT").Value = DBNull.Value
                            Else
                                cardRow.Cells("ReducedCardPayment").Value = 0
                                'modify code 040,046,054,072:start-------------------------------------------------------------------------
                                'If drSalesBill("SalesBillType") = 0 Then
                                'If drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6 Then
                                'If drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6 OrElse drSalesBill("SalesBillType") = 7 Then
                                If drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6 OrElse drSalesBill("SalesBillType") = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                                    'modify code 040,046,054,072:end-------------------------------------------------------------------------
                                    cardRow.Cells("CardPayment").Value = cardRow.Cells("FaceValue").Value + cardRow.Cells("CardCost").Value
                                Else
                                    cardRow.Cells("CardPayment").Value = 0
                                End If
                                cardRow.Cells("ChargedAMT").Value = cardRow.Cells("FaceValue").Value * cardRow.Cells("CardQTY").Value
                                cardRow.Cells("PayableAMT").Value = cardRow.Cells("CardPayment").Value * cardRow.Cells("CardQTY").Value
                            End If
                        End If
                    Next
                Else
                    For Each cardRow As DataGridViewRow In Me.dgvNormalCard.Rows
                        If cardRow.Cells("FaceValue").Value.ToString <> "" Then
                            If cardRow.Cells("FaceValue").Value = 0 Then
                                blNormalCardFaceValueErrorWhenSwitchCustomer = True
                                If errorNormalCell Is Nothing Then
                                    errorNormalCell = cardRow.Cells("FaceValue")
                                    sErrorNormalInfo = "卡片面值不能为零"
                                End If
                                cardRow.Cells("ReducedCardPayment").Value = DBNull.Value
                                cardRow.Cells("CardPayment").Value = DBNull.Value
                                cardRow.Cells("ChargedAMT").Value = DBNull.Value
                                cardRow.Cells("PayableAMT").Value = DBNull.Value
                            Else
                                cardRow.Cells("ReducedCardPayment").Value = 0
                                'modify code 040:start-------------------------------------------------------------------------
                                'If drSalesBill("SalesBillType") = 0 Then
                                If drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6 Then
                                    'modify code 040:end-------------------------------------------------------------------------
                                    cardRow.Cells("CardPayment").Value = cardRow.Cells("FaceValue").Value + cardRow.Cells("CardCost").Value
                                Else
                                    cardRow.Cells("CardPayment").Value = 0
                                End If
                                cardRow.Cells("ChargedAMT").Value = cardRow.Cells("FaceValue").Value * cardRow.Cells("CardQTY").Value
                                cardRow.Cells("PayableAMT").Value = cardRow.Cells("CardPayment").Value * cardRow.Cells("CardQTY").Value
                            End If
                        End If
                    Next
                End If
                blSkipDeal = blOldSkipDeal
                Me.dgvNormalCard.Refresh()
            End If
            If errorNormalCell IsNot Nothing Then
                Me.dgvNormalCard.Select() : errorNormalCell.Selected = True
                Return
            End If

            'modify code 040:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso blCanUsePaperCard Then
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 6) AndAlso blCanUsePaperCard Then
                'modify code 040:end-------------------------------------------------------------------------
                Dim blHaveOtherType As Boolean = False
                For Each drCard As DataGridViewRow In Me.dgvNormalCard.Rows
                    If drCard.Cells("CardFeature").Value.ToString = "充值券" Then
                        blHaveOtherType = True
                        Exit For
                    End If
                Next
                If blHaveOtherType = False Then
                    blOldSkipDeal = blSkipDeal
                    blSkipDeal = False
                    For iPayment As Int16 = Me.dgvPayment.RowCount - 1 To 0 Step -1
                        'modify code 008,040,044:start-------------------------------------------------------------------------
                        'If Me.dgvPayment("PaymentTerm", iPayment).Value > 4 Then
                        If Me.dgvPayment("PaymentTerm", iPayment).Value > 4 And Me.dgvPayment("PaymentTerm", iPayment).Value <> 7 And Me.dgvPayment("PaymentTerm", iPayment).Value <> 8 And Me.dgvPayment("PaymentTerm", iPayment).Value <> 11 Then
                            'modify code 008,040,044:end-------------------------------------------------------------------------
                            Me.dgvPayment("RowID", iPayment).Selected = True
                            Me.menuDeletePayment.PerformClick()
                        End If
                    Next
                    blSkipDeal = blOldSkipDeal
                    'modify code 008,040,044,085:start-------------------------------------------------------------------------
                    'For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>4")
                    For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>4 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11")
                        'For Each drPaymentTerm As DataRow In dtPaymentTerm.Select("PaymentTerm>4 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11 and PaymentTerm<>13")
                        drPaymentTerm.Delete()
                    Next
                    dtPaymentTerm.AcceptChanges()
                    'ElseIf dtPaymentTerm.Select("PaymentTerm>4").Length = 0 Then
                ElseIf dtPaymentTerm.Select("PaymentTerm>4 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11").Length = 0 Then
                    'ElseIf dtPaymentTerm.Select("PaymentTerm>4 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11 and PaymentTerm<>13").Length = 0 Then
                    dtPaymentTerm.Rows.Add(5, "转账_后付")
                    dtPaymentTerm.Rows.Add(6, "支票_后付")
                    dtPaymentTerm.AcceptChanges()
                    'modify code 008,040,044,085:end-------------------------------------------------------------------------
                End If
            End If

            If dtNormalCard.Rows.Count = 0 OrElse dtNormalCard.Rows(0)("StartCardNo").ToString = "" Then
                dmNormalSalesAMT = 0 : dmPayableAMT = 0
                drSalesBill("NormalCardQTY") = 0
                drSalesBill("NormalSalesAMT") = 0
                drSalesBill("CardCost") = 0
                drSalesBill("CardQTY") = 0
                drSalesBill("PayableAMT") = 0
                drSalesBill("ChargedAMT") = 0

                'modify code 046,054,072:start-------------------------------------------------------------------------
                '同一般销售单
                'If bNewSalesBillType = 0 AndAlso Me.grbNormalRebate.Visible Then
                'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso Me.grbNormalRebate.Visible Then
                If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso Me.grbNormalRebate.Visible Then
                    'modify code 046,054,072:end-------------------------------------------------------------------------
                    Me.grbNormalRebate.Visible = False
                    Me.splitList.Panel2Collapsed = True
                    Me.grbPrintDiscount.Visible = False
                    Me.ResetInterfaceLayout()
                End If

                'modify code 046,054,072:start-------------------------------------------------------------------------
                '同一般销售单
                'If bNewSalesBillType = 0 AndAlso drSalesBill("RebateMode") = 2 AndAlso drContract("PaymentMode") = 0 AndAlso Me.splitList.Panel2Collapsed Then
                'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("RebateMode") = 2 AndAlso drContract("PaymentMode") = 0 AndAlso Me.splitList.Panel2Collapsed Then
                If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("RebateMode") = 2 AndAlso drContract("PaymentMode") = 0 AndAlso Me.splitList.Panel2Collapsed Then
                    'modify code 046,054,072:end-------------------------------------------------------------------------
                    Me.splitList.Panel2Collapsed = False
                    Me.ResetCardListLayout()
                End If

                If bNewSalesBillType = 4 Then
                    Me.splitList.Panel2Collapsed = False
                    Me.ResetCardListLayout()
                End If
            Else
                If dtNormalCard.Compute("Sum(ChargedAMT)", "").ToString = "" Then dmNormalSalesAMT = 0 Else dmNormalSalesAMT = dtNormalCard.Compute("Sum(ChargedAMT)", "")
                If dtNormalCard.Compute("Sum(PayableAMT)", "").ToString = "" Then dmPayableAMT = 0 Else dmPayableAMT = dtNormalCard.Compute("Sum(PayableAMT)", "")

                drSalesBill("NormalCardQTY") = dtNormalCard.Compute("Sum(CardQTY)", "")
                drSalesBill("NormalSalesAMT") = dmNormalSalesAMT
                drSalesBill("CardCost") = dtNormalCard.Compute("Sum(CostAMT)", "")
                drSalesBill("PayableAMT") = dmPayableAMT
                drSalesBill("ChargedAMT") = dmNormalSalesAMT

                'modify code 046,054,072:start-------------------------------------------------------------------------
                '同一般销售单
                'If bNewSalesBillType = 0 AndAlso drSalesBill("RebateMode") < 2 Then
                'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("RebateMode") < 2 ThenThen
                If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("RebateMode") < 2 Then
                    'modify code 046,054,072:end-------------------------------------------------------------------------
                    Me.grbNormalRebate.Visible = (dmNormalSalesAMT > 0)
                    If Me.grbNormalRebate.Visible AndAlso Me.chbNormalRebate.Checked AndAlso Me.splitList.Panel2Collapsed Then
                        Me.splitList.Panel2Collapsed = False
                        Me.ResetCardListLayout()
                    End If
                    Me.ResetInterfaceLayout()
                End If
            End If

            'modify code 046,054,072:start-------------------------------------------------------------------------
            '同一般销售单
            'If (bNewSalesBillType = 0 AndAlso (drSalesBill("RebateMode") = 1 OrElse (drSalesBill("RebateMode") = 2 AndAlso drContract("PaymentMode") = 0))) OrElse bNewSalesBillType = 4 Then
            'If ((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso (drSalesBill("RebateMode") = 1 OrElse (drSalesBill("RebateMode") = 2 AndAlso drContract("PaymentMode") = 0))) OrElse bNewSalesBillType = 4 Then
            If ((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso (drSalesBill("RebateMode") = 1 OrElse (drSalesBill("RebateMode") = 2 AndAlso drContract("PaymentMode") = 0))) OrElse bNewSalesBillType = 4 Then
                'modify code 046,054,072:end-------------------------------------------------------------------------
                drSalesBill("ChargedAMT") = dmNormalSalesAMT + dmRebateSalesAMT
            End If

            Me.CalculateCardQTY()

            If bNewSalesBillType = 4 Then
                Me.UpdateEmployeePurchaseInfo() '员工卡
            ElseIf Me.dgvRebateCard.Visible Then
                Me.RebateCardSummary()
            ElseIf drSalesBill("RebateMode") = 1 Then '一般返点
                Me.UpdateNormalRebateInfo()
            ElseIf drSalesBill("RebateMode") = 2 Then '合同返点
                Me.UpdateContractInfo()
            ElseIf drSalesBill("RebateMode") = 3 Then '合同结余
                Me.UpdateBalanceContractInfo()
            End If

            If drSalesBill("SalesBillType") <> 1 AndAlso drSalesBill("RebateMode") <> 3 Then
                'modify code 006:start-------------------------------------------------------------------------
                'If dmPayableAMT > 0 AndAlso Me.dgvPayment.RowCount = 1 Then
                'If dmPayableAMT >= 0 AndAlso Me.dgvPayment.RowCount = 1 Then
                '    'modify code 006:end-------------------------------------------------------------------------
                '    blOldSkipDeal = blSkipDeal
                '    blSkipDeal = False
                '    Me.dgvPayment("PaymentAMT", 0).Value = dmPayableAMT
                '    blSkipDeal = blOldSkipDeal
                '    Me.dgvPayment("PaymentAMT", 0).Selected = False
                '    'modify code 040,044:start-------------------------------------------------------------------------
                'ElseIf bNewSalesBillType = 6 Then
                '    blOldSkipDeal = blSkipDeal
                '    blSkipDeal = False
                '    'Me.dgvPayment("PaymentAMT", 0).Value = drSalesBill("CardCost")
                '    If strSelectedBuyChannel = "Cul" Then
                '        'Me.dgvPayment("PaymentAMT", 0).Value = dmPayableAMT - ecir.ExtractingCodeInfoData.BillPayTotalAmount
                '        Me.lblTotalPayAmt.Text = ecir.ExtractingCodeInfoData.BillPayTotalAmount + IIf(IsDBNull(drSalesBill("CardCost")), 0, drSalesBill("CardCost"))
                '    Else
                '        'Me.dgvPayment("PaymentAMT", 0).Value = dmPayableAMT - cir.CodeAmount / 100
                '        Me.lblTotalPayAmt.Text = cir.CodeAmount / 100 + IIf(IsDBNull(drSalesBill("CardCost")), 0, drSalesBill("CardCost"))
                '    End If
                '    blSkipDeal = blOldSkipDeal
                '    Me.dgvPayment("PaymentAMT", 0).Selected = False
                '    'modify code 040,044:end-------------------------------------------------------------------------
                'End If
                If bNewSalesBillType = 6 Then
                    blOldSkipDeal = blSkipDeal
                    blSkipDeal = False
                    'Me.dgvPayment("PaymentAMT", 0).Value = drSalesBill("CardCost")
                    If strSelectedBuyChannel = "Cul" Then
                        'Me.dgvPayment("PaymentAMT", 0).Value = dmPayableAMT - ecir.ExtractingCodeInfoData.BillPayTotalAmount
                        Me.lblTotalPayAmt.Text = ecir.ExtractingCodeInfoData.BillPayTotalAmount + IIf(IsDBNull(drSalesBill("CardCost")), 0, drSalesBill("CardCost"))
                    Else
                        'Me.dgvPayment("PaymentAMT", 0).Value = dmPayableAMT - cir.CodeAmount / 100
                        Me.lblTotalPayAmt.Text = cir.CodeAmount / 100 + IIf(IsDBNull(drSalesBill("CardCost")), 0, drSalesBill("CardCost"))
                    End If
                    blSkipDeal = blOldSkipDeal
                    Me.dgvPayment("PaymentAMT", 0).Selected = False
                ElseIf dmPayableAMT >= 0 AndAlso Me.dgvPayment.RowCount = 1 Then
                    'modify code 006:end-------------------------------------------------------------------------
                    blOldSkipDeal = blSkipDeal
                    blSkipDeal = False
                    Me.dgvPayment("PaymentAMT", 0).Value = dmPayableAMT
                    blSkipDeal = blOldSkipDeal
                    Me.dgvPayment("PaymentAMT", 0).Selected = False
                    'modify code 040,044:end-------------------------------------------------------------------------
                End If
                Me.PaymentSummary()
            Else
                Me.btnOK.Enabled = True
            End If

            blIsChanged = (dmNormalSalesAMT <> 0 OrElse dmRebateSalesAMT <> 0)
            Me.btnNewSalesBill.Enabled = blIsChanged
        Else
            dmNormalSalesAMT = drSalesBill("NormalSalesAMT")
            dmPayableAMT = drSalesBill("PayableAMT")
        End If

        If dmNormalSalesAMT = 0 Then
            Me.lblNormalCardSummary.Text = ""
        Else
            Me.lblNormalCardSummary.Text = "（卡数： " & Format(drSalesBill("NormalCardQTY"), "#,0") & " 张  充值： " & Format(dmNormalSalesAMT, "#,0.00") & " 元  应付： " & Format(dmPayableAMT, "#,0.00") & " 元）"
        End If
    End Sub

    Private Sub RebateCardSummary()
        If sSalesBillID = "-1" Then
            If dtRebateCard.Rows.Count = 0 OrElse dtRebateCard.Compute("Sum(ChargedAMT)", "").ToString = "" Then
                dmRebateSalesAMT = 0
                drSalesBill("CardQTY") = drSalesBill("NormalCardQTY")
                drSalesBill("RebateRate") = 0
                drSalesBill("RebateCardQTY") = 0
                drSalesBill("RebateSalesAMT") = 0
                If dmPayableAMT = 0 Then
                    Me.btnOK.Text = IIf(drSalesBill("RebateMode") = 3, "销售单确认(&O)", "付款确认(&O)")
                    Me.btnOK.Enabled = False
                    blIsChanged = (dtNormalCard.Rows.Count > 1)
                End If
            Else
                dmRebateSalesAMT = dtRebateCard.Compute("Sum(ChargedAMT)", "")
                If dmNormalSalesAMT = 0 Then
                    drSalesBill("RebateRate") = 1
                Else
                    drSalesBill("RebateRate") = Int((dmRebateSalesAMT / dmNormalSalesAMT) * 1000 + 0.5) / 1000
                End If
                drSalesBill("RebateCardQTY") = dtRebateCard.Compute("Sum(CardQTY)", "")
                If drSalesBill("RebateCardQTY").ToString = "" Then drSalesBill("RebateCardQTY") = 0
                drSalesBill("RebateSalesAMT") = dmRebateSalesAMT
                If dmNormalSalesAMT = 0 Then
                    Me.btnOK.Text = "销售单确认(&O)"
                    Me.btnOK.Enabled = (dmRebateSalesAMT <> 0)
                    blIsChanged = True
                End If
            End If
            Me.btnNewSalesBill.Enabled = blIsChanged
            Me.CalculateCardQTY()

            If bNewSalesBillType = 4 Then
                Me.UpdateEmployeePurchaseInfo() '员工卡
            ElseIf drSalesBill("RebateMode") = 1 Then '一般返点
                Me.UpdateNormalRebateInfo()
            ElseIf drSalesBill("RebateMode") = 2 Then '合同返点
                Me.UpdateContractInfo()
            ElseIf drSalesBill("RebateMode") = 3 Then '结余返点
                Me.UpdateBalanceContractInfo()
            End If

            drSalesBill("ChargedAMT") = dmNormalSalesAMT + dmRebateSalesAMT
        Else
            dmRebateSalesAMT = drSalesBill("RebateSalesAMT")
        End If

        If dmRebateSalesAMT = 0 Then
            Me.lblRebateCardSummary.Text = ""
        Else
            Me.lblRebateCardSummary.Text = "（卡数： " & Format(drSalesBill("RebateCardQTY"), "#,0") & " 张  充值： " & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元  应付：0.00 元）"
        End If
    End Sub

    Private Sub CalculateCardQTY()
        'modify code 022:start-------------------------------------------------------------------------
        Dim boolRepeated As Boolean
        'modify code 022:end-------------------------------------------------------------------------
        If drSalesBill("RebateCardQTY") = 0 Then
            drSalesBill("CardQTY") = drSalesBill("NormalCardQTY")
            If sErrorNormalInfo.IndexOf("两个面值之和不能超过") > -1 Then errorNormalCell = Nothing : Me.dgvNormalCard.Refresh()
            If sErrorNormalInfo = "同一张条码卡不能同时既是正常卡又是返点卡" Then errorNormalCell = Nothing : Me.dgvNormalCard.Refresh()
        ElseIf drSalesBill("NormalCardQTY") = 0 Then
            drSalesBill("CardQTY") = drSalesBill("RebateCardQTY")
            If sErrorRebateInfo.IndexOf("两个面值之和不能超过") > -1 Then errorRebateCell = Nothing : Me.dgvRebateCard.Refresh()
            If sErrorRebateInfo = "同一张条码卡不能同时既是正常卡又是返点卡" Then errorRebateCell = Nothing : Me.dgvRebateCard.Refresh()
        Else
            Dim dtCard As New DataTable, sCardNo As String = "", iNormalCards As Integer = Me.dgvNormalCard.RowCount - 1, blHaveError As Boolean = False
            If drSalesBill("ImportedFromFile").ToString = "" Then iNormalCards -= 1
            dtCard.Columns.Add("CardNo", System.Type.GetType("System.String"))
            dtCard.PrimaryKey = New DataColumn() {dtCard.Columns("CardNo")}
            For iRow As Int16 = 0 To iNormalCards
                sCardNo = Me.dgvNormalCard("StartCardNo", iRow).Value.ToString
                If sCardNo.IndexOf("2") = 0 Then sCardNo = sCardNo.Substring(0, 18)
                For iCard As Integer = 0 To Me.dgvNormalCard("CardQTY", iRow).Value - 1
                    dtCard.Rows.Add((CLng(sCardNo) + iCard).ToString)
                Next
            Next

            'modify code 046:start-------------------------------------------------------------------------
            Dim maxFaceValue As Decimal = 1000
            If bNewSalesBillType = 7 Then
                maxFaceValue = dmMaxSignCardFaceValue
            End If
            'modify code 046:end-------------------------------------------------------------------------

            For iRow As Int16 = 0 To Me.dgvRebateCard.RowCount - 2
                'modify code 022:start-------------------------------------------------------------------------
                'Try
                sCardNo = Me.dgvRebateCard("StartCardNo", iRow).Value.ToString

                'modify code 046,050,054:start-------------------------------------------------------------------------
                'If bNewSalesBillType = 0 Then
                If bNewSalesBillType = 0 OrElse bNewSalesBillType = 8 Then
                    'If getSignCardList(sCardNo).Rows.Count > 0 Then
                    'If dtSignCardRangeAll.Select("CardNo='" & sCardNo & "'").Length > 0 Then
                    '    maxFaceValue = dmMaxSignCardFaceValue
                    'Else
                    maxFaceValue = 1000
                    'End If
                End If
                'modify code 046,050,054:end-------------------------------------------------------------------------

                If sCardNo.IndexOf("2") = 0 Then sCardNo = sCardNo.Substring(0, 18)
                For iCard As Integer = 0 To Me.dgvRebateCard("CardQTY", iRow).Value - 1
                    'dtCard.Rows.Add((CLng(sCardNo) + iCard).ToString)
                    If iCard > 0 Then
                        sCardNo = (CLng(sCardNo) + 1).ToString
                    End If
                    Try
                        boolRepeated = False
                        dtCard.Rows.Add(sCardNo)
                    Catch
                        boolRepeated = True
                    End Try
                    If boolRepeated Then
                        If sCardNo.IndexOf("2") = 0 Then
                            If Me.dgvRebateCard("FaceValue", iRow).Value.ToString <> "" Then
                                sCardNo = ShoppingCardNo.GetFullCardNo(sCardNo)
                                Try
                                    Dim drNormal As DataRow = dtNormalCard.Select("StartCardNo<='" & sCardNo & "' And EndCardNo>='" & sCardNo & "'")(0)
                                    'modify code 046:start-------------------------------------------------------------------------
                                    If drNormal("FaceValue").ToString <> "" AndAlso Me.dgvRebateCard("FaceValue", iRow).Value + drNormal("FaceValue") > maxFaceValue Then
                                        'If drNormal("FaceValue").ToString <> "" AndAlso Me.dgvRebateCard("FaceValue", iRow).Value + drNormal("FaceValue") > 1000 Then
                                        If drNormal("CardQTY") = 1 Then
                                            'sErrorNormalInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorNormalInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        Else
                                            'sErrorNormalInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorNormalInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        End If
                                        errorNormalCell = Me.dgvNormalCard("FaceValue", drNormal("RowID") - 1)
                                        If Me.dgvRebateCard("CardQTY", iRow).Value = 1 Then
                                            'sErrorRebateInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorRebateInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        Else
                                            'sErrorRebateInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorRebateInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        End If
                                        'modify code 046:end-------------------------------------------------------------------------
                                        errorRebateCell = Me.dgvRebateCard("FaceValue", iRow)
                                        blHaveError = True
                                    End If
                                Catch
                                    'modify code 046:start-------------------------------------------------------------------------
                                    If Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Value.ToString <> "" AndAlso Me.dgvRebateCard("FaceValue", iRow).Value + Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Value > maxFaceValue Then
                                        'If Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Value.ToString <> "" AndAlso Me.dgvRebateCard("FaceValue", iRow).Value + Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Value > 1000 Then
                                        If Me.dgvNormalCard("CardQTY", Me.dgvNormalCard.CurrentRow.Index).Value = 1 Then
                                            'sErrorNormalInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorNormalInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        Else
                                            'sErrorNormalInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorNormalInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        End If
                                        errorNormalCell = Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index)
                                        If Me.dgvRebateCard("CardQTY", iRow).Value = 1 Then
                                            'sErrorRebateInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorRebateInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        Else
                                            'sErrorRebateInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                                            sErrorRebateInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 " & maxFaceValue & " 元"
                                        End If
                                        'modify code 046:end-------------------------------------------------------------------------
                                        errorRebateCell = Me.dgvRebateCard("FaceValue", iRow)
                                        blHaveError = True
                                    End If
                                End Try
                            End If
                        Else '条码卡
                            blHaveError = True
                        End If
                    End If
                    If blHaveError Then Exit For
                    If sCardNo.IndexOf("2") = 0 Then sCardNo = sCardNo.Substring(0, 18)
                Next
                'Catch
                '    If sCardNo.IndexOf("2") = 0 Then
                '        If Me.dgvRebateCard("FaceValue", iRow).Value.ToString <> "" Then
                '            sCardNo = ShoppingCardNo.GetFullCardNo(sCardNo)
                '            Try
                '                Dim drNormal As DataRow = dtNormalCard.Select("StartCardNo<='" & sCardNo & "' And EndCardNo>='" & sCardNo & "'")(0)
                '                If drNormal("FaceValue").ToString <> "" AndAlso Me.dgvRebateCard("FaceValue", iRow).Value + drNormal("FaceValue") > 1000 Then
                '                    If drNormal("CardQTY") = 1 Then
                '                        sErrorNormalInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    Else
                '                        sErrorNormalInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    End If
                '                    errorNormalCell = Me.dgvNormalCard("FaceValue", drNormal("RowID") - 1)
                '                    If Me.dgvRebateCard("CardQTY", iRow).Value = 1 Then
                '                        sErrorRebateInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    Else
                '                        sErrorRebateInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    End If
                '                    errorRebateCell = Me.dgvRebateCard("FaceValue", iRow)
                '                    blHaveError = True
                '                End If
                '            Catch
                '                If Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Value.ToString <> "" AndAlso Me.dgvRebateCard("FaceValue", iRow).Value + Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index).Value > 1000 Then
                '                    If Me.dgvNormalCard("CardQTY", Me.dgvNormalCard.CurrentRow.Index).Value = 1 Then
                '                        sErrorNormalInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    Else
                '                        sErrorNormalInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    End If
                '                    errorNormalCell = Me.dgvNormalCard("FaceValue", Me.dgvNormalCard.CurrentRow.Index)
                '                    If Me.dgvRebateCard("CardQTY", iRow).Value = 1 Then
                '                        sErrorRebateInfo = "该卡既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    Else
                '                        sErrorRebateInfo = "该行部分卡片既是正常卡又是返点卡，两个面值之和不能超过 1,000 元"
                '                    End If
                '                    errorRebateCell = Me.dgvRebateCard("FaceValue", iRow)
                '                    blHaveError = True
                '                End If
                '            End Try
                '        End If
                '    Else '条码卡
                '        blHaveError = True
                '    End If
                'End Try
                'modify code 022:end-------------------------------------------------------------------------
            Next

            If Not blHaveError Then
                If sErrorNormalInfo.IndexOf("两个面值之和不能超过") > -1 Then errorNormalCell = Nothing : sErrorNormalInfo = ""
                If sErrorRebateInfo.IndexOf("两个面值之和不能超过") > -1 Then errorRebateCell = Nothing : sErrorRebateInfo = ""
                If sErrorNormalInfo.IndexOf("同一张条码卡不能同时既是正常卡又是返点卡") > -1 Then errorNormalCell = Nothing : sErrorNormalInfo = ""
                If sErrorRebateInfo.IndexOf("同一张条码卡不能同时既是正常卡又是返点卡") > -1 Then errorRebateCell = Nothing : sErrorRebateInfo = ""
            End If

            dtCard.AcceptChanges()
            drSalesBill("CardQTY") = dtCard.Rows.Count
            dtCard.Dispose() : dtCard = Nothing
            Me.dgvNormalCard.Refresh() : Me.dgvRebateCard.Refresh()
        End If
    End Sub

    Private Sub PaymentSummary()
        Dim sumFaceValue As Decimal = 0
        Dim sumCardCost As Decimal = 0
        If sSalesBillID = "-1" Then
            If dtPayment.Compute("Sum(PaymentAMT)", "").ToString = "" Then dmReceivedAMT = 0 Else dmReceivedAMT = dtPayment.Compute("Sum(PaymentAMT)", "")
            drSalesBill("ReceivedAMT") = dmReceivedAMT : drSalesBill("ChangeAMT") = dmReceivedAMT - dmPayableAMT
            'modify code 040:start-------------------------------------------------------------------------
            'If bNewSalesBillType <> 6 Then
            If dmReceivedAMT < dmPayableAMT Then
                Dim blNeedAdd As Boolean = True
                For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                    If drPayment.Cells("PaymentAMT").Value.ToString = "" OrElse drPayment.Cells("PaymentAMT").Value = 0 Then
                        blNeedAdd = False : Exit For
                    End If
                    'modify code 008:start-------------------------------------------------------------------------
                    If drPayment.Cells("PaymentTerm").Value = 7 Then
                        blNeedAdd = False : Exit For
                    End If
                    'modify code 008:end-------------------------------------------------------------------------
                Next
                If bNewSalesBillType = 6 AndAlso dtPayment.Rows.Count <> 1 Then
                    blNeedAdd = False
                End If
                If blNeedAdd Then
                    dtPayment.Rows.Add(Me.dgvPayment.RowCount + 1, 0)
                End If
                If bNewSalesBillType = 6 AndAlso dtPayment.Rows.Count = 2 Then
                    For Each drCard As DataRow In dtNormalCard.Rows
                        If drCard("FaceValue").ToString <> "" Then
                            sumFaceValue = sumCardCost + CDec(drCard("FaceValue").ToString) * CDec(drCard("CardQTY").ToString)
                        End If

                        If drCard("CardCost").ToString <> "" Then
                            sumCardCost = sumCardCost + CDec(drCard("CardCost").ToString) * CDec(drCard("CardQTY").ToString)
                        End If
                    Next
                    If sumCardCost = 0 Then
                        dtPayment.Rows(1).Delete()
                        Me.dgvNormalCard.Columns("PaymentDescription").Visible = False
                    Else
                        dtPayment.Rows(1)("PaymentAMT") = sumCardCost

                        Dim drNormalCard As DataRow
                        For Each drNormalCard In dtNormalCard.Rows
                            If drNormalCard("StartCardNo").ToString.Trim <> "" AndAlso drNormalCard("PaymentDescription").ToString.Trim = "" Then
                                drNormalCard("PaymentDescription") = "请分配付款金额……"
                            End If
                        Next
                        Me.dgvNormalCard.Columns("PaymentDescription").Visible = True
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
                        Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                        frmMain.statusText.Text = "注意：付款单中存在多行付款，请对购物卡列表中的每一行进行付款分配。"
                    End If
                    drSalesBill("ReceivedAMT") = CDec(dtPayment.Rows(0)("PaymentAMT").ToString) + sumCardCost
                    dmReceivedAMT = drSalesBill("ReceivedAMT")
                End If
                'modify code 044:start-------------------------------------------------------------------------
            ElseIf Me.dgvPayment.RowCount > 1 AndAlso (Me.dgvPayment("PaymentAMT", Me.dgvPayment.RowCount - 1).Value.ToString = "" OrElse Me.dgvPayment("PaymentAMT", Me.dgvPayment.RowCount - 1).Value = 0) Then
                dtPayment.Rows(dtPayment.Rows.Count - 1).Delete()
                'modify code 044:start-------------------------------------------------------------------------
            ElseIf bNewSalesBillType = 6 Then
                For Each drCard As DataRow In dtNormalCard.Rows
                    If drCard("FaceValue").ToString <> "" Then
                        sumFaceValue = sumCardCost + CDec(drCard("FaceValue").ToString) * CDec(drCard("CardQTY").ToString)
                    End If
                    If drCard("CardCost").ToString <> "" Then
                        sumCardCost = sumCardCost + CDec(drCard("CardCost").ToString) * CDec(drCard("CardQTY").ToString)
                    End If
                Next

                If sumCardCost = 0 Then
                    If dtPayment.Rows.Count = 2 Then
                        dtPayment.Rows(1).Delete()
                        For Each drNormalCard In dtNormalCard.Rows
                            drNormalCard("PaymentDescription") = DBNull.Value
                        Next
                        Me.dgvNormalCard.Columns("PaymentDescription").Visible = False

                        drSalesBill("ReceivedAMT") = CDec(dtPayment.Rows(0)("PaymentAMT").ToString)
                        dmReceivedAMT = drSalesBill("ReceivedAMT")
                    End If
                Else
                    If dtPayment.Rows.Count = 1 Then
                        dtPayment.Rows.Add(1, 0)
                        dtPayment.Rows(1)("RowID") = 2
                        dtSelectablePayment.Rows.Add(0, Me.dgvPayment("RowID", 1).Value, Me.dgvPayment("PaymentTerm", 1).FormattedValue)
                    End If

                    Dim drNormalCard As DataRow
                    For Each drNormalCard In dtNormalCard.Rows
                        If drNormalCard("StartCardNo").ToString.Trim <> "" AndAlso drNormalCard("PaymentDescription").ToString.Trim = "" Then
                            drNormalCard("PaymentDescription") = "请分配付款金额……"
                        End If
                    Next
                    Me.dgvNormalCard.Columns("PaymentDescription").Visible = True
                    Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                    Me.dgvNormalCard.Columns("PaymentDescription").Width += 24
                    Me.dgvNormalCard.Columns("PaymentDescription").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    frmMain.statusText.Text = "注意：付款单中存在多行付款，请对购物卡列表中的每一行进行付款分配。"

                    dtPayment.Rows(1)("PaymentAMT") = sumCardCost
                    drSalesBill("ReceivedAMT") = CDec(dtPayment.Rows(0)("PaymentAMT").ToString) + sumCardCost
                    dmReceivedAMT = drSalesBill("ReceivedAMT")
                End If
            End If
            'modify code 040:end-------------------------------------------------------------------------

            If drSalesBill("CardQTY") > 0 AndAlso dmNormalSalesAMT > 0 Then
                Me.btnOK.Text = "付款确认(&O)"
                Me.btnOK.Enabled = True
            ElseIf drSalesBill("RebateMode") <> 0 AndAlso dmRebateSalesAMT > 0 Then
                Me.btnOK.Text = "销售单确认(&O)"
                Me.btnOK.Enabled = True
            Else
                Me.btnOK.Text = "付款确认(&O)"
                Me.btnOK.Enabled = False
            End If
            blIsChanged = Me.btnOK.Enabled
            Me.btnNewSalesBill.Enabled = blIsChanged
        Else
            dmReceivedAMT = drSalesBill("ReceivedAMT")
        End If

        'modify code 040,044:start-------------------------------------------------------------------------
        If sSalesBillID = "-1" AndAlso (bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6) Then
            If strSelectedBuyChannel = "Cul" Then
                'Me.lblTotalPayAmt.Text = Format(ecir.ExtractingCodeInfoData.BillPayTotalAmount + IIf(IsDBNull(drSalesBill("CardCost")), 0, drSalesBill("CardCost")), "#,0.00")
                Me.lblTotalPayAmt.Text = Format(ecir.ExtractingCodeInfoData.BillPayTotalAmount + sumCardCost, "#,0.00")
            Else
                'Me.lblTotalPayAmt.Text = Format(cir.CodeAmount / 100 + IIf(IsDBNull(drSalesBill("CardCost")), 0, drSalesBill("CardCost")), "#,0.00")
                Me.lblTotalPayAmt.Text = Format(cir.CodeAmount / 100 + sumCardCost, "#,0.00")
            End If
        Else
            Me.lblTotalPayAmt.Text = Format(dmPayableAMT, "#,0.00")
        End If
        'modify code 040,044:end-------------------------------------------------------------------------
        Me.lblPayable.Text = Format(dmPayableAMT, "#,0.00")
        Me.lblPaid.Text = Format(dmReceivedAMT, "#,0.00")
        If dmPayableAMT >= dmReceivedAMT Then
            Me.lblUnpaidTitle.ForeColor = SystemColors.ControlText
            Me.lblUnpaidTitle.Text = "未付："
            Me.lblUnpaid.ForeColor = Color.Maroon
            Me.lblUnpaid.Text = Format(dmPayableAMT - dmReceivedAMT, "#,0.00")
        Else
            Me.lblUnpaidTitle.ForeColor = Color.Red
            Me.lblUnpaidTitle.Text = "找零："
            Me.lblUnpaid.ForeColor = Color.Blue
            Me.lblUnpaid.Text = Format(dmReceivedAMT - dmPayableAMT, "#,0.00")
        End If
    End Sub

    Private Function FormatPaymentDescription(ByVal sCardRowID As String) As String
        Dim sPaymentDescription As String = "", drPayment As DataRow
        For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & sCardRowID, "PaymentRowID")
            drPayment = dtPayment.Select("RowID=" & drRowPayment("PaymentRowID").ToString)(0)
            sPaymentDescription = sPaymentDescription & drPayment("RowID").ToString & "-"
            Select Case drPayment("PaymentTerm")
                Case 0
                    sPaymentDescription = sPaymentDescription & "现金："
                Case 1
                    sPaymentDescription = sPaymentDescription & "银行卡："
                Case 2
                    sPaymentDescription = sPaymentDescription & "转账："
                Case 3
                    sPaymentDescription = sPaymentDescription & "支票："
                Case 4
                    sPaymentDescription = sPaymentDescription & "支票＋保证金："
                Case 5
                    sPaymentDescription = sPaymentDescription & "转账_后付："
                    'modify code 044:start-------------------------------------------------------------------------
                    'Case 8
                    '    sPaymentDescription = sPaymentDescription & "兑换码："
                Case 7
                    sPaymentDescription = sPaymentDescription & "积分兑换："
                Case 8
                    sPaymentDescription = sPaymentDescription & dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString & "："
                Case 11
                    sPaymentDescription = sPaymentDescription & dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString & "："
                    'modify code 044:end-------------------------------------------------------------------------
                Case Else
                    sPaymentDescription = sPaymentDescription & "支票_后付："
            End Select
            sPaymentDescription = sPaymentDescription & Format(drRowPayment("DistributedAMT"), "#,0.00").Replace(".00", "") & " 元；"
        Next
        If sPaymentDescription = "" Then
            sPaymentDescription = "请分配付款金额……"
        Else
            sPaymentDescription = sPaymentDescription.Substring(0, sPaymentDescription.Length - 1) & "。"
        End If
        Return sPaymentDescription
    End Function

    Private Function GetRowPaymentPicLocation() As Point
        Dim theBound As Rectangle = Me.dgvNormalCard.GetCellDisplayRectangle(Me.dgvNormalCard.CurrentCell.ColumnIndex, Me.dgvNormalCard.CurrentCell.RowIndex, True)
        If theBound.Height < 24 Then
            Return New Point(-100, -100)
        Else
            Dim thePoint As Point = Me.dgvNormalCard.GetCellDisplayRectangle(Me.dgvNormalCard.CurrentCell.ColumnIndex, Me.dgvNormalCard.CurrentCell.RowIndex, False).Location, theParent As Control = Me.dgvNormalCard.Parent
            thePoint.Offset(Me.dgvNormalCard.Columns("PaymentDescription").Width - 24, 0)
            If thePoint.X + 24 > Me.dgvNormalCard.Width Then thePoint = New Point(Me.dgvNormalCard.Width - 24, thePoint.Y)
            Do While theParent IsNot Nothing AndAlso theParent.Name <> "frmSelling"
                thePoint.Offset(theParent.Left, theParent.Top)
                theParent = theParent.Parent
            Loop

            Return thePoint
        End If
    End Function

    Private Sub ShowRowPaymentGrid()
        blSkipDeal = True
        Dim dmRowPaymentAMT As Decimal = 0, dmRowAvailableAMT As Decimal = 0, dmRowDistributedAMT As Decimal = 0
        For Each drPayment As DataRow In dtSelectablePayment.Rows
            dmRowPaymentAMT = dtPayment.Select("RowID=" & drPayment("RowID").ToString)(0)("PaymentAMT")
            Try
                dmRowAvailableAMT = dmRowPaymentAMT - dtRowPayment.Compute("Sum(DistributedAMT)", "PaymentRowID=" & drPayment("RowID").ToString)
            Catch
                dmRowAvailableAMT = dmRowPaymentAMT
            End Try
            Try
                dmRowDistributedAMT = dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", Me.dgvNormalCard.CurrentCell.RowIndex).Value.ToString & " And PaymentRowID=" & drPayment("RowID").ToString)(0)("DistributedAMT")
            Catch
                dmRowDistributedAMT = 0
            End Try
            dmRowAvailableAMT += dmRowDistributedAMT
            drPayment("Selected") = (dmRowDistributedAMT > 0)
            drPayment("AvailableAMT") = dmRowAvailableAMT
            drPayment("DistributedAMT") = dmRowDistributedAMT
        Next
        dtSelectablePayment.AcceptChanges()
        Dim iPanelWidth As Integer = 3, iPanelHeight As Integer = (dtSelectablePayment.Rows.Count + 1) * 24 + 2
        Me.dgvSelectablePayment.Columns("AvailableAMT").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
        Me.dgvSelectablePayment.Columns("AvailableAMT").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
        Me.dgvSelectablePayment.Columns("DistributedAMT").Width = Me.dgvSelectablePayment.Columns("AvailableAMT").Width
        For Each column As DataGridViewColumn In Me.dgvSelectablePayment.Columns
            iPanelWidth += column.Width
        Next
        If Me.pcbSelectablPayment.Top + Me.pcbSelectablPayment.Height + iPanelHeight > Me.Height Then
            iPanelHeight = Int((Me.Height - Me.pcbSelectablPayment.Top - Me.pcbSelectablPayment.Height - 2) / 24) * 24 + 2
        End If
        Me.pnlSelectablePayment.Size = New Size(iPanelWidth, iPanelHeight)
        Me.pnlSelectablePayment.Location = New Point(Me.pcbSelectablPayment.Left + Me.pcbSelectablPayment.Width - iPanelWidth + 1, Me.pcbSelectablPayment.Top + Me.pcbSelectablPayment.Height)
        Me.pcbSelectablPayment.Image = My.Resources.PaymentUp
        Me.pnlSelectablePayment.Visible = True
        Me.dgvSelectablePayment.Select()
        For Each drPayment As DataGridViewRow In Me.dgvSelectablePayment.Rows
            If drPayment.Cells("Selected").Value Then
                drPayment.Cells("DistributedAMT").ReadOnly = False
                drPayment.Cells("DistributedAMT").Selected = True
            Else
                drPayment.Cells("DistributedAMT").ReadOnly = True
            End If
        Next
        blSkipDeal = False
    End Sub

    Private Sub GetNewestCityRule(ByVal sNewestCityID As String)
        Me.Cursor = Cursors.WaitCursor
        frmMain.statusText.Text = "正在检索城市返点规则……"
        frmMain.statusMain.Refresh()

        sNewestCityRuleID = "" : drSalesBill("CityRuleID") = DBNull.Value
        Dim DB As New DataBase
        DB.Open()
        If DB.IsConnected Then
            Try
                'modify code 054:start-------------------------------------------------------------------------
                'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where CityID=" & sNewestCityID & " And RuleState=2")
                Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sNewestCityID & " And RuleState=2")
                'modify code 054:end-------------------------------------------------------------------------
                If dtCityRule.Rows.Count = 0 Then
                    drNewestCityRule = Nothing
                    If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                    frmMain.statusText.Text = "未发现当前门店所在城市的返点规则！"
                    sNewestCityRuleID = "-1"
                Else
                    drNewestCityRule = dtCityRule.Copy.Rows(0)
                    sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                    'modify code 054:start-------------------------------------------------------------------------
                    'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).DefaultView.Table
                    dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).DefaultView.Table
                    'modify code 054:end-------------------------------------------------------------------------
                    For Each drDetail As DataRow In dtNewestRuleDetails.Rows
                        drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                    Next
                    drSalesBill("CityRuleID") = sNewestCityRuleID
                    frmMain.statusText.Text = "就绪。"
                End If
                dtCityRule.Dispose() : dtCityRule = Nothing
            Catch
                drNewestCityRule = Nothing
                If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
                frmMain.statusText.Text = "系统因在检索数据时出错而无法检索门店所在城市的返点规则。请联系软件开发人员。"
            End Try
        Else
            drNewestCityRule = Nothing
            If dtNewestRuleDetails IsNot Nothing Then dtNewestRuleDetails.Dispose() : dtNewestRuleDetails = Nothing
            frmMain.statusText.Text = "系统因连接不到数据库而无法检索城市返点规则。请检查数据库连接。"
        End If
        DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default
    End Sub

    Private Sub GetCityRule()
        If drNewestCityRule IsNot Nothing AndAlso sCityRuleID = sNewestCityRuleID Then
            drCityRule = drNewestCityRule.Table.Copy.Rows(0)
            dtRuleDetails = dtNewestRuleDetails.Copy
        Else
            Me.Cursor = Cursors.WaitCursor
            frmMain.statusText.Text = "正在打开城市返点规则……"
            frmMain.statusMain.Refresh()
            Dim DB As New DataBase
            DB.Open()
            If DB.IsConnected Then
                Try
                    'modify code 054:start-------------------------------------------------------------------------
                    'Dim dtCityRule As DataTable = DB.GetDataTable("Select * From CityRule Where RuleID=" & sCityRuleID)
                    Dim dtCityRule As DataTable = DB.GetDataTable("Select * From " & sCityRule & " Where RuleID=" & sCityRuleID)
                    'modify code 054:end-------------------------------------------------------------------------
                    If dtCityRule.Rows.Count = 0 Then
                        drCityRule = Nothing
                        If dtRuleDetails IsNot Nothing Then dtRuleDetails.Dispose() : dtRuleDetails = Nothing
                        MessageBox.Show("原来的城市返点规则已不复存在！    ", "城市返点规则不存在！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.btnViewCityRule.Enabled = False
                        frmMain.statusText.Text = "原来的城市返点规则已不复存在！"
                    Else
                        drCityRule = dtCityRule.Copy.Rows(0)
                        'modify code 054:start-------------------------------------------------------------------------
                        'dtRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sCityRuleID).DefaultView.Table
                        dtRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sCityRuleID).DefaultView.Table
                        'modify code 054:end-------------------------------------------------------------------------
                        For Each drDetail As DataRow In dtRuleDetails.Rows
                            drDetail("RoleFullName") = drDetail("RoleFullName").ToString.Substring(3) : drDetail.AcceptChanges()
                        Next
                        frmMain.statusText.Text = "就绪。"
                    End If
                    dtCityRule.Dispose() : dtCityRule = Nothing
                Catch
                    frmMain.statusText.Text = "系统因在检索数据时出错而无法打开门店所在城市的返点规则。请联系软件开发人员。"
                End Try
            Else
                frmMain.statusText.Text = "系统因连接不到数据库而无法打开城市返点规则。请检查数据库连接。"
            End If
            DB.Close() : Me.Activate() : Me.Cursor = Cursors.Default
        End If
    End Sub

    Private Sub InitBalanceContractInfo()
        drSalesBill("CardCost") = 0
        drSalesBill("PayableAMT") = 0
        drSalesBill("ReceivedAMT") = 0
        drSalesBill("CardQTY") = 0
        drSalesBill("NormalCardQTY") = 0
        drSalesBill("NormalSalesAMT") = 0
        drSalesBill("RebateMode") = 3
        drSalesBill("RebateRuleID") = sBalanceContractID
        drSalesBill("RebateRate") = 1
        drSalesBill("RebateState") = 2
        drSalesBill("AddToContract") = 0
        drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
        drSalesBill("ContractRebateHistorySalesAMTTip") = DBNull.Value

        Me.flpBalanceContract.Visible = True
        Me.pnlPreviousDistribution.Visible = True
        Me.txbPreviousDistribution.ForeColor = SystemColors.ControlText
        Me.txbPreviousDistribution.Font = New Font(Me.txbPreviousDistribution.Font, FontStyle.Regular)
        Me.theTip.SetToolTip(Me.txbPreviousDistribution, "")
        Me.txbPreviousDistribution.Text = "0.00"
        Me.pnlPreviousBalance.Visible = False
        Me.flpBalanceContract.AutoSize = False
        Me.flpBalanceContract.AutoSize = True
        Me.grbBalanceContract.Height = Me.flpBalanceContract.Height + 110

        dmNormalSalesAMT = 0 : dmRebateSalesAMT = 0 : dmAvailableRebateAMT = drSalesBill("BalanceContractBalanceRebateAMT") : dmPayableAMT = 0 : dmReceivedAMT = 0
        Me.RebateCardSummary()
    End Sub

    Private Sub UpdateBalanceContractInfo()
        Me.txbPreviousDistribution.Text = Format(dmRebateSalesAMT, "#,0.00")
        If dmRebateSalesAMT <= dmAvailableRebateAMT Then
            Me.txbPreviousDistribution.ForeColor = SystemColors.ControlText
            Me.txbPreviousDistribution.Font = New Font(Me.txbPreviousDistribution.Font, FontStyle.Regular)
            Me.theTip.SetToolTip(Me.txbPreviousDistribution, "")
        Else
            Me.txbPreviousDistribution.BackColor = SystemColors.Control
            Me.txbPreviousDistribution.ForeColor = Color.Red
            Me.txbPreviousDistribution.Font = New Font(Me.txbPreviousDistribution.Font, FontStyle.Bold)
            Me.theTip.SetToolTip(Me.txbPreviousDistribution, "已分配的返点金额超过上期合同的剩余返点金额： " & Format(dmAvailableRebateAMT, "#,0.00").Replace(".00", "") & " 元！")
        End If

        If dmRebateSalesAMT < dmAvailableRebateAMT Then
            Me.pnlPreviousBalance.Visible = True
            Me.txbPreviousBalance.Text = Format(dmAvailableRebateAMT - dmRebateSalesAMT, "#,0.00")
            Me.theTip.SetToolTip(Me.txbPreviousBalance, "已分配的返点金额未达到上期合同的剩余返点金额： " & Format(dmAvailableRebateAMT, "#,0.00").Replace(".00", "") & " 元。" & Chr(13) & "请在右边返点卡列表中" & IIf(dmRebateSalesAMT = 0, "", "继续") & "分配返点卡及其金额。")
        Else
            Me.pnlPreviousBalance.Visible = False
        End If

        Dim iOldHeight As Integer = Me.grbBalanceContract.Height
        Me.flpBalanceContract.AutoSize = False
        Me.flpBalanceContract.AutoSize = True
        Dim iNewHeight As Integer = Me.flpBalanceContract.Height + 110
        If iOldHeight <> iNewHeight Then
            Me.grbBalanceContract.Height = iNewHeight
            Me.ResetInterfaceLayout()
        End If
    End Sub

    Private Sub InitContractInfo()
        drSalesBill("RebateMode") = 2
        drSalesBill("RebateRuleID") = sContractID
        drSalesBill("RebateRate") = 0
        drSalesBill("RebateState") = 2
        drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
        drSalesBill("ContractRebateHistorySalesAMTTip") = DBNull.Value
        iFirstAvailableRowID = -1 : iSecondAvailableRowID = -1
        Dim drLevel As DataRow = Nothing, dmHistoryRebateRate As Decimal = 0, dmHistorySalesAMT As Decimal = drContract("HistorySalesAMT"), dmHistoryRebateAMT As Decimal = 0

        drSalesBill("ContractRebateThisRebateRemarks") = DBNull.Value
        drSalesBill("ContractRebateHistorySalesAMT") = dmHistorySalesAMT
        drSalesBill("ContractRebateHistoryPaidRebateAMT") = drContract("HistoryTodayPaidRebateAMT")

        Me.txbThisSalesAMT.Text = "0.00"
        'modify code 038:start-------------------------------------------------------------------------
        'Me.txbThisRebateRate.Text = "0.0"
        Me.txbThisRebateRate.Text = "0.00"
        'modify code 038:end-------------------------------------------------------------------------
        Me.txbThisRebateAMT.Text = "0.00"
        Me.pnlThisPurchaseRemarks.Visible = False
        Me.pnlThisPurchaseRebate.Height = 119 - Me.pnlThisPurchaseRemarks.Height

        Me.txbAvailableRebateSalesAMT.Text = "0.00"
        If drContract("PaymentMode") = 0 Then '赠送返点
            Me.lblThisPurchaseRebate.Text = "本次购买返点计算："
            Me.lblThisSalesAMT.Text = "购买："
            Me.theTip.SetToolTip(Me.lblThisSalesAMT, "本次购买金额")
            Me.lblThisRebateRate.Text = "比率："
            If drContract("CalculationDay") = 255 Then
                If drContract("CalculationMode") = 0 Then '按总金额计算
                    Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次购买与历史购买之和达到的最终返点比率")
                Else '分段计算
                    Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次购买与历史购买之和达到的最大返点比率")
                End If
            Else
                Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次购买达到的最终返点比率")
            End If
            Me.lblThisRebateAMT.Text = "金额："
            Me.theTip.SetToolTip(Me.lblThisRebateAMT, "本次购买产生的返点金额")

            For Each drLevel In dtContractDetails.Rows
                If drLevel("EndSalesAMT").ToString <> "" AndAlso (dmHistorySalesAMT = 0 OrElse (dmHistorySalesAMT > drLevel("StartSalesAMT") AndAlso dmHistorySalesAMT <= drLevel("EndSalesAMT"))) Then
                    Exit For
                End If
            Next

            dmHistoryRebateRate = drLevel("RebateRate")
            If drContract("CalculationMode") = 0 Then '按总金额计算
                dmHistoryRebateAMT = Int(dmHistorySalesAMT * dmHistoryRebateRate * 100) / 100
            Else '分段计算
                Dim dmCalculatedSaleAMT = dmHistorySalesAMT
                For Each dr As DataRow In dtContractDetails.Rows
                    If dr("EndSalesAMT").ToString = "" OrElse dmHistorySalesAMT <= dr("EndSalesAMT") Then
                        dmHistoryRebateAMT = dmHistoryRebateAMT + dmCalculatedSaleAMT * dr("RebateRate")
                        Exit For
                    Else
                        dmHistoryRebateAMT = dmHistoryRebateAMT + (dr("EndSalesAMT") - dr("StartSalesAMT")) * dr("RebateRate")
                        dmCalculatedSaleAMT = dmCalculatedSaleAMT - (dr("EndSalesAMT") - dr("StartSalesAMT"))
                    End If
                Next
                dmHistoryRebateAMT = Int(dmHistoryRebateAMT * 100) / 100
            End If
            drSalesBill("ContractRebateHistorySalesAMTTip") = "历史购买金额总计（仅包含" & IIf(drContract("MonthDate").ToString = "", "", "截止至""" & drContract("MonthDate").ToString & """的") & "已确认到账的历史购买金额）"
            drSalesBill("ContractRebateHistoryRebateRate") = dmHistoryRebateRate
            drSalesBill("ContractRebateHistoryRebateAMT") = dmHistoryRebateAMT
            drSalesBill("ContractRebateHistoryRebateRemarks") = DBNull.Value
            If dmHistoryRebateAMT - drContract("HistoryTodayPaidRebateAMT") > 0 Then
                If drContract("CalculationDay") = 0 AndAlso drContract("EndDate") >= drContract("Today") Then
                    drSalesBill("ContractRebateHistoryRebateRemarks") = "合同未到期，不可兑现。"
                ElseIf drContract("MinContractAMT").ToString <> "" AndAlso dmHistorySalesAMT < drContract("MinContractAMT") Then
                    drSalesBill("ContractRebateHistoryRebateRemarks") = "未达到合同的最小总金额。"
                End If
            End If

            Me.lblHistoryPurchaseRebate.Text = "历史购买返点计算："
            Me.lblHistorySalesAMT.Text = "购买： " : Me.txbHistorySalesAMT.Text = Format(dmHistorySalesAMT, "#,0.00") : Me.theTip.SetToolTip(Me.lblHistorySalesAMT, drSalesBill("ContractRebateHistorySalesAMTTip").ToString)
            'modify code 038:start-------------------------------------------------------------------------
            'Me.lblHistoryRebateRate.Text = "比率： " : Me.txbHistoryRebateRate.Text = Format(dmHistoryRebateRate * 100, "#,0.0") : Me.theTip.SetToolTip(Me.lblHistoryRebateRate, IIf(drContract("CalculationMode") = 0, "历史购买达到的最终返点比率", "历史购买达到的最大返点比率"))
            Me.lblHistoryRebateRate.Text = "比率： " : Me.txbHistoryRebateRate.Text = Format(dmHistoryRebateRate * 100, "#,0.00") : Me.theTip.SetToolTip(Me.lblHistoryRebateRate, IIf(drContract("CalculationMode") = 0, "历史购买达到的最终返点比率", "历史购买达到的最大返点比率"))
            'modify code 038:end-------------------------------------------------------------------------
            Me.lblHistoryRebateAMT.Text = "金额： " : Me.txbHistoryRebateAMT.Text = Format(dmHistoryRebateAMT, "#,0.00") : Me.theTip.SetToolTip(Me.lblHistoryRebateAMT, "历史购买产生的返点金额")
            Me.lblHistoryPaidRebateAMT.Text = "已兑： " : Me.txbHistoryPaidRebateAMT.Text = Format(drContract("HistoryTodayPaidRebateAMT"), "#,0.00") : Me.theTip.SetToolTip(Me.lblHistoryPaidRebateAMT, "历史已经兑现的返点金额总计")
            If drSalesBill("ContractRebateHistoryRebateRemarks").ToString = "" Then
                Me.pnlHistoryPurchaseRemarks.Visible = False
                Me.pnlHistoryPurchaseRebate.Height = 146 - Me.pnlHistoryPurchaseRemarks.Height
            Else
                Me.lblHistoryPurchaseRemarks.Text = drSalesBill("ContractRebateHistoryRebateRemarks").ToString
                Me.pnlHistoryPurchaseRemarks.Visible = True
                Me.pnlHistoryPurchaseRebate.Height = 146
            End If

            Me.lblAvailableRebateAMT.Text = "本次最大可兑返点金额："
            Me.lblRebateSalesAMT.Text = "本次已分配返点金额："
            Me.lblBalanceRebateAMT.Text = "剩余返点金额："

            Me.pnlDeductionAMT.Visible = False
            Me.splitList.Panel2Collapsed = False
        Else '付款抵扣
            Me.lblThisPurchaseRebate.Text = "本次充值抵扣计算："
            Me.lblThisSalesAMT.Text = "充值："
            Me.theTip.SetToolTip(Me.lblThisSalesAMT, "本次充值金额")
            Me.lblThisRebateRate.Text = "比率："
            If drContract("CalculationMode") = 0 Then '按总金额计算
                Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次充值与历史充值之和达到的最终抵扣比率")
            Else '分段计算
                Me.theTip.SetToolTip(Me.lblThisRebateRate, "本次充值与历史充值之和达到的最大抵扣比率")
            End If
            Me.lblThisRebateAMT.Text = "金额："
            Me.theTip.SetToolTip(Me.lblThisRebateAMT, "本次充值产生的抵扣金额")

            For Each drLevel In dtContractDetails.Rows
                If drLevel("EndSalesAMT").ToString <> "" AndAlso (dmHistorySalesAMT = 0 OrElse (dmHistorySalesAMT > drLevel("StartSalesAMT") AndAlso dmHistorySalesAMT <= drLevel("EndSalesAMT"))) Then
                    Exit For
                End If
            Next

            dmHistoryRebateRate = drLevel("RebateRate")
            If drContract("CalculationMode") = 0 Then '按总金额计算
                dmHistoryRebateAMT = Int(((dmHistorySalesAMT * dmHistoryRebateRate) / (1 + dmHistoryRebateRate)) * 100) / 100
            Else '分段计算
                Dim dmCalculatedSaleAMT = dmHistorySalesAMT
                For Each dr As DataRow In dtContractDetails.Rows
                    If dr("EndSalesAMT").ToString = "" OrElse dmHistorySalesAMT <= dr("EndSalesAMT") Then
                        dmHistoryRebateAMT = dmHistoryRebateAMT + (dmCalculatedSaleAMT * dr("RebateRate")) / (1 + dr("RebateRate"))
                        Exit For
                    Else
                        dmHistoryRebateAMT = dmHistoryRebateAMT + ((dr("EndSalesAMT") - dr("StartSalesAMT")) * dr("RebateRate")) / (1 + dr("RebateRate"))
                        dmCalculatedSaleAMT = dmCalculatedSaleAMT - (dr("EndSalesAMT") - dr("StartSalesAMT"))
                    End If
                Next
                dmHistoryRebateAMT = Int(dmHistoryRebateAMT * 100) / 100
            End If

            drSalesBill("ContractRebateHistorySalesAMTTip") = "历史充值金额总计（仅包含已确认到账的历史充值金额）"
            drSalesBill("ContractRebateHistoryRebateRate") = dmHistoryRebateRate
            drSalesBill("ContractRebateHistoryRebateAMT") = dmHistoryRebateAMT
            If drContract("MinContractAMT").ToString <> "" AndAlso dmHistorySalesAMT < drContract("MinContractAMT") AndAlso dmHistorySalesAMT > 0 Then
                drSalesBill("ContractRebateHistoryRebateRemarks") = "未达到合同的最小总金额。"
            Else
                drSalesBill("ContractRebateHistoryRebateRemarks") = DBNull.Value
            End If

            Me.lblHistoryPurchaseRebate.Text = "历史充值抵扣计算："
            Me.lblHistorySalesAMT.Text = "充值： " : Me.txbHistorySalesAMT.Text = Format(dmHistorySalesAMT, "#,0.00") : Me.theTip.SetToolTip(Me.lblHistorySalesAMT, drSalesBill("ContractRebateHistorySalesAMTTip").ToString)
            'modify code 038:start-------------------------------------------------------------------------
            'Me.lblHistoryRebateRate.Text = "比率： " : Me.txbHistoryRebateRate.Text = Format(dmHistoryRebateRate * 100, "#,0.0") : Me.theTip.SetToolTip(Me.lblHistoryRebateRate, "历史充值达到的最终抵扣比率")
            Me.lblHistoryRebateRate.Text = "比率： " : Me.txbHistoryRebateRate.Text = Format(dmHistoryRebateRate * 100, "#,0.00") : Me.theTip.SetToolTip(Me.lblHistoryRebateRate, "历史充值达到的最终抵扣比率")
            'modify code 038:end-------------------------------------------------------------------------
            Me.lblHistoryRebateAMT.Text = "金额： " : Me.txbHistoryRebateAMT.Text = Format(dmHistoryRebateAMT, "#,0.00") : Me.theTip.SetToolTip(Me.lblHistoryRebateAMT, "历史充值产生的抵扣金额")
            Me.lblHistoryPaidRebateAMT.Text = "已抵： " : Me.txbHistoryPaidRebateAMT.Text = Format(drContract("HistoryTodayPaidRebateAMT"), "#,0.00") : Me.theTip.SetToolTip(Me.lblHistoryPaidRebateAMT, "历史已经抵扣的付款金额总计")
            Me.pnlHistoryPurchaseRemarks.Visible = False
            Me.pnlHistoryPurchaseRebate.Height = 146 - Me.pnlHistoryPurchaseRemarks.Height
            If drSalesBill("ContractRebateHistoryRebateRemarks").ToString = "" Then
                Me.pnlHistoryPurchaseRemarks.Visible = False
                Me.pnlHistoryPurchaseRebate.Height = 146 - Me.pnlHistoryPurchaseRemarks.Height
            Else
                Me.lblHistoryPurchaseRemarks.Text = drSalesBill("ContractRebateHistoryRebateRemarks").ToString
                Me.pnlHistoryPurchaseRemarks.Visible = True
                Me.pnlHistoryPurchaseRebate.Height = 146
            End If

            Me.lblAvailableRebateAMT.Text = "本次可抵扣付款金额："
            Me.lblRebateSalesAMT.Text = "本次已抵扣付款金额："
            Me.lblBalanceRebateAMT.Text = "未抵扣付款金额："

            Me.pnlDeductionAMT.Visible = True
            Me.splitList.Panel2Collapsed = True
            Me.grbPrintDiscount.Visible = False
        End If

        Me.pnlRebatSalesAMT.Visible = False
        Me.pnlBalanceRebateAMT.Visible = False

        Me.flpContract.AutoSize = False
        Me.flpContract.AutoSize = True
        Me.grbContract.Height = Me.flpContract.Height + 83
        Me.ResetInterfaceLayout()

        Try
            dmMinFaceValue = drContract("MinFaceValue") : dmMaxFaceValue = drContract("MaxFaceValue")
        Catch
            dmMinFaceValue = 0 : dmMaxFaceValue = 1000
        End Try
        If blUsedOldCard Then dmMinFaceValue = 0

        If dmHistorySalesAMT > 0 Then iSecondAvailableRowID = drLevel("LevelID") - 1
        drLevel = Nothing
        dmAvailableRebateAMT = 0 : dmRebateSalesAMT = 0
        blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
        Me.NormalCardSummary()
    End Sub

    Private Sub UpdateContractInfo()
        drSalesBill("ContractRebateThisRebateRemarks") = DBNull.Value
        drSalesBill("AddToContract") = 0
        blThisRebateAvailable = False
        Dim dmTotalSalesAMT As Decimal = drContract("HistorySalesAMT") + dmNormalSalesAMT, dmRebateAMTFromHistory As Decimal = 0
        If drContract("MinAMTPerPurchase").ToString <> "" AndAlso dmNormalSalesAMT < drContract("MinAMTPerPurchase") AndAlso dmNormalSalesAMT > 0 Then
            drSalesBill("ContractRebateThisRebateRemarks") = "未达到单次最低购买金额。"
        ElseIf dmNormalSalesAMT > 0 Then
            drSalesBill("AddToContract") = 1 : blThisRebateAvailable = True
        End If

        If drContract("MinContractAMT").ToString <> "" AndAlso dmTotalSalesAMT < drContract("MinContractAMT") AndAlso dmNormalSalesAMT > 0 Then
            If drSalesBill("ContractRebateThisRebateRemarks").ToString = "" Then
                drSalesBill("ContractRebateThisRebateRemarks") = "未达到合同的最小总金额。"
                blThisRebateAvailable = False
            End If
        ElseIf drContract("MaxContractAMT").ToString <> "" AndAlso dmTotalSalesAMT > drContract("MaxContractAMT") Then
            dmTotalSalesAMT = drContract("MaxContractAMT")
            If drSalesBill("ContractRebateThisRebateRemarks").ToString = "" Then drSalesBill("ContractRebateThisRebateRemarks") = "已达到合同的最大总金额。"
            If drContract("HistorySalesAMT") >= drContract("MaxContractAMT") Then
                drSalesBill("AddToContract") = 0
                blThisRebateAvailable = False
            End If
        End If

        drSalesBill("ContractRebateThisSalesAMT") = dmNormalSalesAMT : Me.txbThisSalesAMT.Text = Format(dmNormalSalesAMT, "#,0.00")

        Dim drLevel As DataRow = Nothing
        If drContract("PaymentMode") = 0 Then '赠送返点
            If drContract("CalculationDay") = 255 Then
                For Each drLevel In dtContractDetails.Rows
                    If drLevel("EndSalesAMT").ToString <> "" AndAlso (dmTotalSalesAMT = 0 OrElse (dmTotalSalesAMT > drLevel("StartSalesAMT") AndAlso dmTotalSalesAMT <= drLevel("EndSalesAMT"))) Then
                        Exit For
                    End If
                Next
                iFirstAvailableRowID = IIf(dmTotalSalesAMT = 0, -1, drLevel("LevelID") - 1)
                iSecondAvailableRowID = -1
                'modify code 038:start-------------------------------------------------------------------------
                'drSalesBill("ContractRebateThisRebateRate") = drLevel("RebateRate") : Me.txbThisRebateRate.Text = Format(drLevel("RebateRate") * 100, "#,0.0")
                drSalesBill("ContractRebateThisRebateRate") = drLevel("RebateRate") : Me.txbThisRebateRate.Text = Format(drLevel("RebateRate") * 100, "#,0.00")
                'modify code 038:end-------------------------------------------------------------------------
                If drContract("CalculationMode") = 0 Then '按总金额计算
                    If drSalesBill("ContractRebateHistorySalesAMT") > 0 AndAlso drSalesBill("ContractRebateHistoryRebateRate") <> drSalesBill("ContractRebateThisRebateRate") Then
                        drSalesBill("ContractRebateHistoryRebateRate") = drSalesBill("ContractRebateThisRebateRate")
                        'modify code 038:start-------------------------------------------------------------------------
                        'Me.txbHistoryRebateRate.Text = Format(drSalesBill("ContractRebateHistoryRebateRate") * 100, "#,0.0")
                        Me.txbHistoryRebateRate.Text = Format(drSalesBill("ContractRebateHistoryRebateRate") * 100, "#,0.00")
                        'modify code 038:end-------------------------------------------------------------------------
                        drSalesBill("ContractRebateHistoryRebateAMT") = Int(drSalesBill("ContractRebateHistorySalesAMT") * drSalesBill("ContractRebateHistoryRebateRate") * 100) / 100
                        Me.txbHistoryRebateAMT.Text = Format(drSalesBill("ContractRebateHistoryRebateAMT"), "#,0.00")
                    End If
                    drSalesBill("ContractRebateThisRebateAMT") = Int(((dmTotalSalesAMT * drLevel("RebateRate")) - drSalesBill("ContractRebateHistoryRebateAMT")) * 100) / 100
                Else '分段计算
                    Dim dmCalculatedSaleAMT = dmTotalSalesAMT, dmHistoryRebateAMT As Decimal = 0
                    For Each dr As DataRow In dtContractDetails.Rows
                        If dr("EndSalesAMT").ToString = "" OrElse dmTotalSalesAMT <= dr("EndSalesAMT") Then
                            dmHistoryRebateAMT = dmHistoryRebateAMT + dmCalculatedSaleAMT * dr("RebateRate")
                            Exit For
                        Else
                            dmHistoryRebateAMT = dmHistoryRebateAMT + (dr("EndSalesAMT") - dr("StartSalesAMT")) * dr("RebateRate")
                            dmCalculatedSaleAMT = dmCalculatedSaleAMT - (dr("EndSalesAMT") - dr("StartSalesAMT"))
                        End If
                    Next
                    dmHistoryRebateAMT = Int(dmHistoryRebateAMT * 100) / 100
                    drSalesBill("ContractRebateThisRebateAMT") = dmHistoryRebateAMT - drSalesBill("ContractRebateHistoryRebateAMT")
                End If
                Me.txbThisRebateAMT.Text = Format(drSalesBill("ContractRebateThisRebateAMT"), "#,0.00")
            Else '每月一结或合同期满后兑现时，按当次购买金额计算返点，不与历史购买加在一起计算
                For Each drLevel In dtContractDetails.Rows
                    If drLevel("EndSalesAMT").ToString <> "" AndAlso (dmNormalSalesAMT = 0 OrElse (dmNormalSalesAMT > drLevel("StartSalesAMT") AndAlso dmNormalSalesAMT <= drLevel("EndSalesAMT"))) Then
                        Exit For
                    End If
                Next
                iFirstAvailableRowID = IIf(dmNormalSalesAMT = 0, -1, drLevel("LevelID") - 1)
                'modify code 038:start-------------------------------------------------------------------------
                'drSalesBill("ContractRebateThisRebateRate") = drLevel("RebateRate") : Me.txbThisRebateRate.Text = Format(drLevel("RebateRate") * 100, "#,0.0")
                drSalesBill("ContractRebateThisRebateRate") = drLevel("RebateRate") : Me.txbThisRebateRate.Text = Format(drLevel("RebateRate") * 100, "#,0.00")
                'modify code 038:end-------------------------------------------------------------------------
                drSalesBill("ContractRebateThisRebateAMT") = Int(dmNormalSalesAMT * drLevel("RebateRate") * 100) / 100 : Me.txbThisRebateAMT.Text = Format(drSalesBill("ContractRebateThisRebateAMT"), "#,0.00")
            End If

            If drSalesBill("ContractRebateThisRebateRemarks").ToString = "" Then
                Me.pnlThisPurchaseRemarks.Visible = False
                Me.pnlThisPurchaseRebate.Height = 119 - Me.pnlThisPurchaseRemarks.Height
            Else
                Me.lblThisPurchaseRemarks.Text = drSalesBill("ContractRebateThisRebateRemarks").ToString
                Me.pnlThisPurchaseRemarks.Visible = True
                Me.pnlThisPurchaseRebate.Height = 119
            End If

            dmRebateAMTFromHistory = IIf(drSalesBill("ContractRebateHistoryRebateRemarks").ToString = "", drSalesBill("ContractRebateHistoryRebateAMT") - drSalesBill("ContractRebateHistoryPaidRebateAMT"), 0)
            dmAvailableRebateAMT = IIf(blThisRebateAvailable, drSalesBill("ContractRebateThisRebateAMT"), 0) + dmRebateAMTFromHistory
            drSalesBill("ContractRebateAvailableRebateAMT") = dmAvailableRebateAMT
            Me.txbAvailableRebateSalesAMT.Text = Format(dmAvailableRebateAMT, "#,0.00")

            If (dmAvailableRebateAMT > 0 OrElse dtRebateCard.Rows(0)("StartCardNo").ToString <> "") Then
                Me.pnlRebatSalesAMT.Visible = True
                If Me.splitList.Panel2Collapsed Then
                    Me.splitList.Panel2Collapsed = False
                    If Me.dgvRebateCard.CurrentCell IsNot Nothing Then
                        Dim blOldSkipDeal As Boolean = blSkipDeal
                        blSkipDeal = True
                        Me.dgvRebateCard.CurrentCell.Selected = False
                        Me.dgvRebateCard.CurrentRow.Selected = False
                        blSkipDeal = blOldSkipDeal
                    End If
                    Me.ResetCardListLayout()
                End If

                Me.txbRebateSalesAMT.Text = Format(dmRebateSalesAMT, "#,0.00")
                If dmRebateSalesAMT <= dmAvailableRebateAMT Then
                    Me.txbRebateSalesAMT.ForeColor = SystemColors.ControlText
                    Me.txbRebateSalesAMT.Font = New Font(Me.txbRebateSalesAMT.Font, FontStyle.Regular)
                    Me.theTip.SetToolTip(Me.txbRebateSalesAMT, "")
                Else
                    Me.txbRebateSalesAMT.BackColor = SystemColors.Control
                    Me.txbRebateSalesAMT.ForeColor = Color.Red
                    Me.txbRebateSalesAMT.Font = New Font(Me.txbRebateSalesAMT.Font, FontStyle.Bold)
                    Me.theTip.SetToolTip(Me.txbRebateSalesAMT, "已分配的返点金额超过本次最大可兑返点金额： " & Format(dmAvailableRebateAMT, "#,0.00").Replace(".00", "") & " 元！")
                End If

                If dmRebateSalesAMT < dmAvailableRebateAMT Then
                    Me.pnlBalanceRebateAMT.Visible = True
                    Me.txbBalanceRebateAMT.Text = Format(dmAvailableRebateAMT - dmRebateSalesAMT, "#,0.00")
                    Me.theTip.SetToolTip(Me.txbBalanceRebateAMT, "已分配的返点金额未达到本次最大可兑返点金额： " & Format(dmAvailableRebateAMT, "#,0.00").Replace(".00", "") & " 元。" & Chr(13) & "请在右边返点卡列表中" & IIf(dmRebateSalesAMT = 0, "", "继续") & "分配返点卡及其金额。")
                Else
                    Me.pnlBalanceRebateAMT.Visible = False
                End If
            Else
                Me.pnlRebatSalesAMT.Visible = False
                Me.pnlBalanceRebateAMT.Visible = False
            End If
        Else '付款抵扣
            For Each drLevel In dtContractDetails.Rows
                If drLevel("EndSalesAMT").ToString <> "" AndAlso (dmTotalSalesAMT = 0 OrElse (dmTotalSalesAMT > drLevel("StartSalesAMT") AndAlso dmTotalSalesAMT <= drLevel("EndSalesAMT"))) Then
                    Exit For
                End If
            Next
            iFirstAvailableRowID = IIf(dmTotalSalesAMT = 0, -1, drLevel("LevelID") - 1)
            iSecondAvailableRowID = -1
            'modify code 038:start-------------------------------------------------------------------------
            'drSalesBill("ContractRebateThisRebateRate") = drLevel("RebateRate") : Me.txbThisRebateRate.Text = Format(drLevel("RebateRate") * 100, "#,0.0")
            drSalesBill("ContractRebateThisRebateRate") = drLevel("RebateRate") : Me.txbThisRebateRate.Text = Format(drLevel("RebateRate") * 100, "#,0.00")
            'modify code 038:end-------------------------------------------------------------------------

            If drContract("CalculationMode") = 0 Then '按总金额计算
                If drSalesBill("ContractRebateHistorySalesAMT") > 0 AndAlso drSalesBill("ContractRebateHistoryRebateRate") <> drSalesBill("ContractRebateThisRebateRate") Then
                    drSalesBill("ContractRebateHistoryRebateRate") = drSalesBill("ContractRebateThisRebateRate")
                    'modify code 038:start-------------------------------------------------------------------------
                    'Me.txbHistoryRebateRate.Text = Format(drSalesBill("ContractRebateHistoryRebateRate") * 100, "#,0.0")
                    Me.txbHistoryRebateRate.Text = Format(drSalesBill("ContractRebateHistoryRebateRate") * 100, "#,0.00")
                    'modify code 038:end-------------------------------------------------------------------------
                    drSalesBill("ContractRebateHistoryRebateAMT") = Int(((drSalesBill("ContractRebateHistorySalesAMT") * drSalesBill("ContractRebateHistoryRebateRate")) / (1 + drSalesBill("ContractRebateHistoryRebateRate"))) * 100) / 100
                    Me.txbHistoryRebateAMT.Text = Format(drSalesBill("ContractRebateHistoryRebateAMT"), "#,0.00")
                End If
                drSalesBill("ContractRebateThisRebateAMT") = Int((((dmTotalSalesAMT * drLevel("RebateRate")) / (1 + drLevel("RebateRate"))) - drSalesBill("ContractRebateHistoryRebateAMT")) * 100) / 100
            Else '分段计算
                Dim dmCalculatedSaleAMT = dmTotalSalesAMT, dmHistoryRebateAMT As Decimal = 0
                For Each dr As DataRow In dtContractDetails.Rows
                    If dr("EndSalesAMT").ToString = "" OrElse dmTotalSalesAMT <= dr("EndSalesAMT") Then
                        dmHistoryRebateAMT = dmHistoryRebateAMT + (dmCalculatedSaleAMT * dr("RebateRate")) / (1 + dr("RebateRate"))
                        Exit For
                    Else
                        dmHistoryRebateAMT = dmHistoryRebateAMT + ((dr("EndSalesAMT") - dr("StartSalesAMT")) * dr("RebateRate")) / (1 + dr("RebateRate"))
                        dmCalculatedSaleAMT = dmCalculatedSaleAMT - (dr("EndSalesAMT") - dr("StartSalesAMT"))
                    End If
                Next
                dmHistoryRebateAMT = Int(dmHistoryRebateAMT * 100) / 100
                drSalesBill("ContractRebateThisRebateAMT") = dmHistoryRebateAMT - drSalesBill("ContractRebateHistoryRebateAMT")
            End If
            Me.txbThisRebateAMT.Text = Format(drSalesBill("ContractRebateThisRebateAMT"), "#,0.00")

            If drSalesBill("ContractRebateThisRebateRemarks").ToString = "" Then
                Me.pnlThisPurchaseRemarks.Visible = False
                Me.pnlThisPurchaseRebate.Height = 119 - Me.pnlThisPurchaseRemarks.Height
            Else
                Me.lblThisPurchaseRemarks.Text = drSalesBill("ContractRebateThisRebateRemarks").ToString
                Me.pnlThisPurchaseRemarks.Visible = True
                Me.pnlThisPurchaseRebate.Height = 119
            End If

            dmRebateAMTFromHistory = IIf(drSalesBill("ContractRebateHistoryRebateRemarks").ToString = "", drSalesBill("ContractRebateHistoryRebateAMT") - drSalesBill("ContractRebateHistoryPaidRebateAMT"), 0)
            dmAvailableRebateAMT = IIf(blThisRebateAvailable, drSalesBill("ContractRebateThisRebateAMT"), 0) + dmRebateAMTFromHistory
            drSalesBill("ContractRebateAvailableRebateAMT") = dmAvailableRebateAMT
            Me.txbAvailableRebateSalesAMT.Text = Format(dmAvailableRebateAMT, "#,0.00")

            dmRebateSalesAMT = dmAvailableRebateAMT
            dmPayableAMT = dmNormalSalesAMT
            If dtNormalCard.Compute("Sum(CostAMT)", "").ToString <> "" Then dmPayableAMT = dmPayableAMT + dtNormalCard.Compute("Sum(CostAMT)", "")

            If dmRebateSalesAMT = 0 Then
                Me.pnlRebatSalesAMT.Visible = False
                Me.pnlBalanceRebateAMT.Visible = False
                For Each drCard As DataRow In dtNormalCard.Rows
                    If drCard("FaceValue").ToString <> "" Then
                        drCard("ReducedCardPayment") = 0
                        drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost")
                        If drCard("CardQTY").ToString <> "" Then drCard("PayableAMT") = drCard("CardPayment") * drCard("CardQTY")
                    End If
                Next
                Me.dgvNormalCard.Columns("ReducedCardPayment").Visible = False
                Me.dgvNormalCard.Columns("CardPayment").Visible = False
            Else
                'Me.dgvNormalCard.Columns("ReducedCardPayment").Visible = True
                'Me.dgvNormalCard.Columns("CardPayment").Visible = True

                Dim dmProportion As Decimal = 0
                If dmNormalSalesAMT > 0 Then dmProportion = dmRebateSalesAMT / dmNormalSalesAMT '平均分摊抵扣
                dmPayableAMT = dmPayableAMT - dmRebateSalesAMT
                If dmPayableAMT < 0 Then
                    Me.txbRebateSalesAMT.Text = Format(dmNormalSalesAMT, "#,0.00")
                    Me.pnlBalanceRebateAMT.Visible = True : Me.txbBalanceRebateAMT.Text = Format(-dmPayableAMT, "#,0.00")

                    For Each drCard As DataRow In dtNormalCard.Rows
                        If drCard("FaceValue").ToString <> "" Then
                            drCard("ReducedCardPayment") = drCard("FaceValue") + drCard("CardCost")
                            drCard("CardPayment") = 0
                            drCard("PayableAMT") = 0 '(drCard("FaceValue") + drCard("CardCost")) * drCard("CardQTY") '
                        End If
                    Next
                    dmRebateSalesAMT = dmRebateSalesAMT + dmPayableAMT : dmPayableAMT = 0
                Else
                    Me.pnlBalanceRebateAMT.Visible = False

                    Dim drCard As DataRow = Nothing
                    'modify code 019:start-------------------------------------------------------------------------
                    'For Each drCard In dtNormalCard.Select("Isnull(FaceValue,0)>0", "RowID")
                    '    drCard("ReducedCardPayment") = dmProportion * drCard("FaceValue")
                    '    drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost") - drCard("ReducedCardPayment")
                    '    drCard("PayableAMT") = Int(drCard("CardPayment") * drCard("CardQTY") * 100) / 100 '(drCard("FaceValue") + drCard("CardCost")) * drCard("CardQTY") '
                    'Next
                    'If dtNormalCard.Rows.Count > 2 Then '更新最后一行的应付总计
                    '    drCard("PayableAMT") = dmPayableAMT - dtNormalCard.Compute("Sum(PayableAMT)", "RowID<" & drCard("RowID").ToString)
                    'End If
                    Dim i As Integer, j As Integer = -1, drCardLast As DataRow = Nothing
                    For i = 0 To dtNormalCard.Rows.Count - 1
                        drCard = dtNormalCard.Rows(i)
                        If Not IsDBNull(drCard("FaceValue")) Then
                            drCard("ReducedCardPayment") = dmProportion * drCard("FaceValue")
                            drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost") - drCard("ReducedCardPayment")
                            drCard("PayableAMT") = Int(drCard("CardPayment") * drCard("CardQTY") * 100) / 100 '(drCard("FaceValue") + drCard("CardCost")) * drCard("CardQTY") '
                        End If
                    Next
                    If dtNormalCard.Rows.Count > 2 Then '更新最后一行的应付总计
                        drCardLast = dtNormalCard.Rows(dtNormalCard.Rows.Count - 2)
                        j = dtNormalCard.Rows.Count - 1
                        drCardLast("PayableAMT") = dmPayableAMT - dtNormalCard.Compute("Sum(PayableAMT)", "RowID<" & j.ToString)
                    End If
                    'modify code 019:end-------------------------------------------------------------------------
                End If
                Me.pnlRebatSalesAMT.Visible = True : Me.txbRebateSalesAMT.Text = Me.txbAvailableRebateSalesAMT.Text
            End If
            drSalesBill("PayableAMT") = dmPayableAMT : drSalesBill("RebateSalesAMT") = dmRebateSalesAMT
            If dmNormalSalesAMT = 0 Then
                drSalesBill("RebateRate") = 0
            ElseIf dmNormalSalesAMT - dmRebateSalesAMT = 0 Then
                drSalesBill("RebateRate") = 1
            Else
                'modify code 038:start-------------------------------------------------------------------------
                'drSalesBill("RebateRate") = Int((dmRebateSalesAMT / (dmNormalSalesAMT - dmRebateSalesAMT)) * 1000 + 0.5) / 1000
                drSalesBill("RebateRate") = Int((dmRebateSalesAMT / (dmNormalSalesAMT - dmRebateSalesAMT)) * 10000 + 0.5) / 10000
                'modify code 038:end-------------------------------------------------------------------------
            End If
            Me.lblDeductionAMT.Text = Format(dmRebateSalesAMT, "#,0.00") & " 元"
        End If

        drLevel = Nothing

        Dim iOldHeight As Integer = Me.grbContract.Height
        Me.flpContract.AutoSize = False
        Me.flpContract.AutoSize = True
        Dim iNewHeight As Integer = Me.flpContract.Height + 83
        If iOldHeight <> iNewHeight Then
            Me.grbContract.Height = iNewHeight
            Me.ResetInterfaceLayout()
        End If

        If Me.flpLeftContainer.VerticalScroll.Visible = True Then
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
        End If
    End Sub

    Private Sub InitNormalRebateInfo()
        drSalesBill("RebateMode") = 1 '一般返点
        drSalesBill("RebateRate") = 0
        drSalesBill("RebateRuleID") = sNewestCityRuleID
        drSalesBill("AddToContract") = 0

        Me.txbNormalRebateRate.ForeColor = SystemColors.ControlText
        Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Regular)
        Me.txbNormalRebateAMT.ForeColor = SystemColors.ControlText
        Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Regular)
        Me.pnlNormalRebateState.Visible = False
        Me.pnlNormalRebateRemarks.Visible = False
        Me.theTip.SetToolTip(Me.txbDistributionNormalRebateAMT, "")
        Me.pnlBalanceNormalRebateAMT.Visible = False

        Me.flpNormalRebate.AutoSize = False
        Me.flpNormalRebate.AutoSize = True
        Me.grbNormalRebate.Height = Me.flpNormalRebate.Height + 55

        dmMaxNormalRebateRate = 0 : dmMaxNormalRebateAMT = 0 : dmAvailableRebateRate = 0 : dmAvailableRebateAMT = 0 : dmRebateSalesAMT = 0
        blNormalCardFaceValueErrorWhenSwitchCustomer = True '引起检查面值
        Me.NormalCardSummary()
    End Sub

    Private Sub UpdateNormalRebateInfo()
        If dmNormalSalesAMT = 0 AndAlso dmRebateSalesAMT = 0 Then
            drSalesBill("RebateState") = DBNull.Value
            drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
            Me.splitList.Panel2Collapsed = True
            Me.grbNormalRebate.Visible = False
            Me.grbPrintDiscount.Visible = False
            Me.ResetInterfaceLayout()
            Me.dgvNormalCard.Select() : Me.dgvNormalCard("StartCardNo", 0).Selected = True
            Return
        End If

        Dim drRule As DataRow = Nothing
        For Each drRule In dtNewestRuleDetails.Rows
            If drRule("EndSalesAMT").ToString <> "" AndAlso dmNormalSalesAMT > drRule("StartSalesAMT") AndAlso dmNormalSalesAMT <= drRule("EndSalesAMT") Then
                Exit For
            End If
        Next
        iFirstAvailableRowID = drRule("RowID") - 1
        dmMaxNormalRebateRate = drRule("MaxRebateRate") / 100
        dmMaxNormalRebateAMT = Int(dmNormalSalesAMT * dmMaxNormalRebateRate * 100) / 100
        'modify code 038:start-------------------------------------------------------------------------
        'Me.txbMaxNormalRebateRate.Text = Format(dmMaxNormalRebateRate * 100, "#,0.0")
        Me.txbMaxNormalRebateRate.Text = Format(dmMaxNormalRebateRate * 100, "#,0.00")
        'modify code 038:end-------------------------------------------------------------------------
        Me.txbMaxNormalRebateAMT.Text = Format(dmMaxNormalRebateAMT, "#,0.00")

        If blCalculateNormalRebateByRate Then
            dmAvailableRebateRate = CDec(Me.txbNormalRebateRate.Text) / 100
            dmAvailableRebateAMT = Int(dmNormalSalesAMT * dmAvailableRebateRate * 100) / 100
            Me.txbNormalRebateAMT.Text = Format(dmAvailableRebateAMT, "#,0.00")
            dmAvailableRebateAMT = CDec(Me.txbNormalRebateAMT.Text)
        Else
            dmAvailableRebateAMT = CDec(Me.txbNormalRebateAMT.Text)
            If dmAvailableRebateAMT = 0 Then
                dmAvailableRebateRate = 0
            ElseIf dmNormalSalesAMT = 0 Then
                dmAvailableRebateRate = 1
            Else
                'modify code 038:start-------------------------------------------------------------------------
                'dmAvailableRebateRate = Int((dmAvailableRebateAMT / dmNormalSalesAMT) * 1000 + 0.5) / 1000
                dmAvailableRebateRate = Int((dmAvailableRebateAMT / dmNormalSalesAMT) * 10000 + 0.5) / 10000
                'modify code 038:end-------------------------------------------------------------------------
            End If
            'modify code 038:start-------------------------------------------------------------------------
            'Me.txbNormalRebateRate.Text = Format(dmAvailableRebateRate * 100, "#,0.0")
            Me.txbNormalRebateRate.Text = Format(dmAvailableRebateRate * 100, "#,0.00")
            'modify code 038:end-------------------------------------------------------------------------
        End If

        If dmAvailableRebateAMT = 0 Then
            Me.txbNormalRebateRate.ForeColor = SystemColors.ControlText
            Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Regular)
            Me.txbNormalRebateAMT.ForeColor = SystemColors.ControlText
            Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Regular)
            Me.pnlNormalRebateState.Visible = False
            Me.pnlNormalRebateRemarks.Visible = False
            drSalesBill("RebateState") = 2
            drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
            drSalesBill("NormalRebateRemarks") = DBNull.Value
        ElseIf dmAvailableRebateAMT <= dmMaxNormalRebateAMT Then
            Me.txbNormalRebateRate.ForeColor = SystemColors.ControlText
            Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Regular)
            Me.txbNormalRebateAMT.ForeColor = SystemColors.ControlText
            Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Regular)
            Me.lblNormalRebateState.Text = "有效（在标准范围内）"
            Me.pnlNormalRebateState.Visible = True
            Me.pnlNormalRebateRemarks.Visible = False
            drSalesBill("RebateState") = 2
            drSalesBill("NormalRebateApprovableRoleID") = DBNull.Value
            drSalesBill("NormalRebateRemarks") = DBNull.Value
        Else
            Me.txbNormalRebateRate.ForeColor = Color.Orange
            Me.txbNormalRebateRate.Font = New Font(Me.txbNormalRebateRate.Font, FontStyle.Bold)
            Me.txbNormalRebateAMT.ForeColor = Color.Orange
            Me.txbNormalRebateAMT.Font = New Font(Me.txbNormalRebateAMT.Font, FontStyle.Bold)
            Me.lblNormalRebateState.Text = "需审核（超出标准范围）"
            Me.pnlNormalRebateState.Visible = True
            If dmAvailableRebateRate > 0.2 Then
                Me.lblNormalRebateRemarks.Text = "返点不应超过 20% ！"
            Else
                Me.lblNormalRebateRemarks.Text = "需要由下面人员审核： " & Chr(13) & drRule("RoleFullName").ToString
            End If
            Me.pnlNormalRebateRemarks.Visible = True
            drSalesBill("RebateState") = 0
            drSalesBill("NormalRebateApprovableRoleID") = drRule("ApprovableRoleID")
            drSalesBill("NormalRebateRemarks") = Me.lblNormalRebateRemarks.Text
        End If

        Me.txbDistributionNormalRebateAMT.Text = Format(dmRebateSalesAMT, "#,0.00")
        If dmRebateSalesAMT <= dmAvailableRebateAMT Then
            Me.txbDistributionNormalRebateAMT.ForeColor = SystemColors.ControlText
            Me.txbDistributionNormalRebateAMT.Font = New Font(Me.txbDistributionNormalRebateAMT.Font, FontStyle.Regular)
            Me.theTip.SetToolTip(Me.txbDistributionNormalRebateAMT, "")
        Else
            Me.txbDistributionNormalRebateAMT.BackColor = SystemColors.Control
            Me.txbDistributionNormalRebateAMT.ForeColor = Color.Red
            Me.txbDistributionNormalRebateAMT.Font = New Font(Me.txbDistributionNormalRebateAMT.Font, FontStyle.Bold)
            Me.theTip.SetToolTip(Me.txbDistributionNormalRebateAMT, "已分配的返点金额超过您输入的返点金额： " & Format(dmAvailableRebateAMT, "#,0.00").Replace(".00", "") & " 元！")
        End If

        If dmRebateSalesAMT < dmAvailableRebateAMT Then
            Me.pnlBalanceNormalRebateAMT.Visible = True
            Me.txbBalanceNormalRebateAMT.Text = Format(dmAvailableRebateAMT - dmRebateSalesAMT, "#,0.00")
            Me.theTip.SetToolTip(Me.txbBalanceNormalRebateAMT, "已分配的返点金额未达到您输入的返点金额： " & Format(dmAvailableRebateAMT, "#,0.00").Replace(".00", "") & " 元。" & Chr(13) & "请在右边返点卡列表中" & IIf(dmRebateSalesAMT = 0, "", "继续") & "分配返点卡及其金额。")
        Else
            Me.pnlBalanceNormalRebateAMT.Visible = False
        End If

        drRule = Nothing
        Dim iOldHeight As Integer = Me.grbNormalRebate.Height
        Me.flpNormalRebate.AutoSize = False
        Me.flpNormalRebate.AutoSize = True
        Dim iNewHeight As Integer = Me.flpNormalRebate.Height + 55
        If iOldHeight <> iNewHeight Then
            Me.grbNormalRebate.Height = iNewHeight
            Me.ResetInterfaceLayout()
        End If
    End Sub

    Private Sub UpdateEmployeePurchaseInfo()
        If dmNormalSalesAMT = 0 AndAlso dmRebateSalesAMT = 0 Then
            dmAvailableRebateAMT = 0
            Me.pnlAvailableRebateQuota.Visible = False
            Me.tlpDistributedQuota.Visible = False
            Me.tlpBalanceQuota.Visible = False
        Else
            Dim dmMaxAvailableRebateAMT As Decimal = CDec(Me.txbMaxAvailableRebateQuota.Text)
            If dmNormalSalesAMT > drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") Then
                Me.txbAvailableRebateQuota.Text = Me.txbMaxAvailableRebateQuota.Text
            Else
                Me.txbAvailableRebateQuota.Text = Format(dmNormalSalesAMT * drEmployee("RateQuota"), "#,0.00")
            End If
            dmAvailableRebateAMT = CDec(Me.txbAvailableRebateQuota.Text)
            Me.pnlAvailableRebateQuota.Visible = (dmAvailableRebateAMT < dmMaxAvailableRebateAMT)

            Me.tlpDistributedQuota.Visible = True
            Me.txbDistributedPurchaseQuota.BackColor = SystemColors.Control
            If dmNormalSalesAMT <= drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") Then
                Me.txbDistributedPurchaseQuota.ForeColor = SystemColors.ControlText
                Me.txbDistributedPurchaseQuota.Font = New Font(Me.txbDistributedPurchaseQuota.Font, FontStyle.Regular)
                Me.theTip.SetToolTip(Me.txbDistributedPurchaseQuota, "")
            Else
                Me.txbDistributedPurchaseQuota.ForeColor = Color.Red
                Me.txbDistributedPurchaseQuota.Font = New Font(Me.txbDistributedPurchaseQuota.Font, FontStyle.Bold)
                Me.theTip.SetToolTip(Me.txbDistributedPurchaseQuota, "已分配的购买金额已超过购买额度：" & Me.txbMaxAvailablePurchaseQuota.Text & " 元！")
            End If
            Me.txbDistributedPurchaseQuota.Text = Format(dmNormalSalesAMT, "#,0.00")

            Me.txbDistributedRebateQuota.BackColor = SystemColors.Control
            If dmRebateSalesAMT <= dmAvailableRebateAMT Then
                Me.txbDistributedRebateQuota.ForeColor = SystemColors.ControlText
                Me.txbDistributedRebateQuota.Font = New Font(Me.txbDistributedRebateQuota.Font, FontStyle.Regular)
                Me.theTip.SetToolTip(Me.txbDistributedRebateQuota, "")
            Else
                Me.txbDistributedRebateQuota.BackColor = SystemColors.Control
                Me.txbDistributedRebateQuota.ForeColor = Color.Red
                Me.txbDistributedRebateQuota.Font = New Font(Me.txbDistributedRebateQuota.Font, FontStyle.Bold)
                If dmAvailableRebateAMT = dmMaxAvailableRebateAMT Then
                    Me.theTip.SetToolTip(Me.txbDistributedRebateQuota, "已分配的返点金额已超过返点额度：" & Me.txbAvailableRebateQuota.Text & " 元！")
                Else
                    Me.theTip.SetToolTip(Me.txbDistributedRebateQuota, "已分配的返点金额已超过本次最大可兑现的返点金额：" & Me.txbAvailableRebateQuota.Text & " 元！")
                End If
            End If
            Me.txbDistributedRebateQuota.Text = Format(dmRebateSalesAMT, "#,0.00")

            If dmRebateSalesAMT > 0 AndAlso dmRebateSalesAMT < dmAvailableRebateAMT Then
                Me.pnlDistributedBalanceRebateQuota.Visible = True
                Me.txbDistributedBalanceRebateQuota.Text = Format(dmAvailableRebateAMT - dmRebateSalesAMT, "#,0.00")
            Else
                Me.pnlDistributedBalanceRebateQuota.Visible = False
            End If

            Me.tlpBalanceQuota.Visible = False
            If dmNormalSalesAMT >= drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") Then
                Me.pnlBalancePurchaseQuota.Visible = False
            Else
                Me.tlpBalanceQuota.Visible = True
                Me.pnlBalancePurchaseQuota.Visible = True
                Me.txbBalancePurchaseQuota.Text = Format(drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") - dmNormalSalesAMT, "#,0.00")
            End If

            If dmAvailableRebateAMT = dmMaxAvailableRebateAMT Then
                Me.pnlBalanceRebateQuota.Visible = False
            Else
                Me.tlpBalanceQuota.Visible = True
                Me.pnlBalanceRebateQuota.Visible = True
                Me.txbBalanceRebateQuota.Text = Format(dmMaxAvailableRebateAMT - dmAvailableRebateAMT, "#,0.00")
            End If
        End If

        Me.flpEmployeeQuota.AutoSize = False
        Me.flpEmployeeQuota.AutoSize = True
        Me.grbEmployeeQuota.Height = Me.flpEmployeeQuota.Height + 25
        Me.flpEmployee.AutoSize = False
        Me.flpEmployee.AutoSize = True
        Me.ResetInterfaceLayout()

        If Me.flpLeftContainer.VerticalScroll.Visible = True Then
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
        End If
    End Sub

    Private Sub CardNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then
            If editingTextBox IsNot Nothing AndAlso editingTextBox.SelectedText.Length > 0 AndAlso editingTextBox.SelectedText.Length = editingTextBox.Text.Length Then
                blSkipDeal = True
                CType(sender, DataGridViewTextBoxEditingControl).EditingControlDataGridView.CurrentCell.Value = ""
                blSkipDeal = False
            End If
            Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub CardQTY_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        e.SuppressKeyPress = True
    End Sub

    Private Sub Money_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then Return
        If e.KeyCode = Keys.OemPeriod OrElse e.KeyCode = Keys.Decimal Then
            If editingTextBox.SelectedText.IndexOf(".") > -1 OrElse editingTextBox.Text.IndexOf(".") = -1 Then Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub Money_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        If CType(sender, DataGridViewTextBoxEditingControl).EditingControlDataGridView.Equals(Me.dgvPayment) Then
            Me.btnOK.Enabled = True
        End If
    End Sub

    Private Sub MediaNo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentCell.RowIndex).Value <> 1 AndAlso e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If e.KeyCode = Keys.Oemplus Then
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
        If Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentCell.RowIndex).Value <> 1 AndAlso ((e.Shift AndAlso (e.KeyCode = Keys.D9 OrElse e.KeyCode = Keys.D0)) OrElse e.KeyCode = Keys.OemMinus OrElse e.KeyCode = Keys.Subtract OrElse e.KeyCode = Keys.Space) Then Return
        If e.Control AndAlso e.KeyCode = Keys.V AndAlso Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentCell.RowIndex).Value = 1 Then My.Computer.Clipboard.Clear() : e.SuppressKeyPress = True : Return
        'modify code 008:start-------------------------------------------------------------------------
        If Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentCell.RowIndex).Value = 7 AndAlso (e.KeyCode >= Keys.A And e.KeyCode <= Keys.Z) Then Return
        'modify code 008:end-------------------------------------------------------------------------
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentCell.RowIndex).Value = 1 AndAlso e.KeyCode = Keys.Multiply Then e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then
            If editingTextBox IsNot Nothing AndAlso (editingTextBox.SelectedText.Length = editingTextBox.Text.Length OrElse (Me.dgvPayment("PaymentTerm", Me.dgvPayment.CurrentCell.RowIndex).Value = 1 AndAlso editingTextBox.Text.IndexOf("*") > -1)) Then
                blSkipDeal = True
                Me.dgvPayment.CurrentCell.Value = ""
                blSkipDeal = False
            End If
            Return
        End If
        e.SuppressKeyPress = True
    End Sub

    Private Sub PayerName_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        If Not blBrushingEnd Then e.SuppressKeyPress = True : Return
        If e.KeyCode = Keys.OemSemicolon Then '防止从读卡器上输入 
            blBrushingEnd = False
            sTimerType = "BrushingCard"
            Me.theTimer.Interval = 1000
            Me.theTimer.Enabled = True
            e.SuppressKeyPress = True
            Return
        End If
    End Sub

    'modify code 011:start-------------------------------------------------------------------------
    Private Sub Barcode_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        If e.Control OrElse e.Alt OrElse e.KeyCode = Keys.Left OrElse e.KeyCode = Keys.Right OrElse e.KeyCode = Keys.Back OrElse e.KeyCode = Keys.Delete Then Return
        If e.Shift Then e.SuppressKeyPress = True : Return
        If (e.KeyCode >= Keys.NumPad0 AndAlso e.KeyCode <= Keys.NumPad9) OrElse (e.KeyCode >= Keys.D0 AndAlso e.KeyCode <= Keys.D9) Then
            If editingTextBox IsNot Nothing AndAlso editingTextBox.SelectedText.Length > 0 AndAlso editingTextBox.SelectedText.Length = editingTextBox.Text.Length Then
                blSkipDeal = True
                CType(sender, DataGridViewTextBoxEditingControl).EditingControlDataGridView.CurrentCell.Value = ""
                blSkipDeal = False
            End If
            Return
        End If
        e.SuppressKeyPress = True
    End Sub
    'modify code 011:end-------------------------------------------------------------------------

    Private Sub editingTextBox_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        If blSkipDeal Then Return
        If editingTextBox Is Nothing Then Return
        Dim theDataGridView As DataGridView = CType(sender, DataGridViewTextBoxEditingControl).EditingControlDataGridView, blHaveOtherTypeCard As Boolean
        If theDataGridView.Columns(theDataGridView.CurrentCell.ColumnIndex).Name = "StartCardNo" AndAlso theDataGridView("EndCardNo", theDataGridView.CurrentCell.RowIndex).Value.ToString = "" Then
            blSkipDeal = True
            Dim sValue As String = editingTextBox.Text, bSelectionStart As Byte = editingTextBox.SelectionStart, bSelectionLength As Byte = editingTextBox.SelectionLength, sFeature As String = "充值券"
            If blCanUsePaperCard Then
                Dim bStart As Byte = editingTextBox.SelectionStart, bLen As Byte = editingTextBox.SelectionLength
                If sValue.IndexOf("9") = 0 Then
                    Dim blCanUse9Card As Boolean = False
                    If sValue.IndexOf("92") = 0 Then
                        If blCanUse92Card Then
                            sFeature = "营销券"
                            blCanUse9Card = True
                        End If
                    ElseIf sValue.IndexOf("94") = 0 Then
                        If blCanUse94Card Then
                            sFeature = "活动券"
                            blCanUse9Card = True
                        End If
                    ElseIf sValue = "9" Then
                        If bNewSalesBillType = 2 Then
                            sFeature = "活动券"
                            blCanUse9Card = True
                        ElseIf bNewSalesBillType = 3 Then
                            sFeature = "公关券"
                            blCanUse9Card = True
                        ElseIf blCanUse92Card Then
                            sFeature = "营销券"
                            blCanUse9Card = True
                        End If
                    End If

                    If blCanUse9Card Then
                        theDataGridView("CardFeature", theDataGridView.CurrentCell.RowIndex).Value = sFeature
                        theDataGridView.Columns("CardFeature").Visible = True
                        editingTextBox.MaxLength = 17
                        theDataGridView("FaceValue", theDataGridView.CurrentCell.RowIndex).ReadOnly = True
                        'modify code 004:start-------------------------------------------------------------------------
                        'If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = True
                        If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                        'modify code 004:end-------------------------------------------------------------------------
                    Else
                        theDataGridView("CardFeature", theDataGridView.CurrentCell.RowIndex).Value = DBNull.Value
                        blHaveOtherTypeCard = False
                        For Each drCard As DataGridViewRow In theDataGridView.Rows
                            If drCard.Cells("CardFeature").Value.ToString <> "" AndAlso drCard.Cells("CardFeature").Value.ToString <> "磁条卡" Then
                                blHaveOtherTypeCard = True
                                Exit For
                            End If
                        Next

                        theDataGridView.Columns("CardFeature").Visible = blHaveOtherTypeCard
                        editingTextBox.MaxLength = 19
                        theDataGridView("FaceValue", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                        If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                    End If
                ElseIf sValue.IndexOf("8") = 0 Then
                    If sValue.IndexOf("84") = 0 Then
                        If sValue.Length > 7 Then
                            If sValue.Substring(5, 1) = "8" OrElse sValue.Substring(5, 3) = "100" Then sFeature = "条码卡"
                        ElseIf sValue.Length > 5 Then
                            If sValue.Substring(5, 1) = "8" OrElse sValue.Substring(5, 1) = "1" Then sFeature = "条码卡"
                        Else
                            sFeature = "条码卡"
                        End If
                    ElseIf sValue = "8" OrElse sValue.IndexOf("86") = 0 Then
                        sFeature = "条码卡"
                    Else
                        sFeature = ""
                    End If

                    If sFeature = "" Then
                        theDataGridView("CardFeature", theDataGridView.CurrentCell.RowIndex).Value = DBNull.Value
                        blHaveOtherTypeCard = False
                        For Each drCard As DataGridViewRow In theDataGridView.Rows
                            If drCard.Cells("CardFeature").Value.ToString <> "" AndAlso drCard.Cells("CardFeature").Value.ToString <> "磁条卡" Then
                                blHaveOtherTypeCard = True
                                Exit For
                            End If
                        Next

                        theDataGridView.Columns("CardFeature").Visible = blHaveOtherTypeCard
                        editingTextBox.MaxLength = 19
                        theDataGridView("FaceValue", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                        If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                    Else
                        theDataGridView("CardFeature", theDataGridView.CurrentCell.RowIndex).Value = sFeature
                        theDataGridView.Columns("CardFeature").Visible = True
                        editingTextBox.MaxLength = 17
                        theDataGridView("FaceValue", theDataGridView.CurrentCell.RowIndex).ReadOnly = True
                        'modify code 004:start-------------------------------------------------------------------------
                        'If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = True
                        If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                        'modify code 004:end-------------------------------------------------------------------------
                    End If
                Else
                    If sValue.IndexOf("2") = 0 Then
                        If sValue.IndexOf("233694") = 0 Then
                            sFeature = IIf(blCanUse94Card, "活动卡", "")
                        ElseIf sValue.IndexOf("233692") = 0 Then
                            sFeature = IIf(blCanUse92Card, "营销卡", "")
                        ElseIf sValue = "23369" Then
                            sFeature = IIf(bNewSalesBillType = 2, "活动卡", IIf(bNewSalesBillType = 3, "公关卡", IIf(blCanUse92Card, "营销卡", "")))
                        ElseIf sValue = "23368" OrElse sValue.IndexOf("233684") = 0 Then
                            sFeature = "磁条卡"
                            'modify code 051:start-------------------------------------------------------------------------
                            'ElseIf sValue = "23366" OrElse sValue.IndexOf("233660") = 0 Then
                        ElseIf sValue.IndexOf("233660") = 0 Then
                            sFeature = IIf(blCanUse60Card, "礼品卡", "")
                        ElseIf sValue.IndexOf("233665") = 0 Then
                            sFeature = IIf(blCanUse65Card, "磁条卡", "")
                            'modify code 051:end-------------------------------------------------------------------------
                        ElseIf theDataGridView.Name.IndexOf("RebateCard") > -1 AndAlso Me.chbPrintDiscount.Checked = False AndAlso sValue.Length < 5 AndAlso "2336".IndexOf(sValue) = 0 Then
                            sFeature = "营销卡"
                        ElseIf sValue.Length < 5 AndAlso "2336".IndexOf(sValue) = 0 Then
                            sFeature = IIf(bNewSalesBillType = 2, "活动卡", IIf(bNewSalesBillType = 3, "公关卡", "磁条卡"))
                        Else
                            sFeature = ""
                        End If
                    Else
                        sFeature = ""
                    End If

                    theDataGridView("CardFeature", theDataGridView.CurrentCell.RowIndex).Value = IIf(sFeature = "", DBNull.Value, sFeature)
                    If sFeature <> "" AndAlso sFeature <> "磁条卡" Then
                        blHaveOtherTypeCard = True
                    Else
                        blHaveOtherTypeCard = False
                        For Each drCard As DataGridViewRow In theDataGridView.Rows
                            If drCard.Cells("CardFeature").Value.ToString <> "" AndAlso drCard.Cells("CardFeature").Value.ToString <> "磁条卡" Then
                                blHaveOtherTypeCard = True
                                Exit For
                            End If
                        Next
                    End If
                    theDataGridView.Columns("CardFeature").Visible = blHaveOtherTypeCard
                    editingTextBox.MaxLength = 19
                    theDataGridView("FaceValue", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                    If theDataGridView.Name.IndexOf("NormalCard") > -1 Then theDataGridView("CardCost", theDataGridView.CurrentCell.RowIndex).ReadOnly = False
                End If

                editingTextBox.Text = sValue
                editingTextBox.SelectionStart = bStart
                editingTextBox.SelectionLength = bLen
            Else
                If sValue.IndexOf("2") = 0 Then
                    If sValue.IndexOf("233694") = 0 Then
                        sFeature = IIf(blCanUse94Card, "活动卡", "")
                    ElseIf sValue.IndexOf("233692") = 0 Then
                        sFeature = IIf(blCanUse92Card, "营销卡", "")
                    ElseIf sValue = "23369" Then
                        sFeature = IIf(bNewSalesBillType = 2, "活动卡", IIf(bNewSalesBillType = 3, "公关卡", IIf(blCanUse92Card, "营销卡", "")))
                    ElseIf sValue = "23368" OrElse sValue.IndexOf("233684") = 0 Then
                        sFeature = "磁条卡"
                        'modify code 051:start-------------------------------------------------------------------------
                        'ElseIf sValue = "23366" OrElse sValue.IndexOf("233660") = 0 Then
                    ElseIf sValue.IndexOf("233660") = 0 Then
                        sFeature = IIf(blCanUse60Card, "礼品卡", "")
                    ElseIf sValue.IndexOf("233665") = 0 Then
                        sFeature = IIf(blCanUse65Card, "磁条卡", "")
                        'modify code 051:end-------------------------------------------------------------------------
                    ElseIf theDataGridView.Name.IndexOf("RebateCard") > -1 AndAlso Me.chbPrintDiscount.Checked = False AndAlso sValue.Length < 5 AndAlso "2336".IndexOf(sValue) = 0 Then
                        sFeature = "营销卡"
                    ElseIf sValue.Length < 5 AndAlso "2336".IndexOf(sValue) = 0 Then
                        sFeature = IIf(bNewSalesBillType = 2, "活动卡", IIf(bNewSalesBillType = 3, "公关卡", "磁条卡"))
                    Else
                        sFeature = ""
                    End If
                Else
                    sFeature = ""
                End If

                'modify code 063:start-------------------------------------------------------------------------
                If bNewSalesBillType = 7 Then
                    If sValue.Length >= 19 Then
                        editingTextBox.MaxLength = 19
                    End If
                End If
                'modify code 063:end-------------------------------------------------------------------------

                theDataGridView("CardFeature", theDataGridView.CurrentCell.RowIndex).Value = IIf(sFeature = "", DBNull.Value, sFeature)
                If editingTextBox.Text <> sValue Then '可能数据丢失
                    editingTextBox.Text = sValue
                    editingTextBox.SelectionStart = bSelectionStart
                    editingTextBox.SelectionLength = bSelectionLength
                End If
                If sFeature <> "" AndAlso sFeature <> "磁条卡" Then
                    blHaveOtherTypeCard = True
                Else
                    blHaveOtherTypeCard = False
                    For Each drCard As DataGridViewRow In theDataGridView.Rows
                        If drCard.Cells("CardFeature").Value.ToString <> "" AndAlso drCard.Cells("CardFeature").Value.ToString <> "磁条卡" Then
                            blHaveOtherTypeCard = True
                            Exit For
                        End If
                    Next
                End If
                theDataGridView.Columns("CardFeature").Visible = blHaveOtherTypeCard
            End If
            blSkipDeal = False
            theDataGridView.Refresh()
        End If
        editingTextBox.ForeColor = SystemColors.ControlText
        frmMain.statusText.Text = "就绪。"
    End Sub

    Private Function SetInputtingCardFeature(ByVal sInputtingCardNo As String, Optional ByVal blIsRebateCard As Boolean = False) As String
        Dim sNewFeature As String = "充值券"
        If sInputtingCardNo.IndexOf("9") = 0 Then
            If blCanUsePaperCard Then
                If sInputtingCardNo.IndexOf("94") = 0 Then
                    sNewFeature = IIf(blCanUse94Card, "活动券", "")
                ElseIf sInputtingCardNo.IndexOf("92") = 0 Then
                    sNewFeature = IIf(blCanUse92Card, "营销券", "")
                ElseIf sInputtingCardNo = "9" Then
                    sNewFeature = IIf(bNewSalesBillType = 2, "活动券", IIf(bNewSalesBillType = 3, "公关券", IIf(blCanUse92Card, "营销券", "")))
                Else
                    sNewFeature = ""
                End If
            Else
                sNewFeature = ""
            End If
        ElseIf sInputtingCardNo.IndexOf("8") = 0 Then
            If blCanUsePaperCard Then
                If sInputtingCardNo.IndexOf("84") = 0 Then
                    If sInputtingCardNo.Length > 7 Then
                        If sInputtingCardNo.Substring(5, 1) = "8" OrElse sInputtingCardNo.Substring(5, 3) = "100" Then sNewFeature = "条码卡"
                    ElseIf sInputtingCardNo.Length > 5 Then
                        If sInputtingCardNo.Substring(5, 1) = "8" Then sNewFeature = "条码卡"
                    Else
                        sNewFeature = "条码卡"
                    End If
                ElseIf sInputtingCardNo = "8" OrElse sInputtingCardNo.IndexOf("86") = 0 Then
                    sNewFeature = "条码卡"
                Else
                    sNewFeature = ""
                End If
            Else
                sNewFeature = ""
            End If
        ElseIf sInputtingCardNo.IndexOf("2") = 0 Then
            If sInputtingCardNo.IndexOf("233694") = 0 Then
                sNewFeature = IIf(blCanUse94Card, "活动卡", "")
            ElseIf sInputtingCardNo.IndexOf("233692") = 0 Then
                sNewFeature = IIf(blCanUse92Card, "营销卡", "")
                'modify code 050:start-------------------------------------------------------------------------
                'ElseIf bNewSalesBillType = 7 Then
                'If sInputtingCardNo.IndexOf("2336" & frmMain.signCardBin) = 0 Then
            ElseIf sInputtingCardNo.IndexOf("2336" & frmMain.signCardBin) = 0 Then
                sNewFeature = "实名制卡"
                'End If
                'modify code 050:end-------------------------------------------------------------------------
            ElseIf sInputtingCardNo = "23369" Then
                sNewFeature = IIf(bNewSalesBillType = 2, "活动卡", IIf(bNewSalesBillType = 3, "公关卡", IIf(blCanUse92Card, "营销卡", "")))
            ElseIf sInputtingCardNo = "23368" OrElse sInputtingCardNo.IndexOf("233684") = 0 Then
                sNewFeature = "磁条卡"
                'modify code 051:start-------------------------------------------------------------------------
                'ElseIf sInputtingCardNo = "23366" OrElse sInputtingCardNo.IndexOf("233660") = 0 Then
            ElseIf sInputtingCardNo.IndexOf("233660") = 0 Then
                sNewFeature = IIf(blCanUse60Card, "礼品卡", "")
            ElseIf sInputtingCardNo.IndexOf("233665") = 0 Then
                sNewFeature = IIf(blCanUse65Card, "磁条卡", "")
                'modify code 051:end-------------------------------------------------------------------------
            ElseIf blIsRebateCard AndAlso Me.chbPrintDiscount.Checked = False AndAlso sInputtingCardNo.Length < 5 AndAlso "2336".IndexOf(sInputtingCardNo) = 0 Then
                sNewFeature = "营销卡"
            ElseIf sInputtingCardNo.Length < 5 AndAlso "2336".IndexOf(sInputtingCardNo) = 0 Then
                sNewFeature = IIf(bNewSalesBillType = 2, "活动卡", IIf(bNewSalesBillType = 3, "公关卡", "磁条卡"))
                'modify code 051:start-------------------------------------------------------------------------
            ElseIf sInputtingCardNo.IndexOf("233665") = 0 Then
                sNewFeature = "磁条卡"
                'modify code 051:end-------------------------------------------------------------------------
            Else
                sNewFeature = ""
            End If
        Else
            sNewFeature = ""
        End If

        Return sNewFeature
    End Function

    Private Function SetCardFeature(ByVal bRowType As Byte, ByVal sCardNo As String) As String
        Dim sFeature As String = ""
        Select Case bRowType
            Case 0
                If bNewSalesBillType = 2 Then
                    If sCardNo.IndexOf("9") = 0 Then
                        sFeature = "活动券"
                    Else
                        sFeature = "活动卡"
                    End If
                ElseIf bNewSalesBillType = 3 Then
                    If sCardNo.IndexOf("9") = 0 Then
                        sFeature = "公关券"
                    Else
                        sFeature = "公关卡"
                    End If
                ElseIf sCardNo.IndexOf("8") = 0 Then
                    If sCardNo.IndexOf("86") = 0 OrElse sCardNo.Substring(5, 1) = "8" OrElse sCardNo.Substring(5, 3) = "100" Then
                        sFeature = "正常卡（条码卡）"
                    Else
                        sFeature = "正常卡（充值券）"
                    End If
                Else
                    'modify code 051:start-------------------------------------------------------------------------
                    'sFeature = "正常卡" & IIf(sCardNo.IndexOf("23366") = 0, "（礼品卡）", IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, "（磁条卡）", ""))
                    sFeature = "正常卡" & IIf(sCardNo.IndexOf("233660") = 0, "（礼品卡）", IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, "（磁条卡）", ""))
                    'modify code 051:end-------------------------------------------------------------------------
                End If
            Case 1
                'modify code 051:start-------------------------------------------------------------------------
                'If blCanUse60Card = False AndAlso blCanUse92Card = False AndAlso blCanUse94Card = False AndAlso blCanUsePaperCard = False Then
                If blCanUse60Card = False AndAlso blCanUse92Card = False AndAlso blCanUse94Card = False AndAlso blCanUsePaperCard = False AndAlso blCanUse65Card Then
                    'modify code 051:end-------------------------------------------------------------------------
                    sFeature = "退货卡"
                ElseIf sCardNo.IndexOf("233694") = 0 Then
                    sFeature = "活动卡退卡"
                ElseIf sCardNo.IndexOf("233692") = 0 Then
                    sFeature = "营销卡退卡"
                    'modify code 051:start-------------------------------------------------------------------------
                ElseIf sCardNo.IndexOf("233660") = 0 Then
                    sFeature = "礼品卡退卡"
                    'modify code 051:end-------------------------------------------------------------------------
                Else
                    sFeature = "磁条卡退卡"
                End If
            Case Else
                If sCardNo.IndexOf("8") = 0 Then
                    If sCardNo.IndexOf("86") = 0 OrElse sCardNo.Substring(5, 1) = "8" OrElse sCardNo.Substring(5, 3) = "100" Then
                        sFeature = "返点卡（条码卡）"
                    Else
                        sFeature = "返点卡（充值券）"
                    End If
                ElseIf sCardNo.IndexOf("9") = 0 Then
                    sFeature = "返点卡（营销券）"
                Else
                    If sCardNo.Substring(4, 2) = "92" Then
                        sFeature = "返点卡（营销卡）"
                    ElseIf sCardNo.Substring(4, 2) = "60" Then
                        sFeature = "返点卡（礼品卡）"
                    Else
                        'modify code 051:start-------------------------------------------------------------------------
                        'sFeature = "返点卡" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard, "（磁条卡）", "")
                        sFeature = "返点卡" & IIf(blCanUse60Card OrElse blCanUse92Card OrElse blCanUse94Card OrElse blCanUsePaperCard OrElse blCanUse65Card, "（磁条卡）", "")
                        'modify code 051:end-------------------------------------------------------------------------
                    End If
                End If
        End Select

        Return sFeature
    End Function

    Private Function IsValidCard(ByVal sCardNo As String) As Boolean
        If sCardNo.IndexOf("233684") = 0 Then
            Return True
        ElseIf sCardNo.IndexOf("233692") = 0 Then
            Return True
        ElseIf sCardNo.IndexOf("233694") = 0 Then
            Return True
        ElseIf sCardNo.IndexOf("233660") = 0 Then
            Return True
            'modify code 051:start-------------------------------------------------------------------------
        ElseIf sCardNo.IndexOf("233665") = 0 Then
            Return True
            'modify code 051:end-------------------------------------------------------------------------
        ElseIf sCardNo.IndexOf("86") = 0 Then
            Return True
        ElseIf sCardNo.IndexOf("84") = 0 Then
            Return True
        ElseIf sCardNo.IndexOf("94") = 0 Then
            Return True
        ElseIf sCardNo.IndexOf("92") = 0 Then
            Return True
        ElseIf sCardNo = "2" Then
            Return True
        ElseIf sCardNo = "8" Then
            Return True
        ElseIf sCardNo = "9" Then
            Return True
        ElseIf sCardNo = "23" Then
            Return True
        ElseIf sCardNo = "233" Then
            Return True
        ElseIf sCardNo = "2336" Then
            Return True
        ElseIf sCardNo = "23368" Then
            Return True
        ElseIf sCardNo = "23369" Then
            Return True
        ElseIf sCardNo = "23366" Then
            Return True
        Else
            Return False
        End If
    End Function

    Private Sub ConfigNormalCardRow()
        Dim iRows As Integer = Me.dgvNormalCard.RowCount - 1, iCurrentRow As Integer = Me.dgvNormalCard.CurrentRow.Index, sStartCardNo As String = Me.dgvNormalCard("StartCardNo", iCurrentRow).Value.ToString, sEndCardNo As String = Me.dgvNormalCard("EndCardNo", iCurrentRow).Value.ToString
        'modify code 004:start-------------------------------------------------------------------------
        Dim sFirstBuy As String = "", sCardCost As String = ""
        'modify code 004:end-------------------------------------------------------------------------
        'modify code 011:start-------------------------------------------------------------------------
        Dim sBarCode As String = ""
        'modify code 011:end-------------------------------------------------------------------------
        'modify code 046:start-------------------------------------------------------------------------
        Dim sHolderName As String = ""
        Dim sGender As String = ""
        Dim sHolderIdNo As String = ""
        Dim sMobile As String = ""
        'modify code 046:end-------------------------------------------------------------------------
        If sStartCardNo > sEndCardNo Then
            Me.dgvNormalCard.EndEdit() : sStartCardNo = sEndCardNo : sEndCardNo = Me.dgvNormalCard("StartCardNo", iCurrentRow).Value.ToString
            Me.dgvNormalCard("StartCardNo", iCurrentRow).Value = sStartCardNo : Me.dgvNormalCard("EndCardNo", iCurrentRow).Value = sEndCardNo
        End If

        Dim dtTempList As DataTable = dtNormalCard.DefaultView.ToTable, sFeature As String, sStart As String, sEnd As String, drCard As DataRow, blNeedResetRow As Boolean = False
        dtTempList.Rows.Clear()
        dtTempList.Columns.Add("SecondID", System.Type.GetType("System.Int16"))
        For iRow As Integer = 0 To iRows
            If iRow <> iCurrentRow AndAlso Me.dgvNormalCard("StartCardNo", iRow).Value.ToString <> "" Then
                sFeature = Me.dgvNormalCard("CardFeature", iRow).Value.ToString
                sStart = Me.dgvNormalCard("StartCardNo", iRow).Value.ToString : sEnd = Me.dgvNormalCard("EndCardNo", iRow).Value.ToString
                If sStart.IndexOf("8") = 0 OrElse sStart.IndexOf("9") = 0 Then '纸券行,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvNormalCard("CardQTY", iRow).Value
                    'modify code 011:start-------------------------------------------------------------------------
                    drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                    'modify code 011:end-------------------------------------------------------------------------
                    drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                    drCard("ReducedCardPayment") = 0
                    'modify code 004:start-------------------------------------------------------------------------
                    'drCard("CardCost") = 0
                    drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                    drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                    'modify code 004:end-------------------------------------------------------------------------
                    drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value
                    drCard("ChargedAMT") = Me.dgvNormalCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = Me.dgvNormalCard("PayableAMT", iRow).Value
                    drCard("PaymentDescription") = Me.dgvNormalCard("PaymentDescription", iRow).Value
                    'modify code 004:start-------------------------------------------------------------------------
                    'drCard("CostAMT") = 0
                    drCard("CostAMT") = Me.dgvNormalCard("CostAMT", iRow).Value
                    'modify code 004:end-------------------------------------------------------------------------
                ElseIf sStartCardNo > sEnd OrElse sEndCardNo < sStart Then '该行卡号范围落在当前修改行之外,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvNormalCard("CardQTY", iRow).Value
                    'modify code 011:start-------------------------------------------------------------------------
                    drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                    'modify code 011:end-------------------------------------------------------------------------
                    drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                    drCard("ReducedCardPayment") = 0
                    drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                    'modify code 004:start-------------------------------------------------------------------------
                    drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                    'modify code 004:end-------------------------------------------------------------------------

                    'modify code 046:start-------------------------------------------------------------------------
                    If bNewSalesBillType = 7 Then
                        drCard("HolderName") = Me.dgvNormalCard("HolderName", iRow).Value
                        drCard("Gender") = Me.dgvNormalCard("Gender", iRow).Value
                        drCard("HolderIdNo") = Me.dgvNormalCard("HolderIdNo", iRow).Value
                        drCard("Mobile") = Me.dgvNormalCard("Mobile", iRow).Value
                    End If
                    'modify code 046:end-------------------------------------------------------------------------

                    If drSalesBill("SalesBillType") = 1 Then
                        drCard("CardPayment") = 0
                    Else
                        drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value + Me.dgvNormalCard("CardCost", iRow).Value
                    End If
                    drCard("ChargedAMT") = Me.dgvNormalCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = Me.dgvNormalCard("PayableAMT", iRow).Value
                    drCard("PaymentDescription") = Me.dgvNormalCard("PaymentDescription", iRow).Value
                    drCard("CostAMT") = Me.dgvNormalCard("CostAMT", iRow).Value
                Else
                    If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then
                        For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", iRow).Value.ToString)
                            drRowPayment.Delete() : drRowPayment.AcceptChanges()
                        Next
                    End If
                    If sStartCardNo < sStart AndAlso sEnd < sEndCardNo Then '该行卡号范围完全落在当前修改行之内,将被删除
                        'modify code 004:start-------------------------------------------------------------------------
                        sFirstBuy = Me.dgvNormalCard("FirstBuy", iCurrentRow).Value
                        sCardCost = Me.dgvNormalCard("CardCost", iCurrentRow).Value
                        'modify code 004:end-------------------------------------------------------------------------
                        'modify code 011:start-------------------------------------------------------------------------
                        sBarCode = Me.dgvNormalCard("BarCode", iCurrentRow).Value.ToString
                        'modify code 011:end-------------------------------------------------------------------------

                        'modify code 046:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Then
                            sHolderName = Me.dgvNormalCard("HolderName", iRow).Value
                            sGender = Me.dgvNormalCard("Gender", iRow).Value
                            sHolderIdNo = Me.dgvNormalCard("HolderIdNo", iRow).Value
                            sMobile = Me.dgvNormalCard("Mobile", iRow).Value
                        End If
                        'modify code 046:end-------------------------------------------------------------------------

                        blNeedResetRow = True
                    Else '该行卡号范围部分落在当前修改行之内,将被截断
                        Dim dtTemp As New DataTable
                        dtTemp.Columns.Add("CardNo", System.Type.GetType("System.String"))
                        Dim dvTemp As New DataView(dtTemp), drTemp As DataRowView
                        sStart = sStart.Substring(0, 18)
                        Dim iCardQTY As Integer = Me.dgvNormalCard("CardQTY", iRow).Value - 1
                        For iCard As Integer = 0 To iCardQTY
                            sEnd = (CLng(sStart) + iCard).ToString
                            If sEnd < sStartCardNo.Substring(0, 18) OrElse sEnd > sEndCardNo.Substring(0, 18) Then
                                drTemp = dvTemp.AddNew
                                drTemp(0) = sEnd
                                drTemp.EndEdit()
                            End If
                        Next
                        dtTemp.AcceptChanges()

                        'modify code 004:start-------------------------------------------------------------------------
                        If dvTemp.Count = 0 Then
                            sFirstBuy = Me.dgvNormalCard("FirstBuy", iRow).Value
                            sCardCost = Me.dgvNormalCard("CardCost", iRow).Value
                        End If
                        'modify code 004:end-------------------------------------------------------------------------
                        'modify code 011:start-------------------------------------------------------------------------
                        sBarCode = Me.dgvNormalCard("BarCode", iRow).Value.ToString
                        'modify code 011:end-------------------------------------------------------------------------

                        'modify code 046:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Then
                            sHolderName = Me.dgvNormalCard("HolderName", iRow).Value
                            sGender = Me.dgvNormalCard("Gender", iRow).Value
                            sHolderIdNo = Me.dgvNormalCard("HolderIdNo", iRow).Value
                            sMobile = Me.dgvNormalCard("Mobile", iRow).Value
                        End If
                        'modify code 046:end-------------------------------------------------------------------------

                        If dvTemp.Count > 0 Then
                            dvTemp.Sort = "CardNo"
                            sStart = dvTemp(0)("CardNo").ToString : sEnd = sStart : iCardQTY = 1
                            For iCard As Integer = 1 To dvTemp.Count - 1
                                If CLng(dvTemp(iCard)("CardNo").ToString) - CLng(sEnd) = 1 Then
                                    iCardQTY += 1
                                    sEnd = dvTemp(iCard)("CardNo").ToString
                                Else
                                    drCard = dtTempList.Rows.Add()
                                    drCard("RowID") = iRow + 1
                                    drCard("SecondID") = iCard - 1
                                    drCard("CardFeature") = sFeature
                                    drCard("StartCardNo") = ShoppingCardNo.GetFullCardNo(sStart)
                                    drCard("EndCardNo") = ShoppingCardNo.GetFullCardNo(sEnd)
                                    drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                                    drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                                    'modify code 004:start-------------------------------------------------------------------------
                                    drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                                    'modify code 004:end-------------------------------------------------------------------------

                                    'modify code 046:start-------------------------------------------------------------------------
                                    If bNewSalesBillType = 7 Then
                                        drCard("HolderName") = sHolderName
                                        drCard("Gender") = sGender
                                        drCard("HolderIdNo") = sHolderIdNo
                                        drCard("Mobile") = sMobile
                                    End If
                                    'modify code 046:end-------------------------------------------------------------------------

                                    If Me.dgvNormalCard("FaceValue", iRow).Value.ToString <> "" Then
                                        'modify code 011:start-------------------------------------------------------------------------
                                        drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                                        'modify code 011:end-------------------------------------------------------------------------
                                        drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                                        drCard("ReducedCardPayment") = 0
                                        If drSalesBill("SalesBillType") = 1 Then
                                            drCard("CardPayment") = 0
                                        Else
                                            drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value + Me.dgvNormalCard("CardCost", iRow).Value
                                        End If
                                        drCard("ChargedAMT") = drCard("FaceValue") * drCard("CardQTY")
                                        drCard("PayableAMT") = drCard("CardPayment") * drCard("CardQTY")
                                        drCard("CostAMT") = drCard("CardCost") * drCard("CardQTY")
                                    End If
                                    If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then drCard("PaymentDescription") = "请分配付款金额……"
                                    drCard.EndEdit()
                                    sStart = dvTemp(iCard)("CardNo").ToString
                                    sEnd = sStart
                                    iCardQTY = 1
                                End If
                            Next
                            drCard = dtTempList.Rows.Add()
                            drCard("RowID") = iRow + 1
                            drCard("SecondID") = dvTemp.Count
                            drCard("CardFeature") = sFeature
                            drCard("StartCardNo") = ShoppingCardNo.GetFullCardNo(sStart)
                            drCard("EndCardNo") = ShoppingCardNo.GetFullCardNo(sEnd)
                            drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                            drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                            'modify code 004:start-------------------------------------------------------------------------
                            drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                            sFirstBuy = Me.dgvNormalCard("FirstBuy", iRow).Value
                            sCardCost = Me.dgvNormalCard("CardCost", iRow).Value
                            'modify code 004:end-------------------------------------------------------------------------

                            'modify code 046:start-------------------------------------------------------------------------
                            If bNewSalesBillType = 7 Then
                                drCard("HolderName") = sHolderName
                                drCard("Gender") = sGender
                                drCard("HolderIdNo") = sHolderIdNo
                                drCard("Mobile") = sMobile
                            End If
                            'modify code 046:end-------------------------------------------------------------------------

                            If Me.dgvNormalCard("FaceValue", iRow).Value.ToString <> "" Then
                                'modify code 011:start-------------------------------------------------------------------------
                                drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                                'modify code 011:end-------------------------------------------------------------------------
                                drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                                drCard("ReducedCardPayment") = 0
                                If drSalesBill("SalesBillType") = 1 Then
                                    drCard("CardPayment") = 0
                                Else
                                    drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value + Me.dgvNormalCard("CardCost", iRow).Value
                                End If
                                drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                                drCard("PayableAMT") = drCard("CardPayment") * drCard("CardQTY")
                                drCard("CostAMT") = drCard("CardCost") * drCard("CardQTY")
                                If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then drCard("PaymentDescription") = "请分配付款金额……"
                            End If
                            drCard.EndEdit()
                        End If
                        dtTemp.Dispose() : dtTemp = Nothing : dvTemp.Dispose() : dvTemp = Nothing
                    End If
                    blNeedResetRow = True
                End If
            End If
        Next

        sFeature = Me.dgvNormalCard("CardFeature", iCurrentRow).Value.ToString
        If blNeedResetRow Then
            drCard = dtTempList.Rows.Add()
            drCard("RowID") = iCurrentRow + 1
            drCard("SecondID") = 0
            drCard("CardFeature") = sFeature
            drCard("StartCardNo") = sStartCardNo
            drCard("EndCardNo") = sEndCardNo
            drCard("CardQTY") = CLng(sEndCardNo.Substring(0, 18)) - CLng(sStartCardNo.Substring(0, 18)) + 1
            'modify code 004:start-------------------------------------------------------------------------
            'Dim dmCost As Decimal = dtCardCost.Rows(0)("CardCost")
            'If dmCost > 0 Then
            '    For iRow As Integer = Me.dgvNormalCard.RowCount - 1 To 0 Step -1
            '        If Me.dgvNormalCard("CardFeature", iRow).Value.ToString = "磁条卡" Then
            '            dmCost = Me.dgvNormalCard("CardCost", iRow).Value
            '            Exit For
            '        End If
            '    Next
            'End If
            'drCard("CardCost") = dmCost
            drCard("CardCost") = sCardCost
            drCard("FirstBuy") = sFirstBuy
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 011:start-------------------------------------------------------------------------
            drCard("BarCode") = sBarCode
            'modify code 011:end-------------------------------------------------------------------------

            'modify code 046:start-------------------------------------------------------------------------
            If bNewSalesBillType = 7 Then
                drCard("HolderName") = sHolderName
                drCard("Gender") = sGender
                drCard("HolderIdNo") = sHolderIdNo
                drCard("Mobile") = sMobile
            End If
            'modify code 046:end-------------------------------------------------------------------------

            If Me.dgvNormalCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iCurrentRow).Value
                drCard("ReducedCardPayment") = 0
                If drSalesBill("SalesBillType") = 1 Then
                    drCard("CardPayment") = 0
                Else
                    drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost")
                End If
                drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                drCard("PayableAMT") = drCard("CardQTY") * drCard("CardPayment")
                drCard("CostAMT") = drCard("CardCost") * drCard("CardQTY")
                If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then drCard("PaymentDescription") = "请分配付款金额……"
            End If
            drCard.EndEdit()
            Dim bCurrentColumn As Byte = Me.dgvNormalCard.CurrentCell.ColumnIndex, drFinalCard As DataRow
            dtNormalCard.Rows.Clear()
            iRows = 1
            For Each drCard In dtTempList.Select("", "RowID,SecondID")
                drFinalCard = dtNormalCard.Rows.Add
                drFinalCard("RowID") = iRows
                For bColumn As Byte = 1 To dtNormalCard.Columns.Count - 1
                    drFinalCard(bColumn) = drCard(bColumn)
                Next
                drFinalCard.EndEdit()
                iRows += 1
            Next
            dtNormalCard.Rows.Add(iRows)
            For Each dr As DataGridViewRow In Me.dgvNormalCard.Rows
                If dr.Cells("StartCardNo").Value.ToString = sStartCardNo Then
                    iCurrentRow = dr.Index
                    Me.dgvNormalCard(bCurrentColumn, iCurrentRow).Selected = True : Exit For
                End If
            Next
        Else
            Me.dgvNormalCard("CardQTY", iCurrentRow).Value = CLng(sEndCardNo.Substring(0, 18)) - CLng(sStartCardNo.Substring(0, 18)) + 1
            If Me.dgvNormalCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                If drSalesBill("SalesBillType") = 1 Then
                    Me.dgvNormalCard("CardPayment", iCurrentRow).Value = 0
                Else
                    Me.dgvNormalCard("CardPayment", iCurrentRow).Value = Me.dgvNormalCard("FaceValue", iCurrentRow).Value + Me.dgvNormalCard("CardCost", iCurrentRow).Value
                End If
                Me.dgvNormalCard("ChargedAMT", iCurrentRow).Value = Me.dgvNormalCard("CardQTY", iCurrentRow).Value * Me.dgvNormalCard("FaceValue", iCurrentRow).Value
                Me.dgvNormalCard("PayableAMT", iCurrentRow).Value = Me.dgvNormalCard("CardQTY", iCurrentRow).Value * Me.dgvNormalCard("CardPayment", iCurrentRow).Value
                Me.dgvNormalCard("CostAMT", iCurrentRow).Value = Me.dgvNormalCard("CardQTY", iCurrentRow).Value * Me.dgvNormalCard("CardCost", iCurrentRow).Value
            End If
            If Me.dgvNormalCard.CurrentCell.RowIndex = Me.dgvNormalCard.RowCount - 1 Then dtNormalCard.Rows.Add(iRows + 2)
        End If

        For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
            'modify code 011:start-------------------------------------------------------------------------
            'drNormal.Cells("FaceValue").ReadOnly = (drNormal.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drNormal.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0) 
            drNormal.Cells("FaceValue").ReadOnly = (drNormal.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drNormal.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0) OrElse (drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("StartCardNo").Value.ToString.Substring(0, 6) = "233660" AndAlso drNormal.Cells("FirstBuy").Value.ToString = "购卡")
            drNormal.Cells("BarCode").ReadOnly = Not (drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("StartCardNo").Value.ToString.Substring(0, 6) = "233660" AndAlso drNormal.Cells("FirstBuy").Value.ToString = "购卡")
            'modify code 011:end-------------------------------------------------------------------------
            'modify code 004:start-------------------------------------------------------------------------
            'drNormal.Cells("CardCost").ReadOnly = (drNormal.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drNormal.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0)
            drNormal.Cells("CardCost").ReadOnly = False
            'modify code 004:end-------------------------------------------------------------------------
        Next

        'modify code 004:start-------------------------------------------------------------------------
        'If dmCardCost > 0 AndAlso dtNormalCard.Select("Isnull(CardFeature,'磁条卡') In ('磁条卡','礼品卡')").Length > 2 Then
        '    Me.dgvNormalCard.Columns("CardCost").ToolTipText = "点击该标题可为各行指定相同的卡成本"
        'Else
        '    Me.dgvNormalCard.Columns("CardCost").ToolTipText = ""
        'End If
        'modify code 004:end-------------------------------------------------------------------------

        'modify code 004:start-------------------------------------------------------------------------
        For i As Integer = 0 To Me.dtNormalCard.Rows.Count - 2
            Me.dgvNormalCard("FirstBuy", i).Value = SetFirstBuy(dtNormalCard.Rows(i).Item("StartCardNo").ToString, i, dtNormalCard.Rows(i).Item("FirstBuy").ToString)
            Me.dgvNormalCard("CardCost", i).Value = SetCardCost(dtNormalCard.Rows(i).Item("StartCardNo").ToString, dtNormalCard.Rows(i).Item("FirstBuy").ToString, i, dtNormalCard.Rows(i).Item("CardCost").ToString)
        Next
        'modify code 004:end-------------------------------------------------------------------------

        If Me.splitList.Panel2Collapsed = False Then Me.ResetCardListLayout()
        Me.NormalCardSummary()

        dtTempList.Dispose() : dtTempList = Nothing
    End Sub

    Private Sub ConfigRebateCardRow()
        Dim iRows As Integer = Me.dgvRebateCard.RowCount - 1, iCurrentRow As Integer = Me.dgvRebateCard.CurrentRow.Index, sStartCardNo As String = Me.dgvRebateCard("StartCardNo", iCurrentRow).Value.ToString, sEndCardNo As String = Me.dgvRebateCard("EndCardNo", iCurrentRow).Value.ToString
        If sStartCardNo > sEndCardNo Then
            Me.dgvRebateCard.EndEdit() : sStartCardNo = sEndCardNo : sEndCardNo = Me.dgvRebateCard("StartCardNo", iCurrentRow).Value.ToString
            Me.dgvRebateCard("StartCardNo", iCurrentRow).Value = sStartCardNo : Me.dgvRebateCard("EndCardNo", iCurrentRow).Value = sEndCardNo
        End If

        Dim dtTempList As DataTable = dtRebateCard.DefaultView.ToTable, sFeature As String, sStart As String, sEnd As String, drCard As DataRow, blNeedResetRow As Boolean = False
        dtTempList.Rows.Clear()
        dtTempList.Columns.Add("SecondID", System.Type.GetType("System.Byte"))
        For iRow As Integer = 0 To iRows
            If iRow <> iCurrentRow AndAlso Me.dgvRebateCard("StartCardNo", iRow).Value.ToString <> "" Then
                sFeature = Me.dgvRebateCard("CardFeature", iRow).Value.ToString
                sStart = Me.dgvRebateCard("StartCardNo", iRow).Value.ToString : sEnd = Me.dgvRebateCard("EndCardNo", iRow).Value.ToString
                If sStart.IndexOf("8") = 0 OrElse sStart.IndexOf("9") = 0 Then '纸卡,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvRebateCard("CardQTY", iRow).Value
                    drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                    drCard("ChargedAMT") = Me.dgvRebateCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = 0
                ElseIf sStartCardNo > sEnd OrElse sEndCardNo < sStart Then '该行卡号范围落在当前修改行之外,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvRebateCard("CardQTY", iRow).Value
                    drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                    drCard("ChargedAMT") = Me.dgvRebateCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = 0
                ElseIf sStartCardNo < sStart AndAlso sEnd < sEndCardNo Then '该行卡号范围完全落在当前修改行之内,将被删除
                    blNeedResetRow = True
                Else '该行卡号范围部分落在当前修改行之内,将被截断
                    Dim dtTemp As New DataTable
                    dtTemp.Columns.Add("CardNo", System.Type.GetType("System.String"))
                    Dim dvTemp As New DataView(dtTemp), drTemp As DataRowView
                    sStart = sStart.Substring(0, 18)
                    Dim iCardQTY As Integer = Me.dgvRebateCard("CardQTY", iRow).Value - 1
                    For iCard As Integer = 0 To iCardQTY
                        sEnd = (CLng(sStart) + iCard).ToString
                        If sEnd < sStartCardNo.Substring(0, 18) OrElse sEnd > sEndCardNo.Substring(0, 18) Then
                            drTemp = dvTemp.AddNew
                            drTemp(0) = sEnd
                            drTemp.EndEdit()
                        End If
                    Next
                    dtTemp.AcceptChanges()

                    If dvTemp.Count > 0 Then
                        dvTemp.Sort = "CardNo"
                        sStart = dvTemp(0)("CardNo").ToString : sEnd = sStart : iCardQTY = 1
                        For iCard As Integer = 1 To dvTemp.Count - 1
                            If CLng(dvTemp(iCard)("CardNo").ToString) - CLng(sEnd) = 1 Then
                                iCardQTY += 1
                                sEnd = dvTemp(iCard)("CardNo").ToString
                            Else
                                drCard = dtTempList.Rows.Add()
                                drCard("RowID") = iRow + 1
                                drCard("SecondID") = iCard - 1
                                drCard("CardFeature") = sFeature
                                drCard("StartCardNo") = ShoppingCardNo.GetFullCardNo(sStart)
                                drCard("EndCardNo") = ShoppingCardNo.GetFullCardNo(sEnd)
                                drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                                If Me.dgvRebateCard("FaceValue", iRow).Value.ToString <> "" Then
                                    drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                                    drCard("ChargedAMT") = drCard("FaceValue") * drCard("CardQTY")
                                    drCard("PayableAMT") = 0
                                End If
                                drCard.EndEdit()
                                sStart = dvTemp(iCard)("CardNo").ToString
                                sEnd = sStart
                                iCardQTY = 1
                            End If
                        Next
                        drCard = dtTempList.Rows.Add()
                        drCard("RowID") = iRow + 1
                        drCard("SecondID") = dvTemp.Count
                        drCard("CardFeature") = sFeature
                        drCard("StartCardNo") = ShoppingCardNo.GetFullCardNo(sStart)
                        drCard("EndCardNo") = ShoppingCardNo.GetFullCardNo(sEnd)
                        drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                        If Me.dgvRebateCard("FaceValue", iRow).Value.ToString <> "" Then
                            drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                            drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                            drCard("PayableAMT") = 0
                        End If
                        drCard.EndEdit()
                    End If
                    dtTemp.Dispose() : dtTemp = Nothing : dvTemp.Dispose() : dvTemp = Nothing
                    blNeedResetRow = True
                End If
            End If
        Next

        sFeature = Me.dgvRebateCard("CardFeature", iCurrentRow).Value.ToString
        If blNeedResetRow Then
            drCard = dtTempList.Rows.Add()
            drCard("RowID") = iCurrentRow + 1
            drCard("SecondID") = 0
            drCard("CardFeature") = sFeature
            drCard("StartCardNo") = sStartCardNo
            drCard("EndCardNo") = sEndCardNo
            drCard("CardQTY") = CLng(sEndCardNo.Substring(0, 18)) - CLng(sStartCardNo.Substring(0, 18)) + 1
            If Me.dgvRebateCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iCurrentRow).Value
                drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                drCard("PayableAMT") = 0
            End If
            drCard.EndEdit()
            Dim bCurrentColumn As Byte = Me.dgvRebateCard.CurrentCell.ColumnIndex, drFinalCard As DataRow
            dtRebateCard.Rows.Clear()
            iRows = 1
            For Each drCard In dtTempList.Select("", "RowID,SecondID")
                drFinalCard = dtRebateCard.Rows.Add
                drFinalCard("RowID") = iRows
                For bColumn As Byte = 1 To dtRebateCard.Columns.Count - 1
                    If dtRebateCard.Columns(bColumn).ReadOnly = False Then drFinalCard(bColumn) = drCard(bColumn)
                Next
                drFinalCard.EndEdit()
                iRows += 1
            Next
            dtRebateCard.Rows.Add(iRows)
            For Each dr As DataGridViewRow In Me.dgvRebateCard.Rows
                If dr.Cells("StartCardNo").Value.ToString = sStartCardNo Then
                    iCurrentRow = dr.Index
                    Me.dgvRebateCard(bCurrentColumn, iCurrentRow).Selected = True : Exit For
                End If
            Next
        Else
            Me.dgvRebateCard("CardQTY", iCurrentRow).Value = CLng(sEndCardNo.Substring(0, 18)) - CLng(sStartCardNo.Substring(0, 18)) + 1
            If Me.dgvRebateCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                Me.dgvRebateCard("ChargedAMT", iCurrentRow).Value = Me.dgvRebateCard("CardQTY", iCurrentRow).Value * Me.dgvRebateCard("FaceValue", iCurrentRow).Value
                Me.dgvRebateCard("PayableAMT", iCurrentRow).Value = 0
            End If
            If Me.dgvRebateCard.CurrentCell.RowIndex = Me.dgvRebateCard.RowCount - 1 Then dtRebateCard.Rows.Add(iRows + 2)
        End If

        For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
            drRebate.Cells("FaceValue").ReadOnly = (drRebate.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drRebate.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0)
           'modify code 046,050:start-------------------------------------------------------------------------
            If drRebate.Cells("StartCardNo").Value.ToString <> "" Then
                'If getSignCardList(drRebate.Cells("StartCardNo").Value.ToString).Rows.Count > 0 OrElse (bNewSalesBillType = 7 AndAlso dtNormalCard.Select("'" & drRebate.Cells("StartCardNo").Value.ToString & "'>=StartCardNo And '" & drRebate.Cells("StartCardNo").Value.ToString & "'<=EndCardNo").Length > 0) Then
                'If dtSignCardRangeAll.Select("CardNo='" & drRebate.Cells("StartCardNo").Value.ToString & "'").Length > 0 OrElse (bNewSalesBillType = 7 AndAlso dtNormalCard.Select("'" & drRebate.Cells("StartCardNo").Value.ToString & "'>=StartCardNo And '" & drRebate.Cells("StartCardNo").Value.ToString & "'<=EndCardNo").Length > 0) Then
                'If dtSignCardRangeNew.Select("CardNo='" & drRebate.Cells("StartCardNo").Value.ToString & "'").Length > 0 OrElse (bNewSalesBillType = 7 AndAlso dtNormalCard.Select("'" & drRebate.Cells("StartCardNo").Value.ToString & "'>=StartCardNo And '" & drRebate.Cells("StartCardNo").Value.ToString & "'<=EndCardNo").Length > 0) Then
                If drRebate.Cells("StartCardNo").Value.ToString.IndexOf("233661") = 0 Then
                    drRebate.Cells("IsSignCard").Value = "是"
                Else
                    drRebate.Cells("IsSignCard").Value = "否"
                End If
            End If
            'modify code 046,050:end-------------------------------------------------------------------------
        Next

        Me.ResetCardListLayout()
        Me.RebateCardSummary()

        dtTempList.Dispose() : dtTempList = Nothing
    End Sub

    Private Sub ConfigNormalPaperCardRow()
        Dim iRows As Integer = Me.dgvNormalCard.RowCount - 1, iCurrentRow As Integer = Me.dgvNormalCard.CurrentRow.Index, sStartCardNo As String = Me.dgvNormalCard("StartCardNo", iCurrentRow).Value.ToString, sEndCardNo As String = Me.dgvNormalCard("EndCardNo", iCurrentRow).Value.ToString
        'modify code 004:start-------------------------------------------------------------------------
        Dim sFirstBuy As String = "", sCardCost As String = ""
        'modify code 004:end-------------------------------------------------------------------------
        'modify code 011:start-------------------------------------------------------------------------
        Dim sBarCode As String = ""
        'modify code 011:end-------------------------------------------------------------------------
        If sStartCardNo > sEndCardNo Then
            Me.dgvNormalCard.EndEdit() : sStartCardNo = sEndCardNo : sEndCardNo = Me.dgvNormalCard("StartCardNo", iCurrentRow).Value.ToString
            Me.dgvNormalCard("StartCardNo", iCurrentRow).Value = sStartCardNo : Me.dgvNormalCard("EndCardNo", iCurrentRow).Value = sEndCardNo
        End If

        Dim dtTempList As DataTable = dtNormalCard.DefaultView.ToTable, sFeature As String, sStart As String, sEnd As String, drCard As DataRow, blNeedResetRow As Boolean = False
        dtTempList.Rows.Clear()
        dtTempList.Columns.Add("SecondID", System.Type.GetType("System.Int16"))
        For iRow As Integer = 0 To iRows
            If iRow <> iCurrentRow AndAlso Me.dgvNormalCard("StartCardNo", iRow).Value.ToString <> "" Then
                sFeature = Me.dgvNormalCard("CardFeature", iRow).Value.ToString
                sStart = Me.dgvNormalCard("StartCardNo", iRow).Value.ToString : sEnd = Me.dgvNormalCard("EndCardNo", iRow).Value.ToString
                If sStart.IndexOf("2") = 0 Then '塑料卡行,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvNormalCard("CardQTY", iRow).Value
                    'modify code 011:start-------------------------------------------------------------------------
                    drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                    'modify code 011:end-------------------------------------------------------------------------
                    drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                    drCard("ReducedCardPayment") = 0
                    drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                    'modify code 004:start-------------------------------------------------------------------------
                    drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                    'modify code 004:end-------------------------------------------------------------------------
                    drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value + Me.dgvNormalCard("CardCost", iRow).Value
                    drCard("ChargedAMT") = Me.dgvNormalCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = Me.dgvNormalCard("PayableAMT", iRow).Value
                    drCard("PaymentDescription") = Me.dgvNormalCard("PaymentDescription", iRow).Value
                    drCard("CostAMT") = Me.dgvNormalCard("CostAMT", iRow).Value
                ElseIf sStartCardNo > sEnd OrElse sEndCardNo < sStart Then '该行卡号范围落在当前修改行之外,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvNormalCard("CardQTY", iRow).Value
                    'modify code 011:start-------------------------------------------------------------------------
                    drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                    'modify code 011:end-------------------------------------------------------------------------
                    drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                    drCard("ReducedCardPayment") = 0
                    drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                    'modify code 004:start-------------------------------------------------------------------------
                    drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                    'modify code 004:end-------------------------------------------------------------------------
                    drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value
                    drCard("ChargedAMT") = Me.dgvNormalCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = Me.dgvNormalCard("PayableAMT", iRow).Value
                    drCard("PaymentDescription") = Me.dgvNormalCard("PaymentDescription", iRow).Value
                    drCard("CostAMT") = 0
                Else
                    If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then
                        For Each drRowPayment As DataRow In dtRowPayment.Select("CardRowID=" & Me.dgvNormalCard("RowID", iRow).Value.ToString)
                            drRowPayment.Delete() : drRowPayment.AcceptChanges()
                        Next
                    End If
                    If sStartCardNo < sStart AndAlso sEnd < sEndCardNo Then '该行卡号范围完全落在当前修改行之内,将被删除
                        'modify code 004:start-------------------------------------------------------------------------
                        sFirstBuy = Me.dgvNormalCard("FirstBuy", iCurrentRow).Value
                        sCardCost = Me.dgvNormalCard("CardCost", iCurrentRow).Value
                        'modify code 004:end-------------------------------------------------------------------------
                        'modify code 011:start-------------------------------------------------------------------------
                        sBarCode = Me.dgvNormalCard("BarCode", iCurrentRow).Value.ToString
                        'modify code 011:end-------------------------------------------------------------------------
                        blNeedResetRow = True
                    Else '该行卡号范围部分落在当前修改行之内,将被截断
                        Dim dtTemp As New DataTable
                        dtTemp.Columns.Add("CardNo", System.Type.GetType("System.String"))
                        Dim dvTemp As New DataView(dtTemp), drTemp As DataRowView
                        Dim iCardQTY As Integer = Me.dgvNormalCard("CardQTY", iRow).Value - 1
                        For iCard As Integer = 0 To iCardQTY
                            sEnd = (CLng(sStart) + iCard).ToString
                            If sEnd < sStartCardNo OrElse sEnd > sEndCardNo Then
                                drTemp = dvTemp.AddNew
                                drTemp(0) = sEnd
                                drTemp.EndEdit()
                            End If
                        Next
                        dtTemp.AcceptChanges()

                        'modify code 004:start-------------------------------------------------------------------------
                        If dvTemp.Count = 0 Then
                            sFirstBuy = Me.dgvNormalCard("FirstBuy", iRow).Value
                            sCardCost = Me.dgvNormalCard("CardCost", iRow).Value
                        End If
                        'modify code 004:end-------------------------------------------------------------------------
                        'modify code 011:start-------------------------------------------------------------------------
                        sBarCode = Me.dgvNormalCard("BarCode", iRow).Value.ToString
                        'modify code 011:end-------------------------------------------------------------------------
                        If dvTemp.Count > 0 Then
                            dvTemp.Sort = "CardNo"
                            sStart = dvTemp(0)("CardNo").ToString : sEnd = sStart : iCardQTY = 1
                            For iCard As Integer = 1 To dvTemp.Count - 1
                                If CLng(dvTemp(iCard)("CardNo").ToString) - CLng(sEnd) = 1 Then
                                    iCardQTY += 1
                                    sEnd = dvTemp(iCard)("CardNo").ToString
                                Else
                                    drCard = dtTempList.Rows.Add()
                                    drCard("RowID") = iRow + 1
                                    drCard("SecondID") = iCard - 1
                                    drCard("CardFeature") = sFeature
                                    drCard("StartCardNo") = sStart
                                    drCard("EndCardNo") = sEnd
                                    drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                                    'modify code 004:start-------------------------------------------------------------------------
                                    'drCard("CardCost") = 0
                                    drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                                    drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                                    'modify code 004:end-------------------------------------------------------------------------
                                    If Me.dgvNormalCard("FaceValue", iRow).Value.ToString <> "" Then
                                        'modify code 011:start-------------------------------------------------------------------------
                                        drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                                        'modify code 011:end-------------------------------------------------------------------------
                                        drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                                        drCard("ReducedCardPayment") = 0
                                        'modify code 004:start-------------------------------------------------------------------------
                                        'drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value
                                        drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value + Me.dgvNormalCard("CardCost", iRow).Value
                                        'modify code 004:end-------------------------------------------------------------------------
                                        drCard("ChargedAMT") = drCard("FaceValue") * drCard("CardQTY")
                                        drCard("PayableAMT") = drCard("CardPayment") * drCard("CardQTY")
                                        drCard("CostAMT") = 0
                                        If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then drCard("PaymentDescription") = "请分配付款金额……"
                                    End If
                                    drCard.EndEdit()
                                    sStart = dvTemp(iCard)("CardNo").ToString
                                    sEnd = sStart
                                    iCardQTY = 1
                                End If
                            Next
                            drCard = dtTempList.Rows.Add()
                            drCard("RowID") = iRow + 1
                            drCard("SecondID") = dvTemp.Count
                            drCard("CardFeature") = sFeature
                            drCard("StartCardNo") = sStart
                            drCard("EndCardNo") = sEnd
                            drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                            'modify code 004:start-------------------------------------------------------------------------
                            'drCard("CardCost") = 0
                            drCard("CardCost") = Me.dgvNormalCard("CardCost", iRow).Value
                            drCard("FirstBuy") = Me.dgvNormalCard("FirstBuy", iRow).Value
                            sFirstBuy = Me.dgvNormalCard("FirstBuy", iRow).Value
                            sCardCost = Me.dgvNormalCard("CardCost", iRow).Value
                            'modify code 004:end-------------------------------------------------------------------------
                            If Me.dgvNormalCard("FaceValue", iRow).Value.ToString <> "" Then
                                'modify code 011:start-------------------------------------------------------------------------
                                drCard("BarCode") = Me.dgvNormalCard("BarCode", iRow).Value
                                'modify code 011:end-------------------------------------------------------------------------
                                drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iRow).Value
                                drCard("ReducedCardPayment") = 0
                                'modify code 004:start-------------------------------------------------------------------------
                                'drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value
                                drCard("CardPayment") = Me.dgvNormalCard("FaceValue", iRow).Value + Me.dgvNormalCard("CardCost", iRow).Value
                                'modify code 004:end-------------------------------------------------------------------------
                                drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                                drCard("PayableAMT") = drCard("CardPayment") * drCard("CardQTY")
                                drCard("CostAMT") = 0
                                If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then drCard("PaymentDescription") = "请分配付款金额……"
                            End If
                            drCard.EndEdit()
                        End If
                        dtTemp.Dispose() : dtTemp = Nothing : dvTemp.Dispose() : dvTemp = Nothing
                    End If
                    blNeedResetRow = True
                End If
            End If
        Next

        sFeature = Me.dgvNormalCard("CardFeature", iCurrentRow).Value.ToString
        If blNeedResetRow Then
            drCard = dtTempList.Rows.Add()
            drCard("RowID") = iCurrentRow + 1
            drCard("SecondID") = 0
            drCard("CardFeature") = sFeature
            drCard("StartCardNo") = sStartCardNo
            drCard("EndCardNo") = sEndCardNo
            drCard("CardQTY") = CLng(sEndCardNo) - CLng(sStartCardNo) + 1
            'modify code 004:start-------------------------------------------------------------------------
            'drCard("CardCost") = 0
            drCard("CardCost") = sCardCost
            drCard("FirstBuy") = sFirstBuy
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 011:start-------------------------------------------------------------------------
            drCard("BarCode") = sBarCode
            'modify code 011:end-------------------------------------------------------------------------
            If Me.dgvNormalCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                drCard("FaceValue") = Me.dgvNormalCard("FaceValue", iCurrentRow).Value
                drCard("ReducedCardPayment") = 0
                drCard("CardPayment") = drCard("FaceValue") + drCard("CardCost")
                drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                drCard("PayableAMT") = drCard("CardQTY") * drCard("CardPayment")
                drCard("CostAMT") = 0
                If bNewSalesBillType <> 1 AndAlso dtSelectablePayment.Rows.Count > 1 Then drCard("PaymentDescription") = "请分配付款金额……"
            End If
            drCard.EndEdit()
            Dim bCurrentColumn As Byte = Me.dgvNormalCard.CurrentCell.ColumnIndex, drFinalCard As DataRow
            dtNormalCard.Rows.Clear()
            iRows = 1
            For Each drCard In dtTempList.Select("", "RowID,SecondID")
                drFinalCard = dtNormalCard.Rows.Add
                drFinalCard("RowID") = iRows
                For bColumn As Byte = 1 To dtNormalCard.Columns.Count - 1
                    drFinalCard(bColumn) = drCard(bColumn)
                Next
                drFinalCard.EndEdit()
                iRows += 1
            Next
            dtNormalCard.Rows.Add(iRows)
            For Each dr As DataGridViewRow In Me.dgvNormalCard.Rows
                If dr.Cells("StartCardNo").Value.ToString = sStartCardNo Then
                    iCurrentRow = dr.Index
                    Me.dgvNormalCard(bCurrentColumn, iCurrentRow).Selected = True : Exit For
                End If
            Next
        Else
            Me.dgvNormalCard("CardQTY", iCurrentRow).Value = CLng(sEndCardNo) - CLng(sStartCardNo) + 1
            If Me.dgvNormalCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                If drSalesBill("SalesBillType") = 1 Then
                    Me.dgvNormalCard("CardPayment", iCurrentRow).Value = 0
                Else
                    Me.dgvNormalCard("CardPayment", iCurrentRow).Value = Me.dgvNormalCard("FaceValue", iCurrentRow).Value + Me.dgvNormalCard("CardCost", iCurrentRow).Value
                End If
                Me.dgvNormalCard("ChargedAMT", iCurrentRow).Value = Me.dgvNormalCard("CardQTY", iCurrentRow).Value * Me.dgvNormalCard("FaceValue", iCurrentRow).Value
                Me.dgvNormalCard("PayableAMT", iCurrentRow).Value = Me.dgvNormalCard("CardQTY", iCurrentRow).Value * Me.dgvNormalCard("CardPayment", iCurrentRow).Value
                Me.dgvNormalCard("CostAMT", iCurrentRow).Value = Me.dgvNormalCard("CardQTY", iCurrentRow).Value * Me.dgvNormalCard("CardCost", iCurrentRow).Value
            End If
            If Me.dgvNormalCard.CurrentCell.RowIndex = Me.dgvNormalCard.RowCount - 1 Then dtNormalCard.Rows.Add(iRows + 2)
        End If

        For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
            'modify code 011:start-------------------------------------------------------------------------
            'drNormal.Cells("FaceValue").ReadOnly = (drNormal.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drNormal.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0)
            drNormal.Cells("FaceValue").ReadOnly = (drNormal.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drNormal.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0) OrElse (drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("StartCardNo").Value.ToString.Substring(0, 6) = "233660" AndAlso drNormal.Cells("FirstBuy").Value.ToString = "购卡")
            drNormal.Cells("BarCode").ReadOnly = Not (drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("StartCardNo").Value.ToString.Substring(0, 6) = "233660" AndAlso drNormal.Cells("FirstBuy").Value.ToString = "购卡")
            'modify code 011:end-------------------------------------------------------------------------
            'modify code 004:start-------------------------------------------------------------------------
            'drNormal.Cells("CardCost").ReadOnly = drNormal.Cells("FaceValue").ReadOnly
            drNormal.Cells("CardCost").ReadOnly = False
            'modify code 004:end-------------------------------------------------------------------------
        Next

        'modify code 004:start-------------------------------------------------------------------------
        For i As Integer = 0 To Me.dtNormalCard.Rows.Count - 2
            Me.dgvNormalCard("FirstBuy", i).Value = SetFirstBuy(dtNormalCard.Rows(i).Item("StartCardNo").ToString, i, dtNormalCard.Rows(i).Item("FirstBuy").ToString)
            Me.dgvNormalCard("CardCost", i).Value = SetCardCost(dtNormalCard.Rows(i).Item("StartCardNo").ToString, dtNormalCard.Rows(i).Item("FirstBuy").ToString, i, dtNormalCard.Rows(i).Item("CardCost").ToString)
        Next
        'modify code 004:end-------------------------------------------------------------------------

        If Me.splitList.Panel2Collapsed = False Then Me.ResetCardListLayout()
        Me.NormalCardSummary()

        dtTempList.Dispose() : dtTempList = Nothing
    End Sub

    Private Sub ConfigRebatePaperCardRow()
        Dim iRows As Integer = Me.dgvRebateCard.RowCount - 1, iCurrentRow As Integer = Me.dgvRebateCard.CurrentRow.Index, sStartCardNo As String = Me.dgvRebateCard("StartCardNo", iCurrentRow).Value.ToString, sEndCardNo As String = Me.dgvRebateCard("EndCardNo", iCurrentRow).Value.ToString
        If sStartCardNo > sEndCardNo Then
            Me.dgvRebateCard.EndEdit() : sStartCardNo = sEndCardNo : sEndCardNo = Me.dgvRebateCard("StartCardNo", iCurrentRow).Value.ToString
            Me.dgvRebateCard("StartCardNo", iCurrentRow).Value = sStartCardNo : Me.dgvRebateCard("EndCardNo", iCurrentRow).Value = sEndCardNo
        End If

        Dim dtTempList As DataTable = dtRebateCard.DefaultView.ToTable, sFeature As String, sStart As String, sEnd As String, drCard As DataRow, blNeedResetRow As Boolean = False
        dtTempList.Rows.Clear()
        dtTempList.Columns.Add("SecondID", System.Type.GetType("System.Byte"))
        For iRow As Integer = 0 To iRows
            If iRow <> iCurrentRow AndAlso Me.dgvRebateCard("StartCardNo", iRow).Value.ToString <> "" Then
                sFeature = Me.dgvRebateCard("CardFeature", iRow).Value.ToString
                sStart = Me.dgvRebateCard("StartCardNo", iRow).Value.ToString : sEnd = Me.dgvRebateCard("EndCardNo", iRow).Value.ToString
                If sStart.IndexOf("2") = 0 Then '塑料卡,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvRebateCard("CardQTY", iRow).Value
                    drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                    drCard("ChargedAMT") = Me.dgvRebateCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = 0
                ElseIf sStartCardNo > sEnd OrElse sEndCardNo < sStart Then '该行卡号范围落在当前修改行之外,保留该行
                    drCard = dtTempList.Rows.Add()
                    drCard("RowID") = iRow + 1
                    drCard("SecondID") = 0
                    drCard("CardFeature") = sFeature
                    drCard("StartCardNo") = sStart
                    drCard("EndCardNo") = sEnd
                    drCard("CardQTY") = Me.dgvRebateCard("CardQTY", iRow).Value
                    drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                    drCard("ChargedAMT") = Me.dgvRebateCard("ChargedAMT", iRow).Value
                    drCard("PayableAMT") = 0
                ElseIf sStartCardNo < sStart AndAlso sEnd < sEndCardNo Then '该行卡号范围完全落在当前修改行之内,将被删除
                    blNeedResetRow = True
                Else '该行卡号范围部分落在当前修改行之内,将被截断
                    Dim dtTemp As New DataTable
                    dtTemp.Columns.Add("CardNo", System.Type.GetType("System.String"))
                    Dim dvTemp As New DataView(dtTemp), drTemp As DataRowView
                    Dim iCardQTY As Integer = Me.dgvRebateCard("CardQTY", iRow).Value - 1
                    For iCard As Integer = 0 To iCardQTY
                        sEnd = (CLng(sStart) + iCard).ToString
                        If sEnd < sStartCardNo OrElse sEnd > sEndCardNo Then
                            drTemp = dvTemp.AddNew
                            drTemp(0) = sEnd
                            drTemp.EndEdit()
                        End If
                    Next
                    dtTemp.AcceptChanges()

                    If dvTemp.Count > 0 Then
                        dvTemp.Sort = "CardNo"
                        sStart = dvTemp(0)("CardNo").ToString : sEnd = sStart : iCardQTY = 1
                        For iCard As Integer = 1 To dvTemp.Count - 1
                            If CLng(dvTemp(iCard)("CardNo").ToString) - CLng(sEnd) = 1 Then
                                iCardQTY += 1
                                sEnd = dvTemp(iCard)("CardNo").ToString
                            Else
                                drCard = dtTempList.Rows.Add()
                                drCard("RowID") = iRow + 1
                                drCard("SecondID") = iCard - 1
                                drCard("CardFeature") = sFeature
                                drCard("StartCardNo") = sStart
                                drCard("EndCardNo") = sEnd
                                drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                                If Me.dgvRebateCard("FaceValue", iRow).Value.ToString <> "" Then
                                    drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                                    drCard("ChargedAMT") = drCard("FaceValue") * drCard("CardQTY")
                                    drCard("PayableAMT") = 0
                                End If
                                drCard.EndEdit()
                                sStart = dvTemp(iCard)("CardNo").ToString
                                sEnd = sStart
                                iCardQTY = 1
                            End If
                        Next
                        drCard = dtTempList.Rows.Add()
                        drCard("RowID") = iRow + 1
                        drCard("SecondID") = dvTemp.Count
                        drCard("CardFeature") = sFeature
                        drCard("StartCardNo") = sStart
                        drCard("EndCardNo") = sEnd
                        drCard("CardQTY") = CLng(sEnd) - CLng(sStart) + 1
                        If Me.dgvRebateCard("FaceValue", iRow).Value.ToString <> "" Then
                            drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iRow).Value
                            drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                            drCard("PayableAMT") = 0
                        End If
                        drCard.EndEdit()
                    End If
                    dtTemp.Dispose() : dtTemp = Nothing : dvTemp.Dispose() : dvTemp = Nothing
                    blNeedResetRow = True
                End If
            End If
        Next

        sFeature = Me.dgvRebateCard("CardFeature", iCurrentRow).Value.ToString
        If blNeedResetRow Then
            drCard = dtTempList.Rows.Add()
            drCard("RowID") = iCurrentRow + 1
            drCard("SecondID") = 0
            drCard("CardFeature") = sFeature
            drCard("StartCardNo") = sStartCardNo
            drCard("EndCardNo") = sEndCardNo
            drCard("CardQTY") = CLng(sEndCardNo) - CLng(sStartCardNo) + 1
            If Me.dgvRebateCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                drCard("FaceValue") = Me.dgvRebateCard("FaceValue", iCurrentRow).Value
                drCard("ChargedAMT") = drCard("CardQTY") * drCard("FaceValue")
                drCard("PayableAMT") = 0
            End If
            drCard.EndEdit()
            Dim bCurrentColumn As Byte = Me.dgvRebateCard.CurrentCell.ColumnIndex, drFinalCard As DataRow
            dtRebateCard.Rows.Clear()
            iRows = 1
            For Each drCard In dtTempList.Select("", "RowID,SecondID")
                drFinalCard = dtRebateCard.Rows.Add
                drFinalCard("RowID") = iRows
                For bColumn As Byte = 1 To dtRebateCard.Columns.Count - 1
                    If dtRebateCard.Columns(bColumn).ReadOnly = False Then drFinalCard(bColumn) = drCard(bColumn)
                Next
                drFinalCard.EndEdit()
                iRows += 1
            Next
            dtRebateCard.Rows.Add(iRows)
            For Each dr As DataGridViewRow In Me.dgvRebateCard.Rows
                If dr.Cells("StartCardNo").Value.ToString = sStartCardNo Then
                    iCurrentRow = dr.Index
                    Me.dgvRebateCard(bCurrentColumn, iCurrentRow).Selected = True : Exit For
                End If
            Next
        Else
            Me.dgvRebateCard("CardFeature", iCurrentRow).Value = sFeature
            Me.dgvRebateCard("CardQTY", iCurrentRow).Value = CLng(sEndCardNo) - CLng(sStartCardNo) + 1
            If Me.dgvRebateCard("FaceValue", iCurrentRow).Value.ToString <> "" Then
                Me.dgvRebateCard("ChargedAMT", iCurrentRow).Value = Me.dgvRebateCard("CardQTY", iCurrentRow).Value * Me.dgvRebateCard("FaceValue", iCurrentRow).Value
                Me.dgvRebateCard("PayableAMT", iCurrentRow).Value = 0
            End If
            If Me.dgvRebateCard.CurrentCell.RowIndex = Me.dgvRebateCard.RowCount - 1 Then dtRebateCard.Rows.Add(iRows + 2)
        End If

        For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
            drRebate.Cells("FaceValue").ReadOnly = (drRebate.Cells("StartCardNo").Value.ToString.IndexOf("8") = 0 OrElse drRebate.Cells("StartCardNo").Value.ToString.IndexOf("9") = 0)
        Next

        Me.ResetCardListLayout()
        Me.RebateCardSummary()

        dtTempList.Dispose() : dtTempList = Nothing
    End Sub

    Private Function CheckPaperCardExisting(ByVal blCheckInNormal As Boolean, ByVal sStartCardNo As String, ByVal sEndCardNo As String) As Boolean
        Dim sStart As String, sEnd As String
        If blCheckInNormal Then
            For iRow As Integer = 0 To Me.dgvNormalCard.RowCount - 1
                If "|条码卡|充值券|公关券|活动券|".IndexOf("|" & Me.dgvNormalCard("CardFeature", iRow).Value.ToString & "|") > -1 Then
                    sStart = Me.dgvNormalCard("StartCardNo", iRow).Value.ToString
                    sEnd = Me.dgvNormalCard("EndCardNo", iRow).Value.ToString
                    If sStartCardNo > sEnd OrElse sEndCardNo < sStart Then '该行卡号范围落在当前修改行之外,没有重复
                    Else
                        Return True
                    End If
                End If
            Next
        Else
            For iRow As Integer = 0 To Me.dgvRebateCard.RowCount - 1
                If "|条码卡|充值券|营销券|".IndexOf("|" & Me.dgvRebateCard("CardFeature", iRow).Value.ToString & "|") > -1 Then
                    sStart = Me.dgvRebateCard("StartCardNo", iRow).Value.ToString
                    sEnd = Me.dgvRebateCard("EndCardNo", iRow).Value.ToString
                    If sStartCardNo > sEnd OrElse sEndCardNo < sStart Then '该行卡号范围落在当前修改行之外,没有重复
                    Else
                        Return True
                    End If
                End If
            Next
        End If

        Return False
    End Function

    Public Sub ResetInterfaceWhenSalesBillDeleted(ByVal drResult As DataRow)
        Me.drSalesBill("SalesBillState") = 9
        Me.drSalesBill("StateReason") = drResult("StateReason")
        Me.drSalesBill("CancellerName") = drResult("CancellerName")
        Me.drSalesBill("CancelledTime") = drResult("CancelledTime")
        Me.drSalesBill.AcceptChanges()

        If Me.pnlModifyNormalRebate.Visible Then
            Me.pnlModifyNormalRebate.Visible = False
            Me.flpNormalRebate.AutoSize = False
            Me.flpNormalRebate.AutoSize = True
            Me.grbNormalRebate.Height = Me.flpNormalRebate.Height + 55
        End If

        Me.lblSalesBillState.Font = New Font(Me.lblSalesBillState.Font, FontStyle.Bold)
        Me.lblSalesBillState.ForeColor = Color.Red
        Me.lblSalesBillState.Text = "此销售单已被取消！"
        If drSalesBill("StateReason").ToString <> "" Then Me.theTip.SetToolTip(Me.lblSalesBillState, "取消原因： " & drSalesBill("StateReason").ToString)
        Me.lblSalesBillRemarks.Text = "取消： " & drSalesBill("CancellerName").ToString & Chr(13) & "时间： " & Format(drSalesBill("CancelledTime"), "yyyy\/MM\/dd HH:mm")
        Me.pnlSalesBillStateDescription.Visible = True
        Me.grbSalesBillInfo.Height = 157

        Try
            Me.splitLayout.SplitterDistance = IIf(Me.flpLeftContainer.VerticalScroll.Visible, 264, 239)
        Catch
        End Try

        For Each drNormalCard As DataRow In dtNormalCard.Rows
            drNormalCard("ActivationState") = "已被取消"
            drNormalCard.AcceptChanges()
        Next

        For Each drRebateCard As DataRow In dtRebateCard.Rows
            drRebateCard("ActivationState") = "已被取消"
            drRebateCard.AcceptChanges()
        Next

        Me.btnModifyPaymentInfo.Visible = False

        Me.btnOK.Enabled = False
        Me.btnPrintTicket.Enabled = False
        Me.btnPrintInvoice.Enabled = False
        Me.btnViewActivation.Enabled = False

        If frmSalesBillManagement.IsHandleCreated Then
            Try
                frmSalesBillManagement.dvSalesBill.Table.Rows.Find(drSalesBill("SalesBillID").ToString).Delete()
                frmSalesBillManagement.dvSalesBill.Table.AcceptChanges()
            Catch
            End Try
        End If
    End Sub

    Public Sub ResetInterfaceWhenSalesBillCancelled(ByVal drResult As DataRow)
        Me.drSalesBill("SalesBillState") = 9
        Me.drSalesBill("StateReason") = drResult("StateReason")
        Me.drSalesBill("CancellerID") = frmMain.sLoginUserID
        Me.drSalesBill("CancellerName") = drResult("CancellerName")
        Me.drSalesBill("CancelledTime") = drResult("CancelledTime")
        Me.drSalesBill.AcceptChanges()

        If Me.pnlModifyNormalRebate.Visible Then
            Me.pnlModifyNormalRebate.Visible = False
            Me.flpNormalRebate.AutoSize = False
            Me.flpNormalRebate.AutoSize = True
            Me.grbNormalRebate.Height = Me.flpNormalRebate.Height + 55
        End If

        Me.lblSalesBillState.Font = New Font(Me.lblSalesBillState.Font, FontStyle.Bold)
        Me.lblSalesBillState.ForeColor = Color.Red
        Me.lblSalesBillState.Text = "等待确认取消"
        If drSalesBill("StateReason").ToString <> "" Then Me.theTip.SetToolTip(Me.lblSalesBillState, "申请取消原因： " & drSalesBill("StateReason").ToString)
        Me.lblSalesBillRemarks.Text = "申请： " & drSalesBill("CancellerName").ToString & Chr(13) & "时间： " & Format(drSalesBill("CancelledTime"), "yyyy\/MM\/dd HH:mm")
        Me.pnlSalesBillStateDescription.Visible = True
        Me.grbSalesBillInfo.Height = 157

        Try
            Me.splitLayout.SplitterDistance = IIf(Me.flpLeftContainer.VerticalScroll.Visible, 264, 239)
        Catch
        End Try

        If Me.flpLeftContainer.VerticalScroll.Visible = True Then
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
        End If

        For Each drNormalCard As DataRow In dtNormalCard.Rows
            drNormalCard("ActivationState") = "等待取消"
            drNormalCard("StateReason") = drSalesBill("StateReason").ToString
            drNormalCard.AcceptChanges()
        Next
        If drSalesBill("StateReason").ToString <> "" Then Me.dgvNormalCard.Columns("StateReason").Visible = True

        For Each drRebateCard As DataRow In dtRebateCard.Rows
            drRebateCard("ActivationState") = "等待取消"
            drRebateCard("StateReason") = drSalesBill("StateReason").ToString
            drRebateCard.AcceptChanges()
        Next
        If drSalesBill("StateReason").ToString <> "" Then Me.dgvRebateCard.Columns("StateReason").Visible = True

        If frmSalesBillManagement.IsHandleCreated Then
            Try
                Dim currentSalesBill As DataRow = frmSalesBillManagement.dvSalesBill.Table.Rows.Find(drSalesBill("SalesBillID").ToString)
                currentSalesBill("SalesBillState") = "等待取消"
                currentSalesBill.AcceptChanges()
                currentSalesBill = Nothing
                If frmSalesBillManagement.dgvList.CurrentRow IsNot Nothing Then
                    frmSalesBillManagement.dgvList.CurrentRow.Selected = False
                    frmSalesBillManagement.dgvList.CurrentRow.Selected = True
                End If
            Catch
            End Try
        End If

        Me.btnModifyPaymentInfo.Visible = False

        Me.btnPrintTicket.Enabled = False
        Me.btnPrintInvoice.Enabled = False
    End Sub

    Public Function SaveChanges() As Boolean
        If Not Me.btnOK.Enabled Then Return False

        'modify code 003:start-------------------------------------------------------------------------
        If dgvNormalCard.RowCount = 1 And dgvNormalCard("StartCardNo", 0).Value.ToString = String.Empty _
        And dgvRebateCard.RowCount = 1 And dgvRebateCard("StartCardNo", 0).Value.ToString = String.Empty Then
            MessageBox.Show("对不起！卡信息为空，不可销售。    ", "您不可创建该销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Return False
        End If
        'modify code 003:end-------------------------------------------------------------------------

        Me.btnOK.Select()
        Me.btnNewSalesBill.Enabled = True
        'modify code 075:start-------------------------------------------------------------------------
        Me.btnCheckCUL.Visible = False
        'modify code 075:end-------------------------------------------------------------------------

        'modify code 046,054:start-------------------------------------------------------------------------
        '同一般销售单
        'If bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 1 AndAlso drCustomer("CustomerChineseName").ToString <> Me.txbCustomerName.Text Then
        'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 1 AndAlso drCustomer("CustomerChineseName").ToString <> Me.txbCustomerName.Text Then
        If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso drSalesBill("CustomerType") = 1 AndAlso drCustomer("CustomerChineseName").ToString <> Me.txbCustomerName.Text Then
            'modify code 046,054:end-------------------------------------------------------------------------
            MessageBox.Show("客户异常！请重新选择客户。    " & Chr(13) & Chr(13) & "请立即报告总部IT：021-38784500-761。    ", "客户异常！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
            Me.cbbCustomerType.Select()
            If Not My.Settings.IsInTraining Then
                Try
                    Dim DBT As New DataBase
                    DBT.Open()
                    If DBT.IsConnected Then DBT.ModifyTable("Insert Into tempProblemCustomer Values (" & sSalesBillID & "," & sCustomerID & ",'" & Me.txbCustomerName.Text.Replace("'", "''") & "(*)'," & drCustomer("CustomerID").ToString & ",'" & drCustomer("CustomerChineseName").ToString.Replace("'", "''") & "')")
                    DBT.Close()
                Catch
                End Try
            End If
            Return False
        End If

        If bNewSalesBillType = 4 Then
            If sEmployeeID = "" Then
                MessageBox.Show("当前的员工已经没有购买资格！    " & Chr(13) & Chr(13) & "请取消保存或输入其他员工编号。    ", "当前的员工没有购买资格！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbInputEmployeeNo.Focus()
                Me.txbInputEmployeeNo.Select()
                Me.txbInputEmployeeNo.SelectAll()
                frmMain.statusText.Text = sEmployeePrompt
                Return False
            End If
        ElseIf bNewSalesBillType = 2 Then
            If drSalesBill("PromotionTitle").ToString = "" Then
                MessageBox.Show("活动卡销售单的活动名称不能为空！请先输入活动名称，然后再保存销售单。    ", "不能保存销售单。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbPromotionTitle.Select()
                Return False
            End If
            If drSalesBill("PromotionPeriod").ToString = "" Then
                MessageBox.Show("活动卡销售单的活动时期不能为空！请先设置活动时期，然后再保存销售单。    ", "不能保存销售单。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dtpPromotionStartDate.Select()
                Return False
            End If
        ElseIf bNewSalesBillType = 5 Then '
            If drSalesBill("BuyerName").ToString = "" Then
                MessageBox.Show("会员姓名不能为空！请输入会员姓名。    ", "会员姓名不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbMemberName.Select()
                Return False
            End If
            If drSalesBill("BuyerCredentialsNo").ToString = "" Then
                MessageBox.Show("会员身份证号不能为空！请输入会员身份证号。    ", "会员身份证号不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbMemberIDNo.Select()
                Return False
            End If
            If drSalesBill("TelMP").ToString = "" Then
                MessageBox.Show("会员联系电话不能为空！请输入会员联系电话。    ", "会员联系电话不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbMemberTel.Select()
                Return False
            End If
            If Me.txbMemberAddress.Text = "" Then
                MessageBox.Show("会员联系地址不能为空！请输入会员联系地址。    ", "会员联系地址不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbMemberAddress.Select()
                Return False
            End If
            If Me.txbNewMemberCardNo.Text = "" Then
                MessageBox.Show("新积分卡号不能为空！请输入新积分卡号。    ", "新积分卡号不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbNewMemberCardNo.Select()
                Return False
            End If
            If drSalesBill("CardQTY") > 1 Then
                MessageBox.Show("一张联名卡销售单只能有一张购物卡！请减少购物卡数量到一张。    ", "只允许有一张购物卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dgvNormalCard.Select()
                Me.dgvNormalCard("CardQTY", 0).Selected = True
                Return False
            End If
        End If

        'modify code 046,050:start-------------------------------------------------------------------------
        Dim startCardNo As String
        Dim endCardNo As String
        Dim rowCardQTY As Integer
        If bNewSalesBillType = 7 Then

            Dim DBHolder As New DataBase
            DBHolder.Open()
            If DBHolder.IsConnected Then
                dtHolderInfo = DBHolder.GetDataTable("SELECT * FROM HolderInfoList")
                DBHolder.Close()
            End If

            'dgvNormalCard
            For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows

                startCardNo = Me.dgvNormalCard("StartCardNo", drNormal.Index).Value.ToString
                endCardNo = Me.dgvNormalCard("EndCardNo", drNormal.Index).Value.ToString
                If startCardNo <> "" Then rowCardQTY = Integer.Parse(Me.dgvNormalCard("CardQTY", drNormal.Index).Value.ToString)

                '个人信息一致性检查
                If drNormal.Cells("HolderIdNo").Value.ToString <> "" Then   '售卡行
                    '和已存信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drNormal.Cells("HolderName").Value.ToString & "'").Length = 0 Then
                            sErrorNormalInfo = "持卡人姓名与数据库中保存的个人信息不一致，无法再做售卖操作"
                            MessageBox.Show("持卡人姓名与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                            frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！"
                            Return False
                        End If

                        If dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drNormal.Cells("Gender").Value.ToString & "'").Length = 0 Then
                            sErrorNormalInfo = "持卡人性别与数据库中保存的个人信息不一致，无法再做售卖操作"
                            MessageBox.Show("持卡人性别与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                            frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！"
                            Return False
                        End If

                        If dtHolderInfo.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drNormal.Cells("Mobile").Value.ToString & "'").Length = 0 Then
                            sErrorNormalInfo = "持卡人手机与数据库中保存的个人信息不一致，无法再做售卖操作"
                            MessageBox.Show("持卡人手机与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                            frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！"
                            Return False
                        End If
                    Else
                        '和待存信息（界面输入）对比
                        Dim iNormalRowCount As Integer = dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length
                        Dim iRebateRowCount As Integer = dtRebateCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "'").Length

                        If iNormalRowCount + iRebateRowCount > 1 Then
                            If dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drNormal.Cells("HolderName").Value.ToString & "'").Length _
                            + dtRebateCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drNormal.Cells("HolderName").Value.ToString & "'").Length _
                            <> iNormalRowCount + iRebateRowCount Then
                                sErrorNormalInfo = "持同一证件号的持卡人姓名不一致，无法再做售卖操作"
                                MessageBox.Show("持同一证件号的持卡人姓名不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致，无法再做售卖操作，请输入正确的个人信息！"
                                Return False
                            End If

                            If dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drNormal.Cells("Gender").Value.ToString & "'").Length _
                            + dtRebateCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drNormal.Cells("Gender").Value.ToString & "'").Length _
                            <> iNormalRowCount + iRebateRowCount Then
                                sErrorNormalInfo = "持同一证件号的持卡人性别不一致，无法再做售卖操作"
                                MessageBox.Show("持同一证件号的持卡人性别不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致，无法再做售卖操作，请输入正确的个人信息！"
                                Return False
                            End If

                            If dtNormalCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drNormal.Cells("Mobile").Value.ToString & "'").Length _
                            + dtRebateCard.Select("HolderIdNo ='" & drNormal.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drNormal.Cells("Mobile").Value.ToString & "'").Length _
                            <> iNormalRowCount + iRebateRowCount Then
                                sErrorNormalInfo = "持同一证件号的持卡人手机不一致，无法再做售卖操作"
                                MessageBox.Show("持同一证件号的持卡人手机不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致，无法再做售卖操作，请输入正确的个人信息！"
                                Return False
                            End If
                        End If
                    End If
                    '确保购卡行无已售出实名制卡
                    If dtSignCardRangeNew.Select("CardNo>='" & startCardNo & "' and CardNo<='" & endCardNo & "'").Length > 0 Then
                        sErrorNormalInfo = "该卡段中已有售出的实名制卡，无法再做售卖操作"
                        MessageBox.Show("该卡段中已有售出的实名制卡，无法再做售卖操作，请修正卡段！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.dgvNormalCard("EndCardNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "该卡段中已有售出的实名制卡，无法再做售卖操作，请修正卡段！"
                        Return False
                    End If
                ElseIf startCardNo <> "" Then   '充值行（去掉最后一行）
                    '确保充值行无未出售的实名制卡
                    If dtSignCardRangeNew.Select("CardNo>='" & startCardNo & "' and CardNo<='" & endCardNo & "'").Length <> rowCardQTY Then
                        sErrorNormalInfo = "该卡段中有未出售的实名制卡，无法进行充值操作"
                        MessageBox.Show("该卡段中有未出售的实名制卡，无法进行充值操作，请修正卡段！", sErrorNormalInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.dgvNormalCard("EndCardNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "该卡段中有未出售的实名制卡，无法进行充值操作，请修正卡段！"
                        Return False
                    End If
                End If
            Next

            'dgvRebateCard
            For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows

                startCardNo = Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString
                endCardNo = Me.dgvRebateCard("EndCardNo", drRebate.Index).Value.ToString
                If startCardNo <> "" Then rowCardQTY = Integer.Parse(Me.dgvRebateCard("CardQTY", drRebate.Index).Value.ToString)

                '个人信息一致性检查
                If drRebate.Cells("HolderIdNo").Value.ToString <> "" Then  '售卡行
                    '和已存信息对比
                    If dtHolderInfo.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "'").Length > 0 Then
                        If dtHolderInfo.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drRebate.Cells("HolderName").Value.ToString & "'").Length = 0 Then
                            sErrorRebateInfo = "持卡人姓名与数据库中保存的个人信息不一致，无法再做售卖操作"
                            MessageBox.Show("持卡人姓名与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.dgvRebateCard("HolderName", drRebate.Index).Selected = True
                            frmMain.statusText.Text = "持卡人姓名与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！"
                            Return False
                        End If

                        If dtHolderInfo.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drRebate.Cells("Gender").Value.ToString & "'").Length = 0 Then
                            sErrorRebateInfo = "持卡人性别与数据库中保存的个人信息不一致，无法再做售卖操作"
                            MessageBox.Show("持卡人性别与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.dgvRebateCard("Gender", drRebate.Index).Selected = True
                            frmMain.statusText.Text = "持卡人性别与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！"
                            Return False
                        End If

                        If dtHolderInfo.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drRebate.Cells("Mobile").Value.ToString & "'").Length = 0 Then
                            sErrorRebateInfo = "持卡人手机与数据库中保存的个人信息不一致，无法再做售卖操作"
                            MessageBox.Show("持卡人手机与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.dgvRebateCard("Mobile", drRebate.Index).Selected = True
                            frmMain.statusText.Text = "持卡人手机与数据库中保存的个人信息不一致，无法再做售卖操作，请输入正确的个人信息！"
                            Return False
                        End If
                    Else
                        '和待存信息（界面输入）对比
                        Dim iNormalRowCount As Integer = dtNormalCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "'").Length
                        Dim iRebateRowCount As Integer = dtRebateCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "'").Length

                        If iNormalRowCount + iRebateRowCount > 1 Then
                            If dtNormalCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drRebate.Cells("HolderName").Value.ToString & "'").Length _
                                                    + dtRebateCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND HolderName = '" & drRebate.Cells("HolderName").Value.ToString & "'").Length _
                                                    <> iNormalRowCount + iRebateRowCount Then
                                sErrorRebateInfo = "持同一证件号的持卡人姓名不一致，无法再做售卖操作"
                                MessageBox.Show("持同一证件号的持卡人姓名不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.dgvRebateCard("HolderName", drRebate.Index).Selected = True
                                frmMain.statusText.Text = "持同一证件号的持卡人姓名不一致，无法再做售卖操作，请输入正确的个人信息！"
                                Return False
                            End If

                            If dtNormalCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drRebate.Cells("Gender").Value.ToString & "'").Length _
                            + dtRebateCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND Gender = '" & drRebate.Cells("Gender").Value.ToString & "'").Length _
                            <> iNormalRowCount + iRebateRowCount Then
                                sErrorRebateInfo = "持同一证件号的持卡人性别不一致，无法再做售卖操作"
                                MessageBox.Show("持同一证件号的持卡人性别不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.dgvRebateCard("Gender", drRebate.Index).Selected = True
                                frmMain.statusText.Text = "持同一证件号的持卡人性别不一致，无法再做售卖操作，请输入正确的个人信息！"
                                Return False
                            End If

                            If dtNormalCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drRebate.Cells("Mobile").Value.ToString & "'").Length _
                            + dtRebateCard.Select("HolderIdNo ='" & drRebate.Cells("HolderIdNo").Value.ToString & "' AND Mobile = '" & drRebate.Cells("Mobile").Value.ToString & "'").Length _
                            <> iNormalRowCount + iRebateRowCount Then
                                sErrorRebateInfo = "持同一证件号的持卡人手机不一致，无法再做售卖操作"
                                MessageBox.Show("持同一证件号的持卡人手机不一致，无法再做售卖操作，请输入正确的个人信息！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.dgvRebateCard("Mobile", drRebate.Index).Selected = True
                                frmMain.statusText.Text = "持同一证件号的持卡人手机不一致，无法再做售卖操作，请输入正确的个人信息！"
                                Return False
                            End If
                        End If
                    End If
                    '确保购卡行无已售出实名制卡
                    If dtSignCardRangeNew.Select("CardNo>='" & startCardNo & "' and CardNo<='" & endCardNo & "'").Length > 0 Then
                        sErrorRebateInfo = "该卡段中已有售出的实名制卡，无法再做售卖操作"
                        MessageBox.Show("该卡段中已有售出的实名制卡，无法再做售卖操作，请修正卡段！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.dgvRebateCard("EndCardNo", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "该卡段中已有售出的实名制卡，无法再做售卖操作，请修正卡段！"
                        Return False
                    End If
                ElseIf startCardNo.IndexOf("2336" & frmMain.signCardBin) = 0 Then   '充值行（去掉最后一行及非实名制卡）
                    If dtSignCardRangeNew.Select("CardNo>='" & startCardNo & "' and CardNo<='" & endCardNo & "'").Length <> rowCardQTY Then
                        sErrorRebateInfo = "该卡段中有未出售的实名制卡，无法进行充值操作"
                        MessageBox.Show("该卡段中有未出售的实名制卡，无法进行充值操作，请修正卡段！", sErrorRebateInfo & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.dgvRebateCard("EndCardNo", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "该卡段中有未出售的实名制卡，无法进行充值操作，请修正卡段！"
                        Return False
                    End If
                End If
            Next
        End If

        '返点卡表增加输入新个人信息后，check同售卡表（如上↑）
        'For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
        '    Dim sFaceValue As String = drRebate.Cells("FaceValue").Value.ToString
        '    startCardNo = Me.dgvRebateCard("StartCardNo", drRebate.Index).Value.ToString
        '    endCardNo = Me.dgvRebateCard("EndCardNo", drRebate.Index).Value.ToString
        '    If sFaceValue <> "" Then
        '        If drRebate.Cells("IsSignCard").Value.ToString = "是" Then
        '            '实名制行
        '            If CDec(sFaceValue) > dmMaxSignCardFaceValue Then
        '                Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
        '                frmMain.statusText.Text = "实名制卡片面值不能超过 5,000 元。"
        '                blSkipDeal = False : Exit Function
        '            Else
        '                rowCardQTY = Integer.Parse(Me.dgvRebateCard("CardQTY", drRebate.Index).Value.ToString)
        '                If dtSignCardRangeNew.Select("CardNo>='" & startCardNo & "' and CardNo<='" & endCardNo & "'").Length <> rowCardQTY Then
        '                    sErrorRebateInfo = "该卡段中有未出售的实名制卡，无法进行操作"
        '                    Me.dgvRebateCard("EndCardNo", drRebate.Index).Selected = True
        '                    frmMain.statusText.Text = "该卡段中有未出售的实名制卡，无法进行操作，请修正卡段！"
        '                    blSkipDeal = False : Exit Function
        '                End If
        '            End If
        '        Else
        '            If CDec(sFaceValue) > 1000 Then
        '                Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
        '                frmMain.statusText.Text = "卡片面值不能超过 1,000 元"
        '                blSkipDeal = False : Exit Function
        '            End If
        '        End If
        '    End If
        'Next
        'modify code 046,050:end-------------------------------------------------------------------------

        'modify code 046,054:start-------------------------------------------------------------------------
        '同一般销售单
        'If bNewSalesBillType = 0 AndAlso dmNormalSalesAMT >= 10000 AndAlso drSalesBill("CustomerType") = 1 Then
        'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso dmNormalSalesAMT >= 10000 AndAlso drSalesBill("CustomerType") = 1 Then
        If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso dmNormalSalesAMT >= 10000 AndAlso drSalesBill("CustomerType") = 1 Then
            'modify code 046,054:end-------------------------------------------------------------------------
            If Me.cbbCompanyCredentialsType.Text.Trim = "" Then
                MessageBox.Show("该销售单需要实名登记，所以公司证件类型不能为空！    " & Chr(13) & Chr(13) & "请选择或输入公司证件类型。    ", "公司证件类型不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.cbbCompanyCredentialsType.Select()
                Return False
            End If
            If Me.cbbCompanyCredentialsType.Text <> "（特准无需证件）" AndAlso Me.txbCompanyCredentialsNo.Text.Trim = "" Then
                MessageBox.Show("该销售单需要实名登记，所以公司证件号码不能为空！    " & Chr(13) & Chr(13) & "请输入公司证件号码。    ", "公司证件号码不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbCompanyCredentialsNo.Select()
                Return False
            End If
        End If

        If bNewSalesBillType <> 1 AndAlso bNewSalesBillType <> 4 AndAlso dmNormalSalesAMT >= 10000 Then
            'modify code 046,054:start-------------------------------------------------------------------------
            '同一般销售单
            'Dim sName As String = IIf(bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
            'Dim sName As String = IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
            Dim sName As String = IIf((bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso drSalesBill("CustomerType") = 0, "购买人", "代购人")
            'modify code 046,054:end-------------------------------------------------------------------------
            If Me.txbBuyerName.Text.Trim = "" Then
                MessageBox.Show("该销售单需要实名登记，所以" & sName & "姓名不能为空！    " & Chr(13) & Chr(13) & "请输入" & sName & "姓名。    ", sName & "姓名不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbBuyerName.Select()
                Return False
            End If
            If Me.txbTelMP.Text.Trim = "" Then
                MessageBox.Show("该销售单需要实名登记，所以" & sName & "联系电话不能为空！    " & Chr(13) & Chr(13) & "请输入" & sName & "联系电话。    ", sName & "联系电话不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbTelMP.Select()
                Return False
            End If
            If Me.cbbBuyerCredentialsType.Text.Trim = "" Then
                MessageBox.Show("该销售单需要实名登记，所以" & sName & "证件类型不能为空！    " & Chr(13) & Chr(13) & "请选择或输入" & sName & "证件类型。    ", sName & "证件类型不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.cbbBuyerCredentialsType.Select()
                Return False
            End If
            If Me.txbBuyerCredentialsNo.Text.Trim = "" Then
                MessageBox.Show("该销售单需要实名登记，所以" & sName & "证件号码不能为空！    " & Chr(13) & Chr(13) & "请输入" & sName & "证件号码。    ", sName & "证件号码不能为空！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.txbBuyerCredentialsNo.Select()
                Return False
            End If
        End If

        If Me.splitList.Panel1Collapsed = False Then
            If errorNormalCell IsNot Nothing Then
                MessageBox.Show("购物卡列表中存在错误！请先修改错误，然后再保存销售单。    ", "不能保存销售单。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dgvNormalCard.Select()
                blSkipDeal = True
                Me.dgvNormalCard("ChargedAMT", errorNormalCell.RowIndex).Selected = True
                blSkipDeal = False
                errorNormalCell.Selected = True
                Return False
            End If

            For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
                If drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("FaceValue").Value.ToString = "" Then
                    MessageBox.Show("不能保存销售单，因为有一行购物卡的面值未设置！    " & Chr(13) & Chr(13) & "请设置该行购物卡的面值。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.Activate()
                    Me.dgvNormalCard.Select()
                    blSkipDeal = True
                    Me.dgvNormalCard("FaceValue", drNormal.Index).Selected = True
                    Me.dgvNormalCard("FaceValue", drNormal.Index).Selected = False
                    blSkipDeal = False
                    Me.dgvNormalCard("FaceValue", drNormal.Index).Selected = True
                    frmMain.statusText.Text = "不能保存销售单，因为有一行购物卡的面值未设置！请设置该行购物卡的面值。"
                    Return False
                    'modify code 046,050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso drNormal.Cells("FirstBuy").Value.ToString = "购卡" Then
                    'modify code 050:end-------------------------------------------------------------------------
                    If drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("HolderName").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人姓名未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人姓名。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvNormalCard.Select()
                        blSkipDeal = True
                        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvNormalCard("HolderName", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人姓名未设置！请设置该行的持卡人姓名。"
                        Return False
                    ElseIf drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("Gender").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人性别未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人性别。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvNormalCard.Select()
                        blSkipDeal = True
                        Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                        Me.dgvNormalCard("Gender", drNormal.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvNormalCard("Gender", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人性别未设置！请设置该行的持卡人性别。"
                        Return False
                    ElseIf drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("HolderIdNo").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人身份证号未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人身份证号。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvNormalCard.Select()
                        blSkipDeal = True
                        Me.dgvNormalCard("HolderIdNo", drNormal.Index).Selected = True
                        Me.dgvNormalCard("HolderIdNo", drNormal.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvNormalCard("HolderIdNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人身份证号未设置！请设置该行的持卡人身份证号。"
                        Return False
                    ElseIf drNormal.Cells("StartCardNo").Value.ToString <> "" AndAlso drNormal.Cells("Mobile").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人手机号未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人手机号。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvNormalCard.Select()
                        blSkipDeal = True
                        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvNormalCard("Mobile", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人手机号未设置！请设置该行的持卡人手机号。"
                        Return False
                    End If
                    'modify code 046:end-------------------------------------------------------------------------
                End If
            Next

            If dtNormalCard.Select("ActivationState='N'").Length > 0 Then
                MessageBox.Show("您当前处于""购物卡再充值""销售模式。    " & Chr(13) & "但经检查发现部分购物卡（红色卡号）从未充过值。    " & Chr(13) & Chr(13) & "请先删除这些卡，再保存销售单。否则，无法保存！    ", "存在未充过值的购物卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
                    If drNormal.Cells("ActivationState").Value.ToString = "N" Then
                        Me.dgvNormalCard.Select()
                        blSkipDeal = True
                        Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = True
                        Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = True
                        frmMain.statusText.Text = "存在未充过值的购物卡！请先删除这些卡再保存。"
                        Return False
                    End If
                Next
            End If
        End If

        If Me.splitList.Panel2Collapsed = False Then
            If errorRebateCell IsNot Nothing Then
                MessageBox.Show("返点卡列表中存在错误！请先修改错误，然后再保存。    ", "不能保存。", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dgvRebateCard.Select()
                blSkipDeal = True
                Me.dgvRebateCard("ChargedAMT", errorRebateCell.RowIndex).Selected = True
                blSkipDeal = False
                errorRebateCell.Selected = True
                Return False
            End If

            For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
                If drRebate.Cells("StartCardNo").Value.ToString <> "" AndAlso drRebate.Cells("FaceValue").Value.ToString = "" Then
                    MessageBox.Show("不能保存销售单，因为有一行返点卡的面值未设置！    " & Chr(13) & Chr(13) & "请设置该行返点卡的面值。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.Activate()
                    Me.dgvRebateCard.Select()
                    blSkipDeal = True
                    Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
                    Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = False
                    blSkipDeal = False
                    Me.dgvRebateCard("FaceValue", drRebate.Index).Selected = True
                    frmMain.statusText.Text = "不能保存销售单，因为有一行返点卡的面值未设置！请设置该行返点卡的面值。"
                    Return False
                    'modify code 050:start-------------------------------------------------------------------------
                ElseIf bNewSalesBillType = 7 AndAlso drRebate.Cells("HolderIdNo").ReadOnly = False Then
                    If drRebate.Cells("StartCardNo").Value.ToString <> "" AndAlso drRebate.Cells("HolderName").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人姓名未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人姓名。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvRebateCard.Select()
                        blSkipDeal = True
                        Me.dgvRebateCard("HolderName", drRebate.Index).Selected = True
                        Me.dgvRebateCard("HolderName", drRebate.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvRebateCard("HolderName", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人姓名未设置！请设置该行的持卡人姓名。"
                        Return False
                    ElseIf drRebate.Cells("StartCardNo").Value.ToString <> "" AndAlso drRebate.Cells("Gender").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人性别未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人性别。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvRebateCard.Select()
                        blSkipDeal = True
                        Me.dgvRebateCard("Gender", drRebate.Index).Selected = True
                        Me.dgvRebateCard("Gender", drRebate.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvRebateCard("Gender", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人性别未设置！请设置该行的持卡人性别。"
                        Return False
                    ElseIf drRebate.Cells("StartCardNo").Value.ToString <> "" AndAlso drRebate.Cells("HolderIdNo").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人身份证号未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人身份证号。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvRebateCard.Select()
                        blSkipDeal = True
                        Me.dgvRebateCard("HolderIdNo", drRebate.Index).Selected = True
                        Me.dgvRebateCard("HolderIdNo", drRebate.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvRebateCard("HolderIdNo", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人身份证号未设置！请设置该行的持卡人身份证号。"
                        Return False
                    ElseIf drRebate.Cells("StartCardNo").Value.ToString <> "" AndAlso drRebate.Cells("Mobile").Value.ToString = "" Then
                        MessageBox.Show("不能保存销售单，因为有一行持卡人手机号未设置！    " & Chr(13) & Chr(13) & "请设置该行的持卡人手机号。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvRebateCard.Select()
                        blSkipDeal = True
                        Me.dgvRebateCard("Mobile", drRebate.Index).Selected = True
                        Me.dgvRebateCard("Mobile", drRebate.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvRebateCard("Mobile", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，因为有一行持卡人手机号未设置！请设置该行的持卡人手机号。"
                        Return False
                    End If
                    'modify code 050:end-------------------------------------------------------------------------
                End If
            Next

            If dtRebateCard.Select("ActivationState='N'").Length > 0 Then
                MessageBox.Show("您当前处于""购物卡再充值""销售模式。    " & Chr(13) & "但经检查发现部分返点卡（红色卡号）从未充过值。    " & Chr(13) & Chr(13) & "请先删除这些卡，再保存销售单。否则，无法保存！    ", "存在未充过值的返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
                    If drRebate.Cells("ActivationState").Value.ToString = "N" Then
                        Me.dgvRebateCard.Select()
                        blSkipDeal = True
                        Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = True
                        Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = False
                        blSkipDeal = False
                        Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = True
                        frmMain.statusText.Text = "存在未充过值的返点卡！请先删除这些卡再保存。"
                        Return False
                    End If
                Next
            End If
        End If

        If bNewSalesBillType = 4 Then
            Dim bMaxLength As Byte = Me.txbDistributedPurchaseQuota.Text.Length
            If dmNormalSalesAMT > drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota") Then
                MessageBox.Show("已分配的购买金额已超过该员工本次的购买额度！    " & Chr(13) & Chr(13) & _
                                "本次允许的购买额度：" & Space(bMaxLength - Me.txbMaxAvailablePurchaseQuota.Text.Length) & Me.txbMaxAvailablePurchaseQuota.Text & " 元    " & Chr(13) & Chr(13) & _
                                "已经分配的购买金额：" & Me.txbDistributedPurchaseQuota.Text & " 元    " & Chr(13) & Chr(13) & _
                                "请减少购买金额（购买额度之外的金额请使用一般销售单）。    ", "购买金额超过购买额度！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dgvNormalCard.Select()
                frmMain.statusText.Text = "不能保存销售单，因为已分配的购买金额已超过该员工本次的购买额度！"
                Return False
            End If

            If dmRebateSalesAMT > dmAvailableRebateAMT Then
                bMaxLength = Me.txbDistributedRebateQuota.Text.Length
                MessageBox.Show("已分配的返点金额已超过该员工本次可兑现的返点额度！    " & Chr(13) & Chr(13) & _
                                "可兑现的返点额度：" & Space(bMaxLength - Me.txbAvailableRebateQuota.Text.Length) & Me.txbAvailableRebateQuota.Text & " 元    " & Chr(13) & Chr(13) & _
                                "已分配的返点金额：" & Me.txbDistributedRebateQuota.Text & " 元    " & Chr(13) & Chr(13) & _
                                "请减少返点金额。    ", "返点金额超过可兑现的返点额度！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dgvRebateCard.Select()
                frmMain.statusText.Text = "不能保存销售单，因为已分配的返点金额已超过该员工本次可兑现的返点额度！"
                Return False
            End If

            If dmRebateSalesAMT < dmAvailableRebateAMT Then
                bMaxLength = Me.txbAvailableRebateQuota.Text.Length
                MessageBox.Show("已分配的返点金额未达到该员工本次应得的返点额度！    " & Chr(13) & Chr(13) & _
                                "本次应得的返点额度：" & Me.txbAvailableRebateQuota.Text & " 元    " & Chr(13) & Chr(13) & _
                                "已经分配的返点金额：" & Space(bMaxLength - Me.txbDistributedRebateQuota.Text.Length) & Me.txbDistributedRebateQuota.Text & " 元    " & Chr(13) & Chr(13) & _
                                "请给该员工分配更多的返点金额。    ", "返点金额未达到应得的返点额度！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                Me.Activate()
                Me.dgvRebateCard.Select()
                frmMain.statusText.Text = "不能保存销售单，因为已分配的返点金额未达到该员工本次应得的返点额度！"
                Return False
            End If
        End If

        If bNewSalesBillType = 1 Then
            If Me.txbRefundNo.Text.Trim = "" Then
                MessageBox.Show("您还未输入来自退货中心的退货号码！请先输入退货号码。    ", "未输入来自退货中心的退货号码！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                frmMain.statusText.Text = "不能保存退货销售单，因为您还未输入来自退货中心的退货号码！"
                Me.Activate()
                Me.txbRefundNo.Select()
                Return False
            End If
        Else
            If dmNormalSalesAMT > 0 Then
                Dim dmTotalCardCost As Decimal = 0, dmCash As Decimal = 0
                Try
                    dmTotalCardCost = drSalesBill("CardCost")
                    dmCash = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm<" & IIf(drSalesBill("RebateMode") <> 2 AndAlso blHaveThreeMedia, 1, 2).ToString)
                Catch
                End Try

                'modify code 044:start-------------------------------------------------------------------------
                For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                    If IsDBNull(drPayment.Cells("PaymentAMT").Value) Then
                        MessageBox.Show("支付金额为空！请先填写支付金额。    ", "未填写支付金额！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.Activate()
                        Me.dgvPayment.Select()
                        Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                        Me.dgvPayment("PaymentAMT", drPayment.Index).Selected = True
                        frmMain.statusText.Text = "不能保存销售单，未填写支付金额！"
                        Return False
                    End If

                    'modify code 059:start-------------------------------------------------------------------------
                    If Not drContract Is Nothing AndAlso drContract("PaymentMode") = 1 Then '如果是付款抵扣合同的情况,允许支付金额为零
                    Else
                        If drPayment.Cells("PaymentAMT").Value = 0 Then
                            MessageBox.Show("支付金额为零！请先填写支付金额。    ", "支付金额为零！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.Activate()
                            Me.dgvPayment.Select()
                            Me.dgvPayment("PaymentAMT", drPayment.Index).Selected = True
                            frmMain.statusText.Text = "不能保存销售单，支付金额为零！"
                            Return False
                        End If
                    End If
                    'modify code 059:end-------------------------------------------------------------------------
                Next
                'modify code 044:end-------------------------------------------------------------------------

                For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                    If (drSalesBill("CustomerType") = 0 AndAlso dmTotalCardCost < dmCash AndAlso dmPayableAMT - dmTotalCardCost >= 50000 AndAlso drPayment.Cells("PaymentTerm").Value < IIf(blHaveThreeMedia, 1, 2)) OrElse _
                         (drSalesBill("CustomerType") = 1 AndAlso dmTotalCardCost < dmCash AndAlso dmPayableAMT - dmTotalCardCost >= 5000 AndAlso drPayment.Cells("PaymentTerm").Value < IIf(blHaveThreeMedia, 1, 2)) Then
                        Me.dgvPayment.Select()
                        Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                        Me.dgvPayment("PaymentTerm", drPayment.Index).Selected = True
                        If drSalesBill("CustomerType") = 0 Then
                            If blHaveThreeMedia Then
                                MessageBox.Show("应国家政策规定，个人客户一次性购卡超过（含） 50,000 元时，不能使用现金支付。    " & IIf(dmTotalCardCost = 0, "", Chr(13) & Chr(13) & "（现金只可用来支付卡成本。）    ") & Chr(13) & Chr(13) & "请使用银行卡、转账或支票方式。    ", "支付方式不合法！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Else
                                MessageBox.Show("应国家政策规定，个人客户一次性购卡超过（含） 50,000 元时，不能使用现金或银行卡支付。    " & IIf(dmTotalCardCost = 0, "", Chr(13) & Chr(13) & "（现金或银行卡只可用来支付卡成本。）    ") & Chr(13) & Chr(13) & "请使用转账或支票方式。    ", "支付方式不合法！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            End If
                        Else
                            If blHaveThreeMedia Then
                                MessageBox.Show("应国家政策规定，公司客户一次性购卡超过（含） 5,000 元时，不能使用现金支付。    " & IIf(dmTotalCardCost = 0, "", Chr(13) & Chr(13) & "（现金只可用来支付卡成本。）    ") & Chr(13) & Chr(13) & "请使用银行卡、转账或支票方式。    ", "支付方式不合法！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Else
                                MessageBox.Show("应国家政策规定，公司客户一次性购卡超过（含） 5,000 元时，不能使用现金或银行卡支付。    " & IIf(dmTotalCardCost = 0, "", Chr(13) & Chr(13) & "（现金或银行卡只可用来支付卡成本。）    ") & Chr(13) & Chr(13) & "请使用转账或支票方式。    ", "支付方式不合法！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            End If
                        End If
                        Me.Activate()
                        frmMain.statusText.Text = "支付方式违反国家政策规定。请使用转账或支票方式。"
                        Me.dgvPayment.Select()
                        Return False
                        'modify code 008:start-------------------------------------------------------------------------
                        'ElseIf drSalesBill("RebateMode") = 2 AndAlso (drPayment.Cells("PaymentTerm").Value < 2 OrElse drPayment.Cells("PaymentTerm").Value > 3) AndAlso dmTotalCardCost < dmCash Then
                    ElseIf drSalesBill("RebateMode") = 2 AndAlso (drPayment.Cells("PaymentTerm").Value < 2 OrElse drPayment.Cells("PaymentTerm").Value > 3) AndAlso drPayment.Cells("PaymentTerm").Value <> 7 AndAlso dmTotalCardCost < dmCash Then
                        Me.dgvPayment.Select()
                        Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                        Me.dgvPayment("PaymentTerm", drPayment.Index).Selected = True
                        If drPayment.Cells("PaymentTerm").Value < 2 Then
                            If dmTotalCardCost = 0 Then
                                'MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票/积分兑换""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Else
                                'MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "（现金或银行卡只可用来支付卡成本。）    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                MessageBox.Show("对不起，合同客户不允许使用""现金/银行卡""支付方式。    " & Chr(13) & Chr(13) & "（现金或银行卡只可用来支付卡成本。）    " & Chr(13) & Chr(13) & "请选择""转账/支票/积分兑换""支付方式。    ", "合同客户不允许使用""现金/银行卡""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            End If
                        Else
                            'MessageBox.Show("对不起，合同客户不允许使用除""转账/支票""之外的支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用非""转账/支票""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            MessageBox.Show("对不起，合同客户不允许使用除""转账/支票/积分兑换""之外的支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票/积分兑换""支付方式。    ", "合同客户不允许使用非""转账/支票/积分兑换""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        End If
                        Me.Activate()
                        'frmMain.statusText.Text = "合同客户不允许使用""现金/银行卡""支付方式。请选择""转账/支票/积分兑换""支付方式。"
                        frmMain.statusText.Text = "合同客户不允许使用""现金/银行卡""支付方式。请选择""转账/支票/积分兑换""支付方式。"
                        Return False
                        'ElseIf drSalesBill("RebateMode") = 2 AndAlso drPayment.Cells("PaymentTerm").Value = 7 Then
                        '    Me.dgvPayment.Select()
                        '    Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                        '    Me.dgvPayment("PaymentTerm", drPayment.Index).Selected = True
                        '    MessageBox.Show("对不起，合同客户不允许使用除""转账/支票""之外的支付方式。    " & Chr(13) & Chr(13) & "请选择""转账/支票""支付方式。    ", "合同客户不允许使用非""转账/支票""支付方式！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        '    Me.Activate()
                        '    frmMain.statusText.Text = "合同客户不允许使用""转账/支票""之外的支付方式。请选择""转账/支票""支付方式。"
                        '    Return False
                        'ElseIf drPayment.Cells("PaymentAMT").Value.ToString <> "" AndAlso drPayment.Cells("PaymentAMT").Value > 0 AndAlso drPayment.Cells("PaymentTerm").Value > 0 Then
                        'modify code 040,044:start-------------------------------------------------------------------------
                        'ElseIf drPayment.Cells("PaymentAMT").Value.ToString <> "" AndAlso drPayment.Cells("PaymentAMT").Value > 0 AndAlso drPayment.Cells("PaymentTerm").Value > 0 AndAlso drPayment.Cells("PaymentTerm").Value <> 7 Then
                    ElseIf drPayment.Cells("PaymentAMT").Value.ToString <> "" AndAlso drPayment.Cells("PaymentAMT").Value > 0 AndAlso drPayment.Cells("PaymentTerm").Value > 0 AndAlso drPayment.Cells("PaymentTerm").Value <> 7 AndAlso drPayment.Cells("PaymentTerm").Value <> 8 AndAlso drPayment.Cells("PaymentTerm").Value <> 11 Then
                        'modify code 040,044:end-------------------------------------------------------------------------
                        'modify code 008:end-------------------------------------------------------------------------
                        If drPayment.Cells("MediaNo").Value.ToString = "" Then
                            Dim sMediaName As String = IIf(drPayment.Cells("PaymentTerm").Value = 1, "银行卡卡号", IIf(drPayment.Cells("PaymentTerm").Value = 2, "转账账号", "支票号"))

                            'modify code 085:start-------------------------------------------------------------------------
                            Dim sTerm As String = drPayment.Cells("PaymentTerm").Value
                            If sTerm = "13" Then
                                MessageBox.Show("领卡用途不能为空，请输入领卡用途。    ", "您还未输入领卡用途！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Else
                                MessageBox.Show(sMediaName & "不能为空，请输入" & sMediaName & "。    ", "您还未输入" & sMediaName & "！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            End If
                            'modify code 085:end-------------------------------------------------------------------------

                            Me.Activate()
                            Me.dgvPayment.Select()
                            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                            Me.dgvPayment("MediaNo", drPayment.Index).Selected = True

                            'modify code 085:start-------------------------------------------------------------------------
                            If sTerm = "13" Then
                                frmMain.statusText.Text = "领卡用途不能为空！请输入领卡用途。"
                            Else
                                frmMain.statusText.Text = sMediaName & "不能为空！请输入" & sMediaName & "。"
                            End If
                            'modify code 085:end-------------------------------------------------------------------------

                            Return False
                        ElseIf drPayment.Cells("PayerName").Value.ToString = "" Then
                            If drPayment.Cells("PaymentAMT").Value = 1 Then
                                MessageBox.Show("持卡人姓名不能为空！请输入持卡人姓名。    ", "您还未输入持卡人姓名！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Else

                                'modify code 085:start-------------------------------------------------------------------------
                                Dim sTerm As String = drPayment.Cells("PaymentTerm").Value
                                If sTerm = "13" Then
                                    MessageBox.Show("领卡部门不能为空！请输入领卡部门。    ", "您还未输入领卡部门！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Else
                                    MessageBox.Show("付款单位不能为空！请输入付款单位。    ", "您还未输入付款单位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                End If
                                'modify code 085:end-------------------------------------------------------------------------

                            End If
                            Me.Activate()
                            Me.dgvPayment.Select()
                            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                            Me.dgvPayment("PayerName", drPayment.Index).Selected = True
                            If drPayment.Cells("PaymentAMT").Value = 1 Then
                                frmMain.statusText.Text = "持卡人姓名不能为空！请输入持卡人姓名。 "
                            Else

                                'modify code 085:start-------------------------------------------------------------------------
                                Dim sTerm As String = drPayment.Cells("PaymentTerm").Value
                                If sTerm = "13" Then
                                    frmMain.statusText.Text = "领卡部门不能为空！请输入领卡部门。"
                                Else
                                    frmMain.statusText.Text = "付款单位不能为空！请输入付款单位。"
                                End If
                                'modify code 085:end-------------------------------------------------------------------------

                            End If
                            Return False
                        End If
                        'modify code 008:start-------------------------------------------------------------------------
                    ElseIf drPayment.Cells("PaymentAMT").Value.ToString <> "" AndAlso drPayment.Cells("PaymentAMT").Value > 0 AndAlso drPayment.Cells("PaymentTerm").Value = 7 Then
                        If drPayment.Cells("MediaNo").Value.ToString = "" Then
                            MessageBox.Show("顾客手机号/兑换号不能为空。    ", "您还未输入顾客手机号/兑换号！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.Activate()
                            Me.dgvPayment.Select()
                            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                            Me.dgvPayment("MediaNo", drPayment.Index).Selected = True
                            frmMain.statusText.Text = "顾客手机号/兑换号不能为空！请输入顾客手机号/兑换号。"
                            Return False
                        Else
                            'If Not IsNumeric(drPayment.Cells("MediaNo").Value.ToString) Then
                            '    MessageBox.Show("顾客手机号/兑换号为数字。    ", "顾客手机号码/兑换号输入错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            '    Me.Activate()
                            '    Me.dgvPayment.Select()
                            '    Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                            '    Me.dgvPayment("MediaNo", drPayment.Index).Selected = True
                            '    frmMain.statusText.Text = "顾客手机号/兑换号为数字！请重新输入。"
                            '    Return False
                            'End If
                        End If
                        If drPayment.Cells("PayerName").Value.ToString = "" Then
                            MessageBox.Show("付款单位不能为空。    ", "您还未输入付款单位！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.Activate()
                            Me.dgvPayment.Select()
                            Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                            Me.dgvPayment("PayerName", drPayment.Index).Selected = True
                            frmMain.statusText.Text = "付款单位不能为空！请输入付款单位。"
                            Return False
                        End If
                        'modify code 008:end-------------------------------------------------------------------------
                    End If
                Next

                Dim bLen As Byte, blWithDot As Boolean = (dmReceivedAMT <> CLng(dmReceivedAMT) OrElse dmPayableAMT <> CLng(dmPayableAMT)), blPaymentError As Boolean = False
                If dmReceivedAMT < dmPayableAMT Then
                    bLen = Format(dmPayableAMT, IIf(blWithDot, "#,0.00", "#,0")).Length
                    MessageBox.Show("已付金额低于应付金额！    " & Chr(13) & Chr(13) & _
                                    "应付金额： " & String.Format("{0," & bLen & ":#,0" & IIf(blWithDot, ".00", "") & "}", dmPayableAMT) & " 元    " & Chr(13) & _
                                    "已付金额： " & String.Format("{0," & bLen & ":#,0" & IIf(blWithDot, ".00", "") & "}", dmReceivedAMT) & " 元    " & Chr(13) & _
                                    "未付金额： " & String.Format("{0," & bLen & ":#,0" & IIf(blWithDot, ".00", "") & "}", dmPayableAMT - dmReceivedAMT) & " 元    " & Chr(13) & Chr(13) & _
                                    "已付金额不能低于应付金额！请重新收款。    " & Chr(13), _
                                    "已付金额不足！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "已付金额不能低于客户应付金额！请重新收款。"
                    blPaymentError = True
                ElseIf dmReceivedAMT > dmPayableAMT Then
                    bLen = Format(dmReceivedAMT, IIf(blWithDot, "#,0.00", "#,0")).Length
                    MessageBox.Show("已付金额高于应付金额！请调整收款金额。    " & Chr(13) & Chr(13) & _
                                        "应付金额： " & String.Format("{0," & bLen & ":#,0" & IIf(blWithDot, ".00", "") & "}", dmPayableAMT) & " 元    " & Chr(13) & _
                                        "已付金额： " & String.Format("{0," & bLen & ":#,0" & IIf(blWithDot, ".00", "") & "}", dmReceivedAMT) & " 元    " & Chr(13) & _
                                        "超过金额： " & String.Format("{0," & bLen & ":#,0" & IIf(blWithDot, ".00", "") & "}", dmReceivedAMT - dmPayableAMT) & " 元    " & Chr(13) & Chr(13) & _
                                        "已付金额不能高于应付金额！请调整收款金额。    " & Chr(13), _
                                        "已付金额过高！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "已付金额不能高于应付金额！请调整收款金额。"
                    blPaymentError = True
                End If

                If blPaymentError Then
                    Me.Activate()
                    Me.dgvPayment.Select()
                    Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                    Dim iIndex As Int16 = Me.dgvPayment.RowCount - 1
                    For Each drPayment As DataGridViewRow In Me.dgvPayment.Rows
                        If drPayment.Cells("PaymentAMT").Value.ToString = "" OrElse drPayment.Cells("PaymentAMT").Value = 0 Then
                            iIndex = drPayment.Index : Exit For
                        End If
                    Next
                    Me.dgvPayment("PaymentAMT", iIndex).Selected = True
                    Return False
                End If

                If Me.dgvNormalCard.Columns("PaymentDescription").Visible = True Then
                    For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
                        If drNormal.Cells("PaymentDescription").Value.ToString.IndexOf("请分配付款金额").ToString > -1 Then
                            MessageBox.Show("不能保存销售单，因为有一行购物卡的付款金额未分配！    " & Chr(13) & Chr(13) & "请分配该行购物卡的付款金额。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            Me.Activate()
                            Me.dgvNormalCard.Select()
                            blSkipDeal = True
                            Me.dgvNormalCard("PaymentDescription", drNormal.Index).Selected = True
                            Me.dgvNormalCard("PaymentDescription", drNormal.Index).Selected = False
                            blSkipDeal = False
                            Me.dgvNormalCard("PaymentDescription", drNormal.Index).Selected = True
                            frmMain.statusText.Text = "不能保存销售单，因为有一行购物卡的付款金额未分配！请分配该行购物卡的付款金额。"
                            Return False
                        ElseIf drNormal.Cells("StartCardNo").Value.ToString <> "" Then
                            Dim dmDistributedAMT As Decimal = 0, dmRowPayableAMT As Decimal = drNormal.Cells("PayableAMT").Value
                            Try
                                dmDistributedAMT = dtRowPayment.Compute("Sum(DistributedAMT)", "CardRowID=" & drNormal.Cells("RowID").Value.ToString)
                            Catch
                            End Try
                            If dmDistributedAMT <> dmRowPayableAMT Then
                                errorNormalCell = drNormal.Cells("PaymentDescription")
                                sErrorNormalInfo = "已分配的付款金额不足"
                                MessageBox.Show("不能保存销售单，因为有一行购物卡的已分配的付款金额不足！    " & Chr(13) & Chr(13) & "请重新分配该行购物卡的付款金额。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                Me.Activate()
                                Me.dgvNormalCard.Select()
                                blSkipDeal = True
                                Me.dgvNormalCard("PaymentDescription", drNormal.Index).Selected = True
                                Me.dgvNormalCard("PaymentDescription", drNormal.Index).Selected = False
                                blSkipDeal = False
                                Me.dgvNormalCard("PaymentDescription", drNormal.Index).Selected = True
                                frmMain.statusText.Text = "不能保存销售单，因为有一行购物卡的已分配的付款金额不足！请重新分配该行购物卡的付款金额。"
                                Return False
                            End If
                        End If
                    Next
                End If

                Dim dmPaymentAMTAfterActivation As Decimal = 0, dmPaymentAMTPaperCard As Decimal = 0, blNeedClearRowPayment As Boolean = False
                Try
                    'modify code 008:start-------------------------------------------------------------------------
                    'dmPaymentAMTAfterActivation = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm>4")
                    'modify code 040,044,085:start-------------------------------------------------------------------------
                    'dmPaymentAMTAfterActivation = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm>4 and PaymentTerm<>7")
                    dmPaymentAMTAfterActivation = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm>4 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11")
                    'dmPaymentAMTAfterActivation = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm>4 and PaymentTerm<>7 and PaymentTerm<>8 and PaymentTerm<>11 and PaymentTerm<>13")
                    'modify code 040,044,085:end-------------------------------------------------------------------------
                    'modify code 008:end-------------------------------------------------------------------------
                Catch
                End Try
                If dtSelectablePayment.Rows.Count < 2 OrElse dtRowPayment.Rows.Count = 0 Then
                    Dim drTempRowPayment As DataRow
                    dtRowPayment.Rows.Clear()
                    blNeedClearRowPayment = True
                    For Each drNormal As DataRow In dtNormalCard.Select("Isnull(StartCardNo,'')<>''", "RowID")
                        drTempRowPayment = dtRowPayment.Rows.Add()
                        drTempRowPayment("CardRowID") = drNormal("RowID")
                        drTempRowPayment("PaymentRowID") = 1
                        drTempRowPayment("DistributedAMT") = drNormal("PayableAMT")
                    Next
                    dtRowPayment.AcceptChanges()
                End If

                If dmPaymentAMTAfterActivation > 0 Then
                    For Each drRowPayment As DataRow In dtRowPayment.Rows
                        If dtNormalCard.Rows(drRowPayment("CardRowID") - 1)("CardFeature").ToString = "充值券" AndAlso dtPayment.Rows(drRowPayment("PaymentRowID") - 1)("PaymentTerm") > 4 Then
                            dmPaymentAMTPaperCard = dmPaymentAMTPaperCard + drRowPayment("DistributedAMT")
                        End If
                    Next
                End If
                If dmPaymentAMTAfterActivation > dmPaymentAMTPaperCard Then
                    MessageBox.Show("仅限充值券才可以使用后付式的""转账/支票""支付方式！    " & Chr(13) & Chr(13) & "请添加其它支付方式或重新分配非充值券的卡行的支付方式。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    If blNeedClearRowPayment Then dtRowPayment.Rows.Clear() : dtRowPayment.AcceptChanges()
                    Me.Activate()
                    Me.dgvPayment.Select()
                    Me.dgvPayment.EditMode = DataGridViewEditMode.EditOnEnter
                    Me.dgvPayment("PaymentAMT", Me.dgvPayment.RowCount - 1).Selected = True
                    Return False
                End If

                If drSalesBill("RebateMode") = 2 AndAlso drSalesBill("ContractRebateThisRebateRemarks").ToString = "未达到单次最低购买金额。" Then
                    MessageBox.Show("当前销售单不能使用合同，因为购买金额未达到合同规定的单次最低购买金额！    " & Chr(13) & Chr(13) & _
                                    "        合同编号： " & Me.txbContractCode.Text & Chr(13) & _
                                    "        合同客户： " & Me.txbCustomerName.Text & Chr(13) & _
                                    "单次最低购买金额： " & Format(drContract("MinAMTPerPurchase"), "#,0.00") & " 元" & Chr(13) & _
                                    "当前实际购买金额： " & Format(dmNormalSalesAMT, "#,0.00") & " 元" & Chr(13) & Chr(13) & _
                                    "如欲给予返点，请不要使用合同，改用城市返点。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.Activate()
                    Me.dgvNormalCard.Select()
                    Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True
                    frmMain.statusText.Text = "不能保存销售单，因为购买金额未达到合同规定的单次最低购买金额！"
                    Return False
                End If

                'If drSalesBill("RebateMode") <> 2 AndAlso drSalesBill("ContractID").ToString <> "" AndAlso (drContract("MinAMTPerPurchase").ToString = "" OrElse dmNormalSalesAMT >= drContract("MinAMTPerPurchase")) AndAlso (sContractAppointedStoreID = "" OrElse sContractAppointedStoreID = drSalesBill("StoreID").ToString) AndAlso _
                'MessageBox.Show("注意：该客户存在有效合同，且当前的购买金额也达到可以使用该合同的条件。    " & Chr(13) & Chr(13) & _
                '                "      但您没有选择使用合同！这将会使当前的购买金额不能被累计到该合同。     " & Chr(13) & Chr(13) & _
                '                "您确实不想对当前销售使用合同吗？ 按""否""将取消保存以便选择使用合同。    ", _
                '                "请确认不使用合同：", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) = Windows.Forms.DialogResult.No Then
                '    Me.Activate()
                '    Me.grbContract.Select()
                '    Me.chbContract.Select()
                '    Me.chbContract.Checked = True
                '    frmMain.statusText.Text = "您已取消保存销售单。"
                '    Return False
                'End If

                'modify code 064,068:start-------------------------------------------------------------------------
                'If bNewSalesBillType <> 7 AndAlso bNewSalesBillType <> 8 Then
                If drSalesBill("RebateMode") <> 2 AndAlso drSalesBill("ContractID").ToString <> "" AndAlso (drContract("MinAMTPerPurchase").ToString = "" OrElse dmNormalSalesAMT >= drContract("MinAMTPerPurchase")) AndAlso (sContractAppointedStoreID = "" OrElse sContractAppointedStoreID = drSalesBill("StoreID").ToString) AndAlso _
                MessageBox.Show("注意：该客户存在有效合同，且当前的购买金额也达到可以使用该合同的条件。    " & Chr(13) & Chr(13) & _
                            "      但您没有选择使用合同！这将会使当前的购买金额不能被累计到该合同。     " & Chr(13) & Chr(13) & _
                            "您确实不想对当前销售使用合同吗？ 按""否""将取消保存以便选择使用合同。    ", _
                            "请确认不使用合同：", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) = Windows.Forms.DialogResult.No Then
                    Me.Activate()
                    Me.grbContract.Select()
                    Me.chbContract.Select()
                    Me.chbContract.Checked = True
                    frmMain.statusText.Text = "您已取消保存销售单。"
                    Return False
                End If
                'End If
                'modify code 064,068:end-------------------------------------------------------------------------
            End If

            'modify code 046,054:start-------------------------------------------------------------------------
            '同一般销售单
            'If bNewSalesBillType = 0 AndAlso dmRebateSalesAMT <> dmAvailableRebateAMT Then
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso dmRebateSalesAMT <> dmAvailableRebateAMT Then
            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso dmRebateSalesAMT <> dmAvailableRebateAMT Then
                'modify code 046,054:end-------------------------------------------------------------------------
                Dim bAnswer As DialogResult = Windows.Forms.DialogResult.No, sFormattedValue1 As String, sFormattedValue2 As String, sFormattedValue3 As String, sStatusText As String = ""
                If drSalesBill("RebateMode") = 1 Then '一般返点
                    If dmRebateSalesAMT = 0 Then
                        'modify code 038:start-------------------------------------------------------------------------
                        'sFormattedValue1 = Format(dmAvailableRebateRate * 100, "#,0.0") & "  %    " : sFormattedValue2 = Format(dmAvailableRebateAMT, "#,0.00") & " 元    "
                        sFormattedValue1 = Format(dmAvailableRebateRate * 100, "#,0.00") & "  %    " : sFormattedValue2 = Format(dmAvailableRebateAMT, "#,0.00") & " 元    "
                        'modify code 038:end-------------------------------------------------------------------------
                        If sFormattedValue1.Length < sFormattedValue2.Length Then sFormattedValue1 = Space(sFormattedValue2.Length - sFormattedValue1.Length) & sFormattedValue1
                        MessageBox.Show("您已指定返点，但还没有分配返点卡。    " & Chr(13) & Chr(13) & "已指定的返点比率： " & sFormattedValue1 & Chr(13) & "已指定的返点金额： " & sFormattedValue2 & Chr(13) & Chr(13) & "请您分配返点卡，或者取消该单的返点。    ", "还未分配返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        sStatusText = "未保存销售单，因为您还未分配返点卡！"
                    ElseIf dmRebateSalesAMT < dmAvailableRebateAMT Then
                        sFormattedValue1 = Format(dmAvailableRebateAMT, "#,0.00") & " 元    " : sFormattedValue2 = Format(dmRebateSalesAMT, "#,0.00") & " 元    " : sFormattedValue3 = Format(dmAvailableRebateAMT - dmRebateSalesAMT, "#,0.00") & " 元    "
                        If sFormattedValue2.Length < sFormattedValue1.Length Then sFormattedValue2 = Space(sFormattedValue1.Length - sFormattedValue2.Length) & sFormattedValue2
                        If sFormattedValue3.Length < sFormattedValue1.Length Then sFormattedValue3 = Space(sFormattedValue1.Length - sFormattedValue3.Length) & sFormattedValue3
                        MessageBox.Show("已分配的返点金额未达到您指定的返点金额。    " & Chr(13) & Chr(13) & "已指定的返点金额： " & sFormattedValue1 & Chr(13) & "已分配的返点金额： " & sFormattedValue2 & Chr(13) & "待分配的返点金额： " & sFormattedValue3 & Chr(13) & Chr(13) & "请您继续分配返点卡，或者减少指定的返点金额。    ", "已分配的返点金额不足！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        sStatusText = "未保存销售单，因为已分配的返点金额不足！"
                    Else
                        sFormattedValue1 = Format(dmAvailableRebateAMT, "#,0.00") & " 元    " : sFormattedValue2 = Format(dmRebateSalesAMT, "#,0.00") & " 元    " : sFormattedValue3 = Format(dmRebateSalesAMT - dmAvailableRebateAMT, "#,0.00") & " 元    "
                        If sFormattedValue1.Length < sFormattedValue2.Length Then sFormattedValue1 = Space(sFormattedValue2.Length - sFormattedValue1.Length) & sFormattedValue1
                        If sFormattedValue3.Length < sFormattedValue2.Length Then sFormattedValue3 = Space(sFormattedValue2.Length - sFormattedValue3.Length) & sFormattedValue3
                        MessageBox.Show("已分配的返点金额超出您指定的返点金额。    " & Chr(13) & Chr(13) & "已指定的返点金额： " & sFormattedValue1 & Chr(13) & "已分配的返点金额： " & sFormattedValue2 & Chr(13) & "已超出的返点金额： " & sFormattedValue3 & Chr(13) & Chr(13) & "请您减少返点卡的充值金额，或者增加指定的返点金额。    ", "已分配的返点金额过多！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        sStatusText = "未保存销售单，因为已分配的返点金额超出指定的返点金额！"
                    End If
                Else '合同返点
                    If dmRebateSalesAMT = 0 Then
                        bAnswer = MessageBox.Show("本次销售存在可兑现的返点金额，但您还没有分配任何返点卡。    " & Chr(13) & Chr(13) & "可兑现的返点金额： " & Format(dmAvailableRebateAMT, "#,0.00") & " 元    " & Chr(13) & Chr(13) & "您确实不在本次分配这些返点金额吗？    " & Chr(13) & "（提示：可在另外一次购卡时再兑现）    ", "请确认不分配返点金额：", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2)
                        sStatusText = "未保存销售单，因为您还未分配返点卡！"
                    ElseIf dmRebateSalesAMT < dmAvailableRebateAMT Then
                        sFormattedValue1 = Format(dmAvailableRebateAMT, "#,0.00") & " 元    " : sFormattedValue2 = Format(dmRebateSalesAMT, "#,0.00") & " 元    " : sFormattedValue3 = Format(dmAvailableRebateAMT - dmRebateSalesAMT, "#,0.00") & " 元    "
                        If sFormattedValue2.Length < sFormattedValue1.Length Then sFormattedValue2 = Space(sFormattedValue1.Length - sFormattedValue2.Length) & sFormattedValue2
                        If sFormattedValue3.Length < sFormattedValue1.Length Then sFormattedValue3 = Space(sFormattedValue1.Length - sFormattedValue3.Length) & sFormattedValue3
                        bAnswer = MessageBox.Show("您还未完全分配所有的返点金额。    " & Chr(13) & Chr(13) & "可兑现的返点金额： " & sFormattedValue1 & Chr(13) & "已分配的返点金额： " & sFormattedValue2 & Chr(13) & "  剩余的返点金额： " & sFormattedValue3 & Chr(13) & Chr(13) & "您确实不在本次分配完这些剩余金额吗？    " & Chr(13) & "（提示：可在另外一次购卡时再兑现）    ", "请确认不分配剩余的返点金额：", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2)
                        sStatusText = "未保存销售单，因为您还未完全分配所有的返点金额！"
                    Else
                        sFormattedValue1 = Format(dmAvailableRebateAMT, "#,0.00") & " 元    " : sFormattedValue2 = Format(dmRebateSalesAMT, "#,0.00") & " 元    " : sFormattedValue3 = Format(dmRebateSalesAMT - dmAvailableRebateAMT, "#,0.00") & " 元    "
                        If sFormattedValue1.Length < sFormattedValue2.Length Then sFormattedValue1 = Space(sFormattedValue2.Length - sFormattedValue1.Length) & sFormattedValue1
                        If sFormattedValue3.Length < sFormattedValue2.Length Then sFormattedValue3 = Space(sFormattedValue2.Length - sFormattedValue3.Length) & sFormattedValue3
                        MessageBox.Show("已分配的返点金额超出本次可兑现的最大返点金额。    " & Chr(13) & Chr(13) & "可兑现的返点金额： " & sFormattedValue1 & Chr(13) & "已分配的返点金额： " & sFormattedValue2 & Chr(13) & "已超出的返点金额： " & sFormattedValue3 & Chr(13) & Chr(13) & "请您重新分配卡及其金额，否则无法保存！    ", "已分配的返点金额过多！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        sStatusText = "未保存销售单，因为已分配的返点金额超出本次可兑现的最大返点金额！"
                    End If
                End If

                If bAnswer = Windows.Forms.DialogResult.No Then
                    Me.Activate()
                    Me.dgvRebateCard.Select()
                    Me.dgvRebateCard("FaceValue", 0).Selected = True
                    frmMain.statusText.Text = sStatusText
                    Return False
                End If
            End If

            'modify code 046,054:start-------------------------------------------------------------------------
            '同一般销售单
            'If bNewSalesBillType = 0 AndAlso drSalesBill("RebateMode") = 0 AndAlso drNewestCityRule IsNot Nothing Then
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("RebateMode") = 0 AndAlso drNewestCityRule IsNot Nothing Then
            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso drSalesBill("RebateMode") = 0 AndAlso drNewestCityRule IsNot Nothing Then
                'modify code 046,054:end-------------------------------------------------------------------------
                Dim dmMinAbleAmount As Decimal = -1
                Try
                    dmMinAbleAmount = dtNewestRuleDetails.Select("MaxRebateRate>0")(0)("StartSalesAMT")
                Catch
                End Try
                If dmMinAbleAmount > -1 AndAlso dmNormalSalesAMT > dmMinAbleAmount AndAlso MessageBox.Show("根据当前城市的返点规则，该销售单是可以享有返点的。但您并未给予返点。    " & Chr(13) & Chr(13) & "您是否确实不想给予该销售单返点？若想给予返点，请按""否""，以便分配返点。    ", "请确认不给予返点？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.No Then
                    Me.Activate()
                    Me.dgvRebateCard.Select()
                    Me.chbNormalRebate.Select()
                    Me.chbNormalRebate.Checked = True
                    frmMain.statusText.Text = "您已取消保存销售单。"
                    Return False
                End If
            End If

            If drSalesBill("RebateMode") = 1 AndAlso drSalesBill("RebateState") = 0 Then
                Dim sPrompt As String = "该单在当前城市（" & drNewestCityRule("CityFullName").ToString.Substring(5) & "）下的最大许可返点是：    " & Chr(13) & Chr(13)
                For Each drRule In dtNewestRuleDetails.Rows
                    If drRule("EndSalesAMT").ToString <> "" AndAlso dmNormalSalesAMT > drRule("StartSalesAMT") - 1 AndAlso dmNormalSalesAMT <= drRule("EndSalesAMT") Then
                        Exit For
                    End If
                Next

                'modify code 038:start-------------------------------------------------------------------------
                'sPrompt = sPrompt & "返点比率： " & Format(dmMaxNormalRebateRate * 100, "#,0.0") & " %    返点金额： " & Format(dmMaxNormalRebateAMT, "#,0.00") & " 元    " & Chr(13) & Chr(13)
                sPrompt = sPrompt & "返点比率： " & Format(dmMaxNormalRebateRate * 100, "#,0.00") & " %    返点金额： " & Format(dmMaxNormalRebateAMT, "#,0.00") & " 元    " & Chr(13) & Chr(13)
                sPrompt = sPrompt & "但您实际已分配的返点是：    " & Chr(13) & Chr(13)
                'sPrompt = sPrompt & "返点比率： " & Format(dmAvailableRebateRate * 100, "#,0.0") & " %    返点金额： " & Format(dmAvailableRebateAMT, "#,0.00") & " 元    " & Chr(13) & Chr(13)
                sPrompt = sPrompt & "返点比率： " & Format(dmAvailableRebateRate * 100, "#,0.00") & " %    返点金额： " & Format(dmAvailableRebateAMT, "#,0.00") & " 元    " & Chr(13) & Chr(13)
                sPrompt = sPrompt & "因此，该单的返点将需要""" & Me.lblNormalRebateRemarks.Text.Substring(Me.lblNormalRebateRemarks.Text.IndexOf(Chr(13)) + 1) & """的进一步审核方能生效！    " & Chr(13) & Chr(13)
                'modify code 038:end-------------------------------------------------------------------------
                If drSalesBill("RebateRate") > 0.2 Then sPrompt = sPrompt & "注意！由于该单的返点比率超过 20 %，该单返点很可能不能通过审核！    " & Chr(13) & Chr(13)
                sPrompt = sPrompt & "您是否确实想给予该单超过所在城市标准的返点？    "
                If MessageBox.Show(sPrompt, "该单的返点已经超出所在城市的标准！", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) = Windows.Forms.DialogResult.No Then
                    Me.Activate()
                    Me.dgvRebateCard.Select()
                    Me.dgvRebateCard("FaceValue", 0).Selected = True
                    frmMain.statusText.Text = "该单的返点已经超出所在城市的标准！"
                    Return False
                End If
            End If
        End If

        'modify code 040,044:start-------------------------------------------------------------------------
        If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
            If strSelectedBuyChannel = "Cul" Then
                'If dtNormalCard.Select("FaceValue = " & ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.CardPrice).Length < ecir.ExtractingCodeInfoData.BillTotalNum Then
                If dtNormalCard.Select("FaceValue <> " & ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.CardPrice).Length > 0 Then
                    MessageBox.Show("卡面值与提取码不符。请重新输入。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.Activate()
                    Me.dgvNormalCard.Select()
                    Me.dgvNormalCard("StartCardNo", 0).Selected = True
                    frmMain.statusText.Text = "不能保存销售单，因为卡面值有误！"
                    Return False
                End If
                If dtNormalCard.Compute("Sum(CardQTY)", "") <> ecir.ExtractingCodeInfoData.BillTotalNum Then
                    MessageBox.Show("卡数量与提取码不符。请重新输入。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.Activate()
                    Me.dgvNormalCard.Select()
                    Me.dgvNormalCard("StartCardNo", Me.dgvNormalCard.RowCount - 1).Selected = True
                    frmMain.statusText.Text = "不能保存销售单，因为卡数量有误！"
                    Return False
                End If
            End If

            If strSelectedBuyChannel = "RuiTai" Then
                Dim sumPayment As Decimal = 0
                For Each drCard As DataRow In dtNormalCard.Rows
                    If drCard("FaceValue").ToString <> "" Then
                        sumPayment = sumPayment + CDec(drCard("FaceValue").ToString) * CDec(drCard("CardQTY").ToString)
                    End If
                Next

                If sumPayment <> CDec(cir.CodeAmount.ToString) / 100 Then
                    MessageBox.Show("总金额与提取码不符。请重新输入。    ", "不能保存销售单！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    Me.Activate()
                    Me.dgvNormalCard.Select()
                    Me.dgvNormalCard("StartCardNo", 0).Selected = True
                    frmMain.statusText.Text = "不能保存销售单，因为总金额有误！"
                    Return False
                End If
            End If
        End If
        'modify code 040,044:end-------------------------------------------------------------------------

        Dim dtNow As Date = Now(), blDeadLock As Byte = False

        Me.Refresh()
        Me.Cursor = Cursors.WaitCursor
        Dim sTask As String = IIf(My.Settings.IsInTraining, "保存销售单", "检查购物卡的可用状态")
        frmMain.statusText.Text = "正在" & sTask & "……"
        frmMain.statusMain.Refresh()
        Dim DB As New DataBase, sSQL As String = ""
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & sTask & "。请检查数据库连接。"
            Me.Cursor = Cursors.Default
            Me.Activate() : Return False
        End If

        'modify code 046:start-------------------------------------------------------------------------
        Dim dtTempSignCard As New DataTable, drTempSignCard As DataRow
        dtTempSignCard.Columns.Add("CardNo", System.Type.GetType("System.String"))
        dtTempSignCard.Columns.Add("HolderName", System.Type.GetType("System.String"))
        dtTempSignCard.Columns.Add("Gender", System.Type.GetType("System.String"))
        dtTempSignCard.Columns.Add("HolderIdNo", System.Type.GetType("System.String"))
        dtTempSignCard.Columns.Add("Mobile", System.Type.GetType("System.String"))
        dtTempSignCard.Columns.Add("CardType", System.Type.GetType("System.String"))
        dtTempSignCard.Columns.Add("OperationDes", System.Type.GetType("System.String"))
        'modify code 046:end-------------------------------------------------------------------------

        Dim dtTempCard As New DataTable, drTempCard As DataRow, sCardNo As String, iRowCardQTY As Integer, blNeedCheckCard As Boolean = (Not My.Settings.IsInTraining) '培训模式不必检查卡状态
        dtTempCard.Columns.Add("SalesBillDetailID", System.Type.GetType("System.Int32"))
        dtTempCard.Columns.Add("CardNo", System.Type.GetType("System.String"))
        dtTempCard.Columns.Add("FaceValue", System.Type.GetType("System.Decimal"))
        dtTempCard.Columns.Add("CardType", System.Type.GetType("System.Byte"))
        dtTempCard.Columns.Add("RowType", System.Type.GetType("System.Byte"))
        dtTempCard.Columns.Add("RowID", System.Type.GetType("System.Int16"))

        If drSalesBill("NormalSalesAMT") > 0 Then
            For Each drNormal As DataRow In dtNormalCard.Select("Isnull(StartCardNo,'')<>''", "RowID")
                sCardNo = drNormal("StartCardNo").ToString
                If sCardNo.IndexOf("2") = 0 Then sCardNo = sCardNo.Substring(0, 18)
                iRowCardQTY = drNormal("CardQTY") - 1
                For iCard As Integer = 0 To iRowCardQTY
                    drTempCard = dtTempCard.Rows.Add()
                    If sCardNo.IndexOf("2") = 0 Then
                        drTempCard("CardNo") = ShoppingCardNo.GetFullCardNo((CLng(sCardNo) + iCard).ToString)
                    Else
                        drTempCard("CardNo") = (CLng(sCardNo) + iCard).ToString
                    End If
                    drTempCard("FaceValue") = drNormal("FaceValue")
                    drTempCard("RowType") = IIf(bNewSalesBillType = 1, 1, 0)
                    drTempCard("RowID") = drNormal("RowID")

                    'modify code 046:start-------------------------------------------------------------------------
                    '获取实名卡持卡人信息
                    If bNewSalesBillType = 7 Then
                        drTempSignCard = dtTempSignCard.Rows.Add()
                        drTempSignCard("CardNo") = drTempCard("CardNo")
                        drTempSignCard("HolderName") = drNormal("HolderName")
                        drTempSignCard("Gender") = drNormal("Gender")
                        drTempSignCard("HolderIdNo") = drNormal("HolderIdNo")
                        drTempSignCard("Mobile") = drNormal("Mobile")
                        drTempSignCard("CardType") = "实名制卡"
                    End If
                    'modify code 046:end-------------------------------------------------------------------------
                Next
            Next
        End If

        'modify code 046,050:start-------------------------------------------------------------------------
        '实名制卡临时表保存失败
        'If DB.ModifyTable("Select Convert(char(19),CardNo) As CardNo,Convert(nvarchar(20),'') As HolderName,Convert(nvarchar(1),'') As Gender,Convert(char(18),HolderIdNo) As HolderIdNo,Convert(char(20),'') As Mobile,Convert(nvarchar(10),CardType) As CardType,Convert(nvarchar(10),OperationDes) As OperationDes Into #tempSignCard From SignCardListNew Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempSignCard", dtTempSignCard) = -1 Then
        '    frmMain.statusText.Text = sTask & "失败！"
        '    dtTempSignCard.Dispose() : dtTempSignCard = Nothing
        '    DB.Close() : Me.Cursor = Cursors.Default
        '    Me.Activate() : Return False
        'End If
        'modify code 046,050:end-------------------------------------------------------------------------

        If drSalesBill("RebateSalesAMT") > 0 Then
            For Each drRebate As DataRow In dtRebateCard.Select("Isnull(StartCardNo,'')<>''", "RowID")
                sCardNo = drRebate("StartCardNo").ToString
                If sCardNo.IndexOf("2") = 0 Then sCardNo = sCardNo.Substring(0, 18)
                iRowCardQTY = drRebate("CardQTY") - 1
                For iCard As Integer = 0 To iRowCardQTY
                    drTempCard = dtTempCard.Rows.Add()
                    If sCardNo.IndexOf("2") = 0 Then
                        drTempCard("CardNo") = ShoppingCardNo.GetFullCardNo((CLng(sCardNo) + iCard).ToString)
                    Else
                        drTempCard("CardNo") = (CLng(sCardNo) + iCard).ToString
                    End If
                    drTempCard("FaceValue") = drRebate("FaceValue")
                    drTempCard("RowType") = 2
                    drTempCard("RowID") = drRebate("RowID")

                    'modify code 050:start-------------------------------------------------------------------------
                    '获取实名卡持卡人信息
                    If bNewSalesBillType = 7 Then
                        drTempSignCard = dtTempSignCard.Rows.Add()
                        drTempSignCard("CardNo") = drTempCard("CardNo")
                        drTempSignCard("HolderName") = drRebate("HolderName")
                        drTempSignCard("Gender") = drRebate("Gender")
                        drTempSignCard("HolderIdNo") = drRebate("HolderIdNo")
                        drTempSignCard("Mobile") = drRebate("Mobile")
                        drTempSignCard("CardType") = "实名制卡"
                    End If
                    'modify code 050:end-------------------------------------------------------------------------
                Next
            Next
        End If

        'modify code 050:start-------------------------------------------------------------------------
        '实名制卡临时表保存失败
        If DB.ModifyTable("Select Convert(char(19),CardNo) As CardNo,Convert(nvarchar(20),'') As HolderName,Convert(nvarchar(1),'') As Gender,Convert(char(18),HolderIdNo) As HolderIdNo,Convert(char(20),'') As Mobile,Convert(nvarchar(10),CardType) As CardType,Convert(nvarchar(10),OperationDes) As OperationDes Into #tempSignCard From SignCardListNew Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempSignCard", dtTempSignCard) = -1 Then
            frmMain.statusText.Text = sTask & "失败！"
            dtTempSignCard.Dispose() : dtTempSignCard = Nothing
            DB.Close() : Me.Cursor = Cursors.Default
            Me.Activate() : Return False
        End If
        'modify code 050:end-------------------------------------------------------------------------

        If dtAllCheckedCard IsNot Nothing AndAlso dtAllCheckedCard.Rows.Count > 0 Then '如果曾经检查过卡使用状态
            Dim drCheckedCard As DataRow, drProblemCard As DataRow
            'modify code 046:start-------------------------------------------------------------------------
            Dim maxChargeValue As Decimal = dmMaxFaceValue
            'modify code 046:end-------------------------------------------------------------------------
            blNeedCheckCard = False
            dtLastCheckingProblemCard.Rows.Clear()

            For Each drTempCard In dtTempCard.Select("", "RowType,RowID,CardNo")
                sCardNo = drTempCard("CardNo").ToString
                'modify code 046,050:start-------------------------------------------------------------------------
                maxChargeValue = 1000
                'If dtSignCardRangeNew.Select("CardNo='" & sCardNo & "'").Length = 1 Then
                If sCardNo.IndexOf("2336" & frmMain.signCardBin) = 0 Then
                    maxChargeValue = dmMaxSignCardFaceValue
                End If
                'modify code 046,050:end-------------------------------------------------------------------------
                drCheckedCard = dtAllCheckedCard.Rows.Find(sCardNo)
                If drCheckedCard Is Nothing Then
                    blNeedCheckCard = True '如果当前准备充值的卡不出现在针对该销售单的检查结果中，说明该卡未被检查，需要重新检查所有卡的状态
                    'modify code 046:start-------------------------------------------------------------------------
                    'ElseIf (drCheckedCard("UsageState") > 0) OrElse _
                    '   (drCheckedCard("CardType") = 2 AndAlso dtTempCard.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'") + drCheckedCard("Balance") > 1000) Then
                ElseIf (drCheckedCard("UsageState") > 0) OrElse _
                   (drCheckedCard("CardType") = 2 AndAlso dtTempCard.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'") + drCheckedCard("Balance") > maxChargeValue) Then
                    'modify code 046:end-------------------------------------------------------------------------
                    '该卡不可充值（如该卡已被充值、所在销售单等待取消、等待撤销充值、等待回收、等待换卡、冻结、结束或需要到银商系统查询状态等原因）
                    '或者该卡是顾客的再充值卡且状态正确，但存在余额，并且加上本次的充值金额后已超过1000元
                    drProblemCard = dtLastCheckingProblemCard.Rows.Find(sCardNo)
                    If drProblemCard Is Nothing Then
                        drProblemCard = dtLastCheckingProblemCard.Rows.Add()
                        drProblemCard("RowType") = Me.SetCardFeature(drTempCard("RowType"), sCardNo)
                        drProblemCard("RowID") = drTempCard("RowID").ToString
                        drProblemCard("CardNo") = sCardNo
                        drProblemCard("FaceValue") = dtTempCard.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'")
                        If drCheckedCard("UsageState") = 9 Then
                            drProblemCard("UsageState") = "（未知）" '上次到银商查询时失败
                        ElseIf drCheckedCard("UsageState") > 0 Then
                            drProblemCard("UsageState") = "不可售卖"
                        Else
                            drProblemCard("UsageState") = "面值受限"
                        End If
                        drProblemCard("UnchargableReason") = drCheckedCard("UnchargableReason").ToString
                        drProblemCard("Operation") = "拷贝卡号"
                    Else
                        drProblemCard("RowType") = "正常卡＋返点卡"
                        drProblemCard("RowID") = drProblemCard("RowID") & "+" & drTempCard("RowID").ToString
                    End If
                Else 'drCheckedCard("UsageState") = 0, 可售卖
                    drTempCard("CardType") = drCheckedCard("CardType") '0 - 新卡; 1 - 回收卡; 2 - 再充值卡（顾客自带）
                    If (DateDiff(DateInterval.Minute, Now(), CDate(sFirstCheckCardTime)) > 15) Then blNeedCheckCard = True : sFirstCheckCardTime = "" '如果该单第一次查询的时间已超过15分钟，则所有的卡都必须再查一遍
                End If
            Next
            dtLastCheckingProblemCard.AcceptChanges()

            If dtLastCheckingProblemCard.Rows.Count > 0 Then '如果目前卡列表中存在不可充值的卡
                With frmCheckCardResult
                    .blCanUse60Card = blCanUse60Card
                    .blCanUse92Card = blCanUse92Card
                    .blCanUse94Card = blCanUse94Card
                    .blCanUsePaperCard = blCanUsePaperCard
                    'modify code 051:start-------------------------------------------------------------------------
                    .blCanUse65Card = blCanUse65Card
                    'modify code 051:end-------------------------------------------------------------------------
                    .Show()
                End With
                Me.btnViewActivation.Text = "隐藏卡片检查结果(&R)" : Me.btnViewActivation.Enabled = True
                Dim sError As String = ""
                If dtLastCheckingProblemCard.Select("UsageState='不可售卖'").Length > 0 Then sError = "不可售卖、"
                If dtLastCheckingProblemCard.Select("UsageState='面值受限'").Length > 0 Then sError = sError & "面值受限、"
                If dtLastCheckingProblemCard.Select("UsageState='（未知）'").Length > 0 Then sError = sError & "可用状态不明确、"
                sError = sError.Substring(0, sError.Length - 1)
                If sError.LastIndexOf("、") > -1 Then sError = sError.Insert(sError.LastIndexOf("、"), "、").Replace("、、", "或")
                frmMain.statusText.Text = "充值列表中存在" & sError & "的卡片，所以不能保存该销售单！"
                dtTempCard.Dispose() : dtTempCard = Nothing
                DB.Close() : Me.Cursor = Cursors.Default
                Me.Activate() : Return False
            Else
                Me.btnViewActivation.Text = "激活明细(&A)" : Me.btnViewActivation.Enabled = False
            End If
        End If

        If DB.ModifyTable("Select Convert(int,0) As SalesBillDetailID,Convert(varchar(19),CardNo) As CardNo,FaceValue,CardType,Convert(tinyint,0) As RowType, Convert(smallint,0) As RowID Into #tempCard From NewActivationList Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempCard", dtTempCard) = -1 Then
            frmMain.statusText.Text = sTask & "失败！"
            dtTempCard.Dispose() : dtTempCard = Nothing
            DB.Close() : Me.Cursor = Cursors.Default
            Me.Activate() : Return False
        End If

        Dim dtResult As DataTable
        If blNeedCheckCard Then
            dtResult = DB.GetDataTable("Exec SalesBillCheckCardState")
            If dtResult Is Nothing Then
                frmMain.statusText.Text = "检查购物卡的使用状态失败！"
                DB.Close() : Me.Cursor = Cursors.Default
                Me.Activate() : Return False
            End If

            Dim drCheckedCard As DataRow, drProblemCard As DataRow
            '将本次检查结果保存到dtAllCheckedCard，以避免对同一张单相同卡号进行再次检查
            If dtAllCheckedCard Is Nothing OrElse dtAllCheckedCard.Rows.Count = 0 Then
                dtAllCheckedCard = dtResult.Copy
                dtAllCheckedCard.PrimaryKey = New DataColumn() {dtAllCheckedCard.Columns("CardNo")}
            Else
                For Each drCard As DataRow In dtResult.Select("CardType=2") '如果再充值卡在上一次的检查中已存在，无须到CUL再检查，以节省时间
                    drCheckedCard = dtAllCheckedCard.Rows.Find(drCard("CardNo").ToString)
                    If drCheckedCard IsNot Nothing AndAlso drCheckedCard("CardType") = 2 Then
                        drCard("UsageState") = drCheckedCard("UsageState")
                        drCard("Balance") = drCheckedCard("Balance")
                        drCard("UnchargableReason") = drCheckedCard("UnchargableReason")
                        drCard.EndEdit() : drCard.AcceptChanges()
                    End If
                Next
                dtAllCheckedCard.Merge(dtResult.Copy, False)
            End If
            blCanRecheckCard = False
            If sFirstCheckCardTime = "" Then sFirstCheckCardTime = Format(Now(), "yyyy\/MM\/dd HH:mm:ss")

            blNeedReloadCard = False
            If dtResult.Select("UsageState=9").Length > 0 Then '如果存在状态不明确需要到银商系统查询状态的卡
                frmCheckCardFromCUL.ShowDialog()
                frmCheckCardFromCUL.Dispose()
                Me.Refresh()
            End If
            dtResult.Dispose() : dtResult = Nothing

            If dtLastCheckingProblemCard Is Nothing Then
                dtLastCheckingProblemCard = New DataTable
                dtLastCheckingProblemCard.Columns.Add("RowType", System.Type.GetType("System.String"))
                dtLastCheckingProblemCard.Columns.Add("RowID", System.Type.GetType("System.String"))
                dtLastCheckingProblemCard.Columns.Add("CardNo", System.Type.GetType("System.String"))
                dtLastCheckingProblemCard.Columns.Add("FaceValue", System.Type.GetType("System.Decimal"))
                dtLastCheckingProblemCard.Columns.Add("UsageState", System.Type.GetType("System.String"))
                dtLastCheckingProblemCard.Columns.Add("UnchargableReason", System.Type.GetType("System.String"))
                dtLastCheckingProblemCard.Columns.Add("Operation", System.Type.GetType("System.String"))
                dtLastCheckingProblemCard.PrimaryKey = New DataColumn() {dtLastCheckingProblemCard.Columns("CardNo")}
                dtLastCheckingProblemCard.Columns("CardNo").AllowDBNull = True
            Else
                dtLastCheckingProblemCard.Rows.Clear()
            End If

            If dtAllCheckedCard.Select("CardType=2 Or UsageState>0").Length > 0 Then '如果检查结果中包含再充值卡或当次不可充值的卡，需要检查当前充值列表是否存在问题卡
                'modify code 046,050:start-------------------------------------------------------------------------
                Dim maxChargeValue As Decimal = dmMaxFaceValue
                'modify code 046:end-------------------------------------------------------------------------
                For Each drTempCard In dtTempCard.Select("", "RowType,RowID,CardNo")
                    sCardNo = drTempCard("CardNo").ToString
                    'modify code 046:start-------------------------------------------------------------------------
                    maxChargeValue = 1000
                    'If dtSignCardRangeNew.Select("CardNo='" & sCardNo & "'").Length = 1 Then
                    If sCardNo.IndexOf("2336" & frmMain.signCardBin) = 0 Then
                        maxChargeValue = dmMaxSignCardFaceValue
                    End If
                    'modify code 046,050:end-------------------------------------------------------------------------
                    drCheckedCard = dtAllCheckedCard.Rows.Find(sCardNo)
                    'If (drCheckedCard("UsageState") > 0) OrElse _
                    '   (drCheckedCard("CardType") = 2 AndAlso dtTempCard.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'") + drCheckedCard("Balance") > 1000) Then
                    If (drCheckedCard("UsageState") > 0) OrElse _
                   (drCheckedCard("CardType") = 2 AndAlso dtTempCard.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'") + drCheckedCard("Balance") > maxChargeValue) Then
                        '该卡不可充值（如该卡已被充值、所在销售单等待取消、等待撤销充值、等待回收、等待换卡、冻结、结束或需要到银商系统查询状态等原因）
                        '或者该卡是顾客的再充值卡但未查询过卡状态及余额（需要查询）：UsageState = 9
                        '或者该卡是顾客的再充值卡且状态正确，但存在余额，并且加上本次的充值金额后已超过1000元
                        drProblemCard = dtLastCheckingProblemCard.Rows.Find(sCardNo)
                        If drProblemCard Is Nothing Then
                            drProblemCard = dtLastCheckingProblemCard.Rows.Add()
                            drProblemCard("RowType") = Me.SetCardFeature(drTempCard("RowType"), sCardNo)
                            drProblemCard("RowID") = drTempCard("RowID").ToString
                            drProblemCard("CardNo") = sCardNo
                            drProblemCard("FaceValue") = dtTempCard.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'")
                            If drCheckedCard("UsageState") = 9 Then
                                drProblemCard("UsageState") = "（未知）"
                            ElseIf drCheckedCard("UsageState") > 0 Then
                                drProblemCard("UsageState") = "不可售卖"
                            Else
                                drProblemCard("UsageState") = "面值受限"
                            End If
                            drProblemCard("UnchargableReason") = drCheckedCard("UnchargableReason").ToString
                            drProblemCard("Operation") = "拷贝卡号"
                        Else
                            drProblemCard("RowType") = "正常卡＋返点卡"
                            drProblemCard("RowID") = drProblemCard("RowID") & "+" & drTempCard("RowID").ToString
                        End If
                    End If
                Next
            End If
            dtLastCheckingProblemCard.AcceptChanges()

            If dtLastCheckingProblemCard.Rows.Count > 0 Then '如果目前卡列表中存在不可充值的卡
                With frmCheckCardResult
                    .blCanUse60Card = blCanUse60Card
                    .blCanUse92Card = blCanUse92Card
                    .blCanUse94Card = blCanUse94Card
                    .blCanUsePaperCard = blCanUsePaperCard
                    'modify code 051:start-------------------------------------------------------------------------
                    .blCanUse65Card = blCanUse65Card
                    'modify code 051:end-------------------------------------------------------------------------
                    .Show()
                End With
                Me.btnViewActivation.Text = "隐藏卡片检查结果(&R)" : Me.btnViewActivation.Enabled = True
                Dim sError As String = ""
                If dtLastCheckingProblemCard.Select("UsageState='不可售卖'").Length > 0 Then sError = "不可售卖、"
                If dtLastCheckingProblemCard.Select("UsageState='面值受限'").Length > 0 Then sError = sError & "面值受限、"
                If dtLastCheckingProblemCard.Select("UsageState='（未知）'").Length > 0 Then sError = sError & "可用状态不明确、"
                sError = sError.Substring(0, sError.Length - 1)
                If sError.LastIndexOf("、") > -1 Then sError = sError.Insert(sError.LastIndexOf("、"), "、").Replace("、、", "或")
                frmMain.statusText.Text = "充值列表中存在" & sError & "的卡片，所以不能保存该销售单！"
                dtTempCard.Dispose() : dtTempCard = Nothing
                DB.Close() : Me.Cursor = Cursors.Default
                Me.Activate() : Return False
            End If

            If blNeedReloadCard Then
                For Each drTempCard In dtTempCard.Rows
                    drCheckedCard = dtAllCheckedCard.Rows.Find(drTempCard("CardNo").ToString)
                    drTempCard("CardType") = drCheckedCard("CardType")
                Next

                If DB.ModifyTable("Delete From #tempCard") = -1 OrElse DB.BulkCopyTable("#tempCard", dtTempCard) = -1 Then
                    frmMain.statusText.Text = "保存销售单失败！"
                    dtTempCard.Dispose() : dtTempCard = Nothing
                    DB.Close() : Me.Cursor = Cursors.Default
                    Me.Activate() : Return False
                End If
            End If
        End If
        dtTempCard.Dispose() : dtTempCard = Nothing

        'modify code 004:start-------------------------------------------------------------------------
        '增减银商实时检查卡激活状态，只有充值的礼品卡，需要检查。
        'modify code 046,054:start-------------------------------------------------------------------------
        '同一般销售单
        'If bNewSalesBillType = 0 Then
        'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 Then
        If bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 Then
            'modify code 046,054:end-------------------------------------------------------------------------
            If My.Settings.IsInTraining Then   '培训模式下，不检查。
            Else                               '生产模式下，实时连银商检查卡的激活状态，只有返回状态为已激活的礼品卡可以充值。
                For i As Integer = 0 To Me.dtNormalCard.Rows.Count - 1
                    If dtNormalCard.Rows(i).Item("FirstBuy").ToString = "充值" Then
                        Dim sStartCardNo As String = dtNormalCard.Rows(i).Item("StartCardNo").ToString
                        'Dim sMerchantNo As String = dtCardParameter.Select("CULCardBin='" & sStartCardNo.Substring(4, 5) & "'")(0)("CULStoreCode").ToString
                        Dim sMerchantNo As String = frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("CULStoreCode").ToString
                        Dim dtTemp As DataTable = ShoppingCardOperation.GetCRFCardState(sMerchantNo, sStartCardNo, dtNormalCard.Rows(i).Item("EndCardNo").ToString)
                        If dtTemp.Rows(0)("CardNo").ToString = "Error" Then
                            frmMain.statusText.Text = "查询卡片状态时发生错误！错误提示：" & dtTemp.Rows(0)("StoreName").ToString
                            MessageBox.Show("查询卡片状态时发生错误！错误提示：" & dtTemp.Rows(0)("StoreName").ToString, "查询卡片状态时发生错误！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                            dtTemp.Dispose() : dtTemp = Nothing
                            Me.Activate() : Return False
                        Else
                            For Each drCUL As DataRow In dtTemp.Rows
                                If drCUL("CardState").ToString = "已激活" Then

                                Else
                                    frmMain.statusText.Text = "卡状态不正确！"
                                    MessageBox.Show("充值的礼品卡必须是已激活状态！错误提示：" & drCUL("CardNo").ToString, "卡状态不正确！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                                    dtTemp.Dispose() : dtTemp = Nothing
                                    Me.Activate() : Return False
                                End If
                            Next
                        End If
                    End If
                Next
            End If
        End If
        'modify code 004:end-------------------------------------------------------------------------

        frmMain.statusText.Text = "正在保存销售单……"
        frmMain.statusMain.Refresh()

        Dim dtTempDetails As New DataTable, drTempDetail As DataRow
        dtTempDetails.Columns.Add("RowType", System.Type.GetType("System.Byte"))
        dtTempDetails.Columns.Add("RowID", System.Type.GetType("System.Int16"))
        'modify code 004:start-------------------------------------------------------------------------
        dtTempDetails.Columns.Add("FirstBuy", System.Type.GetType("System.String"))
        'modify code 004:end-------------------------------------------------------------------------
        dtTempDetails.Columns.Add("StartCardNo", System.Type.GetType("System.String"))
        dtTempDetails.Columns.Add("EndCardNo", System.Type.GetType("System.String"))
        dtTempDetails.Columns.Add("CardQTY", System.Type.GetType("System.Int32"))
        'modify code 011:start-------------------------------------------------------------------------
        dtTempDetails.Columns.Add("BarCode", System.Type.GetType("System.String"))
        'modify code 011:end-------------------------------------------------------------------------
        dtTempDetails.Columns.Add("FaceValue", System.Type.GetType("System.Decimal"))
        dtTempDetails.Columns.Add("CardPayment", System.Type.GetType("System.Decimal"))
        dtTempDetails.Columns.Add("CardCost", System.Type.GetType("System.Decimal"))
        dtTempDetails.Columns.Add("PayableAMT", System.Type.GetType("System.Decimal"))
        'modify code 046:start-------------------------------------------------------------------------
        dtTempDetails.Columns.Add("SalesBillDetailID", System.Type.GetType("System.Int32"))
        dtTempDetails.Columns.Add("HolderIdNo", System.Type.GetType("System.String"))
        dtTempDetails.Columns.Add("HolderName", System.Type.GetType("System.String"))
        dtTempDetails.Columns.Add("Gender", System.Type.GetType("System.String"))
        dtTempDetails.Columns.Add("Mobile", System.Type.GetType("System.String"))
        dtTempDetails.Columns.Add("IsSignCard", System.Type.GetType("System.String"))
        'modify code 046:end-------------------------------------------------------------------------

        If drSalesBill("NormalSalesAMT") > 0 Then
            For Each drNormal As DataRow In dtNormalCard.Select("Isnull(StartCardNo,'')<>''", "RowID")
                drTempDetail = dtTempDetails.Rows.Add()
                drTempDetail("RowType") = IIf(bNewSalesBillType = 1, 1, 0)
                drTempDetail("RowID") = drNormal("RowID")
                'modify code 004:start-------------------------------------------------------------------------
                drTempDetail("FirstBuy") = drNormal("FirstBuy")
                'modify code 004:end-------------------------------------------------------------------------
                drTempDetail("StartCardNo") = drNormal("StartCardNo")
                drTempDetail("EndCardNo") = drNormal("EndCardNo")
                drTempDetail("CardQTY") = drNormal("CardQTY")
                'modify code 011:start-------------------------------------------------------------------------
                drTempDetail("BarCode") = drNormal("BarCode").ToString
                'modify code 011:end-------------------------------------------------------------------------
                drTempDetail("FaceValue") = drNormal("FaceValue")
                drTempDetail("CardPayment") = IIf(bNewSalesBillType = 1, 0, drNormal("CardPayment"))
                'modify code 004:start-------------------------------------------------------------------------
                'drTempDetail("CardCost") = IIf(bNewSalesBillType = 0, drNormal("CardCost"), 0)
                drTempDetail("CardCost") = IIf(bNewSalesBillType = 1, 0, drNormal("CardCost"))
                'modify code 004:end-------------------------------------------------------------------------
                drTempDetail("PayableAMT") = IIf(bNewSalesBillType = 1, 0, drNormal("PayableAMT"))

                'modify code 046:start-------------------------------------------------------------------------
                drTempDetail("SalesBillDetailID") = 0
                drTempDetail("HolderName") = drNormal("HolderName").ToString
                drTempDetail("Gender") = drNormal("Gender").ToString
                drTempDetail("HolderIdNo") = drNormal("HolderIdNo").ToString
                drTempDetail("Mobile") = drNormal("Mobile").ToString
                drTempDetail("IsSignCard") = drNormal("IsSignCard").ToString
                'modify code 046:end-------------------------------------------------------------------------
            Next
        End If

        If drSalesBill("RebateSalesAMT") > 0 Then
            For Each drRebate As DataRow In dtRebateCard.Select("Isnull(StartCardNo,'')<>''", "RowID")
                drTempDetail = dtTempDetails.Rows.Add()
                drTempDetail("RowType") = 2
                drTempDetail("RowID") = drRebate("RowID")
                'modify code 004:start-------------------------------------------------------------------------
                drTempDetail("FirstBuy") = ""
                'modify code 004:end-------------------------------------------------------------------------
                drTempDetail("StartCardNo") = drRebate("StartCardNo")
                drTempDetail("EndCardNo") = drRebate("EndCardNo")
                drTempDetail("CardQTY") = drRebate("CardQTY")
                'modify code 011:start-------------------------------------------------------------------------
                drTempDetail("BarCode") = ""
                'modify code 011:end-------------------------------------------------------------------------
                drTempDetail("FaceValue") = drRebate("FaceValue")
                drTempDetail("CardPayment") = 0
                drTempDetail("CardCost") = 0
                drTempDetail("PayableAMT") = 0

                'modify code 046:start-------------------------------------------------------------------------
                drTempDetail("SalesBillDetailID") = 0
                drTempDetail("IsSignCard") = drRebate("IsSignCard").ToString
                'modify code 046:end-------------------------------------------------------------------------
                'modify code 050:start-------------------------------------------------------------------------
                drTempDetail("HolderName") = drRebate("HolderName").ToString
                drTempDetail("Gender") = drRebate("Gender").ToString
                drTempDetail("HolderIdNo") = drRebate("HolderIdNo").ToString
                drTempDetail("Mobile") = drRebate("Mobile").ToString
                'modify code 050:end-------------------------------------------------------------------------
            Next
        End If

        'modify code 046:start-------------------------------------------------------------------------
        'modify code 004:start-------------------------------------------------------------------------
        'If DB.ModifyTable("Select RowType,RowID,'    ' as FirstBuy,StartCardNo,EndCardNo,CardQTY,'             ' as BarCode,FaceValue,CardPayment,CardCost,PayableAMT Into #tempDetails From NewSalesBillDetails Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempDetails", dtTempDetails) = -1 Then
        If DB.ModifyTable("Select RowType,RowID,'    ' as FirstBuy,StartCardNo,EndCardNo,CardQTY,'             ' as BarCode,FaceValue,CardPayment,CardCost,PayableAMT,Convert(int,0) As SalesBillDetailID,Convert(varchar(18),'') As HolderIdNo,Convert(nvarchar(20),'') As HolderName,Convert(nvarchar(1),'') As Gender,Convert(varchar(20),'') As Mobile,Convert(nvarchar(1),'') As IsSignCard Into #tempDetails From NewSalesBillDetails Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempDetails", dtTempDetails) = -1 Then
            'modify code 004:end-------------------------------------------------------------------------
            'modify code 046:end-------------------------------------------------------------------------
            frmMain.statusText.Text = "保存销售单失败！"
            dtTempDetails.Dispose() : dtTempDetails = Nothing
            DB.Close() : Me.Cursor = Cursors.Default
            Me.Activate() : Return False
        End If
        dtTempDetails.Dispose() : dtTempDetails = Nothing

        'modify code 059:start-------------------------------------------------------------------------
        If Not drContract Is Nothing AndAlso drContract("PaymentMode") = 1 Then '如果是付款抵扣合同的情况,需要保存支付金额为零的支付方式
            If bNewSalesBillType <> 1 AndAlso dmPayableAMT >= 0 Then '非退货销售单
                Dim dtTempPayment As New DataTable, drTempPayment As DataRow
                dtTempPayment.Columns.Add("RowID", System.Type.GetType("System.Int16"))
                dtTempPayment.Columns.Add("PaymentTerm", System.Type.GetType("System.Byte"))
                dtTempPayment.Columns.Add("PaymentAMT", System.Type.GetType("System.Decimal"))
                dtTempPayment.Columns.Add("MediaNo", System.Type.GetType("System.String"))
                dtTempPayment.Columns.Add("PayerName", System.Type.GetType("System.String"))

                For Each drPayment As DataRow In dtPayment.Rows
                    drTempPayment = dtTempPayment.Rows.Add()
                    drTempPayment("RowID") = drPayment("RowID")
                    drTempPayment("PaymentTerm") = drPayment("PaymentTerm")
                    'modify code 044:start-------------------------------------------------------------------------
                    'drTempPayment("PaymentAMT") = IIf(drPayment("PaymentAMT").ToString = "", dmPayableAMT, drPayment("PaymentAMT"))
                    drTempPayment("PaymentAMT") = drPayment("PaymentAMT")
                    'modify code 044:end-------------------------------------------------------------------------
                    If drPayment("PaymentTerm") > 0 Then
                        drTempPayment("MediaNo") = drPayment("MediaNo")
                        drTempPayment("PayerName") = drPayment("PayerName")
                    End If
                Next

                'modify code 040,044:start-------------------------------------------------------------------------
                '线下提卡，如果填写了顾客姓名，写入付款人栏(044去除此功能)
                'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                '    If Me.txbBuyerName.Text.Trim <> "" Then
                '        dtTempPayment.Rows(1)("PayerName") = Me.txbBuyerName.Text.Trim
                '        dtTempPayment.AcceptChanges()
                '    End If
                '    If Me.txbBuyerName.Text.Trim <> "" Then
                '        dtPayment.Rows(1)("PayerName") = Me.txbBuyerName.Text.Trim
                '        dtPayment.AcceptChanges()
                '    End If
                'End If
                'modify code 040,044:end-------------------------------------------------------------------------

                If DB.ModifyTable("Select RowID,PaymentTerm,PaymentAMT,MediaNo,PayerName Into #tempPayment From NewSalesBillPayment Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempPayment", dtTempPayment) = -1 Then
                    frmMain.statusText.Text = "保存销售单失败！"
                    dtTempPayment.Dispose() : dtTempPayment = Nothing
                    DB.Close() : Me.Cursor = Cursors.Default
                    Me.Activate() : Return False
                End If
                dtTempPayment.Dispose() : dtTempPayment = Nothing

                'modify code 040:start-------------------------------------------------------------------------
                '手工增加付款分配内容，平均分配
                'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                '    dtRowPayment = New DataTable
                '    dtRowPayment.Columns.Add("CardRowID", System.Type.GetType("System.Int16"))
                '    dtRowPayment.Columns.Add("PaymentRowID", System.Type.GetType("System.Int16"))
                '    dtRowPayment.Columns.Add("DistributedAMT", System.Type.GetType("System.Decimal"))
                '    dtRowPayment.Clear()
                '    For iCount As Integer = 0 To dtNormalCard.Rows.Count - 2
                '        dtRowPayment.Rows.Add(dtNormalCard.Rows(iCount)("RowID"), 1, dtNormalCard.Rows(iCount)("CardCost") * dtNormalCard.Rows(iCount)("CardQTY"))
                '        dtRowPayment.Rows.Add(dtNormalCard.Rows(iCount)("RowID"), 2, dtNormalCard.Rows(iCount)("FaceValue") * dtNormalCard.Rows(iCount)("CardQTY"))
                '    Next
                '    dtRowPayment.AcceptChanges()
                'End If
                'modify code 040:start-------------------------------------------------------------------------

                If DB.ModifyTable("Select CardRowID,PaymentRowID,DistributedAMT Into #tempRowPayment From NewSalesBillRowPayment Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempRowPayment", dtRowPayment) = -1 Then
                    frmMain.statusText.Text = "保存销售单失败！"
                    DB.Close() : Me.Cursor = Cursors.Default
                    Me.Activate() : Return False
                End If
            End If
        Else
            'modify code 066:start-------------------------------------------------------------------------
            'If bNewSalesBillType <> 1 AndAlso dmPayableAMT > 0 Then '非退货销售单
            If (bNewSalesBillType <> 1 AndAlso dmPayableAMT > 0 OrElse Me.chbContract.Checked) Then '非退货销售单
                'modify code 066:end-------------------------------------------------------------------------
                Dim dtTempPayment As New DataTable, drTempPayment As DataRow
                dtTempPayment.Columns.Add("RowID", System.Type.GetType("System.Int16"))
                dtTempPayment.Columns.Add("PaymentTerm", System.Type.GetType("System.Byte"))
                dtTempPayment.Columns.Add("PaymentAMT", System.Type.GetType("System.Decimal"))
                dtTempPayment.Columns.Add("MediaNo", System.Type.GetType("System.String"))
                dtTempPayment.Columns.Add("PayerName", System.Type.GetType("System.String"))

                For Each drPayment As DataRow In dtPayment.Rows
                    drTempPayment = dtTempPayment.Rows.Add()
                    drTempPayment("RowID") = drPayment("RowID")
                    drTempPayment("PaymentTerm") = drPayment("PaymentTerm")
                    'modify code 044:start-------------------------------------------------------------------------
                    'drTempPayment("PaymentAMT") = IIf(drPayment("PaymentAMT").ToString = "", dmPayableAMT, drPayment("PaymentAMT"))
                    drTempPayment("PaymentAMT") = drPayment("PaymentAMT")
                    'modify code 044:end-------------------------------------------------------------------------
                    If drPayment("PaymentTerm") > 0 Then
                        drTempPayment("MediaNo") = drPayment("MediaNo")
                        drTempPayment("PayerName") = drPayment("PayerName")
                    End If
                Next

                'modify code 040,044:start-------------------------------------------------------------------------
                '线下提卡，如果填写了顾客姓名，写入付款人栏(044去除此功能)
                'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                '    If Me.txbBuyerName.Text.Trim <> "" Then
                '        dtTempPayment.Rows(1)("PayerName") = Me.txbBuyerName.Text.Trim
                '        dtTempPayment.AcceptChanges()
                '    End If
                '    If Me.txbBuyerName.Text.Trim <> "" Then
                '        dtPayment.Rows(1)("PayerName") = Me.txbBuyerName.Text.Trim
                '        dtPayment.AcceptChanges()
                '    End If
                'End If
                'modify code 040,044:end-------------------------------------------------------------------------

                If DB.ModifyTable("Select RowID,PaymentTerm,PaymentAMT,MediaNo,PayerName Into #tempPayment From NewSalesBillPayment Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempPayment", dtTempPayment) = -1 Then
                    frmMain.statusText.Text = "保存销售单失败！"
                    dtTempPayment.Dispose() : dtTempPayment = Nothing
                    DB.Close() : Me.Cursor = Cursors.Default
                    Me.Activate() : Return False
                End If
                dtTempPayment.Dispose() : dtTempPayment = Nothing

                'modify code 040:start-------------------------------------------------------------------------
                '手工增加付款分配内容，平均分配
                'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                '    dtRowPayment = New DataTable
                '    dtRowPayment.Columns.Add("CardRowID", System.Type.GetType("System.Int16"))
                '    dtRowPayment.Columns.Add("PaymentRowID", System.Type.GetType("System.Int16"))
                '    dtRowPayment.Columns.Add("DistributedAMT", System.Type.GetType("System.Decimal"))
                '    dtRowPayment.Clear()
                '    For iCount As Integer = 0 To dtNormalCard.Rows.Count - 2
                '        dtRowPayment.Rows.Add(dtNormalCard.Rows(iCount)("RowID"), 1, dtNormalCard.Rows(iCount)("CardCost") * dtNormalCard.Rows(iCount)("CardQTY"))
                '        dtRowPayment.Rows.Add(dtNormalCard.Rows(iCount)("RowID"), 2, dtNormalCard.Rows(iCount)("FaceValue") * dtNormalCard.Rows(iCount)("CardQTY"))
                '    Next
                '    dtRowPayment.AcceptChanges()
                'End If
                'modify code 040:start-------------------------------------------------------------------------

                If DB.ModifyTable("Select CardRowID,PaymentRowID,DistributedAMT Into #tempRowPayment From NewSalesBillRowPayment Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempRowPayment", dtRowPayment) = -1 Then
                    frmMain.statusText.Text = "保存销售单失败！"
                    DB.Close() : Me.Cursor = Cursors.Default
                    Me.Activate() : Return False
                End If
            End If
        End If
        'modify code 059:end-------------------------------------------------------------------------


        If drSalesBill("ImportedFromFile").ToString <> "" Then
            'modify code 046:start-------------------------------------------------------------------------
            'Dim dtTempFileDetails As DataTable = dtImportedDetails.DefaultView.ToTable(False, "RowID", "ErrorColumn", "CityName", "CardNo", "FaceValue", "SalesDate", "Remarks", "ImportedState", "StateReason")
            Dim dtTempFileDetails As DataTable = dtImportedDetails.DefaultView.ToTable(False, "RowID", "ErrorColumn", "CityName", "CardNo", "FaceValue", "SalesDate", "Remarks", "ImportedState", "StateReason", "CardCost", "HolderName", "Gender", "HolderIdNo", "Mobile")
            'modify code 046:end-------------------------------------------------------------------------

            If DB.ModifyTable("Select RowID,ErrorColumn,CityName,CardNo,FaceValue,SalesDate,Remarks,ImportedState,StateReason,CardCost,HolderName,Gender,HolderIdNo,Mobile Into #tempFileDetails From ImportedFileDetails Where 1=2") = -1 OrElse DB.BulkCopyTable("#tempFileDetails", dtTempFileDetails) = -1 Then
                frmMain.statusText.Text = "保存销售单失败！"
                dtTempFileDetails.Dispose() : dtTempFileDetails = Nothing
                DB.Close() : Me.Cursor = Cursors.Default
                Me.Activate() : Return False
            End If

            dtTempFileDetails.Dispose() : dtTempFileDetails = Nothing
        End If

        'modify code 050,054,059,063,068,072:start-------------------------------------------------------------------------
        'sSQL = "Exec SalesBillInsertion_Sign "
        'sSQL = "Exec SalesBillInsertion_NewSign "
        'sSQL = "Exec SalesBillInsertion_CrossSelling "
        'sSQL = "Exec SalesBillInsertion_29504 "
        'sSQL = "Exec SalesBillInsertion_29508 "
        'sSQL = "Exec SalesBillInsertion_29509 "
        sSQL = "Exec SalesBillInsertion_29605 "
        'modify code 050,054,059,063,068,072:end-------------------------------------------------------------------------

        If bNewSalesBillType <> 0 Then
            sSQL = sSQL & "@SalesBillType=" & bNewSalesBillType.ToString & ","
            'modify code 046:start-------------------------------------------------------------------------
            '实名制卡销售
        ElseIf bNewSalesBillType = 7 Then
            sSQL = sSQL & "@SalesBillType=" & bNewSalesBillType.ToString & ","
            'modify code 046:end-------------------------------------------------------------------------
        ElseIf blUsedOldCard Then
            sSQL = sSQL & "@NeedCheckCard=1,"
        End If

        sSQL = sSQL & "@StoreID=" & drSalesBill("StoreID").ToString & ","
        If drSalesBill("CustomerType") = 1 Then sSQL = sSQL & "@CustomerType=1,@CustomerID=" & drSalesBill("CustomerID").ToString & ","
        If drSalesBill("BuyerName").ToString <> "" Then sSQL = sSQL & "@BuyerName='" & drSalesBill("BuyerName").ToString.Replace("'", "''") & "',"
        If drSalesBill("TelMP").ToString <> "" Then sSQL = sSQL & "@TelMP='" & drSalesBill("TelMP").ToString.Replace("'", "''") & "',"
        sSQL = sSQL & "@CardQTY=" & drSalesBill("CardQTY").ToString & ","
        If drSalesBill("NormalCardQTY") <> 0 Then sSQL = sSQL & "@NormalCardQTY=" & drSalesBill("NormalCardQTY").ToString & ",@NormalSalesAMT=" & drSalesBill("NormalSalesAMT").ToString & ","
        If bNewSalesBillType <> 1 Then
            drSalesBill("CardCost") = dtNormalCard.Compute("Sum(CostAMT)", "")
            If drSalesBill("CardCost").ToString = "" Then drSalesBill("CardCost") = 0
            If drSalesBill("CardCost") <> 0 Then sSQL = sSQL & "@CardCost=" & drSalesBill("CardCost").ToString & ","
            If dmPayableAMT <> 0 Then sSQL = sSQL & "@PayableAMT=" & dmPayableAMT.ToString & ","
            sSQL = sSQL & "@ChargedAMT=" & drSalesBill("ChargedAMT").ToString & ","
            If Me.grbPrintDiscount.Visible = True Then
                drSalesBill("InvoicePrintDiscount") = IIf(Me.chbPrintDiscount.Checked, 1, 0)
                sSQL = sSQL & "@InvoicePrintDiscount=" & IIf(Me.chbPrintDiscount.Checked, "1", "0") & ","
            ElseIf sContractID <> "" AndAlso drSalesBill("ContractMode").ToString.Substring(0, 1) = "1" Then '付款抵扣
                drSalesBill("InvoicePrintDiscount") = blCanUse92Card
                sSQL = sSQL & "@InvoicePrintDiscount=" & IIf(blCanUse92Card, "1", "0") & ","
            Else
                drSalesBill("InvoicePrintDiscount") = DBNull.Value
            End If

            If sNewestCityRuleID <> "-1" Then sSQL = sSQL & "@CityRuleID=" & sNewestCityRuleID & ","
            If sContractID <> "" Then sSQL = sSQL & "@ContractID=" & sContractID & ",@ContractCode='" & drSalesBill("ContractCode") & "',@ContractMode='" & drSalesBill("ContractMode").ToString & "',"
            If sBalanceContractID <> "" Then sSQL = sSQL & "@BalanceContractID=" & sBalanceContractID & ",@BalanceContractCode='" & drSalesBill("BalanceContractCode").ToString & "',@BalanceContractBalanceRebateAMT=" & drSalesBill("BalanceContractBalanceRebateAMT").ToString & ","

            If bNewSalesBillType = 4 Then '员工销售单
                drSalesBill("RebateMode") = 4 '员工返点
                drSalesBill("RebateRate") = drEmployee("RateQuota")
                drSalesBill("RebateState") = 2
                sSQL = sSQL & "@RebateMode=4,@RebateRate=" & drSalesBill("RebateRate").ToString & ",@RebateCardQTY=" & drSalesBill("RebateCardQTY").ToString & ",@RebateSalesAMT=" & drSalesBill("RebateSalesAMT").ToString & ",@RebateState=2,"
            ElseIf drSalesBill("RebateMode") = 1 Then '一般返点
                If drSalesBill("RebateSalesAMT") > 0 Then
                    sSQL = sSQL & "@RebateMode=1,@RebateRuleID=" & sNewestCityRuleID & ",@RebateRate=" & drSalesBill("RebateRate").ToString & ",@RebateCardQTY=" & drSalesBill("RebateCardQTY").ToString & ",@RebateSalesAMT=" & drSalesBill("RebateSalesAMT").ToString & ",@RebateState=" & drSalesBill("RebateState").ToString & ","
                    If drSalesBill("RebateState") = 0 Then sSQL = sSQL & "@NormalRebateApprovableRoleID=" & drSalesBill("NormalRebateApprovableRoleID").ToString & ","
                    If drSalesBill("NormalRebateRemarks").ToString <> "" Then sSQL = sSQL & "@NormalRebateRemarks='" & drSalesBill("NormalRebateRemarks").ToString.Replace("'", "''") & "',"
                    sSQL = sSQL & "@FirstAvailableRowID=" & iFirstAvailableRowID.ToString & ","
                End If
            ElseIf drSalesBill("RebateMode") = 2 Then '合同返点
                sSQL = sSQL & "@RebateMode=2,@RebateRuleID=" & sContractID & ",@RebateRate=" & drSalesBill("RebateRate").ToString & ",@RebateCardQTY=" & drSalesBill("RebateCardQTY").ToString & ",@RebateSalesAMT=" & drSalesBill("RebateSalesAMT").ToString & ",@RebateState=2,"
                If drContract("MonthDate").ToString <> "" Then sSQL = sSQL & "@ContractIsMonthly=1,"
                sSQL = sSQL & "@HistorySalesAMTBefore=" & drContract("HistorySalesAMT").ToString & ",@HistoryTodayPaidRebateAMTBefore=" & drContract("HistoryTodayPaidRebateAMT").ToString & ","
                sSQL = sSQL & "@ContractRebateThisSalesAMT=" & drSalesBill("ContractRebateThisSalesAMT").ToString & ",@ContractRebateThisRebateRate=" & drSalesBill("ContractRebateThisRebateRate").ToString & ",@ContractRebateThisRebateAMT=" & drSalesBill("ContractRebateThisRebateAMT").ToString & ","
                If drSalesBill("ContractRebateThisRebateRemarks").ToString <> "" Then sSQL = sSQL & "@ContractRebateThisRebateRemarks='" & drSalesBill("ContractRebateThisRebateRemarks").ToString.Replace("'", "''") & "',"
                sSQL = sSQL & "@ContractRebateHistorySalesAMT=" & drSalesBill("ContractRebateHistorySalesAMT").ToString & ",@ContractRebateHistoryRebateRate=" & drSalesBill("ContractRebateHistoryRebateRate").ToString & ",@ContractRebateHistoryRebateAMT=" & drSalesBill("ContractRebateHistoryRebateAMT").ToString & ",@ContractRebateHistoryPaidRebateAMT=" & drSalesBill("ContractRebateHistoryPaidRebateAMT").ToString & ","
                If drSalesBill("ContractRebateHistorySalesAMTTip").ToString <> "" Then sSQL = sSQL & "@ContractRebateHistorySalesAMTTip='" & drSalesBill("ContractRebateHistorySalesAMTTip").ToString.Replace("'", "''") & "',"
                If drSalesBill("ContractRebateHistoryRebateRemarks").ToString <> "" Then sSQL = sSQL & "@ContractRebateHistoryRebateRemarks='" & drSalesBill("ContractRebateHistoryRebateRemarks").ToString.Replace("'", "''") & "',"
                sSQL = sSQL & "@ContractRebateAvailableRebateAMT=" & dmAvailableRebateAMT.ToString & ","
                If drSalesBill("AddToContract") Then sSQL = sSQL & "@AddToContract=1,"
                If dmRebateSalesAMT > 0 Then
                    Dim dmTodayPaidRebateAMTFromHistory As Decimal = 0 '计算当天已兑现的返点需要从历史返点中扣除的部分，避免在另一次销售中重复兑现历史返点
                    If Not blThisRebateAvailable Then '当天销售不产生返点或虽有返点但返点无效，说明当次已兑现的返点将完全在历史返点中扣除
                        dmTodayPaidRebateAMTFromHistory = dmRebateSalesAMT
                    Else
                        dmTodayPaidRebateAMTFromHistory = dmRebateSalesAMT - drSalesBill("ContractRebateThisRebateAMT")
                        'modify code 052:start-------------------------------------------------------------------------
                        If drContract("PaymentMode") <> 1 Then  '付款抵扣的误差值，不论正负都要加入计算
                            If dmTodayPaidRebateAMTFromHistory < 0 Then dmTodayPaidRebateAMTFromHistory = 0 '如果当天产生的返点足够当天已兑现的返点，则无需从历史返点中扣除
                        End If
                        'modify code 052:end-------------------------------------------------------------------------
                    End If
                    If dmTodayPaidRebateAMTFromHistory <> 0 Then sSQL = sSQL & "@TodayPaidRebateAMTFromHistory=" & dmTodayPaidRebateAMTFromHistory.ToString & ","
                End If

                sSQL = sSQL & "@FirstAvailableRowID=" & iFirstAvailableRowID.ToString & ",@SecondAvailableRowID=" & iSecondAvailableRowID.ToString & ","
            ElseIf drSalesBill("RebateMode") = 3 Then '合同结余
                sSQL = sSQL & "@RebateMode=3,@RebateRuleID=" & sBalanceContractID & ",@RebateRate=1,@RebateCardQTY=" & drSalesBill("RebateCardQTY").ToString & ",@RebateSalesAMT=" & drSalesBill("RebateSalesAMT").ToString & ",@RebateState=2,"
            End If

            If dmPayableAMT > 0 Then sSQL = sSQL & "@ReceivedAMT=" & drSalesBill("ReceivedAMT").ToString & ",@ChangeAMT=" & drSalesBill("ChangeAMT").ToString & ","
        Else
            sSQL = sSQL & "@ChargedAMT=" & drSalesBill("ChargedAMT").ToString & ","
        End If

        If bNewSalesBillType = 1 Then
            drSalesBill("CustomerName") = "（退货客户）"
            sSQL = sSQL & "@CustomerName='（退货客户）',"
        ElseIf bNewSalesBillType = 4 Then
            drSalesBill("CustomerName") = "（内部员工）"
            sSQL = sSQL & "@CustomerName='（内部员工）',"
        ElseIf drSalesBill("CustomerType") = 1 OrElse bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 Then
            sSQL = sSQL & "@CustomerName='" & Me.txbCustomerName.Text.Replace("'", "''") & "',"
        End If
        If bNewSalesBillType <> 1 AndAlso bNewSalesBillType <> 4 AndAlso drSalesBill("BuyerCredentialsNo").ToString <> "" Then sSQL = sSQL & "@BuyerCredentialsType='" & drSalesBill("BuyerCredentialsType").ToString.Replace("'", "") & "',@BuyerCredentialsNo='" & drSalesBill("BuyerCredentialsNo").ToString.Replace("'", "") & "',"
        If bNewSalesBillType = 2 OrElse bNewSalesBillType = 3 AndAlso drSalesBill("CompanyCredentialsNo").ToString <> "" Then
            sSQL = sSQL & "@CompanyCredentialsType='" & drSalesBill("CompanyCredentialsType").ToString.Replace("'", "") & "',@CompanyCredentialsNo='" & drSalesBill("CompanyCredentialsNo").ToString.Replace("'", "") & "',"
        ElseIf drSalesBill("CustomerType") = 1 Then
            If drSalesBill("CompanyCredentialsType").ToString = "（特准无需证件）" Then
                If dmNormalSalesAMT >= 10000 Then sSQL = sSQL & "@CompanyCredentialsType='（特准无需证件）',"
            ElseIf drSalesBill("CompanyCredentialsNo").ToString <> "" Then
                sSQL = sSQL & "@CompanyCredentialsType='" & drSalesBill("CompanyCredentialsType").ToString.Replace("'", "") & "',@CompanyCredentialsNo='" & drSalesBill("CompanyCredentialsNo").ToString.Replace("'", "") & "',"
            End If
        End If
        sSQL = sSQL & "@CustomerStoreID=" & drSalesBill("CustomerStoreID").ToString & ","

        If bNewSalesBillType = 1 Then
            sSQL = sSQL & "@RefundDate='" & Format(drSalesBill("RefundDate"), "yyyy\/MM\/dd") & "',@RefundNo='" & drSalesBill("RefundNo").ToString & "',"
        ElseIf bNewSalesBillType = 2 Then
            sSQL = sSQL & "@PromotionTitle='" & drSalesBill("PromotionTitle").ToString.Replace("'", "''") & "',"
            sSQL = sSQL & "@PromotionPeriod='" & drSalesBill("PromotionPeriod").ToString.Replace("'", "''") & "',"
        ElseIf bNewSalesBillType = 4 Then
            sSQL = sSQL & "@EmployeeID=" & sEmployeeID & ",@EmployeeNo='" & sEmployeeNo.Replace("'", "''") & "',@EmployeeName='" & drEmployee("EmployeeName").ToString.Replace("'", "''") & "',"
            sSQL = sSQL & "@EmployeeIDType='" & drEmployee("IDType").ToString.Replace("'", "''") & "',@EmployeeIDNo='" & drEmployee("IDNo").ToString.Replace("'", "''") & "',"
            sSQL = sSQL & "@OfficeName='" & drEmployee("OfficeName").ToString.Replace("'", "''") & "',@LevelName='" & drEmployee("LevelName").ToString.Replace("'", "''") & "',@EmployeeState='" & drEmployee("EmployeeState").ToString.Replace("'", "''") & "',"
            sSQL = sSQL & "@PurchaseQuota=" & drEmployee("PurchaseQuota").ToString & ",@RateQuota=" & drEmployee("RateQuota").ToString & ",@UsedPurchaseQuota=" & drEmployee("UsedPurchaseQuota").ToString & ","
        ElseIf bNewSalesBillType = 5 Then
            If Me.txbMemberAddress.Text <> "" Then sSQL = sSQL & "@MemberAddress='" & Me.txbMemberAddress.Text.Replace("'", "''") & "',"
            sSQL = sSQL & "@NewMemberCardNo='" & Me.txbNewMemberCardNo.Text & "',"
            If Me.txbOldMemberCardNo.Text <> "" Then sSQL = sSQL & "@OldMemberCardNo='" & Me.txbOldMemberCardNo.Text & "',"
        End If

        If drSalesBill("ImportedFromFile").ToString <> "" Then sSQL = sSQL & "@ImportedFromFile='" & drSalesBill("ImportedFromFile").ToString.Replace("'", "''") & "',@SourceFile='" & drImportedFile("SourceFile").ToString.Replace("'", "''") & "',@SourceWorkSheet='" & drImportedFile("WorkSheet").ToString.Replace("'", "''") & "',@SourceFileSize=" & drImportedFile("FileSize").ToString & ",@SourceFileModifiedTime='" & drImportedFile("FileModifiedTime").ToString & "',"
        sSQL = sSQL & "@OperatorName='" & frmMain.sLoginUserRealName.Replace("'", "''") & "',@SSID=" & frmMain.sSSID

        'modify code 040,044:start-------------------------------------------------------------------------
        If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
            If strSelectedBuyChannel = "Cul" Then
                sSQL = sSQL & ",@InternetBillNo='" & ecir.ExtractingCodeInfoData.BillNo & "'"
            End If
        End If
        'modify code 040,044:end-------------------------------------------------------------------------

        'modify code 072:start-------------------------------------------------------------------------
        If bNewSalesBillType = 9 AndAlso sOrderNo <> "" Then
            sSQL = sSQL & ",@OrderNo='" & sOrderNo & "'"
        Else
            sSQL = sSQL & ",@OrderNo=null"
        End If
        'modify code 072:end-------------------------------------------------------------------------

        dtResult = DB.GetDataTable(sSQL)
        If dtResult Is Nothing Then
            frmMain.statusText.Text = "保存销售单失败！"
            DB.Close()
            Me.Cursor = Cursors.Default
            Me.Activate() : Return False
        ElseIf dtResult.Rows(0)("Result").ToString = "OK" Then
            sSalesBillID = dtResult.Rows(0)("SalesBillID").ToString
            If Not My.Settings.IsInTraining Then
                Try
                    DB.ModifyTable("Insert Into tempNewPerformance Values (" & sSalesBillID & "," & DateDiff(DateInterval.Second, dtNow, Now()).ToString & "," & IIf(blDeadLock, "1", "0") & ")")
                Catch
                End Try
            End If

            Me.btnViewActivation.Text = "激活明细(&A)" : Me.btnViewActivation.Enabled = False
            If frmCheckCardResult.IsHandleCreated AndAlso frmCheckCardResult.Visible = True Then frmCheckCardResult.Close()
            If dtLastCheckingProblemCard IsNot Nothing AndAlso dtLastCheckingProblemCard.Rows.Count > 0 Then dtLastCheckingProblemCard.Rows.Clear() : dtLastCheckingProblemCard.AcceptChanges()
            If dtAllCheckedCard IsNot Nothing AndAlso dtAllCheckedCard.Rows.Count > 0 Then dtAllCheckedCard.Rows.Clear() : dtAllCheckedCard.AcceptChanges()
            sFirstCheckCardTime = "" : blCanRecheckCard = False : blNeedReloadCard = False : bHightLightTimes = 0

            If drSalesBill("CustomerType") = 1 Then
                drCustomer("IsUsed") = True
                If drSalesBill("CompanyCredentialsNo").ToString <> "" AndAlso (drCustomer("CompanyCredentialsType").ToString <> drSalesBill("CompanyCredentialsType").ToString OrElse drCustomer("CompanyCredentialsNo").ToString <> drSalesBill("CompanyCredentialsNo").ToString) Then
                    drCustomer("AllowNoCredentials") = 0
                    drCustomer("CompanyCredentialsType") = drSalesBill("CompanyCredentialsType").ToString
                    drCustomer("CompanyCredentialsNo") = drSalesBill("CompanyCredentialsNo").ToString
                End If
                drCustomer.AcceptChanges()
            End If

            If drEmployee IsNot Nothing Then drEmployee.AcceptChanges()

            sSalesBillID = dtResult.Rows(0)("SalesBillID").ToString
            drSalesBill("SalesBillID") = sSalesBillID
            drSalesBill("SalesBillCode") = dtResult.Rows(0)("SalesBillCode").ToString
            '同一般销售单
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'If (bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0) OrElse bNewSalesBillType = 5 Then drSalesBill("CustomerName") = "（个人客户）"
            'If ((bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 0) OrElse bNewSalesBillType = 5 Then drSalesBill("CustomerName") = "（个人客户）"
            'If ((bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0) OrElse bNewSalesBillType = 5 Then drSalesBill("CustomerName") = "（个人客户）"
            If ((bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0) OrElse bNewSalesBillType = 5 Then drSalesBill("CustomerName") = "（个人客户）"
            'modify code 040,046,054,072:end-------------------------------------------------------------------------
            drSalesBill("SalesmanID") = dtResult.Rows(0)("SalesmanID") : drSalesBill("SalesmanName") = dtResult.Rows(0)("SalesmanName") : drSalesBill("SalesmanChanged") = 0
            If drSalesBill("RebateSalesAMT") = 0 AndAlso drSalesBill("RebateMode") = 1 Then drSalesBill("RebateMode") = 0 : drSalesBill("RebateRate") = DBNull.Value : drSalesBill("RebateCardQTY") = 0 : drSalesBill("RebateSalesAMT") = 0
            If bNewSalesBillType = 4 Then
                drSalesBill("BuyerCredentialsType") = drEmployee("IDType").ToString
                drSalesBill("BuyerCredentialsNo") = drEmployee("IDNo").ToString
            ElseIf drSalesBill("BuyerCredentialsNo").ToString = "" Then
                drSalesBill("BuyerCredentialsType") = DBNull.Value
            End If
            '同一般销售单
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'If bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0 Then drSalesBill("CompanyCredentialsNo") = DBNull.Value
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 0 Then drSalesBill("CompanyCredentialsNo") = DBNull.Value
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0 Then drSalesBill("CompanyCredentialsNo") = DBNull.Value
            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0 Then drSalesBill("CompanyCredentialsNo") = DBNull.Value
            'modify code 040,046,054,072:end-------------------------------------------------------------------------
            If (drSalesBill("CompanyCredentialsType").ToString <> "（特准无需证件）" OrElse dmNormalSalesAMT < 10000) AndAlso drSalesBill("CompanyCredentialsNo").ToString = "" Then drSalesBill("CompanyCredentialsType") = DBNull.Value

            drSalesBill("CreatorID") = frmMain.sLoginUserID : drSalesBill("CreatorName") = frmMain.sLoginUserRealName : drSalesBill("CreatedTime") = dtResult.Rows(0)("CreatedTime")
            drSalesBill("TicketPrintedTimes") = 0 : drSalesBill("InvoicePrintedTimes") = 0
            drSalesBill.AcceptChanges()

            blSkipDeal = True
            If drSalesBill("ImportedFromFile").ToString = "" Then dtNormalCard.Rows(dtNormalCard.Rows.Count - 1).Delete()
            If bNewSalesBillType = 1 Then
                For Each drNormal As DataRow In dtNormalCard.Rows
                    drNormal("CardCost") = 0
                Next
            End If

            dtNormalCard.AcceptChanges()

            For Each drNormal As DataRow In dtNormalCard.Rows
                drNormal("ActivationState") = "等待激活"
            Next
            dtNormalCard.AcceptChanges()

            'modify code 046:start-------------------------------------------------------------------------
            resetCardCostColumn(True)
            'modify code 046:end-------------------------------------------------------------------------

            'modify code 004:start-------------------------------------------------------------------------
            For iRow As Integer = 0 To Me.dtNormalCard.Rows.Count - 1
                Me.dgvNormalCard("FirstBuy", iRow).Value = SetFirstBuy(dtNormalCard.Rows(iRow).Item("StartCardNo").ToString, iRow, dtNormalCard.Rows(iRow).Item("FirstBuy").ToString)
                Me.dgvNormalCard("CardCost", iRow).Value = SetCardCost(dtNormalCard.Rows(iRow).Item("StartCardNo").ToString, dtNormalCard.Rows(iRow).Item("FirstBuy").ToString, iRow, dtNormalCard.Rows(iRow).Item("CardCost").ToString)
            Next
            'modify code 004:end-------------------------------------------------------------------------

            If drSalesBill("RebateMode") = 0 Then
                dtRebateCard.Rows.Clear()
            Else
                dtRebateCard.Rows(dtRebateCard.Rows.Count - 1).Delete()
                For Each drRebate As DataRow In dtRebateCard.Rows
                    drRebate("ActivationState") = "等待激活"
                Next
            End If
            dtRebateCard.AcceptChanges()

            'modify code 059:start-------------------------------------------------------------------------
            'If dmPayableAMT = 0 Then
            If dmPayableAMT = 0 AndAlso Not (Not drContract Is Nothing AndAlso drContract("PaymentMode") = 1) Then '如果是付款抵扣合同的情况,需要显示支付金额为零的支付方式
                'modify code 059:end-------------------------------------------------------------------------
                dtPayment.Rows.Clear()
            Else
                For Each drPayment As DataRow In dtPayment.Rows
                    Select Case drPayment("PaymentTerm")
                        Case 0
                            drPayment("ValidationState") = "现金已收"
                        Case 1
                            drPayment("MediaNo") = drPayment("MediaNo").ToString.Substring(0, 6) & StrDup(drPayment("MediaNo").ToString.Length - 10, "*") & drPayment("MediaNo").ToString.Substring(drPayment("MediaNo").ToString.Length - 4, 4)
                            drPayment("ValidationState") = "已刷卡"
                        Case 2, 5
                            drPayment("ValidationState") = "转账已登记"
                        Case 3, 6
                            drPayment("ValidationState") = "支票已收"
                            'modify code 008:start-------------------------------------------------------------------------
                        Case 7
                            drPayment("ValidationState") = "积分兑换已收"
                            'modify code 008:end-------------------------------------------------------------------------
                            'modify code 040,044:start-------------------------------------------------------------------------
                        Case 8
                            'drPayment("ValidationState") = "兑换码已收"
                            drPayment("ValidationState") = dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString & "已收"
                        Case 11
                            drPayment("ValidationState") = dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString & "已收"
                            'modify code 040,044:end-------------------------------------------------------------------------
                        Case Else
                            drPayment("ValidationState") = "支票、现金已收"
                    End Select
                Next
            End If
            dtPayment.AcceptChanges()

            If drSalesBill("ImportedFromFile").ToString <> "" Then
                drImportedFile("SalesBillID") = sSalesBillID
                drImportedFile("SourceComputer") = dtResult.Rows(0)("SourceComputer").ToString
                drImportedFile.AcceptChanges()

                For Each drCard As DataRow In dtImportedDetails.Rows
                    drCard("SalesBillID") = sSalesBillID
                    drCard.AcceptChanges()
                Next
            End If

            If bNewSalesBillType = 2 Then
                If drSalesBill("BuyerName").ToString <> "" Then drInternalPayer("MKLinkman") = drSalesBill("BuyerName").ToString
                If drSalesBill("TelMP").ToString <> "" Then drInternalPayer("MKTelMP") = drSalesBill("TelMP").ToString
                If drSalesBill("BuyerCredentialsType").ToString <> "" Then drInternalPayer("MKCredentialsType") = drSalesBill("BuyerCredentialsType").ToString
                If drSalesBill("BuyerCredentialsNo").ToString <> "" Then drInternalPayer("MKCredentialsNo") = drSalesBill("BuyerCredentialsNo").ToString
                drInternalPayer("LastPromotionTitle") = drSalesBill("PromotionTitle").ToString
                drInternalPayer("LastPromotionPeriod") = drSalesBill("PromotionPeriod").ToString
                drInternalPayer.AcceptChanges()
            End If

            If bNewSalesBillType = 3 AndAlso drSalesBill("BuyerName").ToString <> "" Then
                If drSalesBill("BuyerName").ToString <> "" Then drInternalPayer("PRLinkman") = drSalesBill("BuyerName").ToString
                If drSalesBill("TelMP").ToString <> "" Then drInternalPayer("PRTelMP") = drSalesBill("TelMP").ToString
                If drSalesBill("BuyerCredentialsType").ToString <> "" Then drInternalPayer("PRCredentialsType") = drSalesBill("BuyerCredentialsType").ToString
                If drSalesBill("BuyerCredentialsNo").ToString <> "" Then drInternalPayer("PRCredentialsNo") = drSalesBill("BuyerCredentialsNo").ToString
                drInternalPayer.AcceptChanges()
            End If

            blSkipDeal = False
            Me.grbSalesBillType.Text = "销售单类型："
            Me.txbSalesBillType.Text = Me.cbbSalesBillType.Text
            Me.txbSalesBillType.Visible = True
            Me.cbbSalesBillType.Visible = False

            If bNewSalesBillType = 4 Then
                Me.grbInputEmployeeNo.Visible = False
                Me.grbEmployeeInfo.Text = "员工信息："
                Me.pnlEmployeeNo.Visible = True
                Me.txbEmployeeNo.Text = Me.txbInputEmployeeNo.Text
                Me.pnlEmployeeTel.Visible = True
                Me.flpEmployeeInfo.AutoSize = False
                Me.flpEmployeeInfo.AutoSize = True
                Me.grbEmployeeInfo.Height = Me.flpEmployeeInfo.Height + 26
                Me.txbEmployeeTel.Text = drSalesBill("TelMP").ToString
                Me.grbInputEmployeeTel.Visible = False

                Me.tlpAvailableQuota.Visible = False
                Me.flpEmployeeQuota.AutoSize = False
                Me.flpEmployeeQuota.AutoSize = True
                Me.grbEmployeeQuota.Height = Me.flpEmployeeQuota.Height + 25

                Me.flpEmployee.AutoSize = False
                Me.flpEmployee.AutoSize = True
            End If

            If bNewSalesBillType = 2 Then
                Me.grbPromotionInfo.Text = "活动摘要："
                Me.txbPromotionTitle.ReadOnly = True
                Me.txbPromotionTitle.BackColor = SystemColors.Window
                Me.txbPromotionTitle.BackColor = SystemColors.Control
                Me.pnlPromotionPeriod.Visible = False
                Me.pnlPromotionPeriodReadOnly.Visible = True
                Me.txbPromotionStartDate.Text = Format(Me.dtpPromotionStartDate.Value, "yyyy\/MM\/dd")
                Me.txbPromotionEndDate.Text = Format(Me.dtpPromotionEndDate.Value, "yyyy\/MM\/dd")
            End If

            '同一般销售单
            'modify code 040,046,054,072:start-------------------------------------------------------------------------
            'If bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0 Then
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 0 Then
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0 Then
            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0 Then
                'modify code 040,046,054,072:end-------------------------------------------------------------------------
                Me.grbCustomer.Visible = False
            ElseIf Me.grbCustomer.Visible Then
                Me.grbCustomer.Text = "公司信息："
                Me.pnlSelectStore.Visible = False
                Me.pnlCustomerType.Visible = False
                '同一般销售单
                'modify code 040,046,054,072:start-------------------------------------------------------------------------
                'If bNewSalesBillType = 0 Then
                'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 Then
                'If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 Then
                If bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9 Then
                    'modify code 040,046,054,072:end-------------------------------------------------------------------------
                    Me.lblCustomerName.Text = "公司名称："
                Else
                    Me.lblCustomerName.Text = "家乐福自购客户名称："
                End If
                Me.txbCustomerName.Visible = True
                Me.txbCustomerName.ReadOnly = True
                Me.txbCustomerName.BackColor = SystemColors.Window
                Me.txbCustomerName.BackColor = SystemColors.Control
                Me.cbbCustomerName.Visible = False
                Me.cbbCompanyCredentialsType.Visible = False
                Me.txbCompanyCredentialsType.Text = drSalesBill("CompanyCredentialsType").ToString
                Me.txbCompanyCredentialsType.Visible = True
                Me.txbCompanyCredentialsNo.ReadOnly = True
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Window
                Me.txbCompanyCredentialsNo.BackColor = SystemColors.Control
                Me.btnNewCustomer.Visible = False
                Me.flpCustomer.AutoSize = False
                Me.flpCustomer.AutoSize = True
                Me.grbCustomer.Height = Me.flpCustomer.Height + 25
            End If

            Me.grbAvailablePayer.Visible = False

            If grbBuyerInfo.Visible Then
                Me.theTip.SetToolTip(Me.cbbBuyerName, "")
                Me.theTip.SetToolTip(Me.txbBuyerName, "")
                Me.txbBuyerName.Visible = True
                Me.txbBuyerName.ReadOnly = True
                Me.txbBuyerName.BackColor = SystemColors.Window
                Me.txbBuyerName.BackColor = SystemColors.Control
                Me.cbbBuyerName.Visible = False
                Me.txbTelMP.Visible = True
                Me.txbTelMP.ReadOnly = True
                Me.txbTelMP.BackColor = SystemColors.Window
                Me.txbTelMP.BackColor = SystemColors.Control
                Me.cbbTelMP.Visible = False
                If bNewSalesBillType = 1 Then '退货销售单
                    Me.grbBuyerInfo.Text = "退货客户信息："
                Else
                    '同一般销售单
                    'modify code 040,046,054,072:start-------------------------------------------------------------------------
                    'If bNewSalesBillType = 0 AndAlso drSalesBill("CustomerType") = 0 Then
                    'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6) AndAlso drSalesBill("CustomerType") = 0 Then
                    'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7) AndAlso drSalesBill("CustomerType") = 0 Then
                    If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 6 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8 OrElse bNewSalesBillType = 9) AndAlso drSalesBill("CustomerType") = 0 Then
                        'modify code 040,046,054,072:end-------------------------------------------------------------------------
                        Me.grbBuyerInfo.Text = "购买人信息："
                    Else
                        Me.grbBuyerInfo.Text = "代购人信息："
                    End If
                    Me.txbBuyerCredentialsType.Text = drSalesBill("BuyerCredentialsType").ToString
                    Me.txbBuyerCredentialsType.Visible = True
                    Me.cbbBuyerCredentialsType.Visible = False
                    Me.txbBuyerCredentialsNo.ReadOnly = True
                    Me.txbBuyerCredentialsNo.BackColor = SystemColors.Window
                    Me.txbBuyerCredentialsNo.BackColor = SystemColors.Control
                End If
            End If

            If bNewSalesBillType = 5 Then
                Me.grbMemberInfo.Text = "会员信息："
                Me.txbMemberName.ReadOnly = True
                Me.txbMemberName.BackColor = SystemColors.Window
                Me.txbMemberName.BackColor = SystemColors.Control
                Me.txbMemberIDNo.ReadOnly = True
                Me.txbMemberIDNo.BackColor = SystemColors.Window
                Me.txbMemberIDNo.BackColor = SystemColors.Control
                Me.txbMemberTel.ReadOnly = True
                Me.txbMemberTel.BackColor = SystemColors.Window
                Me.txbMemberTel.BackColor = SystemColors.Control
                Me.txbMemberAddress.ReadOnly = True
                Me.txbMemberAddress.BackColor = SystemColors.Window
                Me.txbMemberAddress.BackColor = SystemColors.Control
                Me.txbNewMemberCardNo.ReadOnly = True
                Me.txbNewMemberCardNo.BackColor = SystemColors.Window
                Me.txbNewMemberCardNo.BackColor = SystemColors.Control
                Me.txbOldMemberCardNo.ReadOnly = True
                Me.txbOldMemberCardNo.BackColor = SystemColors.Window
                Me.txbOldMemberCardNo.BackColor = SystemColors.Control
            End If

            If drSalesBill("RebateMode") = 3 Then Me.grbBalanceContract.Text = "上期合同剩余返点：" : Me.chbBalanceContract.Enabled = False Else Me.grbBalanceContract.Visible = False
            If drSalesBill("RebateMode") = 2 Then Me.grbContract.Text = "合同返点：" : Me.chbContract.Enabled = False Else Me.grbContract.Visible = False

            If Me.grbNormalRebate.Visible Then
                Me.chbNormalRebate.Checked = (drSalesBill("RebateSalesAMT").ToString <> "" AndAlso drSalesBill("RebateSalesAMT") > 0)
                Me.chbNormalRebate.Enabled = False
                Me.pnlMaxNormalRebateCalculation.Visible = False
                Me.txbNormalRebateRate.ReadOnly = True
                Me.txbNormalRebateRate.BackColor = SystemColors.Window
                Me.txbNormalRebateRate.BackColor = SystemColors.Control
                Me.txbNormalRebateAMT.ReadOnly = True
                Me.txbNormalRebateAMT.BackColor = SystemColors.Window
                Me.txbNormalRebateAMT.BackColor = SystemColors.Control
                Me.pnlDistributionNormalRebateAMT.Visible = False
                Me.pnlBalanceNormalRebateAMT.Visible = False
                Me.flpNormalRebate.AutoSize = False
                Me.flpNormalRebate.AutoSize = True
                Me.grbNormalRebate.Height = Me.flpNormalRebate.Height + 55
                Me.grbNormalRebate.Visible = Me.chbNormalRebate.Checked
            End If

            If Me.grbNormalRebate.Visible Then
                Me.grbNormalRebate.Text = "城市返点："
                drCityRule = drNewestCityRule.Table.Copy.Rows(0)
                dtRuleDetails = dtNewestRuleDetails.Copy
            End If

            Me.grbSalesBillSummary.Visible = True
            Me.txbCardQTY.Text = Format(drSalesBill("CardQTY"), "#,0")
            Me.txbChargedAMT.Text = Format(drSalesBill("ChargedAMT"), "#,0.00")
            Me.txbPaymentAMT.Text = Format(drSalesBill("PayableAMT"), "#,0.00")
            If drSalesBill("CardCost") > 0 Then
                Me.pnlCardCost.Visible = True
                Me.txbCardCost.Text = Format(drSalesBill("CardCost"), "#,0.00")
            End If
            Me.grbSalesBillSummary.Height = Me.flpSalesBillSummary.Height + 28

            Me.grbSalesBillInfo.Visible = True
            Me.lblSalesBillCode.Text = drSalesBill("StoreCode").ToString & " " & drSalesBill("SalesBillCode").ToString.Insert(6, " ")
            Me.lblCreatedTime.Text = Format(drSalesBill("CreatedTime"), "yyyy\/MM\/dd HH:mm:ss")
            Me.lblCreatorName.Text = drSalesBill("CreatorName").ToString
            Me.lblSalesBillState.ForeColor = Color.Green
            Me.lblSalesBillState.Text = IIf(dmPayableAMT > 0, "已付款，", "") & "等待激活"
            Me.pnlSalesBillStateDescription.Visible = False
            Me.grbSalesBillInfo.Height = 125

            'modify code 046,054:start-------------------------------------------------------------------------
            '同一般销售单
            'If bNewSalesBillType = 0 AndAlso dmPayableAMT > 0 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillSalesmanAdjust'").Length > 0 Then
            'If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7) AndAlso dmPayableAMT > 0 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillSalesmanAdjust'").Length > 0 Then
            If (bNewSalesBillType = 0 OrElse bNewSalesBillType = 7 OrElse bNewSalesBillType = 8) AndAlso dmPayableAMT > 0 AndAlso frmMain.dtAllowedRight.Select("RightName='SalesBillSalesmanAdjust'").Length > 0 Then
                'modify code 046,054:end-------------------------------------------------------------------------
                Me.pnlAddjustSalesman.Visible = True
            End If

            Me.dgvNormalCard.Columns("CardCost").ToolTipText = ""
            'modify code 004:start-------------------------------------------------------------------------
            'Me.dgvNormalCard.Columns("CardCost").Visible = (drSalesBill("CardCost") > 0)
            Me.dgvNormalCard.Columns("CardCost").Visible = True
            'modify code 004:end-------------------------------------------------------------------------
            If Me.dgvNormalCard.Columns("PaymentDescription").Visible Then Me.dgvNormalCard.Columns("PaymentDescription").Width -= 24
            Me.dgvNormalCard.Columns("ActivationState").Visible = True
            Me.dgvNormalCard.ReadOnly = True
            Me.dgvRebateCard.Columns("ActivationState").Visible = True
            Me.dgvRebateCard.ReadOnly = True

            If bNewSalesBillType = 1 Then
                Me.lblRefundTitle.Text = "下面是来自退货中心的退货信息："
                Me.dtpRefundDate.Visible = False
                Me.txbRefundDate.Visible = True
                Me.txbRefundNo.ReadOnly = True
                Me.txbRefundNo.BackColor = SystemColors.Window
                Me.txbRefundNo.BackColor = SystemColors.Control
            Else
                Me.dgvPayment.Columns("ValidationState").Visible = True
                Me.dgvPayment.Columns("ValidationState").AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                Me.dgvPayment.Columns("ValidationState").AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                Me.dgvPayment.ReadOnly = True
                Me.btnModifyPaymentInfo.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillPaymentModify'").Length > 0)
            End If

            dmTotalChargedAMT = drSalesBill("ChargedAMT")
            dmTotalRebateAMT = dmRebateSalesAMT
            'modify code 040,044:start-------------------------------------------------------------------------
            'dmTotalPaymentAMT = dmPayableAMT
            If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                If strSelectedBuyChannel = "Cul" Then
                    dmTotalPaymentAMT = ecir.ExtractingCodeInfoData.BillPayTotalAmount + drSalesBill("CardCost")
                Else
                    dmTotalPaymentAMT = cir.CodeAmount / 100 + drSalesBill("CardCost")
                End If
            Else
                dmTotalPaymentAMT = dmPayableAMT
            End If
            'modify code 040,044:end-------------------------------------------------------------------------
            dmTotalPrintedInvoiceAMT = 0

            Me.btnOK.Text = "申请取消(&O)"
            'modify code 040:start-------------------------------------------------------------------------
            Me.btnOK.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillCancel'").Length > 0 And Not bNewSalesBillType = 6)
            'modify code 040:start-------------------------------------------------------------------------
            Me.btnPrintTicket.Enabled = (frmMain.dtAllowedRight.Select("RightName='SalesBillTicketPrint'").Length > 0)
            Me.btnPrintApplicationForm.Enabled = (dmRebateSalesAMT > 0)
            Me.btnPrintInvoice.Text = "打印发票(&I)"
            Me.btnPrintInvoice.Enabled = False
            Me.btnViewActivation.Enabled = True

            Me.Text = "查看销售单"

            If drSalesBill("NormalCardQTY") = 0 Then Me.splitList.Panel1Collapsed = True : Me.Refresh()
            If drSalesBill("RebateCardQTY") = 0 Then Me.splitList.Panel2Collapsed = True : Me.grbPrintDiscount.Visible = False
            If Me.splitList.Panel2Collapsed = False Then Me.ResetCardListLayout()

            If Me.flpLeftContainer.VerticalScroll.Visible = True Then
                Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
                Me.flpLeftContainer.VerticalScroll.Value = Me.flpLeftContainer.VerticalScroll.Maximum
            End If

            If drSalesBill("CustomerID").ToString <> "" AndAlso frmCustomerManagement.IsHandleCreated Then
                Try
                    Dim customer As DataRow = frmCustomerManagement.dvCustomer.Table.Rows.Find(drSalesBill("CustomerID").ToString)
                    customer("SalesBillCount") = customer("SalesBillCount") + 1 : customer.AcceptChanges()
                Catch
                End Try
            End If

            'If drSalesBill("RebateMode") > 1 AndAlso frmContractManagement.IsHandleCreated Then
            '    If frmContractManagement.IsHandleCreated Then
            '        Try
            '            Dim contractRow As DataRow = frmContractManagement.dvContract.Table.Rows.Find(drSalesBill("RebateRuleID").ToString)
            '            If drSalesBill("RebateMode") = 2 Then '合同返点
            '                If dmNormalSalesAMT > 0 Then contractRow("SalesTimes") += 1
            '                If drSalesBill("AddToContract") Then contractRow("SalesAMT") += dmNormalSalesAMT
            '                contractRow("RebateAMT") = drContract("HistoryRebateAMT") + dtResult.Rows(0)("TodayRebateAMT")
            '                contractRow("AverageRebateRate") = (contractRow("RebateAMT") / (contractRow("SalesAMT") - IIf(contractRow("PaymentMode").ToString.IndexOf("付款抵扣") = -1, 0, contractRow("RebateAMT")))) * 100
            '            End If
            '            contractRow("PaidRebateAMT") += dmRebateSalesAMT
            '            contractRow("BalanceRebateAMT") = contractRow("RebateAMT") - contractRow("PaidRebateAMT")
            '            contractRow.EndEdit() : contractRow.AcceptChanges()
            '            contractRow = Nothing
            '        Catch
            '        End Try
            '    End If
            'End If

            'If drSalesBill("RebateMode") > 1 AndAlso frmContractManagement.IsHandleCreated Then
            '    If frmContractManagement.IsHandleCreated Then
            '        Try
            '            Dim contractRow As DataRow = frmContractManagement.dvContract.Table.Rows.Find(drSalesBill("RebateRuleID").ToString)
            '            If drSalesBill("RebateMode") = 2 Then '合同返点
            '                If dmNormalSalesAMT > 0 Then contractRow("SalesTimes") += 1
            '                If drSalesBill("AddToContract") Then contractRow("SalesAMT") += dmNormalSalesAMT
            '                contractRow("RebateAMT") = drContract("HistoryRebateAMT") + dtResult.Rows(0)("TodayRebateAMT")
            '                contractRow("AverageRebateRate") = (contractRow("RebateAMT") / (contractRow("SalesAMT") - IIf(contractRow("PaymentMode").ToString.IndexOf("付款抵扣") = -1, 0, contractRow("RebateAMT")))) * 100
            '            End If
            '            contractRow("PaidRebateAMT") += dmRebateSalesAMT
            '            contractRow("BalanceRebateAMT") = contractRow("RebateAMT") - contractRow("PaidRebateAMT")
            '            contractRow.EndEdit() : contractRow.AcceptChanges()
            '            contractRow = Nothing
            '        Catch
            '        End Try
            '    End If
            'End If

            'modify code 068,072:start-------------------------------------------------------------------------
            If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                If drSalesBill("RebateMode") > 1 AndAlso frmCrossContractManagement.IsHandleCreated Then
                    If frmCrossContractManagement.IsHandleCreated Then
                        Try
                            Dim contractRow As DataRow = frmCrossContractManagement.dvContract.Table.Rows.Find(drSalesBill("RebateRuleID").ToString)
                            If drSalesBill("RebateMode") = 2 Then '合同返点
                                If dmNormalSalesAMT > 0 Then contractRow("SalesTimes") += 1
                                If drSalesBill("AddToContract") Then contractRow("SalesAMT") += dmNormalSalesAMT
                                contractRow("RebateAMT") = drContract("HistoryRebateAMT") + dtResult.Rows(0)("TodayRebateAMT")
                                contractRow("AverageRebateRate") = (contractRow("RebateAMT") / (contractRow("SalesAMT") - IIf(contractRow("PaymentMode").ToString.IndexOf("付款抵扣") = -1, 0, contractRow("RebateAMT")))) * 100
                            End If
                            contractRow("PaidRebateAMT") += dmRebateSalesAMT
                            contractRow("BalanceRebateAMT") = contractRow("RebateAMT") - contractRow("PaidRebateAMT")
                            contractRow.EndEdit() : contractRow.AcceptChanges()
                            contractRow = Nothing
                        Catch
                        End Try
                    End If
                End If
            Else
                If drSalesBill("RebateMode") > 1 AndAlso frmContractManagement.IsHandleCreated Then
                    If frmContractManagement.IsHandleCreated Then
                        Try
                            Dim contractRow As DataRow = frmContractManagement.dvContract.Table.Rows.Find(drSalesBill("RebateRuleID").ToString)
                            If drSalesBill("RebateMode") = 2 Then '合同返点
                                If dmNormalSalesAMT > 0 Then contractRow("SalesTimes") += 1
                                If drSalesBill("AddToContract") Then contractRow("SalesAMT") += dmNormalSalesAMT
                                contractRow("RebateAMT") = drContract("HistoryRebateAMT") + dtResult.Rows(0)("TodayRebateAMT")
                                contractRow("AverageRebateRate") = (contractRow("RebateAMT") / (contractRow("SalesAMT") - IIf(contractRow("PaymentMode").ToString.IndexOf("付款抵扣") = -1, 0, contractRow("RebateAMT")))) * 100
                            End If
                            contractRow("PaidRebateAMT") += dmRebateSalesAMT
                            contractRow("BalanceRebateAMT") = contractRow("RebateAMT") - contractRow("PaidRebateAMT")
                            contractRow.EndEdit() : contractRow.AcceptChanges()
                            contractRow = Nothing
                        Catch
                        End Try
                    End If
                End If
            End If
            'modify code 068,072:end-------------------------------------------------------------------------

            If frmSalesBillManagement.IsHandleCreated Then
                With frmSalesBillManagement
                    If .trvArea.SelectedNode Is Nothing OrElse .trvArea.SelectedNode.Name <> drSalesBill("StoreID").ToString Then
                        If .trvArea.SelectedNode IsNot Nothing Then
                            .trvArea.SelectedNode.BackColor = SystemColors.Window
                            .trvArea.SelectedNode.ForeColor = SystemColors.ControlText
                        End If
                        .trvArea.SelectedNode = .trvArea.Nodes.Find(drSalesBill("StoreID").ToString, True)(0)
                        .trvArea.SelectedNode.BackColor = SystemColors.Highlight
                        .trvArea.SelectedNode.ForeColor = SystemColors.HighlightText
                        .trvArea.SelectedNode.EnsureVisible()
                    End If
                    If .dtpSalesDate.Value <> dtResult.Rows(0)("SalesDate") Then
                        If .dtpSalesDate.MaxDate < dtResult.Rows(0)("SalesDate") Then .dtpSalesDate.MaxDate = dtResult.Rows(0)("SalesDate")
                        .dtpSalesDate.Value = dtResult.Rows(0)("SalesDate")
                    End If
                    .chbOnlyInvalid.Checked = False
                    If .cbbSalesBillType.SelectedIndex <> 0 AndAlso .lblSalesBillType.Text <> Me.txbSalesBillType.Text Then .cbbSalesBillType.SelectedIndex = 0
                    If .cbbSalesBillState.SelectedIndex <> 0 AndAlso .cbbSalesBillState.Text <> "等待激活 Inactivated" Then .cbbSalesBillState.SelectedIndex = 0
                    Dim newSalesBill As DataRowView = .dvSalesBill.AddNew
                    newSalesBill("SalesBillID") = sSalesBillID
                    newSalesBill("SalesBillCode") = drSalesBill("StoreCode").ToString & drSalesBill("SalesBillCode").ToString
                    newSalesBill("SalesDate") = dtResult.Rows(0)("SalesDate")
                    Select Case bNewSalesBillType
                        Case 0
                            newSalesBill("SalesBillType") = "一般销售单"
                        Case 1
                            newSalesBill("SalesBillType") = "退货销售单"
                        Case 2
                            newSalesBill("SalesBillType") = "活动卡销售单"
                        Case 3
                            newSalesBill("SalesBillType") = "公关卡销售单"
                            'modify code 040:start-------------------------------------------------------------------------
                        Case 6
                            newSalesBill("SalesBillType") = "线下提卡销售单"
                            'modify code 040:end-------------------------------------------------------------------------
                            'modify code 046:start-------------------------------------------------------------------------
                            '追加销售单类型
                        Case 7
                            newSalesBill("SalesBillType") = "实名制卡销售单"
                            'modify code 046:end-------------------------------------------------------------------------
                            'modify code 054:start-------------------------------------------------------------------------
                            '追加销售单类型
                        Case 8
                            newSalesBill("SalesBillType") = "通卖非实名卡销售单"
                            'modify code 054:end-------------------------------------------------------------------------
                        Case 9
                            newSalesBill("SalesBillType") = "电子卡销售单"
                        Case Else
                            newSalesBill("SalesBillType") = "员工销售单"
                    End Select
                    newSalesBill("CustomerName") = drSalesBill("CustomerName").ToString
                    newSalesBill("StoreName") = dtResult.Rows(0)("StoreName").ToString
                    newSalesBill("CardQTY") = drSalesBill("CardQTY")
                    newSalesBill("ChargedAMT") = drSalesBill("ChargedAMT")
                    newSalesBill("PayableAMT") = drSalesBill("PayableAMT")
                    Select Case drSalesBill("RebateMode")
                        Case 0
                            newSalesBill("RebateMode") = "没有返点"
                        Case 1
                            newSalesBill("RebateMode") = "城市返点"
                        Case 2
                            newSalesBill("RebateMode") = "合同返点"
                        Case 3
                            newSalesBill("RebateMode") = "合同结余"
                        Case Else
                            newSalesBill("RebateMode") = "员工返点"
                    End Select
                    If drSalesBill("RebateMode") <> 0 Then
                        newSalesBill("RebateRate") = drSalesBill("RebateRate")
                        newSalesBill("RebateSalesAMT") = drSalesBill("RebateSalesAMT")
                        newSalesBill("RebateState") = IIf(drSalesBill("RebateState") = 0, "等待审核", "不用审核")
                    End If
                    newSalesBill("SalesBillState") = "等待激活"
                    newSalesBill("CreatorName") = drSalesBill("CreatorName").ToString
                    newSalesBill("CreatedTime") = drSalesBill("CreatedTime")
                    newSalesBill("StoreID") = drSalesBill("StoreID")
                    newSalesBill("CustomerID") = IIf(sCustomerID = "", DBNull.Value, sCustomerID)
                    newSalesBill("BusinessTypeID") = dtResult.Rows(0)("BusinessTypeID")
                    newSalesBill("SalesmanID") = dtResult.Rows(0)("SalesmanID")
                    newSalesBill("SalesmanName") = dtResult.Rows(0)("SalesmanName")
                    newSalesBill("SalesmanChanged") = 0
                    newSalesBill("RebateRuleID") = drSalesBill("RebateRuleID")
                    newSalesBill("NormalRebateApprovableRoleID") = drSalesBill("NormalRebateApprovableRoleID")
                    newSalesBill("CreatorID") = frmMain.sLoginUserID
                    newSalesBill.EndEdit() : newSalesBill.Row.AcceptChanges()
                    newSalesBill = Nothing
                    With .dgvList.Columns("CustomerName")
                        .MinimumWidth = 2
                        .AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
                        .MinimumWidth = .Width
                        .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
                    End With
                    If frmMain.sLoginRoleID = "14" Then .btnCheckAccount.Enabled = True

                    If .dvSalesBill.ToTable("SalesBillID").Select("SalesBillID=" & sSalesBillID).Length = 0 Then
                        .cbbSalesBillType.SelectedIndex = 1
                        .cbbSalesBillType.SelectedIndex = 0
                    End If
                    For Each dr As DataGridViewRow In .dgvList.Rows
                        If dr.Cells("SalesBillID").Value.ToString = sSalesBillID Then
                            dr.Cells(1).Selected = True
                            dr.Selected = True
                            Exit For
                        End If
                    Next
                End With
            End If

            Me.ResetInterfaceLayout()
            Me.btnPrintTicket.PerformClick()
            MessageBox.Show("销售单保存成功。    ", "销售单保存成功。", MessageBoxButtons.OK, MessageBoxIcon.Information)
            'modify code 040,044:start-------------------------------------------------------------------------
            If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
                Dim resultFlag As Boolean = False

                If strSelectedBuyChannel = "Cul" Then
                    Dim dtResultCardInfo As DataTable
                    Dim sCardNo2 As String = ""
                    Dim cardNum As Integer
                    cardNum = CInt(ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.ProductNum)

                    sCards = ""
                    dtResultCardInfo = DB.GetDataTable("select * from NewSalesBillDetails where SalesBillID = " & sSalesBillID & " order by RowID")
                    For Each drCard As DataRow In dtResultCardInfo.Rows
                        sCardNo2 = drCard("StartCardNo").ToString.Substring(0, 18)
                        For iCard As Integer = 0 To CLng(drCard("CardQTY").ToString) - 1
                            sCards = sCards & "-" & ShoppingCardNo.GetFullCardNo((CLng(sCardNo2) + iCard).ToString)
                        Next
                    Next
                    sCards = sCards.Substring(1, 20 * cardNum - 1)

                    If Not SetInternetBillStatus() Then
                        MessageBox.Show("向银商传输领用状态失败，请及时联系ＩＴ人员解决。    ", "传输失败。", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    Else
                        resultFlag = True
                    End If
                Else
                    Dim strDealId As String = ""
                    strDealId = SetInternetRuiTaiStatus()
                    If strDealId <> "" Then
                        resultFlag = True
                        If Not SaveInternetRuiTai(strDealId, sSalesBillID) Then
                            MessageBox.Show("保存瑞泰/销售单关系失败，请及时联系ＩＴ人员解决。    ", "保存失败。", MessageBoxButtons.OK, MessageBoxIcon.Information)
                        End If
                    Else
                        MessageBox.Show("向瑞泰确认消费失败，请及时联系ＩＴ人员解决。    ", "确认失败。", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    End If
                End If

                If resultFlag Then
                    'Dim payResult As Integer = dtPayment.Select("PaymentTerm<>8 and PaymentTerm<>11").Length
                    'If payResult = 0 Then
                    sCards = ""
                    If AutoActivation(sSalesBillID) Then

                        Me.lblSalesBillState.ForeColor = Color.SteelBlue
                        Me.lblSalesBillState.Text = "已提交到CUL，正在激活"

                        For Each drNormal As DataRow In dtNormalCard.Rows
                            drNormal("ActivationState") = "正在激活"
                        Next
                        dtNormalCard.AcceptChanges()
                    Else
                        MessageBox.Show("自动激活购物卡失败，请及时联系ＩＴ人员解决。    ", "自动激活失败。", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    End If
                    'End If
                End If
            End If
            'modify code 040,044:end-------------------------------------------------------------------------
            Me.Activate()
            frmMain.statusText.Text = "销售单已保存。"
            dtResult.Dispose() : dtResult = Nothing
            sErrorNormalInfo = "" : errorNormalCell = Nothing : sErrorRebateInfo = "" : errorRebateCell = Nothing
            DB.Close() : Me.Cursor = Cursors.Default
            blIsChanged = False : Return True
        Else
            Select Case dtResult.Rows(0)(0).ToString
                Case "StoreMissing"
                    MessageBox.Show("当前门店已不存在！请在选择其他门店后再保存销售单。    ", "门店无效！", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                    drSalesBill("StoreID") = DBNull.Value
                    frmMain.statusText.Text = "当前门店已不存在！请在选择其他门店后再保存销售单。"
                    frmSelectStore.ShowDialog()
                    drSalesBill("StoreID") = frmSelectStore.cbbStore.SelectedValue
                    frmSelectStore.Dispose()
                    frmMain.statusText.Text = "请重新保存该销售单。"
                Case "CustomerMissing"
                    If frmCustomerManagement.IsHandleCreated Then
                        Try
                            frmCustomerManagement.dvCustomer.Table.Rows.Find(sCustomerID).Delete()
                        Catch
                        End Try
                    End If
                    sCustomerID = "" : drCustomer = Nothing
                    If MessageBox.Show("因原来客户已被删除而无法保存销售单，是否重新创建该客户？    ", "是否创建客户？", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = Windows.Forms.DialogResult.Yes Then
                        Me.btnNewCustomer.PerformClick()
                    Else
                        sCustomerPrompt = "该客户已被删除！请在创建该客户或选择其他的公司名称后再保存该销售单。"
                        frmMain.statusText.Text = sCustomerPrompt
                        If Me.cbbCustomerName.Visible Then
                            Me.cbbCustomerName.Select() : Me.cbbCustomerName.SelectAll()
                        Else
                            Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
                        End If
                    End If
                Case "CustomerStopped"
                    MessageBox.Show("因原来客户已被停止使用而无法保存销售单！请在选择其他的公司名称后再保存该销售单。    " & Chr(13) & Chr(13) & "停用客户： " & drCustomer("StoreCode").ToString & drCustomer("CustomerCode").ToString & " " & drCustomer("CustomerChineseName").ToString & Space(4) & IIf(dtResult.Rows(0)("StoppedReason").ToString = "", "", Chr(13) & "停用原因： " & dtResult.Rows(0)("StoppedReason").ToString & Space(4)), "客户已被停止使用！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    drCustomer = Nothing
                    sCustomerID = ""
                    sCustomerPrompt = "该客户已被停止使用！请在选择其他的公司名称后再保存该销售单。"
                    frmMain.statusText.Text = sCustomerPrompt
                    Me.Activate()
                    If Me.cbbCustomerName.Visible Then
                        Me.cbbCustomerName.Select() : Me.cbbCustomerName.SelectAll()
                    Else
                        Me.txbCustomerName.Select() : Me.txbCustomerName.SelectAll()
                    End If
                Case "CityRuleChanged"
                    MessageBox.Show("门店所在城市的一般返点规则已发生改变！    " & Chr(13) & Chr(13) & "请按最新的返点规则重新检查您此前分配的返点，在确认无误后再保存销售单。    ", "城市返点规则已改变！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    sNewestCityRuleID = "" : drSalesBill("CityRuleID") = DBNull.Value : drSalesBill("RebateRuleID") = DBNull.Value
                    Try
                        'modify code 054:start-------------------------------------------------------------------------
                        'drNewestCityRule = DB.GetDataTable("Select * From CityRule Where CityID=" & sCityID & " And RuleState=2").Rows(0)
                        drNewestCityRule = DB.GetDataTable("Select * From " & sCityRule & " Where CityID=" & sCityID & " And RuleState=2").Rows(0)
                        'modify code 054:end-------------------------------------------------------------------------
                        sNewestCityRuleID = drNewestCityRule("RuleID").ToString
                        'modify code 054:start-------------------------------------------------------------------------
                        'dtNewestRuleDetails = DB.GetDataTable("Select * From CityRuleDetails Where RuleID=" & sNewestCityRuleID).DefaultView.Table
                        dtNewestRuleDetails = DB.GetDataTable("Select * From " & sCityRuleDetails & " Where RuleID=" & sNewestCityRuleID).DefaultView.Table
                        'modify code 054:end-------------------------------------------------------------------------
                        drSalesBill("RebateRuleID") = sNewestCityRuleID : drSalesBill("CityRuleID") = sNewestCityRuleID
                    Catch
                        drNewestCityRule = Nothing : dtNewestRuleDetails = Nothing
                        Me.chbNormalRebate.Checked = False
                    End Try
                    Me.RebateCardSummary()
                    Me.ResetCardListLayout()
                    frmMain.statusText.Text = "城市返点规则已改变！请在按最新返点规则检查已分配返点正确无误后再保存销售单。"
                Case "BalanceRebateAMTChanged"
                    MessageBox.Show("合同的剩余返点金额已发生改变！    " & Chr(13) & Chr(13) & "请重新检查您此前分配的返点，在确认无误后再保存销售单。    ", "合同的剩余返点金额已改变！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    dmAvailableRebateAMT = dtResult.Rows(0)("BalanceContractBalanceRebateAMT")
                    drSalesBill("BalanceContractBalanceRebateAMT") = dmAvailableRebateAMT
                    Me.txbBalanceContractBalanceRebateAMT.Text = Format(dmAvailableRebateAMT, "#,0.00")
                    Me.UpdateBalanceContractInfo()
                    frmMain.statusText.Text = "合同的剩余返点金额已发生改变！请重新检查您此前分配的返点。"
                Case "ContractDataChanged"
                    MessageBox.Show("合同的返点兑现状态已发生改变！    " & Chr(13) & Chr(13) & "请按合同最新的返点兑现状态重新检查您此前分配的返点，在确认无误后再保存销售单。    ", "合同的返点兑现状态已改变！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    drContract("HistoryRebateAMT") = dtResult.Rows(0)("HistoryRebateAMT") : drContract("HistorySalesAMT") = dtResult.Rows(0)("HistorySalesAMT") : drContract("HistoryTodayPaidRebateAMT") = dtResult.Rows(0)("HistoryTodayPaidRebateAMT") : drContract.AcceptChanges()
                    Me.InitContractInfo()
                    frmMain.statusText.Text = "合同的返点兑现状态已发生改变！请重新检查您此前分配的返点。"
                Case "PurchaseQuotaChanged"
                    If dtResult.Rows(0)("UsedPurchaseQuota").ToString = "" Then
                        drEmployee("UsedPurchaseQuota") = drEmployee("PurchaseQuota")
                    Else
                        drEmployee("UsedPurchaseQuota") = dtResult.Rows(0)("UsedPurchaseQuota")
                    End If
                    If drEmployee("UsedPurchaseQuota") >= drEmployee("PurchaseQuota") Then
                        MessageBox.Show("此员工本月的优惠购买额度已用完！    " & Chr(13) & Chr(13) & "所以，该员工在本月内不再享受购卡优惠。    ", "此员工本月的优惠购买额度已用完！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.grbEmployeeInfo.Text = "员工信息："
                        drSalesBill("TelMP") = DBNull.Value
                        Me.grbInputEmployeeTel.Visible = False
                        Me.txbUsedPurchaseQuota.Text = Format(drEmployee("UsedPurchaseQuota"), "#,0.00")
                        Me.txbUsedRebateQuota.Text = Format(drEmployee("UsedPurchaseQuota") * drEmployee("RateQuota"), "#,0.00")
                        Me.tlpAvailableQuota.Visible = False
                        Me.tlpDistributedQuota.Visible = False
                        Me.tlpBalanceQuota.Visible = False
                        Me.flpEmployeeQuota.AutoSize = False
                        Me.flpEmployeeQuota.AutoSize = True
                        Me.grbEmployeeQuota.Height = Me.flpEmployeeQuota.Height + 25
                        Me.flpEmployee.AutoSize = False
                        Me.flpEmployee.AutoSize = True
                        Me.ResetInterfaceLayout()
                        sEmployeeID = "" : sOldEmployeeID = ""
                        sEmployeePrompt = "此员工本月的优惠购买额度已用完！"
                        sOldEmployeePrompt = sEmployeePrompt
                        Me.Activate()
                        Me.txbInputEmployeeNo.Select() : Me.txbInputEmployeeNo.SelectAll()
                        frmMain.statusText.Text = sEmployeePrompt
                    Else
                        MessageBox.Show("此员工本月已使用额度已发生改变！    " & Chr(13) & Chr(13) & "请重新检查已分配的购买金额与返点金额。    ", "此员工本月已使用额度已发生改变！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        Me.txbUsedPurchaseQuota.Text = Format(drEmployee("UsedPurchaseQuota"), "#,0.00")
                        Me.txbUsedRebateQuota.Text = Format(drEmployee("UsedPurchaseQuota") * drEmployee("RateQuota"), "#,0.00")
                        Me.txbMaxAvailablePurchaseQuota.Text = Format(drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota"), "#,0.00")
                        Me.txbMaxAvailableRebateQuota.Text = Format((drEmployee("PurchaseQuota") - drEmployee("UsedPurchaseQuota")) * drEmployee("RateQuota"), "#,0.00")
                        Me.UpdateEmployeePurchaseInfo()
                        Me.Activate()
                        Me.dgvNormalCard.Select()
                        frmMain.statusText.Text = "此员工本月已使用额度已发生改变！请重新检查已分配的购买金额与返点金额。"
                    End If
                Case "SomeNotBought"
                    For Each drNormal As DataRow In dtNormalCard.Rows
                        If dtResult.Select("CardNo='" & drNormal("StartCardNo").ToString & "'").Length = 1 Then
                            drNormal("ActivationState") = "N"
                        End If
                    Next
                    Me.dgvNormalCard.Refresh()

                    If Me.splitList.Panel2Collapsed = False Then
                        For Each drRebate As DataRow In dtRebateCard.Rows
                            If dtResult.Select("CardNo='" & drRebate("StartCardNo").ToString & "'").Length = 1 Then
                                drRebate("ActivationState") = "N"
                            End If
                        Next
                        Me.dgvRebateCard.Refresh()
                    End If

                    If dtNormalCard.Select("ActivationState='N'").Length > 0 Then
                        MessageBox.Show("您当前处于""购物卡再充值""销售模式。    " & Chr(13) & "但经检查发现部分购物卡（红色卡号）从未充过值。    " & Chr(13) & Chr(13) & "请先删除这些卡，再保存销售单。否则，无法保存！    ", "存在未充过值的购物卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        For Each drNormal As DataGridViewRow In Me.dgvNormalCard.Rows
                            If drNormal.Cells("ActivationState").Value.ToString = "N" Then
                                Me.dgvNormalCard.Select()
                                blSkipDeal = True
                                Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = True
                                Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = False
                                blSkipDeal = False
                                Me.dgvNormalCard("StartCardNo", drNormal.Index).Selected = True
                                frmMain.statusText.Text = "存在未充过值的购物卡！请先删除这些卡再保存。"
                                Exit For
                            End If
                        Next
                    Else
                        MessageBox.Show("您当前处于""购物卡再充值""销售模式。    " & Chr(13) & "但经检查发现部分返点卡（红色卡号）从未充过值。    " & Chr(13) & Chr(13) & "请先删除这些卡，再保存销售单。否则，无法保存！    ", "存在未充过值的返点卡！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                        For Each drRebate As DataGridViewRow In Me.dgvRebateCard.Rows
                            If drRebate.Cells("ActivationState").Value.ToString = "N" Then
                                Me.dgvRebateCard.Select()
                                blSkipDeal = True
                                Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = True
                                Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = False
                                blSkipDeal = False
                                Me.dgvRebateCard("StartCardNo", drRebate.Index).Selected = True
                                frmMain.statusText.Text = "存在未充过值的返点卡！请先删除这些卡再保存。"
                                Exit For
                            End If
                        Next
                    End If
                Case "SomeUsed"
                    Dim drCheckedCard As DataRow, drProblemCard As DataRow
                    For Each drCard As DataRow In dtResult.Select("", "RowType,RowID,CardNo")
                        sCardNo = drCard("CardNo").ToString
                        drCheckedCard = dtAllCheckedCard.Rows.Find(sCardNo)
                        drCheckedCard("UsageState") = drCard("UsageState")
                        drCheckedCard("UnchargableReason") = drCard("UnchargableReason").ToString
                        drProblemCard = dtLastCheckingProblemCard.Rows.Find(sCardNo)
                        If drProblemCard Is Nothing Then
                            drProblemCard = dtLastCheckingProblemCard.Rows.Add()
                            drProblemCard("RowType") = Me.SetCardFeature(drCard("RowType"), sCardNo)
                            drProblemCard("RowID") = drCard("RowID").ToString
                            drProblemCard("CardNo") = sCardNo
                            drProblemCard("FaceValue") = dtResult.Compute("Sum(FaceValue)", "CardNo='" & sCardNo & "'")
                            drProblemCard("UsageState") = "不可售卖"
                            drProblemCard("UnchargableReason") = drCard("UnchargableReason").ToString
                            drProblemCard("Operation") = "拷贝卡号"
                        Else
                            drProblemCard("RowType") = "正常卡＋返点卡"
                            drProblemCard("RowID") = drProblemCard("RowID") & "+" & drCard("RowID").ToString
                        End If
                    Next
                    dtAllCheckedCard.AcceptChanges() : dtLastCheckingProblemCard.AcceptChanges()
                    frmCheckCardResult.Text = IIf(dtLastCheckingProblemCard.Rows.Count = drSalesBill("CardQTY"), "", "部分") & "购物卡的可用状态已发生改变！"
                    With frmCheckCardResult
                        .blCanUse60Card = blCanUse60Card
                        .blCanUse92Card = blCanUse92Card
                        .blCanUse94Card = blCanUse94Card
                        .blCanUsePaperCard = blCanUsePaperCard
                        'modify code 051:start-------------------------------------------------------------------------
                        .blCanUse65Card = blCanUse65Card
                        'modify code 051:end-------------------------------------------------------------------------
                        .Show()
                    End With
                    Me.btnViewActivation.Text = "隐藏卡片检查结果(&R)" : Me.btnViewActivation.Enabled = True
                    frmMain.statusText.Text = frmCheckCardResult.Text & "不能保存销售单！"
                Case Else
                    MessageBox.Show("保存销售单时出现错误！下面是数据库的内部错误提示：    " & Chr(13) & Chr(13) & dtResult.Rows(0)("ErrorInfo").ToString & Space(4) & Chr(13) & Chr(13) & "请放弃保存，在关闭窗口后重试。如果仍有问题，请联系软件开发人员。    ", "保存销售单失败！", MessageBoxButtons.OK, MessageBoxIcon.Stop)
                    frmMain.statusText.Text = "保存销售单失败！"
            End Select

            dtResult.Dispose() : dtResult = Nothing
            DB.Close() : Me.Cursor = Cursors.Default
            Me.Activate() : Return False
        End If
    End Function

    Private Sub Ticket_PrintPage_A4(ByVal sender As System.Object, ByVal e As System.Drawing.Printing.PrintPageEventArgs)
        e.Graphics.PageUnit = GraphicsUnit.Millimeter

        Dim titleFont As New Font("宋体", 16), drawFont As New Font("宋体", 10), footFont As New Font("宋体", 9, FontStyle.Italic), blackPen As New Pen(Color.Black, 0.2), drawBrush As New SolidBrush(Color.Black)
        Dim titleFormat As New StringFormat, rightFormat As New StringFormat, drawFormat As New StringFormat
        titleFormat.Alignment = StringAlignment.Center
        rightFormat.Alignment = StringAlignment.Far
        drawFormat.Alignment = StringAlignment.Near
        drawFormat.FormatFlags = StringFormatFlags.NoWrap

        Dim sPrintingText As String
        Select Case drSalesBill("SalesBillType")
            Case 0
                sPrintingText = "家乐福购物卡购买凭证"
            Case 1
                sPrintingText = "家乐福购物卡退货充值凭证"
            Case 2
                'modify code 005:start-------------------------------------------------------------------------
                'sPrintingText = "家乐福活动卡购买凭证"
                sPrintingText = "家乐福市场活动卡凭证"
                'modify code 005:end-------------------------------------------------------------------------
            Case 3
                sPrintingText = "家乐福公关卡购买凭证"
            Case 4
                sPrintingText = "家乐福员工卡购买凭证"
                'modify code 040:start-------------------------------------------------------------------------
            Case 6
                sPrintingText = "家乐福线下提卡凭证"
                'modify code 040:end-------------------------------------------------------------------------
                'modify code 046:start-------------------------------------------------------------------------
            Case 7
                sPrintingText = "家乐福实名制卡凭证"
                'modify code 046:end-------------------------------------------------------------------------
                'modify code 054:start-------------------------------------------------------------------------
            Case 8
                sPrintingText = "家乐福通卖非实名卡凭证"
                'modify code 054:end-------------------------------------------------------------------------
            Case 9
                sPrintingText = "家乐福电子卡凭证"
            Case Else
                sPrintingText = "家乐福卡联名卡购买凭证"
        End Select
        If My.Settings.IsInTraining Then sPrintingText = sPrintingText & "（培训使用，非有效凭证）"
        e.Graphics.DrawString(sPrintingText, titleFont, drawBrush, New Rectangle(10, 10, 180, 20), titleFormat)

        If drSalesBill("TicketPrintedTimes") > 0 Then
            e.Graphics.DrawRectangle(blackPen, New Rectangle(174, 12, 16, 3))
            e.Graphics.DrawString("第" & (drSalesBill("TicketPrintedTimes") + 1).ToString & "次打印", footFont, drawBrush, 174, 12)
        End If

        sPrintingText = "公司名称："
        Select Case drSalesBill("SalesBillType")
            'modify code 040,046,054:start-------------------------------------------------------------------------
            'Case 0 '一般销售单
            'Case 0, 6 '一般销售单、线下提卡销售单
            'Case 0, 6, 7 '一般销售单、线下提卡销售单、实名制卡销售单
            Case 0, 6, 7, 8, 9 '一般销售单、线下提卡销售单、实名制卡销售单
                'modify code 040,046,054:end-------------------------------------------------------------------------
                If drSalesBill("CustomerType") = 0 Then
                    sPrintingText = sPrintingText & "（个人客户）"
                Else
                    sPrintingText = sPrintingText & Me.txbCustomerName.Text
                    If drSalesBill("RebateMode") = 2 Then sPrintingText = sPrintingText & "（合同客户）"
                    If Me.txbCompanyCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
                End If
            Case 1 '退货销售单
                sPrintingText = sPrintingText & "（退货客户）"
            Case 2, 3 '活动卡销售单、公关卡销售单
                sPrintingText = sPrintingText & Me.txbCustomerName.Text & "（家乐福自购）  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
            Case 4 '员工销售单
                sPrintingText = sPrintingText & "（家乐福内部员工：" & Me.txbEmployeeNo.Text & "）"
            Case Else
                sPrintingText = sPrintingText & "（个人客户）"
        End Select
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(10, 18, 180, 10), drawFormat)
        sPrintingText = "客户姓名："
        If drSalesBill("SalesBillType") = 4 Then
            sPrintingText = sPrintingText & Me.txbEmployeeName.Text
            If Me.txbEmployeeTel.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbEmployeeTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbEmployeeIDNo.Text & "（" & Me.txbEmployeeIDType.Text & "）"
        ElseIf drSalesBill("SalesBillType") = 5 Then
            sPrintingText = sPrintingText & Me.txbMemberName.Text
            sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbMemberTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbMemberIDNo.Text & "（居民身份证）"
        ElseIf Me.txbBuyerName.Text <> "" Then
            sPrintingText = sPrintingText & Me.txbBuyerName.Text
            If Me.txbTelMP.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbTelMP.Text)
            If Me.txbBuyerCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbBuyerCredentialsNo.Text & "（" & Me.txbBuyerCredentialsType.Text & "）"
        End If
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(10, 23, 180, 10), drawFormat)

        e.Graphics.DrawString("销售单号：" & Me.lblSalesBillCode.Text, drawFont, drawBrush, New Rectangle(143, 18, 60, 10), drawFormat)
        e.Graphics.DrawString("建单时间：" & Me.lblCreatedTime.Text.Substring(0, 16), drawFont, drawBrush, New Rectangle(143, 23, 60, 10), drawFormat)

        e.Graphics.DrawLine(blackPen, 10, 28, 190, 28)

        'modify code 005:start-------------------------------------------------------------------------
        Dim newRowHeight As Integer
        If drSalesBill("SalesBillType") = 2 Then
            newRowHeight = 6
            e.Graphics.DrawString("以下列表是购买商品抵用券信息", drawFont, drawBrush, New Rectangle(10, 30, 100, newRowHeight), drawFormat)
        Else
            newRowHeight = 0
        End If
        '以下行的top位置参数 +newRowHeight

        '每页可容纳50行->iPrintRows
        'modify code 060:start-------------------------------------------------------------------------
        'Dim iRow As Integer, iStartRow As Int16 = (iTicketPageNum - 1) * 50, iEndRow As Int16 = iStartRow + 49
        Dim iRow As Integer, iStartRow As Int16 = (iTicketPageNum - 1) * iPrintRows, iEndRow As Int16 = iStartRow + iPrintRows - 1
        'modify code 060:end-------------------------------------------------------------------------
        If iEndRow > dtCardListInTicket.Rows.Count - 1 Then iEndRow = dtCardListInTicket.Rows.Count - 1

        If iEndRow >= iStartRow Then
            e.Graphics.DrawString("行号", drawFont, drawBrush, New Rectangle(10, 30 + newRowHeight, 10, 10), drawFormat)
            e.Graphics.DrawString("开始卡号", drawFont, drawBrush, New Rectangle(20, 30 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("结束卡号", drawFont, drawBrush, New Rectangle(58, 30 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("数量", drawFont, drawBrush, New Rectangle(96, 30 + newRowHeight, 12, 10), rightFormat)
            e.Graphics.DrawString("面值", drawFont, drawBrush, New Rectangle(108, 30 + newRowHeight, 20, 10), rightFormat)
            'modify code 004:start-------------------------------------------------------------------------
            e.Graphics.DrawString("卡费/张", drawFont, drawBrush, New Rectangle(128, 30 + newRowHeight, 18, 10), rightFormat)
            'e.Graphics.DrawString("充值总计", drawFont, drawBrush, New Rectangle(128, 30, 31, 10), rightFormat)
            'e.Graphics.DrawString("应付总计", drawFont, drawBrush, New Rectangle(159, 30, 31, 10), rightFormat)
            e.Graphics.DrawString("充值总计", drawFont, drawBrush, New Rectangle(146, 30 + newRowHeight, 22, 10), rightFormat)
            e.Graphics.DrawString("应付总计", drawFont, drawBrush, New Rectangle(168, 30 + newRowHeight, 22, 10), rightFormat)
            'modify code 004:end-------------------------------------------------------------------------
        End If

        For iRow = iStartRow To iEndRow
            'modify code 060:start-------------------------------------------------------------------------
            If dtCardListInTicket.Rows(iRow)("RowID").ToString = "" Then
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(10, 36 + newRowHeight + (iRow Mod 50) * 5, 80, 10), drawFormat) '打印"以下列表是营销卡"
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(10, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 80, 10), drawFormat) '打印"以下列表是营销卡"
            Else
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("RowID").ToString, drawFont, drawBrush, New Rectangle(9, 36 + newRowHeight + (iRow Mod 50) * 5, 10, 10), titleFormat)
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(20, 36 + newRowHeight + (iRow Mod 50) * 5, 38, 10), drawFormat)
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("EndCardNo").ToString, drawFont, drawBrush, New Rectangle(58, 36 + newRowHeight + (iRow Mod 50) * 5, 38, 10), drawFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("CardQTY"), "#,0"), drawFont, drawBrush, New Rectangle(96, 36 + newRowHeight + (iRow Mod 50) * 5, 12, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("FaceValue"), "#,0.00"), drawFont, drawBrush, New Rectangle(108, 36 + newRowHeight + (iRow Mod 50) * 5, 20, 10), rightFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("RowID").ToString, drawFont, drawBrush, New Rectangle(9, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 10, 10), titleFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(20, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("EndCardNo").ToString, drawFont, drawBrush, New Rectangle(58, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("CardQTY"), "#,0"), drawFont, drawBrush, New Rectangle(96, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 12, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("FaceValue"), "#,0.00"), drawFont, drawBrush, New Rectangle(108, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 20, 10), rightFormat)
                'modify code 004:start-------------------------------------------------------------------------
                'e.Graphics.DrawString(Format(CDec(dtCardListInTicket.Rows(iRow)("CardCost")), "#,0.00"), drawFont, drawBrush, New Rectangle(128, 36 + newRowHeight + (iRow Mod 50) * 5, 18, 10), rightFormat)
                ''e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(128, 36 + (iRow Mod 50) * 5, 31, 10), rightFormat)
                ''e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(159, 36 + (iRow Mod 50) * 5, 31, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 36 + newRowHeight + (iRow Mod 50) * 5, 22, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(168, 36 + newRowHeight + (iRow Mod 50) * 5, 22, 10), rightFormat)
                e.Graphics.DrawString(Format(CDec(dtCardListInTicket.Rows(iRow)("CardCost")), "#,0.00"), drawFont, drawBrush, New Rectangle(128, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 18, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 22, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(168, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 22, 10), rightFormat)
                'modify code 004:end-------------------------------------------------------------------------
            End If
            'modify code 060:end-------------------------------------------------------------------------
        Next
        'modify code 005:end-------------------------------------------------------------------------

        Dim blIsLastPage As Boolean, iCurrentPageNum As Int16 = iTicketPageNum
        If iTicketPageCount > 1 Then
            If iTicketPageNum < iTicketPageCount Then
                blIsLastPage = False
                e.HasMorePages = True
            Else
                blIsLastPage = True
                e.HasMorePages = False
            End If
            iTicketPageNum = iTicketPageNum + 1
        Else
            blIsLastPage = True
            e.HasMorePages = False
        End If

        'modify code 060:start-------------------------------------------------------------------------
        '卡行以下的信息都下移iAdjust
        If blIsLastPage Then
            'modify code 005:start-------------------------------------------------------------------------
            Dim bDistance As Byte = 5, iTop As Integer = 238 + iAdjust + newRowHeight, iWidth As Integer = 90
            'modify code 005:end-------------------------------------------------------------------------
            If drSalesBill("CardCost") > 0 OrElse dtPayment.DefaultView.ToTable(True, "PaymentTerm").Rows.Count = 5 Then bDistance = 4
            'modify code 061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 50 '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 50 '如果属非现金的付款方式，需打印转出/转入账户信息
            'modify code 061:end-------------------------------------------------------------------------

            'modify code 005:start-------------------------------------------------------------------------
            e.Graphics.DrawLine(blackPen, 10, 236 + iAdjust + newRowHeight, 190, 236 + iAdjust + newRowHeight)
            'modify code 005:end-------------------------------------------------------------------------

            e.Graphics.DrawString("卡片数量：" & Me.txbCardQTY.Text & " 张", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            e.Graphics.DrawString("充值金额：" & Me.txbChargedAMT.Text & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            If drSalesBill("RebateSalesAMT") = 0 Then
                e.Graphics.DrawString("折扣金额：0.00 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("折扣比例：0.0 %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("折扣比例：0.00 %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                'modify code 038:end-------------------------------------------------------------------------
            ElseIf drSalesBill("RebateCardQTY") = 0 Then
                e.Graphics.DrawString("抵扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("抵扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("抵扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                'modify code 038:end-------------------------------------------------------------------------
            Else
                e.Graphics.DrawString("折扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("折扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("折扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                'modify code 038:end-------------------------------------------------------------------------
            End If
            iTop += bDistance
            e.Graphics.DrawString("实收金额：" & Me.txbPaymentAMT.Text & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            If drSalesBill("CardCost") > 0 Then
                iTop += bDistance
                'modify code 004:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("卡片成本：" & Format(drSalesBill("CardCost"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("卡费：" & Format(drSalesBill("CardCost"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                'modify code 004:end-------------------------------------------------------------------------
            End If

            'modify code 005:start-------------------------------------------------------------------------
            iTop = 238 + iAdjust + newRowHeight
            'modify code 005:end-------------------------------------------------------------------------

            'modify code 040:start-------------------------------------------------------------------------
            'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
            '    e.Graphics.DrawString("可开票总金额：" & dmTotalPaymentAMT & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
            '    iTop = iTop + bDistance
            'End If
            'modify code 040:end-------------------------------------------------------------------------

            e.Graphics.DrawString("付款方式：", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
            If drSalesBill("SalesBillType") = 1 Then
                iTop += bDistance
                e.Graphics.DrawString("（退货单无须付款）", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
            ElseIf drSalesBill("PayableAMT") = 0 Then
                iTop += bDistance
                e.Graphics.DrawString("（返点单无须付款）", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
            Else
                Dim dmTermAMT As Decimal = 0, sText As String = ""
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=0")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    现金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=1")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  银行卡 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=2 Or PaymentTerm=5")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    转账 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=3 Or PaymentTerm=4 Or PaymentTerm=6")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    支票 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=4")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  保证金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 008:start-------------------------------------------------------------------------
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=7")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("积分兑换 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 008:end-------------------------------------------------------------------------
                'modify code 040,044:start-------------------------------------------------------------------------
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=8")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    'e.Graphics.DrawString("  兑换码 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=11")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 040,044:end-------------------------------------------------------------------------
            End If

            'modify code 061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
                'modify code 061:end-------------------------------------------------------------------------
                'modify code 005:start-------------------------------------------------------------------------
                iTop = 238 + iAdjust + newRowHeight
                'modify code 005:end-------------------------------------------------------------------------
                e.Graphics.DrawString("转出/转入账户信息：", drawFont, drawBrush, New Rectangle(100, iTop, 80, 10), drawFormat)
                sPrintingText = ""
                Dim dvTemp As DataView = dtPayment.Copy.DefaultView, dtTemp As DataTable
                dvTemp.Sort = "RowID"
                dvTemp.RowFilter = "PaymentTerm>0"
                dtTemp = dvTemp.ToTable(True, "PayerName")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("PayerName").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 57 Then bDistance = 4
                iTop += bDistance
                e.Graphics.DrawString("转出账户名称：", drawFont, drawBrush, New Rectangle(100, iTop, 80, 20), drawFormat)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(124, iTop, 57, 20), New StringFormat) '使用默认的StringFormat以允许换行
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 57 Then iTop += bDistance
                iTop += bDistance
                sPrintingText = "转出账户账号："
                dtTemp = dvTemp.ToTable(True, "MediaNo")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("MediaNo").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(100, iTop, 81, 10), drawFormat)
                dvTemp.Dispose() : dvTemp = Nothing : dtTemp.Dispose() : dtTemp = Nothing
                iTop += bDistance
                If drInternalPayer Is Nothing Then drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
                e.Graphics.DrawString("转入账户名称：" & drInternalPayer("PayeeName").ToString, drawFont, drawBrush, New Rectangle(100, iTop, 81, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("转入账户账号：" & drInternalPayer("ReceiverAccountNo").ToString, drawFont, drawBrush, New Rectangle(100, iTop, 81, 10), drawFormat)
            End If

            'e.Graphics.DrawRectangle(blackPen, New Rectangle(10, 264, 141, 12))
            'e.Graphics.DrawRectangle(blackPen, New Rectangle(154, 264, 36, 12))

            'modify code 005:start-------------------------------------------------------------------------
            e.Graphics.DrawString("本人已认真阅读家乐福福卡公告及章程，知晓并同意其中所有条款。", drawFont, drawBrush, New Rectangle(11, 265 + iAdjust + newRowHeight, 120, 10), drawFormat)
            If drSalesBill("SalesBillType") = 5 Then '联名卡销售单
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = "新/旧" Else sPrintingText = ""
                sPrintingText = sPrintingText & "积分卡号：" & Me.txbNewMemberCardNo.Text
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = sPrintingText & "/" & Me.txbOldMemberCardNo.Text
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(11, 271 + iAdjust + newRowHeight, 120, 10), drawFormat)
            End If
            e.Graphics.DrawString("客户签名：", drawFont, drawBrush, New Rectangle(117, 271 + iAdjust + newRowHeight, 20, 10), drawFormat) '-6
            e.Graphics.DrawString("销售签名：", drawFont, drawBrush, New Rectangle(155, 271 + iAdjust + newRowHeight, 20, 10), drawFormat) '-6
        Else
            e.Graphics.DrawLine(blackPen, 10, 276 + iAdjust + newRowHeight, 190, 276 + iAdjust + newRowHeight)
        End If

        If Me.lblCreatorName.Text = frmMain.sLoginUserRealName Then
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(10, 278 + iAdjust + newRowHeight, 190, 10), drawFormat)
        Else
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印：" & frmMain.sLoginUserRealName & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(10, 278 + iAdjust + newRowHeight, 180, 10), drawFormat)
        End If

        e.Graphics.DrawString("(第" & iCurrentPageNum & "页,共" & iTicketPageCount & "页)", footFont, drawBrush, New Rectangle(10, 278 + iAdjust + newRowHeight, 180, 10), rightFormat)
        'modify code 005,060:end-------------------------------------------------------------------------
    End Sub

    Private Sub Ticket_PrintPage_MultiPaper(ByVal sender As System.Object, ByVal e As System.Drawing.Printing.PrintPageEventArgs)
        e.Graphics.PageUnit = GraphicsUnit.Millimeter

        Dim titleFont As New Font("宋体", 16), drawFont As New Font("宋体", 10), footFont As New Font("宋体", 9, FontStyle.Italic), blackPen As New Pen(Color.Black, 0.2), drawBrush As New SolidBrush(Color.Black)
        Dim titleFormat As New StringFormat, rightFormat As New StringFormat, drawFormat As New StringFormat
        titleFormat.Alignment = StringAlignment.Center
        rightFormat.Alignment = StringAlignment.Far
        drawFormat.Alignment = StringAlignment.Near
        drawFormat.FormatFlags = StringFormatFlags.NoWrap

        Dim sPrintingText As String
        Select Case drSalesBill("SalesBillType")
            Case 0
                sPrintingText = "家乐福购物卡购买凭证"
            Case 1
                sPrintingText = "家乐福购物卡退货充值凭证"
            Case 2
                'modify code 005:start-------------------------------------------------------------------------
                'sPrintingText = "家乐福活动卡购买凭证"
                sPrintingText = "家乐福市场活动卡凭证"
                'modify code 005:end-------------------------------------------------------------------------
            Case 3
                sPrintingText = "家乐福公关卡购买凭证"
            Case 4
                sPrintingText = "家乐福员工卡购买凭证"
                'modify code 040:start-------------------------------------------------------------------------
            Case 6
                sPrintingText = "家乐福线下提卡凭证"
                'modify code 040:end-------------------------------------------------------------------------
                'modify code 046:start-------------------------------------------------------------------------
            Case 7
                sPrintingText = "家乐福实名制卡凭证"
                'modify code 046:end-------------------------------------------------------------------------
                'modify code 054:start-------------------------------------------------------------------------
            Case 8
                sPrintingText = "家乐福通卖非实名卡凭证"
                'modify code 054:end-------------------------------------------------------------------------
            Case 9
                sPrintingText = "家乐福电子卡凭证"
            Case Else
                sPrintingText = "家乐福卡联名卡购买凭证"
        End Select
        If My.Settings.IsInTraining Then sPrintingText = sPrintingText & "（培训使用，非有效凭证）"
        e.Graphics.DrawString(sPrintingText, titleFont, drawBrush, New Rectangle(0, 0, 200, 20), titleFormat)

        If drSalesBill("TicketPrintedTimes") > 0 Then
            e.Graphics.DrawRectangle(blackPen, New Rectangle(184, 2, 16, 3))
            e.Graphics.DrawString("第" & (drSalesBill("TicketPrintedTimes") + 1).ToString & "次打印", footFont, drawBrush, 184, 2)
        End If

        sPrintingText = "公司名称："
        Select Case drSalesBill("SalesBillType")
            'modify code 040,046,054:start-------------------------------------------------------------------------
            'Case 0 '一般销售单
            'Case 0, 6 '一般销售单、线下提卡销售单
            'Case 0, 6, 7 '一般销售单、线下提卡销售单、实名制卡销售单
            Case 0, 6, 7, 8, 9 '一般销售单、线下提卡销售单、实名制卡销售单
                'modify code 040,046,054:end-------------------------------------------------------------------------
                If drSalesBill("CustomerType") = 0 Then
                    sPrintingText = sPrintingText & "（个人客户）"
                Else
                    sPrintingText = sPrintingText & Me.txbCustomerName.Text
                    If drSalesBill("RebateMode") = 2 Then sPrintingText = sPrintingText & "（合同客户）"
                    If Me.txbCompanyCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
                End If
            Case 1 '退货销售单
                sPrintingText = sPrintingText & "（退货客户）"
            Case 2, 3 '活动卡销售单、公关卡销售单
                sPrintingText = sPrintingText & Me.txbCustomerName.Text & "（家乐福自购）  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
            Case 4 '员工销售单
                sPrintingText = sPrintingText & "（家乐福内部员工：" & Me.txbEmployeeNo.Text & "）"
            Case Else
                sPrintingText = sPrintingText & "（个人客户）"
        End Select
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(0, 8, 200, 10), drawFormat)
        sPrintingText = "客户姓名："
        If drSalesBill("SalesBillType") = 4 Then
            sPrintingText = sPrintingText & Me.txbEmployeeName.Text
            If Me.txbEmployeeTel.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbEmployeeTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbEmployeeIDNo.Text & "（" & Me.txbEmployeeIDType.Text & "）"
        ElseIf drSalesBill("SalesBillType") = 5 Then
            sPrintingText = sPrintingText & Me.txbMemberName.Text
            sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbMemberTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbMemberIDNo.Text & "（居民身份证）"
        ElseIf Me.txbBuyerName.Text <> "" Then
            sPrintingText = sPrintingText & Me.txbBuyerName.Text
            If Me.txbTelMP.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbTelMP.Text)
            If Me.txbBuyerCredentialsNo.Visible AndAlso Me.txbBuyerCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbBuyerCredentialsNo.Text & "（" & Me.txbBuyerCredentialsType.Text & "）"
        End If
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(0, 13, 200, 10), drawFormat)

        e.Graphics.DrawString("销售单号：" & Me.lblSalesBillCode.Text, drawFont, drawBrush, New Rectangle(152, 8, 60, 10), drawFormat)
        e.Graphics.DrawString("建单时间：" & Me.lblCreatedTime.Text.Substring(0, 16), drawFont, drawBrush, New Rectangle(152, 13, 60, 10), drawFormat)

        e.Graphics.DrawLine(blackPen, 0, 18, 200, 18)

        'modify code 005:start-------------------------------------------------------------------------
        Dim newRowHeight As Integer
        If drSalesBill("SalesBillType") = 2 Then
            newRowHeight = 6
            e.Graphics.DrawString("以下列表是购买商品抵用券信息", drawFont, drawBrush, New Rectangle(0, 20, 100, newRowHeight), drawFormat)
        Else
            newRowHeight = 0
        End If
        '以下行的top位置参数 +newRowHeight

        '每页可容纳20行
        Dim iRow As Integer, iStartRow As Int16 = (iTicketPageNum - 1) * 20, iEndRow As Int16 = iStartRow + 19
        If iEndRow > dtCardListInTicket.Rows.Count - 1 Then iEndRow = dtCardListInTicket.Rows.Count - 1

        If iEndRow >= iStartRow Then
            e.Graphics.DrawString("行号", drawFont, drawBrush, New Rectangle(0, 20 + newRowHeight, 10, 10), drawFormat)
            e.Graphics.DrawString("开始卡号", drawFont, drawBrush, New Rectangle(10, 20 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("结束卡号", drawFont, drawBrush, New Rectangle(48, 20 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("数量", drawFont, drawBrush, New Rectangle(86, 20 + newRowHeight, 16, 10), rightFormat)
            e.Graphics.DrawString("面值", drawFont, drawBrush, New Rectangle(102, 20 + newRowHeight, 20, 10), rightFormat)
            'modify code 004:start-------------------------------------------------------------------------
            e.Graphics.DrawString("卡费/张", drawFont, drawBrush, New Rectangle(122, 20 + newRowHeight, 20, 10), rightFormat)
            'e.Graphics.DrawString("充值总计", drawFont, drawBrush, New Rectangle(122, 20, 39, 10), rightFormat)
            'e.Graphics.DrawString("应付总计", drawFont, drawBrush, New Rectangle(161, 20, 39, 10), rightFormat)
            e.Graphics.DrawString("充值总计", drawFont, drawBrush, New Rectangle(142, 20 + newRowHeight, 29, 10), rightFormat)
            e.Graphics.DrawString("应付总计", drawFont, drawBrush, New Rectangle(171, 20 + newRowHeight, 29, 10), rightFormat)
            'modify code 004:end-------------------------------------------------------------------------
        End If

        For iRow = iStartRow To iEndRow
            If dtCardListInTicket.Rows(iRow)("RowID").ToString = "" Then
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(0, 26 + newRowHeight + (iRow Mod 20) * 5, 80, 10), drawFormat) '打印"以下列表是营销卡"
            Else
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("RowID").ToString, drawFont, drawBrush, New Rectangle(0, 26 + newRowHeight + (iRow Mod 20) * 5, 8, 10), titleFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(10, 26 + newRowHeight + (iRow Mod 20) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("EndCardNo").ToString, drawFont, drawBrush, New Rectangle(48, 26 + newRowHeight + (iRow Mod 20) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("CardQTY"), "#,0"), drawFont, drawBrush, New Rectangle(86, 26 + newRowHeight + (iRow Mod 20) * 5, 16, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("FaceValue"), "#,0.00"), drawFont, drawBrush, New Rectangle(102, 26 + newRowHeight + (iRow Mod 20) * 5, 20, 10), rightFormat)
                'modify code 004:start-------------------------------------------------------------------------
                e.Graphics.DrawString(Format(CDec(dtCardListInTicket.Rows(iRow)("CardCost")), "#,0.00"), drawFont, drawBrush, New Rectangle(122, 26 + newRowHeight + (iRow Mod 20) * 5, 20, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(122, 26 + (iRow Mod 20) * 5, 39, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(161, 26 + (iRow Mod 20) * 5, 39, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(142, 26 + newRowHeight + (iRow Mod 20) * 5, 29, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(171, 26 + newRowHeight + (iRow Mod 20) * 5, 29, 10), rightFormat)
                'modify code 004:start-------------------------------------------------------------------------
            End If
        Next
        'modify code 005:end-------------------------------------------------------------------------

        Dim blIsLastPage As Boolean, iCurrentPageNum As Int16 = iTicketPageNum
        If iTicketPageCount > 1 Then
            If iTicketPageNum < iTicketPageCount Then
                blIsLastPage = False
                e.HasMorePages = True
            Else
                blIsLastPage = True
                e.HasMorePages = False
            End If
            iTicketPageNum = iTicketPageNum + 1
        Else
            blIsLastPage = True
            e.HasMorePages = False
        End If

        If blIsLastPage Then
            'modify code 005:start-------------------------------------------------------------------------
            Dim bDistance As Byte = 5, iTop As Integer = 88 + newRowHeight, iWidth As Integer = 100
            'modify code 005:end-------------------------------------------------------------------------
            If drSalesBill("CardCost") > 0 OrElse dtPayment.DefaultView.ToTable(True, "PaymentTerm").Rows.Count = 5 Then bDistance = 4
            'modify code 061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 55 '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 55 '如果属非现金的付款方式，需打印转出/转入账户信息
            'modify code 061:end-------------------------------------------------------------------------

            'modify code 005:start-------------------------------------------------------------------------
            e.Graphics.DrawLine(blackPen, 0, 86 + newRowHeight, 200, 86 + newRowHeight)
            'modify code 005:end-------------------------------------------------------------------------

            e.Graphics.DrawString("卡片数量：" & Me.txbCardQTY.Text & " 张", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            e.Graphics.DrawString("充值金额：" & Me.txbChargedAMT.Text & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            If drSalesBill("RebateSalesAMT") = 0 Then
                e.Graphics.DrawString("折扣金额：0.00 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("折扣比例：0.0 %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("折扣比例：0.00 %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                'modify code 038:end-------------------------------------------------------------------------
            ElseIf drSalesBill("RebateCardQTY") = 0 Then
                e.Graphics.DrawString("抵扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("抵扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("抵扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                'modify code 038:end-------------------------------------------------------------------------
            Else
                e.Graphics.DrawString("折扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("折扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("折扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                'modify code 038:end-------------------------------------------------------------------------
            End If
            iTop += bDistance
            e.Graphics.DrawString("实收金额：" & Me.txbPaymentAMT.Text & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            If drSalesBill("CardCost") > 0 Then
                iTop += bDistance
                'modify code 004:start-------------------------------------------------------------------------
                'e.Graphics.DrawString("卡片成本：" & Format(drSalesBill("CardCost"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                e.Graphics.DrawString("卡费：" & Format(drSalesBill("CardCost"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                'modify code 004:end-------------------------------------------------------------------------
            End If

            'modify code 005:start-------------------------------------------------------------------------
            iTop = 88 + newRowHeight
            'modify code 005:end-------------------------------------------------------------------------

            'modify code 040:start-------------------------------------------------------------------------
            'If bNewSalesBillType = 6 OrElse drSalesBill("SalesBillType") = 6 Then
            '    e.Graphics.DrawString("可开票总金额：" & dmTotalPaymentAMT & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
            '    iTop = iTop + bDistance
            'End If
            'modify code 040:end-------------------------------------------------------------------------

            e.Graphics.DrawString("付款方式：", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
            If drSalesBill("SalesBillType") = 1 Then
                iTop += bDistance
                e.Graphics.DrawString("（退货单无须付款）", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
            ElseIf drSalesBill("PayableAMT") = 0 Then
                iTop += bDistance
                e.Graphics.DrawString("（返点单无须付款）", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
            Else
                Dim dmTermAMT As Decimal = 0, sText As String = ""
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=0")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    现金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=1")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  银行卡 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=2 Or PaymentTerm=5")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    转账 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=3 Or PaymentTerm=4 Or PaymentTerm=6")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    支票 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=4")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  保证金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 008:start-------------------------------------------------------------------------
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=7")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("积分兑换 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 008:end-------------------------------------------------------------------------
                'modify code 040,044:start-------------------------------------------------------------------------
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=8")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    'e.Graphics.DrawString("  兑换码 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=11")
                Catch
                    dmTermAMT = 0
                End Try
                If dmTermAMT > 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 040,044:end-------------------------------------------------------------------------
            End If

            'modify code 061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
                'modify code 061:end-------------------------------------------------------------------------
                'modify code 005:start-------------------------------------------------------------------------
                iTop = 88 + newRowHeight
                'modify code 005:end-------------------------------------------------------------------------
                e.Graphics.DrawString("转出/转入账户信息：", drawFont, drawBrush, New Rectangle(110, iTop, 90, 10), drawFormat)
                sPrintingText = ""
                Dim dvTemp As DataView = dtPayment.Copy.DefaultView, dtTemp As DataTable
                dvTemp.Sort = "RowID"
                dvTemp.RowFilter = "PaymentTerm>0"
                dtTemp = dvTemp.ToTable(True, "PayerName")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("PayerName").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 67 Then bDistance = 4
                iTop += bDistance
                e.Graphics.DrawString("转出账户名称：", drawFont, drawBrush, New Rectangle(110, iTop, 90, 20), drawFormat)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(134, iTop, 67, 20), New StringFormat) '使用默认的StringFormat以允许换行
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 67 Then iTop += bDistance
                iTop += bDistance
                sPrintingText = "转出账户账号："
                dtTemp = dvTemp.ToTable(True, "MediaNo")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("MediaNo").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(110, iTop, 91, 10), drawFormat)
                dvTemp.Dispose() : dvTemp = Nothing : dtTemp.Dispose() : dtTemp = Nothing
                iTop += bDistance
                If drInternalPayer Is Nothing Then drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
                e.Graphics.DrawString("转入账户名称：" & drInternalPayer("PayeeName").ToString, drawFont, drawBrush, New Rectangle(110, iTop, 91, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("转入账户账号：" & drInternalPayer("ReceiverAccountNo").ToString, drawFont, drawBrush, New Rectangle(110, iTop, 91, 10), drawFormat)
            End If

            'e.Graphics.DrawRectangle(blackPen, New Rectangle(0, 114, 152, 12))
            'e.Graphics.DrawRectangle(blackPen, New Rectangle(157, 114, 43, 12))

            'modify code 005:start-------------------------------------------------------------------------
            e.Graphics.DrawString("本人已认真阅读家乐福福卡公告及章程，知晓并同意其中所有条款。", drawFont, drawBrush, New Rectangle(1, 115 + newRowHeight, 120, 10), drawFormat)
            If drSalesBill("SalesBillType") = 5 Then '联名卡销售单
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = "新/旧" Else sPrintingText = ""
                sPrintingText = sPrintingText & "积分卡号：" & Me.txbNewMemberCardNo.Text
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = sPrintingText & "/" & Me.txbOldMemberCardNo.Text
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(1, 121 + newRowHeight, 120, 10), drawFormat)
            End If
            e.Graphics.DrawString("客户签名：", drawFont, drawBrush, New Rectangle(110, 121 + newRowHeight, 20, 10), drawFormat) '-6
            e.Graphics.DrawString("销售签名：", drawFont, drawBrush, New Rectangle(158, 121 + newRowHeight, 20, 10), drawFormat) '-6
        Else
            e.Graphics.DrawLine(blackPen, 0, 126 + newRowHeight, 200, 126 + newRowHeight)
        End If

        If Me.lblCreatorName.Text = frmMain.sLoginUserRealName Then
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(0, 128 + newRowHeight, 200, 10), drawFormat)
        Else
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印：" & frmMain.sLoginUserRealName & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(0, 128 + newRowHeight, 200, 10), drawFormat)
        End If

        e.Graphics.DrawString("(第" & iCurrentPageNum & "页,共" & iTicketPageCount & "页)", footFont, drawBrush, New Rectangle(0, 128 + newRowHeight, 200, 10), rightFormat)
        'modify code 005:start-------------------------------------------------------------------------
    End Sub

    Private Sub ApplicationForm_PrintPage(ByVal sender As System.Object, ByVal e As System.Drawing.Printing.PrintPageEventArgs)
        e.Graphics.PageUnit = GraphicsUnit.Millimeter

        Dim titleFont As New Font("宋体", 16, FontStyle.Bold), drawFont As New Font("宋体", 10), footFont As New Font("宋体", 9, FontStyle.Italic), blackPen As New Pen(Color.Black, 0.2), drawBrush As New SolidBrush(Color.Black)
        Dim titleFormat As New StringFormat, rightFormat As New StringFormat, drawFormat As New StringFormat
        titleFormat.Alignment = StringAlignment.Center
        rightFormat.Alignment = StringAlignment.Far
        drawFormat.Alignment = StringAlignment.Near
        drawFormat.FormatFlags = StringFormatFlags.NoWrap

        e.Graphics.DrawString("家乐福购物卡折扣申请单", titleFont, drawBrush, New Rectangle(10, 1, 180, 20), titleFormat)
        e.Graphics.DrawString("Carrefour Shopping Card Discount Application Form", titleFont, drawBrush, New Rectangle(10, 6, 180, 20), titleFormat)

        e.Graphics.DrawString("申请门店：" & frmMain.dtLoginStructure.Select("AreaID=" & drSalesBill("StoreID").ToString)(0)("AreaName").ToString, drawFont, drawBrush, New Rectangle(10, 15, 180, 20), drawFormat)
        e.Graphics.DrawString("申请日期：" & Format(Today(), "yyyy\/MM\/dd"), drawFont, drawBrush, New Rectangle(10, 15, 180, 20), rightFormat)

        e.Graphics.DrawRectangle(blackPen, New Rectangle(10, 20, 180, 72))
        e.Graphics.DrawLine(blackPen, 55, 20, 55, 92)
        e.Graphics.DrawLine(blackPen, 100, 20, 100, 32)
        e.Graphics.DrawLine(blackPen, 145, 20, 145, 32)
        e.Graphics.DrawLine(blackPen, 100, 44, 100, 92)
        e.Graphics.DrawLine(blackPen, 145, 44, 145, 92)
        e.Graphics.DrawLine(blackPen, 10, 32, 190, 32)
        e.Graphics.DrawLine(blackPen, 10, 44, 190, 44)
        e.Graphics.DrawLine(blackPen, 10, 56, 190, 56)
        e.Graphics.DrawLine(blackPen, 10, 68, 190, 68)
        e.Graphics.DrawLine(blackPen, 10, 80, 190, 80)

        e.Graphics.DrawString("销售单号：", drawFont, drawBrush, New Rectangle(11, 22, 43, 5), drawFormat)
        e.Graphics.DrawString("Sales Dealing Number：", drawFont, drawBrush, New Rectangle(11, 27, 43, 5), drawFormat)

        e.Graphics.DrawString("购卡日期：", drawFont, drawBrush, New Rectangle(101, 22, 43, 5), drawFormat)
        e.Graphics.DrawString("Purchase Date：", drawFont, drawBrush, New Rectangle(101, 27, 43, 5), drawFormat)

        e.Graphics.DrawString("公司名称：", drawFont, drawBrush, New Rectangle(11, 34, 43, 5), drawFormat)
        e.Graphics.DrawString("Name of Customer：", drawFont, drawBrush, New Rectangle(11, 39, 43, 5), drawFormat)

        e.Graphics.DrawString(IIf(drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("CustomerType") = 0, "购买人：", "代购人："), drawFont, drawBrush, New Rectangle(11, 46, 43, 5), drawFormat)
        e.Graphics.DrawString("Contact Person：", drawFont, drawBrush, New Rectangle(11, 51, 43, 5), drawFormat)

        e.Graphics.DrawString("联系电话：", drawFont, drawBrush, New Rectangle(101, 46, 43, 5), drawFormat)
        e.Graphics.DrawString("Tel No.：", drawFont, drawBrush, New Rectangle(101, 51, 43, 5), drawFormat)

        e.Graphics.DrawString("累计购卡总金额：", drawFont, drawBrush, New Rectangle(11, 58, 43, 5), drawFormat)
        e.Graphics.DrawString("Accumulated Pur. Value：", drawFont, drawBrush, New Rectangle(11, 63, 43, 5), drawFormat)

        e.Graphics.DrawString("累计可享折扣：", drawFont, drawBrush, New Rectangle(101, 58, 43, 5), drawFormat)
        e.Graphics.DrawString("Accumulated Dis. Value：", drawFont, drawBrush, New Rectangle(101, 63, 43, 5), drawFormat)

        e.Graphics.DrawString("历史已分配折扣：", drawFont, drawBrush, New Rectangle(11, 70, 43, 5), drawFormat)
        e.Graphics.DrawString("History Paid Discount：", drawFont, drawBrush, New Rectangle(11, 75, 43, 5), drawFormat)

        e.Graphics.DrawString("本次已分配折扣：", drawFont, drawBrush, New Rectangle(101, 70, 43, 5), drawFormat)
        e.Graphics.DrawString("Current Paid Discount：", drawFont, drawBrush, New Rectangle(101, 75, 43, 5), drawFormat)

        e.Graphics.DrawString("剩余未分配折扣：", drawFont, drawBrush, New Rectangle(11, 82, 43, 5), drawFormat)
        e.Graphics.DrawString("Remaining Discount：", drawFont, drawBrush, New Rectangle(11, 87, 43, 5), drawFormat)

        e.Graphics.DrawString("累计对应折扣率：", drawFont, drawBrush, New Rectangle(101, 82, 43, 5), drawFormat)
        e.Graphics.DrawString("Accumulated Dis. Rate：", drawFont, drawBrush, New Rectangle(101, 87, 43, 5), drawFormat)

        e.Graphics.DrawString(Me.lblSalesBillCode.Text, drawFont, drawBrush, New Rectangle(56, 24, 43, 5), titleFormat)
        e.Graphics.DrawString(Me.lblCreatedTime.Text.Substring(0, 10), drawFont, drawBrush, New Rectangle(146, 24, 43, 5), titleFormat)

        Dim sValue As String = "（个人客户）"
        If drSalesBill("CustomerType") = 1 Then
            sValue = Me.txbCustomerName.Text
        ElseIf drSalesBill("SalesBillType") = 4 Then
            sValue = "（家乐福内部员工）"
        End If
        e.Graphics.DrawString(sValue, drawFont, drawBrush, New Rectangle(56, 36, 133, 5), titleFormat)

        e.Graphics.DrawString(drSalesBill("BuyerName").ToString, drawFont, drawBrush, New Rectangle(56, 48, 43, 5), titleFormat)
        e.Graphics.DrawString(drSalesBill("TelMP").ToString, drawFont, drawBrush, New Rectangle(146, 48, 43, 5), titleFormat)

        Select Case drSalesBill("RebateMode")
            Case 1, 4  '一般返点或员工返点
                e.Graphics.DrawString(Format(drSalesBill("NormalSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 60, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(drSalesBill("RebateSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 60, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(drSalesBill("RebateSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 72, 43, 5), titleFormat)
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString(Format((drSalesBill("RebateSalesAMT") / drSalesBill("NormalSalesAMT")) * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(146, 84, 43, 5), titleFormat)
                e.Graphics.DrawString(Format((drSalesBill("RebateSalesAMT") / drSalesBill("NormalSalesAMT")) * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(146, 84, 43, 5), titleFormat)
                'modify code 038:end-------------------------------------------------------------------------
            Case 2  '合同返点
                e.Graphics.DrawString(Format(drSalesBill("ContractRebateThisSalesAMT") + drSalesBill("ContractRebateHistorySalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 60, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(drSalesBill("ContractRebateThisRebateAMT") + drSalesBill("ContractRebateHistoryRebateAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 60, 43, 5), titleFormat)

                e.Graphics.DrawString(Format(drSalesBill("ContractRebateHistoryPaidRebateAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 72, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(drSalesBill("RebateSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 72, 43, 5), titleFormat)

                e.Graphics.DrawString(Format(drSalesBill("ContractRebateAvailableRebateAMT") - drSalesBill("RebateSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 84, 43, 5), titleFormat)
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString(Format(((drSalesBill("RebateSalesAMT") + drSalesBill("ContractRebateHistoryPaidRebateAMT")) / (drSalesBill("ContractRebateThisSalesAMT") + drSalesBill("ContractRebateHistorySalesAMT"))) * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(146, 84, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(((drSalesBill("RebateSalesAMT") + drSalesBill("ContractRebateHistoryPaidRebateAMT")) / (drSalesBill("ContractRebateThisSalesAMT") + drSalesBill("ContractRebateHistorySalesAMT"))) * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(146, 84, 43, 5), titleFormat)
                'modify code 038:end-------------------------------------------------------------------------
            Case Else '结余合同返点
                e.Graphics.DrawString(Format(drContractExtra("HistorySalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 60, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(drContractExtra("HistoryRebateAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 60, 43, 5), titleFormat)

                e.Graphics.DrawString(Format(drContractExtra("HistoryPaidRebateAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 72, 43, 5), titleFormat)
                e.Graphics.DrawString(Format(drSalesBill("RebateSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 72, 43, 5), titleFormat)

                e.Graphics.DrawString(Format(drContractExtra("HistoryRebateAMT") - drContractExtra("HistoryPaidRebateAMT") - drSalesBill("RebateSalesAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(56, 84, 43, 5), titleFormat)
                'modify code 038:start-------------------------------------------------------------------------
                'e.Graphics.DrawString(Format((drContractExtra("HistoryRebateAMT") / drContractExtra("HistorySalesAMT")) * 100, "#,0.0") & " %", drawFont, drawBrush, New Rectangle(146, 84, 43, 5), titleFormat)
                e.Graphics.DrawString(Format((drContractExtra("HistoryRebateAMT") / drContractExtra("HistorySalesAMT")) * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(146, 84, 43, 5), titleFormat)
                'modify code 038:end-------------------------------------------------------------------------
        End Select

        titleFont = New Font("宋体", 12)
        e.Graphics.DrawString("城市经理（签字）：", titleFont, drawBrush, New Rectangle(10, 98, 45, 10), drawFormat)
        e.Graphics.DrawString("小区经理（签字）：", titleFont, drawBrush, New Rectangle(10, 108, 45, 10), drawFormat)
        e.Graphics.DrawString("（如需要）", titleFont, drawBrush, New Rectangle(10, 114, 45, 10), drawFormat)
        e.Graphics.DrawString("绩效经理（签字）：", titleFont, drawBrush, New Rectangle(10, 124, 45, 10), drawFormat)
        e.Graphics.DrawString("店长（签字）：", titleFont, drawBrush, New Rectangle(100, 98, 45, 10), drawFormat)
        e.Graphics.DrawString("大区经理（签字）：", titleFont, drawBrush, New Rectangle(100, 108, 45, 10), drawFormat)
        e.Graphics.DrawString("（如需要）", titleFont, drawBrush, New Rectangle(100, 114, 45, 10), drawFormat)
        e.Graphics.DrawString("客户（签字）：", titleFont, drawBrush, New Rectangle(100, 124, 45, 10), drawFormat)

        e.HasMorePages = False
    End Sub

    'modify code 004:start-------------------------------------------------------------------------
    Private Sub SetCardCostByCityID(ByVal parmCityID As String)
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        Try
            If parmCityID <> String.Empty Then
                dtCardCostManage = DB.GetDataTable("Select * From CardCostManage Where CityID=" & parmCityID).Copy
                If dtCardCostManage.Rows.Count > 0 Then
                    For Each drCardCost As DataRow In dtCardCostManage.Rows
                        If drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = CARD_TYPE_84 Then
                            dm84CardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            bl84CanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                        ElseIf drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = CARD_TYPE_86 Then
                            dm86CardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            bl86CanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                        ElseIf drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = CARD_TYPE_92 Then
                            dm92CardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            bl92CanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                        ElseIf drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = CARD_TYPE_94 Then
                            dm94CardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            bl94CanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                        ElseIf drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = CARD_TYPE_60 Then
                            dm60CardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            bl60CanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                            'modify code 050:start-------------------------------------------------------------------------
                        ElseIf drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = frmMain.signCardBin Then
                            dmSignCardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            blSignCardCanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                            'modify code 050:start-------------------------------------------------------------------------
                            'modify code 051:start-------------------------------------------------------------------------
                        ElseIf drCardCost("CityID").ToString = sCityID And drCardCost("CardType").ToString = CARD_TYPE_65 Then
                            dm65CardCost = Decimal.Parse(drCardCost("CardCost").ToString)
                            bl65CanChanged = Boolean.Parse(drCardCost("CanChanged").ToString)
                            'modify code 051:start-------------------------------------------------------------------------
                        End If
                    Next
                End If
            End If

            DB.Close()
        Catch ex As Exception
            DB.Close()
        End Try
    End Sub

    Private Function SetCardCost(ByVal sCardNo As String, ByVal sFirstBuy As String, ByVal iRow As Integer, Optional ByVal dmExistCardCost As Decimal = -1) As String
        Dim sCardType As String
        Dim iLevel As Integer
        Dim iSelectedIndex As Integer = 0

        Dim comboBoxCell_CardCost As DataGridViewComboBoxCell
        comboBoxCell_CardCost = Me.dgvNormalCard.Rows(iRow).Cells("CardCost")
        comboBoxCell_CardCost.Items.Clear()

        sCardType = GetCardTypeByCardNo(sCardNo)

        If bNewSalesBillType = 1 Or bNewSalesBillType = 4 Then
            comboBoxCell_CardCost.Items.Add(Format(0, "#,0.00"))
        Else

            If sCardType = "" Then
                comboBoxCell_CardCost.Items.Add(Format(0, "#,0.00"))
            Else
                If sFirstBuy = "充值" Then
                    comboBoxCell_CardCost.Items.Add(Format(0, "#,0.00"))
                ElseIf sFirstBuy = "购卡" Or sFirstBuy = "" Then
                    If bNewSalesBillType = 1 Or bNewSalesBillType = 4 Then
                        comboBoxCell_CardCost.Items.Add(Format(0, "#,0.00"))
                    Else
                        If CARD_TYPE_84 = sCardType Then
                            If bl84CanChanged Then
                                For iLevel = CInt(dm84CardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dm84CardCost, "#,0.00"))
                            End If
                        ElseIf CARD_TYPE_86 = sCardType Then
                            If bl86CanChanged Then
                                For iLevel = CInt(dm86CardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dm86CardCost, "#,0.00"))
                            End If
                        ElseIf CARD_TYPE_92 = sCardType Then
                            If bl92CanChanged Then
                                For iLevel = CInt(dm92CardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dm92CardCost, "#,0.00"))
                            End If
                        ElseIf CARD_TYPE_94 = sCardType Then
                            If bl94CanChanged Then
                                For iLevel = CInt(dm94CardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dm94CardCost, "#,0.00"))
                            End If
                        ElseIf CARD_TYPE_60 = sCardType Then
                            If bl60CanChanged Then
                                For iLevel = CInt(dm60CardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dm60CardCost, "#,0.00"))
                            End If
                            'modify code 050:start-------------------------------------------------------------------------
                        ElseIf frmMain.signCardBin = sCardType Then
                            If blSignCardCanChanged Then
                                For iLevel = CInt(dmSignCardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dmSignCardCost, "#,0.00"))
                            End If
                            'modify code 050:end-------------------------------------------------------------------------
                            'modify code 051:start-------------------------------------------------------------------------
                        ElseIf CARD_TYPE_65 = sCardType Then
                            If bl65CanChanged Then
                                For iLevel = CInt(dm65CardCost) To 0 Step -1
                                    comboBoxCell_CardCost.Items.Add(Format(iLevel, "#,0.00"))
                                Next
                            Else
                                comboBoxCell_CardCost.Items.Add(Format(dm65CardCost, "#,0.00"))
                            End If
                            'modify code 051:end-------------------------------------------------------------------------
                        Else
                            comboBoxCell_CardCost.Items.Add(Format(0, "#,0.00"))
                        End If
                    End If
                Else
                    comboBoxCell_CardCost.Items.Add(Format(0, "#,0.00"))
                End If

            End If
        End If

        If dmExistCardCost <> -1 Then
            comboBoxCell_CardCost.Value = Format(dmExistCardCost, "#,0.00")
            iSelectedIndex = comboBoxCell_CardCost.Items.IndexOf(Format(dmExistCardCost, "#,0.00"))
        End If


        SetCardCost = comboBoxCell_CardCost.Items(iSelectedIndex)

    End Function

    Private Function SetFirstBuy(ByVal sCardNo As String, ByVal iRow As Integer, Optional ByVal sExistFirstBuy As String = "-1") As String
        Dim sCardType As String
        Dim comboBoxCell_FirstBuy As DataGridViewComboBoxCell
        Dim iSelectedIndex As Integer = 0

        comboBoxCell_FirstBuy = Me.dgvNormalCard.Rows(iRow).Cells("FirstBuy")
        comboBoxCell_FirstBuy.Items.Clear()

        sCardType = GetCardTypeByCardNo(sCardNo)

        If bNewSalesBillType = 1 Then
            comboBoxCell_FirstBuy.Items.Add("")
        ElseIf bNewSalesBillType = 7 Then
            comboBoxCell_FirstBuy.Items.Add("")
            comboBoxCell_FirstBuy.Items.Add("购卡")
            comboBoxCell_FirstBuy.Items.Add("充值")
        Else
            If CARD_TYPE_60 = sCardType Then
                comboBoxCell_FirstBuy.Items.Add("购卡")
                comboBoxCell_FirstBuy.Items.Add("充值")
            Else
                comboBoxCell_FirstBuy.Items.Add("")
            End If
        End If

        If sExistFirstBuy <> "-1" Then
            comboBoxCell_FirstBuy.Value = sExistFirstBuy
            iSelectedIndex = comboBoxCell_FirstBuy.Items.IndexOf(sExistFirstBuy)
        End If

        SetFirstBuy = comboBoxCell_FirstBuy.Items(iSelectedIndex)

    End Function

    Private Function GetCardTypeByCardNo(ByVal sCardNo As String) As String
        Dim result As String = ""
        If sCardNo.IndexOf("84") = 0 Then
            Return CARD_TYPE_84
        ElseIf sCardNo.IndexOf("86") = 0 Then
            Return CARD_TYPE_86
        ElseIf sCardNo.IndexOf("92") = 0 Then
            Return CARD_TYPE_92
        ElseIf sCardNo.IndexOf("94") = 0 Then
            Return CARD_TYPE_94
        ElseIf sCardNo.IndexOf("233684") = 0 Then
            Return CARD_TYPE_84
        ElseIf sCardNo.IndexOf("233692") = 0 Then
            Return CARD_TYPE_92
        ElseIf sCardNo.IndexOf("233694") = 0 Then
            Return CARD_TYPE_94
        ElseIf sCardNo.IndexOf("233660") = 0 Then
            Return CARD_TYPE_60
            'modify code 050:start-------------------------------------------------------------------------
        ElseIf sCardNo.IndexOf("2336" & frmMain.signCardBin) = 0 Then
            Return frmMain.signCardBin
            'modify code 050:end-------------------------------------------------------------------------
            'modify code 051:start-------------------------------------------------------------------------
        ElseIf sCardNo.IndexOf("233665") = 0 Then
            Return CARD_TYPE_65
            'modify code 051:end-------------------------------------------------------------------------
        Else
            Return String.Empty
        End If
        Return result
    End Function

    'modify code 008,044:start-------------------------------------------------------------------------
    'Public Sub GetPaymentTermByCityID(ByVal parmCityID As String, ByVal parmPaymentTerm As String)
    Public Sub GetPaymentTermByCityID(ByVal parmCityID As String, Optional ByVal parmPaymentTerm As String = "")
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        Try
            If parmPaymentTerm = "" Then
                If parmCityID <> String.Empty Then
                    dtCityPaymentTerm = DB.GetDataTable("Select a.*,b.PaymentName From CityPaymentTerm a left join CityPaymentTermName b on a.PaymentTerm = b.PaymentTerm Where CityID=" & parmCityID).Copy
                Else
                    dtCityPaymentTerm = DB.GetDataTable("Select a.*,b.PaymentName From CityPaymentTerm a left join CityPaymentTermName b on a.PaymentTerm = b.PaymentTerm Join AreaScope(" & frmMain.sLoginUserID & ") AS S On a.CityID=S.AreaID").Copy
                End If
            Else
                'modify code 040:start-------------------------------------------------------------------------
                If parmCityID <> String.Empty Then
                    'dtCityPaymentTerm = DB.GetDataTable("Select * From CityPaymentTerm Where CityID=" & parmCityID & " and PaymentTerm = " & parmPaymentTerm).Copy
                    'dtCityPaymentTerm = DB.GetDataTable("Select * From CityPaymentTerm Where CityID=" & parmCityID & " and PaymentTerm in (" & parmPaymentTerm & ")").Copy
                    dtCityPaymentTerm = DB.GetDataTable("Select a.*,b.PaymentName From CityPaymentTerm a left join CityPaymentTermName b on a.PaymentTerm = b.PaymentTerm Where CityID=" & parmCityID & " and a.PaymentTerm in (" & parmPaymentTerm & ")").Copy
                Else
                    'dtCityPaymentTerm = DB.GetDataTable("Select * From CityPaymentTerm P Inner Join AreaScope(" & frmMain.sLoginUserID & ") AS S On P.CityID=S.AreaID Where P.PaymentTerm = " & parmPaymentTerm).Copy
                    'dtCityPaymentTerm = DB.GetDataTable("Select * From CityPaymentTerm P Inner Join AreaScope(" & frmMain.sLoginUserID & ") AS S On P.CityID=S.AreaID Where P.PaymentTerm in (" & parmPaymentTerm & ")").Copy
                    dtCityPaymentTerm = DB.GetDataTable("Select a.*,b.PaymentName From CityPaymentTerm a left join CityPaymentTermName b on a.PaymentTerm = b.PaymentTerm Join AreaScope(" & frmMain.sLoginUserID & ") AS S On a.CityID=S.AreaID Where a.PaymentTerm in (" & parmPaymentTerm & ")").Copy
                End If
                'modify code 040:end-------------------------------------------------------------------------
            End If

            DB.Close()
        Catch ex As Exception
            DB.Close()
        End Try
    End Sub
    'modify code 008,044:end-------------------------------------------------------------------------

    'modify code 011:start-------------------------------------------------------------------------
    Private Sub GetBarcodeFaceValue()
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        Try
            dtBarcodeFaceValue = DB.GetDataTable("Select * From BarcodeFaceValue ").Copy

            DB.Close()
        Catch ex As Exception
            DB.Close()
        End Try
    End Sub
    'modify code 011:end-------------------------------------------------------------------------

    'modify code 016:start-------------------------------------------------------------------------
    Private Sub GetBankCardAreaID()
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        Try
            dtBankCardStoreID = DB.GetDataTable("Select B.StoreID From BankCardForEmployee B Inner Join AreaScope(" & frmMain.sLoginUserID & ") AS S On B.StoreID = S.AreaID ").Copy

            DB.Close()
        Catch ex As Exception
            DB.Close()
        End Try
    End Sub
    'modify code 016:end-------------------------------------------------------------------------

    'modify code 040:start-------------------------------------------------------------------------
    'modify code 044:start-------------------------------------------------------------------------
    Private Sub SetInternetBillInfo()
        '增加兑换码的支付方式行,填入提取码和订单金额
        dtPayment.Rows(0).Delete()
        'dtPayment.Rows.Add(2, 8, ecir.ExtractingCodeInfoData.BillTotalAmount, ecir.ExtractingCodeInfoData.ExtractingCode)
        'dtPayment.Rows.Add(2, 8, ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.CardPrice * ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.ProductNum, ecir.ExtractingCodeInfoData.ExtractingCode, IIf(ecir.ExtractingCodeInfoData.BillBuyChannel = "WECHAT", "微信", "支付宝"))
        dtPayment.Rows.Add(1, 8, ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.CardPrice * ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData.ProductNum, ecir.ExtractingCodeInfoData.ExtractingCode, IIf(ecir.ExtractingCodeInfoData.BillBuyChannel.ToUpper = "WECHAT", "微信", "支付宝"))
        'dtPayment.Rows.Add(2, 8, 500, ecir.ExtractingCodeInfoData.ExtractingCode)
        dtPayment.AcceptChanges()
        '设置卡类型
        If ecir.ExtractingCodeInfoData.BillType = "ENTITY" Then 'ENTITY-实体卡，GIFT-礼品卡
            sGiftCardBin = ""
        Else
            sCULCardBin = ""
        End If
    End Sub
    'modify code 044:end-------------------------------------------------------------------------

    Private Sub GetInternetBillInfo()
        Dim dtInternetBillInfo As DataTable = Nothing

        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        Try
            dtInternetBillInfo = DB.GetDataTable("Select * From InternetSales where SalesBillID = " & sSalesBillID).Copy

            If dtInternetBillInfo Is Nothing OrElse dtInternetBillInfo.Rows.Count = 0 Then DB.Close() : Exit Sub

            Dim drInternetBillInfo As DataRow = dtInternetBillInfo.Rows(0)

            ecir = New InternetWebService.ExtractingCodeInfoResponse
            ecir.ExtractingCodeInfoData = New InternetWebService.ExtractingCodeInfoData
            ecir.ExtractingCodeInfoData.ExtractingCodeInfoDetailData = New InternetWebService.ExtractingCodeInfoDetailData

            With ecir.ExtractingCodeInfoData
                .ExtractingCode = drInternetBillInfo("EXTRACTINGCODE")
                .Status = drInternetBillInfo("STATUS")
                .HotReason = drInternetBillInfo("HOTREASON")
                .IssuerId = drInternetBillInfo("ISSUERID")
                .BillNo = drInternetBillInfo("BILLNO")
                .BillTotalAmount = drInternetBillInfo("BILLTOTALAMOUNT")
                .BillPayTotalAmount = drInternetBillInfo("BILLPAYTOTALAMOUNT")
                .BillTotalNum = drInternetBillInfo("BILLTOTALNUM")
                .BillPayStatus = drInternetBillInfo("BILLPAYSTATUS")
                .BillType = drInternetBillInfo("BILLTYPE")
                .BillCreateTimestamp = drInternetBillInfo("BILLCREATETIMESTAMP")
                .BillBuyChannel = drInternetBillInfo("BILLBUYCHANNEL")
                .BuyerMobilePhone = drInternetBillInfo("BUYERMOBILEPHONE")
                .HolderMobilePhone = drInternetBillInfo("HOLDERMOBILEPHONE")
                .CreateTime = drInternetBillInfo("CREATETIME")
                .UpdateTime = drInternetBillInfo("UPDATETIME")
                With .ExtractingCodeInfoDetailData
                    .ProductId = drInternetBillInfo("PRODUCTID")
                    .AreaCode = drInternetBillInfo("AREACODE")
                    .ProductName = drInternetBillInfo("PRODUCTNAME")
                    .Status = drInternetBillInfo("DETAIL_STATUS")
                    .CardPrice = drInternetBillInfo("CARDPRICE")
                    .ProductNum = drInternetBillInfo("PRODUCTNUM")
                    .PayAmount = drInternetBillInfo("PAYAMOUNT")
                End With
            End With

            DB.Close()
        Catch ex As Exception
            DB.Close()
        End Try
    End Sub

    Private Function SetInternetBillStatus() As Boolean
        Dim IWebService As New InternetWebService.Service
        Dim secs As New InternetWebService.SetExtractingCodeStatus
        Dim cm As InternetWebService.CodeMsg

        Try
            guIDClass = New InternetWebService.GuIDClass
            guIDClass.GuID = frmMain.sGuID
            With secs
                .IssuerId = sIssuerId
                .MobilePhone = ecir.ExtractingCodeInfoData.HolderMobilePhone
                .ExtractingCode = ecir.ExtractingCodeInfoData.ExtractingCode
                .Cards = sCards
            End With
            cm = IWebService.SetExtractingCodeStatus(secs, guIDClass)
            If cm.Code = "00" Then  '提取码使用成功
                Return True
            Else
                Return False
            End If
        Catch ex As Exception
            Return False
        End Try
    End Function

    Public Sub GetBillBuyChannelCityID(ByVal parmCityID As String)
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return
        End If

        Try
            If parmCityID <> "" Then
                dtBillBuyChannel = DB.GetDataTable("Select * From City_BillBuyChannel Where CityID=" & parmCityID).Copy
            End If
           
            DB.Close()
        Catch ex As Exception
            DB.Close()
        End Try
    End Sub

    Private Function AutoActivation(ByVal aSaleBillID As String) As Boolean
        Dim dtCard As DataTable = Nothing, dtDetail As DataTable = Nothing, drDetail As DataRow = Nothing
        Dim dtResultMove As DataTable, dtResult As DataTable
        Dim sSQL As String

        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法自动激活销售单。请检查数据库连接。"
            Return False
        End If

        Try
            dtResultMove = DB.GetDataTable("declare @Result nvarchar(1000);Exec MoveNew2PendingSingle " & aSaleBillID & ",@Result output;select @Result as Result;")
            If dtResultMove.Rows(0)("Result").ToString = "OK" Then
                If DB.ModifyTable("Select SalesBillDetailID,CardNo,FaceValue Into #tempCard From PendingActivationList Where 1=2") = -1 Then
                    frmMain.statusText.Text = "自动激活失败！"
                    DB.Close()
                    Return False
                Else
                    dtCard = DB.GetDataTable("select A.SalesBillDetailID,A.CardNo,A.FaceValue from PendingSalesBillDetails D join PendingActivationList A on D.SalesBillDetailID = A.SalesBillDetailID where D.SalesBillID = " & aSaleBillID & " order by SalesBillDetailID,CardNo")
                    dtDetail = DB.GetDataTable("select * from PendingSalesBillDetails where SalesBillID = " & aSaleBillID & " order by SalesBillDetailID ")

                    If DB.ModifyTable("Delete From #tempCard") = -1 OrElse DB.BulkCopyTable("#tempCard", dtCard) = -1 Then
                        frmMain.statusText.Text = "自动激活失败！"
                        DB.Close()
                        Return False
                    End If

                    For Each drCard As DataRow In dtCard.Rows
                        sCards = sCards & "-" & drCard("CardNo").ToString
                    Next
                    sCards = sCards.Substring(1)

                    Dim iSucessfully As Integer = 0
                    For iCount As Integer = 0 To dtDetail.Rows.Count - 1
                        drDetail = dtDetail.Rows(iCount)
                        'sSQL = "Exec ActivateCard @SalesBillDetailID=" & drDetail("SalesBillDetailID") & ",@SalesBillID=" & aSaleBillID & ",@OldRowSelectedAMT=0,@PendingAMT=" & drDetail("CardQTY") * drDetail("FaceValue") & ","

                        'modify code 068,072:start-------------------------------------------------------------------------
                        If bNewSalesBillType = 7 Or bNewSalesBillType = 8 Or bNewSalesBillType = 9 Then
                            sSQL = "Exec ActivateCard_29509 @SalesBillDetailID=" & drDetail("SalesBillDetailID") & ",@SalesBillID=" & aSaleBillID & ",@OldRowSelectedAMT=0,@PendingAMT=" & drDetail("CardQTY") * drDetail("FaceValue") & ","
                        Else
                            sSQL = "Exec ActivateCard @SalesBillDetailID=" & drDetail("SalesBillDetailID") & ",@SalesBillID=" & aSaleBillID & ",@OldRowSelectedAMT=0,@PendingAMT=" & drDetail("CardQTY") * drDetail("FaceValue") & ","
                        End If
                        'modify code 068,072:end-------------------------------------------------------------------------

                        sSQL = sSQL & "@OldPaymentTerm=" & drDetail("PaymentTerm").ToString & ","
                        If drDetail("PaymentDescription").ToString <> "" Then sSQL = sSQL & "@OldPaymentDescription='" & drDetail("PaymentDescription").ToString & "',"
                        If drDetail("MediaNo").ToString <> "" Then sSQL = sSQL & "@OldMediaNo='" & drDetail("MediaNo").ToString.Replace("'", "''") & "',"
                        If drDetail("PayerName").ToString <> "" Then sSQL = sSQL & "@OldPayerName='" & drDetail("PayerName").ToString.Replace("'", "''") & "',"
                        sSQL = sSQL & "@OperatorName='" & frmMain.sLoginUserRealName.Replace("'", "''") & "',@SSID=" & frmMain.sSSID
                        dtResult = DB.GetDataTable(sSQL)
                        If dtResult Is Nothing Then
                            Continue For
                        ElseIf dtResult.Rows(0)("Result").ToString = "OK" Then
                            iSucessfully += 1
                        End If
                    Next

                    If iSucessfully = 0 Then
                        frmMain.statusText.Text = "自动激活失败！"
                        DB.Close()
                        Return False
                    ElseIf iSucessfully <> dtDetail.Rows.Count Then
                        frmMain.statusText.Text = "自动激活部分成功！"
                    Else
                        frmMain.statusText.Text = "自动激活成功！"
                    End If
                End If
            Else
                frmMain.statusText.Text = "自动激活失败！"
                DB.Close()
                Return False
            End If

            DB.Close()
            Return True
        Catch ex As Exception
            DB.Close()
            Return False
        End Try
    End Function
    'modify code 040:end-------------------------------------------------------------------------

    'modify code 044:start-------------------------------------------------------------------------
    Private Sub SetInternetRuiTaiInfo()
        '增加瑞泰的支付方式行,填入电子券密码和电子券金额
        dtPayment.Rows(0).Delete()
        dtPayment.Rows.Add(1, 11, cir.CodeAmount / 100, cir.CodePassword, "瑞泰")
        'dtPayment.Rows.Add(2, 0, 0)
        dtPayment.AcceptChanges()
    End Sub

    Private Function SetInternetRuiTaiStatus() As String
        Dim IWebService As New InternetRuiTaiWebService.Service
        Dim sci As New InternetRuiTaiWebService.SetCodeInfo
        Dim scir As InternetRuiTaiWebService.SetCodeInfoResponse

        Try
            guIDClass_Ruitai = New InternetRuiTaiWebService.GuIDClass
            guIDClass_Ruitai.GuID = frmMain.sGuID
            With sci
                .OperType = "1"
                .CodePassword = cir.CodePassword
                .ConfirmAmount = cir.CodeAmount
                .SerialNo = strSerialNo

                .ShopId = frmMain.sShopId
                .Account = frmMain.sShopAccount
                .Passwd = frmMain.sShopPassword
                .Key = frmMain.sShopKey
            End With
            scir = IWebService.SetCode(sci, guIDClass_Ruitai)
            If scir.CodeMsg.Code = "0" Then  '使用成功
                Return scir.DealId
            Else
                Return ""
            End If
        Catch ex As Exception
            MessageBox.Show(ex.Message, "向瑞泰确认消费失败", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Return ""
        End Try
    End Function

    Public Function SaveInternetRuiTai(ByVal parmDealId As String, ByVal parmSalesBillID As String) As Boolean
        Dim DB As New DataBase
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
            Me.Close() : Return False
        End If

        Try
            If parmDealId = "" Or parmSalesBillID = "" Then
                DB.Close()
                Return False
            End If

            DB.ModifyTable("insert into InternetSales_RuiTai (CodePassword,ConfirmAmount,DealId,SalesBillID) " _
                          & "values('" & cir.CodePassword & "','" & cir.CodeAmount & "','" & parmDealId & "','" & parmSalesBillID & "')")

            DB.Close()
            Return True
        Catch ex As Exception
            DB.Close()
            Return False
        End Try
    End Function
    'modify code 044:end-------------------------------------------------------------------------

    'modify code 046:start-------------------------------------------------------------------------
    '身份证号验证函数
    Public Function CheckCredentialsNo(ByVal aCredentialsNo As String) As Boolean
        aCredentialsNo = aCredentialsNo.Trim()
        If aCredentialsNo <> "" Then
            If aCredentialsNo.Length <> 18 Then
                Return False
            ElseIf (Not IsNumeric(aCredentialsNo.Substring(0, 17))) OrElse (Not IsDate(aCredentialsNo.Substring(6, 8).Insert(4, "/").Insert(7, "/"))) OrElse aCredentialsNo <> CustomerIDNo.GetFullIDNo(aCredentialsNo.Substring(0, 17)) Then
                Return False
            End If
        End If
        Return True
    End Function
    'modify code 046:end-------------------------------------------------------------------------

    'modify code 046:start-------------------------------------------------------------------------
    '实名制卡销售单内实名制卡状态变更
    Public Sub updateSignCardType(ByVal cardType As String, ByVal operationDes As String)
        If bNewSalesBillType = 7 Then
            Dim sqlwhere As String = ""
            'modify code 050:start-------------------------------------------------------------------------
            Dim strsql As String = ""
            'modify code 050:end-------------------------------------------------------------------------
            'modify code 063:start-------------------------------------------------------------------------
            Dim strfilter As String = "", sqlfilter As String
            'modify code 063:end-------------------------------------------------------------------------

            Dim DB As New DataBase
            DB.Open()
            If Not DB.IsConnected Then
                frmMain.statusText.Text = "系统因连接不到数据库而无法" & IIf(sSalesBillID = "-1", "创建", "打开") & "销售单。请检查数据库连接。"
                Me.Close() : Return
            End If

            For Each drNormal As DataRow In dtNormalCard.Select("Isnull(StartCardNo,'')<>''", "RowID")
                If drNormal("FirstBuy").ToString = "购卡" Then
                    Dim sCardNo As String = drNormal("StartCardNo").ToString
                    sCardNo = sCardNo.Substring(0, 18)
                    Dim iRowCardQTY As Integer = drNormal("CardQTY") - 1
                    For iCard As Integer = 0 To iRowCardQTY
                        '更改实名卡状态
                        If sqlwhere <> "" Then
                            sqlwhere = sqlwhere & " or "
                        End If
                        sqlwhere = sqlwhere & "CardNo = " & ShoppingCardNo.GetFullCardNo((CLng(sCardNo) + iCard).ToString)
                    Next
                End If

                'modify code 063:start-------------------------------------------------------------------------
                Dim sCardNo2 As String = drNormal("StartCardNo").ToString
                sCardNo2 = sCardNo2.Substring(0, 18)
                Dim iRowCardQTY2 As Integer = drNormal("CardQTY") - 1
                For iCard2 As Integer = 0 To iRowCardQTY2
                    If strfilter = "" Then
                        strfilter = "'" & ShoppingCardNo.GetFullCardNo((CLng(sCardNo2) + iCard2).ToString) & "'"
                    Else
                        strfilter = strfilter + ",'" & ShoppingCardNo.GetFullCardNo((CLng(sCardNo2) + iCard2).ToString) & "'"
                    End If
                Next
                'modify code 063:end-------------------------------------------------------------------------
            Next

            'modify code 063:start-------------------------------------------------------------------------
            If strfilter = "" Then
                sqlfilter = " and CardNo is null"
            Else
                sqlfilter = " and CardNo in (" & strfilter & ")"
            End If

            If operationDes = "撤销取消" Then
                If sqlfilter <> "" Then
                    DB.ModifyTable("update SignCardListCount set CardCount = CardCount + 1 where 1=1" & sqlfilter & "")
                End If
            End If
            'modify code 063:end-------------------------------------------------------------------------

            '实名制卡临时表保存失败
            'modify code 050:start-------------------------------------------------------------------------
            If sqlwhere = "" Then sqlwhere = "1=2"
            If operationDes = "确认取消" Then
                strsql = "Delete from SignCardListNew where " & sqlwhere
            Else
                strsql = "Update SignCardListNew set CardType = '" & cardType & "', OperationDes = '" & operationDes & "' where " & sqlwhere
            End If
            'modify code 063:start-------------------------------------------------------------------------
            If sqlfilter <> "" Then
                strsql = "Update SignCardListNew set CardType = '" & cardType & "', OperationDes = '" & operationDes & "' where CardNo in (select distinct CardNo from SignCardListCount where CardCount = 1" & sqlfilter & ")"
            End If
            'modify code 063:end-------------------------------------------------------------------------
            'If DB.ModifyTable("Update SignCardListNew set CardType = '" & cardType & "', OperationDes = '" & operationDes & "' where " & sqlwhere) = -1 Then
            If strsql <> "" Then
                If DB.ModifyTable(strsql) = -1 Then
                    'modify code 050:end-------------------------------------------------------------------------
                    frmMain.statusText.Text = cardType & "失败！"
                    DB.Close() : Me.Cursor = Cursors.Default
                    Me.Activate() : Return
                End If
            End If

            'modify code 063:start-------------------------------------------------------------------------
            If operationDes = "申请取消" Then
                If sqlfilter <> "" Then
                    DB.ModifyTable("update SignCardListCount set CardCount = CardCount - 1 where 1=1" & sqlfilter & "")
                End If
            End If
            'modify code 063:end-------------------------------------------------------------------------

        End If
    End Sub
    'modify code 046:end-------------------------------------------------------------------------

    'modify code 046:start-------------------------------------------------------------------------
    '获取实名卡信息
    Public Function getSignCardList(ByVal cardNo As String) As DataTable
        Dim DB As New DataBase
        Dim dtSignCard As DataTable
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法取得实名卡信息。请检查数据库连接。"
            dtSignCard = New DataTable
            Me.Close() : Return dtSignCard
        End If

        dtSignCard = DB.GetDataTable("Select * From SignCardList Where CardNo='" & cardNo & "' and CardType = '实名制卡'").Copy
        DB.Close()
        Return dtSignCard
    End Function

    Public Function getSignCardListByRange(ByVal sStartCardNo As String, ByVal sEndCardNo As String) As DataTable
        Dim DB As New DataBase
        Dim dtSignCard As DataTable
        Dim cardNo1 As String
        Dim cardNo2 As String

        If sStartCardNo.Trim = "" Then
            cardNo1 = "0"
        Else
            cardNo1 = (CLng(sStartCardNo) - 10).ToString
        End If

        If sEndCardNo.Trim = "" Then
            cardNo2 = "0"
        Else
            cardNo2 = (CLng(sEndCardNo) + 10).ToString
        End If
        'cardNo1 = (CLng(sStartCardNo) - 10).ToString
        'cardNo2 = (CLng(sEndCardNo) + 10).ToString
        DB.Open()
        If Not DB.IsConnected Then
            frmMain.statusText.Text = "系统因连接不到数据库而无法取得实名卡信息。请检查数据库连接。"
            dtSignCard = New DataTable
            Me.Close() : Return dtSignCard
        End If

        dtSignCard = DB.GetDataTable("Select * From SignCardList Where CardNo between '" & cardNo1 & "' and '" & cardNo2 & "' and CardType = '实名制卡'").Copy
        DB.Close()
        Return dtSignCard
    End Function
    'modify code 046:end-------------------------------------------------------------------------

    'modify code 046:start-------------------------------------------------------------------------
    '设定卡成本列
    Public Sub resetCardCostColumn(ByVal isComboBox As Boolean)
        'With Me.dgvNormalCard
        '    Dim newColumn As New DataGridViewTextBoxColumn
        '    With newColumn
        '        .HeaderText = "卡费/张"
        '        .Width = 80
        '        .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
        '        .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
        '        .SortMode = DataGridViewColumnSortMode.NotSortable
        '        .Resizable = DataGridViewTriState.False
        '        .ReadOnly = True
        '        .Name = "CardCost"
        '    End With
        '    .Columns.RemoveAt(9)
        '    .Columns.Insert(9, newColumn)
        'End With

        With Me.dgvNormalCard
            If isComboBox Then
                Dim newColumn As New DataGridViewComboBoxColumn
                With newColumn
                    .DataPropertyName = "CardCost"
                    .ValueMember = "CardCost"
                    .DisplayMember = "CardCost"
                    .DisplayStyle = DataGridViewComboBoxDisplayStyle.Nothing
                    .DefaultCellStyle.Padding = New Padding(0, 1, 0, 0)
                End With
                .Columns.RemoveAt(9)
                .Columns.Insert(9, newColumn)
                With .Columns(9)
                    .HeaderText = "卡费/张"
                    .Width = 80
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                    .Name = "CardCost"
                End With
            Else
                Dim newColumn As New DataGridViewTextBoxColumn
                With newColumn
                    .HeaderText = "卡费/张"
                    .Width = 80
                    .DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    .AutoSizeMode = DataGridViewAutoSizeColumnMode.None
                    .SortMode = DataGridViewColumnSortMode.NotSortable
                    .Resizable = DataGridViewTriState.False
                    .ReadOnly = True
                    .Name = "CardCost"
                End With
                .Columns.RemoveAt(9)
                .Columns.Insert(9, newColumn)
            End If
        End With
    End Sub
    'modify code 046:end-------------------------------------------------------------------------

    'modify code 059:start-------------------------------------------------------------------------
    Private Sub Ticket_PrintPage_A4_Zero(ByVal sender As System.Object, ByVal e As System.Drawing.Printing.PrintPageEventArgs)
        e.Graphics.PageUnit = GraphicsUnit.Millimeter

        Dim titleFont As New Font("宋体", 16), drawFont As New Font("宋体", 10), footFont As New Font("宋体", 9, FontStyle.Italic), blackPen As New Pen(Color.Black, 0.2), drawBrush As New SolidBrush(Color.Black)
        Dim titleFormat As New StringFormat, rightFormat As New StringFormat, drawFormat As New StringFormat
        titleFormat.Alignment = StringAlignment.Center
        rightFormat.Alignment = StringAlignment.Far
        drawFormat.Alignment = StringAlignment.Near
        drawFormat.FormatFlags = StringFormatFlags.NoWrap

        Dim sPrintingText As String
        Select Case drSalesBill("SalesBillType")
            Case 0
                sPrintingText = "家乐福购物卡购买凭证"
            Case 1
                sPrintingText = "家乐福购物卡退货充值凭证"
            Case 2
                sPrintingText = "家乐福市场活动卡凭证"
            Case 3
                sPrintingText = "家乐福公关卡购买凭证"
            Case 4
                sPrintingText = "家乐福员工卡购买凭证"
            Case 6
                sPrintingText = "家乐福线下提卡凭证"
            Case 7
                sPrintingText = "家乐福实名制卡凭证"
            Case 8
                sPrintingText = "家乐福通卖非实名卡凭证"
            Case 9
                sPrintingText = "家乐福电子卡凭证"
            Case Else
                sPrintingText = "家乐福卡联名卡购买凭证"
        End Select
        If My.Settings.IsInTraining Then sPrintingText = sPrintingText & "（培训使用，非有效凭证）"
        e.Graphics.DrawString(sPrintingText, titleFont, drawBrush, New Rectangle(10, 10, 180, 20), titleFormat)

        If drSalesBill("TicketPrintedTimes") > 0 Then
            e.Graphics.DrawRectangle(blackPen, New Rectangle(174, 12, 16, 3))
            e.Graphics.DrawString("第" & (drSalesBill("TicketPrintedTimes") + 1).ToString & "次打印", footFont, drawBrush, 174, 12)
        End If

        sPrintingText = "公司名称："
        Select Case drSalesBill("SalesBillType")
            Case 0, 6, 7, 8, 9 '一般销售单、线下提卡销售单、实名制卡销售单
                If drSalesBill("CustomerType") = 0 Then
                    sPrintingText = sPrintingText & "（个人客户）"
                Else
                    sPrintingText = sPrintingText & Me.txbCustomerName.Text
                    If drSalesBill("RebateMode") = 2 Then sPrintingText = sPrintingText & "（合同客户）"
                    If Me.txbCompanyCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
                End If
            Case 1 '退货销售单
                sPrintingText = sPrintingText & "（退货客户）"
            Case 2, 3 '活动卡销售单、公关卡销售单
                sPrintingText = sPrintingText & Me.txbCustomerName.Text & "（家乐福自购）  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
            Case 4 '员工销售单
                sPrintingText = sPrintingText & "（家乐福内部员工：" & Me.txbEmployeeNo.Text & "）"
            Case Else
                sPrintingText = sPrintingText & "（个人客户）"
        End Select
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(10, 18, 180, 10), drawFormat)
        sPrintingText = "客户姓名："
        If drSalesBill("SalesBillType") = 4 Then
            sPrintingText = sPrintingText & Me.txbEmployeeName.Text
            If Me.txbEmployeeTel.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbEmployeeTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbEmployeeIDNo.Text & "（" & Me.txbEmployeeIDType.Text & "）"
        ElseIf drSalesBill("SalesBillType") = 5 Then
            sPrintingText = sPrintingText & Me.txbMemberName.Text
            sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbMemberTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbMemberIDNo.Text & "（居民身份证）"
        ElseIf Me.txbBuyerName.Text <> "" Then
            sPrintingText = sPrintingText & Me.txbBuyerName.Text
            If Me.txbTelMP.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbTelMP.Text)
            If Me.txbBuyerCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbBuyerCredentialsNo.Text & "（" & Me.txbBuyerCredentialsType.Text & "）"
        End If
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(10, 23, 180, 10), drawFormat)

        e.Graphics.DrawString("销售单号：" & Me.lblSalesBillCode.Text, drawFont, drawBrush, New Rectangle(143, 18, 60, 10), drawFormat)
        e.Graphics.DrawString("建单时间：" & Me.lblCreatedTime.Text.Substring(0, 16), drawFont, drawBrush, New Rectangle(143, 23, 60, 10), drawFormat)

        e.Graphics.DrawLine(blackPen, 10, 28, 190, 28)

        Dim newRowHeight As Integer
        If drSalesBill("SalesBillType") = 2 Then
            newRowHeight = 6
            e.Graphics.DrawString("以下列表是购买商品抵用券信息", drawFont, drawBrush, New Rectangle(10, 30, 100, newRowHeight), drawFormat)
        Else
            newRowHeight = 0
        End If
        '以下行的top位置参数 +newRowHeight

        '每页可容纳50行->iPrintRows
        'modify code 060:start-------------------------------------------------------------------------
        'Dim iRow As Integer, iStartRow As Int16 = (iTicketPageNum - 1) * 50, iEndRow As Int16 = iStartRow + 49
        Dim iRow As Integer, iStartRow As Int16 = (iTicketPageNum - 1) * iPrintRows, iEndRow As Int16 = iStartRow + iPrintRows - 1
        'modify code 060:end-------------------------------------------------------------------------
        If iEndRow > dtCardListInTicket.Rows.Count - 1 Then iEndRow = dtCardListInTicket.Rows.Count - 1

        If iEndRow >= iStartRow Then
            e.Graphics.DrawString("行号", drawFont, drawBrush, New Rectangle(10, 30 + newRowHeight, 10, 10), drawFormat)
            e.Graphics.DrawString("开始卡号", drawFont, drawBrush, New Rectangle(20, 30 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("结束卡号", drawFont, drawBrush, New Rectangle(58, 30 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("数量", drawFont, drawBrush, New Rectangle(96, 30 + newRowHeight, 12, 10), rightFormat)
            e.Graphics.DrawString("面值", drawFont, drawBrush, New Rectangle(108, 30 + newRowHeight, 20, 10), rightFormat)
            e.Graphics.DrawString("卡费/张", drawFont, drawBrush, New Rectangle(128, 30 + newRowHeight, 18, 10), rightFormat)
            e.Graphics.DrawString("充值总计", drawFont, drawBrush, New Rectangle(146, 30 + newRowHeight, 22, 10), rightFormat)
            e.Graphics.DrawString("应付总计", drawFont, drawBrush, New Rectangle(168, 30 + newRowHeight, 22, 10), rightFormat)
        End If

        For iRow = iStartRow To iEndRow
            'modify code 060:start-------------------------------------------------------------------------
            If dtCardListInTicket.Rows(iRow)("RowID").ToString = "" Then
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(10, 36 + newRowHeight + (iRow Mod 50) * 5, 80, 10), drawFormat) '打印"以下列表是营销卡"
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(10, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 80, 10), drawFormat) '打印"以下列表是营销卡"
            Else
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("RowID").ToString, drawFont, drawBrush, New Rectangle(9, 36 + newRowHeight + (iRow Mod 50) * 5, 10, 10), titleFormat)
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(20, 36 + newRowHeight + (iRow Mod 50) * 5, 38, 10), drawFormat)
                'e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("EndCardNo").ToString, drawFont, drawBrush, New Rectangle(58, 36 + newRowHeight + (iRow Mod 50) * 5, 38, 10), drawFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("CardQTY"), "#,0"), drawFont, drawBrush, New Rectangle(96, 36 + newRowHeight + (iRow Mod 50) * 5, 12, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("FaceValue"), "#,0.00"), drawFont, drawBrush, New Rectangle(108, 36 + newRowHeight + (iRow Mod 50) * 5, 20, 10), rightFormat)
                'e.Graphics.DrawString(Format(CDec(dtCardListInTicket.Rows(iRow)("CardCost")), "#,0.00"), drawFont, drawBrush, New Rectangle(128, 36 + newRowHeight + (iRow Mod 50) * 5, 18, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 36 + newRowHeight + (iRow Mod 50) * 5, 22, 10), rightFormat)
                'e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(168, 36 + newRowHeight + (iRow Mod 50) * 5, 22, 10), rightFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("RowID").ToString, drawFont, drawBrush, New Rectangle(9, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 10, 10), titleFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(20, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("EndCardNo").ToString, drawFont, drawBrush, New Rectangle(58, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("CardQTY"), "#,0"), drawFont, drawBrush, New Rectangle(96, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 12, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("FaceValue"), "#,0.00"), drawFont, drawBrush, New Rectangle(108, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 20, 10), rightFormat)
                e.Graphics.DrawString(Format(CDec(dtCardListInTicket.Rows(iRow)("CardCost")), "#,0.00"), drawFont, drawBrush, New Rectangle(128, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 18, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(146, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 22, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(168, 36 + newRowHeight + (iRow Mod iPrintRows) * 5, 22, 10), rightFormat)
            End If
            'modify code 060:end-------------------------------------------------------------------------
        Next

        Dim blIsLastPage As Boolean, iCurrentPageNum As Int16 = iTicketPageNum
        If iTicketPageCount > 1 Then
            If iTicketPageNum < iTicketPageCount Then
                blIsLastPage = False
                e.HasMorePages = True
            Else
                blIsLastPage = True
                e.HasMorePages = False
            End If
            iTicketPageNum = iTicketPageNum + 1
        Else
            blIsLastPage = True
            e.HasMorePages = False
        End If

        'modify code 060:start-------------------------------------------------------------------------
        '卡行以下的信息都下移iAdjust
        If blIsLastPage Then
            Dim bDistance As Byte = 5, iTop As Integer = 238 + iAdjust + newRowHeight, iWidth As Integer = 90
            If drSalesBill("CardCost") > 0 OrElse dtPayment.DefaultView.ToTable(True, "PaymentTerm").Rows.Count = 5 Then bDistance = 4
            'modify code 059,061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 50 '如果属非现金的付款方式，需打印转出/转入账户信息
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 50 '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 50 '如果属非现金的付款方式，需打印转出/转入账户信息
            'modify code 059,061:end-------------------------------------------------------------------------

            e.Graphics.DrawLine(blackPen, 10, 236 + iAdjust + newRowHeight, 190, 236 + iAdjust + newRowHeight)

            e.Graphics.DrawString("卡片数量：" & Me.txbCardQTY.Text & " 张", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            e.Graphics.DrawString("充值金额：" & Me.txbChargedAMT.Text & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            If drSalesBill("RebateSalesAMT") = 0 Then
                e.Graphics.DrawString("折扣金额：0.00 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("折扣比例：0.00 %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            ElseIf drSalesBill("RebateCardQTY") = 0 Then
                e.Graphics.DrawString("抵扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("抵扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            Else
                e.Graphics.DrawString("折扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("折扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            End If
            iTop += bDistance
            e.Graphics.DrawString("实收金额：" & Me.txbPaymentAMT.Text & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            If drSalesBill("CardCost") > 0 Then
                iTop += bDistance
                e.Graphics.DrawString("卡费：" & Format(drSalesBill("CardCost"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(10, iTop, iWidth, 10), drawFormat)
            End If

            iTop = 238 + iAdjust + newRowHeight

            e.Graphics.DrawString("付款方式：", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
            If drSalesBill("SalesBillType") = 1 Then
                iTop += bDistance
                e.Graphics.DrawString("（退货单无须付款）", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                'modify code 059:start-------------------------------------------------------------------------
                'ElseIf drSalesBill("PayableAMT") = 0 Then
                '    iTop += bDistance
                '    e.Graphics.DrawString("（返点单无须付款）", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                'modify code 059:end-------------------------------------------------------------------------
            Else
                'modify code 059:start-------------------------------------------------------------------------
                'Dim dmTermAMT As Decimal = 0, sText As String = ""
                Dim dmTermAMT As Decimal = -1, sText As String = ""
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=0")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    现金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=1")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  银行卡 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=2 Or PaymentTerm=5")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    转账 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=3 Or PaymentTerm=4 Or PaymentTerm=6")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    支票 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=4")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  保证金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=7")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("积分兑换 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=8")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=11")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 059:end-------------------------------------------------------------------------
            End If

            'modify code 059,061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
                'modify code 059,061:end-------------------------------------------------------------------------
                iTop = 238 + iAdjust + newRowHeight
                e.Graphics.DrawString("转出/转入账户信息：", drawFont, drawBrush, New Rectangle(100, iTop, 80, 10), drawFormat)
                sPrintingText = ""
                Dim dvTemp As DataView = dtPayment.Copy.DefaultView, dtTemp As DataTable
                dvTemp.Sort = "RowID"
                dvTemp.RowFilter = "PaymentTerm>0"
                dtTemp = dvTemp.ToTable(True, "PayerName")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("PayerName").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 57 Then bDistance = 4
                iTop += bDistance
                e.Graphics.DrawString("转出账户名称：", drawFont, drawBrush, New Rectangle(100, iTop, 80, 20), drawFormat)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(124, iTop, 57, 20), New StringFormat) '使用默认的StringFormat以允许换行
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 57 Then iTop += bDistance
                iTop += bDistance
                sPrintingText = "转出账户账号："
                dtTemp = dvTemp.ToTable(True, "MediaNo")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("MediaNo").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(100, iTop, 81, 10), drawFormat)
                dvTemp.Dispose() : dvTemp = Nothing : dtTemp.Dispose() : dtTemp = Nothing
                iTop += bDistance
                If drInternalPayer Is Nothing Then drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
                e.Graphics.DrawString("转入账户名称：" & drInternalPayer("PayeeName").ToString, drawFont, drawBrush, New Rectangle(100, iTop, 81, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("转入账户账号：" & drInternalPayer("ReceiverAccountNo").ToString, drawFont, drawBrush, New Rectangle(100, iTop, 81, 10), drawFormat)
            End If

            e.Graphics.DrawString("本人已认真阅读家乐福福卡公告及章程，知晓并同意其中所有条款。", drawFont, drawBrush, New Rectangle(11, 265 + iAdjust + newRowHeight, 120, 10), drawFormat)
            If drSalesBill("SalesBillType") = 5 Then '联名卡销售单
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = "新/旧" Else sPrintingText = ""
                sPrintingText = sPrintingText & "积分卡号：" & Me.txbNewMemberCardNo.Text
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = sPrintingText & "/" & Me.txbOldMemberCardNo.Text
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(11, 271 + iAdjust + newRowHeight, 120, 10), drawFormat)
            End If
            e.Graphics.DrawString("客户签名：", drawFont, drawBrush, New Rectangle(117, 271 + iAdjust + newRowHeight, 20, 10), drawFormat) '-6
            e.Graphics.DrawString("销售签名：", drawFont, drawBrush, New Rectangle(155, 271 + iAdjust + newRowHeight, 20, 10), drawFormat) '-6
        Else
            e.Graphics.DrawLine(blackPen, 10, 276 + iAdjust + newRowHeight, 190, 276 + newRowHeight)
        End If

        If Me.lblCreatorName.Text = frmMain.sLoginUserRealName Then
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(10, 278 + iAdjust + newRowHeight, 190, 10), drawFormat)
        Else
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印：" & frmMain.sLoginUserRealName & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(10, 278 + iAdjust + newRowHeight, 180, 10), drawFormat)
        End If

        e.Graphics.DrawString("(第" & iCurrentPageNum & "页,共" & iTicketPageCount & "页)", footFont, drawBrush, New Rectangle(10, 278 + iAdjust + newRowHeight, 180, 10), rightFormat)
        'modify code 060:end-------------------------------------------------------------------------
    End Sub

    Private Sub Ticket_PrintPage_MultiPaper_Zero(ByVal sender As System.Object, ByVal e As System.Drawing.Printing.PrintPageEventArgs)
        e.Graphics.PageUnit = GraphicsUnit.Millimeter

        Dim titleFont As New Font("宋体", 16), drawFont As New Font("宋体", 10), footFont As New Font("宋体", 9, FontStyle.Italic), blackPen As New Pen(Color.Black, 0.2), drawBrush As New SolidBrush(Color.Black)
        Dim titleFormat As New StringFormat, rightFormat As New StringFormat, drawFormat As New StringFormat
        titleFormat.Alignment = StringAlignment.Center
        rightFormat.Alignment = StringAlignment.Far
        drawFormat.Alignment = StringAlignment.Near
        drawFormat.FormatFlags = StringFormatFlags.NoWrap

        Dim sPrintingText As String
        Select Case drSalesBill("SalesBillType")
            Case 0
                sPrintingText = "家乐福购物卡购买凭证"
            Case 1
                sPrintingText = "家乐福购物卡退货充值凭证"
            Case 2
                sPrintingText = "家乐福市场活动卡凭证"
            Case 3
                sPrintingText = "家乐福公关卡购买凭证"
            Case 4
                sPrintingText = "家乐福员工卡购买凭证"
            Case 6
                sPrintingText = "家乐福线下提卡凭证"
            Case 7
                sPrintingText = "家乐福实名制卡凭证"
            Case 8
                sPrintingText = "家乐福通卖非实名卡凭证"
            Case 9
                sPrintingText = "家乐福电子卡凭证"
            Case Else
                sPrintingText = "家乐福卡联名卡购买凭证"
        End Select
        If My.Settings.IsInTraining Then sPrintingText = sPrintingText & "（培训使用，非有效凭证）"
        e.Graphics.DrawString(sPrintingText, titleFont, drawBrush, New Rectangle(0, 0, 200, 20), titleFormat)

        If drSalesBill("TicketPrintedTimes") > 0 Then
            e.Graphics.DrawRectangle(blackPen, New Rectangle(184, 2, 16, 3))
            e.Graphics.DrawString("第" & (drSalesBill("TicketPrintedTimes") + 1).ToString & "次打印", footFont, drawBrush, 184, 2)
        End If

        sPrintingText = "公司名称："
        Select Case drSalesBill("SalesBillType")
            Case 0, 6, 7, 8, 9 '一般销售单、线下提卡销售单、实名制卡销售单
                If drSalesBill("CustomerType") = 0 Then
                    sPrintingText = sPrintingText & "（个人客户）"
                Else
                    sPrintingText = sPrintingText & Me.txbCustomerName.Text
                    If drSalesBill("RebateMode") = 2 Then sPrintingText = sPrintingText & "（合同客户）"
                    If Me.txbCompanyCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
                End If
            Case 1 '退货销售单
                sPrintingText = sPrintingText & "（退货客户）"
            Case 2, 3 '活动卡销售单、公关卡销售单
                sPrintingText = sPrintingText & Me.txbCustomerName.Text & "（家乐福自购）  证件：" & Me.txbCompanyCredentialsNo.Text & "（" & Me.txbCompanyCredentialsType.Text & "）"
            Case 4 '员工销售单
                sPrintingText = sPrintingText & "（家乐福内部员工：" & Me.txbEmployeeNo.Text & "）"
            Case Else
                sPrintingText = sPrintingText & "（个人客户）"
        End Select
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(0, 8, 200, 10), drawFormat)
        sPrintingText = "客户姓名："
        If drSalesBill("SalesBillType") = 4 Then
            sPrintingText = sPrintingText & Me.txbEmployeeName.Text
            If Me.txbEmployeeTel.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbEmployeeTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbEmployeeIDNo.Text & "（" & Me.txbEmployeeIDType.Text & "）"
        ElseIf drSalesBill("SalesBillType") = 5 Then
            sPrintingText = sPrintingText & Me.txbMemberName.Text
            sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbMemberTel.Text)
            sPrintingText = sPrintingText & "  证件：" & Me.txbMemberIDNo.Text & "（居民身份证）"
        ElseIf Me.txbBuyerName.Text <> "" Then
            sPrintingText = sPrintingText & Me.txbBuyerName.Text
            If Me.txbTelMP.Text <> "" Then sPrintingText = sPrintingText & "  电话：" & Me.MaskTelMP(Me.txbTelMP.Text)
            If Me.txbBuyerCredentialsNo.Visible AndAlso Me.txbBuyerCredentialsNo.Text <> "" Then sPrintingText = sPrintingText & "  证件：" & Me.txbBuyerCredentialsNo.Text & "（" & Me.txbBuyerCredentialsType.Text & "）"
        End If
        e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(0, 13, 200, 10), drawFormat)

        e.Graphics.DrawString("销售单号：" & Me.lblSalesBillCode.Text, drawFont, drawBrush, New Rectangle(152, 8, 60, 10), drawFormat)
        e.Graphics.DrawString("建单时间：" & Me.lblCreatedTime.Text.Substring(0, 16), drawFont, drawBrush, New Rectangle(152, 13, 60, 10), drawFormat)

        e.Graphics.DrawLine(blackPen, 0, 18, 200, 18)

        Dim newRowHeight As Integer
        If drSalesBill("SalesBillType") = 2 Then
            newRowHeight = 6
            e.Graphics.DrawString("以下列表是购买商品抵用券信息", drawFont, drawBrush, New Rectangle(0, 20, 100, newRowHeight), drawFormat)
        Else
            newRowHeight = 0
        End If
        '以下行的top位置参数 +newRowHeight

        '每页可容纳20行
        Dim iRow As Integer, iStartRow As Int16 = (iTicketPageNum - 1) * 20, iEndRow As Int16 = iStartRow + 19
        If iEndRow > dtCardListInTicket.Rows.Count - 1 Then iEndRow = dtCardListInTicket.Rows.Count - 1

        If iEndRow >= iStartRow Then
            e.Graphics.DrawString("行号", drawFont, drawBrush, New Rectangle(0, 20 + newRowHeight, 10, 10), drawFormat)
            e.Graphics.DrawString("开始卡号", drawFont, drawBrush, New Rectangle(10, 20 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("结束卡号", drawFont, drawBrush, New Rectangle(48, 20 + newRowHeight, 38, 10), drawFormat)
            e.Graphics.DrawString("数量", drawFont, drawBrush, New Rectangle(86, 20 + newRowHeight, 16, 10), rightFormat)
            e.Graphics.DrawString("面值", drawFont, drawBrush, New Rectangle(102, 20 + newRowHeight, 20, 10), rightFormat)
            e.Graphics.DrawString("卡费/张", drawFont, drawBrush, New Rectangle(122, 20 + newRowHeight, 20, 10), rightFormat)
            e.Graphics.DrawString("充值总计", drawFont, drawBrush, New Rectangle(142, 20 + newRowHeight, 29, 10), rightFormat)
            e.Graphics.DrawString("应付总计", drawFont, drawBrush, New Rectangle(171, 20 + newRowHeight, 29, 10), rightFormat)
        End If

        For iRow = iStartRow To iEndRow
            If dtCardListInTicket.Rows(iRow)("RowID").ToString = "" Then
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(0, 26 + newRowHeight + (iRow Mod 20) * 5, 80, 10), drawFormat) '打印"以下列表是营销卡"
            Else
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("RowID").ToString, drawFont, drawBrush, New Rectangle(0, 26 + newRowHeight + (iRow Mod 20) * 5, 8, 10), titleFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("StartCardNo").ToString, drawFont, drawBrush, New Rectangle(10, 26 + newRowHeight + (iRow Mod 20) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(dtCardListInTicket.Rows(iRow)("EndCardNo").ToString, drawFont, drawBrush, New Rectangle(48, 26 + newRowHeight + (iRow Mod 20) * 5, 38, 10), drawFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("CardQTY"), "#,0"), drawFont, drawBrush, New Rectangle(86, 26 + newRowHeight + (iRow Mod 20) * 5, 16, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("FaceValue"), "#,0.00"), drawFont, drawBrush, New Rectangle(102, 26 + newRowHeight + (iRow Mod 20) * 5, 20, 10), rightFormat)
                e.Graphics.DrawString(Format(CDec(dtCardListInTicket.Rows(iRow)("CardCost")), "#,0.00"), drawFont, drawBrush, New Rectangle(122, 26 + newRowHeight + (iRow Mod 20) * 5, 20, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("ChargedAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(142, 26 + newRowHeight + (iRow Mod 20) * 5, 29, 10), rightFormat)
                e.Graphics.DrawString(Format(dtCardListInTicket.Rows(iRow)("PayableAMT"), "#,0.00"), drawFont, drawBrush, New Rectangle(171, 26 + newRowHeight + (iRow Mod 20) * 5, 29, 10), rightFormat)
            End If
        Next

        Dim blIsLastPage As Boolean, iCurrentPageNum As Int16 = iTicketPageNum
        If iTicketPageCount > 1 Then
            If iTicketPageNum < iTicketPageCount Then
                blIsLastPage = False
                e.HasMorePages = True
            Else
                blIsLastPage = True
                e.HasMorePages = False
            End If
            iTicketPageNum = iTicketPageNum + 1
        Else
            blIsLastPage = True
            e.HasMorePages = False
        End If

        If blIsLastPage Then
            Dim bDistance As Byte = 5, iTop As Integer = 88 + newRowHeight, iWidth As Integer = 100
            If drSalesBill("CardCost") > 0 OrElse dtPayment.DefaultView.ToTable(True, "PaymentTerm").Rows.Count = 5 Then bDistance = 4
            'modify code 059,061:start-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 55 '如果属非现金的付款方式，需打印转出/
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 55 '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then iWidth = 55 '如果属非现金的付款方式，需打印转出/转入账户信息
            'modify code 059,061:end-------------------------------------------------------------------------

            e.Graphics.DrawLine(blackPen, 0, 86 + newRowHeight, 200, 86 + newRowHeight)

            e.Graphics.DrawString("卡片数量：" & Me.txbCardQTY.Text & " 张", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            e.Graphics.DrawString("充值金额：" & Me.txbChargedAMT.Text & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            iTop += bDistance
            If drSalesBill("RebateSalesAMT") = 0 Then
                e.Graphics.DrawString("折扣金额：0.00 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("折扣比例：0.00 %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            ElseIf drSalesBill("RebateCardQTY") = 0 Then
                e.Graphics.DrawString("抵扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("抵扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            Else
                e.Graphics.DrawString("折扣金额：" & Format(drSalesBill("RebateSalesAMT"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("折扣比例：" & Format(drSalesBill("RebateRate") * 100, "#,0.00") & " %", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            End If
            iTop += bDistance
            e.Graphics.DrawString("实收金额：" & Me.txbPaymentAMT.Text & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            If drSalesBill("CardCost") > 0 Then
                iTop += bDistance
                e.Graphics.DrawString("卡费：" & Format(drSalesBill("CardCost"), "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(0, iTop, iWidth, 10), drawFormat)
            End If

            iTop = 88 + newRowHeight

            e.Graphics.DrawString("付款方式：", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
            If drSalesBill("SalesBillType") = 1 Then
                iTop += bDistance
                e.Graphics.DrawString("（退货单无须付款）", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                'modify code 059:start-------------------------------------------------------------------------
                'ElseIf drSalesBill("PayableAMT") = 0 Then
                '    iTop += bDistance
                '    e.Graphics.DrawString("（返点单无须付款）", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                'modify code 059:end-------------------------------------------------------------------------
            Else
                'modify code 059:start-------------------------------------------------------------------------
                'Dim dmTermAMT As Decimal = 0, sText As String = ""
                Dim dmTermAMT As Decimal = -1, sText As String = ""
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=0")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    现金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=1")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  银行卡 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=2 Or PaymentTerm=5")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    转账 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=3 Or PaymentTerm=4 Or PaymentTerm=6")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("    支票 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=4")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("  保证金 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=7")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString("积分兑换 " & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=8")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=8")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth, iTop, iWidth, 10), drawFormat)
                End If
                Try
                    dmTermAMT = dtPayment.Compute("Sum(PaymentAMT)", "PaymentTerm=11")
                Catch
                    'dmTermAMT = 0
                    dmTermAMT = -1
                End Try
                'If dmTermAMT > 0 Then
                If dmTermAMT >= 0 Then
                    iTop += bDistance
                    e.Graphics.DrawString(dtCityPaymentTerm.Select("PaymentTerm=11")(0)("PaymentName").ToString & Format(dmTermAMT, "#,0.00") & " 元", drawFont, drawBrush, New Rectangle(iWidth + 10, iTop, iWidth, 10), drawFormat)
                End If
                'modify code 059:end-------------------------------------------------------------------------
            End If

            'modify code 059,061:end-------------------------------------------------------------------------
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") > 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
            'If drSalesBill("SalesBillType") = 0 AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
            If (drSalesBill("SalesBillType") = 0 OrElse drSalesBill("SalesBillType") = 7 OrElse drSalesBill("SalesBillType") = 8) AndAlso drSalesBill("PayableAMT") >= 0 AndAlso dtPayment.Select("PaymentTerm>0").Length > 0 Then '如果属非现金的付款方式，需打印转出/转入账户信息
                'modify code 059,061:end-------------------------------------------------------------------------
                iTop = 88 + newRowHeight
                e.Graphics.DrawString("转出/转入账户信息：", drawFont, drawBrush, New Rectangle(110, iTop, 90, 10), drawFormat)
                sPrintingText = ""
                Dim dvTemp As DataView = dtPayment.Copy.DefaultView, dtTemp As DataTable
                dvTemp.Sort = "RowID"
                dvTemp.RowFilter = "PaymentTerm>0"
                dtTemp = dvTemp.ToTable(True, "PayerName")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("PayerName").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 67 Then bDistance = 4
                iTop += bDistance
                e.Graphics.DrawString("转出账户名称：", drawFont, drawBrush, New Rectangle(110, iTop, 90, 20), drawFormat)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(134, iTop, 67, 20), New StringFormat) '使用默认的StringFormat以允许换行
                If e.Graphics.MeasureString(sPrintingText, drawFont).Width > 67 Then iTop += bDistance
                iTop += bDistance
                sPrintingText = "转出账户账号："
                dtTemp = dvTemp.ToTable(True, "MediaNo")
                For Each drTemp As DataRow In dtTemp.Rows
                    sPrintingText = sPrintingText & drTemp("MediaNo").ToString & "/"
                Next
                sPrintingText = sPrintingText.Substring(0, sPrintingText.Length - 1)
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(110, iTop, 91, 10), drawFormat)
                dvTemp.Dispose() : dvTemp = Nothing : dtTemp.Dispose() : dtTemp = Nothing
                iTop += bDistance
                If drInternalPayer Is Nothing Then drInternalPayer = dtInternalPayer.Rows.Find(drSalesBill("StoreID").ToString)
                e.Graphics.DrawString("转入账户名称：" & drInternalPayer("PayeeName").ToString, drawFont, drawBrush, New Rectangle(110, iTop, 91, 10), drawFormat)
                iTop += bDistance
                e.Graphics.DrawString("转入账户账号：" & drInternalPayer("ReceiverAccountNo").ToString, drawFont, drawBrush, New Rectangle(110, iTop, 91, 10), drawFormat)
            End If

            e.Graphics.DrawString("本人已认真阅读家乐福福卡公告及章程，知晓并同意其中所有条款。", drawFont, drawBrush, New Rectangle(1, 115 + newRowHeight, 120, 10), drawFormat)
            If drSalesBill("SalesBillType") = 5 Then '联名卡销售单
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = "新/旧" Else sPrintingText = ""
                sPrintingText = sPrintingText & "积分卡号：" & Me.txbNewMemberCardNo.Text
                If Me.txbOldMemberCardNo.Text <> "" Then sPrintingText = sPrintingText & "/" & Me.txbOldMemberCardNo.Text
                e.Graphics.DrawString(sPrintingText, drawFont, drawBrush, New Rectangle(1, 121 + newRowHeight, 120, 10), drawFormat)
            End If
            e.Graphics.DrawString("客户签名：", drawFont, drawBrush, New Rectangle(110, 121 + newRowHeight, 20, 10), drawFormat) '-6
            e.Graphics.DrawString("销售签名：", drawFont, drawBrush, New Rectangle(158, 121 + newRowHeight, 20, 10), drawFormat) '-6
        Else
            e.Graphics.DrawLine(blackPen, 0, 126 + newRowHeight, 200, 126 + newRowHeight)
        End If

        If Me.lblCreatorName.Text = frmMain.sLoginUserRealName Then
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(0, 128 + newRowHeight, 200, 10), drawFormat)
        Else
            e.Graphics.DrawString("门店：" & frmMain.dtLoginStructure.Rows.Find(drSalesBill("StoreID").ToString)("AreaName").ToString & "  " & _
                                  "建单：" & Me.lblCreatorName.Text & "  " & _
                                  "打印：" & frmMain.sLoginUserRealName & "  " & _
                                  "打印时间：" & sTicketPrintedTime, footFont, drawBrush, New Rectangle(0, 128 + newRowHeight, 200, 10), drawFormat)
        End If

        e.Graphics.DrawString("(第" & iCurrentPageNum & "页,共" & iTicketPageCount & "页)", footFont, drawBrush, New Rectangle(0, 128 + newRowHeight, 200, 10), rightFormat)
    End Sub

    'modify code 059:end-------------------------------------------------------------------------

    'modify code 075:start-------------------------------------------------------------------------
    Public Sub GetCULReturnCard()

        Dim nRowIndex As Integer = 0
        Dim totalChargedAMT As Decimal = 0, totalRebateSalesAMT As Decimal = Me.txbAvailableRebateSalesAMT.Text.Trim()

        If dtRebateCard.Rows.Count > 0 Then
            For iRow As Integer = 0 To dtRebateCard.Rows.Count - 1
                If dtRebateCard.Rows(iRow)("StartCardNo").ToString Is Nothing OrElse dtRebateCard.Rows(iRow)("StartCardNo").ToString = "" Then
                    nRowIndex = iRow
                End If
            Next
        End If

        If dtRebateCardEx.Rows.Count > 0 Then
            For jRow As Integer = 0 To dtRebateCardEx.Rows.Count - 1
                Try
                    totalChargedAMT = dtRebateCard.Compute("Sum(ChargedAMT)", "")
                Catch
                End Try
                totalChargedAMT = totalChargedAMT + (Convert.ToDecimal(dtRebateCardEx.Rows(jRow)("FaceValue")) * Convert.ToInt32(dtRebateCardEx.Rows(jRow)("CardQTY")))
                If totalChargedAMT > totalRebateSalesAMT Then
                    MessageBox.Show("获取返点卡的总金额已超出本次最大可兑返点金额", "提示！", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                    Me.Cursor = Cursors.Default
                    Return
                End If

                Dim FaceValue As Decimal = Convert.ToDecimal(dtRebateCardEx.Rows(jRow)("FaceValue"))
                Dim CardQTY As Integer = Convert.ToInt32(dtRebateCardEx.Rows(jRow)("CardQTY"))

                Me.dgvRebateCard("RowID", nRowIndex).Value = nRowIndex + 1
                Me.dgvRebateCard("CardFeature", nRowIndex).Value = "营销卡"

                Try
                    '开始卡号
                    Me.dgvRebateCard("StartCardNo", nRowIndex).Value = dtRebateCardEx.Rows(jRow)("StartCardNo") '2336920200100052736
                Catch
                End Try

                Try
                    '结束卡号
                    Me.dgvRebateCard("EndCardNo", nRowIndex).Value = dtRebateCardEx.Rows(jRow)("EndCardNo") '2336920200100052736
                Catch
                End Try

                Try
                    '面值
                    Me.dgvRebateCard("FaceValue", nRowIndex).Value = FaceValue
                Catch
                End Try

                Try
                    '数量
                    Me.dgvRebateCard("CardQTY", nRowIndex).Value = CardQTY
                Catch
                End Try

                Try
                    '充值金额
                    Me.dgvRebateCard("ChargedAMT", nRowIndex).Value = Convert.ToDecimal(FaceValue * CardQTY)
                Catch
                End Try

                Me.dgvRebateCard("PayableAMT", nRowIndex).Value = 0
                Me.dgvRebateCard.Rows(nRowIndex).ReadOnly = True

                If jRow <> dtRebateCardEx.Rows.Count - 1 Then
                    nRowIndex = nRowIndex + 1
                    Me.dtRebateCard.Rows.Add(1)
                    Me.dgvRebateCard("RowID", nRowIndex + 1).Value = nRowIndex + 2
                Else
                    Me.dgvRebateCard.Focus() : Me.dgvRebateCard.Select() : Me.dgvRebateCard("StartCardNo", Me.dgvRebateCard.RowCount - 1).Selected = True : Me.dgvRebateCard.BeginEdit(True)
                End If

            Next
        End If

        Me.RebateCardSummary()
    End Sub
    'modify code 075:end-------------------------------------------------------------------------
End Class